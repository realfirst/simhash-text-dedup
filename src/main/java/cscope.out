cscope 15 $HOME/zhongsou/project/spider_common/src/main/java               0000809489
	@com/cybozu/labs/langdetect/Command.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
;

3 
impÜt
 
	gjava
.
	gio
.
	gFe
;

4 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

5 
impÜt
 
	gjava
.
	gio
.
	gFeIÅutSŒ—m
;

6 
impÜt
 
	gjava
.
	gio
.
	gFeOuutSŒ—m
;

7 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

8 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—mR—d”
;

9 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

10 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

11 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

12 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

14 
impÜt
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
.
	gLªgProfe
;

16 
impÜt
 
	gÃt
.
	g¬nx
.
	gjsÚic
.
	gJSON
;

17 
impÜt
 
	gÃt
.
	g¬nx
.
	gjsÚic
.
	gJSONExû±iÚ
;

29 
public
 cÏs 
	cCommªd
 {

31 
´iv©e
 
fš®
 
	mDEFAULT_ALPHA
 = 0.5;

34 
´iv©e
 
	mHashM­
<
	mSŒšg
, SŒšg> 
	mİt_w™h_v®ue
 = 
Ãw
 
HashM­
<
SŒšg
, String>();

35 
´iv©e
 
	mHashM­
<
	mSŒšg
, SŒšg> 
	mv®ues
 = 
Ãw
 
HashM­
<
SŒšg
, String>();

36 
´iv©e
 
	mHashS‘
<
	mSŒšg
> 
	mİt_w™hout_v®ue
 = 
Ãw
 
HashS‘
<
SŒšg
>();

37 
´iv©e
 
	mA¼ayLi¡
<
	mSŒšg
> 
	m¬gli¡
 = 
Ãw
 
A¼ayLi¡
<
SŒšg
>();

43 
´iv©e
 
	$·r£
(
SŒšg
[] 
¬gs
) {

44 
i
=0;i<
¬gs
.
Ëngth
;++i) {

45 ià(
İt_w™h_v®ue
.
	`cÚšsKey
(
¬gs
[
i
])) {

46 
SŒšg
 
key
 = 
İt_w™h_v®ue
.
	`g‘
(
¬gs
[
i
]);

47 
v®ues
.
	`put
(
key
, 
¬gs
[
i
+1]);

48 ++
i
;

49 } ià(
¬gs
[
i
].
	`¡¬tsW™h
("-")) {

50 
İt_w™hout_v®ue
.
	`add
(
¬gs
[
i
]);

52 
¬gli¡
.
	`add
(
¬gs
[
i
]);

57 
´iv©e
 
	$addO±
(
SŒšg
 
İt
, SŒšg 
key
, SŒšg 
v®ue
) {

58 
İt_w™h_v®ue
.
	`put
(
İt
, 
key
);

59 
v®ues
.
	`put
(
key
, 
v®ue
);

60 
	}
}

61 
´iv©e
 
SŒšg
 
	$g‘
(
SŒšg
 
key
) {

62  
v®ues
.
	`g‘
(
key
);

63 
	}
}

64 
´iv©e
 
LÚg
 
	$g‘LÚg
(
SŒšg
 
key
) {

65 
SŒšg
 
v®ue
 = 
v®ues
.
	`g‘
(
key
);

66 ià(
v®ue
 =ğ
nuÎ
) ‚ull;

67 
Œy
 {

68  
LÚg
.
	`v®ueOf
(
v®ue
);

69 } 
	`ÿtch
 (
Numb”FÜm©Exû±iÚ
 
e
) {

70  
nuÎ
;

72 
	}
}

73 
´iv©e
 
	$g‘DoubË
(
SŒšg
 
key
, 
deçuÉV®ue
) {

74 
Œy
 {

75  
DoubË
.
	`v®ueOf
(
v®ues
.
	`g‘
(
key
));

76 } 
	`ÿtch
 (
Numb”FÜm©Exû±iÚ
 
e
) {

77  
deçuÉV®ue
;

79 
	}
}

81 
´iv©e
 
boŞ—n
 
	$hasO±
(
SŒšg
 
İt
) {

82  
İt_w™hout_v®ue
.
	`cÚšs
(
İt
);

83 
	}
}

92 
´iv©e
 
Fe
 
	$£¬chFe
(
Fe
 
dœeùÜy
, 
SŒšg
 
·‰”n
) {

93 
Fe
 
fe
 : 
dœeùÜy
.
	`li¡Fes
()) {

94 ià(
fe
.
	`g‘Name
().
	`m©ches
(
·‰”n
))  file;

96  
nuÎ
;

97 
	}
}

104 
´iv©e
 
boŞ—n
 
	$lßdProfe
() {

105 
SŒšg
 
´ofeDœeùÜy
 = 
	`g‘
("directory") + "/";

106 
Œy
 {

107 
D‘eùÜFaùÜy
.
	`lßdProfe
(
´ofeDœeùÜy
);

108 
LÚg
 
£ed
 = 
	`g‘LÚg
("seed");

109 ià(
£ed
 !ğ
nuÎ
è
D‘eùÜFaùÜy
.
	`£tS“d
(seed);

110  
çl£
;

111 } 
	`ÿtch
 (
LªgD‘eùExû±iÚ
 
e
) {

112 
Sy¡em
.
”r
.
	`´šn
("ERROR: " + 
e
.
	`g‘Mes§ge
());

113  
Œue
;

115 
	}
}

125 
public
 
	$g’”©eProfe
() {

126 
Fe
 
dœeùÜy
 = 
Ãw
 
	`Fe
(
	`g‘
("directory"));

127 
SŒšg
 
Ïng
: 
¬gli¡
) {

128 
Fe
 
fe
 = 
	`£¬chFe
(
dœeùÜy
, 
Ïng
 + "wiki-.*-abstract\\.xml.*");

129 ià(
fe
 =ğ
nuÎ
) {

130 
Sy¡em
.
”r
.
	`´šn
("NÙ Found‡b¡¿ù xmÈ:†ªg = " + 
Ïng
);

134 
FeOuutSŒ—m
 
os
 = 
nuÎ
;

135 
Œy
 {

136 
LªgProfe
 
´ofe
 = 
G’Profe
.
	`lßdFromWikedŸAb¡¿ù
(
Ïng
, 
fe
);

137 
´ofe
.
	`om™LessF»q
();

139 
Fe
 
´ofe_·th
 = 
Ãw
 
	`Fe
(
	`g‘
("dœeùÜy"è+ "/´ofes/" + 
Ïng
);

140 
os
 = 
Ãw
 
	`FeOuutSŒ—m
(
´ofe_·th
);

141 
JSON
.
	`’code
(
´ofe
, 
os
);

142 } 
	`ÿtch
 (
JSONExû±iÚ
 
e
) {

143 
e
.
	`´štSckT¿û
();

144 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

145 
e
.
	`´štSckT¿û
();

146 } 
	`ÿtch
 (
LªgD‘eùExû±iÚ
 
e
) {

147 
e
.
	`´štSckT¿û
();

148 } 
fš®ly
 {

149 
Œy
 {

150 ià(
os
!=
nuÎ
èos.
	`şo£
();

151 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {}

154 
	}
}

164 
´iv©e
 
	$g’”©eProfeFromText
() {

165 ià(
¬gli¡
.
	`size
() != 1) {

166 
Sy¡em
.
”r
.
	`´šn
("Needo specifyext file…ath");

169 
Fe
 
fe
 = 
Ãw
 
	`Fe
(
¬gli¡
.
	`g‘
(0));

170 ià(!
fe
.
	`exi¡s
()) {

171 
Sy¡em
.
”r
.
	`´šn
("Needo specifyƒxistingext file…ath");

175 
SŒšg
 
Ïng
 = 
	`g‘
("lang");

176 ià(
Ïng
 =ğ
nuÎ
) {

177 
Sy¡em
.
”r
.
	`´šn
("Needo specify†angage code(-l)");

181 
FeOuutSŒ—m
 
os
 = 
nuÎ
;

182 
Œy
 {

183 
LªgProfe
 
´ofe
 = 
G’Profe
.
	`lßdFromText
(
Ïng
, 
fe
);

184 
´ofe
.
	`om™LessF»q
();

186 
Fe
 
´ofe_·th
 = 
Ãw
 
	`Fe
(
Ïng
);

187 
os
 = 
Ãw
 
	`FeOuutSŒ—m
(
´ofe_·th
);

188 
JSON
.
	`’code
(
´ofe
, 
os
);

189 } 
	`ÿtch
 (
JSONExû±iÚ
 
e
) {

190 
e
.
	`´štSckT¿û
();

191 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

192 
e
.
	`´štSckT¿û
();

193 } 
	`ÿtch
 (
LªgD‘eùExû±iÚ
 
e
) {

194 
e
.
	`´štSckT¿û
();

195 } 
fš®ly
 {

196 
Œy
 {

197 ià(
os
!=
nuÎ
èos.
	`şo£
();

198 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {}

200 
	}
}

210 
public
 
	$d‘eùLªg
() {

211 ià(
	`lßdProfe
()) ;

212 
SŒšg
 
f’ame
: 
¬gli¡
) {

213 
Bufã»dR—d”
 
is
 = 
nuÎ
;

214 
Œy
 {

215 
is
 = 
Ãw
 
	`Bufã»dR—d”
Òew 
	`IÅutSŒ—mR—d”
Òew 
	`FeIÅutSŒ—m
(
f’ame
), "utf-8"));

217 
D‘eùÜ
 
d‘eùÜ
 = 
D‘eùÜFaùÜy
.
	`ü—‹
(
	`g‘DoubË
("®pha", 
DEFAULT_ALPHA
));

218 ià(
	`hasO±
("--debug")è
d‘eùÜ
.
	`£tV”bo£
();

219 
d‘eùÜ
.
	`­³nd
(
is
);

220 
Sy¡em
.
out
.
	`´šn
(
f’ame
 + ":" + 
d‘eùÜ
.
	`g‘Probab™›s
());

221 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

222 
e
.
	`´štSckT¿û
();

223 } 
	`ÿtch
 (
LªgD‘eùExû±iÚ
 
e
) {

224 
e
.
	`´štSckT¿û
();

225 } 
fš®ly
 {

226 
Œy
 {

227 ià(
is
!=
nuÎ
èis.
	`şo£
();

228 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {}

232 
	}
}

247 
public
 
	$b©chTe¡
() {

248 ià(
	`lßdProfe
()) ;

249 
HashM­
<
SŒšg
, 
A¼ayLi¡
<SŒšg>> 
»suÉ
 = 
Ãw
 HashMap<String, ArrayList<String>>();

250 
SŒšg
 
f’ame
: 
¬gli¡
) {

251 
Bufã»dR—d”
 
is
 = 
nuÎ
;

252 
Œy
 {

253 
is
 = 
Ãw
 
	`Bufã»dR—d”
Òew 
	`IÅutSŒ—mR—d”
Òew 
	`FeIÅutSŒ—m
(
f’ame
), "utf-8"));

254 
is
.
	`»ady
()) {

255 
SŒšg
 
lše
 = 
is
.
	`»adLše
();

256 
idx
 = 
lše
.
	`šdexOf
('\t');

257 ià(
idx
 <= 0) ;

258 
SŒšg
 
cÜ»ùLªg
 = 
lše
.
	`sub¡ršg
(0, 
idx
);

259 
SŒšg
 
‹xt
 = 
lše
.
	`sub¡ršg
(
idx
 + 1);

261 
D‘eùÜ
 
d‘eùÜ
 = 
D‘eùÜFaùÜy
.
	`ü—‹
(
	`g‘DoubË
("®pha", 
DEFAULT_ALPHA
));

262 
d‘eùÜ
.
	`­³nd
(
‹xt
);

263 
SŒšg
 
Ïng
 = "";

264 
Œy
 {

265 
Ïng
 = 
d‘eùÜ
.
	`d‘eù
();

266 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

267 
e
.
	`´štSckT¿û
();

269 ià(!
»suÉ
.
	`cÚšsKey
(
cÜ»ùLªg
)è»suÉ.
	`put
(cÜ»ùLªg, 
Ãw
 
A¼ayLi¡
<
SŒšg
>());

270 
»suÉ
.
	`g‘
(
cÜ»ùLªg
).
	`add
(
Ïng
);

271 ià(
	`hasO±
("--debug")è
Sy¡em
.
out
.
	`´šn
(
cÜ»ùLªg
 + "," + 
Ïng
 + "," + (
‹xt
.
	`Ëngth
()>100?‹xt.
	`sub¡ršg
(0, 100):text));

274 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

275 
e
.
	`´štSckT¿û
();

276 } 
	`ÿtch
 (
LªgD‘eùExû±iÚ
 
e
) {

277 
e
.
	`´štSckT¿û
();

278 } 
fš®ly
 {

279 
Œy
 {

280 ià(
is
!=
nuÎ
èis.
	`şo£
();

281 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {}

284 
A¼ayLi¡
<
SŒšg
> 
Ïngli¡
 = 
Ãw
 A¼ayLi¡<SŒšg>(
»suÉ
.
	`keyS‘
());

285 
CŞËùiÚs
.
	`sÜt
(
Ïngli¡
);

287 
tÙ®CouÁ
 = 0, 
tÙ®CÜ»ù
 = 0;

288  
SŒšg
 
Ïng
 :
Ïngli¡
) {

289 
HashM­
<
SŒšg
, 
IÁeg”
> 
»suÉCouÁ
 = 
Ãw
 HashMap<String, Integer>();

290 
couÁ
 = 0;

291 
A¼ayLi¡
<
SŒšg
> 
li¡
 = 
»suÉ
.
	`g‘
(
Ïng
);

292 
SŒšg
 
d‘eùedLªg
: 
li¡
) {

293 ++
couÁ
;

294 ià(
»suÉCouÁ
.
	`cÚšsKey
(
d‘eùedLªg
)) {

295 
»suÉCouÁ
.
	`put
(
d‘eùedLªg
,„esuÉCouÁ.
	`g‘
(detectedLang) + 1);

297 
»suÉCouÁ
.
	`put
(
d‘eùedLªg
, 1);

300 
cÜ»ù
 = 
»suÉCouÁ
.
	`cÚšsKey
(
Ïng
)?»suÉCouÁ.
	`g‘
(lang):0;

301 
¿‹
 = 
cÜ»ù
 / ()
couÁ
;

302 
Sy¡em
.
out
.
	`´šn
(
SŒšg
.
	`fÜm©
("% (%d/%d=%.2f): %s", 
Ïng
, 
cÜ»ù
, 
couÁ
, 
¿‹
, 
»suÉCouÁ
));

303 
tÙ®CÜ»ù
 +ğ
cÜ»ù
;

304 
tÙ®CouÁ
 +ğ
couÁ
;

306 
Sy¡em
.
out
.
	`´šn
(
SŒšg
.
	`fÜm©
("tÙ®: %d/%d = %.3f", 
tÙ®CÜ»ù
, 
tÙ®CouÁ
,otalCorrect / ()totalCount));

310 
	}
}

316 
public
 
	$maš
(
SŒšg
[] 
¬gs
) {

317 
Commªd
 
commªd
 = 
Ãw
 
	`Commªd
();

318 
commªd
.
	`addO±
("-d", "directory", "./");

319 
commªd
.
	`addO±
("-a", "®pha", "" + 
DEFAULT_ALPHA
);

320 
commªd
.
	`addO±
("-s", "£ed", 
nuÎ
);

321 
commªd
.
	`addO±
("-l", "Ïng", 
nuÎ
);

322 
commªd
.
	`·r£
(
¬gs
);

324 ià(
commªd
.
	`hasO±
("--genprofile")) {

325 
commªd
.
	`g’”©eProfe
();

326 } ià(
commªd
.
	`hasO±
("--genprofile-text")) {

327 
commªd
.
	`g’”©eProfeFromText
();

328 } ià(
commªd
.
	`hasO±
("--detectlang")) {

329 
commªd
.
	`d‘eùLªg
();

330 } ià(
commªd
.
	`hasO±
("--batchtest")) {

331 
commªd
.
	`b©chTe¡
();

333 
	}
}

	@com/cybozu/labs/langdetect/Detector.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

5 
impÜt
 
	gjava
.
	gÏng
.
	gCh¬aù”
.
	gUnicodeBlock
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gFÜm©‹r
;

8 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

9 
impÜt
 
	gjava
.
	gut
.
	gRªdom
;

10 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gM©ch”
;

11 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹º
;

13 
impÜt
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
.
	gNG¿m
;

63 
public
 cÏs 
	cD‘eùÜ
 {

64 
´iv©e
 
fš®
 
	mALPHA_DEFAULT
 = 0.5;

65 
´iv©e
 
fš®
 
	mALPHA_WIDTH
 = 0.05;

67 
´iv©e
 
fš®
 
	mITERATION_LIMIT
 = 1000;

68 
´iv©e
 
fš®
 
	mPROB_THRESHOLD
 = 0.1;

69 
´iv©e
 
fš®
 
	mCONV_THRESHOLD
 = 0.99999;

70 
´iv©e
 
fš®
 
	mBASE_FREQ
 = 10000;

71 
´iv©e
 
fš®
 
SŒšg
 
	mUNKNOWN_LANG
 = "unknown";

73 
´iv©e
 
fš®
 
P©‹º
 
	mURL_REGEX
 = P©‹º.
compe
("https?://[-_.?&~;+=/#0-9A-Za-z]+");

76 
´iv©e
 
fš®
 
P©‹º
 
	mMAIL_REGEX
 = P©‹º.
compe
("[-_.0-9A-Za-z]{1,20}@[-_0-9A-Za-z]{1,20}");

77 
´iv©e
 
fš®
 
	mHashM­
<
	mSŒšg
, []> 
	mwÜdLªgProbM­
;

78 
´iv©e
 
fš®
 
	mA¼ayLi¡
<
	mSŒšg
> 
	mÏngli¡
;

80 
´iv©e
 
SŒšgBufãr
 
	m‹xt
;

81 
´iv©e
 [] 
	mÏng´ob
 = 
nuÎ
;

83 
´iv©e
 
	m®pha
 = 
ALPHA_DEFAULT
;

84 
´iv©e
 
	mn_ŒŸl
 = 7;

85 
´iv©e
 
	mmax_‹xt_Ëngth
 = 10000;

86 
´iv©e
 [] 
	m´iÜM­
 = 
nuÎ
;

87 
´iv©e
 
boŞ—n
 
	mv”bo£
 = 
çl£
;

88 
´iv©e
 
LÚg
 
	m£ed
 = 
nuÎ
;

97 
public
 
	$D‘eùÜ
(
D‘eùÜFaùÜy
 
çùÜy
) {

98 
this
.
wÜdLªgProbM­
 = 
çùÜy
.wordLangProbMap;

99 
this
.
Ïngli¡
 = 
çùÜy
.langlist;

100 
this
.
‹xt
 = 
Ãw
 
	`SŒšgBufãr
();

101 
this
.
£ed
 = 
çùÜy
.seed;

107 
public
 
	$£tV”bo£
() {

108 
this
.
v”bo£
 = 
Œue
;

109 
	}
}

118 
public
 
	$£tAÍha
(
®pha
) {

119 
this
.
®pha
 =‡lpha;

120 
	}
}

122 
public
 
	$ş—rText
() {

123 
this
.
‹xt
.
	`£tL’gth
(0);

124 
	}
}

133 
public
 
£tPriÜM­
(
HashM­
<
SŒšg
, 
DoubË
> 
´iÜM­
è
throws
 
	gLªgD‘eùExû±iÚ
 {

134 
	gthis
.
	g´iÜM­
 = 
Ãw
 [
Ïngli¡
.
size
()];

135 
	gsump
 = 0;

136 
	gi
 = 0; i < 
	gthis
.
	g´iÜM­
.
	gËngth
; ++i) {

137 
SŒšg
 
	gÏng
 = 
Ïngli¡
.
g‘
(
i
);

138 ià(
	g´iÜM­
.
cÚšsKey
(
Ïng
)) {

139 
	gp
 = 
´iÜM­
.
g‘
(
Ïng
);

140 ià(
	gp
 < 0)

141 
throw
 
Ãw
 
LªgD‘eùExû±iÚ
(
E¼ÜCode
.
In™P¬amE¼Ü
, "Prior…robability must be‚on-negative.");

142 
	gthis
.
	g´iÜM­
[
i
] = 
p
;

143 
	gsump
 +ğ
p
;

146 ià(
	gsump
 <= 0)

147 
throw
 
Ãw
 
LªgD‘eùExû±iÚ
(
E¼ÜCode
.
In™P¬amE¼Ü
, "More one of…rior…robability must be‚on-zero.");

148 
	gi
 = 0; i < 
	gthis
.
	g´iÜM­
.
	gËngth
; ++i)

149 
	gthis
.
	g´iÜM­
[
i
] /ğ
sump
;

159 
public
 
	$£tMaxTextL’gth
(
max_‹xt_Ëngth
) {

160 
this
.
max_‹xt_Ëngth
 = max_text_length;

161 
	}
}

174 
public
 
	$­³nd
(
R—d”
 
»ad”
è
throws
 
IOExû±iÚ
 {

175 [] 
buf
 = 
Ãw
 [
max_‹xt_Ëngth
 / 2];

176 
‹xt
.
	`Ëngth
(è< 
max_‹xt_Ëngth
 && 
»ad”
.
	`»ady
()) {

177 
Ëngth
 = 
»ad”
.
	`»ad
(
buf
);

178 
	`­³nd
(
Ãw
 
	`SŒšg
(
buf
, 0, 
Ëngth
));

180 
	}
}

190 
public
 
	$­³nd
(
SŒšg
 
‹xt
) {

191 
‹xt
 = 
URL_REGEX
.
	`m©ch”
Ñext).
	`»¶aûAÎ
(" ");

192 
M©ch”
 
m
 = 
MAIL_REGEX
.
	`m©ch”
(
‹xt
);

193 ià(
‹xt
.
	`cÚšs
("@")&&
m
.
	`fšd
()) {

194 
‹xt
 = 
MAIL_REGEX
.
	`m©ch”
Ñext).
	`»¶aûAÎ
(" ");

196 
´e
 = 0;

197 
i
 = 0; i < 
‹xt
.
	`Ëngth
(è&& i < 
max_‹xt_Ëngth
; ++i) {

198 
c
 = 
NG¿m
.
	`nÜm®ize
(
‹xt
.
	`ch¬At
(
i
));

199 ià(
c
 !ğ' ' || 
´e
 != ' ')

200 
this
.
‹xt
.
	`­³nd
(
c
);

201 
´e
 = 
c
;

203 
	}
}

209 
´iv©e
 
	$ş—nšgText
() {

210 
ÏtšCouÁ
 = 0, 
nÚL©šCouÁ
 = 0;

211 
i
 = 0; i < 
‹xt
.
	`Ëngth
(); ++i) {

212 
c
 = 
‹xt
.
	`ch¬At
(
i
);

213 ià(
c
 <= 'z' && c >= 'A') {

214 ++
ÏtšCouÁ
;

215 } ià(
c
 >ğ'\u0300' && 
UnicodeBlock
.
	`of
(cè!ğUnicodeBlock.
LATIN_EXTENDED_ADDITIONAL
) {

216 ++
nÚL©šCouÁ
;

219 ià(
ÏtšCouÁ
 * 2 < 
nÚL©šCouÁ
) {

220 
SŒšgBufãr
 
‹xtW™houtL©š
 = 
Ãw
 
	`SŒšgBufãr
();

221 
i
 = 0; i < 
‹xt
.
	`Ëngth
(); ++i) {

222 
c
 = 
‹xt
.
	`ch¬At
(
i
);

223 ià(
c
 > 'z' || c < 'A')

224 
‹xtW™houtL©š
.
	`­³nd
(
c
);

226 
‹xt
 = 
‹xtW™houtL©š
;

229 
	}
}

240 
public
 
SŒšg
 
	$d‘eù
(è
throws
 
LªgD‘eùExû±iÚ
 {

241 
A¼ayLi¡
<
Lªguage
> 
´obab™›s
 = 
	`g‘Probab™›s
();

242 ià(
´obab™›s
.
	`size
() > 0)

243  
´obab™›s
.
	`g‘
(0).
Ïng
;

244  
UNKNOWN_LANG
;

245 
	}
}

256 
public
 
	gA¼ayLi¡
<
	gLªguage
> 
	$g‘Probab™›s
(è
throws
 
LªgD‘eùExû±iÚ
 {

257 ià(
Ïng´ob
 =ğ
nuÎ
)

258 
	`d‘eùBlock
();

260 
A¼ayLi¡
<
Lªguage
> 
li¡
 = 
	`sÜtProbab™y
(
Ïng´ob
);

261  
li¡
;

262 
	}
}

268 
´iv©e
 
	$d‘eùBlock
(è
throws
 
LªgD‘eùExû±iÚ
 {

269 
	`ş—nšgText
();

270 
A¼ayLi¡
<
SŒšg
> 
ng¿ms
 = 
	`exŒaùNG¿ms
();

271 ià(
ng¿ms
.
	`size
() == 0)

272 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
CªtD‘eùE¼Ü
, "no features inext");

274 
Ïng´ob
 = 
Ãw
 [
Ïngli¡
.
	`size
()];

276 
Rªdom
 
¿nd
 = 
Ãw
 
	`Rªdom
();

277 ià(
£ed
 !ğ
nuÎ
)

278 
¿nd
.
	`£tS“d
(
£ed
);

279 
t
 = 0; < 
n_ŒŸl
; ++t) {

280 [] 
´ob
 = 
	`š™Probab™y
();

281 
®pha
 = 
this
.®ph¨+ 
¿nd
.
	`ÃxtGaussŸn
(è* 
ALPHA_WIDTH
;

283 
i
 = 0;; ++i) {

284 
r
 = 
¿nd
.
	`ÃxtIÁ
(
ng¿ms
.
	`size
());

285 
	`upd©eLªgProb
(
´ob
, 
ng¿ms
.
	`g‘
(
r
), 
®pha
);

286 ià(
i
 % 5 == 0) {

287 ià(
	`nÜm®izeProb
(
´ob
è> 
CONV_THRESHOLD
 || 
i
 >ğ
ITERATION_LIMIT
)

289 ià(
v”bo£
)

290 
Sy¡em
.
out
.
	`´šn
("> " + 
	`sÜtProbab™y
(
´ob
));

293 
j
 = 0; j < 
Ïng´ob
.
Ëngth
; ++j)

294 
Ïng´ob
[
j
] +ğ
´ob
[j] / 
n_ŒŸl
;

295 ià(
v”bo£
)

296 
Sy¡em
.
out
.
	`´šn
("==> " + 
	`sÜtProbab™y
(
´ob
));

298 
	}
}

306 
´iv©e
 [] 
	$š™Probab™y
() {

307 [] 
´ob
 = 
Ãw
 [
Ïngli¡
.
	`size
()];

308 ià(
´iÜM­
 !ğ
nuÎ
) {

309 
i
 = 0; i < 
´ob
.
Ëngth
; ++i)

310 
´ob
[
i
] = 
´iÜM­
[i];

312 
i
 = 0; i < 
´ob
.
Ëngth
; ++i)

313 
´ob
[
i
] = 1.0 / 
Ïngli¡
.
	`size
();

315  
´ob
;

316 
	}
}

323 
´iv©e
 
	gA¼ayLi¡
<
	gSŒšg
> 
	$exŒaùNG¿ms
() {

324 
A¼ayLi¡
<
SŒšg
> 
li¡
 = 
Ãw
 ArrayList<String>();

325 
NG¿m
 
ng¿m
 = 
Ãw
 
	`NG¿m
();

326 
i
 = 0; i < 
‹xt
.
	`Ëngth
(); ++i) {

327 
ng¿m
.
	`addCh¬
(
‹xt
.
	`ch¬At
(
i
));

328 
n
 = 1;‚ <ğ
NG¿m
.
N_GRAM
; ++n) {

329 
SŒšg
 
w
 = 
ng¿m
.
	`g‘
(
n
);

330 ià(
w
 !ğ
nuÎ
 && 
wÜdLªgProbM­
.
	`cÚšsKey
(w))

331 
li¡
.
	`add
(
w
);

334  
li¡
;

335 
	}
}

343 
´iv©e
 
boŞ—n
 
	$upd©eLªgProb
([] 
´ob
, 
SŒšg
 
wÜd
, 
®pha
) {

344 ià(
wÜd
 =ğ
nuÎ
 || !
wÜdLªgProbM­
.
	`cÚšsKey
(word))

345  
çl£
;

347 [] 
ÏngProbM­
 = 
wÜdLªgProbM­
.
	`g‘
(
wÜd
);

348 ià(
v”bo£
)

349 
Sy¡em
.
out
.
	`´šn
(
wÜd
 + "(" + 
	`unicodeEncode
(wÜdè+ "):" + 
	`wÜdProbToSŒšg
(
ÏngProbM­
));

351 
weight
 = 
®pha
 / 
BASE_FREQ
;

352 
i
 = 0; i < 
´ob
.
Ëngth
; ++i) {

353 
´ob
[
i
] *ğ
weight
 + 
ÏngProbM­
[i];

355  
Œue
;

356 
	}
}

358 
´iv©e
 
SŒšg
 
	$wÜdProbToSŒšg
([] 
´ob
) {

359 
FÜm©‹r
 
fÜm©‹r
 = 
Ãw
 
	`FÜm©‹r
();

360 
j
 = 0; j < 
´ob
.
Ëngth
; ++j) {

361 
p
 = 
´ob
[
j
];

362 ià(
p
 >= 0.00001) {

363 
fÜm©‹r
.
	`fÜm©
(" %s:%.5f", 
Ïngli¡
.
	`g‘
(
j
), 
p
);

366  
fÜm©‹r
.
	`toSŒšg
();

367 
	}
}

374 
´iv©e
 
	$nÜm®izeProb
([] 
´ob
) {

375 
maxp
 = 0, 
sump
 = 0;

376 
i
 = 0; i < 
´ob
.
Ëngth
; ++i)

377 
sump
 +ğ
´ob
[
i
];

378 
i
 = 0; i < 
´ob
.
Ëngth
; ++i) {

379 
p
 = 
´ob
[
i
] / 
sump
;

380 ià(
maxp
 < 
p
)

381 
maxp
 = 
p
;

382 
´ob
[
i
] = 
p
;

384  
maxp
;

385 
	}
}

392 
´iv©e
 
	gA¼ayLi¡
<
	gLªguage
> 
	$sÜtProbab™y
([] 
´ob
) {

393 
A¼ayLi¡
<
Lªguage
> 
li¡
 = 
Ãw
 ArrayList<Language>();

394 
j
 = 0; j < 
´ob
.
Ëngth
; ++j) {

395 
p
 = 
´ob
[
j
];

396 ià(
p
 > 
PROB_THRESHOLD
) {

397 
i
 = 0; i <ğ
li¡
.
	`size
(); ++i) {

398 ià(
i
 =ğ
li¡
.
	`size
(è||†i¡.
	`g‘
(i).
´ob
 < 
p
) {

399 
li¡
.
	`add
(
i
, 
Ãw
 
	`Lªguage
(
Ïngli¡
.
	`g‘
(
j
), 
p
));

405  
li¡
;

406 
	}
}

414 
´iv©e
 
SŒšg
 
	$unicodeEncode
(
SŒšg
 
wÜd
) {

415 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
();

416 
i
 = 0; i < 
wÜd
.
	`Ëngth
(); ++i) {

417 
ch
 = 
wÜd
.
	`ch¬At
(
i
);

418 ià(
ch
 >= '\u0080') {

419 
SŒšg
 
¡
 = 
IÁeg”
.
	`toHexSŒšg
(0x10000 + (è
ch
);

420 
¡
.
	`Ëngth
() < 4)

421 
¡
 = "0" + st;

422 
buf
.
	`­³nd
("\\u").­³nd(
¡
.
	`subSequ’û
(1, 5));

424 
buf
.
	`­³nd
(
ch
);

427  
buf
.
	`toSŒšg
();

428 
	}
}

	@com/cybozu/labs/langdetect/DetectorFactory.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
;

3 
impÜt
 
	gjava
.
	gio
.
	gFe
;

4 
impÜt
 
	gjava
.
	gio
.
	gFeIÅutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—m
;

7 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

8 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

9 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

10 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

12 
impÜt
 
	gÃt
.
	g¬nx
.
	gjsÚic
.
	gJSON
;

13 
impÜt
 
	gÃt
.
	g¬nx
.
	gjsÚic
.
	gJSONExû±iÚ
;

15 
impÜt
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
.
	gLªgProfe
;

36 
public
 cÏs 
	cD‘eùÜFaùÜy
 {

37 
public
 
	mHashM­
<
	mSŒšg
, []> 
	mwÜdLªgProbM­
;

38 
public
 
	mA¼ayLi¡
<
	mSŒšg
> 
	mÏngli¡
;

39 
public
 
LÚg
 
	m£ed
 = 
nuÎ
;

41 
´iv©e
 
	$D‘eùÜFaùÜy
() {

42 
wÜdLªgProbM­
 = 
Ãw
 
HashM­
<
SŒšg
, []>();

43 
Ïngli¡
 = 
Ãw
 
A¼ayLi¡
<
SŒšg
>();

47 
public
 
fš®
 
SŒšg
[] 
Ïnguages
 = 
Ãw
 String[] { "af", "ar", "a.txt", "bg", "bn", "cs", "da", "de", "el", "en", "es", "et", "fa", "fi", "fr", "gu", "he", "hi", "hr", "hu", "id", "it",

49 "zh-ú", "zh-tw" 
	}
};

51 
	$lßdDeçuÉResourûProfe
() {

52 
šdex
 = 0;

53 
Ïngsize
 = 
Ïnguages
.
Ëngth
;

54 
SŒšg
 
Ïng
 : 
Ïnguages
) {

55 
IÅutSŒ—m
 
šput
 = 
nuÎ
;

57 
Œy
 {

58 
šput
 = 
D‘eùÜFaùÜy
.
şass
.
	`g‘ResourûAsSŒ—m
("´ofes/" + 
Ïng
);

59 ià(
šput
 !ğ
nuÎ
) {

60 
LªgProfe
 
´ofe
 = 
JSON
.
	`decode
(
šput
, LªgProfe.
şass
);

61 
	`addProfe
(
´ofe
, 
šdex
, 
Ïngsize
);

62 ++
šdex
;

63 
šput
.
	`şo£
();

66 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

68 
e
.
	`´štSckT¿û
();

69 } 
	`ÿtch
 (
LªgD‘eùExû±iÚ
 
e
) {

71 
e
.
	`´štSckT¿û
();

74 
Sy¡em
.
out
.
	`´šn
("sucûed†ßd f" + 
šdex
);

75 
	}
}

77 
´iv©e
 
D‘eùÜFaùÜy
 
	gš¡ªû_
 = 
Ãw
 DetectorFactory();

80 
lßdDeçuÉResourûProfe
();

94 
public
 
	$lßdProfe
(
SŒšg
 
´ofeDœeùÜy
è
throws
 
LªgD‘eùExû±iÚ
 {

95 
	`lßdProfe
(
Ãw
 
	`Fe
(
´ofeDœeùÜy
));

96 
	}
}

109 
public
 
	$lßdProfe
(
Fe
 
´ofeDœeùÜy
è
throws
 
LªgD‘eùExû±iÚ
 {

110 
Fe
[] 
li¡Fes
 = 
´ofeDœeùÜy
.
	`li¡Fes
();

111 ià(
li¡Fes
 =ğ
nuÎ
)

112 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
N“dLßdProfeE¼Ü
, "NÙ found…rofe: " + 
´ofeDœeùÜy
);

114 
Ïngsize
 = 
li¡Fes
.
Ëngth
, 
šdex
 = 0;

115 
Fe
 
fe
 : 
li¡Fes
) {

116 ià(
fe
.
	`g‘Name
().
	`¡¬tsW™h
("."è|| !fe.
	`isFe
())

118 
FeIÅutSŒ—m
 
is
 = 
nuÎ
;

119 
Œy
 {

120 
is
 = 
Ãw
 
	`FeIÅutSŒ—m
(
fe
);

121 
LªgProfe
 
´ofe
 = 
JSON
.
	`decode
(
is
, LªgProfe.
şass
);

122 
	`addProfe
(
´ofe
, 
šdex
, 
Ïngsize
);

123 ++
šdex
;

124 } 
	`ÿtch
 (
JSONExû±iÚ
 
e
) {

125 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
FÜm©E¼Ü
, "´offÜm©ƒ¼Ü iÀ'" + 
fe
.
	`g‘Name
() + "'");

126 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

127 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
FeLßdE¼Ü
, "ÿn'ˆİ’ '" + 
fe
.
	`g‘Name
() + "'");

128 } 
fš®ly
 {

129 
Œy
 {

130 ià(
is
 !ğ
nuÎ
)

131 
is
.
	`şo£
();

132 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

136 
	}
}

144 
	$addProfe
(
LªgProfe
 
´ofe
, 
šdex
, 
Ïngsize
è
throws
 
LªgD‘eùExû±iÚ
 {

145 
SŒšg
 
Ïng
 = 
´ofe
.
Çme
;

146 ià(
š¡ªû_
.
Ïngli¡
.
	`cÚšs
(
Ïng
)) {

147 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
Du¶iÿ‹LªgE¼Ü
, "duplicatehe same†anguage…rofile");

149 
š¡ªû_
.
Ïngli¡
.
	`add
(
Ïng
);

150 
SŒšg
 
wÜd
 : 
´ofe
.
äeq
.
	`keyS‘
()) {

151 ià(!
š¡ªû_
.
wÜdLªgProbM­
.
	`cÚšsKey
(
wÜd
)) {

152 
š¡ªû_
.
wÜdLªgProbM­
.
	`put
(
wÜd
, 
Ãw
 [
Ïngsize
]);

154 
Ëngth
 = 
wÜd
.
	`Ëngth
();

155 ià(
Ëngth
 >= 1 &&†ength <= 3) {

156 
´ob
 = 
´ofe
.
äeq
.
	`g‘
(
wÜd
).
	`doubËV®ue
(è/…rofe.
n_wÜds
[
Ëngth
 - 1];

157 
š¡ªû_
.
wÜdLªgProbM­
.
	`g‘
(
wÜd
)[
šdex
] = 
´ob
;

160 
	}
}

165 
	$ş—r
() {

166 
š¡ªû_
.
Ïngli¡
.
	`ş—r
();

167 
š¡ªû_
.
wÜdLªgProbM­
.
	`ş—r
();

168 
	}
}

176 
public
 
D‘eùÜ
 
	$ü—‹
(è
throws
 
LªgD‘eùExû±iÚ
 {

177  
	`ü—‹D‘eùÜ
();

178 
	}
}

188 
public
 
D‘eùÜ
 
	$ü—‹
(
®pha
è
throws
 
LªgD‘eùExû±iÚ
 {

189 
D‘eùÜ
 
d‘eùÜ
 = 
	`ü—‹D‘eùÜ
();

190 
d‘eùÜ
.
	`£tAÍha
(
®pha
);

191  
d‘eùÜ
;

192 
	}
}

194 
´iv©e
 
D‘eùÜ
 
	$ü—‹D‘eùÜ
(è
throws
 
LªgD‘eùExû±iÚ
 {

195 ià(
š¡ªû_
.
Ïngli¡
.
	`size
() == 0)

196 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
N“dLßdProfeE¼Ü
, "needo†oad…rofiles");

197 
D‘eùÜ
 
d‘eùÜ
 = 
Ãw
 
	`D‘eùÜ
(
š¡ªû_
);

198  
d‘eùÜ
;

199 
	}
}

201 
public
 
	$£tS“d
(
£ed
) {

202 
š¡ªû_
.
£ed
 = seed;

203 
	}
}

205 
public
 
fš®
 
	gLi¡
<
	gSŒšg
> 
	$g‘LªgLi¡
() {

206  
CŞËùiÚs
.
	`unmodifŸbËLi¡
(
š¡ªû_
.
Ïngli¡
);

207 
	}
}

	@com/cybozu/labs/langdetect/GenProfile.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
;

3 
impÜt
 
	gjava
.
	gio
.
	gBufã»dIÅutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

5 
impÜt
 
	gjava
.
	gio
.
	gFe
;

6 
impÜt
 
	gjava
.
	gio
.
	gFeIÅutSŒ—m
;

7 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

8 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—m
;

9 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—mR—d”
;

10 
impÜt
 
	gjava
.
	gut
.
	gz
.
	gGZIPIÅutSŒ—m
;

12 
impÜt
 
	gjavax
.
	gxml
.
	g¡»am
.
	gXMLIÅutFaùÜy
;

13 
impÜt
 
	gjavax
.
	gxml
.
	g¡»am
.
	gXMLSŒ—mExû±iÚ
;

14 
impÜt
 
	gjavax
.
	gxml
.
	g¡»am
.
	gXMLSŒ—mR—d”
;

16 
impÜt
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
.
	gLªgProfe
;

17 
impÜt
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
.
	gNG¿m
;

18 
impÜt
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
.
	gTagExŒaùÜ
;

27 
public
 cÏs 
	cG’Profe
 {

36 
public
 
LªgProfe
 
	$lßdFromWikedŸAb¡¿ù
(
SŒšg
 
Ïng
, 
Fe
 
fe
è
throws
 
LªgD‘eùExû±iÚ
 {

38 
LªgProfe
 
´ofe
 = 
Ãw
 
	`LªgProfe
(
Ïng
);

40 
IÅutSŒ—m
 
is
 = 
nuÎ
;

41 
Œy
 {

42 
is
 = 
Ãw
 
	`Bufã»dIÅutSŒ—m
Òew 
	`FeIÅutSŒ—m
(
fe
));

43 ià(
fe
.
	`g‘Name
().
	`’dsW™h
(".gz")è
is
 = 
Ãw
 
	`GZIPIÅutSŒ—m
(is);

45 
TagExŒaùÜ
 
gexŒaùÜ
 = 
Ãw
 
	`TagExŒaùÜ
("abstract", 100);

47 
XMLSŒ—mR—d”
 
»ad”
 = 
nuÎ
;

48 
Œy
 {

49 
XMLIÅutFaùÜy
 
çùÜy
 = XMLIÅutFaùÜy.
	`ÃwIn¡ªû
();

50 
»ad”
 = 
çùÜy
.
	`ü—‹XMLSŒ—mR—d”
(
is
);

51 
»ad”
.
	`hasNext
()) {

52 
»ad”
.
	`Ãxt
()) {

53 
XMLSŒ—mR—d”
.
START_ELEMENT
:

54 
gexŒaùÜ
.
	`£tTag
(
»ad”
.
	`g‘Name
().
	`toSŒšg
());

56 
XMLSŒ—mR—d”
.
CHARACTERS
:

57 
gexŒaùÜ
.
	`add
(
»ad”
.
	`g‘Text
());

59 
XMLSŒ—mR—d”
.
END_ELEMENT
:

60 
gexŒaùÜ
.
	`şo£Tag
(
´ofe
);

64 } 
	`ÿtch
 (
XMLSŒ—mExû±iÚ
 
e
) {

65 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
T¿šD©aFÜm©E¼Ü
, "T¿ššg d©aba£ f'" + 
fe
.
	`g‘Name
() + "' is‡n invalid XML.");

66 } 
fš®ly
 {

67 
Œy
 {

68 ià(
»ad”
 !ğ
nuÎ
è»ad”.
	`şo£
();

69 } 
	`ÿtch
 (
XMLSŒ—mExû±iÚ
 
e
) {}

71 
Sy¡em
.
out
.
	`´šn
(
Ïng
 + ":" + 
gexŒaùÜ
.
	`couÁ
());

73 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

74 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
CªtO³nT¿šD©a
, "Cª'ˆİ’¿ššg d©aba£ f'" + 
fe
.
	`g‘Name
() + "'");

75 } 
fš®ly
 {

76 
Œy
 {

77 ià(
is
 !ğ
nuÎ
èis.
	`şo£
();

78 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {}

80  
´ofe
;

90 
public
 
LªgProfe
 
	$lßdFromText
(
SŒšg
 
Ïng
, 
Fe
 
fe
è
throws
 
LªgD‘eùExû±iÚ
 {

92 
LªgProfe
 
´ofe
 = 
Ãw
 
	`LªgProfe
(
Ïng
);

94 
Bufã»dR—d”
 
is
 = 
nuÎ
;

95 
Œy
 {

96 
is
 = 
Ãw
 
	`Bufã»dR—d”
Òew 
	`IÅutSŒ—mR—d”
Òew 
	`FeIÅutSŒ—m
(
fe
), "utf-8"));

98 
couÁ
 = 0;

99 
is
.
	`»ady
()) {

100 
SŒšg
 
lše
 = 
is
.
	`»adLše
();

101 
NG¿m
 
g¿m
 = 
Ãw
 
	`NG¿m
();

102 
i
=0; i<
lše
.
	`Ëngth
(); ++i) {

103 
g¿m
.
	`addCh¬
(
lše
.
	`ch¬At
(
i
));

104 
n
=1;‚<=
NG¿m
.
N_GRAM
; ++n) {

105 
´ofe
.
	`add
(
g¿m
.
	`g‘
(
n
));

108 ++
couÁ
;

111 
Sy¡em
.
out
.
	`´šn
(
Ïng
 + ":" + 
couÁ
);

113 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

114 
throw
 
Ãw
 
	`LªgD‘eùExû±iÚ
(
E¼ÜCode
.
CªtO³nT¿šD©a
, "Cª'ˆİ’¿ššg d©aba£ f'" + 
fe
.
	`g‘Name
() + "'");

115 } 
fš®ly
 {

116 
Œy
 {

117 ià(
is
 !ğ
nuÎ
èis.
	`şo£
();

118 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {}

120  
´ofe
;

121 
	}
}

	@com/cybozu/labs/langdetect/LangDetectException.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
;

6 
	eE¼ÜCode
 {

7 
	mNoTextE¼Ü
, 
	mFÜm©E¼Ü
, 
	mFeLßdE¼Ü
, 
	mDu¶iÿ‹LªgE¼Ü
, 
	mN“dLßdProfeE¼Ü
, 
	mCªtD‘eùE¼Ü
, 
	mCªtO³nT¿šD©a
, 
	mT¿šD©aFÜm©E¼Ü
, 
	mIn™P¬amE¼Ü


14 
public
 cÏs 
	cLªgD‘eùExû±iÚ
 
ex‹nds
 
	mExû±iÚ
 {

15 
´iv©e
 
fš®
 
	m£rŸlV”siÚUID
 = 1L;

16 
´iv©e
 
E¼ÜCode
 
	mcode
;

23 
public
 
	$LªgD‘eùExû±iÚ
(
E¼ÜCode
 
code
, 
SŒšg
 
mes§ge
) {

24 
	`su³r
(
mes§ge
);

25 
this
.
code
 = code;

31 
public
 
E¼ÜCode
 
	$g‘Code
() {

32  
code
;

33 
	}
}

	@com/cybozu/labs/langdetect/Language.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
;

3 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

13 
public
 cÏs 
	cLªguage
 {

14 
public
 
SŒšg
 
	mÏng
;

15 
public
 
	m´ob
;

16 
public
 
	$Lªguage
(
SŒšg
 
Ïng
, 
´ob
) {

17 
this
.
Ïng
 =†ang;

18 
this
.
´ob
 =…rob;

20 
public
 
SŒšg
 
	$toSŒšg
() {

21 ià(
Ïng
==
nuÎ
)  "";

22  
Ïng
 + ":" + 
´ob
;

23 
	}
}

	@com/cybozu/labs/langdetect/util/LangProfile.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
;

3 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

4 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

5 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

13 
public
 cÏs 
	cLªgProfe
 {

14 
´iv©e
 
fš®
 
	mMINIMUM_FREQ
 = 2;

15 
´iv©e
 
fš®
 
	mLESS_FREQ_RATIO
 = 100000;

16 
public
 
SŒšg
 
	mÇme
 = 
nuÎ
;

17 
public
 
	mHashM­
<
	mSŒšg
, 
	mIÁeg”
> 
	mäeq
 = 
Ãw
 
HashM­
<
SŒšg
, Integer>();

18 
public
 [] 
	mn_wÜds
 = 
Ãw
 [
NG¿m
.
N_GRAM
];

23 
public
 
	$LªgProfe
() {}

29 
public
 
	$LªgProfe
(
SŒšg
 
Çme
) {

30 
this
.
Çme
 =‚ame;

31 
	}
}

37 
public
 
	$add
(
SŒšg
 
g¿m
) {

38 ià(
Çme
 =ğ
nuÎ
 || 
g¿m
 ==‚ull) ;

39 
Ën
 = 
g¿m
.
	`Ëngth
();

40 ià(
Ën
 < 1 ||†’ > 
NG¿m
.
N_GRAM
) ;

41 ++
n_wÜds
[
Ën
 - 1];

42 ià(
äeq
.
	`cÚšsKey
(
g¿m
)) {

43 
äeq
.
	`put
(
g¿m
, f»q.
	`g‘
(gram) + 1);

45 
äeq
.
	`put
(
g¿m
, 1);

47 
	}
}

52 
public
 
	$om™LessF»q
() {

53 ià(
Çme
 =ğ
nuÎ
) ;

54 
th»shŞd
 = 
n_wÜds
[0] / 
LESS_FREQ_RATIO
;

55 ià(
th»shŞd
 < 
MINIMUM_FREQ
)hreshold = MINIMUM_FREQ;

57 
S‘
<
SŒšg
> 
keys
 = 
äeq
.
	`keyS‘
();

58 
romª
 = 0;

59 
I‹¿tÜ
<
SŒšg
> 
i
 = 
keys
.
	`™”©Ü
(); i.
	`hasNext
(); ){

60 
SŒšg
 
key
 = 
i
.
	`Ãxt
();

61 
couÁ
 = 
äeq
.
	`g‘
(
key
);

62 ià(
couÁ
 <ğ
th»shŞd
) {

63 
n_wÜds
[
key
.
	`Ëngth
()-1] -ğ
couÁ
;

64 
i
.
	`»move
();

66 ià(
key
.
	`m©ches
("^[A-Za-z]$")) {

67 
romª
 +ğ
couÁ
;

73 ià(
romª
 < 
n_wÜds
[0] / 3) {

74 
S‘
<
SŒšg
> 
keys2
 = 
äeq
.
	`keyS‘
();

75 
I‹¿tÜ
<
SŒšg
> 
i
 = 
keys2
.
	`™”©Ü
(); i.
	`hasNext
(); ){

76 
SŒšg
 
key
 = 
i
.
	`Ãxt
();

77 ià(
key
.
	`m©ches
(".*[A-Za-z].*")) {

78 
n_wÜds
[
key
.
	`Ëngth
()-1] -ğ
äeq
.
	`g‘
(key);

79 
i
.
	`»move
();

84 
	}
}

	@com/cybozu/labs/langdetect/util/Messages.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
;

3 
impÜt
 
	gjava
.
	gut
.
	gMissšgResourûExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gResourûBundË
;

11 
public
 cÏs 
	cMes§ges
 {

12 
´iv©e
 
fš®
 
SŒšg
 
	mBUNDLE_NAME
 = "com.cybozu.labs.langdetect.util.messages";

14 
´iv©e
 
fš®
 
ResourûBundË
 
	mRESOURCE_BUNDLE
 = ResourûBundË.
g‘BundË
(
BUNDLE_NAME
);

16 
´iv©e
 
	$Mes§ges
() {

19 
public
 
SŒšg
 
	$g‘SŒšg
(
SŒšg
 
key
) {

20 
Œy
 {

21  
RESOURCE_BUNDLE
.
	`g‘SŒšg
(
key
);

22 } 
	`ÿtch
 (
MissšgResourûExû±iÚ
 
e
) {

23  '!' + 
key
 + '!';

25 
	}
}

	@com/cybozu/labs/langdetect/util/NGram.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
;

3 
impÜt
 
	gjava
.
	gÏng
.
	gCh¬aù”
.
	gUnicodeBlock
;

4 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

11 
public
 cÏs 
	cNG¿m
 {

12 
´iv©e
 
fš®
 
SŒšg
 
	mLATIN1_EXCLUDED
 = 
Mes§ges
.
g‘SŒšg
("NGram.LATIN1_EXCLUDE");

13 
public
 
fš®
 
	mN_GRAM
 = 3;

14 
public
 
	mHashM­
<
	mCh¬aù”
, Ch¬aù”> 
	mcjk_m­
;

16 
´iv©e
 
SŒšgBufãr
 
	mg¿ms_
;

17 
´iv©e
 
boŞ—n
 
	mÿp™®wÜd_
;

22 
public
 
	$NG¿m
() {

23 
g¿ms_
 = 
Ãw
 
	`SŒšgBufãr
(" ");

24 
ÿp™®wÜd_
 = 
çl£
;

30 
public
 
	$addCh¬
(
ch
) {

31 
ch
 = 
	`nÜm®ize
(ch);

32 
Ï¡ch¬
 = 
g¿ms_
.
	`ch¬At
(g¿ms_.
	`Ëngth
() - 1);

33 ià(
Ï¡ch¬
 == ' ') {

34 
g¿ms_
 = 
Ãw
 
	`SŒšgBufãr
(" ");

35 
ÿp™®wÜd_
 = 
çl£
;

36 ià(
ch
==' ') ;

37 } ià(
g¿ms_
.
	`Ëngth
(è>ğ
N_GRAM
) {

38 
g¿ms_
.
	`d–‘eCh¬At
(0);

40 
g¿ms_
.
	`­³nd
(
ch
);

42 ià(
Ch¬aù”
.
	`isUµ”Ca£
(
ch
)){

43 ià(
Ch¬aù”
.
	`isUµ”Ca£
(
Ï¡ch¬
)è
ÿp™®wÜd_
 = 
Œue
;

45 
ÿp™®wÜd_
 = 
çl£
;

47 
	}
}

54 
public
 
SŒšg
 
	$g‘
(
n
) {

55 ià(
ÿp™®wÜd_
è 
nuÎ
;

56 
Ën
 = 
g¿ms_
.
	`Ëngth
();

57 ià(
n
 < 1 ||‚ > 3 || 
Ën
 <‚è 
nuÎ
;

58 ià(
n
 == 1) {

59 
ch
 = 
g¿ms_
.
	`ch¬At
(
Ën
 - 1);

60 ià(
ch
 =ğ' 'è 
nuÎ
;

61  
Ch¬aù”
.
	`toSŒšg
(
ch
);

63  
g¿ms_
.
	`sub¡ršg
(
Ën
 - 
n
,†en);

65 
	}
}

72 
public
 
	$nÜm®ize
(
ch
) {

73 
Ch¬aù”
.
UnicodeBlock
 
block
 = Ch¬aù”.UnicodeBlock.
	`of
(
ch
);

74 ià(
block
 =ğ
UnicodeBlock
.
BASIC_LATIN
) {

75 ià(
ch
<'A' || (ch<'a' && ch >'Z') || ch>'z') ch = ' ';

76 } ià(
block
 =ğ
UnicodeBlock
.
LATIN_1_SUPPLEMENT
) {

77 ià(
LATIN1_EXCLUDED
.
	`šdexOf
(
ch
)>=0) ch = ' ';

78 } ià(
block
 =ğ
UnicodeBlock
.
GENERAL_PUNCTUATION
) {

79 
ch
 = ' ';

80 } ià(
block
 =ğ
UnicodeBlock
.
ARABIC
) {

81 ià(
ch
 == '\u06cc') ch = '\u064a';

82 } ià(
block
 =ğ
UnicodeBlock
.
LATIN_EXTENDED_ADDITIONAL
) {

83 ià(
ch
 >= '\u1ea0') ch = '\u1ec3';

84 } ià(
block
 =ğ
UnicodeBlock
.
HIRAGANA
) {

85 
ch
 = '\u3042';

86 } ià(
block
 =ğ
UnicodeBlock
.
KATAKANA
) {

87 
ch
 = '\u30a2';

88 } ià(
block
 =ğ
UnicodeBlock
.
BOPOMOFO
 || block =ğUnicodeBlock.
BOPOMOFO_EXTENDED
) {

89 
ch
 = '\u3105';

90 } ià(
block
 =ğ
UnicodeBlock
.
CJK_UNIFIED_IDEOGRAPHS
) {

91 ià(
cjk_m­
.
	`cÚšsKey
(
ch
)èch = cjk_m­.
	`g‘
(ch);

92 } ià(
block
 =ğ
UnicodeBlock
.
HANGUL_SYLLABLES
) {

93 
ch
 = '\uac00';

95  
ch
;

96 
	}
}

103 
fš®
 
	gSŒšg
[] 
	gCJK_CLASS
 = {

104 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_0"),

105 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_2"),

106 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_4"),

107 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_8"),

108 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_11"),

109 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_12"),

110 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_13"),

111 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_14"),

112 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_16"),

113 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_18"),

114 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_22"),

115 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_27"),

116 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_29"),

117 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_31"),

118 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_1_35"),

119 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_0"),

120 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_1"),

121 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_4"),

122 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_9"),

123 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_10"),

124 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_11"),

125 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_12"),

126 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_13"),

127 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_15"),

128 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_16"),

129 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_18"),

130 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_21"),

131 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_22"),

132 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_23"),

133 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_28"),

134 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_29"),

135 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_30"),

136 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_31"),

137 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_32"),

138 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_35"),

139 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_36"),

140 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_37"),

141 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_2_38"),

142 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_1"),

143 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_2"),

144 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_3"),

145 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_4"),

146 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_5"),

147 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_8"),

148 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_9"),

149 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_11"),

150 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_12"),

151 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_13"),

152 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_15"),

153 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_16"),

154 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_18"),

155 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_19"),

156 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_22"),

157 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_23"),

158 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_27"),

159 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_29"),

160 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_30"),

161 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_31"),

162 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_32"),

163 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_35"),

164 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_36"),

165 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_37"),

166 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_3_38"),

167 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_0"),

168 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_9"),

169 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_10"),

170 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_16"),

171 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_17"),

172 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_18"),

173 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_22"),

174 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_24"),

175 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_28"),

176 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_34"),

177 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_4_39"),

178 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_10"),

179 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_11"),

180 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_12"),

181 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_13"),

182 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_14"),

183 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_18"),

184 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_26"),

185 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_29"),

186 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_34"),

187 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_5_39"),

188 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_0"),

189 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_3"),

190 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_9"),

191 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_10"),

192 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_11"),

193 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_12"),

194 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_16"),

195 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_18"),

196 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_20"),

197 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_21"),

198 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_22"),

199 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_23"),

200 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_25"),

201 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_28"),

202 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_29"),

203 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_30"),

204 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_32"),

205 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_34"),

206 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_35"),

207 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_37"),

208 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_6_39"),

209 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_0"),

210 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_3"),

211 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_6"),

212 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_7"),

213 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_9"),

214 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_11"),

215 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_12"),

216 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_13"),

217 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_16"),

218 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_18"),

219 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_19"),

220 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_20"),

221 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_21"),

222 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_23"),

223 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_25"),

224 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_28"),

225 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_29"),

226 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_32"),

227 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_33"),

228 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_35"),

229 
Mes§ges
.
g‘SŒšg
("NGram.KANJI_7_37"),

232 
	gcjk_m­
 = 
Ãw
 
HashM­
<
Ch¬aù”
, 
	gCh¬aù”
>();

233 
SŒšg
 
	gcjk_li¡
 : 
CJK_CLASS
) {

234 
»´e£Á©ive
 = 
cjk_li¡
.
ch¬At
(0);

235 
	gi
=0;i<
	gcjk_li¡
.
Ëngth
();++i) {

236 
	gcjk_m­
.
put
(
cjk_li¡
.
ch¬At
(
i
), 
»´e£Á©ive
);

	@com/cybozu/labs/langdetect/util/TagExtractor.java

1 
·ckage
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gut
;

8 
public
 cÏs 
	cTagExŒaùÜ
 {

9  
SŒšg
 
	mrg‘_
;

10  
	mth»shŞd_
;

11  
SŒšgBufãr
 
	mbuf_
;

12  
SŒšg
 
	mg_
;

13 
´iv©e
 
	mcouÁ_
;

15 
public
 
	$TagExŒaùÜ
(
SŒšg
 
g
, 
th»shŞd
) {

16 
rg‘_
 = 
g
;

17 
th»shŞd_
 = 
th»shŞd
;

18 
couÁ_
 = 0;

19 
	`ş—r
();

21 
public
 
	$couÁ
() {

22  
couÁ_
;

23 
	}
}

24 
public
 
	$ş—r
() {

25 
buf_
 = 
Ãw
 
	`SŒšgBufãr
();

26 
g_
 = 
nuÎ
;

27 
	}
}

28 
public
 
	$£tTag
(
SŒšg
 
g
){

29 
g_
 = 
g
;

30 
	}
}

31 
public
 
	$add
(
SŒšg
 
lše
) {

32 ià(
g_
 =ğ
rg‘_
 && 
lše
 !ğ
nuÎ
) {

33 
buf_
.
	`­³nd
(
lše
);

35 
	}
}

36 
public
 
	$şo£Tag
(
LªgProfe
 
´ofe
) {

37 ià(
´ofe
 !ğ
nuÎ
 && 
g_
 =ğ
rg‘_
 && 
buf_
.
	`Ëngth
(è> 
th»shŞd_
) {

38 
NG¿m
 
g¿m
 = 
Ãw
 
	`NG¿m
();

39 
i
=0; i<
buf_
.
	`Ëngth
(); ++i) {

40 
g¿m
.
	`addCh¬
(
buf_
.
	`ch¬At
(
i
));

41 
n
=1;‚<=
NG¿m
.
N_GRAM
; ++n) {

42 
´ofe
.
	`add
(
g¿m
.
	`g‘
(
n
));

45 ++
couÁ_
;

47 
	`ş—r
();

48 
	}
}

	@com/zhongsou/BMTrieNode.java

1 
·ckage
 
	gcom
.
	gzhÚgsou


	@com/zhongsou/incload/DeDup.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

5 
impÜt
 
	gjava
.
	g‹xt
.
	gP¬£Exû±iÚ
;

6 
impÜt
 
	gjava
.
	gut
.
	gD©e
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gCom·»F‹r
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹rLi¡
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gSšgËCŞumnV®ueF‹r
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gcom´ess
.
	gCom´essiÚCodec
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gcom´ess
.
	gSÇµyCodec
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞ
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞRuÂ”
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

31 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gBš¬yOuutFÜm©
;

43 
public
 
şass
 
DeDup
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	gToŞ
, 
	gM­»duûV2Job
 {

44 
Logg”
 
	glogg”
 = Logg”.
g‘Logg”
(
DeDup
.
şass
);

45 
´iv©e
 
fš®
 
	gby‹
[] 
	gcf
 = 
By‹s
.
toBy‹s
("P");

46 
´iv©e
 
D©eFÜm©
 
	gd©eFÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyyMMddHHmmss");

48 
public
 
Job
 
ü—‹Job
(
SŒšg
 
¬gs
[]è
throws
 
	gIOExû±iÚ
 {

49 
CÚfigu¿tiÚ
 
	gcÚf
 = 
this
.
g‘CÚf
();

51 
	gcÚf
.
£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

52 
	gcÚf
.
£tCÏss
("m­»d.m­.ouut.com´essiÚ.codec", 
SÇµyCodec
.
şass
, 
Com´essiÚCodec
.class);

53 
SŒšg
 
	gbË
 = 
cÚf
.
g‘
("scanTable", "webDB");

54 
Sÿn
 
	gsÿn
 = 
Ãw
 Scan();

55 
	gsÿn
.
addCŞumn
(
cf
, 
By‹s
.
toBy‹s
("f"));

56 
	gsÿn
.
addCŞumn
(
cf
, 
By‹s
.
toBy‹s
("p"));

57 
	gsÿn
.
addCŞumn
(
cf
, 
By‹s
.
toBy‹s
("la"));

58 
	gsÿn
.
addCŞumn
(
cf
, 
By‹s
.
toBy‹s
("n"));

59 
	gÿchšg
 = 
cÚf
.
g‘IÁ
("tableCaching", 500);

60 
	gsÿn
.
£tCachšg
(
ÿchšg
);

61 
	gsÿn
.
£tCacheBlocks
(
çl£
);

62 
	gsÿn
.
£tMaxV”siÚs
(1);

63 
SŒšg
 
	glßdTime
 = 
cÚf
.
g‘
("£qTime¡amp", "0").
Œim
();

64 ià(
	glßdTime
.
equ®s
("0")) {

65 
	glogg”
.
šfo
("must give‡‚ew†oadimestamp");

66  
	gnuÎ
;

68 
	gtime¡amp
 = 0;

69 
	gŒy
 {

70 
D©e
 
	gd
 = 
d©eFÜm©
.
·r£
(
lßdTime
);

71 
	gtime¡amp
 = (è(
d
.
g‘Time
() / 1000l);

72 
	gcÚf
.
£tIÁ
("time¡amp", 
time¡amp
);

73 
	glogg”
.
šfo
("lßdtim" + 
lßdTime
 + " cÚv”ˆtØ¨šˆ" + 
time¡amp
);

74 } 
ÿtch
 (
P¬£Exû±iÚ
 
e
) {

76 
	ge
.
´štSckT¿û
();

77 
	glogg”
.
”rÜ
("·r£ d©fÜm©ƒ¼Ü " + 
lßdTime
);

78  
	gnuÎ
;

80 
	gtsNf
 = 
time¡amp
;

81 ià(
	gtsNf
 == 0) {

82 
Log
.
šfo
("must give‡‚ew†oadimestamp");

83  
	gnuÎ
;

85 
F‹rLi¡
 
	gli¡
 = 
Ãw
 F‹rLi¡(F‹rLi¡.
O³¿tÜ
.
MUST_PASS_ONE
);

86 
SšgËCŞumnV®ueF‹r
 
	gnff
 = 
nuÎ
;

87 
SšgËCŞumnV®ueF‹r
 
	glff
 = 
nuÎ
;

88 
	gnff
 = 
Ãw
 
SšgËCŞumnV®ueF‹r
(
cf
, 
By‹s
.
toBy‹s
("n"), 
Com·»F‹r
.
Com·»Op
.
EQUAL
, By‹s.toBy‹s(
tsNf
));

89 
	gnff
.
£tF‹rIfMissšg
(
Œue
);

90 
	gli¡
.
addF‹r
(
nff
);

92 
	glff
 = 
Ãw
 
SšgËCŞumnV®ueF‹r
(
cf
, 
By‹s
.
toBy‹s
("Ï"), 
Com·»F‹r
.
Com·»Op
.
NOT_EQUAL
, Bytes.toBytes("0"));

93 
	glff
.
£tF‹rIfMissšg
(
Œue
);

94 
	gli¡
.
addF‹r
(
lff
);

95 
	gsÿn
.
£tF‹r
(
li¡
);

96 
Job
 
	gjob
 = 
Ãw
 Job(
cÚf
);

97 
	gjob
.
£tJ¬ByCÏss
(
DeDup
.
şass
);

98 
	gTabËM­ReduûUt
.
š™TabËM­³rJob
(
bË
, 
sÿn
, 
DeDupM­³r
.
şass
, 
KeyV®uePaœ
.şass, 
DupPaœ
.şass, 
job
);

100 
	gjob
.
£tReduûrCÏss
(
DeDupReduûr
.
şass
);

103 
	gjob
.
£tP¬t™iÚ”CÏss
(
U¾idP¬t™iÚ”
.
şass
);

104 
	gjob
.
£tGroupšgCom·¿tÜCÏss
(
U¾idGroupšgCom·¿tÜ
.
şass
);

105 
	gjob
.
£tM­S³cuÏtiveExecutiÚ
(
çl£
);

106 
	gjob
.
£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

107 
	gjob
.
£tOuutV®ueCÏss
(
DupPaœ
.
şass
);

108 
	gjob
.
£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

109 
P©h
 
	gouut
 = 
Ãw
 P©h(
¬gs
[0]);

110 
	gSequ’ûFeOuutFÜm©
.
£tOuutP©h
(
job
, 
ouut
);

113 
	gMuÉËOuuts
.
addNamedOuut
(
job
, "uÆßdKey", 
Sequ’ûFeOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.şass, 
NuÎWr™abË
.class);

116  
	gjob
;

120 
public
 
run
(
SŒšg
[] 
¬gs
è
throws
 
	gExû±iÚ
 {

121 
	gi
 = 0;

122 
SŒšg
 
	g¬g
 : 
¬gs
) {

123 
Sy¡em
.
out
.
´šn
("¬g " + 
i
 + ":" + 
¬g
);

124 
	gi
++;

127 
Job
 
	gjob
 = 
this
.
ü—‹Job
(
¬gs
);

128 ià(
	gjob
 !ğ
nuÎ
)

129  
job
.
wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : -1;

134 
public
 
maš
(
SŒšg
[] 
¬gs
è
throws
 
	gExû±iÚ
 {

135 
CÚfigu¿tiÚ
 
	gcÚf
 = 
HBa£CÚfigu¿tiÚ
.
ü—‹
();

136 
	gSŒšg
[] 
	gÙh”Args
;

137 
	gŒy
 {

138 
	gÙh”Args
 = 
Ãw
 
G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
g‘RemaššgArgs
();

139 ià(
	gÙh”Args
.
	gËngth
 < 1) {

140 
	gSy¡em
.
	gout
.
´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + "‡rgs: urldocid‚ewurlinfo outputpath‚umber_of_reduce");

141 
	gSy¡em
.
ex™
(-1);

143 
DeDup
 
	gp
 = 
Ãw
 DeDup();

144 
	gp
.
£tCÚf
(
cÚf
);

145 
Job
 
	gjob
 = 
p
.
ü—‹Job
(
Ùh”Args
);

146 
	gjob
.
wa™FÜCom¶‘iÚ
(
Œue
);

147 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

149 
	ge
.
´štSckT¿û
();

150 } 
ÿtch
 (
Exû±iÚ
 
e
) {

152 
	ge
.
´štSckT¿û
();

160 
public
 
şass
 
U¾idP¬t™iÚ”
 
ex‹nds
 
	gP¬t™iÚ”
<
	gKeyV®uePaœ
, 
	gDupPaœ
> {

161 @
Ov”ride


162 
public
 
g‘P¬t™iÚ
(
KeyV®uePaœ
 
key
, 
DupPaœ
 
v®ue
, 
numP¬t™iÚs
) {

163  (
	gkey
.
g‘DupU¾id
().
hashCode
(è& 
	gIÁeg”
.
	gMAX_VALUE
è% 
	gnumP¬t™iÚs
;

173 
public
 şas 
	cU¾idGroupšgCom·¿tÜ
 
ex‹nds
 
	gWr™abËCom·¿tÜ
 {

175 
´Ùeùed
 
U¾idGroupšgCom·¿tÜ
() {

176 
su³r
(
KeyV®uePaœ
.
şass
, 
Œue
);

179 @
Ov”ride


180 
public
 
com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

181  
	gWr™abËCom·¿tÜ
.
com·»By‹s
(
b1
, 
s1
 + 4, 8, 
b2
, 
s2
 + 4, 8);

186 @
Ov”ride


187 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

189 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

190 
SŒšg
[] 
Ùh”Args
;

191 
Œy
 {

192 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

193 ià(
Ùh”Args
.
Ëngth
 < 1) {

194 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + "‡rgs: urldocid‚ewurlinfo outputpath‚umber_of_reduce");

195 
Sy¡em
.
	`ex™
(-1);

197 
this
.
	`£tCÚf
(
cÚf
);

198 
Job
 
job
 = 
	`ü—‹Job
(
Ùh”Args
);

199  
job
;

200 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

202 
e
.
	`´štSckT¿û
();

203 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

205 
e
.
	`´štSckT¿û
();

207  
nuÎ
;

209 
	}
}

	@com/zhongsou/incload/DeDupMapper.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

5 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

6 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gM­
;

8 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

14 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

16 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

24 
public
 
şass
 
DeDupM­³r
 
ex‹nds
 
	gTabËM­³r
<
	gKeyV®uePaœ
, 
	gDupPaœ
> {

26 
´iv©e
 
fš®
 
	gTABLE_SIZE
 = 4;

27 
´iv©e
 
fš®
 
	gURLID_LEN
 = 8;

28 
´iv©e
 
fš®
 
	gFINGER_PREFIX_LEN
 = 2;

29 
´iv©e
 
fš®
 
	gFINGER_SUFFIX_LEN
 = 6;

30 
´iv©e
 
fš®
 
	gURLID_FINGERSUFFIX_SIZE
 = 14;

32 
´iv©e
 
	gM­
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË> 
	gm­
 = 
nuÎ
;

33 
´iv©e
 
	gS‘
<
	gImmubËBy‹sWr™abË
> 
	gkeyS‘
 = 
nuÎ
;

34 
´iv©e
 
	gLi¡
<
	gM­
<
	gCh¬aù”
, 
	gby‹
[]>> 
	gextTabËs
 = 
nuÎ
;

36 
´iv©e
 
fš®
 
	gby‹
[] 
	gcŞumnFamy
 = 
By‹s
.
toBy‹s
("P");

37 
´iv©e
 
fš®
 
	gby‹
[] 
	gf
 = 
By‹s
.
toBy‹s
("f");

38 
´iv©e
 
fš®
 
	gby‹
[] 
	gp
 = 
By‹s
.
toBy‹s
("p");

39 
´iv©e
 
fš®
 
	gby‹
[] 
	gl
 = 
By‹s
.
toBy‹s
("la");

40 
´iv©e
 
fš®
 
	gby‹
[] 
	gn
 = 
By‹s
.
toBy‹s
("n");

42 
´iv©e
 
ImmubËBy‹sWr™abË
 
	gdupU¾id
 = 
Ãw
 ImmutableBytesWritable();

43 
´iv©e
 
DupPaœ
 
	gv®ue
 = 
Ãw
 DupPair();

44 
´iv©e
 
KeyV®uePaœ
 
	gcombšeKey
 = 
Ãw
 KeyValuePair();

46 
´iv©e
 
fš®
 
PageNode
 
	gn1
 = 
Ãw
 PageNode();

47 
´iv©e
 
fš®
 
PageNode
 
	gn2
 = 
nuÎ
;

49 
´iv©e
 
	gby‹
[] 
	gcu¼’tPfxA¼ay
 = 
Ãw
 
by‹
[
FINGER_PREFIX_LEN
];

50 
´iv©e
 
	gby‹
[] 
	g´obedU¾id
 = 
Ãw
 
by‹
[
URLID_LEN
];

51 
´iv©e
 
	gby‹
[] 
	g³rmu‹dFšg”Suffixs
 = 
Ãw
 
by‹
[
FINGER_SUFFIX_LEN


52 * 
TABLE_SIZE
];

54 
´iv©e
 
fš®
 
	gby‹
[] 
	gLOAD
 = 
By‹s
.
toBy‹s
("1");

55 
´iv©e
 
fš®
 
	gby‹
[] 
	gUNLOAD
 = 
By‹s
.
toBy‹s
("0");

56 
´iv©e
 
fš®
 
	gby‹
[] 
	gNEW
 = 
By‹s
.
toBy‹s
("1");

57 
´iv©e
 
fš®
 
	gby‹
[] 
	gOLD
 = 
By‹s
.
toBy‹s
("0");

58 
´iv©e
 
	gby‹
[] 
	gtime¡ampBy‹
;

59 
´iv©e
 
fš®
 
	gby‹
[] 
	gZERO
 = 
By‹s
.
toBy‹s
("0");

60 
´iv©e
 
fš®
 
	gby‹
[] 
	g®lz”o
 = 
Ãw
 
by‹
[8];

61 
´iv©e
 
	gS‘
<
	gImmubËBy‹sWr™abË
> 
	gdupU¾idS‘
 = 
Ãw
 
HashS‘
<
ImmubËBy‹sWr™abË
>(4);

63 
´iv©e
 
	gts
;

65 
	eMyCouÁ”
 {

66 
	gEMIT1
, 
	gEMIT2
, 
	gEMIT3
, 
	gEMIT4
;

69 @
Ov”ride


70 
public
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
 {

71 
SŒšg
 
	guric
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘
("urlid_finger_load_file");

72 
MemTabË
 
	gmemTabË
 = 
Ãw
 MemTabË(
cÚ‹xt
.
g‘CÚfigu¿tiÚ
());

73 
	gm­
 = 
memTabË
.
budTabË
(
uric
);

74 
	gkeyS‘
 = 
m­
.
keyS‘
();

75 
	gLog
.
šfo
("thsizoà³¸memabË:\t" + 
keyS‘
.
size
());

76 
	gextTabËs
 = 
memTabË
.
budExtTabË
(
m­
);

77 
	gts
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘IÁ
("timestamp", 0);

78 
	gtime¡ampBy‹
 = 
By‹s
.
toBy‹s
(
ts
);

79 
	gLog
.
šfo
("Ãwime¡am°fÜ‚f:" + 
ts
);

96 @
Ov”ride


97 
public
 
m­
(
ImmubËBy‹sWr™abË
 
row
, 
ResuÉ
 
cŞumns
, 
CÚ‹xt
 
cÚ‹xt
)

98 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

100 
	gby‹
[] 
	gu¾id
 = 
nuÎ
;

101 
	gby‹
[] 
	gfšg”
 = 
nuÎ
;

102 
	gby‹
[] 
	gÃwfšg”
 = 
nuÎ
;

103 
	gby‹
[] 
	g´
 = 
nuÎ
;

104 
	gby‹
[] 
	glf
 = 
nuÎ
;

105 
	gby‹
[] 
	gnf
 = 
nuÎ
;

108 
Ch¬aù”
 
	gcu¼’tPfx
 = 
nuÎ
;

109 
	gM­
<
	gCh¬aù”
, 
	gby‹
[]> 
	gcu¼’tExtTabË
 = 
nuÎ
;

110 
	gby‹
[] 
	g´efixM©chedTabËV®ue
 = 
nuÎ
;

111 
	gŒy
 {

112 
	gu¾id
 = 
cŞumns
.
g‘Row
();

113 
	gfšg”
 = 
cŞumns
.
g‘V®ue
(
cŞumnFamy
, 
f
);

114 
	g´
 = 
cŞumns
.
g‘V®ue
(
cŞumnFamy
, 
p
);

117 ià((
	glf
 = 
cŞumns
.
g‘V®ue
(
cŞumnFamy
, 
l
)è!ğ
nuÎ
) {

119 ià(
By‹s
.
com·»To
(
lf
, 
ZERO
) != 0)

120 
lf
 = 
LOAD
;

122 
	glf
 = 
UNLOAD
;

124 
	glf
 = 
UNLOAD
;

127 
	gnf
 = 
cŞumns
.
g‘V®ue
(
cŞumnFamy
, 
n
);

129 ià(
	gnf
 !ğ
nuÎ
 && 
A¼ays
.
equ®s
(
nf
, 
time¡ampBy‹
)) {

130 
	gnf
 = 
NEW
;

131 
	gcÚ‹xt
.
g‘CouÁ”
("dedup", "Ãw").
šüem’t
(1);

133 
	gnf
 = 
OLD
;

134 
	gcÚ‹xt
.
g‘CouÁ”
("dedup", "Şd").
šüem’t
(1);

137 
	gn1
.
£t
(
u¾id
, 
fšg”
, 
´
, 
lf
, 
nf
);

141 ià(
	gkeyS‘
.
cÚšs
(
row
) ||

142 (
	gA¼ays
.
equ®s
(
lf
, 
LOAD
è&& A¼ays.equ®s(
nf
, 
OLD
))) {

144 ià(
	gkeyS‘
.
cÚšs
(
row
)) {

145 
	gÃwfšg”
 = 
this
.
m­
.
g‘
(
row
).get();

148 ià(
	gfšg”
 !ğ
nuÎ
 && 
A¼ays
.
equ®s
(
fšg”
, 
Ãwfšg”
è&& 
	gA¼ays
.equ®s(
lf
, 
LOAD
)) {

149 
	gv®ue
.
£t
(
n2
,‚2);

150 
	gcombšeKey
.
£t
(
row
, 
v®ue
);

151 
	gcÚ‹xt
.
wr™e
(
combšeKey
, 
v®ue
);

152 
	gcÚ‹xt
.
g‘CouÁ”
("dedup", "§me_fšg”").
šüem’t
(1);

154 
	gcÚ‹xt
.
g‘CouÁ”
("dedup", "difã»Á_fšg”").
šüem’t
(1);

155 
	gfšg”
 = 
Ãwfšg”
;

156 
	gn1
.
£tFšg”
(
Ãwfšg”
);

159 
	gv®ue
.
£t
(
n1
, 
n2
);

160 
	gcombšeKey
.
£t
(
row
, 
v®ue
);

161 
	gcÚ‹xt
.
wr™e
(
combšeKey
, 
v®ue
);

162 
	gcÚ‹xt
.
g‘CouÁ”
(
MyCouÁ”
.
EMIT1
).
šüem’t
(1);

166 
	gS‘
<
	gCh¬aù”
> 
	gextKeyS‘
 = 
nuÎ
;

169 
	gSy¡em
.
¬¿ycİy
(
fšg”
, 2, 
³rmu‹dFšg”Suffixs
, 0,

170 
FINGER_SUFFIX_LEN
);

172 
	gSy¡em
.
¬¿ycİy
(
fšg”
, 0, 
³rmu‹dFšg”Suffixs
,

173 
FINGER_SUFFIX_LEN
, 2);

174 
	gSy¡em
.
¬¿ycİy
(
fšg”
, 4, 
³rmu‹dFšg”Suffixs
,

175 
FINGER_SUFFIX_LEN
 + 2, 4);

177 
	gSy¡em
.
¬¿ycİy
(
fšg”
, 0, 
³rmu‹dFšg”Suffixs
,

178 
FINGER_SUFFIX_LEN
 * 2, 4);

179 
	gSy¡em
.
¬¿ycİy
(
fšg”
, 6, 
³rmu‹dFšg”Suffixs
,

180 
FINGER_SUFFIX_LEN
 * 2 + 4, 2);

182 
	gSy¡em
.
¬¿ycİy
(
fšg”
, 0, 
³rmu‹dFšg”Suffixs
,

183 
FINGER_SUFFIX_LEN
 * 3, 6);

184 
	gdupU¾idS‘
.
ş—r
();

185 
	gi
 = 0; i < 
	gTABLE_SIZE
; i++) {

186 
	gcu¼’tExtTabË
 = 
extTabËs
.
g‘
(
i
);

187 
	gextKeyS‘
 = 
cu¼’tExtTabË
.
keyS‘
();

188 
	gSy¡em
.
¬¿ycİy
(
fšg”
, 2 * 
i
, 
cu¼’tPfxA¼ay
, 0,

189 
FINGER_PREFIX_LEN
);

190 
	gcu¼’tPfx
 = 
Ch¬aù”
.
v®ueOf
(
MemTabË


191 .
by‹A¼ayToCh¬
(
cu¼’tPfxA¼ay
));

192 ià(
	gextKeyS‘
.
cÚšs
(
cu¼’tPfx
)) {

195 
	g´efixM©chedTabËV®ue
 = 
cu¼’tExtTabË


196 .
g‘
(
cu¼’tPfx
);

197 
	gj
 = 0; j < 
	g´efixM©chedTabËV®ue
.
	gËngth


198 / 
	gURLID_FINGERSUFFIX_SIZE
; 
	gj
++) {

199 ià(
ËssKHammšgDi¡ªû
(3,

200 
´efixM©chedTabËV®ue
, 
URLID_LEN


201 + 
URLID_FINGERSUFFIX_SIZE
 * 
j
,

202 
³rmu‹dFšg”Suffixs
, 
FINGER_SUFFIX_LEN


203 * 
i
, 
FINGER_SUFFIX_LEN
)

204 && !(
u¾idEqu®s
(
u¾id
,

205 
´efixM©chedTabËV®ue
,

206 
URLID_FINGERSUFFIX_SIZE
 * 
j
))) {

207 
	gSy¡em
.
¬¿ycİy
(
´efixM©chedTabËV®ue
,

208 
URLID_FINGERSUFFIX_SIZE
 * 
j
,

209 
´obedU¾id
, 0, 
URLID_LEN
);

210 
	gdupU¾id
.
£t
(
´obedU¾id
);

211 ià(!
	gdupU¾idS‘
.
cÚšs
(
dupU¾id
)) {

212 ià(
	gBy‹s
.
equ®s
(
´obedU¾id
, 
®lz”o
)) {

213 
	gcÚ‹xt
.
g‘CouÁ”
("dumapper", "zero")

214 .
šüem’t
(1);

216 
	gdupU¾idS‘
.
add
(
dupU¾id
);

217 
	gv®ue
.
£t
(
n2
, 
n1
);

218 
	gcombšeKey
.
£t
(
dupU¾id
, 
v®ue
);

219 ià(
	gA¼ays
.
equ®s
(
nf
, 
NEW
)) {

220 ià(
	gdupU¾id
.
com·»To
(
u¾id
) > 0) {

221 
	gcÚ‹xt
.
wr™e
(
combšeKey
, 
v®ue
);

224 
	gcÚ‹xt
.
wr™e
(
combšeKey
, 
v®ue
);

226 
	gcÚ‹xt
.
g‘CouÁ”
(
MyCouÁ”
.
EMIT2
).
šüem’t
(1);

234 
	gLog
.
šfo
("”rÜ„owkey key=" + 
n1
.
toSŒšg
() + "\t"

235 + 
By‹s
.
toIÁ
(
cŞumns
.
g‘V®ue
(
cŞumnFamy
, 
n
)));

236 
	gcÚ‹xt
.
g‘CouÁ”
("dedup", "wrÚg_»cÜd").
šüem’t
(1);

238 } 
ÿtch
 (
Exû±iÚ
 
ex
) {

239 
	gex
.
g‘SckT¿û
();

240 
SckT¿ûEËm’t
 
	g–
 : 
ex
.
g‘SckT¿û
()) {

241 
Log
.
šfo
("Œack–em’t" + 
–
.
g‘M‘hodName
() + "\t" +

242 
–
.
g‘LšeNumb”
(è+ "\t" +ƒl.
g‘CÏssName
());

244 
	gcÚ‹xt
.
g‘CouÁ”
("dedup", "”Ür_»cÜd").
šüem’t
(1);

245 
	gLog
.
šfo
("”rÜ mes§ge" + 
ex
.
g‘Mes§ge
()+"\Œowkey key="+
Numb”Ut
.
g‘HexSŒšg
(
row
.
g‘
()));

261 
´iv©e
 
boŞ—n
 
ËssKHammšgDi¡ªû
(
k
, 
fš®
 
by‹
[] 
s
, 
ss
,

262 
fš®
 
by‹
[] 
d
, 
ds
, 
off£t
) {

263 
by‹
 
	gx
;

264 
	gÚes
 = 0;

265 
	gn
 = 0;

266 
	gi
 = 0; i < 
	goff£t
; i++) {

267 
	gx
 = (
by‹
è((
s
[
ss
 + 
i
] ^ 
d
[
ds
 + i]) & 0x000000ff);

268 
	gn
 = 0;

269 
	gx
 != 0) {

270 ++
n
;

271 
	gx
 &ğ(
x
 - 1);

273 
	gÚes
 +ğ
n
;

274 ià(
	gÚes
 > 
	gk
) {

275  
	gçl£
;

278  
	gŒue
;

281 
´iv©e
 
boŞ—n
 
u¾idEqu®s
(
fš®
 
by‹
[] 
Ëá
, fš® by‹[] 
right
,

282 
¡¬tPos
) {

284 
	gi
 = 0; i < 
	gURLID_LEN
; i++) {

285 ià(
	gËá
[
i
] !ğ
right
[
¡¬tPos
 + i]) {

286  
çl£
;

290  
	gŒue
;

	@com/zhongsou/incload/DeDupReducer.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

18 
public
 
şass
 
DeDupReduûr
 
ex‹nds


19 
	gReduûr
<
	gKeyV®uePaœ
, 
	gDupPaœ
, 
	gImmubËBy‹sWr™abË
, DupPair> {

20 
´iv©e
 
DupPaœ
 
	gv®ue
 = 
Ãw
 DupPair();

22 
´iv©e
 
DupPaœ
 
	gfœ¡V®ue
;

23 
´iv©e
 
fš®
 
PageNode
 
	gn1
 = 
Ãw
 PageNode();

24 
´iv©e
 
MuÉËOuuts
 
	gmos
;

26 @
Ov”ride


27 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
)

28 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

29 
	gsu³r
.
£tup
(
cÚ‹xt
);

30 
	gmos
 = 
Ãw
 
MuÉËOuuts
(
cÚ‹xt
);

43 
public
 
»duû
(
KeyV®uePaœ
 
combšeKey
, 
I‹¿bË
<
DupPaœ
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
)

44 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

45 
ImmubËBy‹sWr™abË
 
	gkey
 = 
combšeKey
.
g‘DupU¾id
();

46 
	gI‹¿tÜ
<
	gDupPaœ
> 
	g™
 = 
v®ues
.
™”©Ü
();

47 
	gfœ¡V®ue
 = 
™
.
Ãxt
();

49 
PageNode
 
	g²
 = 
fœ¡V®ue
.
g‘N1
();

50 
PageNode
 
	gn2
 = 
fœ¡V®ue
.
g‘N2
();

53 
as£¹
(!(
n2
 =ğ
nuÎ
 && 
²
 ==‚ull));

54 
as£¹
(
²
 !ğ
nuÎ
);

55 ià(
	g²
 !ğ
nuÎ
) {

56 
n1
.
£t
(
²
);

59 
	g™
.
hasNext
()) {

60 
	gv®ue
 = 
™
.
Ãxt
();

61 ià(
	gv®ue
.
g‘N1
(è=ğ
nuÎ
 && 
v®ue
.
g‘N2
() ==‚ull) {

62 
mos
.
wr™e
("uÆßdKey", 
key
, 
NuÎWr™abË
.
g‘
());

63 
	gcÚ‹xt
.
g‘CouÁ”
("dedup", "em™4").
šüem’t
(1);

66 
	gv®ue
.
£tN1
(
n1
);

67 
	gcÚ‹xt
.
wr™e
(
key
, 
v®ue
);

71 @
Ov”ride


72 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

73 
	gIÁ”ru±edExû±iÚ
 {

75 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

76 
	gmos
.
şo£
();

	@com/zhongsou/incload/Driver.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞRuÂ”
;

5 
public
 cÏs 
	cDriv”
 {

6 
public
 
	$maš
(
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

7 
i
 = 0;

8 
SŒšg
 
¬g
 : 
¬gs
) {

9 
Sy¡em
.
out
.
	`´šn
("¬g " + 
i
 + 
¬g
);

10 
i
++;

13 
dedupEx™Code
 = 
ToŞRuÂ”
.
	`run
(
Ãw
 
	`DeDup
(), 
¬gs
);

14 ià(
dedupEx™Code
 == 0) {

15 
Sy¡em
.
	`ex™
(
ToŞRuÂ”
.
	`run
(
Ãw
 
	`S–eùLogic
(), 
¬gs
));

17 
Sy¡em
.
”r
.
	`´šn
("dedup failure!");

22 
	}
}

	@com/zhongsou/incload/DupPair.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

8 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

16 
public
 
şass
 
DupPaœ


17 
im¶em’ts
 
	gWr™abËCom·¿bË
<
	gDupPaœ
> {

18 
´iv©e
 
PageNode
 
	gn1
;

19 
´iv©e
 
PageNode
 
	gn2
;

21 
public
 
DupPaœ
() {}

23 
public
 
DupPaœ
(
PageNode
 
n1
, PageNod
n2
) {

24 
	gthis
.
	gn1
 = 
n1
;

25 
	gthis
.
	gn2
 = 
n2
;

28 @
Ov”ride


29 
public
 
wr™e
(
fš®
 
D©aOuut
 
out
)

30 
throws
 
	gIOExû±iÚ
 {

32 ià(
	gn1
 !ğ
nuÎ
) {

33 
out
.
wr™eBy‹
(1);

34 
	gn1
.
wr™e
(
out
);

36 
	gout
.
wr™eBy‹
(0);

39 ià(
	gn2
 !ğ
nuÎ
) {

40 
out
.
wr™eBy‹
(1);

41 
	gn2
.
wr™e
(
out
);

43 
	gout
.
wr™eBy‹
(0);

48 @
Ov”ride


49 
public
 
»adF›lds
(
fš®
 
D©aIÅut
 
š
)

50 
throws
 
	gIOExû±iÚ
 {

52 ià(
	gš
.
»adBy‹
() == 1) {

53 
n1
 = 
Ãw
 
PageNode
();

54 
	gn1
.
»adF›lds
(
š
);

55 ià(
	gš
.
»adBy‹
() == 1) {

56 
n2
 = 
Ãw
 
PageNode
();

57 
	gn2
.
»adF›lds
(
š
);

59 
	gn2
 = 
nuÎ
;

62 
	gn1
 = 
nuÎ
;

63 ià(
	gš
.
»adBy‹
() == 1) {

64 
n2
 = 
Ãw
 
PageNode
();

65 
	gn2
.
»adF›lds
(
š
);

69 
	gn2
=
nuÎ
;

74 
public
 
com·»To
(
DupPaœ
 
o
) {

75 
	gcmp
 = 0;

77 ià(
	gn1
 !ğ
nuÎ
 && 
n2
 ==‚ull) {

78 ià(
o
.
n1
 !ğ
nuÎ
 && o.
n2
 ==‚ull) {

79  
cmp
 = 
Wr™abËCom·¿tÜ
.
com·»By‹s
(
n1
.
g‘U¾id
(), 0, 8, 
o
.n1.getUrlid(), 0, 8);

83 } ià(
	gn1
 =ğ
nuÎ
 && 
n2
 !=‚ull) {

84 ià(
o
.
n1
 =ğ
nuÎ
 && o.
n2
 !=‚ull) {

85  
cmp
 = 
Wr™abËCom·¿tÜ
.
com·»By‹s
(
n2
.
g‘U¾id
(), 0, 8, 
o
.n2.getUrlid(), 0, 8);

90  
	gcmp
;

163 
public
 
PageNode
 
g‘N1
() {

164  
	gn1
;

167 
public
 
£tN1
(
PageNode
 
node
) {

168 
	gthis
.
	gn1
 = 
node
;

171 
public
 
PageNode
 
g‘N2
() {

172  
	gn2
;

175 
public
 
£tN2
(
PageNode
 
node
) {

176 
	gthis
.
	gn2
 = 
node
;

179 
public
 
£t
(
PageNode
 
n1
, PageNod
n2
) {

180 
	gthis
.
	gn1
 = 
n1
;

181 
	gthis
.
	gn2
 = 
n2
;

184 @
Ov”ride


185 
public
 
SŒšg
 
toSŒšg
() {

186 
SŒšgBud”
 
	gsb
 = 
Ãw
 StringBuilder();

187 ià(
	gn1
 !ğ
nuÎ
) {

188 
sb
.
­³nd
(
n1
.
toSŒšg
());

190 
	gsb
.
­³nd
("(null) ");

193 ià(
	gn2
 !ğ
nuÎ
) {

194 
sb
.
­³nd
(
n2
.
toSŒšg
());

196 
	gsb
.
­³nd
(" [null]");

198  
	gsb
.
toSŒšg
();

201 @
Ov”ride


202 
public
 
boŞ—n
 
equ®s
(
Objeù
 
o
) {

203 ià(!(
o
 
š¡ªûof
 
	gDupPaœ
)) {

204  
	gçl£
 ;

206 
DupPaœ
 
	gÙh”
 = (DupPaœ)
o
;

208 ià(
	gthis
.
	gn1
 !ğ
nuÎ
 && 
this
.
n2
 !=‚ull &&

209 
Ùh”
.
n1
 !ğ
nuÎ
 && oth”.
n2
 !=‚ull) {

210  
this
.
n1
.
equ®s
(
Ùh”
.n1è&&his.
n2
.equals(other.n2);

211 } ià(
	gthis
.
	gn1
 =ğ
nuÎ
 && 
this
.
n2
 ==‚ull &&

212 
Ùh”
.
n1
 =ğ
nuÎ
 && oth”.
n2
 ==‚ull) {

213  
Œue
;

214 } ià(
	gthis
.
	gn1
 !ğ
nuÎ
 && 
this
.
n2
 ==‚ull &&

215 
Ùh”
.
n1
 !ğ
nuÎ
 && oth”.
n2
 ==‚ull) {

216  
this
.
n1
.
equ®s
(
Ùh”
.n1);

217 } ià(
	gthis
.
	gn1
 =ğ
nuÎ
 && 
this
.
n2
 !=‚ull &&

218 
Ùh”
.
n1
 =ğ
nuÎ
 && oth”.
n2
 !=‚ull) {

219  
this
.
n2
.
equ®s
(
Ùh”
.n2);

221  
	gçl£
;

225 @
Ov”ride


226 
public
 
hashCode
() {

227 ià(
	gn1
 !ğ
nuÎ
 && 
n2
 !=‚ull) {

228  
n1
.
hashCode
(è* 31 + 
n2
.hashCode();

229 } ià(
	gn1
 =ğ
nuÎ
 && 
n2
 !=‚ull) {

230  
n2
.
hashCode
();

231 } ià(
	gn1
 !ğ
nuÎ
 && 
n2
 ==‚ull) {

232  
n1
.
hashCode
();

238 
public
 şas 
	cCom·¿tÜ
 
ex‹nds
 
	gWr™abËCom·¿tÜ
 {

240 
public
 
Com·¿tÜ
() {

241 
su³r
(
DupPaœ
.
şass
);

244 @
Ov”ride


245 
public
 
com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

246 
	gcmp
;

247 
	gLog
.
šfo
("duppair compare method is working");

248 
	gcmp
 = 
com·»By‹s
(
b1
, 
s1
, 1, 
b2
, 
s2
, 1);

249  
	gcmp
;

254 
	gWr™abËCom·¿tÜ
.
defše
(
DupPaœ
.
şass
, 
Ãw
 
Com·¿tÜ
());

	@com/zhongsou/incload/HFileCreatorMapper.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gLßdInüem’lHFes
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

19 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

21 
public
 
şass
 
HFeC»©ÜM­³r


22 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

23 
´iv©e
 
fš®
 
	gby‹
 [] 
	gcf
 = 
By‹s
.
toBy‹s
("P");

24 
´iv©e
 
fš®
 
	gby‹
 [] 
	gnf
 = 
By‹s
.
toBy‹s
("n");

25 
´iv©e
 
	gts
;

26 
´iv©e
 
	gby‹
 [] 
	gnfv
;

27 
´iv©e
 
KeyV®ue
 
	gkvNf
;

29 @
Ov”ride
 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
) {

30 
	gts
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘IÁ
("timestamp", 0);

31 
	gnfv
 = 
By‹s
.
toBy‹s
(
ts
);

32 
	gLog
.
šfo
("v®uoàts:" + 
ts
);

35 @
Ov”ride
 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

36 
ImmubËBy‹sWr™abË
 
v®ue
,

37 
CÚ‹xt
 
cÚ‹xt
)

38 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

39 
	gkvNf
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
cf
, 
nf
, 
nfv
);

40 
	gcÚ‹xt
.
wr™e
(
key
, 
kvNf
);

43 
public
 
maš
(
SŒšg
[] 
¬gs
è
throws
 
	gExû±iÚ
 {

44 
	gi
 = 0;

45 
SŒšg
 
	g¬g
 : 
¬gs
) {

46 
Sy¡em
.
out
.
´šn
("¬g " + 
i
 + ":" + 
¬g
);

47 
	gi
++;

49 
CÚfigu¿tiÚ
 
	gcÚf
 = 
Ãw
 Configuration();

51 
	gcÚf
.
£t
("hba£.bË.Çme", 
¬gs
[3]);

52 
	gts
 = (è(
Sy¡em
.
cu¼’tTimeMlis
() / 1000);

53 
	gcÚf
.
£tIÁ
("time¡amp", 
ts
);

55 
	gHBa£CÚfigu¿tiÚ
.
addHba£Resourûs
(
cÚf
);

57 
Job
 
	gjob
 = 
Ãw
 Job(
cÚf
, "HBa£-Bulk-ImpÜt-" + 
ts
);

58 
	gjob
.
£tJ¬ByCÏss
(
HFeC»©ÜM­³r
.
şass
);

60 
	gjob
.
£tM­³rCÏss
(
HFeC»©ÜM­³r
.
şass
);

61 
	gjob
.
£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

62 
	gjob
.
£tM­OuutV®ueCÏss
(
KeyV®ue
.
şass
);

64 
	gjob
.
£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

66 
HTabË
 
	ghTabË
 = 
Ãw
 HTabË(
cÚf
, 
¬gs
[3]);

69 
	gHFeOuutFÜm©
.
cÚfigu»Inüem’lLßd
(
job
, 
hTabË
);

71 
P©h
 
	gšdœ
 = 
Ãw
 P©h(
¬gs
[1]);

72 
P©h
 
	goutdœ
 = 
Ãw
 P©h(
¬gs
[2]);

74 
	gFeIÅutFÜm©
.
addIÅutP©h
(
job
, 
šdœ
);

75 
	gFeOuutFÜm©
.
£tOuutP©h
(
job
, 
outdœ
);

77 
FeSy¡em
 
	gfs
 = FeSy¡em.
g‘
(
cÚf
);

78 
	gfs
.
d–‘e
(
outdœ
, 
Œue
);

80 
	gjob
.
wa™FÜCom¶‘iÚ
(
Œue
);

83 
LßdInüem’lHFes
 
	glßd”
 = 
Ãw
 LßdInüem’lHFes(
cÚf
);

84 
	glßd”
.
doBulkLßd
(
Ãw
 
P©h
(
¬gs
[2]), 
hTabË
);

	@com/zhongsou/incload/KeyValuePair.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

9 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

11 
public
 
şass
 
KeyV®uePaœ
 
im¶em’ts
 
	gWr™abËCom·¿bË
<
	gKeyV®uePaœ
> {

12 
´iv©e
 
fš®
 
	gURLID_LEN
 = 8;

13 
´iv©e
 
fš®
 
	gDUPURLID_LEN
 = 8;

14 
´iv©e
 
fš®
 
	gN1_LEN
 = 1;

15 
´iv©e
 
fš®
 
	gN2_LEN
 = 1;

16 
´iv©e
 
ImmubËBy‹sWr™abË
 
	gdupU¾id
 = 
Ãw
 ImmutableBytesWritable();

17 
´iv©e
 
DupPaœ
 
	gdp
 = 
Ãw
 DupPair();

19 
public
 
KeyV®uePaœ
() {

22 
public
 
KeyV®uePaœ
(
ImmubËBy‹sWr™abË
 
Ëá
, 
DupPaœ
 
right
) {

23 
£t
(
Ëá
, 
right
);

26 
public
 
£t
(
ImmubËBy‹sWr™abË
 
Ëá
, 
DupPaœ
 
right
) {

27 
	gdupU¾id
 = 
Ëá
;

28 
	gdp
 = 
right
;

31 
public
 
ImmubËBy‹sWr™abË
 
g‘DupU¾id
() {

32  
	gdupU¾id
;

35 
public
 
DupPaœ
 
g‘Dp
() {

36  
	gdp
;

39 
public
 
»adF›lds
(
D©aIÅut
 
š
è
throws
 
	gIOExû±iÚ
 {

40 
	gdupU¾id
.
»adF›lds
(
š
);

41 
	gdp
.
»adF›lds
(
š
);

45 
public
 
wr™e
(
D©aOuut
 
out
è
throws
 
	gIOExû±iÚ
 {

46 
	gdupU¾id
.
wr™e
(
out
);

47 
	gdp
.
wr™e
(
out
);

50 @
Ov”ride


51 
public
 
SŒšg
 
toSŒšg
() {

52  "" + 
	gdupU¾id
 + "|" + 
	gdp
;

55 @
Ov”ride


56 
public
 
hashCode
() {

57  
	gdupU¾id
.
hashCode
(è* 157 + 
	gdp
.hashCode();

60 @
Ov”ride


61 
public
 
boŞ—n
 
equ®s
(
Objeù
 
right
) {

62 ià(
right
 
š¡ªûof
 
	gKeyV®uePaœ
) {

63 
KeyV®uePaœ
 
	gr
 = (KeyV®uePaœè
right
;

64  
	gdupU¾id
.
equ®s
(
r
.
dupU¾id
è&& 
	gdp
.equ®sÔ.
dp
);

66  
	gçl£
;

70 
public
 şas 
	cCom·¿tÜ
 
ex‹nds
 
	gWr™abËCom·¿tÜ
 {

74 
public
 
Com·¿tÜ
() {

75 
su³r
(
KeyV®uePaœ
.
şass
);

78 @
Ov”ride


79 
public
 
com·»
(
by‹
[] 
b1
, 
s1
, 
l1
,

80 
by‹
[] 
b2
, 
s2
, 
l2
) {

83 
	gcmp
 = 
Wr™abËCom·¿tÜ
.
com·»By‹s
(
b1
, 
s1
+4, 
DUPURLID_LEN
, 
b2
, 
s2
+4, DUPURLID_LEN);

85 ià(
	gcmp
 != 0) {

86  
cmp
;

89  -
	gWr™abËCom·¿tÜ
.
com·»By‹s
(
b1
, 
s1
+12, 
N1_LEN
, 
b2
, 
s2
+12, N1_LEN);

94 
	gWr™abËCom·¿tÜ
.
defše
(
KeyV®uePaœ
.
şass
, 
Ãw
 
Com·¿tÜ
());

97 
public
 
	$com·»To
(
KeyV®uePaœ
 
o
) {

98 
cmp
 = 
dupU¾id
.
	`com·»To
(
o
.dupUrlid);

99 ià(
cmp
 != 0) {

100  
cmp
;

102  
dp
.
	`com·»To
(
o
.dp);

103 
	}
}

	@com/zhongsou/incload/MemTable.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

5 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

6 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gM­
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeStus
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gIOUts
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gReæeùiÚUts
;

27 
public
 cÏs 
	cMemTabË
 {

29 
fš®
 
	mURLID_LEN
 = 8;

30 
fš®
 
	mFINGER_LEN
 = 8;

31 
fš®
 
	mFINGER_PREFIX_LEN
 = 2;

32 
fš®
 
	mFINGER_SUFFIX_LEN
 = 6;

33 
fš®
 
	mTABLE_SIZE
 = 4;

34 
fš®
 
	mURLID_FINGERSUFFIX_BYTE_SIZE
 = 14;

35 
fš®
 
	mTABLE_CAPACITY
 = (è
M©h
.
pow
(2, 16);

36 
´iv©e
 
	mby‹
[][] 
	m³rmu‹dFšg”
 = 
nuÎ
;

38 
´iv©e
 
	mM­
<
	mCh¬aù”
, 
	mIÁeg”
> 
	m¦ÙM­0
 = 
nuÎ
;

39 
´iv©e
 
	mM­
<
	mCh¬aù”
, 
	mIÁeg”
> 
	m¦ÙM­1
 = 
nuÎ
;

40 
´iv©e
 
	mM­
<
	mCh¬aù”
, 
	mIÁeg”
> 
	m¦ÙM­2
 = 
nuÎ
;

41 
´iv©e
 
	mM­
<
	mCh¬aù”
, 
	mIÁeg”
> 
	m¦ÙM­3
 = 
nuÎ
;

43 
	mLi¡
<
	mM­
<
	mCh¬aù”
, 
	mIÁeg”
>> 
	msmLi¡
 = 
nuÎ
;

49 
FeSy¡em
 
	mfs
;

50 
CÚfigu¿tiÚ
 
	mcÚf
;

52 
public
 
	$MemTabË
(
CÚfigu¿tiÚ
 
cÚf
) {

53 
Œy
 {

54 
this
.
fs
 = 
FeSy¡em
.
	`g‘
(
cÚf
);

55 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

57 
e
.
	`´štSckT¿û
();

59 
this
.
cÚf
 = conf;

60 
¦ÙM­0
 = 
Ãw
 
HashM­
<
Ch¬aù”
, 
IÁeg”
>(
TABLE_CAPACITY
);

61 
¦ÙM­1
 = 
Ãw
 
HashM­
<
Ch¬aù”
, 
IÁeg”
>(
TABLE_CAPACITY
);

62 
¦ÙM­2
 = 
Ãw
 
HashM­
<
Ch¬aù”
, 
IÁeg”
>(
TABLE_CAPACITY
);

63 
¦ÙM­3
 = 
Ãw
 
HashM­
<
Ch¬aù”
, 
IÁeg”
>(
TABLE_CAPACITY
);

64 
smLi¡
 = 
Ãw
 
A¼ayLi¡
<
M­
<
Ch¬aù”
, 
IÁeg”
>>(4);

65 
smLi¡
.
	`add
(
¦ÙM­0
);

66 
smLi¡
.
	`add
(
¦ÙM­1
);

67 
smLi¡
.
	`add
(
¦ÙM­2
);

68 
smLi¡
.
	`add
(
¦ÙM­3
);

79 
public
 
M­
<
ImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË> 
	$budTabË
(
SŒšg
 
rP©h
è
throws
 
IOExû±iÚ
 {

81 
Sequ’ûFe
.
R—d”
 
»ad”
 = 
nuÎ
;

82 
by‹
[] 
´efixA¼ay
 = 
Ãw
 by‹[
FINGER_PREFIX_LEN
];

83 
Ch¬aù”
 
´efix
 = 
nuÎ
;

84 
M­
<
Ch¬aù”
, 
IÁeg”
> 
´efixCouÁM­
 = 
nuÎ
;

85 
Œy
 {

86 
M­
<
ImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË> 
m­
 = 
Ãw
 
HashM­
<ImmutableBytesWritable, ImmutableBytesWritable>();

87 
ImmubËBy‹sWr™abË
 
m­Key
 = 
nuÎ
;

88 
by‹
[] 
m­KeyA¼ay
 = 
nuÎ
;

89 
ImmubËBy‹sWr™abË
 
m­V®ue
 = 
nuÎ
;

90 
by‹
[] 
m­V®ueA¼ay
 = 
nuÎ
;

91 
Li¡
<
P©h
> 
·ths
 = 
	`g‘P©hs
(
rP©h
);

92 
P©h
 
·th
 : 
·ths
) {

93 ià(
»ad”
 !ğ
nuÎ
) {

94 
IOUts
.
	`şo£SŒ—m
(
»ad”
);

95 
»ad”
 = 
nuÎ
;

97 
»ad”
 = 
Ãw
 
Sequ’ûFe
.
	`R—d”
(
fs
, 
·th
, 
cÚf
);

102 
ImmubËBy‹sWr™abË
 
key
 = (ImmutableBytesWritable)

104 
ReæeùiÚUts
.
	`ÃwIn¡ªû
(
»ad”
.
	`g‘KeyCÏss
(), 
cÚf
);

105 
ImmubËBy‹sWr™abË
 
v®ue
 = (ImmutableBytesWritable)

108 
ReæeùiÚUts
.
	`ÃwIn¡ªû
(
»ad”
.
	`g‘V®ueCÏss
(), 
cÚf
);

110 
»ad”
.
	`Ãxt
(
key
, 
v®ue
)) {

111 
m­KeyA¼ay
 = 
Ãw
 
by‹
[
URLID_LEN
];

112 
Sy¡em
.
	`¬¿ycİy
(
key
.
	`g‘
(), 0, 
m­KeyA¼ay
, 0, 
URLID_LEN
);

113 
m­Key
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
(
m­KeyA¼ay
);

114 
m­V®ueA¼ay
 = 
Ãw
 
by‹
[
FINGER_LEN
];

115 
Sy¡em
.
	`¬¿ycİy
(
v®ue
.
	`g‘
(), 0, 
m­V®ueA¼ay
, 0, 
FINGER_LEN
);

116 
m­V®ue
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
(
m­V®ueA¼ay
);

118 ià(!
m­
.
	`cÚšsKey
(
m­Key
)) {

119 
m­
.
	`put
(
m­Key
, 
m­V®ue
);

132 
i
 = 0; i < 
TABLE_SIZE
; i++) {

133 
Sy¡em
.
	`¬¿ycİy
(
m­V®ueA¼ay
, 2 * 
i
, 
´efixA¼ay
, 0, 
FINGER_PREFIX_LEN
);

134 
´efix
 = 
Ch¬aù”
.
	`v®ueOf
(
	`by‹A¼ayToCh¬
(
´efixA¼ay
));

135 
´efixCouÁM­
 = 
smLi¡
.
	`g‘
(
i
);

136 ià(
´efixCouÁM­
.
	`keyS‘
().
	`cÚšs
(
´efix
)) {

137 
´efixCouÁM­
.
	`put
(
´efix
, 
IÁeg”
.
	`v®ueOf
Õ»fixCouÁM­.
	`g‘
(prefix) + 1));

139 
´efixCouÁM­
.
	`put
(
´efix
, 
IÁeg”
.
	`v®ueOf
(1));

145  
m­
;

146 } 
fš®ly
 {

147 ià(
»ad”
 !ğ
nuÎ
) {

148 
IOUts
.
	`şo£SŒ—m
(
»ad”
);

151 
	}
}

153 
public
 
	gLi¡
<
	gM­
<
	gCh¬aù”
, 
	gby‹
[]>> 
budExtTabË
(
M­
<
ImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË> 
m­
è
throws
 
	gIOExû±iÚ
 {

156 
	gLi¡
<
	gM­
<
	gCh¬aù”
, 
	gby‹
[]>> 
	g»suÉ
 = 
Ãw
 
A¼ayLi¡
<
M­
<
Ch¬aù”
, by‹[]>>(
	gTABLE_SIZE
);

158 
	gM­
<
	gCh¬aù”
, 
	gby‹
[]> 
	gtb0
 = 
Ãw
 
HashM­
<
Ch¬aù”
, by‹[]>(
	gTABLE_CAPACITY
);

159 
	g»suÉ
.
add
(
tb0
);

160 
	gM­
<
	gCh¬aù”
, 
	gby‹
[]> 
	gtb1
 = 
Ãw
 
HashM­
<
Ch¬aù”
, by‹[]>(
	gTABLE_CAPACITY
);

161 
	g»suÉ
.
add
(
tb1
);

162 
	gM­
<
	gCh¬aù”
, 
	gby‹
[]> 
	gtb2
 = 
Ãw
 
HashM­
<
Ch¬aù”
, by‹[]>(
	gTABLE_CAPACITY
);

163 
	g»suÉ
.
add
(
tb2
);

164 
	gM­
<
	gCh¬aù”
, 
	gby‹
[]> 
	gtb3
 = 
Ãw
 
HashM­
<
Ch¬aù”
, by‹[]>(
	gTABLE_CAPACITY
);

165 
	g»suÉ
.
add
(
tb3
);

167 
	gby‹
[] 
	gbkey
 = 
Ãw
 
by‹
[
URLID_LEN
];

168 
	gby‹
[] 
	gbv®ue
 = 
Ãw
 
by‹
[
FINGER_LEN
];

169 
	gby‹
[] 
	g´efixA¼ay
 = 
Ãw
 
by‹
[
FINGER_PREFIX_LEN
];

170 
	gby‹
[] 
	gsuffixA¼ay
 = 
Ãw
 
by‹
[
FINGER_SUFFIX_LEN
];

171 
Ch¬aù”
 
	g´efix
 = 
nuÎ
;

172 
	gby‹
[] 
	gu¾idSuffixA¼ay
 = 
nuÎ
;

173 
	gM­
<
	gCh¬aù”
, 
	gby‹
[]> 
	gbË
 = 
nuÎ
;

174 
	gM­
<
	gCh¬aù”
, 
	gIÁeg”
> 
	gcommÚSuffixCouÁM­
 = 
nuÎ
;

175 
	gcommÚSuffixCouÁ
 = 0;

176 
ImmubËBy‹sWr™abË
 
	gkey
 : 
m­
.
keyS‘
()) {

177 
Sy¡em
.
¬¿ycİy
(
key
.
g‘
(), 0, 
bkey
, 0, 
URLID_LEN
);

178 
	gSy¡em
.
¬¿ycİy
(
m­
.
g‘
(
key
).g‘(), 0, 
bv®ue
, 0, 
FINGER_LEN
);

179 
	gi
 = 0; i < 
	gTABLE_SIZE
; i++) {

180 
	gSy¡em
.
¬¿ycİy
(
bv®ue
, 2 * 
i
, 
´efixA¼ay
, 0, 
FINGER_PREFIX_LEN
);

181 
	g´efix
 = 
Ch¬aù”
.
v®ueOf
(
by‹A¼ayToCh¬
(
´efixA¼ay
));

182 
	gbË
 = 
»suÉ
.
g‘
(
i
);

183 
	gcommÚSuffixCouÁM­
 = 
smLi¡
.
g‘
(
i
);

184 
	gcommÚSuffixCouÁ
 = 
commÚSuffixCouÁM­
.
g‘
(
´efix
);

185 ià(
	gbË
.
keyS‘
().
cÚšs
(
´efix
)) {

186 
	gu¾idSuffixA¼ay
 = 
bË
.
g‘
(
´efix
);

188 
	gu¾idSuffixA¼ay
 = 
Ãw
 
by‹
[
commÚSuffixCouÁ
 * 
URLID_FINGERSUFFIX_BYTE_SIZE
];

191 
	gSy¡em
.
¬¿ycİy
(
bkey
, 0, 
u¾idSuffixA¼ay
, u¾idSuffixA¼ay.
Ëngth
 - 
commÚSuffixCouÁ
 * 
URLID_FINGERSUFFIX_BYTE_SIZE
, 
URLID_LEN
);

192 ià(
	gi
 == 0) {

193 
Sy¡em
.
¬¿ycİy
(
bv®ue
, 2, 
u¾idSuffixA¼ay
, (u¾idSuffixA¼ay.
Ëngth
 - 
commÚSuffixCouÁ
 * 
URLID_FINGERSUFFIX_BYTE_SIZE
è+ 
URLID_LEN
, 
FINGER_SUFFIX_LEN
);

195 } ià(
	gi
 == 1) {

196 
Sy¡em
.
¬¿ycİy
(
bv®ue
, 0, 
suffixA¼ay
, 0, 2);

197 
	gSy¡em
.
¬¿ycİy
(
bv®ue
, 4, 
suffixA¼ay
, 2, 4);

198 
	gSy¡em
.
¬¿ycİy
(
suffixA¼ay
, 0, 
u¾idSuffixA¼ay
, (u¾idSuffixA¼ay.
Ëngth
 - 
commÚSuffixCouÁ
 * 
URLID_FINGERSUFFIX_BYTE_SIZE
è+ 
URLID_LEN
, 
FINGER_SUFFIX_LEN
);

199 } ià(
	gi
 == 2) {

200 
Sy¡em
.
¬¿ycİy
(
bv®ue
, 0, 
suffixA¼ay
, 0, 4);

201 
	gSy¡em
.
¬¿ycİy
(
bv®ue
, 6, 
suffixA¼ay
, 4, 2);

202 
	gSy¡em
.
¬¿ycİy
(
suffixA¼ay
, 0, 
u¾idSuffixA¼ay
, (u¾idSuffixA¼ay.
Ëngth
 - 
commÚSuffixCouÁ
 * 
URLID_FINGERSUFFIX_BYTE_SIZE
è+ 
URLID_LEN
, 
FINGER_SUFFIX_LEN
);

204 
	gSy¡em
.
¬¿ycİy
(
bv®ue
, 0, 
u¾idSuffixA¼ay
, (u¾idSuffixA¼ay.
Ëngth
 - 
commÚSuffixCouÁ
 * 
URLID_FINGERSUFFIX_BYTE_SIZE
è+ 
URLID_LEN
, 
FINGER_SUFFIX_LEN
);

206 
	gcommÚSuffixCouÁM­
.
put
(
´efix
, 
IÁeg”
.
v®ueOf
(
commÚSuffixCouÁ
 - 1));

207 
	gbË
.
put
(
´efix
, 
u¾idSuffixA¼ay
);

210  
	g»suÉ
;

213 
´iv©e
 
	gLi¡
<
	gP©h
> 
	$g‘P©hs
(
SŒšg
 
rP©h
) {

214 
Li¡
<
P©h
> 
¶
 = 
Ãw
 
A¼ayLi¡
<Path>();

215 
Œy
 {

216 
FeSy¡em
 
fs
 = FeSy¡em.
	`g‘
(
Ãw
 
	`CÚfigu¿tiÚ
());

217 
FeStus
[] 
¡©us
 = 
fs
.
	`li¡Stus
(
Ãw
 
	`P©h
(
rP©h
));

219 
i
 = 0; i < 
¡©us
.
Ëngth
; i++) {

220 
¶
.
	`add
(
¡©us
[
i
].
	`g‘P©h
());

222 } 
	`ÿtch
 (
Exû±iÚ
 
ex
) {

223 
ex
.
	`´štSckT¿û
();

225  
¶
;

226 
	}
}

228 
	$by‹A¼ayToCh¬
(
by‹
[] 
´efix
) {

229 
sv
 = 
By‹s
.
	`toShÜt
(
´efix
);

230 ià(
sv
 < 0) {

231 
sv
 = (è(sv + 
M©h
.
	`abs
(
ShÜt
.
MIN_VALUE
));

233  (è(
By‹s
.
	`toShÜt
(
´efix
è+ 
M©h
.
	`abs
(
ShÜt
.
MIN_VALUE
));

234 
	}
}

243 
public
 
	gby‹
[][] 
	$³rmu‹Fšg”
(
by‹
[] 
fšg”
) {

245 
i
 = 0; i < 3; i++) {

246 
³rmu‹dFšg”
[
i
][0] = 
fšg”
[(i + 1) * 2];

247 
³rmu‹dFšg”
[
i
][1] = 
fšg”
[(i + 1) * 2 + 1];

248 
j
 = 2; j < 8; j++) {

249 ià(
j
 =ğ(
i
 + 1) * 2) {

250 
³rmu‹dFšg”
[
i
][
j
] = 
fšg”
[0];

253 ià(
j
 =ğ((
i
 + 1) * 2) + 1) {

254 
³rmu‹dFšg”
[
i
][
j
] = 
fšg”
[1];

257 
³rmu‹dFšg”
[
i
][
j
] = 
fšg”
[j];

260  
³rmu‹dFšg”
;

261 
	}
}

263 
´iv©e
 
fš®
 
	gMEGABYTE
 = 1024L * 1024L;

265 
public
 
	$by‹sToMegaby‹s
(
by‹s
) {

266  
by‹s
 / 
MEGABYTE
;

267 
	}
}

269 
public
 
	$maš
(
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

270 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

271 
	}
}

	@com/zhongsou/incload/PageNode.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

11 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

19 
public
 
şass
 
PageNode
 
im¶em’ts
 
	gWr™abËCom·¿bË
<
	gPageNode
> {

20 
´iv©e
 
	gby‹
[] 
	gu¾id
;

21 
´iv©e
 
	gby‹
[] 
	gfšg”
;

22 
´iv©e
 
	gby‹
[] 
	g´
;

23 
´iv©e
 
	gby‹
[] 
	glf
;

24 
´iv©e
 
	gby‹
[] 
	gnf
;

26 
public
 
PageNode
() {

27 
£t
(
Ãw
 
by‹
[8],‚ew byte[8],‚ew byte[4],‚ew byte[1],‚ew byte[1]);

30 
public
 
PageNode
(PageNod
²
) {

31 
£t
(
²
);

34 
public
 
PageNode
(
by‹
[] 
u¾id
, by‹[] 
fšg”
, by‹[] 
´
, by‹[] 
lf
, by‹[] 
nf
) {

35 
£t
(
u¾id
, 
fšg”
, 
´
, 
lf
, 
nf
);

38 
public
 
£t
(
by‹
[] 
u¾id
, by‹[] 
fšg”
, by‹[] 
´
, by‹[] 
lf
, by‹[] 
nf
) {

39 
	gthis
.
	gu¾id
 = 
u¾id
;

40 
	gthis
.
	gfšg”
 = 
fšg”
;

41 
	gthis
.
	g´
 = 
´
;

42 
	gthis
.
	glf
 = 
lf
;

43 
	gthis
.
	gnf
 = 
nf
;

46 
public
 
£t
(
PageNode
 
o
) {

47 
£t
(
o
.
g‘U¾id
(), o.
g‘Fšg”
(), o.
g‘Pr
(), o.
g‘Lf
(), o.
g‘Nf
());

50 
public
 
£tU¾id
(
by‹
[] 
u¾id
) {

51 
	gthis
.
	gu¾id
 = 
u¾id
;

54 
public
 
£tFšg”
(
by‹
[] 
fšg”
) {

55 
	gthis
.
	gfšg”
 = 
fšg”
;

58 
public
 
£tPr
(
by‹
[] 
´
) {

59 
	gthis
.
	g´
 = 
´
;

62 
public
 
£tLf
(
by‹
[] 
lf
) {

63 
	gthis
.
	glf
 = 
lf
;

66 
public
 
£tNf
(
by‹
[] 
nf
) {

67 
	gthis
.
	gnf
 = 
nf
;

70 
public
 
	gby‹
[] 
g‘U¾id
() {

71  
	gu¾id
;

74 
public
 
	gby‹
[] 
g‘Fšg”
() {

75  
	gfšg”
;

78 
public
 
	gby‹
[] 
g‘Pr
() {

79  
	g´
;

82 
public
 
	gby‹
[] 
g‘Lf
() {

83  
	glf
;

86 
public
 
	gby‹
[] 
g‘Nf
() {

87  
	gnf
;

90 
public
 
wr™e
(
D©aOuut
 
out
è
throws
 
	gIOExû±iÚ
 {

91 
	gout
.
wr™e
(
u¾id
, 0, 8);

92 
	gout
.
wr™e
(
fšg”
, 0, 8);

93 
	gout
.
wr™e
(
´
, 0, 4);

94 
	gout
.
wr™e
(
lf
, 0, 1);

95 
	gout
.
wr™e
(
nf
, 0, 1);

98 
public
 
»adF›lds
(
D©aIÅut
 
š
è
throws
 
	gIOExû±iÚ
 {

99 
	gš
.
»adFuÎy
(
u¾id
, 0, 8);

100 
	gš
.
»adFuÎy
(
fšg”
, 0, 8);

101 
	gš
.
»adFuÎy
(
´
, 0, 4);

102 
	gš
.
»adFuÎy
(
lf
, 0, 1);

103 
	gš
.
»adFuÎy
(
nf
, 0, 1);

106 
´iv©e
 
Flßt
 
g‘ScÜe
() {

107  
	gBy‹s
.
toFlßt
(
this
.
g‘Pr
());

110 @
Ov”ride


111 
public
 
com·»To
(
PageNode
 
Ùh”
) {

112  
	gthis
.
g‘ScÜe
().
com·»To
(
Ùh”
.getScore());

115 @
Ov”ride


116 
public
 
hashCode
() {

117 
fš®
 
	g´ime
 = 31;

118 
	g»suÉ
 = 1;

119 
	g»suÉ
 = 
´ime
 * 
»suÉ
 + ((
u¾id
 =ğ
nuÎ
è? 0 : 
A¼ays
.
hashCode
(urlid));

120 
	g»suÉ
 = 
´ime
 * 
»suÉ
 + ((
fšg”
 =ğ
nuÎ
è? 0 : 
A¼ays
.
hashCode
(finger));

121 
	g»suÉ
 = 
´ime
 * 
»suÉ
 + ((
´
 =ğ
nuÎ
è? 0 : 
A¼ays
.
hashCode
(pr));

122 
	g»suÉ
 = 
´ime
 * 
»suÉ
 + ((
lf
 =ğ
nuÎ
è? 0 : 
A¼ays
.
hashCode
(lf));

123 
	g»suÉ
 = 
´ime
 * 
»suÉ
 + ((
nf
 =ğ
nuÎ
è? 0 : 
A¼ays
.
hashCode
(nf));

125  
	g»suÉ
;

128 @
Ov”ride


129 
public
 
boŞ—n
 
equ®s
(
Objeù
 
o
) {

130 ià(!(
o
 
š¡ªûof
 
	gPageNode
)) {

131  
	gçl£
;

134 
PageNode
 
	gÙh”
 = (PageNodeè
o
;

136  
	gA¼ays
.
equ®s
(
u¾id
, 
Ùh”
.u¾idè&& A¼ays.equ®s(
fšg”
, oth”.fšg”è&& A¼ays.equ®s(
´
, oth”.´è&& A¼ays.equ®s(
lf
, oth”.lfè&& A¼ays.equ®s(
nf
, other.nf);

139 @
Ov”ride


140 
public
 
SŒšg
 
toSŒšg
() {

141  "u¾id:" + 
	gNumb”Ut
.
g‘HexSŒšg
(
u¾id
è+ "\t" + "fšg”:" + Numb”Ut.g‘HexSŒšg(
fšg”
è+ "\t" + "´:" + 
	gSŒšg
.
v®ueOf
(
By‹s
.
toFlßt
(
´
)) + "\t" +

143 "lf:" + 
	gNumb”Ut
.
g‘HexSŒšg
(
lf
) + "\t" +

145 "nf:" + 
	gNumb”Ut
.
g‘HexSŒšg
(
nf
);

	@com/zhongsou/incload/SelectLogic.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞ
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞRuÂ”
;

25 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

34 
public
 
şass
 
S–eùLogic
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	gToŞ
, 
	gM­»duûV2Job
 {

36 
public
 
Job
 
ü—‹Job
(
SŒšg
 
¬gs
[]è
throws
 
	gIOExû±iÚ
 {

37 
CÚfigu¿tiÚ
 
	gcÚf
 = 
this
.
g‘CÚf
();

38 
Job
 
	gjob
 = 
Ãw
 Job(
cÚf
);

39 
	gjob
.
£tJ¬ByCÏss
(
S–eùLogic
.
şass
);

41 
	gjob
.
£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

42 
	gjob
.
£tM­³rCÏss
(
S–eùLogicM­³r
.
şass
);

43 
	gjob
.
£tReduûrCÏss
(
S–eùLogicReduûr
.
şass
);

44 
	gjob
.
£tM­OuutKeyCÏss
(
TrË
.
şass
);

45 
	gjob
.
£tM­OuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

46 
	gjob
.
£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

47 
	gjob
.
£tOuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

48 
	gjob
.
£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

51 
	gjob
.
£tSÜtCom·¿tÜCÏss
(
TrËCom·¿tÜ
.
şass
);

53 
	gjob
.
£tNumReduûTasks
(1);

55 
P©h
 
	gšDœ
 = 
Ãw
 P©h(
¬gs
[0]);

56 
P©h
 
	goutDœ
 = 
Ãw
 P©h(
¬gs
[1]);

58 
	gFeIÅutFÜm©
.
addIÅutP©h
(
job
, 
šDœ
);

59 
	gFeOuutFÜm©
.
£tOuutP©h
(
job
, 
outDœ
);

61 
	gjob
.
£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

62 
	gjob
.
£tOuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

64 
	gMuÉËOuuts
.
addNamedOuut
(
job
, "modifyšgLi¡", 
Sequ’ûFeOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.class, ImmutableBytesWritable.class);

65 
	gMuÉËOuuts
.
£tCouÁ”sEÇbËd
(
job
, 
Œue
);

66  
	gjob
;

69 
public
 
run
(
SŒšg
[] 
¬gs
è
throws
 
	gExû±iÚ
 {

70 
CÚfigu¿tiÚ
 
	gcÚf
 = 
HBa£CÚfigu¿tiÚ
.
ü—‹
();

71 
	gSŒšg
[] 
	gÙh”Args
;

72 
	gŒy
 {

73 
	gÙh”Args
 = 
Ãw
 
G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
g‘RemaššgArgs
();

74 ià(
	gÙh”Args
.
	gËngth
 < 2) {

75 
	gSy¡em
.
	gout
.
´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + "‡rgs:‡rgs: select-input select-output");

76 
	gSy¡em
.
ex™
(-1);

78 
	gthis
.
£tCÚf
(
cÚf
);

79 
Job
 
	gjob
 = 
ü—‹Job
(
Ùh”Args
);

80  
	gjob
.
wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : -1;

81 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

83 
	ge
.
´štSckT¿û
();

84 } 
ÿtch
 (
Exû±iÚ
 
e
) {

86 
	ge
.
´štSckT¿û
();

91 
public
 
maš
(
SŒšg
[] 
¬gs
è
throws
 
	gExû±iÚ
 {

92 
	gSy¡em
.
ex™
(
ToŞRuÂ”
.
run
(
Ãw
 
S–eùLogic
(), 
¬gs
));

95 
public
 
şass
 
u¾idP¬t™iÚ”
 
ex‹nds
 
	gP¬t™iÚ”
<
	gTrË
, 
	gNuÎWr™abË
> {

97 @
Ov”ride


98 
public
 
g‘P¬t™iÚ
(
TrË
 
key
, 
NuÎWr™abË
 
v®ue
, 
numP¬t™iÚs
) {

99  
	gkey
.
g‘Key
().
hashCode
(è% 
	gnumP¬t™iÚs
;

103 
public
 şas 
	cTrËCom·¿tÜ
 
ex‹nds
 
	gWr™abËCom·¿tÜ
 {

105 
´Ùeùed
 
TrËCom·¿tÜ
() {

106 
su³r
(
TrË
.
şass
, 
Œue
);

109 @
Ov”ride


110 
public
 
com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

111 
	ga
 = 
Wr™abËCom·¿tÜ
.
»adFlßt
(
b1
, 
s1
 + 12);

112 
	gb
 = 
Wr™abËCom·¿tÜ
.
»adFlßt
(
b2
, 
s2
 + 12);

113 ià(
	ga
 > 
	gb
) {

115 } ià(
	ga
 < 
	gb
) {

119 
	gcmp
;

121 
	gcmp
 = 
Wr™abËCom·¿tÜ
.
com·»By‹s
(
b1
, 
s1
 + 17, 8, 
b2
, 
s2
 + 17, 8);

122 ià(
	gcmp
 != 0) {

123  
cmp
;

126  
	gWr™abËCom·¿tÜ
.
com·»By‹s
(
b1
, 
s1
 + 40, 8, 
b2
, 
s2
 + 40, 8);

135 
public
 şas 
	cGroupCom·¿tÜ
 
ex‹nds
 
	gWr™abËCom·¿tÜ
 {

136 
´Ùeùed
 
GroupCom·¿tÜ
() {

137 
su³r
(
TrË
.
şass
, 
Œue
);

140 
public
 
com·»
(
Wr™abËCom·¿bË
 
w1
, Wr™abËCom·¿bË 
w2
) {

148 @
Ov”ride


149 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

151 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

152 
SŒšg
[] 
Ùh”Args
;

153 
Œy
 {

154 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

155 ià(
Ùh”Args
.
Ëngth
 < 2) {

156 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + "‡rgs: select-input select-output");

157 
Sy¡em
.
	`ex™
(-1);

159 
this
.
	`£tCÚf
(
cÚf
);

160 
Job
 
job
 = 
	`ü—‹Job
(
Ùh”Args
);

161  
job
;

162 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

164 
e
.
	`´štSckT¿û
();

165 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

167 
e
.
	`´štSckT¿û
();

169  
nuÎ
;

171 
	}
}

	@com/zhongsou/incload/SelectLogicMapper.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

9 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

17 
şass
 
S–eùLogicM­³r


18 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, 
	gDupPaœ
, 
	gTrË
, 
	gNuÎWr™abË
> {

30 @
Ov”ride


31 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

32 
DupPaœ
 
v®ue
,

33 
CÚ‹xt
 
cÚ‹xt
)

34 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

35 
PageNode
 
	gn1
 = 
v®ue
.
g‘N1
();

36 
PageNode
 
	gn2
 = 
v®ue
.
g‘N2
();

38 
	gby‹
[] 
	gscÜe
 = 
g‘ScÜe
(
n1
);

39 ià(
	gBy‹s
.
toFlßt
(
scÜe
è< By‹s.toFlßt(
g‘ScÜe
(
n2
))) {

41 
	gscÜe
 = 
g‘ScÜe
(
n2
);

42 
	gv®ue
 = 
Ãw
 
DupPaœ
(
n2
, 
n1
);

45 
	gcÚ‹xt
.
wr™e
(
Ãw
 
TrË
(
key
, 
scÜe
, 
v®ue
), 
NuÎWr™abË
.
g‘
());

50 
´iv©e
 
	gby‹
[] 
g‘ScÜe
(
PageNode
 
²
) {

51  
	g²
.
g‘Pr
();

	@com/zhongsou/incload/SelectLogicReducer.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

5 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

12 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

21 
public
 
şass
 
S–eùLogicReduûr


22 
ex‹nds
 
	gReduûr
<
	gTrË
, 
	gNuÎWr™abË
, 
	gImmubËBy‹sWr™abË
, ImmutableBytesWritable> {

23 
´iv©e
 
MuÉËOuuts
 
	gmos
;

25 
´iv©e
 
	gHashS‘
<
	gImmubËBy‹sWr™abË
> 
	gd–S‘


26 ğ
Ãw
 
HashS‘
<
ImmubËBy‹sWr™abË
>();

27 
´iv©e
 
	gHashS‘
<
	gImmubËBy‹sWr™abË
> 
	gmdfS‘


28 ğ
Ãw
 
HashS‘
<
ImmubËBy‹sWr™abË
>();

30 
´iv©e
 
fš®
 
	gby‹
[] 
	gNEW
 = 
By‹s
.
toBy‹s
("1");

31 
´iv©e
 
fš®
 
	gby‹
[] 
	gLOAD
 = 
NEW
;

32 
´iv©e
 
fš®
 
	gby‹
[] 
	gUNLOAD
 = 
By‹s
.
toBy‹s
("0");

35 
´iv©e
 
fš®
 
	gby‹
[] 
	gcf
 = 
By‹s
.
toBy‹s
("P");

36 
´iv©e
 
fš®
 
	gby‹
[] 
	gl
 = 
By‹s
.
toBy‹s
("l");

38 @
Ov”ride


39 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
)

40 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

41 
	gmos
 = 
Ãw
 
MuÉËOuuts
(
cÚ‹xt
);

42 
	gsu³r
.
£tup
(
cÚ‹xt
);

55 
public
 
»duû
(
TrË
 
key
, 
I‹¿bË
<
NuÎWr™abË
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
)

56 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

57 
DupPaœ
 
	gdupPaœ
 = 
key
.
g‘DupPaœ
();

58 
PageNode
 
	gn1
 = 
dupPaœ
.
g‘N1
();

59 
PageNode
 
	gn2
 = 
dupPaœ
.
g‘N2
();

61 
	gby‹
[] 
	gn1Nf
 = 
n1
.
g‘Nf
();

62 
	gby‹
[] 
	gn2Nf
 = 
n2
.
g‘Nf
();

63 
	gby‹
[] 
	gn1Lf
 = 
n1
.
g‘Lf
();

64 
	gby‹
[] 
	gn2Lf
 = 
n2
.
g‘Lf
();

69 
ImmubËBy‹sWr™abË
 
	gouutKey
 = 
Ãw
 ImmubËBy‹sWr™abË(
n2
.
g‘U¾id
());

70 
ImmubËBy‹sWr™abË
 
	gn1U¾id
 = 
Ãw
 ImmubËBy‹sWr™abË(
n1
.
g‘U¾id
());

73 ià(
	gA¼ays
.
equ®s
(
n1Nf
, 
NEW
)) {

74 ià(!
	gd–S‘
.
cÚšs
(
n1U¾id
)) {

75 ià(
	gA¼ays
.
equ®s
(
n2Nf
, 
NEW
)) {

76 ià(!
	gd–S‘
.
cÚšs
(
ouutKey
)) {

77 
	gd–S‘
.
add
(
ouutKey
);

78 
	gLog
.
šfo
("n1 i Ãw ,n2 i Ãw,‚2‡ddØd–‘li¡‚1=" + 
n1
 + "‚2=" + 
n2
);

79 
	gcÚ‹xt
.
wr™e
(
ouutKey
, 
n1U¾id
);

83 ià(
	gA¼ays
.
equ®s
(
n2Lf
, 
LOAD
)) {

84 ià(!
	gmdfS‘
.
cÚšs
(
ouutKey
)) {

85 
	gmdfS‘
.
add
(
ouutKey
);

86 
	gLog
.
šfo
("n1 i Ãw ,n2 i lßd,n2‡ddØmodify†i¡‚1=" + 
n1
 + "‚2=" + 
n2
);

87 
	gmos
.
wr™e
("modifyšgLi¡", 
ouutKey
, 
n1U¾id
);

94 ià(
	gA¼ays
.
equ®s
(
n2Nf
, 
NEW
)) {

95 ià(!
	gd–S‘
.
cÚšs
(
ouutKey
)) {

96 
	gd–S‘
.
add
(
ouutKey
);

97 
	gLog
.
šfo
("n1 i lßd ,n2 i Ãw,n2‡ddØd–‘li¡‚1=" + 
n1
 + "‚2=" + 
n2
);

98 
	gcÚ‹xt
.
wr™e
(
ouutKey
, 
n1U¾id
);

105 @
Ov”ride


106 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

107 
	gmos
.
şo£
();

108 
	gLog
.
šfo
("cu¼’ˆsizoàd–S‘:" + 
d–S‘
.
size
());

109 
	gLog
.
šfo
("cu¼’ˆsizoàmdfS‘:" + 
mdfS‘
.
size
());

110 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

	@com/zhongsou/incload/SizeCal.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gG‘
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abË
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

16 
public
 cÏs 
	cSizeC®
 {

17 
´iv©e
 
fš®
 
	mby‹
[] 
	mcf
 = 
By‹s
.
toBy‹s
("P");

18 
´iv©e
 
fš®
 
	mby‹
[] 
	mf
 = 
By‹s
.
toBy‹s
("f");

19 
´iv©e
 
fš®
 
	mby‹
[] 
	mp
 = 
By‹s
.
toBy‹s
("p");

20 
´iv©e
 
fš®
 
	mby‹
[] 
	ml
 = 
By‹s
.
toBy‹s
("l");

21 
´iv©e
 
fš®
 
	mby‹
[] 
	mn
 = 
By‹s
.
toBy‹s
("n");

23 
public
 
	$maš
(
SŒšg
[] 
¬gs
è
throws
 
IOExû±iÚ
 {

24 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

27 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, "webbase");

29 
by‹
[] 
rowkey
 = 
SŒšgUts
.
	`hexSŒšgToBy‹
("30d12800f4e5f192");

30 
G‘
 
g‘
 = 
Ãw
 
	`G‘
(
rowkey
);

31 
ResuÉ
 
»suÉ
 = 
bË
.
	`g‘
(
g‘
);

33 
by‹
[] 
u¾id
 = 
»suÉ
.
	`g‘Row
();

34 
by‹
[] 
fšg”
 = 
»suÉ
.
	`g‘V®ue
(
cf
, 
f
);

35 
by‹
[] 
´
 = 
»suÉ
.
	`g‘V®ue
(
cf
, 
p
);

36 
by‹
[] 
lf
 = 
»suÉ
.
	`g‘V®ue
(
cf
, 
l
);

37 
by‹
[] 
nf
 = 
»suÉ
.
	`g‘V®ue
(
cf
, 
n
);

38 
PageNode
 
²1
 = 
Ãw
 
	`PageNode
(
u¾id
, 
fšg”
, 
´
, 
lf
, 
nf
);

39 
PageNode
 
²2
 = 
Ãw
 
	`PageNode
(
²1
);

40 
DupPaœ
 
dp
 = 
Ãw
 
	`DupPaœ
(
²1
, 
²2
);

42 
KeyV®uePaœ
 
kvp
 = 
Ãw
 
	`KeyV®uePaœ
Òew 
	`ImmubËBy‹sWr™abË
(
u¾id
), 
dp
);

44 
by‹
[] 
a
 = 
	`£rŸlize
(
dp
);

45 
by‹
[] 
b
 = 
	`£rŸlize
(
kvp
);

46 
couÁ
 = 0;

47 
by‹
 
™em
 : 
b
) {

48 
couÁ
++;

49 
Sy¡em
.
out
.
	`´šn
(
couÁ
 + ":" + 
™em
);

51 
Sy¡em
.
out
.
	`´šn
();

52 
Sy¡em
.
out
.
	`´šn
(
a
.
Ëngth
);

53 
Sy¡em
.
out
.
	`´šn
(
b
.
Ëngth
);

56 
public
 
by‹
[] 
	$£rŸlize
(
Wr™abË
 
wr™abË
è
throws
 
IOExû±iÚ
 {

57 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

58 
D©aOuutSŒ—m
 
d©aOut
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

59 
wr™abË
.
	`wr™e
(
d©aOut
);

60 
d©aOut
.
	`şo£
();

61  
out
.
	`toBy‹A¼ay
();

62 
	}
}

	@com/zhongsou/incload/SpamPageGenerate.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

5 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

6 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gM­
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeStus
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gIOUts
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gReæeùiÚUts
;

18 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gS–eùAndS’dJob
;

19 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gSpid”Job
;

21 
public
 cÏs 
	cS·mPageG’”©e
 {

23 
´iv©e
 
	mM­
<
	mImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË> 
	mu¾idFšg”M­
 = 
Ãw
 
HashM­
<
ImmubËBy‹sWr™abË
, ImmutableBytesWritable>();

24 
´iv©e
 
	mM­
<
	mImmubËBy‹sWr™abË
, 
	mIÁeg”
> 
	mfšg”CouÁ”M­
 = 
Ãw
 
HashM­
<
ImmubËBy‹sWr™abË
, Integer>();

26 
´iv©e
 
SŒšg
 
	mÃwLßdURLAndFšg”Fe
;

27 
´iv©e
 
SŒšg
 
	m¥amFe
;

28 
´iv©e
 
SŒšg
 
	mšput
;

30 
public
 
	$S·mPageG’”©e
(
SŒšg
 
u¾AndFšg”FŞd”
, SŒšg 
£qTime
) {

31 
ÃwLßdURLAndFšg”Fe
 = 
Spid”Job
.
ROOT_DIR
 + "/" + Spid”Job.
NEW_URL_AND_FINGER_DIR
 + "/" + 
£qTime
;

32 
¥amFe
 = 
Spid”Job
.
ROOT_DIR
 + "/" + Spid”Job.
SAME_FINGER_DOCID_DELETE_DIR
 + "/" + 
£qTime
;

33 
this
.
šput
 = 
u¾AndFšg”FŞd”
;

36 
public
 
	$´oûss
(
CÚfigu¿tiÚ
 
cÚf
, 
FeSy¡em
 
fs
) {

37 
»s
 = -1;

39 
Sequ’ûFe
.
R—d”
 
»ad”
 = 
nuÎ
;

40 
Sequ’ûFe
.
Wr™”
 
nÜm®PageWr™”
 = 
nuÎ
;

41 
Sequ’ûFe
.
Wr™”
 
¥amPageWr™”
 = 
nuÎ
;

43 
nÜm®CouÁ
 = 0;

44 
¥amCouÁ
 = 0;

46 
Œy
 {

47 
nÜm®PageWr™”
 = 
Ãw
 
Sequ’ûFe
.
	`Wr™”
(
fs
, 
cÚf
,‚ew 
	`P©h
(
ÃwLßdURLAndFšg”Fe
), 
ImmubËBy‹sWr™abË
.
şass
, ImmutableBytesWritable.class);

48 
¥amPageWr™”
 = 
Ãw
 
Sequ’ûFe
.
	`Wr™”
(
fs
, 
cÚf
,‚ew 
	`P©h
(
¥amFe
), 
ImmubËBy‹sWr™abË
.
şass
, ImmutableBytesWritable.class);

49 
Li¡
<
P©h
> 
·ths
 = 
	`g‘P©hs
(
šput
);

50 
P©h
 
·th
 : 
·ths
) {

51 
»ad”
 = 
Ãw
 
Sequ’ûFe
.
	`R—d”
(
fs
, 
·th
, 
cÚf
);

52 
ImmubËBy‹sWr™abË
 
u¾id
 = (ImmubËBy‹sWr™abËè
ReæeùiÚUts
.
	`ÃwIn¡ªû
(
»ad”
.
	`g‘KeyCÏss
(), 
cÚf
);

53 
ImmubËBy‹sWr™abË
 
fšg”
 = (ImmubËBy‹sWr™abËè
ReæeùiÚUts
.
	`ÃwIn¡ªû
(
»ad”
.
	`g‘V®ueCÏss
(), 
cÚf
);

54 
ImmubËBy‹sWr™abË
 
ibFšg”
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
Òew 
by‹
[0]);

55 
ImmubËBy‹sWr™abË
 
ibU¾id
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
Òew 
by‹
[0]);

57 
»ad”
.
	`Ãxt
(
u¾id
, 
fšg”
)) {

58 
ibFšg”
=
Ãw
 
	`ImmubËBy‹sWr™abË
(
fšg”
.
	`cİyBy‹s
());

59 
ibU¾id
=
Ãw
 
	`ImmubËBy‹sWr™abË
(
u¾id
.
	`cİyBy‹s
());

61 ià(
fšg”CouÁ”M­
.
	`keyS‘
().
	`cÚšs
(
ibFšg”
)) {

63 
u¾idFšg”M­
.
	`put
(
ibU¾id
, 
ibFšg”
);

64 
fšg”CouÁ”M­
.
	`put
(
ibFšg”
, fšg”CouÁ”M­.
	`g‘
(ibFinger) + 1);

67 
nÜm®PageWr™”
.
	`­³nd
(
ibU¾id
, 
ibFšg”
);

68 
nÜm®CouÁ
++;

69 
fšg”CouÁ”M­
.
	`put
(
ibFšg”
, 1);

72 
IOUts
.
	`şo£SŒ—m
(
»ad”
);

75 
ImmubËBy‹sWr™abË
 
f
 = 
nuÎ
;

76 
ImmubËBy‹sWr™abË
 
u
 : 
u¾idFšg”M­
.
	`keyS‘
()) {

77 
f
 = 
u¾idFšg”M­
.
	`g‘
(
u
);

78 ià(
fšg”CouÁ”M­
.
	`g‘
(
f
) > 1000) {

79 
¥amPageWr™”
.
	`­³nd
(
u
, 
f
);

80 
¥amCouÁ
++;

82 
nÜm®PageWr™”
.
	`­³nd
(
u
, 
f
);

83 
nÜm®CouÁ
++;

86 
»s
 = 
¥amCouÁ
;

87 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

88 
e
.
	`´štSckT¿û
();

89 } 
fš®ly
 {

90 
IOUts
.
	`şo£SŒ—m
(
nÜm®PageWr™”
);

91 
IOUts
.
	`şo£SŒ—m
(
¥amPageWr™”
);

92 
S–eùAndS’dJob
.
logg”
.
	`šfo
("d–‘¥am fšished!‚Üm®:\t" + 
nÜm®CouÁ
 + "\t¥am:" + 
¥amCouÁ
);

94  
»s
;

95 
	}
}

97 
´iv©e
 
	gLi¡
<
	gP©h
> 
	$g‘P©hs
(
SŒšg
 
rP©h
) {

98 
Li¡
<
P©h
> 
¶
 = 
Ãw
 
A¼ayLi¡
<Path>();

99 
Œy
 {

100 
FeSy¡em
 
fs
 = FeSy¡em.
	`g‘
(
Ãw
 
	`CÚfigu¿tiÚ
());

101 
FeStus
[] 
¡©us
 = 
fs
.
	`li¡Stus
(
Ãw
 
	`P©h
(
rP©h
));

102 
i
 = 0; i < 
¡©us
.
Ëngth
; i++) {

103 
¶
.
	`add
(
¡©us
[
i
].
	`g‘P©h
());

105 } 
	`ÿtch
 (
Exû±iÚ
 
ex
) {

106 
ex
.
	`´štSckT¿û
();

108  
¶
;

109 
	}
}

111 
´iv©e
 
fš®
 
	gMEGABYTE
 = 1024L * 1024L;

113 
public
 
	$by‹sToMegaby‹s
(
by‹s
) {

114  
by‹s
 / 
MEGABYTE
;

115 
	}
}

117 
public
 
	$maš
(
SŒšg
[] 
¬gs
è
throws
 
IOExû±iÚ
 {

118 
RuÁime
 
ruÁime
 = RuÁime.
	`g‘RuÁime
();

119 
¡¬t
 = 
ruÁime
.
	`tÙ®MemÜy
();

120 
CÚfigu¿tiÚ
 
cÚf
 = 
Ãw
 
	`CÚfigu¿tiÚ
();

121 
FeSy¡em
 
fs
 = FeSy¡em.
	`g‘
(
cÚf
);

122 
Ãw
 
	`S·mPageG’”©e
("/u£r/kaiç/Ãw-u¾id-fšg”/9", "20121128183207").
	`´oûss
(
cÚf
, 
fs
);

123 
fšish
 = 
ruÁime
.
	`tÙ®MemÜy
();

128 
memÜy
 = 
¡¬t
 - 
fšish
;

129 
Sy¡em
.
out
.
	`´šn
("u£d memÜy i by‹s: " + 
memÜy
);

130 
Sy¡em
.
out
.
	`´šn
("u£d memÜy i megaby‹s: " + 
	`by‹sToMegaby‹s
(
memÜy
));

131 
Œue
) {

132 
Sy¡em
.
out
.
	`´šn
("sleep");

133 
Œy
 {

134 
Th»ad
.
	`¦“p
(1000 * 10);

135 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

137 
e
.
	`´štSckT¿û
();

141 
	}
}

	@com/zhongsou/incload/Triple.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	gšşßd
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

18 
public
 
şass
 
TrË


19 
im¶em’ts
 
	gWr™abËCom·¿bË
<
	gTrË
> {

20 
´iv©e
 
ImmubËBy‹sWr™abË
 
	gkey
;

21 
´iv©e
 
	gby‹
[] 
	gscÜe
;

22 
´iv©e
 
DupPaœ
 
	gdupPaœ
;

24 
public
 
TrË
() {

25 
£t
(
Ãw
 
ImmubËBy‹sWr™abË
(),

26 
Ãw
 
by‹
[4],

27 
Ãw
 
DupPaœ
());

30 
public
 
TrË
(
ImmubËBy‹sWr™abË
 
key
,

31 
by‹
 [] 
scÜe
,

32 
DupPaœ
 
dupPaœ
) {

33 
£t
(
key
, 
scÜe
, 
dupPaœ
);

36 
public
 
£t
(
ImmubËBy‹sWr™abË
 
key
,

37 
by‹
[] 
scÜe
,

38 
DupPaœ
 
dupPaœ
) {

39 
	gthis
.
	gkey
 = 
key
;

40 
	gthis
.
	gscÜe
 = 
scÜe
;

41 
	gthis
.
	gdupPaœ
 = 
dupPaœ
;

44 
public
 
ImmubËBy‹sWr™abË
 
g‘Key
() {

45  
	gkey
;

48 
public
 
	gby‹
[] 
g‘ScÜe
() {

49  
	gscÜe
;

52 
public
 
DupPaœ
 
g‘DupPaœ
() {

53  
	gdupPaœ
;

56 @
Ov”ride


57 
public
 
wr™e
(
fš®
 
D©aOuut
 
out
)

58 
throws
 
	gIOExû±iÚ
 {

59 
	gkey
.
wr™e
(
out
);

60 
	gout
.
wr™e
(
scÜe
, 0, 4);

61 
	gdupPaœ
.
wr™e
(
out
);

64 @
Ov”ride


65 
public
 
»adF›lds
(
fš®
 
D©aIÅut
 
š
)

66 
throws
 
	gIOExû±iÚ
 {

67 
	gkey
.
»adF›lds
(
š
);

68 
	gš
.
»adFuÎy
(
scÜe
, 0, 4);

69 
	gdupPaœ
.
»adF›lds
(
š
);

72 @
Ov”ride


73 
public
 
hashCode
() {

74 
fš®
 
	g´ime
 = 31;

75 
	g»suÉ
 = 1;

77 
	g»suÉ
 = 
»suÉ
 * 
´ime
 + ((
key
 =ğ
nuÎ
è? 0 : key.
hashCode
());

78 
	g»suÉ
 = 
»suÉ
 * 
´ime
 + ((
scÜe
 =ğ
nuÎ
è? 0 : 
A¼ays
.
hashCode
(score));

79 
	g»suÉ
 = 
»suÉ
 * 
´ime
 + ((
dupPaœ
 =ğ
nuÎ
è? 0 : dupPaœ.
hashCode
());

81  
	g»suÉ
;

84 @
Ov”ride


85 
public
 
boŞ—n
 
equ®s
(
Objeù
 
o
) {

86 ià(
o
 
š¡ªûof
 
	gTrË
) {

87 
TrË
 
	g
 = (TrË)
o
;

88  
	gthis
.
	gkey
.
equ®s
(

.
key
) &&

89 
	gA¼ays
.
equ®s
(
scÜe
, 

.score) &&

90 
	gdupPaœ
.
equ®s
(

.
dupPaœ
);

92  
	gçl£
;

95 @
Ov”ride


96 
public
 
com·»To
(
TrË
 

) {

97 
	gcmp
 = 
key
.
com·»To
(

.key);

98 ià(
	gcmp
 != 0) {

99  
cmp
;

102 
	gcmp
 = 
Ãw
 
Flßt
(
By‹s
.
toFlßt
(
scÜe
)).

103 
com·»To
(
Ãw
 
Flßt
(
By‹s
.
toFlßt
(

.
g‘ScÜe
())));

104 ià(
	gcmp
 != 0) {

105  
cmp
;

108 
	gcmp
 = 
SŒšgUts
.
by‹ToHexSŒšg
(
dupPaœ
.
g‘N1
().
g‘U¾id
()).

109 
com·»To
(
SŒšgUts
.
by‹ToHexSŒšg
(

.
dupPaœ
.
g‘N1
().
g‘U¾id
()));

110 ià(
	gcmp
 != 0) {

111  
cmp
;

114  (
	gSŒšgUts
.
by‹ToHexSŒšg
(
dupPaœ
.
g‘N2
().
g‘U¾id
()).

115 
com·»To
(
SŒšgUts
.
by‹ToHexSŒšg
(

.
dupPaœ
.
g‘N2
().
g‘U¾id
())));

118 @
Ov”ride


119 
public
 
SŒšg
 
toSŒšg
() {

120  
	gSŒšgUts
.
by‹ToHexSŒšg
(
key
.
g‘
()) + "\t" +

121 
	gSŒšgUts
.
by‹ToHexSŒšg
(
scÜe
) + "\t" +

122 
	gdupPaœ
.
toSŒšg
();

	@com/zhongsou/robots/BMTrie.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	grobÙs
;

3 
public
 cÏs 
	cBMTr›
 {

	@com/zhongsou/robots/BMTrieNode.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	grobÙs
;

3 
public
 cÏs 
	cBMTr›Node
 {

4 
´iv©e
 
by‹
 
	md©a
;

5 
´iv©e
 
	mBMTr›Node
 [] 
	mchds
;

6 
´iv©e
 
	mby‹
 [] 
	mchdsB™m­
;

8 
public
 
	$BMTr›Node
() {

9 
d©a
 = ' ';

10 
chds
 = 
Ãw
 
BMTr›Node
[256];

11 
chdsB™m­
 = 
Ãw
 
by‹
[32];

14 
public
 
	$£tD©a
(
by‹
 
ch
) {

15 
d©a
 = 
ch
;

16 
	}
}

18 
public
 
by‹
 
	$g‘D©a
() {

19  
d©a
;

20 
	}
}

	@com/zhongsou/spider/avro/ParserResultConverter.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gavro
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

5 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—m
;

6 
impÜt
 
	gjava
.
	gnio
.
	gBy‹Bufãr
;

7 
impÜt
 
	gjava
.
	g‹xt
.
	gSim¶eD©eFÜm©
;

8 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

9 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

10 
impÜt
 
	gjava
.
	gut
.
	gM­
;

11 
impÜt
 
	gjava
.
	gut
.
	gM­
.
	gEÁry
;

12 
impÜt
 
	gjava
.
	gut
.
	gPrİ”t›s
;

13 
impÜt
 
	gjava
.
	gut
.
	gRªdom
;

14 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gSchema
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gSchema
.
	gF›ld
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gg’”ic
.
	gG’”icA¼ay
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gg’”ic
.
	gG’”icD©umR—d”
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gg’”ic
.
	gG’”icD©umWr™”
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gg’”ic
.
	gG’”icRecÜd
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gio
.
	gBš¬yDecod”
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gio
.
	gBš¬yEncod”
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gio
.
	gDecod”FaùÜy
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gio
.
	gEncod”FaùÜy
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gPaœ
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

31 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gP¬£rResuÉ
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gURLInfo
;

35 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
.
	gURLF‹rExû±iÚ
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
.
	gURLF‹rs
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
.
	gURLNÜm®iz”s
;

38 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

39 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

40 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gSpid”CÚfigu¿tiÚ
;

42 
public
 cÏs 
	cP¬£rResuÉCÚv”‹r
 {

43 
public
 
	mMAX_ERROR_TIMES
 = 10;

44 
Schema
 
	m»cÜdSchema
;

45 
Schema
 
	mlškSchema
;

46 
	mLi¡
<
	mF›ld
> 
	mf›ldLi¡
;

47 
Prİ”t›s
 
	mp
;

48 
	mÚeHourTime
 = 60 * 60 * 1000;

49 
fš®
 
	mby‹
[] 
	mz”o
 = 
Ãw
 
by‹
[0];

50 
	mG’”icD©umR—d”
<
	mG’”icRecÜd
> 
	m»cÜdR—d”
 = 
Ãw
 
G’”icD©umR—d”
<
G’”icRecÜd
>(

51 
»cÜdSchema
);

52 
	mG’”icD©umWr™”
<
	mG’”icA¼ay
<
	mG’”icRecÜd
>> 
	m¬¿yWr™”
 = 
Ãw
 
G’”icD©umWr™”
<
G’”icA¼ay
<
G’”icRecÜd
>>(

53 
lškSchema
);

54 
Bš¬yEncod”
 
	m¬¿yEncod”
 = 
nuÎ
;

55 
Bš¬yDecod”
 
	m»cÜdDecod”
 = 
nuÎ
;

57 
G’”icRecÜd
 
	m»suÉ
 = 
nuÎ
;

58 
URLNÜm®iz”s
 
	mu¾NÜm®iz”
;

59 
URLF‹rs
 
	mu¾F‹r
;

60 
Sim¶eD©eFÜm©
 
	md©efÜm©
 = 
Ãw
 SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

61 
by‹
 
	mÃwtime¡amp
[];

62 
Rªdom
 
	m¿nd
 = 
Ãw
 Random();

64 
public
 
	$P¬£rResuÉCÚv”‹r
(
CÚfigu¿tiÚ
 
cÚf
) {

65 
u¾NÜm®iz”
 = 
Ãw
 
	`URLNÜm®iz”s
(
cÚf
);

66 
u¾F‹r
 = 
Ãw
 
	`URLF‹rs
(
cÚf
);

67 ià(
cÚf
.
	`g‘
("u¾nÜm®iz”.»gex.fe"è=ğ
nuÎ
) {

68 
Log
.
	`šfo
("can‚ot†oad spider defaul config");

72 
public
 
	$P¬£rResuÉCÚv”‹r
(
time¡amp
) {

73 
CÚfigu¿tiÚ
 
cÚf
 = 
Spid”CÚfigu¿tiÚ
.
	`ü—‹
();

74 
u¾NÜm®iz”
 = 
Ãw
 
	`URLNÜm®iz”s
(
cÚf
);

75 
u¾F‹r
 = 
Ãw
 
	`URLF‹rs
(
cÚf
);

76 ià(
cÚf
.
	`g‘
("u¾nÜm®iz”.»gex.fe"è=ğ
nuÎ
) {

77 
Log
.
	`šfo
("can‚ot†oad spider defaul config");

79 
this
.
Ãwtime¡amp
 = 
By‹s
.
	`toBy‹s
(
time¡amp
);

80 
	}
}

82 
public
 
	$P¬£rResuÉCÚv”‹r
(
time¡amp
,
CÚfigu¿tiÚ
 
cÚf
) {

83 
u¾NÜm®iz”
 = 
Ãw
 
	`URLNÜm®iz”s
(
cÚf
);

84 
u¾F‹r
 = 
Ãw
 
	`URLF‹rs
(
cÚf
);

85 ià(
cÚf
.
	`g‘
("u¾nÜm®iz”.»gex.fe"è=ğ
nuÎ
) {

86 
Log
.
	`šfo
("can‚ot†oad spider defaul config");

88 
this
.
Ãwtime¡amp
 = 
By‹s
.
	`toBy‹s
(
time¡amp
);

89 
	}
}

91 
	gM­
<
	gSŒšg
, 
	gPaœ
<
	gby‹
[], by‹[]>> 
	gÇmeM­
 = 
Ãw
 
HashM­
<
SŒšg
, Pair<byte[], byte[]>>();

93 
	gŒy
 {

94 
IÅutSŒ—m
 
	gšput
 = 
P¬£rResuÉCÚv”‹r
.
şass


95 .
g‘ResourûAsSŒ—m
("resource/parser_data.avro");

96 
	gSchema
.
P¬£r
 
	g·r£r
 = 
Ãw
 
Schema
.Parser();

97 
	g»cÜdSchema
 = 
·r£r
.
·r£
(
šput
);

98 
F›ld
 
	gd
 = 
»cÜdSchema
.
g‘F›ld
("parser_link");

99 
	gf›ldLi¡
 = 
»cÜdSchema
.
g‘F›lds
();

100 
	glškSchema
 = 
d
.
schema
();

101 
	gSy¡em
.
	gout
.
´šn
(
»cÜdSchema
.
toSŒšg
(
Œue
));

102 
	gšput
.
şo£
();

103 
	gšput
 = 
P¬£rResuÉCÚv”‹r
.
şass


104 .
g‘ResourûAsSŒ—m
("resource/avrodata2hbase.properties");

105 
	gp
 = 
Ãw
 
Prİ”t›s
();

106 
	gp
.
lßd
(
šput
);

107 
	gS‘
<
	gEÁry
<
	gObjeù
, Objeù>> 
	g£t
 = 
p
.
’ŒyS‘
();

108 
EÁry
 
	g’Œy
 : 
£t
) {

109 
SŒšg
 
v®ue
 = (SŒšgè(
’Œy
.
g‘V®ue
());

110 
	gv®ue
 = 
v®ue
.
Œim
();

111 ià(
	gv®ue
.
cÚšs
(" ")) {

112 
SŒšg
 
	ga
[] = 
v®ue
.
¥l™
(" ");

113 
SŒšg
 
	gf
 : 
a
) {

114 
SŒšg
 
b
[] = 
f
.
¥l™
(":");

115 ià(
	gb
.
	gËngth
 == 2) {

116 
by‹
[] 
çmy
 = 
By‹s
.
toBy‹s
(
b
[0]);

117 
	gby‹
[] 
	gqu®if›r
 = 
By‹s
.
toBy‹s
(
b
[1]);

118 
	gÇmeM­
.
put
(
f
, 
Ãw
 
Paœ
<
by‹
[], by‹[]>(
çmy
,

119 
qu®if›r
));

120 
	gSy¡em
.
	gout
.
´šn
(
f
);

124 
SŒšg
 
	gb
[] = 
v®ue
.
¥l™
(":");

125 ià(
	gb
.
	gËngth
 == 2) {

126 
by‹
[] 
çmy
 = 
By‹s
.
toBy‹s
(
b
[0]);

127 
	gby‹
[] 
	gqu®if›r
 = 
By‹s
.
toBy‹s
(
b
[1]);

128 
	gÇmeM­
.
put
(
v®ue
, 
Ãw
 
Paœ
<
by‹
[], by‹[]>(
çmy
,

129 
qu®if›r
));

130 
	gSy¡em
.
	gout
.
´šn
(
v®ue
);

135 
	gby‹
[] 
	gfçmy
 = 
By‹s
.
toBy‹s
("F");

136 
	gby‹
[] 
	gã¼Ü
 = 
By‹s
.
toBy‹s
("e");

137 
	gÇmeM­
.
put
("F:e", 
Ãw
 
Paœ
<
by‹
[], by‹[]>(
fçmy
, 
ã¼Ü
));

138 
	gby‹
[] 
	gf¡©us
 = 
By‹s
.
toBy‹s
("s");

139 
	gÇmeM­
.
put
("F:s", 
Ãw
 
Paœ
<
by‹
[], by‹[]>(
fçmy
, 
f¡©us
));

140 
	gby‹
[] 
	gÃxtDowÁime
 = 
By‹s
.
toBy‹s
("d");

141 
	gÇmeM­
.
put
("F:d", 
Ãw
 
Paœ
<
by‹
[], by‹[]>(
fçmy
, 
ÃxtDowÁime
));

143 
	gby‹
[] 
	gacûssTime
 = 
By‹s
.
toBy‹s
("a");

144 
	gÇmeM­
.
put
("F:a", 
Ãw
 
Paœ
<
by‹
[], by‹[]>(
fçmy
, 
acûssTime
));

146 
	gfçmy
 = 
By‹s
.
toBy‹s
("P");

147 
	gby‹
[] 
	g³¼Ü
 = 
By‹s
.
toBy‹s
("er");

148 
	gÇmeM­
.
put
("P:”", 
Ãw
 
Paœ
<
by‹
[], by‹[]>(
fçmy
, 
³¼Ü
));

150 
	gby‹
[] 
	g´
 = 
By‹s
.
toBy‹s
("p");

151 
	gÇmeM­
.
put
("P:p", 
Ãw
 
Paœ
<
by‹
[], by‹[]>(
fçmy
, 
´
));

153 
	gšput
.
şo£
();

155 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

157 
	ge
.
´štSckT¿û
();

172 
public
 
P¬£rResuÉ
 
cÚv”‹r
(
by‹
 
key
[], 
keyËn
, by‹[] 
v®ue
,

173 
v®ueL’
, 
Li¡
<
KeyV®ue
> 
kvLi¡
) {

174 
P¬£rResuÉ
 
	g·r£ResuÉ
 = 
Ãw
 ParserResult();

175 
	g·r£ResuÉ
.
£tU¾Md5
(
key
, 
keyËn
);

176 
	g»cÜdDecod”
 = 
Decod”FaùÜy
.
g‘
()

177 .
bš¬yDecod”
(
v®ue
, 
»cÜdDecod”
);

178 
	gŒy
 {

180 
	g»suÉ
 = 
»cÜdR—d”
.
»ad
(
nuÎ
, 
this
.
»cÜdDecod”
);

181 
By‹Bufãr
 
	g¡©us
 = (By‹Bufãrè
»suÉ
.
g‘
("down_status");

182 
SŒšg
 
	gs
 = 
Ãw
 SŒšg(
¡©us
.
¬¿y
());

184 
	gLog
.
šfo
(
s
 + "\t" + s.
Ëngth
(è+ "\t" + s.
equ®s
("2"));

190 ià(
	gs
.
equ®s
("0")) {

191 
By‹Bufãr
 
	gm‘a
 = (By‹Bufãrè
»suÉ
.
g‘
("down_meta");

192 
	gnumb”
 = 
Numb”Ut
.
»adIÁ
(
m‘a
.
¬¿y
(), 16);

193 
	gnumb”
 = 
numb”
 + 1;

194 
	gPaœ
<
	gby‹
[], by‹[]> 
	g·œ
 = 
ÇmeM­
.
g‘
("F:e");

195 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
, 
·œ
.
g‘Fœ¡
(),

196 
·œ
.
g‘SecÚd
(), 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
numb”
)));

197 
	gkvLi¡
.
add
(
kv
);

200 ià(
	gnumb”
 > 
	gMAX_ERROR_TIMES
) {

201 
	gPaœ
<
	gby‹
[], by‹[]> 
	g¥aœ
 = 
ÇmeM­
.
g‘
("F:d");

202 
KeyV®ue
 
	gskv
 = 
Ãw
 KeyV®ue(
key
, 
¥aœ
.
g‘Fœ¡
(),

203 
¥aœ
.
g‘SecÚd
(), 
By‹s
.
toBy‹s
(
IÁeg”
.
MAX_VALUE
));

204 
	gkvLi¡
.
add
(
skv
);

205 
	gLog
.
šfo
("down†oad url failed ,key="

206 + 
Numb”Ut
.
g‘HexSŒšg
(
key
) + "\t failedimes="

207 + 
numb”


210 
	gPaœ
<
	gby‹
[], by‹[]> 
	g¥aœ
 = 
ÇmeM­
.
g‘
("F:d");

212 
	gÃxtTime
 = 
Sy¡em
.
cu¼’tTimeMlis
(è+ 
ÚeHourTime


213 *(10+ ()(
M©h
.
pow
(2l,
numb”
)));

214 
SŒšg
 
	g¡r
 = 
d©efÜm©


215 .
fÜm©
(
Ãw
 
java
.
ut
.
D©e
(
ÃxtTime
));

216 
	gLog
.
šfo
("down†oad url failed ,key="

217 + 
Numb”Ut
.
g‘HexSŒšg
(
key
) + "\t failedimes="

218 + 
numb”
 + "‚exˆtim =" + (
ÃxtTime
) + "\t"

219 + 
¡r
);

220 
KeyV®ue
 
	gskv
 = 
Ãw
 KeyV®ue(
key
, 
¥aœ
.
g‘Fœ¡
(),

221 
¥aœ
.
g‘SecÚd
(),

222 
By‹s
.
toBy‹s
((è(
ÃxtTime
 / 1000)));

223 
	gkvLi¡
.
add
(
skv
);

226 
	g·œ
 = 
ÇmeM­
.
g‘
("F:a");

227 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
, 
·œ
.
g‘Fœ¡
(),…aœ.
g‘SecÚd
(),

228 
Numb”Ut
.
cÚv”tIÁToC
((è(
Sy¡em


229 .
cu¼’tTimeMlis
() / 1000)));

230 
	gkvLi¡
.
add
(
kv
);

233 ià(
	gs
.
equ®s
("3")) {

234 
By‹Bufãr
 
	gm‘a
 = (By‹Bufãrè
»suÉ
.
g‘
("down_meta");

235 
By‹Bufãr
 
	gdown_cÚ‹Á
 = (By‹Bufãrè(
»suÉ


236 .
g‘
("down_content"));

237 
SŒšg
 
	gÇme
 = 
p
.
g‘Prİ”ty
("down_content");

238 
	gPaœ
<
	gby‹
[], by‹[]> 
	g·œ
 = 
ÇmeM­
.
g‘
(
Çme
);

239 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
, 
·œ
.
g‘Fœ¡
(),

240 
·œ
.
g‘SecÚd
(), 
down_cÚ‹Á
.
¬¿y
());

241 
	gnumb”
 = 
Numb”Ut
.
»adIÁ
(
m‘a
.
¬¿y
(), 16);

242 
	g·œ
 = 
ÇmeM­
.
g‘
("F:e");

243 
	gnumb”
 = 
numb”
 + 1;

245 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
, 
·œ
.
g‘Fœ¡
(),…aœ.
g‘SecÚd
(),

246 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
numb”
)));

247 
	gkvLi¡
.
add
(
kv
);

250 
	g·œ
 = 
ÇmeM­
.
g‘
("P:er");

251 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
, 
·œ
.
g‘Fœ¡
(),…aœ.
g‘SecÚd
(),

252 
By‹s
.
toBy‹s
("1"));

253 
	gkvLi¡
.
add
(
kv
);

255 ià(
	gnumb”
 > 
	gMAX_ERROR_TIMES
) {

256 
	gPaœ
<
	gby‹
[], by‹[]> 
	g¥aœ
 = 
ÇmeM­
.
g‘
("F:d");

257 
KeyV®ue
 
	gskv
 = 
Ãw
 KeyV®ue(
key
, 
¥aœ
.
g‘Fœ¡
(),

258 
¥aœ
.
g‘SecÚd
(), 
By‹s
.
toBy‹s
(
IÁeg”
.
MAX_VALUE
));

259 
	gkvLi¡
.
add
(
skv
);

260 
	gLog
.
šfo
("convert url failed ,key="

261 + 
Numb”Ut
.
g‘HexSŒšg
(
key
) + "\t failedimes="

262 + 
numb”


265 
	gPaœ
<
	gby‹
[], by‹[]> 
	g¥aœ
 = 
ÇmeM­
.
g‘
("F:d");

267 
	gÃxtTime
 = 
Sy¡em
.
cu¼’tTimeMlis
(è+ 
ÚeHourTime


268 *()(10+
M©h
.
pow
(2,
numb”
));

269 
SŒšg
 
	g¡r
 = 
d©efÜm©


270 .
fÜm©
(
Ãw
 
java
.
ut
.
D©e
(
ÃxtTime
));

271 
	gLog
.
šfo
("convert url failed ,key="

272 + 
Numb”Ut
.
g‘HexSŒšg
(
key
) + "\t failedimes="

273 + 
numb”
 + "‚exˆtim =" + (
ÃxtTime
) + "\t"

274 + 
¡r
);

275 
KeyV®ue
 
	gskv
 = 
Ãw
 KeyV®ue(
key
, 
¥aœ
.
g‘Fœ¡
(),

276 
¥aœ
.
g‘SecÚd
(),

277 
By‹s
.
toBy‹s
((è(
ÃxtTime
 / 1000)));

278 
	gkvLi¡
.
add
(
skv
);

280 
	g·œ
 = 
ÇmeM­
.
g‘
("F:a");

281 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
, 
·œ
.
g‘Fœ¡
(),…aœ.
g‘SecÚd
(),

282 
Numb”Ut
.
cÚv”tIÁToC
((è(
Sy¡em


283 .
cu¼’tTimeMlis
() / 1000)));

284 
	gkvLi¡
.
add
(
kv
);

288 ià(
	gs
.
equ®s
("2")) {

289 
By‹Bufãr
 
	gm‘a
 = (By‹Bufãrè
»suÉ
.
g‘
("down_meta");

290 
	gLog
.
šfo
("m‘¨Ëngth=" + 
m‘a
.
¬¿y
().
Ëngth
 + "\t"

291 + 
SŒšgUts
.
by‹ToHexSŒšg
(
m‘a
.
¬¿y
()));

292 
	g·r£ResuÉ
.
£tM‘a
(
m‘a
.
¬¿y
());

293 
By‹Bufãr
 
	g¶
 = (By‹Bufãrè
»suÉ
.
g‘
("parser_lang");

294 
by‹
 
	gÏng
[] = 
¶
.
¬¿y
();

295 
	g·r£Lªg
 = 0;

296 ià(
	gÏng
 !ğ
nuÎ
 && 
Ïng
.
Ëngth
 > 0

297 && 
¶
.
¬¿yOff£t
(è< 
Ïng
.
Ëngth
) {

298 
·r£Lªg
 = 
Ïng
[
¶
.
¬¿yOff£t
()];

300 
	gPaœ
<
	gby‹
[], by‹[]> 
	g·œ
 = 
ÇmeM­
.
g‘
("P:p");

303 
	g´
 = 
¿nd
.
ÃxtFlßt
();

304 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
, 
·œ
.
g‘Fœ¡
(),

305 
·œ
.
g‘SecÚd
(), 
By‹s
.
toBy‹s
(
´
));

306 
	gkvLi¡
.
add
(
kv
);

308 
F›ld
 
	gf›ld
 : 
f›ldLi¡
) {

309 ià(
f›ld
.
Çme
().
equ®s
("down_meta")

310 || 
f›ld
.
Çme
().
equ®s
("down_status")

311 || 
f›ld
.
Çme
().
equ®s
("down_url"))

313 ià(
	gf›ld
.
Çme
().
equ®s
("parser_link")) {

314 
G’”icA¼ay
 
	g·r£r_lšk
 = (G’”icA¼ayè
»suÉ


315 .
g‘
("parser_link");

316 
By‹Bufãr
 
	gc
 = (By‹Bufãrè
»suÉ
.
g‘
("down_encode");

317 
SŒšg
 
	gch¬£t
 = 
Ãw
 SŒšg(
c
.
¬¿y
());

318 
By‹A¼ayOuutSŒ—m
 
	gout
 = 
Ãw
 ByteArrayOutputStream();

319 
	g¬¿yEncod”
 = 
Encod”FaùÜy
.
g‘
().
bš¬yEncod”
(
out
,

320 
¬¿yEncod”
);

321 
	gthis
.
	g¬¿yWr™”
.
wr™e
(
·r£r_lšk
, 
¬¿yEncod”
);

322 
	g¬¿yEncod”
.
æush
();

323 
	g·œ
 = 
ÇmeM­
.
g‘
(
p
.get("parser_link"));

324 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
, 
·œ
.
g‘Fœ¡
(),

325 
·œ
.
g‘SecÚd
(), 
out
.
toBy‹A¼ay
());

326 
	gkvLi¡
.
add
(
kv
);

328 
	gsize
 = 
·r£r_lšk
.
size
();

332 ià(
	g·r£Lªg
 == 1) {

333 
i
 = 0; 
	gi
 < 
	gsize
; i++) {

334 
Objeù
 
	go
 = 
·r£r_lšk
.
g‘
(
i
);

335 ià(
o
 
š¡ªûof
 
	gG’”icRecÜd
) {

336 
By‹Bufãr
 
	gu¾bufãr
 = (By‹Bufãrè(((
G’”icRecÜd
è
o
)

337 .
g‘
("url"));

340 
SŒšg
 
	gu¾
 = 
Ãw
 SŒšg(
u¾bufãr
.
¬¿y
(),

342 
SŒšg
 
	g¤cu¾
 = 
u¾
;

343 
	gŒy
 {

345 
	gu¾
 = 
this
.
u¾F‹r
.
f‹r
(
u¾
);

346 
	gu¾
 = 
this
.
u¾NÜm®iz”
.
nÜm®ize
(
u¾
);

348 ià(
	gu¾
 !ğ
nuÎ


349 && 
u¾
.
Œim
().
Ëngth
() > 0) {

350 
URLInfo
 
šfo
 = 
Ãw
 URLInfo();

351 
	gšfo
.
£tSrcURLmd5
(
key
);

353 ià(
	gch¬£t
 !ğ
nuÎ


354 && 
ch¬£t
.
Ëngth
() > 0

355 && 
ch¬£t
.
Ëngth
() < 5

356 && !(
ch¬£t


357 .
equ®sIgnÜeCa£
("utf8"è|| 
ch¬£t


358 .
equ®sIgnÜeCa£
("utf-8"))) {

359 
by‹
 
Ãwu¾by‹
[] = 
u¾


360 .
g‘By‹s
(
ch¬£t


361 .
toLow”Ca£
()

362 .
Œim
());

363 
SŒšg
 
	ga
 = 
Ãw
 String(

364 
Ãwu¾by‹
,

365 
ch¬£t
.
toLow”Ca£
()

366 .
Œim
());

367 ià(
	ga
.
equ®s
(
u¾
)) {

368 
	gšfo
.
£tU¾
(
Ãwu¾by‹
);

370 
	gLog
.
šfo
("error url="

371 + 
u¾
);

374 
	gšfo
.
£tU¾
(
u¾
.
g‘By‹s
());

376 
MD5
 
	gmd5
 = MD5.
dige¡8
(
šfo


377 .
g‘U¾
());

378 
	gšfo
.
£tU¾md5
(
md5
.
g‘Dige¡
());

379 
	g·r£ResuÉ
.
addURLInfo
(
šfo
);

382 
	gLog
.
debug
("u¾ " + 
¤cu¾


385 } 
ÿtch
 (
URLF‹rExû±iÚ
 
e
) {

387 
	ge
.
´štSckT¿û
();

393 } ià(
	gf›ld
.
Çme
().
equ®s
("simhash")) {

395 
By‹Bufãr
 
	ghashbufãr
 = (By‹Bufãrè
»suÉ


396 .
g‘
("simhash");

397 
	g·r£ResuÉ
.
£tFšg”
(
hashbufãr
.
¬¿y
(), 8);

398 
	gby‹
[] 
	gsimhash
 = 
hashbufãr
.
¬¿y
();

399 ià(
	gsimhash
 =ğ
nuÎ
 || 
simhash
.
Ëngth
 != 8) {

400 
Log
.
šfo
("simhash†’gthƒ¼Ü " + 
simhash
.
Ëngth


401 + "\ˆu¾" + 
By‹s
.
toSŒšg
(
key
));

404 
	g·œ
 = 
ÇmeM­
.
g‘
(
p
.get("parser_newflag"));

405 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
, 
·œ
.
g‘Fœ¡
(),

406 
·œ
.
g‘SecÚd
(), 
Ãwtime¡amp
);

407 
	gkvLi¡
.
add
(
kv
);

431 
By‹Bufãr
 
	gšfobufãr
 = (By‹Bufãrè
»suÉ
.
g‘
(
f›ld


432 .
Çme
());

433 ià(
	gšfobufãr
 !ğ
nuÎ
 && 
šfobufãr
.
¬¿y
().
Ëngth
 > 0) {

434 
·œ
 = 
ÇmeM­
.
g‘
(
p
.
g‘Prİ”ty
(
f›ld
.
Çme
()));

435 ià(
	g·œ
 !ğ
nuÎ
) {

436 
kv
 = 
Ãw
 
KeyV®ue
(
key
, 
·œ
.
g‘Fœ¡
(),

437 
·œ
.
g‘SecÚd
(), 
šfobufãr
.
¬¿y
());

438 
	gkvLi¡
.
add
(
kv
);

440 
	gLog
.
šfo
("error "

441 + 
f›ld
.
Çme
()

445 
	g·œ
 = 
ÇmeM­
.
g‘
(
p
.
g‘Prİ”ty
(
f›ld
.
Çme
()));

446 ià(
	g·œ
 !ğ
nuÎ
) {

447 
kv
 = 
Ãw
 
KeyV®ue
(
key
, 
·œ
.
g‘Fœ¡
(),

448 
·œ
.
g‘SecÚd
(), 
z”o
);

449 
	gkvLi¡
.
add
(
kv
);

451 
	gLog
.
šfo
("error "

452 + 
f›ld
.
Çme
()

460 
	gLog
.
šfo
("unkowÀ”rÜ stus" + 
s
);

463 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

465 
	ge
.
´štSckT¿û
();

468  
	g·r£ResuÉ
;

471 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

474 
	}
}

	@com/zhongsou/spider/bean/JobInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
;

3 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

4 
impÜt
 
	gjava
.
	gut
.
	gM­
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

8 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gexû±iÚ
.
	gEm±yP¬amV®ueExû±iÚ
;

9 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gSpid”Job
;

11 
public
 cÏs 
	cJobInfo
 {

12 
Logg”
 
	mlog
 = Logg”.
g‘Logg”
(
JobInfo
.
şass
);

13 
´iv©e
 
SŒšg
 
	mÇme
;

14 
´iv©e
 
	mHashM­
<
	mSŒšg
, SŒšg> 
	m·¿mM­
 = 
Ãw
 
HashM­
<
SŒšg
, String>();

15 
´iv©e
 
SŒšg
 
	mcommªd
;

16 
´iv©e
 
Jobty³
 
	mty³
;

18 
public
 
SŒšg
 
	$g‘Name
() {

19  
Çme
;

22 
public
 
	$£tName
(
SŒšg
 
Çme
) {

23 
this
.
Çme
 =‚ame;

24 
	}
}

26 
public
 
	gHashM­
<
	gSŒšg
, SŒšg> 
	$g‘P¬amM­
() {

27  
·¿mM­
;

28 
	}
}

30 
public
 
£tP¬amM­
(
HashM­
<
SŒšg
, SŒšg> 
·¿mM­
) {

31 
	gthis
.
	g·¿mM­
 = 
·¿mM­
;

34 
public
 
SŒšg
 
	$g‘Commªd
() {

35  
commªd
;

36 
	}
}

38 
public
 
	$£tCommªd
(
SŒšg
 
commªd
) {

39 
this
.
commªd
 = command;

40 
	}
}

42 
public
 
Jobty³
 
	$g‘Ty³
() {

43  
ty³
;

44 
	}
}

46 
public
 
	$£tTy³
(
Jobty³
 
ty³
) {

47 
this
.
ty³
 =ype;

48 
	}
}

50 
public
 
SŒšg
 
	$g’”©eCommªd
(è
throws
 
Em±yP¬amV®ueExû±iÚ
 {

51 
SŒšg
 
s
 = 
this
.
commªd
;

52 
M­
.
EÁry
<
SŒšg
, SŒšg> 
t
 : 
Spid”Job
.
´İ”t›sM­
.
	`’ŒyS‘
()) {

53 
s
 = s.
	`»¶aû
(
t
.
	`g‘Key
(),.
	`g‘V®ue
());

56 
M­
.
EÁry
<
SŒšg
, SŒšg> 
’Œy
 : 
this
.
·¿mM­
.
	`’ŒyS‘
()) {

57 ià(
’Œy
.
	`g‘V®ue
(è=ğ
nuÎ
 ||ƒÁry.g‘V®ue().
	`equ®s
("")) {

58 
log
.
	`equ®s
("”rÜ v®ukey=" + 
’Œy
.
	`g‘Key
(è+ "\ˆcommªd=" + 
commªd
);

59 
throw
 
Ãw
 
	`Em±yP¬amV®ueExû±iÚ
();

61 
s
 = s.
	`»¶aû
(
’Œy
.
	`g‘Key
(),ƒÁry.
	`g‘V®ue
());

63  
s
.
	`Œim
();

64 
	}
}

66 
public
 
SŒšg
 
	$toSŒšg
() {

67 
SŒšgBufãr
 
bufãr
 = 
Ãw
 
	`SŒšgBufãr
();

68 
bufãr
.
	`­³nd
("Çme:" + 
Çme
 + "\‰y³=" + 
ty³
.
	`toSŒšg
(è+ "\tcommªd=" + 
commªd
 + "\n");

69 
SŒšg
 
s
 = 
bufãr
.
	`toSŒšg
();

71 
M­
.
EÁry
<
SŒšg
, SŒšg> 
’Œy
 : 
this
.
·¿mM­
.
	`’ŒyS‘
()) {

72 
bufãr
.
	`­³nd
("\t" + 
’Œy
.
	`g‘Key
(è+ "\t" +ƒÁry.
	`g‘V®ue
() + "\n");

75  
bufãr
.
	`toSŒšg
();

76 
	}
}

	@com/zhongsou/spider/bean/Jobtype.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
;

3 
public
 
	eJobty³
 {

4 
	mm­»duû_v1
, 
	mm­»duû_v2
, 
	mpes
, 
	mj¬


	@com/zhongsou/spider/bean/ParsedFingerInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
;

3 
public
 
şass
 
P¬£dFšg”Info
 
im¶em’ts
 
	gCom·¿bË
<
	gP¬£dFšg”Info
> {

4 
´iv©e
 
SŒšg
 
	gu¾AndFšg”P©h
;

5 
´iv©e
 
SŒšg
 
	ghfeOuutP©h
;

6 
´iv©e
 
SŒšg
 
	g£qTime
;

7 
´iv©e
 
SŒšg
 
	gÃwURLAndFšg”Fe
;

8 
´iv©e
 
SŒšg
 
	glßdFeP©h
;

10 
public
 
SŒšg
 
g‘LßdFeP©h
() {

11  
	glßdFeP©h
;

14 
public
 
£tLßdFeP©h
(
SŒšg
 
lßdFeP©h
) {

15 
	gthis
.
	glßdFeP©h
 = 
lßdFeP©h
;

18 
public
 
SŒšg
 
g‘NewURLAndFšg”Fe
() {

19  
	gÃwURLAndFšg”Fe
;

22 
public
 
£tNewURLAndFšg”Fe
(
SŒšg
 
ÃwURLAndFšg”Fe
) {

23 
	gthis
.
	gÃwURLAndFšg”Fe
 = 
ÃwURLAndFšg”Fe
;

26 
public
 
SŒšg
 
g‘U¾AndFšg”P©h
() {

27  
	gu¾AndFšg”P©h
;

30 
public
 
£tU¾AndFšg”P©h
(
SŒšg
 
u¾AndFšg”P©h
) {

31 
	gthis
.
	gu¾AndFšg”P©h
 = 
u¾AndFšg”P©h
;

34 
public
 
SŒšg
 
g‘HfeOuutP©h
() {

35  
	ghfeOuutP©h
;

38 
public
 
£tHfeOuutP©h
(
SŒšg
 
hfeOuutP©h
) {

39 
	gthis
.
	ghfeOuutP©h
 = 
hfeOuutP©h
;

42 
public
 
SŒšg
 
g‘SeqTime
() {

43  
	g£qTime
;

46 
public
 
£tSeqTime
(
SŒšg
 
£qTime
) {

47 
	gthis
.
	g£qTime
 = 
£qTime
;

50 @
Ov”ride


51 
public
 
hashCode
() {

53  
	gthis
.
	g£qTime
.
hashCode
();

56 @
Ov”ride


57 
public
 
boŞ—n
 
equ®s
(
Objeù
 
obj
) {

59 ià(!(
obj
 
š¡ªûof
 
	gP¬£dFšg”Info
))

60  
	gçl£
;

61 
P¬£dFšg”Info
 
	gm
 = (P¬£dFšg”Infoè
obj
;

62  
	gthis
.
	g£qTime
.
equ®s
(
m
.
g‘SeqTime
());

65 
public
 
SŒšg
 
toSŒšg
() {

66  
	gthis
.
	g£qTime
 + "\t" + 
	ghfeOuutP©h
 + "\t" + 
	gu¾AndFšg”P©h
;

69 @
Ov”ride


70 
public
 
com·»To
(
P¬£dFšg”Info
 
o
) {

72  
	gthis
.
	g£qTime
.
com·»To
(
o
.
g‘SeqTime
());

	@com/zhongsou/spider/bean/ParsedURLInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
;

10 
public
 
şass
 
P¬£dURLInfo
 
im¶em’ts
 
	gCom·¿bË
<
	gP¬£dURLInfo
> {

11 
SŒšg
 
	gm‘aFŞd”
;

12 
SŒšg
 
	gu¾InfoFŞd”
;

13 
SŒšg
 
	g£qTime
;

15 
public
 
SŒšg
 
g‘SeqTime
() {

16  
	g£qTime
;

19 
public
 
£tSeqTime
(
SŒšg
 
£qTime
) {

20 
	gthis
.
	g£qTime
 = 
£qTime
;

23 
public
 
SŒšg
 
g‘M‘aFŞd”
() {

24  
	gm‘aFŞd”
;

27 
public
 
£tM‘aFŞd”
(
SŒšg
 
m‘aFŞd”
) {

28 
	gthis
.
	gm‘aFŞd”
 = 
m‘aFŞd”
;

31 
public
 
SŒšg
 
g‘U¾InfoFŞd”
() {

32  
	gu¾InfoFŞd”
;

35 
public
 
£tU¾InfoFŞd”
(
SŒšg
 
u¾InfoFŞd”
) {

36 
	gthis
.
	gu¾InfoFŞd”
 = 
u¾InfoFŞd”
;

39 @
Ov”ride


40 
public
 
hashCode
() {

42  
	gthis
.
	g£qTime
.
hashCode
();

45 @
Ov”ride


46 
public
 
boŞ—n
 
equ®s
(
Objeù
 
obj
) {

48 ià(!(
obj
 
š¡ªûof
 
	gP¬£dURLInfo
))

49  
	gçl£
;

51 
P¬£dURLInfo
 
	go
 = (P¬£dURLInfoè
obj
;

52  
	gthis
.
g‘SeqTime
().
equ®s
(
o
.getSeqTime());

56 
public
 
SŒšg
 
toSŒšg
() {

57  
	gthis
.
	gm‘aFŞd”
 + "\t" +his.
	gu¾InfoFŞd”
;

60 @
Ov”ride


61 
public
 
com·»To
(
P¬£dURLInfo
 
o
) {

63  
	gthis
.
	g£qTime
.
com·»To
(
o
.
g‘SeqTime
());

	@com/zhongsou/spider/bean/ParserResult.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
;

3 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

4 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

5 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

7 
public
 cÏs 
	cP¬£rResuÉ
 {

8 
	mby‹
[] 
	mfšg”
;

9 
	mby‹
[] 
	mu¾
;

10 
	mby‹
[] 
	mu¾Md5
;

11 
	mS‘
<
	mURLInfo
> 
	mšfoS‘
;

12 
	mby‹
[] 
	mm‘a
;

14 
public
 
	mby‹
[] 
	$g‘M‘a
() {

15  
m‘a
;

18 
public
 
	$£tM‘a
(
by‹
[] 
m‘a
) {

19 
this
.
m‘a
 = meta;

20 
	}
}

22 
public
 
	gby‹
[] 
	$g‘Fšg”
() {

23  
fšg”
;

24 
	}
}

26 
public
 
	$£tFšg”
(
by‹
[] 
fšg”
, 
Ëngth
) {

27 
this
.
fšg”
 = finger;

28 
	}
}

30 
public
 
	gby‹
[] 
	$g‘U¾
() {

31  
u¾
;

32 
	}
}

34 
public
 
	$£tU¾
(
by‹
[] 
u¾
, 
Ëngth
) {

35 
this
.
u¾
 = url;

37 
	}
}

39 
public
 
	gS‘
<
	gURLInfo
> 
	$g‘InfoS‘
() {

40  
šfoS‘
;

41 
	}
}

43 
public
 
£tInfoS‘
(
S‘
<
URLInfo
> 
šfoS‘
) {

44 
	gthis
.
	gšfoS‘
 = 
šfoS‘
;

47 
public
 
	gby‹
[] 
	$g‘U¾Md5
() {

48  
u¾Md5
;

49 
	}
}

51 
public
 
	$£tU¾Md5
(
by‹
[] 
u¾Md5
, 
Ëngth
) {

52 
this
.
u¾Md5
 = urlMd5;

53 
	}
}

55 
public
 
	$P¬£rResuÉ
() {

56 
šfoS‘
 = 
Ãw
 
HashS‘
<
URLInfo
>();

57 
	}
}

59 
public
 
	$addURLInfo
(
URLInfo
 
šfo
) {

60 
šfoS‘
.
	`add
(
šfo
);

61 
	}
}

	@com/zhongsou/spider/bean/URLInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gHash
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abË
;

11 
public
 cÏs 
	cURLInfo
 
im¶em’ts
 
	mWr™abË
 {

12 
	mby‹
[] 
	mu¾md5
;

13 
	mby‹
[] 
	mu¾
;

14 
	mby‹
[] 
	m¤cURLmd5
;;

15 
Hash
 
	mhash
 = Hash.
g‘In¡ªû
(1);

17 
public
 
	mby‹
[] 
	$g‘U¾md5
() {

18  
u¾md5
;

21 
public
 
	$£tU¾md5
(
by‹
[] 
u¾md5
) {

22 
this
.
u¾md5
 = urlmd5;

23 
	}
}

25 
public
 
	gby‹
[] 
	$g‘U¾
() {

26  
u¾
;

27 
	}
}

29 
public
 
	$£tU¾
(
by‹
[] 
u¾
) {

30 
this
.
u¾
 = url;

31 
	}
}

33 
public
 
	gby‹
[] 
	$g‘SrcURLmd5
() {

34  
¤cURLmd5
;

35 
	}
}

37 
public
 
	$£tSrcURLmd5
(
by‹
[] 
¤cURLmd5
) {

38 
this
.
¤cURLmd5
 = srcURLmd5;

39 
	}
}

41 @
Ov”ride


42 
public
 
	$wr™e
(
D©aOuut
 
out
è
throws
 
IOExû±iÚ
 {

44 ià(
u¾
 !ğ
nuÎ
) {

45 
out
.
	`wr™eIÁ
(
u¾
.
Ëngth
);

46 
out
.
	`wr™e
(
u¾
);

48 
out
.
	`wr™eIÁ
(0);

49 ià(
u¾md5
 !ğ
nuÎ
) {

50 
out
.
	`wr™eIÁ
(
u¾md5
.
Ëngth
);

51 
out
.
	`wr™e
(
u¾md5
);

53 
out
.
	`wr™eIÁ
(0);

55 ià(
¤cURLmd5
 !ğ
nuÎ
) {

56 
out
.
	`wr™eIÁ
(
¤cURLmd5
.
Ëngth
);

57 
out
.
	`wr™e
(
¤cURLmd5
);

59 
out
.
	`wr™eIÁ
(0);

61 
	}
}

63 @
Ov”ride


64 
public
 
	$»adF›lds
(
D©aIÅut
 
š
è
throws
 
IOExû±iÚ
 {

66 
t
 = 
š
.
	`»adIÁ
();

67 ià(
t
 > 0) {

68 
u¾
 = 
Ãw
 
by‹
[
t
];

69 
š
.
	`»adFuÎy
(
u¾
);

71 
u¾
 = 
nuÎ
;

73 
t
 = 
š
.
	`»adIÁ
();

74 ià(
t
 > 0) {

75 
u¾md5
 = 
Ãw
 
by‹
[
t
];

76 
š
.
	`»adFuÎy
(
u¾md5
);

78 
u¾md5
 = 
nuÎ
;

80 
t
 = 
š
.
	`»adIÁ
();

81 ià(
t
 > 0) {

82 
¤cURLmd5
 = 
Ãw
 
by‹
[
t
];

83 
š
.
	`»adFuÎy
(
¤cURLmd5
);

85 
¤cURLmd5
 = 
nuÎ
;

87 
	}
}

89 
public
 
	$hashCode
() {

90 ià(
u¾md5
 !ğ
nuÎ
) {

91 
code
 = 
hash
.
	`hash
(
u¾md5
);

92  
code
;

97 
	}
}

99 
public
 
boŞ—n
 
	$equ®s
(
Objeù
 
o
) {

100 ià(!(
o
 
š¡ªûof
 
URLInfo
))

101  
çl£
;

103 
URLInfo
 
šfo
 = (URLInfoè
o
;

104  
A¼ays
.
	`equ®s
(
this
.
u¾md5
, 
šfo
.urlmd5);

106 
	}
}

	@com/zhongsou/spider/common/fileutil/GenerateImportHFile.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gfeut
;

3 
impÜt
 
	gjava
.
	gio
.
	gBufã»dOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gFeNÙFoundExû±iÚ
;

5 
impÜt
 
	gjava
.
	gio
.
	gFeOuutSŒ—m
;

6 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

7 
impÜt
 
	gjava
.
	gut
.
	gRªdom
;

9 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

11 
public
 cÏs 
	cG’”©eImpÜtHFe
 {

13 
Rªdom
 
	m¿nd
 = 
Ãw
 Random();

14 
	mË‰”
[] = "abcdefghijklmnİqr¡uvwxyz".
toCh¬A¼ay
();

16 
SŒšg
 
	$g’”©eURL
() {

17 
SŒšgBufãr
 
bufãr
 = 
Ãw
 
	`SŒšgBufãr
("http://");

18 
t
 = 
¿nd
.
	`ÃxtIÁ
(512) + 64;

19 
m
 = 0;

20 
ho¡DÙ
 = 
¿nd
.
	`ÃxtIÁ
(2) + 2;

21 
dÙ
 = 0;

22 
Ï¡ch
;

23 
i
 = 0; i < 
t
; i++) {

24 
m
 = 
¿nd
.
	`ÃxtIÁ
(26);

25 
Ï¡ch
 = 
Ë‰”
[
m
];

26 
bufãr
.
	`­³nd
(
Ï¡ch
);

27 ià(
dÙ
 =ğ
ho¡DÙ
 && 
m
 % 7 =ğ0 && 
Ï¡ch
 != '/') {

28 
Ï¡ch
 = '/';

29 
bufãr
.
	`­³nd
("/");

30 
i
++;

32 ià(
dÙ
 < 
ho¡DÙ
 && 
Ï¡ch
 !ğ'.' && 
m
 % 3 == 0) {

33 
bufãr
.
	`­³nd
(".");

34 
dÙ
++;

35 
Ï¡ch
 = '.';

36 
i
++;

41  
bufãr
.
	`toSŒšg
();

44 
´iv©e
 
SŒšg
 
de¡Fe
;

45 
´iv©e
 
size
;

47 
public
 
	$G’”©eImpÜtHFe
(
SŒšg
 
de¡Fe
, 
size
) {

48 
this
.
de¡Fe
 = destFile;

49 
this
.
size
 = size;

50 
	}
}

52 
public
 
	$g’”©e
() {

53 
Bufã»dOuutSŒ—m
 
wr™”
 = 
nuÎ
;

54 
by‹
 
t
[] = 
Ãw
 byte[1024];

55 
d©aSize
 = 0;

56 
Œy
 {

57 
wr™”
 = 
Ãw
 
	`Bufã»dOuutSŒ—m
Òew 
	`FeOuutSŒ—m
(
de¡Fe
));

58 
i
 = 0; i < 
size
; i++) {

59 
SŒšg
 
u¾
 = 
this
.
	`g’”©eURL
();

60 
by‹
[] 
md5
 = 
MD5
.
	`dige¡8
(
u¾
.
	`g‘By‹s
()).
	`g‘Dige¡
();

61 
wr™”
.
	`wr™e
(
md5
, 0, 8);

62 
wr™”
.
	`wr™e
("\t".
	`g‘By‹s
("utf-8"));

63 
wr™”
.
	`wr™e
(
u¾
.
	`g‘By‹s
("utf-8"));

64 
wr™”
.
	`wr™e
("\t".
	`g‘By‹s
("utf-8"));

65 
d©aSize
 = 
this
.
	`g’”©eD©a
(
t
);

66 
wr™”
.
	`wr™e
(
t
, 0, 
d©aSize
);

67 
wr™”
.
	`wr™e
("\r\n".
	`g‘By‹s
("utf-8"));

70 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

72 
e
.
	`´štSckT¿û
();

73 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

75 
e
.
	`´štSckT¿û
();

76 } 
fš®ly
 {

77 
Œy
 {

78 
wr™”
.
	`şo£
();

79 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

81 
e
.
	`´štSckT¿û
();

85 
	}
}

87 
	$g’”©eD©a
(
by‹
 
¤c
[]) {

89 
size
 = 
this
.
¿nd
.
	`ÃxtIÁ
(512) + 512;

90 
i
 = 0; i < 
size
; i++) {

91 
¤c
[
i
] = (
by‹
è('a' + 
¿nd
.
	`ÃxtIÁ
(26));

93  
size
;

94 
	}
}

96 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

97 ià(
¬gs
.
Ëngth
 < 2) {

98 
Sy¡em
.
out
.
	`´šn
("usage java com.zhongsou.spider.common.fileutil.GenerateImportHFile filename size ");

101 
G’”©eImpÜtHFe
 
f
 = 
Ãw
 
	`G’”©eImpÜtHFe
(
¬gs
[0], 
IÁeg”
.
	`·r£IÁ
(args[1]));

102 
f
.
	`g’”©e
();

103 
	}
}

	@com/zhongsou/spider/common/url/AutomatonURLFilter.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

21 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

22 
impÜt
 
	gjava
.
	gio
.
	gSŒšgR—d”
;

23 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹ºSyÁaxExû±iÚ
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

27 
impÜt
 
	gdk
.
	gbrics
.
	gautom©Ú
.
	gRegExp
;

28 
impÜt
 
	gdk
.
	gbrics
.
	gautom©Ú
.
	gRunAutom©Ú
;

39 
public
 cÏs 
	cAutom©ÚURLF‹r
 
ex‹nds
 
	mRegexURLF‹rBa£
 {

40 
public
 
fš®
 
SŒšg
 
	mURLFILTER_AUTOMATON_FILE
 = "urlfilter.automaton.file";

41 
public
 
fš®
 
SŒšg
 
	mURLFILTER_AUTOMATON_RULES
 = "urlfilter.automaton.rules";

43 
public
 
	$Autom©ÚURLF‹r
() {

44 
	`su³r
();

47 
public
 
	$Autom©ÚURLF‹r
(
SŒšg
 
f’ame
)

48 
throws
 
IOExû±iÚ
, 
P©‹ºSyÁaxExû±iÚ
 {

49 
	`su³r
(
f’ame
);

50 
	}
}

52 
	$Autom©ÚURLF‹r
(
R—d”
 
»ad”
)

53 
throws
 
IOExû±iÚ
, 
IÎeg®Argum’tExû±iÚ
 {

54 
	`su³r
(
»ad”
);

55 
	}
}

66 
´Ùeùed
 
R—d”
 
	$g‘RuËsR—d”
(
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

67 
SŒšg
 
¡ršgRuËs
 = 
cÚf
.
	`g‘
(
URLFILTER_AUTOMATON_RULES
);

68 ià(
¡ršgRuËs
 !ğ
nuÎ
) {

69  
Ãw
 
	`SŒšgR—d”
(
¡ršgRuËs
);

71 
SŒšg
 
feRuËs
 = 
cÚf
.
	`g‘
(
URLFILTER_AUTOMATON_FILE
);

72  
cÚf
.
	`g‘CÚfResourûAsR—d”
(
feRuËs
);

73 
	}
}

76 
´Ùeùed
 
RegexRuË
 
	$ü—‹RuË
(
boŞ—n
 
sign
, 
SŒšg
 
»gex
) {

77  
Ãw
 
	`RuË
(
sign
, 
»gex
);

78 
	}
}

85 
public
 
	$maš
(
SŒšg
 
¬gs
[]è
throws
 
IOExû±iÚ
 {

86 
	`maš
(
Ãw
 
	`Autom©ÚURLF‹r
(), 
¬gs
);

87 
	}
}

90 
´iv©e
 cÏs 
	cRuË
 
ex‹nds
 
	gRegexRuË
 {

92 
´iv©e
 
RunAutom©Ú
 
	gautom©Ú
;

94 
RuË
(
boŞ—n
 
sign
, 
SŒšg
 
»gex
) {

95 
su³r
(
sign
, 
»gex
);

96 
	gautom©Ú
 = 
Ãw
 
RunAutom©Ú
Òew 
RegExp
(
»gex
, RegExp.
ALL
).
toAutom©Ú
());

99 
´Ùeùed
 
boŞ—n
 
m©ch
(
SŒšg
 
u¾
) {

100  
	gautom©Ú
.
run
(
u¾
);

	@com/zhongsou/spider/common/url/BMTrieRobots.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

3 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

4 
impÜt
 
	gjava
.
	gio
.
	gFe
;

5 
impÜt
 
	gjava
.
	gio
.
	gFeR—d”
;

7 
public
 cÏs 
	cBMTr›RobÙs
 {

9 şas 
	cBMTr›Node
 {

10 
by‹
 
	mÏb–
;

11 
by‹
 
	mæag
;

12 
	mby‹
 [] 
	mb™m­
;

13 
	mBMTr›Node
 [] 
	mchd»n
;

14 
	mnumChd»n
;

15 
	m§vedPos
;

17 
public
 
BMTr›Node
(
by‹
 
®ph
, by‹ 
³rm™
) {

18 
	mÏb–
 = 
®ph
;

19 
	mæag
 = 
³rm™
;

20 
	mchd»n
 = 
nuÎ
;

21 
	mb™m­
 = 
Ãw
 
by‹
 [32];

22 
	m§vedPos
 = -1;

25 
public
 
BMTr›Node
 
addChd
(
by‹
 
Ïb–
, by‹ 
æag
) {

26 ià(
	mthis
.
	mchd»n
 =ğ
nuÎ
) {

27 
chd»n
 = 
Ãw
 
BMTr›Node
[256];

28 
	mchd»n
[
Ïb–
] = 
Ãw
 
BMTr›Node
Öab–, 
æag
);

30 ià(
	mthis
.
	mchd»n
[
Ïb–
] =ğ
nuÎ
) {

31 
chd»n
[
Ïb–
] = 
Ãw
 
BMTr›Node
Öab–, 
æag
);

34 ià((
	mchd»n
[
Ïb–
].
	mæag
 =ğ0è&& (
æag
 != 0)) {

35 
chd»n
[
Ïb–
].
æag
 = flag;

39  
	mchd»n
[
Ïb–
];

43 
public
 
BMTr›Node
 
g‘Chd
() {

44 
BMTr›Node
 
	mchd
 = 
nuÎ
;

45 
	mi
 = 0; i < 
	mchd»n
.
	mËngth
; i++) {

46 ià(
	mchd»n
[
i
] !ğ
nuÎ
) {

47 
chd
 = 
chd»n
[
i
];

50  
	mchd
;

53 
public
 
£tChdB™
(
by‹
 
chdLab–
) {

54 
	mi
 = 
chdLab–
 / 8;

55 
	mb™m­
[
i
] |ğ1 << (7 - 
chdLab–
 % 8);

58 
public
 
couÁChd»n
() {

59 
	msum
 = 0;

60 
by‹
 
	mx
;

61 
	mn
;

62 
	mi
 = 0; i < 
	mb™m­
.
	mËngth
; i++) {

63 
	mx
 = (
by‹
è(
b™m­
[
i
] & 0x000000ff);

64 
	mn
 = 0;

65 
	mx
 != 0) {

66 ++
n
;

67 
	mx
 &ğ(
x
 - 1);

69 
	msum
 +ğ
n
;

71  
	msum
;

74 @
Ov”ride


75 
public
 
SŒšg
 
toSŒšg
() {

76  "" + ()
	mÏb–
 + "\t" + 
	mSŒšg
.
v®ueOf
(
æag
);

87 
´iv©e
 
BMTr›Node
 
	$bud
(
SŒšg
 
noWdÿrds
) {

88 
BMTr›Node
 
roÙ
 = 
Ãw
 
	`BMTr›Node
((
by‹
)' ', (byte)0);

90 
SŒšg
 [] 
™ems
 = 
noWdÿrds
.
	`¥l™
("[\r\n]{1,}");

91 
j
 = 0;

92 
SŒšg
 
™em
 : 
™ems
) {

93 
Sy¡em
.
out
.
	`´šn
("™em: " + 
j
 + " " + 
™em
);

94 
j
++;

95 
by‹
 [] 
t
 = 
™em
.
	`g‘By‹s
();

96 
BMTr›Node
 
cu¼
 = 
roÙ
;

97 
BMTr›Node
 
Ãxt
 = 
nuÎ
;

99 
i
 = 1; i < 
t
.
Ëngth
; i++) {

100 ià(
i
 !ğ(
t
.
Ëngth
 - 1)) {

101 
Ãxt
 = 
cu¼
.
	`addChd
(
t
[
i
], (
by‹
)0);

103 ià(
t
[0] =ğ(
by‹
)'-') {

104 
Ãxt
 = 
cu¼
.
	`addChd
(
t
[
i
], (
by‹
)-1);

106 
Ãxt
 = 
cu¼
.
	`addChd
(
t
[
i
], (
by‹
)1);

109 
cu¼
.
	`£tChdB™
(
t
[
i
]);

110 
cu¼
 = 
Ãxt
;

111 
Sy¡em
.
out
.
	`´šn
("" + 
cu¼
);

114  
roÙ
;

115 
	}
}

117 
public
 
	gby‹
 [] 
	$Œav”£AndSave
(
SŒšg
 
noWdÿrds
) {

118 
BMTr›Node
 
roÙ
 = 
	`bud
(
noWdÿrds
);

119 
BMTr›Node
 
cu¼
 = 
roÙ
;

120 
BMTr›Node
 
Ãxt
 = 
nuÎ
;

121 
by‹
 [] 
Œ›Buf
 = 
Ãw
 byte [1024 * 1024 * 2];

122 
by‹
 [] 
nodeInfo
 = 
nuÎ
;

123 
loÿlOff£t
= 0;

124 
§vedNodeNum
 = 0;

128 
»maššgChd»n
 = 0;

129 
ÃxtChdPos
 = 0;

130 
tÙ®SavedL’
 = 0;

131 
cfOff£t
 = 0;

132 
i
 = 0; i < 
roÙ
.
	`couÁChd»n
(); i++) {

133 
cu¼
.
æag
 == 0) {

134 ià(
cu¼
.
§vedPos
 == -1) {

135 
cu¼
.
§vedPos
 +ğ
tÙ®SavedL’
;

136 
cu¼
.
numChd»n
 = cu¼.
	`couÁChd»n
();

137 
nodeInfo
 = 
Ãw
 
by‹
 [1 + 1 + 32 + 4 * 
cu¼
.
	`couÁChd»n
()];

138 
Sy¡em
.
	`¬¿ycİy
(
cu¼
.
Ïb–
, 0, 
nodeInfo
, 0, 1);

139 
Sy¡em
.
	`¬¿ycİy
(
cu¼
.
æag
, 0, 
nodeInfo
, 1, 1);

140 
Sy¡em
.
	`¬¿ycİy
(
cu¼
.
b™m­
, 0, 
nodeInfo
, 2, 32);

141 
tÙ®SavedL’
 +ğ
nodeInfo
.
Ëngth
;

142 
Sy¡em
.
	`¬¿ycİy
(
nodeInfo
, 0, 
Œ›Buf
, 
tÙ®SavedL’
,‚odeInfo.
Ëngth
);

143 
Ãxt
 = 
cu¼
.
	`g‘Chd
();

144 ià(
Ãxt
.
§vedPos
 == -1) {

145 
nodeInfo
 = 
Ãw
 
by‹
[1 + 1 + 32 + 4 * 
Ãxt
.
	`couÁChd»n
()];

146 
Sy¡em
.
	`¬¿ycİy
(
Ãxt
.
Ïb–
, 0, 
nodeInfo
, 0, 1);

147 
Sy¡em
.
	`¬¿ycİy
(
Ãxt
.
æag
, 0, 
nodeInfo
, 1, 1);

148 
Sy¡em
.
	`¬¿ycİy
(
Ãxt
.
b™m­
, 0, 
nodeInfo
, 2, 32);

149 
cfOff£t
 = 
tÙ®SavedL’
 - 
cu¼
.
§vedPos
;

150 
Sy¡em
.
	`¬¿ycİy
(
cfOff£t
, 4, 
Œ›Buf
,

151 
tÙ®SavedL’
 - 
cfOff£t
 + 34 + 4 * (
cu¼
.
	`couÁChd»n
(è- cu¼.
numChd»n
), 4);

152 
cu¼
.
numChd»n
--;

162 
cu¼
 = 
Ãxt
;

165  
nuÎ
;

166 
	}
}

168 
public
 
	$maš
(
SŒšg
[] 
¬gs
) {

169 
Œy
 {

170 
Fe
 
robÙsFe
 =

171 
Ãw
 
	`Fe
("/home/arch/zhongsou/project/spider_common/data/nowildcard-robots.txt");

172 
FeR—d”
 
ä
 = 
Ãw
 
	`FeR—d”
(
robÙsFe
);

173 
Bufã»dR—d”
 
br
 = 
Ãw
 
	`Bufã»dR—d”
(
ä
);

174 
SŒšg
 
lše
 = 
nuÎ
;

175 
SŒšgBud”
 
sb
 = 
Ãw
 
	`SŒšgBud”
();

176 (
lše
 = 
br
.
	`»adLše
()è!ğ
nuÎ
) {

177 
sb
.
	`­³nd
(
lše
);

178 
sb
.
	`­³nd
("\n");

180 
lše
 = 
sb
.
	`toSŒšg
();

181 
Ãw
 
	`BMTr›RobÙs
().
	`bud
(
lše
);

183 } 
	`ÿtch
 (
Exû±iÚ
 
ex
) {

184 
ex
.
	`´štSckT¿û
();

187 
	}
}

	@com/zhongsou/spider/common/url/BasicURLNormalizer.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

21 
impÜt
 
	gjava
.
	gÃt
.
	gURL
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	gÜo
.
	g‹xt
.
	g»gex
.
	gM®fÜmedP©‹ºExû±iÚ
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	gÜo
.
	g‹xt
.
	g»gex
.
	gP”l5Comp”
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	gÜo
.
	g‹xt
.
	g»gex
.
	gP”l5M©ch”
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	gÜo
.
	g‹xt
.
	g»gex
.
	gP”l5P©‹º
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	gÜo
.
	g‹xt
.
	g»gex
.
	gP”l5Sub¡™utiÚ
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	gÜo
.
	g‹xt
.
	g»gex
.
	gUt
;

30 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

31 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

32 
public
 cÏs 
	cBasicURLNÜm®iz”
 
im¶em’ts
 
	mURLNÜm®iz”
 {

33 
public
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
BasicURLNÜm®iz”
.
şass
);

35 
´iv©e
 
P”l5Comp”
 
	mcomp”
 = 
Ãw
 Perl5Compiler();

36 
´iv©e
 
Th»adLoÿl
 
	mm©ch”s
 = 
Ãw
 
	$Th»adLoÿl
() {

37 
´Ùeùed
 
synchrÚized
 
Objeù
 
	`š™ŸlV®ue
() {

38  
Ãw
 
	`P”l5M©ch”
();

41 
´iv©e
 
RuË
 
»ÏtiveP©hRuË
 = 
nuÎ
;

42 
´iv©e
 
RuË
 
ËadšgR–©iveP©hRuË
 = 
nuÎ
;

43 
´iv©e
 
RuË
 
cu¼’tP©hRuË
 = 
nuÎ
;

44 
´iv©e
 
RuË
 
adjaûÁSÏshRuË
 = 
nuÎ
;

46 
´iv©e
 
CÚfigu¿tiÚ
 
cÚf
;

48 
public
 
	$BasicURLNÜm®iz”
() {

49 
Œy
 {

53 
»ÏtiveP©hRuË
 = 
Ãw
 
	`RuË
();

54 
»ÏtiveP©hRuË
.
·‰”n
 = (
P”l5P©‹º
)

55 
comp”
.
	`compe
("(/[^/]*[^/.]{1}[^/]*/\\.\\./)",

56 
P”l5Comp”
.
READ_ONLY_MASK
);

57 
»ÏtiveP©hRuË
.
sub¡™utiÚ
 = 
Ãw
 
	`P”l5Sub¡™utiÚ
("/");

61 
ËadšgR–©iveP©hRuË
 = 
Ãw
 
	`RuË
();

62 
ËadšgR–©iveP©hRuË
.
·‰”n
 = (
P”l5P©‹º
)

63 
comp”
.
	`compe
("^(/\\.\\./)+", 
P”l5Comp”
.
READ_ONLY_MASK
);

64 
ËadšgR–©iveP©hRuË
.
sub¡™utiÚ
 = 
Ãw
 
	`P”l5Sub¡™utiÚ
("/");

68 
cu¼’tP©hRuË
 = 
Ãw
 
	`RuË
();

69 
cu¼’tP©hRuË
.
·‰”n
 = (
P”l5P©‹º
)

70 
comp”
.
	`compe
("(/\\./)", 
P”l5Comp”
.
READ_ONLY_MASK
);

71 
cu¼’tP©hRuË
.
sub¡™utiÚ
 = 
Ãw
 
	`P”l5Sub¡™utiÚ
("/");

75 
adjaûÁSÏshRuË
 = 
Ãw
 
	`RuË
();

76 
adjaûÁSÏshRuË
.
·‰”n
 = (
P”l5P©‹º
)

77 
comp”
.
	`compe
("/{2,}", 
P”l5Comp”
.
READ_ONLY_MASK
);

78 
adjaûÁSÏshRuË
.
sub¡™utiÚ
 = 
Ãw
 
	`P”l5Sub¡™utiÚ
("/");

80 } 
	`ÿtch
 (
M®fÜmedP©‹ºExû±iÚ
 
e
) {

81 
LOG
.
	`”rÜ
("E¼Ü: ", 
e
);

82 
throw
 
Ãw
 
	`RuÁimeExû±iÚ
(
e
);

84 
	}
}

86 
public
 
SŒšg
 
	$nÜm®ize
(
SŒšg
 
u¾SŒšg
, SŒšg 
scİe
)

87 
throws
 
M®fÜmedURLExû±iÚ
 {

88 ià("".
	`equ®s
(
u¾SŒšg
))

89  
u¾SŒšg
;

91 
u¾SŒšg
 = u¾SŒšg.
	`Œim
();

93 
URL
 
u¾
 = 
Ãw
 
	`URL
(
u¾SŒšg
);

95 
SŒšg
 
´ÙocŞ
 = 
u¾
.
	`g‘PrÙocŞ
();

96 
SŒšg
 
ho¡
 = 
u¾
.
	`g‘Ho¡
();

97 
pÜt
 = 
u¾
.
	`g‘PÜt
();

98 
SŒšg
 
fe
 = 
u¾
.
	`g‘Fe
();

100 
boŞ—n
 
chªged
 = 
çl£
;

102 ià(!
u¾SŒšg
.
	`¡¬tsW™h
(
´ÙocŞ
))

103 
chªged
 = 
Œue
;

105 ià("h‰p".
	`equ®s
(
´ÙocŞ
) || "ftp".equals(protocol)) {

107 ià(
ho¡
 !ğ
nuÎ
) {

108 
SŒšg
 
ÃwHo¡
 = 
ho¡
.
	`toLow”Ca£
();

109 ià(!
ho¡
.
	`equ®s
(
ÃwHo¡
)) {

110 
ho¡
 = 
ÃwHo¡
;

111 
chªged
 = 
Œue
;

115 ià(
pÜt
 =ğ
u¾
.
	`g‘DeçuÉPÜt
()) {

116 
pÜt
 = -1;

117 
chªged
 = 
Œue
;

120 ià(
fe
 =ğ
nuÎ
 || "".
	`equ®s
(file)) {

121 
fe
 = "/";

122 
chªged
 = 
Œue
;

125 ià(
u¾
.
	`g‘Ref
(è!ğ
nuÎ
) {

126 
chªged
 = 
Œue
;

130 
SŒšg
 
fe2
 = 
	`sub¡™u‹UÂeûs§ryR–©iveP©hs
(
fe
);

132 ià(!
fe
.
	`equ®s
(
fe2
)) {

133 
chªged
 = 
Œue
;

134 
fe
 = 
fe2
;

139 ià(
chªged
)

140 
u¾SŒšg
 = 
Ãw
 
	`URL
(
´ÙocŞ
, 
ho¡
, 
pÜt
, 
fe
).
	`toSŒšg
();

142  
u¾SŒšg
;

143 
	}
}

145 
´iv©e
 
SŒšg
 
	$sub¡™u‹UÂeûs§ryR–©iveP©hs
(
SŒšg
 
fe
) {

146 
SŒšg
 
feWÜkCİy
 = 
fe
;

147 
ŞdL’
 = 
fe
.
	`Ëngth
();

148 
ÃwL’
 = 
ŞdL’
 - 1;

166 
P”l5M©ch”
 
m©ch”
 = (P”l5M©ch”)
m©ch”s
.
	`g‘
();

168 
ŞdL’
 !ğ
ÃwL’
) {

170 
ŞdL’
 = 
feWÜkCİy
.
	`Ëngth
();

171 
feWÜkCİy
 = 
Ut
.
sub¡™u‹


172 (
m©ch”
, 
»ÏtiveP©hRuË
.
·‰”n
,

173 
»ÏtiveP©hRuË
.
sub¡™utiÚ
, 
feWÜkCİy
, 1);

176 
feWÜkCİy
 = 
Ut
.
sub¡™u‹


177 (
m©ch”
, 
ËadšgR–©iveP©hRuË
.
·‰”n
,

178 
ËadšgR–©iveP©hRuË
.
sub¡™utiÚ
, 
feWÜkCİy
, 1);

181 
feWÜkCİy
 = 
Ut
.
sub¡™u‹


182 (
m©ch”
, 
cu¼’tP©hRuË
.
·‰”n
,

183 
cu¼’tP©hRuË
.
sub¡™utiÚ
, 
feWÜkCİy
, 1);

187 
feWÜkCİy
 = 
Ut
.
sub¡™u‹


188 (
m©ch”
, 
adjaûÁSÏshRuË
.
·‰”n
,

189 
adjaûÁSÏshRuË
.
sub¡™utiÚ
, 
feWÜkCİy
, 1);

191 
ÃwL’
 = 
feWÜkCİy
.
	`Ëngth
();

194  
feWÜkCİy
;

195 
	}
}

202 
´iv©e
 şas 
	cRuË
 {

203 
public
 
P”l5P©‹º
 
	g·‰”n
;

204 
public
 
P”l5Sub¡™utiÚ
 
	gsub¡™utiÚ
;

208 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

209 
this
.
cÚf
 = conf;

210 
	}
}

212 
public
 
CÚfigu¿tiÚ
 
	$g‘CÚf
() {

213  
this
.
cÚf
;

214 
	}
}

	@com/zhongsou/spider/common/url/DomainBlacklistURLFilter.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

19 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

20 
impÜt
 
	gjava
.
	gio
.
	gFeR—d”
;

21 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

22 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

23 
impÜt
 
	gjava
.
	gio
.
	gSŒšgR—d”
;

24 
impÜt
 
	gjava
.
	gut
.
	gLškedHashS‘
;

25 
impÜt
 
	gjava
.
	gut
.
	gM­
;

26 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gÏng
.
	gSŒšgUts
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

30 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

31 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gURLUt
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
.
	gDomašSuffix
;

35 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
.
	gPlugšIm¶em’tiÚ
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugšP¬£r
;

65 
public
 cÏs 
	cDomašBÏckli¡URLF‹r


66 
im¶em’ts
 
	mURLF‹r
 {

68 
´iv©e
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
DomašBÏckli¡URLF‹r
.
şass
);

71 
´iv©e
 
SŒšg
 
	m©Œibu‹Fe
 = 
nuÎ
;

72 
´iv©e
 
CÚfigu¿tiÚ
 
	mcÚf
;

73 
´iv©e
 
SŒšg
 
	mdomašFe
 = 
nuÎ
;

74 
´iv©e
 
	mS‘
<
	mSŒšg
> 
	mdomašS‘
 = 
Ãw
 
LškedHashS‘
<
SŒšg
>();

76 
´iv©e
 
	$»adCÚfigu¿tiÚ
(
R—d”
 
cÚfigR—d”
)

77 
throws
 
IOExû±iÚ
 {

80 
Bufã»dR—d”
 
»ad”
 = 
Ãw
 
	`Bufã»dR—d”
(
cÚfigR—d”
);

81 
SŒšg
 
lše
 = 
nuÎ
;

82 (
lše
 = 
»ad”
.
	`»adLše
()è!ğ
nuÎ
) {

83 ià(
SŒšgUts
.
	`isNÙBÏnk
(
lše
è&& !lše.
	`¡¬tsW™h
("#")) {

85 
domašS‘
.
	`add
(
SŒšgUts
.
	`low”Ca£
(
lše
.
	`Œim
()));

93 
public
 
	$DomašBÏckli¡URLF‹r
() {

95 
	}
}

104 
public
 
	$DomašBÏckli¡URLF‹r
(
SŒšg
 
domašFe
) {

105 
this
.
domašFe
 = domainFile;

106 
	}
}

111 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

112 
this
.
cÚf
 = conf;

115 
SŒšg
 
¶ugšName
 = "urlfilter-domainblacklist";

117 
PlugšP¬£r
 
¶ugšP¬£r
 = PlugšP¬£r.
	`g‘In¡ªû
();

118 
Plugš
 
¶ugš
 = 
¶ugšP¬£r
.
	`g‘Plugš
(
URLF‹r
.
şass
.
	`g‘Name
());

119 
M­
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
m­
 = 
¶ugš
.
	`g‘Im¶em’tiÚm­
();

121 
M­
.
EÁry
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
’Œy
 : 
m­
.
	`’ŒyS‘
()) {

122 ià(
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
().
	`equ®s
(
DomašBÏckli¡URLF‹r
.
şass
.
	`g‘Name
())) {

123 
©Œibu‹Fe
 = 
’Œy
.
	`g‘V®ue
().
	`g‘A‰ribu‹
("file");

130 ià(
©Œibu‹Fe
 !ğ
nuÎ
 &&‡‰ribu‹Fe.
	`Œim
().
	`equ®s
("")) {

131 
©Œibu‹Fe
 = 
nuÎ
;

134 ià(
©Œibu‹Fe
 !ğ
nuÎ
) {

135 ià(
LOG
.
	`isInfoEÇbËd
()) {

136 
LOG
.
	`šfo
("A‰ribu‹ \"fe\" i defšed fÜ…lugš " + 
¶ugšName


137 + "‡ " + 
©Œibu‹Fe
);

141 ià(
LOG
.
	`isW¬nEÇbËd
()) {

142 
LOG
.
	`w¬n
("Attribute \"file\" is‚ot defined in…lugin.xml for…lugin "

143 + 
¶ugšName
);

148 
SŒšg
 
fe
 = 
cÚf
.
	`g‘
("urlfilter.domainblacklist.file");

149 
SŒšg
 
¡ršgRuËs
 = 
cÚf
.
	`g‘
("urlfilter.domainblacklist.rules");

150 ià(
domašFe
 !ğ
nuÎ
) {

151 
fe
 = 
domašFe
;

153 ià(
©Œibu‹Fe
 !ğ
nuÎ
) {

154 
fe
 = 
©Œibu‹Fe
;

156 
R—d”
 
»ad”
 = 
nuÎ
;

157 ià(
¡ršgRuËs
 !ğ
nuÎ
) {

158 
»ad”
 = 
Ãw
 
	`SŒšgR—d”
(
¡ršgRuËs
);

160 
»ad”
 = 
cÚf
.
	`g‘CÚfResourûAsR—d”
(
fe
);

162 
Œy
 {

163 ià(
»ad”
 =ğ
nuÎ
) {

164 
»ad”
 = 
Ãw
 
	`FeR—d”
(
fe
);

166 
	`»adCÚfigu¿tiÚ
(
»ad”
);

168 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

169 
LOG
.
	`”rÜ
(
Üg
.
­ache
.
hadoİ
.
ut
.
SŒšgUts
.
	`¡ršgifyExû±iÚ
(
e
));

171 
	}
}

173 
public
 
CÚfigu¿tiÚ
 
	$g‘CÚf
() {

174  
this
.
cÚf
;

175 
	}
}

177 
public
 
SŒšg
 
	$f‹r
(
SŒšg
 
u¾
) {

178 
Œy
 {

181 
SŒšg
 
domaš
 = 
URLUt
.
	`g‘DomašName
(
u¾
).
	`toLow”Ca£
().
	`Œim
();

182 
SŒšg
 
ho¡
 = 
URLUt
.
	`g‘Ho¡
(
u¾
);

183 
SŒšg
 
suffix
 = 
nuÎ
;

184 
DomašSuffix
 
domašSuffix
 = 
URLUt
.
	`g‘DomašSuffix
(
u¾
);

185 ià(
domašSuffix
 !ğ
nuÎ
) {

186 
suffix
 = 
domašSuffix
.
	`g‘Domaš
();

189 ià(
domašS‘
.
	`cÚšs
(
suffix
è|| domašS‘.cÚšs(
domaš
)

190 || 
domašS‘
.
	`cÚšs
(
ho¡
)) {

192  
nuÎ
;

196  
u¾
;

198 
	`ÿtch
 (
Exû±iÚ
 
e
) {

201 
LOG
.
	`”rÜ
("Could‚Ù‡µly f‹¸Ú u¾: " + 
u¾
 + "\n"

202 + 
Üg
.
­ache
.
hadoİ
.
ut
.
SŒšgUts
.
	`¡ršgifyExû±iÚ
(
e
));

203  
nuÎ
;

205 
	}
}

	@com/zhongsou/spider/common/url/DomainURLFilter.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

19 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

20 
impÜt
 
	gjava
.
	gio
.
	gFeR—d”
;

21 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

22 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

23 
impÜt
 
	gjava
.
	gio
.
	gSŒšgR—d”
;

24 
impÜt
 
	gjava
.
	gut
.
	gLškedHashS‘
;

25 
impÜt
 
	gjava
.
	gut
.
	gM­
;

26 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gÏng
.
	gSŒšgUts
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

30 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

31 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gURLUt
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
.
	gDomašSuffix
;

35 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
.
	gPlugšIm¶em’tiÚ
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugšP¬£r
;

78 
public
 cÏs 
	cDomašURLF‹r
 
im¶em’ts
 
	mURLF‹r
 {

80 
´iv©e
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
DomašURLF‹r
.
şass
);

83 
´iv©e
 
SŒšg
 
	m©Œibu‹Fe
 = 
nuÎ
;

84 
´iv©e
 
CÚfigu¿tiÚ
 
	mcÚf
;

85 
´iv©e
 
SŒšg
 
	mdomašFe
 = 
nuÎ
;

86 
´iv©e
 
	mS‘
<
	mSŒšg
> 
	mdomašS‘
 = 
Ãw
 
LškedHashS‘
<
SŒšg
>();

88 
´iv©e
 
	$»adCÚfigu¿tiÚ
(
R—d”
 
cÚfigR—d”
è
throws
 
IOExû±iÚ
 {

91 
Bufã»dR—d”
 
»ad”
 = 
Ãw
 
	`Bufã»dR—d”
(
cÚfigR—d”
);

92 
SŒšg
 
lše
 = 
nuÎ
;

93 (
lše
 = 
»ad”
.
	`»adLše
()è!ğ
nuÎ
) {

94 ià(
SŒšgUts
.
	`isNÙBÏnk
(
lše
è&& !lše.
	`¡¬tsW™h
("#")) {

96 
domašS‘
.
	`add
(
SŒšgUts
.
	`low”Ca£
(
lše
.
	`Œim
()));

104 
public
 
	$DomašURLF‹r
() {

106 
	}
}

116 
public
 
	$DomašURLF‹r
(
SŒšg
 
domašFe
) {

117 
this
.
domašFe
 = domainFile;

118 
	}
}

123 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

124 
this
.
cÚf
 = conf;

127 
SŒšg
 
¶ugšName
 = "urlfilter-domain";

129 
PlugšP¬£r
 
¶ugšP¬£r
 = PlugšP¬£r.
	`g‘In¡ªû
();

130 
Plugš
 
¶ugš
 = 
¶ugšP¬£r
.
	`g‘Plugš
(
URLF‹r
.
şass
.
	`g‘Name
());

131 
M­
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
m­
 = 
¶ugš
.
	`g‘Im¶em’tiÚm­
();

133 
M­
.
EÁry
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
’Œy
 : 
m­
.
	`’ŒyS‘
()) {

134 ià(
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
().
	`equ®s
(
DomašURLF‹r
.
şass
.
	`g‘Name
())) {

135 
©Œibu‹Fe
 = 
’Œy
.
	`g‘V®ue
().
	`g‘A‰ribu‹
("file");

142 ià(
©Œibu‹Fe
 !ğ
nuÎ
 &&‡‰ribu‹Fe.
	`Œim
().
	`equ®s
("")) {

143 
©Œibu‹Fe
 = 
nuÎ
;

146 ià(
©Œibu‹Fe
 !ğ
nuÎ
) {

147 ià(
LOG
.
	`isInfoEÇbËd
()) {

148 
LOG
.
	`šfo
("A‰ribu‹ \"fe\" i defšed fÜ…lugš " + 
¶ugšName
 + "‡ " + 
©Œibu‹Fe
);

151 ià(
LOG
.
	`isW¬nEÇbËd
()) {

152 
LOG
.
	`w¬n
("A‰ribu‹ \"fe\" i nÙ defšed iÀ¶ugš.xmÈfÜ…lugš " + 
¶ugšName
);

157 
SŒšg
 
fe
 = 
cÚf
.
	`g‘
("urlfilter.domain.file");

158 
SŒšg
 
¡ršgRuËs
 = 
cÚf
.
	`g‘
("urlfilter.domain.rules");

159 ià(
domašFe
 !ğ
nuÎ
) {

160 
fe
 = 
domašFe
;

161 } ià(
©Œibu‹Fe
 !ğ
nuÎ
) {

162 
fe
 = 
©Œibu‹Fe
;

164 
R—d”
 
»ad”
 = 
nuÎ
;

165 ià(
¡ršgRuËs
 !ğ
nuÎ
) {

166 
»ad”
 = 
Ãw
 
	`SŒšgR—d”
(
¡ršgRuËs
);

168 
»ad”
 = 
cÚf
.
	`g‘CÚfResourûAsR—d”
(
fe
);

170 
Œy
 {

171 ià(
»ad”
 =ğ
nuÎ
) {

172 
»ad”
 = 
Ãw
 
	`FeR—d”
(
fe
);

174 
	`»adCÚfigu¿tiÚ
(
»ad”
);

175 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

176 
LOG
.
	`”rÜ
(
Üg
.
­ache
.
hadoİ
.
ut
.
SŒšgUts
.
	`¡ršgifyExû±iÚ
(
e
));

178 
	}
}

180 
public
 
CÚfigu¿tiÚ
 
	$g‘CÚf
() {

181  
this
.
cÚf
;

182 
	}
}

184 
public
 
SŒšg
 
	$f‹r
(
SŒšg
 
u¾
) {

186 
Œy
 {

191 
SŒšg
 
domaš
 = 
URLUt
.
	`g‘DomašName
(
u¾
).
	`toLow”Ca£
().
	`Œim
();

192 
SŒšg
 
ho¡
 = 
URLUt
.
	`g‘Ho¡
(
u¾
);

193 
SŒšg
 
suffix
 = 
nuÎ
;

194 
DomašSuffix
 
domašSuffix
 = 
URLUt
.
	`g‘DomašSuffix
(
u¾
);

195 ià(
domašSuffix
 !ğ
nuÎ
) {

196 
suffix
 = 
domašSuffix
.
	`g‘Domaš
();

199 ià(
domašS‘
.
	`cÚšs
(
suffix
è|| domašS‘.cÚšs(
domaš
è|| domašS‘.cÚšs(
ho¡
)) {

200  
u¾
;

204  
nuÎ
;

205 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

208 
LOG
.
	`”rÜ
("Could‚Ù‡µly f‹¸Ú u¾: " + 
u¾
 + "\n" + 
Üg
.
­ache
.
hadoİ
.
ut
.
SŒšgUts
.
	`¡ršgifyExû±iÚ
(
e
));

209  
nuÎ
;

211 
	}
}

	@com/zhongsou/spider/common/url/PassURLNormalizer.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

31 
public
 cÏs 
	cPassURLNÜm®iz”
 
im¶em’ts
 
	mURLNÜm®iz”
 {

33 
´iv©e
 
CÚfigu¿tiÚ
 
	mcÚf
;

35 
public
 
SŒšg
 
	$nÜm®ize
(
SŒšg
 
u¾SŒšg
, SŒšg 
scİe
è
throws
 
M®fÜmedURLExû±iÚ
 {

36  
u¾SŒšg
;

39 
public
 
CÚfigu¿tiÚ
 
	$g‘CÚf
() {

40  
cÚf
;

41 
	}
}

43 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

44 
this
.
cÚf
 = conf;

45 
	}
}

	@com/zhongsou/spider/common/url/PrefixRobotsProtocol.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

3 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

4 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

5 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

7 
impÜt
 
	gcom
.
	gsun
.
	gtoŞs
.
	gjavac
.
	gut
.
	gPaœ
;

9 
public
 cÏs 
	cP»fixRobÙsPrÙocŞ
 
ex‹nds
 
	mRobÙsPrÙocŞ
 {

11 
boŞ—n
 
	mcÚšsWdC¬d
;

13 
	mLi¡
<
	mSŒšg
> 
	m´efixLi¡
 = 
nuÎ
;

14 
	mLi¡
<
	mPaœ
<
	mBoŞ—n
, 
	mSŒšg
>> 
	mwdC¬dLi¡
 = 
nuÎ
;

16 @
Ov”ride


17 
public
 
boŞ—n
 
	$checkURL
(
SŒšg
 
·th
) {

19 ià(
´efixLi¡
 !ğ
nuÎ
) {

20 
SŒšg
 
t
 : 
´efixLi¡
) {

22 
boŞ—n
 
´efixm
 = 
Œue
;

23 
i
 = 1; i < 
t
.
	`Ëngth
(); i++) {

24 ià(
i
-1 >ğ
·th
.
	`Ëngth
()) {

25 
´efixm
 = 
Œue
;

28 ià(
·th
.
	`ch¬At
(
i
 - 1è=ğ
t
.charAt(i)) {

31 
´efixm
 = 
çl£
;

36 ià(
´efixm
) {

38 ià(
t
.
	`ch¬At
(0) == '+') {

43  
çl£
;

51 ià(
this
.
wdC¬dLi¡
 !ğ
nuÎ
) {

52 
Paœ
<
BoŞ—n
, 
SŒšg
> 
p
 : 
this
.
wdC¬dLi¡
) {

53 
boŞ—n
 
®low
 = 
p
.
f¡
;

54 
boŞ—n
 
m©ch
 = 
	`m©chWdC¬d
(
·th
, 
p
.
¢d
);

55 ià(
m©ch
) {

56 ià(!
®low
) {

57  
çl£
;

58 } ià(
®low
) {

59  
Œue
;

69  
Œue
;

73 @
Ov”ride


74 
public
 
boŞ—n
 
	$š™
(
SŒšg
[] 
¡r
) {

77 
SŒšg
 
s
 : 
¡r
) {

79 ià(
s
.
	`šdexOf
("*"è=ğs.
	`Ëngth
(è- 1 || s.
	`’dsW™h
("$")) {

80 
s
 = s.
	`sub¡ršg
(0, s.
	`Ëngth
() - 1);

82 ià(
s
.
	`cÚšs
("*")) {

83 ià(
wdC¬dLi¡
 =ğ
nuÎ
) {

84 
wdC¬dLi¡
 = 
Ãw
 
LškedLi¡
<
Paœ
<
BoŞ—n
, 
SŒšg
>>();

86 ià(
s
.
	`ch¬At
(0) == '-') {

87 
wdC¬dLi¡
.
	`add
(
Ãw
 
	`Paœ
(
çl£
, 
s
.
	`sub¡ršg
(1)));

89 
wdC¬dLi¡
.
	`add
(
Ãw
 
	`Paœ
(
Œue
, 
s
.
	`sub¡ršg
(1)));

95 ià(
this
.
´efixLi¡
 =ğ
nuÎ
) {

96 
this
.
´efixLi¡
 = 
Ãw
 
A¼ayLi¡
<
SŒšg
>(
¡r
.
Ëngth
);

98 
´efixLi¡
.
	`add
(
s
);

101  
Œue
;

102 
	}
}

	@com/zhongsou/spider/common/url/PrefixURLFilter.java

20 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

22 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

23 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

24 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—mR—d”
;

25 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

26 
impÜt
 
	gjava
.
	gio
.
	gSŒšgR—d”
;

27 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

28 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

29 
impÜt
 
	gjava
.
	gut
.
	gM­
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

32 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

33 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

35 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gP»fixSŒšgM©ch”
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gTr›SŒšgM©ch”
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
;

38 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
.
	gPlugšIm¶em’tiÚ
;

39 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugšP¬£r
;

51 
public
 cÏs 
	cP»fixURLF‹r
 
im¶em’ts
 
	mURLF‹r
 {

53 
´iv©e
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
P»fixURLF‹r
.
şass
);

56 
´iv©e
 
SŒšg
 
	m©Œibu‹Fe
 = 
nuÎ
;

58 
´iv©e
 
Tr›SŒšgM©ch”
 
	mŒ›
;

60 
´iv©e
 
CÚfigu¿tiÚ
 
	mcÚf
;

62 
public
 
	$P»fixURLF‹r
(è
throws
 
IOExû±iÚ
 {

66 
public
 
	$P»fixURLF‹r
(
SŒšg
 
¡ršgRuËs
è
throws
 
IOExû±iÚ
 {

67 
Œ›
 = 
	`»adCÚfigu¿tiÚ
(
Ãw
 
	`SŒšgR—d”
(
¡ršgRuËs
));

68 
	}
}

70 
public
 
SŒšg
 
	$f‹r
(
SŒšg
 
u¾
) {

71 ià(
Œ›
.
	`shÜ‹¡M©ch
(
u¾
è=ğ
nuÎ
)

72  
nuÎ
;

74  
u¾
;

75 
	}
}

77 
´iv©e
 
Tr›SŒšgM©ch”
 
	$»adCÚfigu¿tiÚ
(
R—d”
 
»ad”
è
throws
 
IOExû±iÚ
 {

79 
Bufã»dR—d”
 
š
 = 
Ãw
 
	`Bufã»dR—d”
(
»ad”
);

80 
Li¡
 
u¾´efixes
 = 
Ãw
 
	`A¼ayLi¡
();

81 
SŒšg
 
lše
;

83 (
lše
 = 
š
.
	`»adLše
()è!ğ
nuÎ
) {

84 ià(
lše
.
	`Ëngth
() == 0)

87 
fœ¡
 = 
lše
.
	`ch¬At
(0);

88 
fœ¡
) {

94 
u¾´efixes
.
	`add
(
lše
);

98  
Ãw
 
	`P»fixSŒšgM©ch”
(
u¾´efixes
);

99 
	}
}

101 
public
 
	$maš
(
SŒšg
 
¬gs
[]è
throws
 
IOExû±iÚ
 {

103 
P»fixURLF‹r
 
f‹r
;

104 ià(
¬gs
.
Ëngth
 >= 1)

105 
f‹r
 = 
Ãw
 
	`P»fixURLF‹r
(
¬gs
[0]);

107 
f‹r
 = 
Ãw
 
	`P»fixURLF‹r
();

109 
Bufã»dR—d”
 
š
 = 
Ãw
 
	`Bufã»dR—d”
Òew 
	`IÅutSŒ—mR—d”
(
Sy¡em
.in));

110 
SŒšg
 
lše
;

111 (
lše
 = 
š
.
	`»adLše
()è!ğ
nuÎ
) {

112 
SŒšg
 
out
 = 
f‹r
.
	`f‹r
(
lše
);

113 ià(
out
 !ğ
nuÎ
) {

114 
Sy¡em
.
out
.
	`´šn
(out);

117 
	}
}

119 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

120 
this
.
cÚf
 = conf;

122 
SŒšg
 
¶ugšName
 = "urlfilter-prefix";

124 
PlugšP¬£r
 
¶ugšP¬£r
 = PlugšP¬£r.
	`g‘In¡ªû
();

125 
Plugš
 
¶ugš
 = 
¶ugšP¬£r
.
	`g‘Plugš
(
URLF‹r
.
şass
.
	`g‘Name
());

126 
M­
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
m­
 = 
¶ugš
.
	`g‘Im¶em’tiÚm­
();

128 
M­
.
EÁry
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
’Œy
 : 
m­
.
	`’ŒyS‘
()) {

129 ià(
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
().
	`equ®s
(
P»fixURLF‹r
.
şass
.
	`g‘Name
())) {

130 
©Œibu‹Fe
 = 
’Œy
.
	`g‘V®ue
().
	`g‘A‰ribu‹
("file");

136 ià(
©Œibu‹Fe
 !ğ
nuÎ
 &&‡‰ribu‹Fe.
	`Œim
().
	`equ®s
(""))

137 
©Œibu‹Fe
 = 
nuÎ
;

138 ià(
©Œibu‹Fe
 !ğ
nuÎ
) {

139 ià(
LOG
.
	`isInfoEÇbËd
()) {

140 
LOG
.
	`šfo
("A‰ribu‹ \"fe\" i defšed fÜ…lugš " + 
¶ugšName
 + "‡ " + 
©Œibu‹Fe
);

149 
SŒšg
 
fe
 = 
cÚf
.
	`g‘
("urlfilter.prefix.file");

150 
SŒšg
 
¡ršgRuËs
 = 
cÚf
.
	`g‘
("urlfilter.prefix.rules");

152 ià(
©Œibu‹Fe
 !ğ
nuÎ
)

153 
fe
 = 
©Œibu‹Fe
;

154 
R—d”
 
»ad”
 = 
nuÎ
;

155 ià(
¡ršgRuËs
 !ğ
nuÎ
) {

156 
»ad”
 = 
Ãw
 
	`SŒšgR—d”
(
¡ršgRuËs
);

158 
»ad”
 = 
cÚf
.
	`g‘CÚfResourûAsR—d”
(
fe
);

161 ià(
»ad”
 =ğ
nuÎ
) {

162 
Œ›
 = 
Ãw
 
	`P»fixSŒšgM©ch”
Òew 
SŒšg
[0]);

164 
Œy
 {

165 
Œ›
 = 
	`»adCÚfigu¿tiÚ
(
»ad”
);

166 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

167 ià(
LOG
.
	`isE¼ÜEÇbËd
()) {

168 
LOG
.
	`”rÜ
(
e
.
	`g‘Mes§ge
());

171 
throw
 
Ãw
 
	`RuÁimeExû±iÚ
(
e
.
	`g‘Mes§ge
(),ƒ);

174 
	}
}

176 
public
 
CÚfigu¿tiÚ
 
	$g‘CÚf
() {

177  
this
.
cÚf
;

178 
	}
}

	@com/zhongsou/spider/common/url/RegexRule.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

26 
public
 
ab¡¿ù
 cÏs 
	cRegexRuË
 {

28 
´iv©e
 
boŞ—n
 
	msign
;

29 
´iv©e
 
SŒšg
 
	m»gex
;

41 
´Ùeùed
 
	$RegexRuË
(
boŞ—n
 
sign
, 
SŒšg
 
»gex
) {

42 
this
.
sign
 = sign;

43 
this
.
»gex
 =„egex;

52 
´Ùeùed
 
boŞ—n
 
	$acû±
(è{  
sign
; 
	}
}

60 
´Ùeùed
 
ab¡¿ù
 
boŞ—n
 
m©ch
(
SŒšg
 
u¾
);

	@com/zhongsou/spider/common/url/RegexURLFilter.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

21 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

22 
impÜt
 
	gjava
.
	gio
.
	gSŒšgR—d”
;

23 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹º
;

24 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹ºSyÁaxExû±iÚ
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

28 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gSpid”CÚfigu¿tiÚ
;

35 
public
 cÏs 
	cRegexURLF‹r
 
ex‹nds
 
	mRegexURLF‹rBa£
 {

37 
public
 
fš®
 
SŒšg
 
	mURLFILTER_REGEX_FILE
 = "urlfilter.regex.file";

38 
public
 
fš®
 
SŒšg
 
	mURLFILTER_REGEX_RULES
 = "urlfilter.regex.rules";

40 
public
 
	$RegexURLF‹r
() {

41 
	`su³r
();

44 
public
 
	$RegexURLF‹r
(
SŒšg
 
f’ame
)

45 
throws
 
IOExû±iÚ
, 
P©‹ºSyÁaxExû±iÚ
 {

46 
	`su³r
(
f’ame
);

47 
	}
}

49 
	$RegexURLF‹r
(
R—d”
 
»ad”
)

50 
throws
 
IOExû±iÚ
, 
IÎeg®Argum’tExû±iÚ
 {

51 
	`su³r
(
»ad”
);

52 
	}
}

63 
´Ùeùed
 
R—d”
 
	$g‘RuËsR—d”
(
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

64 
SŒšg
 
¡ršgRuËs
 = 
cÚf
.
	`g‘
(
URLFILTER_REGEX_RULES
);

65 ià(
¡ršgRuËs
 !ğ
nuÎ
) {

66  
Ãw
 
	`SŒšgR—d”
(
¡ršgRuËs
);

68 
SŒšg
 
feRuËs
 = 
cÚf
.
	`g‘
(
URLFILTER_REGEX_FILE
,"regex-urlfilter.txt");

69  
cÚf
.
	`g‘CÚfResourûAsR—d”
(
feRuËs
);

70 
	}
}

73 
´Ùeùed
 
RegexRuË
 
	$ü—‹RuË
(
boŞ—n
 
sign
, 
SŒšg
 
»gex
) {

74  
Ãw
 
	`RuË
(
sign
, 
»gex
);

75 
	}
}

82 
public
 
	$maš
(
SŒšg
 
¬gs
[]è
throws
 
IOExû±iÚ
 {

83 
RegexURLF‹r
 
f‹r
 = 
Ãw
 
	`RegexURLF‹r
();

84 
f‹r
.
	`£tCÚf
(
Spid”CÚfigu¿tiÚ
.
	`ü—‹
());

85 
	`maš
(
f‹r
, 
¬gs
);

86 
	}
}

89 
´iv©e
 cÏs 
	cRuË
 
ex‹nds
 
	gRegexRuË
 {

91 
´iv©e
 
P©‹º
 
	g·‰”n
;

93 
RuË
(
boŞ—n
 
sign
, 
SŒšg
 
»gex
) {

94 
su³r
(
sign
, 
»gex
);

95 
	g·‰”n
 = 
P©‹º
.
compe
(
»gex
);

98 
´Ùeùed
 
boŞ—n
 
m©ch
(
SŒšg
 
u¾
) {

99  
	g·‰”n
.
m©ch”
(
u¾
).
fšd
();

	@com/zhongsou/spider/common/url/RegexURLFilterBase.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

21 
impÜt
 
	gjava
.
	gio
.
	gFe
;

22 
impÜt
 
	gjava
.
	gio
.
	gFeR—d”
;

23 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

24 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—mR—d”
;

25 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

26 
impÜt
 
	gjava
.
	gio
.
	gSŒšgR—d”
;

27 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

28 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿bË
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

32 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

33 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

54 
public
 
ab¡¿ù
 
şass
 
RegexURLF‹rBa£
 
im¶em’ts
 
	gCÚfigu¿bË
, 
	gURLF‹r
 {

57 
´iv©e
 
fš®
 
Logg”
 
	gLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
RegexURLF‹rBa£
.
şass
);

60 
´iv©e
 
	gRegexRuË
[] 
	gruËs
;

63 
´iv©e
 
CÚfigu¿tiÚ
 
	gcÚf
;

69 
public
 
RegexURLF‹rBa£
() { }

75 
public
 
RegexURLF‹rBa£
(
Fe
 
f’ame
)

76 
throws
 
	gIOExû±iÚ
, 
	gIÎeg®Argum’tExû±iÚ
 {

77 
this
(
Ãw
 
FeR—d”
(
f’ame
));

86 
public
 
RegexURLF‹rBa£
(
SŒšg
 
ruËs
è
throws
 
	gIOExû±iÚ
,

87 
	gIÎeg®Argum’tExû±iÚ
 {

88 
this
(
Ãw
 
SŒšgR—d”
(
ruËs
));

95 
´Ùeùed
 
RegexURLF‹rBa£
(
R—d”
 
»ad”
)

96 
throws
 
	gIOExû±iÚ
, 
	gIÎeg®Argum’tExû±iÚ
 {

97 
	gruËs
 = 
»adRuËs
(
»ad”
);

108 
´Ùeùed
 
ab¡¿ù
 
RegexRuË
 
ü—‹RuË
(
boŞ—n
 
sign
, 
SŒšg
 
»gex
);

116 
´Ùeùed
 
ab¡¿ù
 
R—d”
 
g‘RuËsR—d”
(
CÚfigu¿tiÚ
 
cÚf
è
throws
 
	gIOExû±iÚ
;

124 
public
 
synchrÚized
 
SŒšg
 
f‹r
(SŒšg 
u¾
) {

125 
	gi
=0; i<
	gruËs
.
	gËngth
; i++) {

126 ià(
	gruËs
[
i
].
m©ch
(
u¾
)) {

127  
	gruËs
[
i
].
acû±
(è? 
	gu¾
 : 
nuÎ
;

130  
	gnuÎ
;

142 
public
 
£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

143 
	gthis
.
	gcÚf
 = 
cÚf
;

144 
R—d”
 
	g»ad”
 = 
nuÎ
;

145 
	gŒy
 {

146 
	g»ad”
 = 
g‘RuËsR—d”
(
cÚf
);

147 } 
ÿtch
 (
Exû±iÚ
 
e
) {

148 ià(
	gLOG
.
isE¼ÜEÇbËd
()è{ LOG.
”rÜ
(
e
.
g‘Mes§ge
()); }

149 
throw
 
Ãw
 
RuÁimeExû±iÚ
(
e
.
g‘Mes§ge
(),ƒ);

151 
	gŒy
 {

152 
	gruËs
 = 
»adRuËs
(
»ad”
);

153 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

154 ià(
	gLOG
.
isE¼ÜEÇbËd
()è{ LOG.
”rÜ
(
e
.
g‘Mes§ge
()); }

155 
throw
 
Ãw
 
RuÁimeExû±iÚ
(
e
.
g‘Mes§ge
(),ƒ);

159 
public
 
CÚfigu¿tiÚ
 
g‘CÚf
() {

160  
	gthis
.
	gcÚf
;

173 
´iv©e
 
	gRegexRuË
[] 
»adRuËs
(
R—d”
 
»ad”
)

174 
throws
 
	gIOExû±iÚ
, 
	gIÎeg®Argum’tExû±iÚ
 {

176 
Bufã»dR—d”
 
	gš
 = 
Ãw
 Bufã»dR—d”(
»ad”
);

177 
Li¡
 
	gruËs
 = 
Ãw
 
A¼ayLi¡
();

178 
SŒšg
 
	glše
;

180 (
	glše
=
š
.
»adLše
())!=
nuÎ
) {

181 ià(
lše
.
Ëngth
() == 0) {

184 
	gfœ¡
=
lše
.
ch¬At
(0);

185 
boŞ—n
 
	gsign
=
çl£
;

186 
	gfœ¡
) {

188 
sign
=
Œue
;

191 
sign
=
çl£
;

196 
throw
 
Ãw
 
IOExû±iÚ
("Inv®id fœ¡ ch¬aù”: "+
lše
);

199 
SŒšg
 
	g»gex
 = 
lše
.
sub¡ršg
(1);

200 ià(
	gLOG
.
isT¿ûEÇbËd
()è{ LOG.
Œaû
("Addšg„uË [" + 
»gex
 + "]"); }

201 
RegexRuË
 
	gruË
 = 
ü—‹RuË
(
sign
, 
»gex
);

202 
	gruËs
.
add
(
ruË
);

204  (
	gRegexRuË
[]è
	gruËs
.
toA¼ay
(
Ãw
 
RegexRuË
[
ruËs
.
size
()]);

213 
public
 
maš
(
RegexURLF‹rBa£
 
f‹r
, 
SŒšg
 
¬gs
[])

214 
throws
 
	gIOExû±iÚ
, 
	gIÎeg®Argum’tExû±iÚ
 {

216 
Bufã»dR—d”
 
	gš
 = 
Ãw
 Bufã»dR—d”Òew 
IÅutSŒ—mR—d”
(
Sy¡em
.
š
));

217 
SŒšg
 
	glše
;

218 (
	glše
=
š
.
»adLše
())!=
nuÎ
) {

219 
SŒšg
 
out
 = 
f‹r
.f‹r(
lše
);

220 ià(
	gout
!=
nuÎ
) {

221 
Sy¡em
.
out
.
´št
("+");

222 
	gSy¡em
.
	gout
.
´šn
(
out
);

224 
	gSy¡em
.
	gout
.
´št
("-");

225 
	gSy¡em
.
	gout
.
´šn
(
lše
);

	@com/zhongsou/spider/common/url/RegexURLNormalizer.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gio
.
	gFeR—d”
;

21 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

22 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

23 
impÜt
 
	gjava
.
	gio
.
	gSŒšgR—d”
;

24 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

25 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

26 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

27 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

28 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

29 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

30 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gM©ch”
;

31 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹º
;

32 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹ºSyÁaxExû±iÚ
;

34 
impÜt
 
	gjavax
.
	gxml
.
	g·r£rs
.
	gDocum’tBud”FaùÜy
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

38 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

39 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

40 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gDocum’t
;

41 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gEËm’t
;

42 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gNode
;

43 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gNodeLi¡
;

44 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gText
;

45 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gIÅutSourû
;

47 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gSpid”CÚfigu¿tiÚ
;

63 
public
 cÏs 
	cRegexURLNÜm®iz”
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mURLNÜm®iz”
 {

65 
´iv©e
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
RegexURLNÜm®iz”
.
şass
);

71 
´iv©e
 şas 
	cRuË
 {

72 
public
 
P©‹º
 
	m·‰”n
;

74 
public
 
SŒšg
 
	msub¡™utiÚ
;

77 
´iv©e
 
HashM­
 
	gscİedRuËs
;

79 
´iv©e
 
fš®
 
Li¡
 
	gEMPTY_RULES
 = 
CŞËùiÚs
.
EMPTY_LIST
;

85 
public
 
	$RegexURLNÜm®iz”
() {

86 
	`su³r
(
nuÎ
);

87 
	}
}

89 
public
 
	$RegexURLNÜm®iz”
(
CÚfigu¿tiÚ
 
cÚf
) {

90 
	`su³r
(
cÚf
);

91 
	}
}

97 
public
 
	$RegexURLNÜm®iz”
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
f’ame
)

98 
throws
 
IOExû±iÚ
, 
P©‹ºSyÁaxExû±iÚ
 {

99 
	`su³r
(
cÚf
);

100 
Li¡
 
ruËs
 = 
	`»adCÚfigu¿tiÚFe
(
f’ame
);

101 ià(
ruËs
 !ğ
nuÎ
)

102 
scİedRuËs
.
	`put
(
URLNÜm®iz”s
.
SCOPE_DEFAULT
, 
ruËs
);

103 
	}
}

105 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

106 
su³r
.
	`£tCÚf
(
cÚf
);

107 ià(
cÚf
 =ğ
nuÎ
) ;

109 ià(
this
.
scİedRuËs
 =ğ
nuÎ
) {

110 
SŒšg
 
f’ame
 = 
	`g‘CÚf
().
	`g‘
("urlnormalizer.regex.file");

111 
SŒšg
 
¡ršgRuËs
 = 
	`g‘CÚf
().
	`g‘
("urlnormalizer.regex.rules");

112 
scİedRuËs
 = 
Ãw
 
	`HashM­
();

113 
R—d”
 
»ad”
 = 
nuÎ
;

114 ià(
¡ršgRuËs
 !ğ
nuÎ
) {

115 
»ad”
 = 
Ãw
 
	`SŒšgR—d”
(
¡ršgRuËs
);

117 
»ad”
 = 
	`g‘CÚf
().
	`g‘CÚfResourûAsR—d”
(
f’ame
);

119 
Li¡
 
ruËs
 = 
nuÎ
;

120 ià(
»ad”
 =ğ
nuÎ
) {

121 
LOG
.
	`w¬n
("Can't†oadhe default„ules! ");

122 
ruËs
 = 
EMPTY_RULES
;

124 
Œy
 {

125 
ruËs
 = 
	`»adCÚfigu¿tiÚ
(
»ad”
);

126 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

127 
LOG
.
	`w¬n
("Couldn'ˆ»ad deçuÉ cÚfig: " + 
e
);

128 
ruËs
 = 
EMPTY_RULES
;

131 
scİedRuËs
.
	`put
(
URLNÜm®iz”s
.
SCOPE_DEFAULT
, 
ruËs
);

133 
	}
}

136 
	$£tCÚfigu¿tiÚ
(
R—d”
 
»ad”
, 
SŒšg
 
scİe
) {

137 
Li¡
 
ruËs
 = 
	`»adCÚfigu¿tiÚ
(
»ad”
);

138 
scİedRuËs
.
	`put
(
scİe
, 
ruËs
);

139 
LOG
.
	`debug
("S‘ cÚfig fÜ scİ'" + 
scİe
 + "': " + 
ruËs
.
	`size
() + "„ules.");

140 
	}
}

146 
public
 
synchrÚized
 
SŒšg
 
	$»gexNÜm®ize
(
SŒšg
 
u¾SŒšg
, SŒšg 
scİe
) {

147 
Li¡
 
curRuËs
 = (Li¡)
scİedRuËs
.
	`g‘
(
scİe
);

148 ià(
curRuËs
 =ğ
nuÎ
) {

150 
SŒšg
 
cÚfigFe
 = 
	`g‘CÚf
().
	`g‘
("u¾nÜm®iz”.»gex.fe." + 
scİe
);

151 ià(
cÚfigFe
 !ğ
nuÎ
) {

152 
LOG
.
	`debug
("»sourû fÜ scİ'" + 
scİe
 + "': " + 
cÚfigFe
);

153 ià(
cÚfigFe
 =ğ
nuÎ
) {

154 
LOG
.
	`w¬n
("Cª'ˆlßd„esourû fÜ cÚfig fe: " + 
cÚfigFe
);

156 
Œy
 {

157 
R—d”
 
»ad”
 = 
	`g‘CÚf
().
	`g‘CÚfResourûAsR—d”
(
cÚfigFe
);

158 
curRuËs
 = 
	`»adCÚfigu¿tiÚ
(
»ad”
);

159 
scİedRuËs
.
	`put
(
scİe
, 
curRuËs
);

160 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

161 
LOG
.
	`w¬n
("Couldn'ˆlßd„esourû '" + 
cÚfigFe
 + "': " + 
e
);

165 ià(
curRuËs
 =ğ
EMPTY_RULES
 || curRuË =ğ
nuÎ
) {

166 
LOG
.
	`šfo
("ÿn'ˆfšd„uË fÜ scİ'" + 
scİe
 + "', using default");

167 
scİedRuËs
.
	`put
(
scİe
, 
EMPTY_RULES
);

170 ià(
curRuËs
 =ğ
EMPTY_RULES
 || curRuË =ğ
nuÎ
) {

172 
curRuËs
 = (
Li¡
)
scİedRuËs
.
	`g‘
(
URLNÜm®iz”s
.
SCOPE_DEFAULT
);

174 
I‹¿tÜ
 
i
 = 
curRuËs
.
	`™”©Ü
();

175 
i
.
	`hasNext
()) {

176 
RuË
 
r
 = (RuËè
i
.
	`Ãxt
();

178 
M©ch”
 
m©ch”
 = 
r
.
·‰”n
.
	`m©ch”
(
u¾SŒšg
);

180 
u¾SŒšg
 = 
m©ch”
.
	`»¶aûAÎ
(
r
.
sub¡™utiÚ
);

182  
u¾SŒšg
;

183 
	}
}

185 
public
 
synchrÚized
 
SŒšg
 
	$nÜm®ize
(
SŒšg
 
u¾SŒšg
, SŒšg 
scİe
)

186 
throws
 
M®fÜmedURLExû±iÚ
 {

187  
	`»gexNÜm®ize
(
u¾SŒšg
, 
scİe
);

188 
	}
}

191 
´iv©e
 
Li¡
 
	$»adCÚfigu¿tiÚFe
(
SŒšg
 
f’ame
) {

192 ià(
LOG
.
	`isInfoEÇbËd
()) {

193 
LOG
.
	`šfo
("lßdšg " + 
f’ame
);

195 
Œy
 {

196 
FeR—d”
 
»ad”
 = 
Ãw
 
	`FeR—d”
(
f’ame
);

197  
	`»adCÚfigu¿tiÚ
(
»ad”
);

198 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

199 
LOG
.
	`”rÜ
("E¼Ü†ßdšg„uË äom '" + 
f’ame
 + "': " + 
e
);

200  
EMPTY_RULES
;

202 
	}
}

204 
´iv©e
 
Li¡
 
	$»adCÚfigu¿tiÚ
(
R—d”
 
»ad”
) {

205 
Li¡
 
ruËs
 = 
Ãw
 
	`A¼ayLi¡
();

206 
Œy
 {

209 
Docum’t
 
doc
 = 
Docum’tBud”FaùÜy
.
	`ÃwIn¡ªû
().
	`ÃwDocum’tBud”
()

210 .
	`·r£
(
Ãw
 
	`IÅutSourû
(
»ad”
));

211 
EËm’t
 
roÙ
 = 
doc
.
	`g‘Docum’tEËm’t
();

212 ià((!"»gex-nÜm®ize".
	`equ®s
(
roÙ
.
	`g‘TagName
()))

213 && (
LOG
.
	`isE¼ÜEÇbËd
())) {

214 
LOG
.
	`”rÜ
("bad conf file:op-levelƒlement‚ot <regex-normalize>");

216 
NodeLi¡
 
»gexes
 = 
roÙ
.
	`g‘ChdNodes
();

217 
i
 = 0; i < 
»gexes
.
	`g‘L’gth
(); i++) {

218 
Node
 
»gexNode
 = 
»gexes
.
	`™em
(
i
);

219 ià(!(
»gexNode
 
š¡ªûof
 
EËm’t
))

221 
EËm’t
 
»gex
 = (EËm’tè
»gexNode
;

222 ià((!"»gex".
	`equ®s
(
»gex
.
	`g‘TagName
())è&& (
LOG
.
	`isW¬nEÇbËd
())) {

223 
LOG
.
	`w¬n
("bad conf file:ƒlement‚ot <regex>");

225 
NodeLi¡
 
f›lds
 = 
»gex
.
	`g‘ChdNodes
();

226 
SŒšg
 
·‰”nV®ue
 = 
nuÎ
;

227 
SŒšg
 
subV®ue
 = 
nuÎ
;

228 
j
 = 0; j < 
f›lds
.
	`g‘L’gth
(); j++) {

229 
Node
 
f›ldNode
 = 
f›lds
.
	`™em
(
j
);

230 ià(!(
f›ldNode
 
š¡ªûof
 
EËm’t
))

232 
EËm’t
 
f›ld
 = (EËm’tè
f›ldNode
;

233 ià("·‰”n".
	`equ®s
(
f›ld
.
	`g‘TagName
()è&& f›ld.
	`hasChdNodes
())

234 
·‰”nV®ue
 = ((
Text
è
f›ld
.
	`g‘Fœ¡Chd
()).
	`g‘D©a
();

235 ià("sub¡™utiÚ".
	`equ®s
(
f›ld
.
	`g‘TagName
())

236 && 
f›ld
.
	`hasChdNodes
())

237 
subV®ue
 = ((
Text
è
f›ld
.
	`g‘Fœ¡Chd
()).
	`g‘D©a
();

238 ià(!
f›ld
.
	`hasChdNodes
())

239 
subV®ue
 = "";

241 ià(
·‰”nV®ue
 !ğ
nuÎ
 && 
subV®ue
 !=‚ull) {

242 
RuË
 
ruË
 = 
Ãw
 
	`RuË
();

243 
ruË
.
·‰”n
 = 
P©‹º
.
	`compe
(
·‰”nV®ue
);

244 
ruË
.
sub¡™utiÚ
 = 
subV®ue
;

245 
ruËs
.
	`add
(
ruË
);

248 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

249 ià(
LOG
.
	`isE¼ÜEÇbËd
()) {

250 
LOG
.
	`”rÜ
("”rÜ…¬sšg cÚàfe: " + 
e
);

252  
EMPTY_RULES
;

254 ià(
ruËs
.
	`size
(è=ğ0è 
EMPTY_RULES
;

255  
ruËs
;

256 
	}
}

259 
public
 
	$maš
(
SŒšg
 
¬gs
[]è
throws
 
P©‹ºSyÁaxExû±iÚ
,

260 
IOExû±iÚ
 {

261 
RegexURLNÜm®iz”
 
nÜm®iz”
 = 
Ãw
 
	`RegexURLNÜm®iz”
();

262 
nÜm®iz”
.
	`£tCÚf
(
Spid”CÚfigu¿tiÚ
.
	`ü—‹
());

263 
I‹¿tÜ
 
i
 = ((
Li¡
)
nÜm®iz”
.
scİedRuËs
.
	`g‘
(
URLNÜm®iz”s
.
SCOPE_DEFAULT
)).
	`™”©Ü
();

264 
Sy¡em
.
out
.
	`´šn
("* Rules for 'DEFAULT' scope:");

265 
i
.
	`hasNext
()) {

266 
RuË
 
r
 = (RuËè
i
.
	`Ãxt
();

267 
Sy¡em
.
out
.
	`´št
(" " + 
r
.
·‰”n
.
	`·‰”n
() + " -> ");

268 
Sy¡em
.
out
.
	`´šn
(
r
.
sub¡™utiÚ
);

271 ià(
¬gs
.
Ëngth
 > 1) {

273 
nÜm®iz”
.
	`nÜm®ize
("h‰p://‹¡.com?&j£ssiÚid=3232&&a=#dça", 
¬gs
[1]);

275 ià(
nÜm®iz”
.
scİedRuËs
.
	`size
() > 1) {

276 
I‹¿tÜ
 
™
 = 
nÜm®iz”
.
scİedRuËs
.
	`keyS‘
().
	`™”©Ü
();

277 
™
.
	`hasNext
()) {

278 
SŒšg
 
scİe
 = (SŒšg)
™
.
	`Ãxt
();

279 ià(
URLNÜm®iz”s
.
SCOPE_DEFAULT
.
	`equ®s
(
scİe
)) ;

280 
Sy¡em
.
out
.
	`´šn
("* RuË fÜ '" + 
scİe
 + "' scope:");

281 
i
 = ((
Li¡
)
nÜm®iz”
.
scİedRuËs
.
	`g‘
(
scİe
)).
	`™”©Ü
();

282 
i
.
	`hasNext
()) {

283 
RuË
 
r
 = (RuËè
i
.
	`Ãxt
();

284 
Sy¡em
.
out
.
	`´št
(" " + 
r
.
·‰”n
.
	`·‰”n
() + " -> ");

285 
Sy¡em
.
out
.
	`´šn
(
r
.
sub¡™utiÚ
);

289 ià(
¬gs
.
Ëngth
 > 0) {

290 
Sy¡em
.
out
.
	`´šn
("\n---------- Normalizerest -----------");

291 
SŒšg
 
scİe
 = 
URLNÜm®iz”s
.
SCOPE_DEFAULT
;

292 ià(
¬gs
.
Ëngth
 > 1è
scİe
 =‡rgs[1];

293 
Sy¡em
.
out
.
	`´šn
("Scİe: " + 
scİe
);

294 
Sy¡em
.
out
.
	`´šn
("IÅuˆu¾: '" + 
¬gs
[0] + "'");

296 
Sy¡em
.
out
.
	`´šn
("Ouuˆu¾: '" + 
nÜm®iz”
.
	`nÜm®ize
(
¬gs
[0], 
scİe
) + "'");

298 
Sy¡em
.
	`ex™
(0);

299 
	}
}

	@com/zhongsou/spider/common/url/RobotsFilter.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

3 
impÜt
 
	gjava
.
	gio
.
	gBufã»dIÅutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gFe
;

5 
impÜt
 
	gjava
.
	gio
.
	gFeIÅutSŒ—m
;

6 
impÜt
 
	gjava
.
	gio
.
	gFeNÙFoundExû±iÚ
;

7 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

8 
impÜt
 
	gjava
.
	gio
.
	gRªdomAcûssFe
;

9 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

10 
impÜt
 
	gjava
.
	gÃt
.
	gURL
;

11 
impÜt
 
	gjava
.
	gnio
.
	gBy‹Bufãr
;

12 
impÜt
 
	gjava
.
	gnio
.
	gM­³dBy‹Bufãr
;

13 
impÜt
 
	gjava
.
	gnio
.
	gchªÃls
.
	gFeChªÃl
;

14 
impÜt
 
	gjava
.
	gnio
.
	gchªÃls
.
	gFeChªÃl
.
	gM­Mode
;

15 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

16 
impÜt
 
	gjava
.
	gut
.
	gLškedHashM­
;

17 
impÜt
 
	gjava
.
	gut
.
	gM­
;

18 
impÜt
 
	gjava
.
	gut
.
	gM­
.
	gEÁry
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gG‘
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gPaœ
;

26 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

28 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

29 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
.
	gMD5L’
;

30 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

32 
public
 cÏs 
	cRobÙsF‹r
 
im¶em’ts
 
	mURLF‹r
 {

33 
fš®
 
	mby‹
[] 
	mh—d”
 = "########".
g‘By‹s
();

34 
fš®
 
	mby‹
[] 
	m’d
 = "@@@@@@@@".
g‘By‹s
();

35 
Fe
 
	midxFe
;

36 
RªdomAcûssFe
 
	mrobÙFe
;

37 
FeChªÃl
 
	mroChªÃl
;

38 
M­³dBy‹Bufãr
 
	mroBuf
;

39 
	mHashM­
<
	mMD5
, 
	mOffAndL’
> 
	mho¡M­
 = 
Ãw
 
HashM­
<
MD5
, OffAndLen>(100000);

40 
	mLRUCacheM­
<
	mMD5
, 
	mRobÙsPrÙocŞ
> 
	mrobÙsM­
 = 
Ãw
 
LRUCacheM­
<
MD5
, RobotsProtocol>(

41 5000, 0.75f, 
	mŒue
);

42 
fš®
 
	mMAX_MAP_FILE_SIZE
 = 1024l * 1024 * 512;

43 
	mmax_Ìu_size
;

44 
by‹
 
	mbufãr
[] = 
Ãw
 byte[1024 * 1024];

45 
boŞ—n
 
	mu£MemFe
 = 
çl£
;

47 şas 
	cOffAndL’
 {

48 
	moff£t
;

49 
	mËn
;

51 
public
 
OffAndL’
(
off£t
, 
Ën
) {

52 
	mthis
.
	moff£t
 = 
off£t
;

53 
	mthis
.
	mËn
 = 
Ën
;

57 
şass
 
	gLRUCacheM­
<
	gK
, 
	gV
> 
ex‹nds
 
	gLškedHashM­
<K, V> {

59 
public
 
LRUCacheM­
() {

60 
su³r
();

64 
public
 
LRUCacheM­
(
š™ŸlC­ac™y
, 
lßdFaùÜ
,

65 
boŞ—n
 
acûssOrd”
) {

66 
su³r
(
š™ŸlC­ac™y
, 
lßdFaùÜ
, 
acûssOrd”
);

70 
public
 
LRUCacheM­
(
š™ŸlC­ac™y
, 
lßdFaùÜ
) {

71 
su³r
(
š™ŸlC­ac™y
, 
lßdFaùÜ
);

75 
public
 
LRUCacheM­
(
š™ŸlC­ac™y
) {

76 
su³r
(
š™ŸlC­ac™y
);

80 
public
 
LRUCacheM­
(
M­
<? 
ex‹nds
 
K
, ?ƒx‹nd 
V
> 
m
) {

81 
su³r
(
m
);

88 
´iv©e
 
fš®
 
	g£rŸlV”siÚUID
 = 1L;

90 @
Ov”ride


91 
´Ùeùed
 
boŞ—n
 
»moveElde¡EÁry
(
EÁry
<
K
, 
V
> 
–de¡
) {

93 ià(
size
(è> 
	gmax_Ìu_size
)

94  
	gŒue
;

96  
	gçl£
;

101 
public
 
	$g‘W—kRobÙsM­Size
() {

102  
this
.
robÙsM­
.
	`size
();

103 
	}
}

105 
public
 
	$g‘RobÙsM­Size
() {

106  
this
.
ho¡M­
.
	`size
();

107 
	}
}

109 @
Ov”ride


110 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

112 
this
.
max_Ìu_size
 = 
cÚf
.
	`g‘IÁ
("host_lru_size", 5000);

113 
SŒšg
 
idxName
 = 
cÚf
.
	`g‘
("robot_idx_name");

114 
SŒšg
 
robÙFeName
 = 
cÚf
.
	`g‘
("robot_file_name");

115 
u£MemFe
 = 
cÚf
.
	`g‘BoŞ—n
("u£_memm­_fe", 
Œue
);

116 ià(
idxName
 !ğ
nuÎ
 && !idxName.
	`equ®s
(""è&& 
robÙFeName
 !=‚ull

117 && !
robÙFeName
.
	`equ®s
("")) {

118 
idxFe
 = 
Ãw
 
	`Fe
(
idxName
);

119 
Œy
 {

120 
robÙFe
 = 
Ãw
 
	`RªdomAcûssFe
(
robÙFeName
, "r");

121 
this
.
roChªÃl
 = 
robÙFe
.
	`g‘ChªÃl
();

123 ià(
this
.
roChªÃl
.
	`size
(è> 
MAX_MAP_FILE_SIZE
) {

124 
this
.
u£MemFe
 = 
çl£
;

126 ià(
this
.
u£MemFe
) {

127 
roBuf
 = 
this
.
roChªÃl
.
	`m­
(
M­Mode
.
READ_ONLY
, 0,

128 
roChªÃl
.
	`size
());

133 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

135 
e
.
	`´štSckT¿û
();

136 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

138 
e
.
	`´štSckT¿û
();

142 
public
 
	`g‘W—kRobÙsM­Size
() {

143  
this
.
robÙsM­
.
	`size
();

145 
public
 
	`g‘RobÙsM­Size
() {

146  
this
.
ho¡M­
.
	`size
();

149 
j
 = 0; j + 20 < 
i
; j += 20) {

150 
Œy
 {

151 
MD5
 
md
 = 
Ãw
 
	`MD5
(
a
, 
MD5L’
.
eight
, 
j
);

152 
off£t
 = 
Numb”Ut
.
	`»adLÚg
(
a
, 
j
 + 8);

153 
Ën
 = 
Numb”Ut
.
	`»adIÁ
(
a
, 
j
 + 16);

154 
OffAndL’
 
o
 = 
Ãw
 
	`OffAndL’
(
off£t
, 
Ën
);

155 
ho¡M­
.
	`put
(
md
, 
o
);

156 
robÙsM­
.
	`put
(
md
, 
nuÎ
);

157 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

159 
e
.
	`´štSckT¿û
();

162 
public
 
	`OffAndL’
(
off£t
, 
Ën
) {

163 
this
.
off£t
 = offset;

164 
this
.
Ën
 =†en;

168 @
Ov”ride


169 
public
 
	`£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

170 
boŞ—n
 
u£Di¡ribu‹Cache
 = 
cÚf
.
	`g‘BoŞ—n
("u£Di¡ribu‹Cache", 
çl£
);

171 ià(
u£Di¡ribu‹Cache
) {

172 
SŒšg
 
idxName
 = 
cÚf
.
	`g‘
("robot_idx_name");

173 
SŒšg
 
robÙFeName
 = 
cÚf
.
	`g‘
("robot_file_name");

174 ià(
idxName
 !ğ
nuÎ
 && !idxName.
	`equ®s
("") &&

175 
robÙFeName
 !ğ
nuÎ
 && !robÙFeName.
	`equ®s
("")) {

176 
idxFe
 = 
Ãw
 
	`Fe
(
idxName
);

177 
Œy
 {

178 
robÙFe
 = 
Ãw
 
	`RªdomAcûssFe
(
robÙFeName
, "r");

179 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

180 
e
.
	`´štSckT¿û
();

184 
SŒšg
 
idxName
 = 
cÚf
.
	`g‘
("robot_idx_name");

185 
SŒšg
 
robÙFeName
 = 
cÚf
.
	`g‘
("robot_file_name");

186 ià(
idxName
 !ğ
nuÎ
 && !idxName.
	`equ®s
("") &&

187 
robÙFeName
 !ğ
nuÎ
 && !robÙFeName.
	`equ®s
("")) {

188 
idxFe
 = 
Ãw
 
	`Fe
(
idxName
);

189 
Œy
 {

190 
robÙFe
 = 
Ãw
 
	`RªdomAcûssFe
(
robÙFeName
, "r");

191 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

192 
e
.
	`´štSckT¿û
();

197 ià(
idxFe
 !ğ
nuÎ
 && 
robÙFe
 !=‚ull) {

198 
Bufã»dIÅutSŒ—m
 
šput
 = 
nuÎ
;

200 
Œy
 {

201 
šput
 = 
Ãw
 
	`Bufã»dIÅutSŒ—m
Òew 
	`FeIÅutSŒ—m
(
idxFe
));

202 
by‹
 
a
[] = 
Ãw
 byte[4096];

203 
i
 = 0;

205 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

207 
e
.
	`´štSckT¿û
();

208 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

210 
e
.
	`´štSckT¿û
();

211 } 
fš®ly
 {

212 
Œy
 {

213 
šput
.
	`şo£
();

214 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

216 
e
.
	`´štSckT¿û
();

219 
Log
.
	`šfo
("sucûed†ßd ho¡ m­ size"+
ho¡M­
.
	`size
());

222 
j
 = 0; j + 20 < 
i
; j += 20) {

223 
Œy
 {

224 
MD5
 
md5
 = 
Ãw
 
	`MD5
(
a
, 
MD5L’
.
eight
, 
j
);

225 
off£t
 = 
Numb”Ut
.
	`»adLÚg
(
a
, 
j
 + 8);

226 
Ën
 = 
Numb”Ut
.
	`»adIÁ
(
a
, 
j
 + 16);

227 
OffAndL’
 
o
 = 
Ãw
 
	`OffAndL’
(
off£t
, 
Ën
);

228 
Paœ
<
OffAndL’
, 
RobÙsPrÙocŞ
> 
p
 = 
Ãw
 Paœ<OffAndL’, RobÙsPrÙocŞ>(
o
, 
nuÎ
);

234 
robÙsM­
.
	`put
(
md5
, 
p
);

235 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

236 
e
.
	`´štSckT¿û
();

240 
´iv©e
 
RobÙsPrÙocŞ
 
	`lßdFromMemFe
(
OffAndL’
 
o
) {

241 
RobÙsPrÙocŞ
 
»s
 = 
nuÎ
;

242 
Œy
 {

243 
this
.
roBuf
.
	`pos™iÚ
((è
o
.
off£t
);

244 ià(
o
.
Ën
 < 0 || o.
off£t
 < 0 || o.off£ˆ> 
this
.
robÙFe
.
	`Ëngth
()

245 || 
o
.
off£t
 + o.
Ën
 > 
this
.
robÙFe
.
	`Ëngth
()) {

246 
Log
.
	`šfo
("»adƒ¼Ü off=" + 
o
.
off£t
 + "†’=" + o.
Ën
);

247  
nuÎ
;

250 
roBuf
.
	`g‘
(
bufãr
, 0, 
o
.
Ën
);

251 
by‹
 
a
[] = 
bufãr
;

254 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

255 
e
.
	`´štSckT¿û
();

256 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

257 
e
.
	`´štSckT¿û
();

258 } 
fš®ly
 {

259 
Œy
 {

260 
šput
.
	`şo£
();

261 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

262 
e
.
	`´štSckT¿û
();

267 
´iv©e
 
RobÙsPrÙocŞ
 
	`lßdFromFe
(
OffAndL’
 
o
) {

268 
RobÙsPrÙocŞ
 
»s
 = 
nuÎ
;

269 
Œy
 {

270 
this
.
robÙFe
.
	`£ek
(
o
.
off£t
);

271 ià(
o
.
off£t
 < 0 || o.
Ën
 < 0 ||

272 
o
.
off£t
 > 
this
.
robÙFe
.
	`Ëngth
() ||

273 
o
.
off£t
 + o.
Ën
 > 
this
.
robÙFe
.
	`Ëngth
()) {

274 
Log
.
	`šfo
("»adƒ¼Ü off=" + 
o
.
off£t
 + "†’=" + o.
Ën
);

275  
nuÎ
;

277 
RobÙsPrÙocŞ
 
´ÙocŞ
 = 
Ãw
 
	`P»fixRobÙsPrÙocŞ
();

278 ià(
´ÙocŞ
.
	`š™
(
robÙs
.
	`¥l™
("[\r\n]{1,}"))) {

279  
´ÙocŞ
;

281 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

283 
e
.
	`´štSckT¿û
();

285  
»s
;

295 
´iv©e
 
RobÙsPrÙocŞ
 
	`lßdFromFe
(
OffAndL’
 
o
) {

296 
RobÙsPrÙocŞ
 
»s
 = 
nuÎ
;

297 
Œy
 {

300 ià(
o
.
Ën
 > 
this
.
bufãr
.
Ëngth
) {

301 
bufãr
 = 
Ãw
 
by‹
[
o
.
Ën
];

303 
By‹Bufãr
 
buf
 = By‹Bufãr.
	`w¿p
(
bufãr
, 0, 
o
.
Ën
);

304 
t
 = 
this
.
roChªÃl
.
	`»ad
(
buf
, 
o
.
off£t
);

305 ià(
o
.
Ën
 < 0 || o.
off£t
 < 0 || o.off£ˆ> 
this
.
robÙFe
.
	`Ëngth
()

306 || 
o
.
off£t
 + o.
Ën
 > 
this
.
robÙFe
.
	`Ëngth
(è|| 
t
 < o.len) {

307 
Log
.
	`šfo
("»adƒ¼Ü off=" + 
o
.
off£t
 + "†’=" + o.
Ën
 + "t="

308 + 
t
);

309  
nuÎ
;

312 
by‹
 
a
[] = 
buf
.
	`¬¿y
();

317 
	`as£¹
 (
By‹s
.
	`com·»To
(
a
, 0, 8, 
h—d”
, 0, 8) == 0);

318 
	`as£¹
 (
By‹s
.
	`com·»To
(
a
, 
o
.
Ën
 - 8, 8, 
’d
, 0, 8) == 0);

319 
ho¡L’
 = 
Numb”Ut
.
	`»adIÁ
(
a
, 16);

320 
robÙsL’
 = 
Numb”Ut
.
	`»adIÁ
(
a
, 20 + 
ho¡L’
);

321 
SŒšg
 
robÙs
 = 
Ãw
 
	`SŒšg
(
a
, 
ho¡L’
 + 24, 
robÙsL’
);

322 
RobÙsPrÙocŞ
 
´ÙocŞ
 = 
Ãw
 
	`P»fixRobÙsPrÙocŞ
();

323 ià(
´ÙocŞ
.
	`š™
(
robÙs
.
	`¥l™
("[\r\n]{1,}"))) {

324  
´ÙocŞ
;

327 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

329 
e
.
	`´štSckT¿û
();

345 @
Ov”ride


346 
public
 
SŒšg
 
	`f‹r
(SŒšg 
u¾SŒšg
) {

348 ià(
u¾SŒšg
 =ğ
nuÎ
 || u¾SŒšg.
	`equ®s
(""))

349  
nuÎ
;

350 
RobÙsPrÙocŞ
 
´ÙocŞ
 = 
nuÎ
;

351 
Œy
 {

352 
URL
 
u¾
 = 
Ãw
 
	`URL
(
u¾SŒšg
);

353 
SŒšg
 
ho¡
 = 
u¾
.
	`g‘Ho¡
();

354 
SŒšg
 
·th
 = 
u¾
.
	`g‘Fe
();

356 
MD5
 
md5
 = MD5.
	`dige¡8
(
ho¡
.
	`g‘By‹s
());

358 ià(!
this
.
ho¡M­
.
	`cÚšsKey
(
md5
)) {

359  
u¾SŒšg
;

361 
	`as£¹
 (
this
.
ho¡M­
.
	`cÚšsKey
(
md5
));

362 ià(!
this
.
robÙsM­
.
	`cÚšsKey
(
md5
)

363 || 
this
.
robÙsM­
.
	`g‘
(
md5
è=ğ
nuÎ
) {

365 
OffAndL’
 
o
 = 
this
.
ho¡M­
.
	`g‘
(
md5
);

367 ià(
this
.
u£MemFe
) {

368 
´ÙocŞ
 = 
this
.
	`lßdFromMemFe
(
o
);

370 
´ÙocŞ
 = 
this
.
	`lßdFromFe
(
o
);

372 
this
.
robÙsM­
.
	`put
(
md5
, 
´ÙocŞ
);

374 
´ÙocŞ
 = 
this
.
robÙsM­
.
	`g‘
(
md5
);

375 ià(
´ÙocŞ
 !ğ
nuÎ
) {

376 ià(
´ÙocŞ
.
	`checkURL
(
·th
)) {

377  
u¾SŒšg
;

379  
nuÎ
;

384 @
Ov”ride


385 
public
 
SŒšg
 
	`f‹r
(SŒšg 
u¾SŒšg
) {

386 ià(
u¾SŒšg
 =ğ
nuÎ
 || u¾SŒšg.
	`equ®s
(""))

387  
nuÎ
;

388 
RobÙsPrÙocŞ
 
´ÙocŞ
 = 
nuÎ
;

389 
Œy
 {

390 
URL
 
u¾
 = 
Ãw
 
	`URL
(
u¾SŒšg
);

391 
SŒšg
 
ho¡
 = 
u¾
.
	`g‘Ho¡
();

392 
SŒšg
 
·th
 = 
u¾
.
	`g‘Fe
();

394 
MD5
 
md5
 = MD5.
	`dige¡8
(
ho¡
.
	`g‘By‹s
());

396 ià(!
this
.
robÙsM­
.
	`cÚšsKey
(
md5
)) {

397  
u¾SŒšg
;

399 
Paœ
<
OffAndL’
, 
RobÙsPrÙocŞ
> 
o
 = 
this
.
robÙsM­
.
	`g‘
(
md5
);

400 ià(
o
.
	`g‘SecÚd
(è=ğ
nuÎ
) {

401 
´ÙocŞ
 = 
this
.
	`lßdFromFe
(
o
.
	`g‘Fœ¡
());

402 ià(
´ÙocŞ
 !ğ
nuÎ
) {

403 
o
.
	`£tSecÚd
(
´ÙocŞ
);

407 
´ÙocŞ
 = 
o
.
	`g‘SecÚd
();

408 ià(
´ÙocŞ
 !ğ
nuÎ
) {

409 ià(
´ÙocŞ
.
	`checkURL
(
·th
)) {

410  
u¾SŒšg
;

412  
nuÎ
;

416 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e
) {

417 
e
.
	`´štSckT¿û
();

418  
nuÎ
;

421  
u¾SŒšg
;

424 
public
 
	`maš
(
SŒšg
 
¬gs
[]) {

428 @
Ov”ride


429 
public
 
CÚfigu¿tiÚ
 
	`g‘CÚf
() {

430  
this
.
	`g‘CÚf
();

	@com/zhongsou/spider/common/url/RobotsProtocol.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

3 
public
 
ab¡¿ù
 cÏs 
	cRobÙsPrÙocŞ
 {

5 
ab¡¿ù
 
public
 
boŞ—n
 
š™
(
SŒšg
 
¡r
[]);

13 
public
 
ab¡¿ù
 
boŞ—n
 
checkURL
(
SŒšg
 
·th
);

14 
public
 
boŞ—n
 
	$m©chWdC¬d
(
SŒšg
 
¡r
, SŒšg 
wdÿrd
)

17  
	`m©chWdC¬d
(
¡r
,
wdÿrd
,
Œue
);

30 
public
 
boŞ—n
 
	$m©chWdC¬d
(
SŒšg
 
¡r
, SŒšg 
wdÿrd
,
boŞ—n
 
´efixM©ch
) {

31 
boŞ—n
 
m©ched
 = 
Œue
;

33 
pAá”La¡Wd
 = -1;

35 
pAá”La¡Tame
 = -1;

37 
t
, 
w
;

38 
¡rPos
 = 0, 
wdC¬dPos
 = 0;

40 
Œue
) {

42 ià(
¡rPos
 >ğ
¡r
.
	`Ëngth
()) {

44 ià(
wdC¬dPos
 =ğ
wdÿrd
.
	`Ëngth
()) {

48 ià(
wdÿrd
.
	`ch¬At
(
wdC¬dPos
) == '*') {

49 
wdC¬dPos
++;

53 ià(
pAá”La¡Tame
 != -1) {

55 ià(
pAá”La¡Tame
 >ğ
¡r
.
	`Ëngth
()) {

56 
m©ched
 = 
çl£
;

59 
¡rPos
 = 
pAá”La¡Tame
++;

60 
wdC¬dPos
 = 
pAá”La¡Wd
;

65 
m©ched
 = 
çl£
;

69 
t
 = 
¡r
.
	`ch¬At
(
¡rPos
);

72 ià(
wdC¬dPos
 >ğ
wdÿrd
.
	`Ëngth
()) {

74 if(
´efixM©ch
)

77 
w
 = 
Ch¬aù”
.
MAX_VALUE
;

79 
w
 = 
wdÿrd
.
	`ch¬At
(
wdC¬dPos
);

82 ià(
t
 !ğ
w
) {

83 ià(
w
 == '*') {

84 
pAá”La¡Wd
 = ++
wdC¬dPos
;

85 
pAá”La¡Tame
 = 
¡rPos
;

87 ià(
wdC¬dPos
 =ğ
wdÿrd
.
	`Ëngth
()) {

91 } ià(
pAá”La¡Wd
 != -1) {

93 ià(
pAá”La¡Wd
 !ğ
wdC¬dPos
) {

94 
wdC¬dPos
 = 
pAá”La¡Wd
;

95 
	`as£¹
 (
wdC¬dPos
 <ğ
wdÿrd
.
	`Ëngth
() - 1);

96 
w
 = 
wdÿrd
.
	`ch¬At
(
wdC¬dPos
);

97 ià(
t
 =ğ
w
) {

98 
wdC¬dPos
++;

103 
¡rPos
++;

106 
m©ched
 = 
çl£
;

112 
¡rPos
++;

113 
wdC¬dPos
++;

117  
m©ched
;

118 
	}
}

	@com/zhongsou/spider/common/url/RobotsProtocolParser.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

3 
impÜt
 
	gjava
.
	gio
.
	gBufã»dIÅutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gFe
;

5 
impÜt
 
	gjava
.
	gio
.
	gFeIÅutSŒ—m
;

6 
impÜt
 
	gjava
.
	gio
.
	gFeNÙFoundExû±iÚ
;

7 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

8 
impÜt
 
	gjava
.
	gÃt
.
	gURL
;

9 
impÜt
 
	gjava
.
	gÃt
.
	gURLDecod”
;

10 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

11 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

12 
impÜt
 
	gjava
.
	gut
.
	gSŒšgTok’iz”
;

21 
public
 cÏs 
	cRobÙsPrÙocŞP¬£r
 {

23 
public
 
	$RobÙsPrÙocŞP¬£r
() {

24 
robÙNames
.
	`put
("zhongsouspier", 1);

25 
robÙNames
.
	`put
("googlebot", 2);

26 
robÙNames
.
	`put
("baiduspider", 3);

27 
robÙNames
.
	`put
("*", 4);

31 
´iv©e
 
fš®
 
NO_PRECEDENCE
 = 
IÁeg”
.
MAX_VALUE
;

33 
´iv©e
 
fš®
 
RobÙRuËS‘
 
EMPTY_RULES
 = 
Ãw
 
	`RobÙRuËS‘
();

35 
´iv©e
 
RobÙRuËS‘
 
FORBID_ALL_RULES
 = 
	`g‘FÜbidAÎRuËs
();

37 
´iv©e
 
HashM­
<
SŒšg
, 
IÁeg”
> 
robÙNames
 = 
Ãw
 HashMap<String, Integer>();

39 
RobÙRuËS‘
 
	$g‘FÜbidAÎRuËs
() {

40 
RobÙRuËS‘
 
ruËs
 = 
Ãw
 
	`RobÙRuËS‘
();

41 
ruËs
.
	`addP»fix
("", 
çl£
);

42  
ruËs
;

43 
	}
}

53 
public
 
SŒšg
 
	$·r£rRobÙsText
(
SŒšg
 
cÚ‹Á
) {

54 
RobÙRuËS‘
 
£t
 = 
this
.
	`·r£RuËs
(
cÚ‹Á
);

55 ià(
£t
 =ğ
EMPTY_RULES
)

58  
£t
.
	`toSŒšg
();

59 
	}
}

65 
public
 şas 
	cRobÙRuËS‘
 {

66 
	gA¼ayLi¡
<
	gRobÙsEÁry
> 
	gtmpEÁr›s
 = 
Ãw
 
A¼ayLi¡
<
RobÙsEÁry
>();

67 
	gRobÙsEÁry
[] 
	g’Œ›s
 = 
nuÎ
;

68 
	gexpœeTime
;

69 
	güawlD–ay
 = -1;

73 
´iv©e
 cÏs 
	cRobÙsEÁry
 {

74 
SŒšg
 
	g´efix
;

75 
boŞ—n
 
	g®lowed
;

77 
RobÙsEÁry
(
SŒšg
 
´efix
, 
boŞ—n
 
®lowed
) {

78 
	gthis
.
	g´efix
 = 
´efix
;

79 
	gthis
.
	g®lowed
 = 
®lowed
;

85 
´iv©e
 
addP»fix
(
SŒšg
 
´efix
, 
boŞ—n
 
®low
) {

86 ià(
	gtmpEÁr›s
 =ğ
nuÎ
) {

87 
tmpEÁr›s
 = 
Ãw
 
A¼ayLi¡
<
RobÙsEÁry
>();

88 ià(
	g’Œ›s
 !ğ
nuÎ
) {

89 
i
 = 0; 
	gi
 < 
	g’Œ›s
.
	gËngth
; i++)

90 
	gtmpEÁr›s
.
add
(
’Œ›s
[
i
]);

92 
	g’Œ›s
 = 
nuÎ
;

95 
	gtmpEÁr›s
.
add
(
Ãw
 
RobÙsEÁry
(
´efix
, 
®low
));

100 
´iv©e
 
ş—rP»fixes
() {

101 ià(
	gtmpEÁr›s
 =ğ
nuÎ
) {

102 
tmpEÁr›s
 = 
Ãw
 
A¼ayLi¡
<
RobÙsEÁry
>();

103 
	g’Œ›s
 = 
nuÎ
;

105 
	gtmpEÁr›s
.
ş—r
();

112 
public
 
£tExpœeTime
(
expœeTime
) {

113 
	gthis
.
	gexpœeTime
 = 
expœeTime
;

119 
public
 
g‘ExpœeTime
() {

120  
	gexpœeTime
;

126 
public
 
g‘C¿wlD–ay
() {

127  
	güawlD–ay
;

133 
public
 
£tC¿wlD–ay
(
üawlD–ay
) {

134 
	gthis
.
	güawlD–ay
 = 
üawlD–ay
;

142 
public
 
boŞ—n
 
isAÎowed
(
URL
 
u¾
) {

143 
SŒšg
 
	g·th
 = 
u¾
.
g‘P©h
();

144 ià((
	g·th
 =ğ
nuÎ
è|| "".
equ®s
(
·th
)) {

145 
·th
 = "/";

147  
isAÎowed
(
·th
);

155 
public
 
boŞ—n
 
isAÎowed
(
SŒšg
 
·th
) {

156 
	gŒy
 {

157 
	g·th
 = 
URLDecod”
.
decode
(
·th
, "utf-8");

158 } 
ÿtch
 (
Exû±iÚ
 
e
) {

163 ià(
	g’Œ›s
 =ğ
nuÎ
) {

164 
’Œ›s
 = 
Ãw
 
RobÙsEÁry
[
tmpEÁr›s
.
size
()];

165 
	g’Œ›s
 = 
tmpEÁr›s
.
toA¼ay
(
’Œ›s
);

166 
	gtmpEÁr›s
 = 
nuÎ
;

169 
	gpos
 = 0;

170 
	g’d
 = 
’Œ›s
.
Ëngth
;

171 
	gpos
 < 
	g’d
) {

172 ià(
	g·th
.
¡¬tsW™h
(
’Œ›s
[
pos
].
´efix
))

173  
	g’Œ›s
[
pos
].
	g®lowed
;

174 
	gpos
++;

177  
	gŒue
;

182 @
Ov”ride


183 
public
 
SŒšg
 
toSŒšg
() {

184 
isAÎowed
("x");

185 
SŒšgBufãr
 
	gbuf
 = 
Ãw
 StringBuffer();

186 
	gi
 = 0; i < 
	g’Œ›s
.
	gËngth
; i++)

187 ià(
	g’Œ›s
[
i
].
	g®lowed
)

188 
	gbuf
.
­³nd
("+" + 
’Œ›s
[
i
].
´efix


189 + 
Sy¡em
.
g‘Prİ”ty
("line.separator"));

191 
	gbuf
.
­³nd
("-" + 
’Œ›s
[
i
].
´efix


192 + 
Sy¡em
.
g‘Prİ”ty
("line.separator"));

193  
	gbuf
.
toSŒšg
();

204 
RobÙRuËS‘
 
	$·r£RuËs
(
SŒšg
 
cÚ‹Á
) {

205 
SŒšgTok’iz”
 
lšeP¬£r
 = 
Ãw
 
	`SŒšgTok’iz”
(
cÚ‹Á
, "\n\r");

207 
RobÙRuËS‘
 
be¡RuËsSoF¬
 = 
nuÎ
;

208 
be¡P»ûd’ûSoF¬
 = 
NO_PRECEDENCE
;

210 
RobÙRuËS‘
 
cu¼’tRuËs
 = 
Ãw
 
	`RobÙRuËS‘
();

211 
cu¼’tP»ûd’û
 = 
NO_PRECEDENCE
;

213 
boŞ—n
 
addRuËs
 = 
çl£
;

214 
boŞ—n
 
dÚeAg’ts
 = 
çl£
;

216 
lšeP¬£r
.
	`hasMÜeTok’s
()) {

217 
SŒšg
 
lše
 = 
lšeP¬£r
.
	`ÃxtTok’
();

220 
hashPos
 = 
lše
.
	`šdexOf
("#");

221 ià(
hashPos
 >= 0)

222 
lše
 =†še.
	`sub¡ršg
(0, 
hashPos
);

223 
lše
 =†še.
	`Œim
();

225 ià((
lše
.
	`Ëngth
() >= 11) &&

226 (
lše
.
	`sub¡ršg
(0, 11).
	`equ®sIgnÜeCa£
("User-agent:"))) {

228 ià(
dÚeAg’ts
) {

229 ià(
cu¼’tP»ûd’û
 < 
be¡P»ûd’ûSoF¬
) {

230 
be¡P»ûd’ûSoF¬
 = 
cu¼’tP»ûd’û
;

231 
be¡RuËsSoF¬
 = 
cu¼’tRuËs
;

232 
cu¼’tP»ûd’û
 = 
NO_PRECEDENCE
;

233 
cu¼’tRuËs
 = 
Ãw
 
	`RobÙRuËS‘
();

235 
addRuËs
 = 
çl£
;

237 
dÚeAg’ts
 = 
çl£
;

239 
SŒšg
 
ag’tNames
 = 
lše
.
	`sub¡ršg
Öše.
	`šdexOf
(":") + 1);

240 
ag’tNames
 =‡g’tNames.
	`Œim
();

241 
SŒšgTok’iz”
 
ag’tTok’iz”
 = 
Ãw
 
	`SŒšgTok’iz”
(
ag’tNames
);

243 
ag’tTok’iz”
.
	`hasMÜeTok’s
()) {

245 
SŒšg
 
ag’tName
 = 
ag’tTok’iz”
.
	`ÃxtTok’
().
	`toLow”Ca£
()

246 .
	`Œim
();

248 
IÁeg”
 
´eûd’ûIÁ
 = 
robÙNames
.
	`g‘
(
ag’tName
);

250 ià(
´eûd’ûIÁ
 !ğ
nuÎ
) {

251 
´eûd’û
 = 
´eûd’ûIÁ
.
	`štV®ue
();

252 ià((
´eûd’û
 < 
cu¼’tP»ûd’û
)

253 && (
´eûd’û
 < 
be¡P»ûd’ûSoF¬
))

254 
cu¼’tP»ûd’û
 = 
´eûd’û
;

259 ià(
cu¼’tP»ûd’û
 < 
be¡P»ûd’ûSoF¬
)

260 
addRuËs
 = 
Œue
;

262 } ià((
lše
.
	`Ëngth
() >= 9)

263 && (
lše
.
	`sub¡ršg
(0, 9).
	`equ®sIgnÜeCa£
("Disallow:"))) {

265 
dÚeAg’ts
 = 
Œue
;

266 
SŒšg
 
·th
 = 
lše
.
	`sub¡ršg
Öše.
	`šdexOf
(":") + 1);

267 
·th
 =…©h.
	`Œim
();

268 
Œy
 {

269 
·th
 = 
URLDecod”
.
	`decode
(path, "utf-8");

270 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

274 ià(
·th
.
	`Ëngth
() == 0) {

275 ià(
addRuËs
)

276 
cu¼’tRuËs
.
	`ş—rP»fixes
();

278 ià(
addRuËs
)

279 
cu¼’tRuËs
.
	`addP»fix
(
·th
, 
çl£
);

282 } ià((
lše
.
	`Ëngth
() >= 6)

283 && (
lše
.
	`sub¡ršg
(0, 6).
	`equ®sIgnÜeCa£
("Allow:"))) {

285 
dÚeAg’ts
 = 
Œue
;

286 
SŒšg
 
·th
 = 
lše
.
	`sub¡ršg
Öše.
	`šdexOf
(":") + 1);

287 
·th
 =…©h.
	`Œim
();

289 ià(
·th
.
	`Ëngth
() == 0) {

291 ià(
addRuËs
)

292 
cu¼’tRuËs
.
	`ş—rP»fixes
();

294 ià(
addRuËs
)

295 
cu¼’tRuËs
.
	`addP»fix
(
·th
, 
Œue
);

297 } ià((
lše
.
	`Ëngth
() >= 12)

298 && (
lše
.
	`sub¡ršg
(0, 12).
	`equ®sIgnÜeCa£
("Crawl-Delay:"))) {

299 
dÚeAg’ts
 = 
Œue
;

300 ià(
addRuËs
) {

301 
üawlD–ay
 = -1;

302 
SŒšg
 
d–ay
 = 
lše
.
	`sub¡ršg
("C¿wl-D–ay:".
	`Ëngth
(),

303 
lše
.
	`Ëngth
()).
	`Œim
();

304 ià(
d–ay
.
	`Ëngth
() > 0) {

305 
Œy
 {

306 
üawlD–ay
 = 
LÚg
.
	`·r£LÚg
(
d–ay
) * 1000;

308 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

311 
cu¼’tRuËs
.
	`£tC¿wlD–ay
(
üawlD–ay
);

317 ià(
cu¼’tP»ûd’û
 < 
be¡P»ûd’ûSoF¬
) {

318 
be¡P»ûd’ûSoF¬
 = 
cu¼’tP»ûd’û
;

319 
be¡RuËsSoF¬
 = 
cu¼’tRuËs
;

322 ià(
be¡P»ûd’ûSoF¬
 =ğ
NO_PRECEDENCE
)

323  
EMPTY_RULES
;

324  
be¡RuËsSoF¬
;

325 
	}
}

331 
RobÙRuËS‘
 
	$·r£RuËs
(
by‹
[] 
robÙCÚ‹Á
) {

332 ià(
robÙCÚ‹Á
 =ğ
nuÎ
)

333  
EMPTY_RULES
;

335 
SŒšg
 
cÚ‹Á
 = 
Ãw
 
	`SŒšg
(
robÙCÚ‹Á
);

336  
this
.
	`·r£RuËs
(
cÚ‹Á
);

338 
	}
}

340 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

342 
Fe
 
fe
 = 
Ãw
 
	`Fe
("/tmp/robots.txt");

343 
f–’
 = (è
fe
.
	`Ëngth
();

344 
Sy¡em
.
out
.
	`´šn
("fËngth = " + 
f–’
);

345 
by‹
[] 
cÚ‹Á
 = 
Ãw
 by‹[(è(
f–’
)];

347 
Œy
 {

348 
Bufã»dIÅutSŒ—m
 
¡»am
 = 
Ãw
 
	`Bufã»dIÅutSŒ—m
(

349 
Ãw
 
	`FeIÅutSŒ—m
(
fe
));

350 
Ën
 = 0;

351 
by‹
 
k
[] = 
Ãw
 byte[4096];

352 
off£t
 = 0;

353 (
Ën
 = 
¡»am
.
	`»ad
(
cÚ‹Á
, 
off£t
, 
f–’
 - offset)) != -1) {

354 
off£t
 +ğ
Ën
;

355 ià(
off£t
 =ğ
f–’
)

358 
Sy¡em
.
out
.
	`´šn
("»ad†’gth = " + 
Ën
);

359 
¡»am
.
	`şo£
();

360 
RobÙsPrÙocŞP¬£r
 
·r£r
 = 
Ãw
 
	`RobÙsPrÙocŞP¬£r
();

361 
RobÙRuËS‘
 
£t
 = 
·r£r
.
	`·r£RuËs
(
cÚ‹Á
);

362 
Sy¡em
.
out
.
	`´šn
(
£t
.
	`toSŒšg
());

363 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

364 
e
.
	`´štSckT¿û
();

365 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

366 
e
.
	`´štSckT¿û
();

368 
	}
}

	@com/zhongsou/spider/common/url/SuffixURLFilter.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

21 
impÜt
 
	gjava
.
	gio
.
	gFeR—d”
;

22 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

23 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—mR—d”
;

24 
impÜt
 
	gjava
.
	gio
.
	gR—d”
;

25 
impÜt
 
	gjava
.
	gio
.
	gSŒšgR—d”
;

26 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

27 
impÜt
 
	gjava
.
	gÃt
.
	gURL
;

28 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

29 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

30 
impÜt
 
	gjava
.
	gut
.
	gM­
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

33 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

34 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gSpid”CÚfigu¿tiÚ
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gSuffixSŒšgM©ch”
;

38 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
;

39 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
.
	gPlugšIm¶em’tiÚ
;

40 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugšP¬£r
;

123 
public
 cÏs 
	cSuffixURLF‹r
 
im¶em’ts
 
	mURLF‹r
 {

125 
´iv©e
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
SuffixURLF‹r
.
şass
);

128 
´iv©e
 
SŒšg
 
	m©Œibu‹Fe
 = 
nuÎ
;

130 
´iv©e
 
SuffixSŒšgM©ch”
 
	msuffixes
;

131 
´iv©e
 
boŞ—n
 
	mmodeAcû±
 = 
çl£
;

132 
´iv©e
 
boŞ—n
 
	mf‹rFromP©h
 = 
çl£
;

133 
´iv©e
 
boŞ—n
 
	mignÜeCa£
 = 
çl£
;

135 
´iv©e
 
CÚfigu¿tiÚ
 
	mcÚf
;

137 
public
 
	$SuffixURLF‹r
(è
throws
 
IOExû±iÚ
 {

141 
public
 
	$SuffixURLF‹r
(
R—d”
 
»ad”
è
throws
 
IOExû±iÚ
 {

142 
	`»adCÚfigu¿tiÚ
(
»ad”
);

143 
	}
}

145 
public
 
SŒšg
 
	$f‹r
(
SŒšg
 
u¾
) {

146 ià(
u¾
 =ğ
nuÎ
)

147  
nuÎ
;

148 
SŒšg
 
_u¾
;

149 ià(
ignÜeCa£
)

150 
_u¾
 = 
u¾
.
	`toLow”Ca£
();

152 
_u¾
 = 
u¾
;

153 ià(
f‹rFromP©h
) {

154 
Œy
 {

155 
URL
 
pU¾
 = 
Ãw
 
	`URL
(
_u¾
);

156 
_u¾
 = 
pU¾
.
	`g‘P©h
();

157 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e
) {

162 
SŒšg
 
a
 = 
suffixes
.
	`shÜ‹¡M©ch
(
_u¾
);

163 ià(
a
 =ğ
nuÎ
) {

164 ià(
modeAcû±
)

165  
u¾
;

167  
nuÎ
;

169 ià(
modeAcû±
)

170  
nuÎ
;

172  
u¾
;

174 
	}
}

176 
public
 
	$»adCÚfigu¿tiÚ
(
R—d”
 
»ad”
è
throws
 
IOExû±iÚ
 {

179 ià(
»ad”
 =ğ
nuÎ
) {

180 ià(
LOG
.
	`isW¬nEÇbËd
()) {

181 
LOG
.
	`w¬n
("Missing urlfilter.suffix.file,‡ll URLs will be„ejected!");

183 
suffixes
 = 
Ãw
 
	`SuffixSŒšgM©ch”
Òew 
SŒšg
[0]);

184 
modeAcû±
 = 
çl£
;

185 
ignÜeCa£
 = 
çl£
;

188 
Bufã»dR—d”
 
š
 = 
Ãw
 
	`Bufã»dR—d”
(
»ad”
);

189 
Li¡
 
aSuffixes
 = 
Ãw
 
	`A¼ayLi¡
();

190 
boŞ—n
 
®low
 = 
çl£
;

191 
boŞ—n
 
ignÜe
 = 
çl£
;

192 
SŒšg
 
lše
;

194 (
lše
 = 
š
.
	`»adLše
()è!ğ
nuÎ
) {

195 ià(
lše
.
	`Ëngth
() == 0)

198 
fœ¡
 = 
lše
.
	`ch¬At
(0);

199 
fœ¡
) {

205 
®low
 = 
çl£
;

206 ià(
lše
.
	`cÚšs
("P"))

207 
f‹rFromP©h
 = 
Œue
;

208 ià(
lše
.
	`cÚšs
("I"))

209 
ignÜe
 = 
Œue
;

212 
®low
 = 
Œue
;

213 ià(
lše
.
	`cÚšs
("P"))

214 
f‹rFromP©h
 = 
Œue
;

215 ià(
lše
.
	`cÚšs
("I"))

216 
ignÜe
 = 
Œue
;

219 
aSuffixes
.
	`add
(
lše
);

222 ià(
ignÜe
) {

223 
i
 = 0; i < 
aSuffixes
.
	`size
(); i++) {

224 
aSuffixes
.
	`£t
(
i
, ((
SŒšg
èaSuffixes.
	`g‘
(i)).
	`toLow”Ca£
());

227 
suffixes
 = 
Ãw
 
	`SuffixSŒšgM©ch”
(
aSuffixes
);

228 
modeAcû±
 = 
®low
;

229 
ignÜeCa£
 = 
ignÜe
;

230 
	}
}

232 
public
 
	$maš
(
SŒšg
 
¬gs
[]è
throws
 
IOExû±iÚ
 {

234 
SuffixURLF‹r
 
f‹r
;

235 ià(
¬gs
.
Ëngth
 >= 1)

236 
f‹r
 = 
Ãw
 
	`SuffixURLF‹r
Òew 
	`FeR—d”
(
¬gs
[0]));

238 
f‹r
 = 
Ãw
 
	`SuffixURLF‹r
();

239 
f‹r
.
	`£tCÚf
(
Spid”CÚfigu¿tiÚ
.
	`ü—‹
());

242 
Bufã»dR—d”
 
š
 = 
Ãw
 
	`Bufã»dR—d”
Òew 
	`IÅutSŒ—mR—d”
(
Sy¡em
.in));

243 
SŒšg
 
lše
;

244 (
lše
 = 
š
.
	`»adLše
()è!ğ
nuÎ
) {

245 
SŒšg
 
out
 = 
f‹r
.
	`f‹r
(
lše
);

246 ià(
out
 !ğ
nuÎ
) {

247 
Sy¡em
.
out
.
	`´šn
("ACCEPTED " + out);

249 
Sy¡em
.
out
.
	`´šn
("REJECTED " + out);

252 
	}
}

254 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

255 
this
.
cÚf
 = conf;

257 
SŒšg
 
¶ugšName
 = "urlfilter-suffix";

258 
PlugšP¬£r
 
¶ugšP¬£r
 = PlugšP¬£r.
	`g‘In¡ªû
();

259 
Plugš
 
¶ugš
 = 
¶ugšP¬£r
.
	`g‘Plugš
(
URLF‹r
.
şass
.
	`g‘Name
());

260 
M­
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
m­
 = 
¶ugš
.
	`g‘Im¶em’tiÚm­
();

262 
M­
.
EÁry
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
’Œy
 : 
m­
.
	`’ŒyS‘
()) {

263 ià(
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
().
	`equ®s
(
SuffixURLF‹r
.
şass
.
	`g‘Name
())) {

264 
©Œibu‹Fe
 = 
’Œy
.
	`g‘V®ue
().
	`g‘A‰ribu‹
("file");

269 ià(
©Œibu‹Fe
 !ğ
nuÎ
 &&‡‰ribu‹Fe.
	`Œim
().
	`equ®s
(""))

270 
©Œibu‹Fe
 = 
nuÎ
;

271 ià(
©Œibu‹Fe
 !ğ
nuÎ
) {

272 ià(
LOG
.
	`isInfoEÇbËd
()) {

273 
LOG
.
	`šfo
("A‰ribu‹ \"fe\" i defšed fÜ…lugš " + 
¶ugšName
 + "‡ " + 
©Œibu‹Fe
);

282 
SŒšg
 
fe
 = 
cÚf
.
	`g‘
("urlfilter.suffix.file");

283 
SŒšg
 
¡ršgRuËs
 = 
cÚf
.
	`g‘
("urlfilter.suffix.rules");

285 ià(
©Œibu‹Fe
 !ğ
nuÎ
)

286 
fe
 = 
©Œibu‹Fe
;

287 
R—d”
 
»ad”
 = 
nuÎ
;

288 ià(
¡ršgRuËs
 !ğ
nuÎ
) {

289 
»ad”
 = 
Ãw
 
	`SŒšgR—d”
(
¡ršgRuËs
);

291 
»ad”
 = 
cÚf
.
	`g‘CÚfResourûAsR—d”
(
fe
);

294 
Œy
 {

295 
	`»adCÚfigu¿tiÚ
(
»ad”
);

296 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

297 ià(
LOG
.
	`isE¼ÜEÇbËd
()) {

298 
LOG
.
	`”rÜ
(
e
.
	`g‘Mes§ge
());

300 
throw
 
Ãw
 
	`RuÁimeExû±iÚ
(
e
.
	`g‘Mes§ge
(),ƒ);

302 
	}
}

304 
public
 
CÚfigu¿tiÚ
 
	$g‘CÚf
() {

305  
this
.
cÚf
;

306 
	}
}

308 
public
 
boŞ—n
 
	$isModeAcû±
() {

309  
modeAcû±
;

310 
	}
}

312 
public
 
	$£tModeAcû±
(
boŞ—n
 
modeAcû±
) {

313 
this
.
modeAcû±
 = modeAccept;

314 
	}
}

316 
public
 
boŞ—n
 
	$isIgnÜeCa£
() {

317  
ignÜeCa£
;

318 
	}
}

320 
public
 
	$£tIgnÜeCa£
(
boŞ—n
 
ignÜeCa£
) {

321 
this
.
ignÜeCa£
 = ignoreCase;

322 
	}
}

324 
public
 
	$£tF‹rFromP©h
(
boŞ—n
 
f‹rFromP©h
) {

325 
this
.
f‹rFromP©h
 = filterFromPath;

326 
	}
}

	@com/zhongsou/spider/common/url/TrieRobotsProtocol.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

4 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

5 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

6 
impÜt
 
	gcom
.
	gsun
.
	gtoŞs
.
	gjavac
.
	gut
.
	gPaœ
;

8 
public
 cÏs 
	cTr›RobÙsPrÙocŞ
 
ex‹nds
 
	mRobÙsPrÙocŞ
 {

10 
boŞ—n
 
	mcÚšsWdC¬d
;

11 
Tr›Node
 
	mroÙ
 = 
Ãw
 Tr›Node((
by‹
) ' ', (byte) 0);

12 
	mLi¡
<
	mPaœ
<
	mBoŞ—n
, 
	mSŒšg
>> 
	mwdC¬dLi¡
 = 
nuÎ
;

20 @
Ov”ride


21 
public
 
boŞ—n
 
	$checkURL
(
SŒšg
 
·th
) {

22 
Tr›Node
 
cu¼
 = 
roÙ
;

23 
Tr›Node
 
Ãxt
 = 
nuÎ
;

25 
by‹
 
s
[] = 
·th
.
	`g‘By‹s
();

26 
i
 = 0;

27 
boŞ—n
 
·s£d
 = 
çl£
;

29 
Ãxt
 = 
cu¼
.
	`g‘OÃChd
(
s
[
i
]+128);

30 ià(
Ãxt
 =ğ
nuÎ
) {

31 
·s£d
 = 
Œue
;

34 ià(
Ãxt
.
æag
 == -1) {

36 
·s£d
 = 
çl£
;

39 } ià(
Ãxt
.
æag
 == 1) {

41 
·s£d
 = 
Œue
;

42 
cu¼
 = 
Ãxt
;

47 
cu¼
 = 
Ãxt
;

50 
i
++;

53 ià(!
·s£d
) {

54  
çl£
;

58 ià(
this
.
wdC¬dLi¡
 !ğ
nuÎ
) {

59 
Paœ
<
BoŞ—n
, 
SŒšg
[]> 
p
 : 
this
.
wdC¬dLi¡
) {

60 
boŞ—n
 
®low
 = 
p
.
f¡
;

61 
pos
 = 0;

62 
m
 = 0; m < 
p
.
¢d
.
Ëngth
; m++) {

63 
pos
 = 
·th
.
	`šdexOf
(
p
.
¢d
[
m
],…os);

64 ià(
pos
 == -1)

67 ià(
m
 =ğ
p
.
¢d
.
Ëngth
 - 1 && !
®low
) {

68 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
();

69 
j
 = 0; j < 
p
.
¢d
.
Ëngth
; j++) {

70 
buf
.
	`­³nd
(
p
.
¢d
[
j
]);

72  
çl£
;

73 } ià(
m
 =ğ
p
.
¢d
.
Ëngth
 - 1 && 
®low
) {

74 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
();

75 
j
 = 0; j < 
p
.
¢d
.
Ëngth
; j++) {

76 
buf
.
	`­³nd
(
p
.
¢d
[
j
]);

78  
Œue
;

83  
Œue
;

87 ià(
this
.
wdC¬dLi¡
 !ğ
nuÎ
) {

88 
Paœ
<
BoŞ—n
, 
SŒšg
> 
p
 : 
this
.
wdC¬dLi¡
) {

89 
boŞ—n
 
®low
 = 
p
.
f¡
;

90 
boŞ—n
 
m©ch
 = 
	`m©chWdC¬d
(
·th
, 
p
.
¢d
);

91 ià(
m©ch
) {

92 ià(!
®low
) {

93  
çl£
;

95 if(
®low
)

97  
Œue
;

107  
·s£d
;

111 @
Ov”ride


112 
public
 
boŞ—n
 
	$š™
(
SŒšg
[] 
¡r
) {

115 
SŒšg
 
s
 : 
¡r
) {

117 ià(
s
.
	`šdexOf
("*"è=ğs.
	`Ëngth
(è- 1 || s.
	`’dsW™h
("$")) {

118 
s
 = s.
	`sub¡ršg
(0, s.
	`Ëngth
() - 1);

120 ià(
s
.
	`cÚšs
("*")) {

121 ià(
wdC¬dLi¡
 =ğ
nuÎ
) {

122 
wdC¬dLi¡
 = 
Ãw
 
LškedLi¡
<
Paœ
<
BoŞ—n
, 
SŒšg
>>();

124 ià(
s
.
	`ch¬At
(0) == '-') {

125 
wdC¬dLi¡
.
	`add
(
Ãw
 
	`Paœ
(
çl£
, 
s
.
	`sub¡ršg
(1)));

127 
wdC¬dLi¡
.
	`add
(
Ãw
 
	`Paœ
(
Œue
, 
s
.
	`sub¡ršg
(1)));

132 
by‹
 
t
[] = 
s
.
	`g‘By‹s
();

133 
Tr›Node
 
cu¼
 = 
roÙ
;

134 
Tr›Node
 
Ãxt
 = 
nuÎ
;

135 
i
 = 1; i < 
t
.
Ëngth
; i++) {

136 ià(
i
 !ğ
t
.
Ëngth
 - 1) {

137 
Ãxt
 = 
cu¼
.
	`addOÃChd
((
t
[
i
]+128), (
by‹
) 0);

139 ià(
t
[0] =ğ(
by‹
) '-')

140 
Ãxt
 = 
cu¼
.
	`addOÃChd
((
t
[
i
]+128), (
by‹
) -1);

142 
Ãxt
 = 
cu¼
.
	`addOÃChd
((
t
[
i
]+128), (
by‹
) 1);

144 
cu¼
 = 
Ãxt
;

151 
by‹
 
æag
;

153 
public
 
	`Tr›Node
(
by‹
 
k
, by‹ 
æag
) {

154 
this
.
v
 = 
k
;

155 
this
.
æag
 = flag;

156 
chd
 = 
nuÎ
;

159 
public
 
SŒšg
 
	`toSŒšg
() {

160  
Ãw
 
	`SŒšg
(()
v
 + "\t" + 
SŒšg
.
	`v®ueOf
(
æag
));

171 
public
 
Tr›Node
 
	`addOÃChd
(
by‹
 
v
, by‹ 
æag
) {

172 ià(
this
.
chd
 =ğ
nuÎ
) {

173 
chd
 = 
Ãw
 
Tr›Node
[256];

174 
chd
[
v
] = 
Ãw
 
	`Tr›Node
(v, 
æag
);

178 ià(
this
.
chd
[
v
] =ğ
nuÎ
) {

179 
chd
[
v
] = 
Ãw
 
	`Tr›Node
(v, 
æag
);

183 ià((
chd
[
v
].
æag
 == 0) && (flag != 0)) {

185 
chd
[
v
].
æag
 = flag;

192  
chd
[
v
];

203 
public
 
Tr›Node
 
	`addOÃChd
(
v
, 
by‹
 
æag
) {

204 ià(
this
.
chd
 =ğ
nuÎ
) {

205 
chd
 = 
Ãw
 
Tr›Node
[256];

206 
chd
[
v
] = 
Ãw
 
	`Tr›Node
((
by‹
)v, 
æag
);

207  
chd
[
v
];

209 ià(
this
.
chd
[
v
] =ğ
nuÎ
) {

210 
chd
[
v
] = 
Ãw
 
	`Tr›Node
((
by‹
)v, 
æag
);

211  
chd
[
v
];

213 ià(
chd
[
v
].
æag
 == 0 && flag != 0) {

214 
chd
[
v
].
æag
 = flag;

215  
chd
[
v
];

217  
chd
[
v
];

222 
public
 
Tr›Node
 
	`g‘OÃChd
(
a
) {

223 ià(
this
.
chd
 =ğ
nuÎ
 ||his.chd[
a
] ==‚ull)

224  
nuÎ
;

226  
chd
[
a
];

228 
	}
}

	@com/zhongsou/spider/common/url/URLFilter.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿bË
;

29 
public
 
š‹rçû
 
URLF‹r
 
ex‹nds
 
	gCÚfigu¿bË
 {

31 
public
 
fš®
 
SŒšg
 
	gX_POINT_ID
 = 
URLF‹r
.
şass
.
g‘Name
();

35 
public
 
SŒšg
 
f‹r
(SŒšg 
u¾SŒšg
);

	@com/zhongsou/spider/common/url/URLFilterException.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 @
Suµ»ssW¬nšgs
("serial")

21 
public
 cÏs 
	cURLF‹rExû±iÚ
 
ex‹nds
 
	mExû±iÚ
 {

23 
public
 
	$URLF‹rExû±iÚ
() {

24 
	`su³r
();

27 
public
 
	$URLF‹rExû±iÚ
(
SŒšg
 
mes§ge
) {

28 
	`su³r
(
mes§ge
);

29 
	}
}

31 
public
 
	$URLF‹rExû±iÚ
(
SŒšg
 
mes§ge
, 
ThrowabË
 
ÿu£
) {

32 
	`su³r
(
mes§ge
, 
ÿu£
);

33 
	}
}

35 
public
 
	$URLF‹rExû±iÚ
(
ThrowabË
 
ÿu£
) {

36 
	`su³r
(
ÿu£
);

37 
	}
}

	@com/zhongsou/spider/common/url/URLFilters.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

21 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

22 
impÜt
 
	gjava
.
	gut
.
	gM­
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

25 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

26 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

28 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gObjeùCache
;

29 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gSpid”CÚfigu¿tiÚ
;

30 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
;

31 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
.
	gPlugšIm¶em’tiÚ
;

32 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugšP¬£r
;

35 
public
 cÏs 
	cURLF‹rs
 {

37 
´iv©e
 
	mURLF‹r
[] 
	mf‹rs
;

38 
public
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
URLF‹rs
.
şass
);

40 
public
 
	$URLF‹rs
(
CÚfigu¿tiÚ
 
cÚf
) {

41 
ObjeùCache
 
objeùCache
 = ObjeùCache.
	`g‘
(
cÚf
);

42 
this
.
f‹rs
 = (
URLF‹r
[]è
objeùCache
.
	`g‘Objeù
(URLF‹r.
şass
.
	`g‘Name
());

43 ià(
this
.
f‹rs
 =ğ
nuÎ
) {

44 
Œy
 {

45 
PlugšP¬£r
 
¶ugšP¬£r
 = PlugšP¬£r.
	`g‘In¡ªû
();

46 
Plugš
 
¶ugš
 = 
¶ugšP¬£r
.
	`g‘Plugš
(
URLF‹r
.
şass
.
	`g‘Name
());

47 
M­
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
m­
 = 
¶ugš
.
	`g‘Im¶em’tiÚm­
();

48 
Li¡
<
URLF‹r
> 
u¾f‹rs
 = 
Ãw
 
LškedLi¡
<URLFilter>();

49 
M­
.
EÁry
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
’Œy
 : 
m­
.
	`’ŒyS‘
()) {

51 
URLF‹r
 
u¾F‹r
 = 
nuÎ
;

52 
Œy
 {

55 
u¾F‹r
 = (
URLF‹r
è
objeùCache
.
	`g‘Objeù
(
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
().
	`Œim
());

56 ià(
u¾F‹r
 =ğ
nuÎ
) {

58 
u¾F‹r
 = (
URLF‹r
è
’Œy
.
	`g‘V®ue
().
	`ÃwIn¡ªû
(
cÚf
);

59 
objeùCache
.
	`£tObjeù
(
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
().
	`Œim
(), 
u¾F‹r
);

61 
u¾f‹rs
.
	`add
(
u¾F‹r
);

62 
LOG
.
	`šfo
("add‡ f‹r,f‹¸şassName="+
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
());

63 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

64 
e
.
	`´štSckT¿û
();

65 
LOG
.
	`w¬n
("URLNÜm®iz”s:PlugšRuÁimeExû±iÚ wh’ " + "š™Ÿlizšg u¾‚Üm®iz”…lugš " + 
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
() + " instance in getURLNormalizers "

71 
objeùCache
.
	`£tObjeù
(
URLF‹r
.
şass
.
	`g‘Name
(), 
u¾f‹rs
.
	`toA¼ay
(
Ãw
 URLF‹r[u¾f‹rs.
	`size
()]));

72 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

73 
throw
 
Ãw
 
	`RuÁimeExû±iÚ
(
e
);

75 
this
.
f‹rs
 = (
URLF‹r
[]è
objeùCache
.
	`g‘Objeù
(URLF‹r.
şass
.
	`g‘Name
());

80 
public
 
SŒšg
 
	$f‹r
(
SŒšg
 
u¾SŒšg
è
throws
 
URLF‹rExû±iÚ
 {

81 
SŒšg
 
¤c
=
u¾SŒšg
;

82 
i
 = 0; i < 
this
.
f‹rs
.
Ëngth
; i++) {

83 ià(
u¾SŒšg
 =ğ
nuÎ
)

84  
nuÎ
;

85 
u¾SŒšg
 = 
this
.
f‹rs
[
i
].
	`f‹r
(urlString);

86 if(
u¾SŒšg
==
nuÎ
)

88 
LOG
.
	`debug
("u¾ "+
¤c
+" i f‹»d by "+
f‹rs
[
i
].
	`g‘CÏss
().
	`g‘Sim¶eName
()+" filter");

91  
u¾SŒšg
;

92 
	}
}

94 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

95 
URLF‹rs
 
u¾F‹rs
 = 
Ãw
 
	`URLF‹rs
(
Spid”CÚfigu¿tiÚ
.
	`ü—‹
());

96 
Œy
 {

97 
SŒšg
 
s
="http://shenzhen.baixing.com/zhengzu/?query=%E5%A4%A7%E5%BA%99%E6%9D%91&%E4%BB%B7%E6%A0%BC=%5B4000+TO+%2A%5D";

98 
Sy¡em
.
out
.
	`´šn
(
s
);

99 
t1
=
Sy¡em
.
	`cu¼’tTimeMlis
();

100 
SŒšg
 
m
=
u¾F‹rs
.
	`f‹r
(
s
);

101 
t2
=
Sy¡em
.
	`cu¼’tTimeMlis
();

102 
t3
=
Sy¡em
.
	`cu¼’tTimeMlis
();

103 
SŒšg
 
m2
=
u¾F‹rs
.
	`f‹r
(
s
);

104 
t4
=
Sy¡em
.
	`cu¼’tTimeMlis
();

105 
Sy¡em
.
out
.
	`´šn
("timcÚsume="+(
t2
-
t1
)+"\tm="+
m
+"\n"+
m2
+"\t"+(
t4
-
t3
));

106 } 
	`ÿtch
 (
URLF‹rExû±iÚ
 
e
) {

108 
e
.
	`´štSckT¿û
();

110 
	}
}

	@com/zhongsou/spider/common/url/URLNormalizer.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

3 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿bË
;

8 
public
 
š‹rçû
 
URLNÜm®iz”
 
ex‹nds
 
	gCÚfigu¿bË
 {

11 
public
 
fš®
 
SŒšg
 
	gX_POINT_ID
 = 
URLNÜm®iz”
.
şass
.
g‘Name
();

14 
public
 
SŒšg
 
nÜm®ize
(SŒšg 
u¾SŒšg
, SŒšg 
scİe
è
throws
 
	gM®fÜmedURLExû±iÚ
;

	@com/zhongsou/spider/common/url/URLNormalizers.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

20 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

21 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

22 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

23 
impÜt
 
	gjava
.
	gut
.
	gM­
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

26 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

27 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

29 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gObjeùCache
;

30 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gSpid”CÚfigu¿tiÚ
;

31 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
;

32 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugš
.
	gPlugšIm¶em’tiÚ
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
.
	gPlugšP¬£r
;

35 
public
 
fš®
 cÏs 
	cURLNÜm®iz”s
 {

37 
public
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
URLNÜm®iz”s
.
şass
);

38 
public
 
SŒšg
 
	mSCOPE_DEFAULT
 = "default";

39 
´iv©e
 
fš®
 
	mURLNÜm®iz”
[] 
	mEMPTY_NORMALIZERS
 = 
Ãw
 
URLNÜm®iz”
[0];

41 
´iv©e
 
CÚfigu¿tiÚ
 
	mcÚf
;

43 
´iv©e
 
	mURLNÜm®iz”
[] 
	mnÜm®iz”s
 = 
EMPTY_NORMALIZERS
;

45 
´iv©e
 
	mloİCouÁ
;

47 
public
 
	$URLNÜm®iz”s
(
CÚfigu¿tiÚ
 
cÚf
) {

48 
this
.
cÚf
 = conf;

50 
ObjeùCache
 
objeùCache
 = ObjeùCache.
	`g‘
(
cÚf
);

51 ià(
nÜm®iz”s
 =ğ
EMPTY_NORMALIZERS
) {

52 
nÜm®iz”s
 = (
URLNÜm®iz”
[]è
objeùCache
.
	`g‘Objeù
(URLNÜm®iz”.
X_POINT_ID
);

53 ià(
nÜm®iz”s
 =ğ
nuÎ
) {

54 
nÜm®iz”s
 = 
	`g‘URLNÜm®iz”s
();

55 
objeùCache
.
	`£tObjeù
(
URLNÜm®iz”
.
X_POINT_ID
, 
nÜm®iz”s
);

59 
loİCouÁ
 = 
cÚf
.
	`g‘IÁ
("urlnormalizer.loop.count", 1);

62 
URLNÜm®iz”
[] 
	$g‘URLNÜm®iz”s
() {

63 
PlugšP¬£r
 
¶ugšP¬£r
 = PlugšP¬£r.
	`g‘In¡ªû
();

64 
Plugš
 
¶ugš
 = 
¶ugšP¬£r
.
	`g‘Plugš
(
URLNÜm®iz”
.
şass
.
	`g‘Name
());

65 
M­
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
m­
 = 
¶ugš
.
	`g‘Im¶em’tiÚm­
();

66 
ObjeùCache
 
objeùCache
 = ObjeùCache.
	`g‘
(
cÚf
);

67 
Li¡
<
URLNÜm®iz”
> 
nÜm®iz”s
 = 
Ãw
 
LškedLi¡
<URLNormalizer>();

68 
M­
.
EÁry
<
IÁeg”
, 
PlugšIm¶em’tiÚ
> 
’Œy
 : 
m­
.
	`’ŒyS‘
()) {

70 
URLNÜm®iz”
 
nÜm®iz”
 = 
nuÎ
;

71 
Œy
 {

73 
nÜm®iz”
 = (
URLNÜm®iz”
è
objeùCache
.
	`g‘Objeù
(
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
());

74 ià(
nÜm®iz”
 =ğ
nuÎ
) {

76 
nÜm®iz”
 = (
URLNÜm®iz”
è
’Œy
.
	`g‘V®ue
().
	`ÃwIn¡ªû
(
cÚf
);

77 
objeùCache
.
	`£tObjeù
(
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
(), 
nÜm®iz”
);

79 
nÜm®iz”s
.
	`add
(
nÜm®iz”
);

80 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

81 
e
.
	`´štSckT¿û
();

82 
LOG
.
	`w¬n
("URLNÜm®iz”s:PlugšRuÁimeExû±iÚ wh’ " + "š™Ÿlizšg u¾‚Üm®iz”…lugš " + 
’Œy
.
	`g‘V®ue
().
	`g‘CÏssName
() + " instance in getURLNormalizers "

86  
nÜm®iz”s
.
	`toA¼ay
(
Ãw
 
URLNÜm®iz”
[nÜm®iz”s.
	`size
()]);

87 
	}
}

100 
public
 
SŒšg
 
	$nÜm®ize
(
SŒšg
 
u¾SŒšg
, SŒšg 
scİe
è
throws
 
M®fÜmedURLExû±iÚ
 {

102 
Œy
 {

103 
SŒšg
 
š™ŸlSŒšg
 = 
u¾SŒšg
;

104 
k
 = 0; k < 
loİCouÁ
; k++) {

105 
i
 = 0; i < 
this
.
nÜm®iz”s
.
Ëngth
; i++) {

106 ià(
u¾SŒšg
 =ğ
nuÎ
)

107  
nuÎ
;

108 
u¾SŒšg
 = 
this
.
nÜm®iz”s
[
i
].
	`nÜm®ize
(u¾SŒšg, 
scİe
);

110 ià(
š™ŸlSŒšg
.
	`equ®s
(
u¾SŒšg
))

112 
š™ŸlSŒšg
 = 
u¾SŒšg
;

114  
u¾SŒšg
;

115 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

116 
e
.
	`´štSckT¿û
();

117  
nuÎ
;

119 
	}
}

121 
public
 
SŒšg
 
	$nÜm®ize
(
SŒšg
 
u¾SŒšg
è
throws
 
M®fÜmedURLExû±iÚ
 {

122  
this
.
	`nÜm®ize
(
u¾SŒšg
, 
SCOPE_DEFAULT
);

123 
	}
}

125 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

126 
URLNÜm®iz”s
 
nÜm®iz”
 = 
Ãw
 
	`URLNÜm®iz”s
(
Spid”CÚfigu¿tiÚ
.
	`ü—‹
());

127 
Œy
 {

128 
Sy¡em
.
out
.
	`´šn
(
nÜm®iz”
.
	`nÜm®ize
("h‰p://‹¡.com?&j£ssiÚid=3232&a=#dça", 
URLNÜm®iz”s
.
SCOPE_DEFAULT
));

129 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e
) {

131 
e
.
	`´štSckT¿û
();

133 
	}
}

	@com/zhongsou/spider/common/url/UrlValidator.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
;

19 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gM©ch”
;

20 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹º
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

51 
public
 cÏs 
	cU¾V®id©Ü
 
im¶em’ts
 
	mURLF‹r
 {

53 
´iv©e
 
fš®
 
SŒšg
 
	mALPHA_CHARS
 = "a-zA-Z";

55 
´iv©e
 
fš®
 
SŒšg
 
	mALPHA_NUMERIC_CHARS
 = 
ALPHA_CHARS
 + "\\d";

57 
´iv©e
 
fš®
 
SŒšg
 
	mSPECIAL_CHARS
 = ";/@&=,.?:+$";

59 
´iv©e
 
fš®
 
SŒšg
 
	mVALID_CHARS
 = "[^\\s" + 
SPECIAL_CHARS
 + "]";

61 
´iv©e
 
fš®
 
SŒšg
 
	mSCHEME_CHARS
 = 
ALPHA_CHARS
;

64 
´iv©e
 
fš®
 
SŒšg
 
	mAUTHORITY_CHARS
 = 
ALPHA_NUMERIC_CHARS
 + "\\-\\.";

66 
´iv©e
 
fš®
 
SŒšg
 
	mATOM
 = 
VALID_CHARS
 + '+';

71 
´iv©e
 
fš®
 
P©‹º
 
	mURL_PATTERN
 =

72 
P©‹º
.
compe
("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)" +

78 
´iv©e
 
fš®
 
	mPARSE_URL_SCHEME
 = 2;

83 
´iv©e
 
fš®
 
	mPARSE_URL_AUTHORITY
 = 4;

85 
´iv©e
 
fš®
 
	mPARSE_URL_PATH
 = 5;

87 
´iv©e
 
fš®
 
	mPARSE_URL_QUERY
 = 7;

92 
´iv©e
 
fš®
 
P©‹º
 
	mSCHEME_PATTERN
 =

93 
P©‹º
.
compe
("^[" + 
SCHEME_CHARS
 + "]+");

95 
´iv©e
 
fš®
 
P©‹º
 
	mAUTHORITY_PATTERN
 =

96 
P©‹º
.
compe
("^([" + 
AUTHORITY_CHARS
 + "]*)(:\\d*)?(.*)?");

98 
´iv©e
 
fš®
 
	mPARSE_AUTHORITY_HOST_IP
 = 1;

100 
´iv©e
 
fš®
 
	mPARSE_AUTHORITY_PORT
 = 2;

105 
´iv©e
 
fš®
 
	mPARSE_AUTHORITY_EXTRA
 = 3;

107 
´iv©e
 
fš®
 
P©‹º
 
	mPATH_PATTERN
 =

108 
P©‹º
.
compe
("^(/[-\\w:@&?=+,.!/~*'%$_;\\(\\)]*)?$");

110 
´iv©e
 
fš®
 
P©‹º
 
	mQUERY_PATTERN
 = P©‹º.
compe
("^(.*)$");

112 
´iv©e
 
fš®
 
P©‹º
 
	mLEGAL_ASCII_PATTERN
 =

113 
P©‹º
.
compe
("^[\\x21-\\x7E]+$");

115 
´iv©e
 
fš®
 
P©‹º
 
	mIP_V4_DOMAIN_PATTERN
 =

116 
P©‹º
.
compe
("^(\\d{1,3})[.](\\d{1,3})[.](\\d{1,3})[.](\\d{1,3})$");

118 
´iv©e
 
fš®
 
P©‹º
 
	mDOMAIN_PATTERN
 =

119 
P©‹º
.
compe
("^" + 
ATOM
 + "(\\." + ATOM + ")*$");

121 
´iv©e
 
fš®
 
P©‹º
 
	mPORT_PATTERN
 =

122 
P©‹º
.
compe
("^:(\\d{1,5})$");

124 
´iv©e
 
fš®
 
P©‹º
 
	mATOM_PATTERN
 =

125 
P©‹º
.
compe
("(" + 
ATOM
 + ")");

127 
´iv©e
 
fš®
 
P©‹º
 
	mALPHA_PATTERN
 =

128 
P©‹º
.
compe
("^[" + 
ALPHA_CHARS
 + "]");

130 
´iv©e
 
CÚfigu¿tiÚ
 
	mcÚf
;

132 
public
 
SŒšg
 
	$f‹r
(
SŒšg
 
u¾SŒšg
) {

133  
	`isV®id
(
u¾SŒšg
è? u¾SŒšg : 
nuÎ
;

136 
public
 
CÚfigu¿tiÚ
 
	$g‘CÚf
() {

137  
cÚf
;

138 
	}
}

140 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

141 
this
.
cÚf
 = conf;

142 
	}
}

151 
´iv©e
 
boŞ—n
 
	$isV®id
(
SŒšg
 
v®ue
) {

152 ià(
v®ue
 =ğ
nuÎ
) {

153  
çl£
;

156 
M©ch”
 
m©chU¾P©
 = 
URL_PATTERN
.
	`m©ch”
(
v®ue
);

157 ià(!
LEGAL_ASCII_PATTERN
.
	`m©ch”
(
v®ue
).
	`m©ches
()) {

158  
çl£
;

162 ià(!
m©chU¾P©
.
	`m©ches
()) {

163  
çl£
;

166 ià(!
	`isV®idScheme
(
m©chU¾P©
.
	`group
(
PARSE_URL_SCHEME
))) {

167  
çl£
;

170 ià(!
	`isV®idAuthÜ™y
(
m©chU¾P©
.
	`group
(
PARSE_URL_AUTHORITY
))) {

171  
çl£
;

174 ià(!
	`isV®idP©h
(
m©chU¾P©
.
	`group
(
PARSE_URL_PATH
))) {

175  
çl£
;

178 ià(!
	`isV®idQu”y
(
m©chU¾P©
.
	`group
(
PARSE_URL_QUERY
))) {

179  
çl£
;

182  
Œue
;

183 
	}
}

193 
´iv©e
 
boŞ—n
 
	$isV®idScheme
(
SŒšg
 
scheme
) {

194 ià(
scheme
 =ğ
nuÎ
) {

195  
çl£
;

198  
SCHEME_PATTERN
.
	`m©ch”
(
scheme
).
	`m©ches
();

199 
	}
}

208 
´iv©e
 
boŞ—n
 
	$isV®idAuthÜ™y
(
SŒšg
 
authÜ™y
) {

209 ià(
authÜ™y
 =ğ
nuÎ
) {

210  
çl£
;

213 
M©ch”
 
authÜ™yM©ch”
 = 
AUTHORITY_PATTERN
.
	`m©ch”
(
authÜ™y
);

214 ià(!
authÜ™yM©ch”
.
	`m©ches
()) {

215  
çl£
;

218 
boŞ—n
 
V4Add»ss
 = 
çl£
;

219 
boŞ—n
 
ho¡Çme
 = 
çl£
;

221 
SŒšg
 
ho¡IP
 = 
authÜ™yM©ch”
.
	`group
(
PARSE_AUTHORITY_HOST_IP
);

222 
M©ch”
 
m©chIPV4P©
 = 
IP_V4_DOMAIN_PATTERN
.
	`m©ch”
(
ho¡IP
);

223 
V4Add»ss
 = 
m©chIPV4P©
.
	`m©ches
();

225 ià(
V4Add»ss
) {

227 
i
 = 1; i <= 4; i++) {

228 
SŒšg
 
Segm’t
 = 
m©chIPV4P©
.
	`group
(
i
);

229 ià(
Segm’t
 =ğ
nuÎ
 || ipSegm’t.
	`Ëngth
() <= 0) {

230  
çl£
;

233 
Œy
 {

234 ià(
IÁeg”
.
	`·r£IÁ
(
Segm’t
) > 255) {

235  
çl£
;

237 } 
	`ÿtch
(
Numb”FÜm©Exû±iÚ
 
e
) {

238  
çl£
;

244 
ho¡Çme
 = 
DOMAIN_PATTERN
.
	`m©ch”
(
ho¡IP
).
	`m©ches
();

248 ià(
ho¡Çme
) {

251 [] 
ch¬s
 = 
ho¡IP
.
	`toCh¬A¼ay
();

252 
size
 = 1;

253 
i
=0; i<
ch¬s
.
Ëngth
; i++) {

254 if(
ch¬s
[
i
] == '.') {

255 
size
++;

258 
SŒšg
[] 
domašSegm’t
 = 
Ãw
 SŒšg[
size
];

259 
£gCouÁ
 = 0;

260 
£gL’
 = 0;

261 
M©ch”
 
©omM©ch”
 = 
ATOM_PATTERN
.
	`m©ch”
(
ho¡IP
);

263 
©omM©ch”
.
	`fšd
()) {

264 
domašSegm’t
[
£gCouÁ
] = 
©omM©ch”
.
	`group
();

265 
£gL’
 = 
domašSegm’t
[
£gCouÁ
].
	`Ëngth
() + 1;

266 
ho¡IP
 = (
£gL’
 >ğho¡IP.
	`Ëngth
()) ? ""

267 : 
ho¡IP
.
	`sub¡ršg
(
£gL’
);

268 
£gCouÁ
++;

270 
SŒšg
 
tİLev–
 = 
domašSegm’t
[
£gCouÁ
 - 1];

271 ià(
tİLev–
.
	`Ëngth
() < 2 ||opLevel.length() > 4) {

272  
çl£
;

276 ià(!
ALPHA_PATTERN
.
	`m©ch”
(
tİLev–
.
	`sub¡ršg
(0, 1)).
	`m©ches
()) {

277  
çl£
;

281 ià(
£gCouÁ
 < 2) {

282  
çl£
;

286 ià(!
ho¡Çme
 && !
V4Add»ss
) {

287  
çl£
;

290 
SŒšg
 
pÜt
 = 
authÜ™yM©ch”
.
	`group
(
PARSE_AUTHORITY_PORT
);

291 ià(
pÜt
 !ğ
nuÎ
) {

292 ià(!
PORT_PATTERN
.
	`m©ch”
(
pÜt
).
	`m©ches
()) {

293  
çl£
;

297 
SŒšg
 
exŒa
 = 
authÜ™yM©ch”
.
	`group
(
PARSE_AUTHORITY_EXTRA
);

298  
	`isBÏnkOrNuÎ
(
exŒa
);

299 
	}
}

308 
´iv©e
 
boŞ—n
 
	$isBÏnkOrNuÎ
(
SŒšg
 
v®ue
) {

309  ((
v®ue
 =ğ
nuÎ
è|| (v®ue.
	`Œim
().
	`Ëngth
() == 0));

310 
	}
}

318 
´iv©e
 
boŞ—n
 
	$isV®idP©h
(
SŒšg
 
·th
) {

319 ià(
·th
 =ğ
nuÎ
) {

320  
çl£
;

323 ià(!
PATH_PATTERN
.
	`m©ch”
(
·th
).
	`m©ches
()) {

324  
çl£
;

327 
¦ash2CouÁ
 = 
	`couÁTok’
("//", 
·th
);

328 
¦ashCouÁ
 = 
	`couÁTok’
("/", 
·th
);

329 
dÙ2CouÁ
 = 
	`couÁTok’
("..", 
·th
);

331  (
dÙ2CouÁ
 <ğ0è|| ((
¦ashCouÁ
 - 
¦ash2CouÁ
 - 1) > dot2Count);

332 
	}
}

340 
´iv©e
 
boŞ—n
 
	$isV®idQu”y
(
SŒšg
 
qu”y
) {

341 ià(
qu”y
 =ğ
nuÎ
) {

342  
Œue
;

345  
QUERY_PATTERN
.
	`m©ch”
(
qu”y
).
	`m©ches
();

346 
	}
}

354 
´iv©e
 
	$couÁTok’
(
SŒšg
 
tok’
, SŒšg 
rg‘
) {

355 
tok’Index
 = 0;

356 
couÁ
 = 0;

357 
tok’Index
 != -1) {

358 
tok’Index
 = 
rg‘
.
	`šdexOf
(
tok’
,okenIndex);

359 ià(
tok’Index
 > -1) {

360 
tok’Index
++;

361 
couÁ
++;

364  
couÁ
;

365 
	}
}

	@com/zhongsou/spider/common/util/BitsUtil.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

3 
public
 cÏs 
	cB™sUt
 {

5 
	$£tB™
(
–e
, 
šdex
) {

6 
–e
 =ƒË | (1 << 
šdex
);

7  
–e
;

10 
	$ş—rB™
(
–e
, 
šdex
) {

11 
–e
 =ƒË & ~(1 << 
šdex
);

12  
–e
;

13 
	}
}

	@com/zhongsou/spider/common/util/MD5.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

3 
impÜt
 
	gjava
.
	g£cur™y
.
	gMes§geDige¡
;

4 
impÜt
 
	gjava
.
	g£cur™y
.
	gNoSuchAlgÜ™hmExû±iÚ
;

5 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

7 
public
 cÏs 
	cMD5
 {

8 
´iv©e
 
	mTh»adLoÿl
<
	mMes§geDige¡
> 
	mDIGESTER_FACTORY
 = 
Ãw
 
Th»adLoÿl
<
Mes§geDige¡
>() {

9 
´Ùeùed
 
Mes§geDige¡
 
š™ŸlV®ue
() {

10 
Œy
 {

11  
Mes§geDige¡
.
g‘In¡ªû
("MD5");

12 } 
ÿtch
 (
NoSuchAlgÜ™hmExû±iÚ
 
e
) {

13 
throw
 
Ãw
 
RuÁimeExû±iÚ
(
e
);

18 
´iv©e
 
	gby‹
[] 
	gdige¡
;

20 
public
 
	$MD5
() {

21 
this
.
dige¡
 = 
Ãw
 
by‹
[8];

22 
	}
}

24 
public
 
	eMD5L’
 {

25 
	geight
, 
	gsix‹n
;

28 
public
 
	$MD5
(
by‹
 
t
[], 
MD5L’
 
Ën
, 
¡¬t
è
throws
 
Exû±iÚ
 {

29 ià(
Ën
 =ğ
MD5L’
.
eight
) {

30 
dige¡
 = 
Ãw
 
by‹
[8];

31 ià(
t
.
Ëngth
 < 
¡¬t
 + 8)

32 
throw
 
Ãw
 
	`Exû±iÚ
("byte‡rrayo short");

33 
Sy¡em
.
	`¬¿ycİy
(
t
, 
¡¬t
, 
dige¡
, 0, 8);

35 
dige¡
 = 
Ãw
 
by‹
[16];

36 ià(
t
.
Ëngth
 < 
¡¬t
 + 16)

37 
throw
 
Ãw
 
	`Exû±iÚ
("byte‡rrayo short");

38 
Sy¡em
.
	`¬¿ycİy
(
t
, 
¡¬t
, 
dige¡
, 0, 16);

41 
	}
}

43 
public
 
	$MD5
(
MD5L’
 
Ën
) {

44 ià(
Ën
 =ğ
MD5L’
.
eight
) {

45 
dige¡
 = 
Ãw
 
by‹
[8];

47 
dige¡
 = 
Ãw
 
by‹
[16];

50 
	}
}

52 
public
 
	gby‹
[] 
	$g‘Dige¡
() {

53  
this
.
dige¡
;

54 
	}
}

56 
public
 
SŒšg
 
	$g‘HexSŒšg
() {

57 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
(
this
.
dige¡
.
Ëngth
 * 2);

58 
i
 = 0; i < 
this
.
dige¡
.
Ëngth
; i++) {

59 
b
 = 
dige¡
[
i
];

60 
buf
.
	`­³nd
(
HEX_DIGITS
[(
b
 >> 4) & 0xf]);

61 
buf
.
	`­³nd
(
HEX_DIGITS
[
b
 & 0xf]);

63  
buf
.
	`toSŒšg
();

64 
	}
}

66 
public
 
SŒšg
 
	$g‘HexSŒšg
(
boŞ—n
 
w™hFÏg
) {

67 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
(
this
.
dige¡
.
Ëngth
 * 2);

68 
i
 = 0; i < 
this
.
dige¡
.
Ëngth
; i++) {

69 
b
 = 
dige¡
[
i
];

70 ià(
w™hFÏg
)

71 
buf
.
	`­³nd
("\\x");

72 
buf
.
	`­³nd
(
HEX_DIGITS
[(
b
 >> 4) & 0xf]);

73 
buf
.
	`­³nd
(
HEX_DIGITS
[
b
 & 0xf]);

75  
buf
.
	`toSŒšg
();

76 
	}
}

78 
public
 
	$£t
(
MD5
 
Ùh”
) {

79 ià(
this
.
dige¡
.
Ëngth
 !ğ
Ùh”
.digest.length) {

80 
this
.
dige¡
 = 
Ãw
 
by‹
[
Ùh”
.dige¡.
Ëngth
];

82 
Sy¡em
.
	`¬¿ycİy
(
Ùh”
.
	`g‘Dige¡
(), 0, 
this
.
dige¡
, 0, oth”.g‘Dige¡().
Ëngth
);

83 
	}
}

85 
public
 
MD5
 
	$dige¡16
(
by‹
[] 
d©a
) {

86  
	`dige¡16
(
d©a
, 0, d©a.
Ëngth
);

87 
	}
}

89 
public
 
MD5
 
	$dige¡8
(
by‹
[] 
d©a
) {

90  
	`dige¡8
(
d©a
, 0, d©a.
Ëngth
);

91 
	}
}

93 
public
 
SŒšg
 
	$dige¡8
(
SŒšg
 
¡r
) {

94  
	`dige¡8
(
¡r
.
	`g‘By‹s
()).
	`g‘HexSŒšg
();

95 
	}
}

97 
public
 
SŒšg
 
	$dige¡16
(
SŒšg
 
¡r
) {

98  
	`dige¡16
(
¡r
.
	`g‘By‹s
()).
	`g‘HexSŒšg
();

99 
	}
}

101 
public
 
MD5
 
	$dige¡8
(
by‹
[] 
d©a
, 
¡¬t
, 
Ën
) {

102 
by‹
[] 
dige¡
;

103 
Mes§geDige¡
 
dige¡”
 = 
DIGESTER_FACTORY
.
	`g‘
();

104 
dige¡”
.
	`upd©e
(
d©a
, 
¡¬t
, 
Ën
);

105 
dige¡
 = 
dige¡”
.
	`dige¡
();

106 
Œy
 {

107  
Ãw
 
	`MD5
(
dige¡
, 
MD5L’
.
eight
, 0);

108 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

110 
e
.
	`´štSckT¿û
();

111  
nuÎ
;

113 
	}
}

115 
public
 
MD5
 
	$dige¡16
(
by‹
[] 
d©a
, 
¡¬t
, 
Ën
) {

116 
by‹
[] 
dige¡
;

117 
Mes§geDige¡
 
dige¡”
 = 
DIGESTER_FACTORY
.
	`g‘
();

118 
dige¡”
.
	`upd©e
(
d©a
, 
¡¬t
, 
Ën
);

119 
dige¡
 = 
dige¡”
.
	`dige¡
();

120 
Œy
 {

121  
Ãw
 
	`MD5
(
dige¡
, 
MD5L’
.
six‹n
, 0);

122 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

124 
e
.
	`´štSckT¿û
();

125  
nuÎ
;

127 
	}
}

129 
´iv©e
 
fš®
 [] 
	gHEX_DIGITS
 = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f' };

131 
public
 
SŒšg
 
	$toSŒšg
() {

132 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
(
this
.
dige¡
.
Ëngth
 * 2);

133 
i
 = 0; i < 
this
.
dige¡
.
Ëngth
; i++) {

134 
b
 = 
dige¡
[
i
];

135 
buf
.
	`­³nd
(
HEX_DIGITS
[(
b
 >> 4) & 0xf]);

136 
buf
.
	`­³nd
(
HEX_DIGITS
[
b
 & 0xf]);

138  
buf
.
	`toSŒšg
();

139 
	}
}

141 
public
 
	$hashCode
() {

142 
t
 = 0;

143 
i
 = 0; i < 
this
.
dige¡
.
Ëngth
; i++) {

144 
t
 +ğ
this
.
dige¡
[
i
];

146  
t
;

147 
	}
}

149 @
Ov”ride


150 
public
 
boŞ—n
 
	$equ®s
(
Objeù
 
obj
) {

152 ià(!(
obj
 
š¡ªûof
 
MD5
))

153  
çl£
;

154 
MD5
 
o
 = (MD5è
obj
;

155 ià(
o
 =ğ
nuÎ
 || 
this
.
dige¡
 =ğnuÎ || o.dige¡.
Ëngth
 !=his.digest.length)

156  
çl£
;

158  
A¼ays
.
	`equ®s
(
o
.
dige¡
, 
this
.digest);

160 
	}
}

162 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

163 
MD5
 
md5
 = MD5.
	`dige¡8
("h‰p://hxs.ucbriâocs.lw¤pquµtb›cqv/myfv/njo/lypfg±dza/qpmdo/cszuo/ç/m“—/gxxgwszpx".
	`g‘By‹s
());

164 
Sy¡em
.
out
.
	`´šn
(
md5
.
	`g‘HexSŒšg
());

165 
	}
}

	@com/zhongsou/spider/common/util/NetwokUtil.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

3 
public
 cÏs 
	cN‘wokUt
 {

6 
SŒšg
 
	mt
;

	@com/zhongsou/spider/common/util/NumberUtil.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

3 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

4 
impÜt
 
	gjava
.
	g‹xt
.
	gP¬£Exû±iÚ
;

5 
impÜt
 
	gjava
.
	gut
.
	gD©e
;

7 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

9 
impÜt
 
	guÿr
.
	gunid©a
.
	gut
.
	gFÜm©
;

11 
public
 cÏs 
	cNumb”Ut
 {

12 
´iv©e
 
fš®
 [] 
	mHEX_DIGITS
 = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f' };

14 
D©eFÜm©
 
	gd©eFÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyyMMddHHmmss");

16 
public
 
	gby‹
[] 
	$cÚv”tIÁToC
(
num
) {

17 
by‹
 
a
[] = 
Ãw
 byte[4];

18 
i
 = 0; i < 4; i++) {

19 
a
[
i
] = (
by‹
è((
num
 >> (i * 8)) & 0xff);

21  
a
;

22 
	}
}

24 
public
 
	gby‹
[] 
	$cÚv”tIÁToShÜtC
(
num
) {

25 
by‹
 
a
[] = 
Ãw
 byte[2];

26 
i
 = 0; i < 2; i++) {

27 
a
[
i
] = (
by‹
è((
num
 >> (i * 8)) & 0xff);

29  
a
;

30 
	}
}

32 
public
 
	$b™_couÁ_¥¬£
(
x
)

35 
n
 = 0;

36 
x
 != 0) {

37 ++
n
;

38 
x
 &= (x - 1);

40  
n
;

41 
	}
}

43 
public
 
	$»adShÜt
(
by‹
 
a
[], 
off£t
) {

44 
num
 = 0;

45 
i
 = 0; i <= 1; i++) {

46 
num
 +ğ((
a
[
off£t
 + 
i
] & 0xff) << (i * 8));

48  
num
;

49 
	}
}

51 
public
 
	$»adIÁ
(
by‹
 
a
[], 
off£t
) {

52 
num
 = 0;

53 
i
 = 0; i <= 3; i++) {

54 
num
 +ğ((
a
[
off£t
 + 
i
] & 0xff) << (i * 8));

56  
num
;

57 
	}
}

59 
public
 
	gby‹
[] 
	$cÚv”tLÚgToC
(
v®
) {

60 
by‹
[] 
b
 = 
Ãw
 byte[8];

61 
i
 = 0; i < 7; i++) {

62 
b
[
i
] = (
by‹
è
v®
;

63 
v®
 >>>= 8;

65 
b
[7] = (
by‹
è
v®
;

66  
b
;

67 
	}
}

69 
public
 
	$»adFlßt
(
by‹
 
a
[], 
off£t
) {

70 
m
 = 
	`»adIÁ
(
a
, 
off£t
);

71  
Flßt
.
	`štB™sToFlßt
(
m
);

72 
	}
}

74 
public
 
	$»adLÚg
(
by‹
 
a
[], 
off£t
) {

75 
num
 = 0;

76 
m
 = 0;

77 
i
 = 0; i <= 7; i++) {

78 
m
 = ((
a
[
off£t
 + 
i
] & 0xff));

79 
m
 = m << (
i
 * 8);

80 
num
 +ğ
m
;

82  
num
;

83 
	}
}

85 
public
 
	$by‹sToIÁ
(
by‹
 
by‹s
[], 
off£t
, 
Ëngth
è
throws
 
Exû±iÚ
 {

86 ià(
Ëngth
 > 4 || 
off£t
 +†’gth > 
by‹s
.length) {

87 
throw
 
Ãw
 
	`Exû±iÚ
("byteso†ong");

89 
n
 = 0;

90 
i
 = 
off£t
; i < (off£ˆ+ 
Ëngth
); i++) {

91 
n
 <<= 8;

92 
n
 ^ğ
by‹s
[
i
] & 0xFF;

94  
n
;

95 
	}
}

97 
public
 
	$ÿlNumReduû
(
»cÜdSum
, 
ãtchRecÜd
, 
”rÜBound¬y
, 
mšReduû
) {

98 ià(
ãtchRecÜd
 >ğ
»cÜdSum
) {

101 
ÚeP¬t
 = 0;

102 
m
 = 
mšReduû
;

103 
Ëá
 = 0;

104 
Ëá2
 = 0;

105 
Ëá3
 = 0;

106 
Ëá4
 = 0;

107 
i
 = 
mšReduû
; i <= minReduce * 4; i++) {

108 
ÚeP¬t
 = 
»cÜdSum
 / 
i
;

109 
Ëá
 = 
»cÜdSum
 % 
ÚeP¬t
;

110 
Ëá2
 = 
ãtchRecÜd
 % 
ÚeP¬t
;

111 
Ëá3
 = 
M©h
.
	`abs
(
Ëá2
 - 
ÚeP¬t
);

112 
Ëá4
 = 
M©h
.
	`mš
(
Ëá2
, 
Ëá3
);

113 
Sy¡em
.
out
.
	`´šn
("·¹=" + 
ÚeP¬t
 + "†eá=" + 
Ëá
 + "†eá2=" + 
Ëá2
 + "†eá3=" + 
M©h
.
	`abs
Öeá2 - oÃP¬tè+ "†eá4=" + 
Ëá4
);

114 ià(
Ëá
 < 
”rÜBound¬y
 && (
Ëá2
 <ƒrrorBoundary)) {

115  
i
;

118  
mšReduû
;

119 
	}
}

121 
public
 
SŒšg
 
	$g‘HexSŒšg
(
by‹
 
a
[]) {

122 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
();

123 
i
 = 0; 
a
!=
nuÎ
&&˜<‡.
Ëngth
; i++) {

124 
b
 = 
a
[
i
];

125 
buf
.
	`­³nd
(
HEX_DIGITS
[(
b
 >> 4) & 0xf]);

126 
buf
.
	`­³nd
(
HEX_DIGITS
[
b
 & 0xf]);

128  
buf
.
	`toSŒšg
();

130 
	}
}

132 
public
 
SŒšg
 
	$g‘HexSŒšg
(
by‹
 
a
[], 
off£t
, 
Ën
) {

133 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
();

134 
i
 = 
off£t
; i < 
Ën
 && off£ˆ+ i < 
a
.
Ëngth
; i++) {

135 
b
 = 
a
[
i
];

136 
buf
.
	`­³nd
(
HEX_DIGITS
[(
b
 >> 4) & 0xf]);

137 
buf
.
	`­³nd
(
HEX_DIGITS
[
b
 & 0xf]);

139  
buf
.
	`toSŒšg
();

141 
	}
}

143 
fš®
 [] 
	gdig™s
 = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w',

146 
public
 
SŒšg
 
	$g‘Bš¬ySŒšg
(
by‹
 
a
[]) {

147 
SŒšgBufãr
 
buf
 = 
Ãw
 
	`SŒšgBufãr
();

148 
i
 = 0; i < 
a
.
Ëngth
; i++) {

149 
b
 = 
a
[
i
];

150 [] 
cbuf
 = 
Ãw
 [8];

151 
ch¬Pos
 = 8;

152 
¿dix
 = 1 << 1;

153 
mask
 = 
¿dix
 - 1;

155 
cbuf
[--
ch¬Pos
] = 
dig™s
[
b
 & 
mask
];

156 
b
 >>>= 1;

157 } 
b
 != 0);

158 
ch¬Pos
--; charPos >= 0; charPos--) {

159 
cbuf
[
ch¬Pos
] = '0';

161 
buf
.
	`­³nd
(
Ãw
 
	`SŒšg
(
cbuf
));

163  
buf
.
	`toSŒšg
();

164 
	}
}

166 
public
 
SŒšg
 
	$d©eSecÚdToSŒšg
(
ds
) {

167 
D©e
 
d©e
 = 
Ãw
 
	`D©e
(1È* 
ds
 * 1000);

168  
d©eFÜm©
.
	`fÜm©
(
d©e
);

169 
	}
}

171 
public
 
SŒšg
 
	$g‘Cu¼’tD©eSŒšg
() {

172 
D©e
 
d©e
 = 
Ãw
 
	`D©e
();

173  
d©eFÜm©
.
	`fÜm©
(
d©e
);

174 
	}
}

176 
public
 
	$·r£D©eToSecÚd
(
SŒšg
 
d©e¡r
è
throws
 
P¬£Exû±iÚ
 {

177 
Œy
 {

178 
D©e
 
d
 = 
d©eFÜm©
.
	`·r£
(
d©e¡r
.
	`Œim
());

179 
m
 = (è(
d
.
	`g‘Time
() / 1000);

180  
m
;

181 } 
	`ÿtch
 (
P¬£Exû±iÚ
 
e
) {

183 
e
.
	`´štSckT¿û
();

184 
Log
.
	`šfo
("”rÜ d©¡¸" + 
d©e¡r
);

185 
throw
 
e
;

188 
	}
}

190 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

191 
t
 = 
Numb”Ut
.
	`b™_couÁ_¥¬£
(11);

192 
Sy¡em
.
out
.
	`´šn
(
t
);

193 
	}
}

	@com/zhongsou/spider/common/util/ObjectCache.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

19 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

20 
impÜt
 
	gjava
.
	gut
.
	gW—kHashM­
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

23 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

24 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

29 
public
 cÏs 
	cObjeùCache
 {

31 
´iv©e
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
ObjeùCache
.
şass
);

33 
´iv©e
 
fš®
 
	mW—kHashM­
<
	mCÚfigu¿tiÚ
, 
	mObjeùCache
> 
	mCACHE
 =

34 
Ãw
 
W—kHashM­
<
CÚfigu¿tiÚ
, 
	mObjeùCache
>();

36 
´iv©e
 
fš®
 
	mHashM­
<
	mSŒšg
, 
	mObjeù
> 
	mobjeùM­
;

38 
´iv©e
 
	$ObjeùCache
() {

39 
objeùM­
 = 
Ãw
 
HashM­
<
SŒšg
, 
Objeù
>();

42 
public
 
ObjeùCache
 
	$g‘
(
CÚfigu¿tiÚ
 
cÚf
) {

43 
ObjeùCache
 
objeùCache
 = 
CACHE
.
	`g‘
(
cÚf
);

44 ià(
objeùCache
 =ğ
nuÎ
) {

45 
LOG
.
	`debug
("NØobjeù cachfound fÜ cÚf=" + 
cÚf


47 
objeùCache
 = 
Ãw
 
	`ObjeùCache
();

48 
CACHE
.
	`put
(
cÚf
, 
objeùCache
);

50  
objeùCache
;

51 
	}
}

53 
public
 
Objeù
 
	$g‘Objeù
(
SŒšg
 
key
) {

54  
objeùM­
.
	`g‘
(
key
);

55 
	}
}

57 
public
 
	$£tObjeù
(
SŒšg
 
key
, 
Objeù
 
v®ue
) {

58 
objeùM­
.
	`put
(
key
, 
v®ue
);

59 
	}
}

	@com/zhongsou/spider/common/util/PrefixStringMatcher.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

20 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

21 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

27 
public
 cÏs 
	cP»fixSŒšgM©ch”
 
ex‹nds
 
	mTr›SŒšgM©ch”
 {

34 
public
 
	$P»fixSŒšgM©ch”
(
SŒšg
[] 
´efixes
) {

35 
	`su³r
();

36 
i
ğ0; i < 
´efixes
.
Ëngth
; i++)

37 
	`addP©‹ºFÜw¬d
(
´efixes
[
i
]);

48 
public
 
	$P»fixSŒšgM©ch”
(
CŞËùiÚ
 
´efixes
) {

49 
	`su³r
();

50 
I‹¿tÜ
 
™”
ğ
´efixes
.
	`™”©Ü
();

51 
™”
.
	`hasNext
())

52 
	`addP©‹ºFÜw¬d
((
SŒšg
)
™”
.
	`Ãxt
());

53 
	}
}

59 
public
 
boŞ—n
 
	$m©ches
(
SŒšg
 
šput
) {

60 
Tr›Node
 
node
ğ
roÙ
;

61 
i
ğ0; i < 
šput
.
	`Ëngth
(); i++) {

62 
node
ğnode.
	`g‘Chd
(
šput
.
	`ch¬At
(
i
));

63 ià(
node
 =ğ
nuÎ
)

64  
çl£
;

65 ià(
node
.
	`isT”mš®
())

66  
Œue
;

68  
çl£
;

69 
	}
}

75 
public
 
SŒšg
 
	$shÜ‹¡M©ch
(
SŒšg
 
šput
) {

76 
Tr›Node
 
node
ğ
roÙ
;

77 
i
ğ0; i < 
šput
.
	`Ëngth
(); i++) {

78 
node
ğnode.
	`g‘Chd
(
šput
.
	`ch¬At
(
i
));

79 ià(
node
 =ğ
nuÎ
)

80  
nuÎ
;

81 ià(
node
.
	`isT”mš®
())

82  
šput
.
	`sub¡ršg
(0, 
i
+1);

84  
nuÎ
;

85 
	}
}

91 
public
 
SŒšg
 
	$lÚge¡M©ch
(
SŒšg
 
šput
) {

92 
Tr›Node
 
node
ğ
roÙ
;

93 
SŒšg
 
»suÉ
ğ
nuÎ
;

94 
i
ğ0; i < 
šput
.
	`Ëngth
(); i++) {

95 
node
ğnode.
	`g‘Chd
(
šput
.
	`ch¬At
(
i
));

96 ià(
node
 =ğ
nuÎ
)

98 ià(
node
.
	`isT”mš®
())

99 
»suÉ
ğ
šput
.
	`sub¡ršg
(0, 
i
+1);

101  
»suÉ
;

102 
	}
}

104 
public
 
fš®
 
	$maš
(
SŒšg
[] 
¬gv
) {

105 
P»fixSŒšgM©ch”
 
m©ch”
=

106 
Ãw
 
	`P»fixSŒšgM©ch”
(

107 
Ãw
 
SŒšg
[]

110 
SŒšg
[] 
‹¡s
= {"a", "ab", "abc", "abcdefg", "apple", "aa", "aac",

114 
i
ğ0; i < 
‹¡s
.
Ëngth
; i++) {

115 
Sy¡em
.
out
.
	`´šn
("‹¡šg: " + 
‹¡s
[
i
]);

116 
Sy¡em
.
out
.
	`´šn
(" m©ches: " + 
m©ch”
.
	`m©ches
(
‹¡s
[
i
]));

117 
Sy¡em
.
out
.
	`´šn
(" shÜ‹¡: " + 
m©ch”
.
	`shÜ‹¡M©ch
(
‹¡s
[
i
]));

118 
Sy¡em
.
out
.
	`´šn
("†Úge¡: " + 
m©ch”
.
	`lÚge¡M©ch
(
‹¡s
[
i
]));

120 
	}
}

	@com/zhongsou/spider/common/util/SpiderConfiguration.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

3 
impÜt
 
	gjava
.
	gut
.
	gM­
.
	gEÁry
;

4 
impÜt
 
	gjava
.
	gut
.
	gPrİ”t›s
;

5 
impÜt
 
	gjava
.
	gut
.
	gUUID
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

9 
public
 cÏs 
	cSpid”CÚfigu¿tiÚ
 
ex‹nds
 
	mCÚfigu¿tiÚ
 {

11 
public
 
fš®
 
SŒšg
 
	mUUID_KEY
 = "spider.conf.uuid";

13 
´iv©e
 
	$Spid”CÚfigu¿tiÚ
() {

16 
´iv©e
 
	$£tUUID
(
CÚfigu¿tiÚ
 
cÚf
) {

17 
UUID
 
uuid
 = UUID.
	`¿ndomUUID
();

18 
cÚf
.
	`£t
(
UUID_KEY
, 
uuid
.
	`toSŒšg
());

19 
	}
}

21 
public
 
SŒšg
 
	$g‘UUID
(
CÚfigu¿tiÚ
 
cÚf
) {

22  
cÚf
.
	`g‘
(
UUID_KEY
);

23 
	}
}

25 
public
 
CÚfigu¿tiÚ
 
	$ü—‹
() {

26 
CÚfigu¿tiÚ
 
cÚf
 = 
Ãw
 
	`CÚfigu¿tiÚ
(
çl£
);

27 
	`£tUUID
(
cÚf
);

28 
	`addSpid”Resourûs
(
cÚf
);

29  
cÚf
;

30 
	}
}

32 
public
 
CÚfigu¿tiÚ
 
	$ü—‹
(
boŞ—n
 
addNutchResourûs
, 
Prİ”t›s
 
nutchPrİ”t›s
) {

33 
CÚfigu¿tiÚ
 
cÚf
 = 
Ãw
 
	`CÚfigu¿tiÚ
();

34 
	`£tUUID
(
cÚf
);

35 ià(
addNutchResourûs
) {

36 
	`addSpid”Resourûs
(
cÚf
);

38 
EÁry
<
Objeù
, Objeù> 
e
 : 
nutchPrİ”t›s
.
	`’ŒyS‘
()) {

39 
cÚf
.
	`£t
(
e
.
	`g‘Key
().
	`toSŒšg
(),ƒ.
	`g‘V®ue
().toString());

41  
cÚf
;

42 
	}
}

44 
´iv©e
 
CÚfigu¿tiÚ
 
	$addSpid”Resourûs
(
CÚfigu¿tiÚ
 
cÚf
) {

45 
cÚf
.
	`addResourû
("spider-default.xml");

46  
cÚf
;

47 
	}
}

	@com/zhongsou/spider/common/util/SuffixStringMatcher.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

20 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

21 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

27 
public
 cÏs 
	cSuffixSŒšgM©ch”
 
ex‹nds
 
	mTr›SŒšgM©ch”
 {

33 
public
 
	$SuffixSŒšgM©ch”
(
SŒšg
[] 
suffixes
) {

34 
	`su³r
();

35 
i
ğ0; i < 
suffixes
.
Ëngth
; i++)

36 
	`addP©‹ºBackw¬d
(
suffixes
[
i
]);

44 
public
 
	$SuffixSŒšgM©ch”
(
CŞËùiÚ
 
suffixes
) {

45 
	`su³r
();

46 
I‹¿tÜ
 
™”
ğ
suffixes
.
	`™”©Ü
();

47 
™”
.
	`hasNext
())

48 
	`addP©‹ºBackw¬d
((
SŒšg
)
™”
.
	`Ãxt
());

49 
	}
}

55 
public
 
boŞ—n
 
	$m©ches
(
SŒšg
 
šput
) {

56 
Tr›Node
 
node
ğ
roÙ
;

57 
i
ğ
šput
.
	`Ëngth
() - 1; i >= 0; i--) {

58 
node
ğnode.
	`g‘Chd
(
šput
.
	`ch¬At
(
i
));

59 ià(
node
 =ğ
nuÎ
)

60  
çl£
;

61 ià(
node
.
	`isT”mš®
())

62  
Œue
;

64  
çl£
;

65 
	}
}

72 
public
 
SŒšg
 
	$shÜ‹¡M©ch
(
SŒšg
 
šput
) {

73 
Tr›Node
 
node
ğ
roÙ
;

74 
i
ğ
šput
.
	`Ëngth
() - 1; i >= 0; i--) {

75 
node
ğnode.
	`g‘Chd
(
šput
.
	`ch¬At
(
i
));

76 ià(
node
 =ğ
nuÎ
)

77  
nuÎ
;

78 ià(
node
.
	`isT”mš®
())

79  
šput
.
	`sub¡ršg
(
i
);

81  
nuÎ
;

82 
	}
}

88 
public
 
SŒšg
 
	$lÚge¡M©ch
(
SŒšg
 
šput
) {

89 
Tr›Node
 
node
ğ
roÙ
;

90 
SŒšg
 
»suÉ
ğ
nuÎ
;

91 
i
ğ
šput
.
	`Ëngth
() - 1; i >= 0; i--) {

92 
node
ğnode.
	`g‘Chd
(
šput
.
	`ch¬At
(
i
));

93 ià(
node
 =ğ
nuÎ
)

95 ià(
node
.
	`isT”mš®
())

96 
»suÉ
ğ
šput
.
	`sub¡ršg
(
i
);

98  
»suÉ
;

99 
	}
}

101 
public
 
fš®
 
	$maš
(
SŒšg
[] 
¬gv
) {

102 
SuffixSŒšgM©ch”
 
m©ch”
=

103 
Ãw
 
	`SuffixSŒšgM©ch”
(

104 
Ãw
 
SŒšg
[]

107 
SŒšg
[] 
‹¡s
= {"a", "ac", "abcd", "abcdefg", "apple", "aa", "aac",

111 
i
ğ0; i < 
‹¡s
.
Ëngth
; i++) {

112 
Sy¡em
.
out
.
	`´šn
("‹¡šg: " + 
‹¡s
[
i
]);

113 
Sy¡em
.
out
.
	`´šn
(" m©ches: " + 
m©ch”
.
	`m©ches
(
‹¡s
[
i
]));

114 
Sy¡em
.
out
.
	`´šn
(" shÜ‹¡: " + 
m©ch”
.
	`shÜ‹¡M©ch
(
‹¡s
[
i
]));

115 
Sy¡em
.
out
.
	`´šn
("†Úge¡: " + 
m©ch”
.
	`lÚge¡M©ch
(
‹¡s
[
i
]));

117 
	}
}

	@com/zhongsou/spider/common/util/TrieStringMatcher.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

21 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

22 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

23 
impÜt
 
	gjava
.
	gut
.
	gLi¡I‹¿tÜ
;

30 
public
 
ab¡¿ù
 cÏs 
	cTr›SŒšgM©ch”
 {

31 
´Ùeùed
 
Tr›Node
 
	mroÙ
;

33 
´Ùeùed
 
	$Tr›SŒšgM©ch”
() {

34 
this
.
roÙ
ğ
Ãw
 
	`Tr›Node
('\000', 
çl£
);

40 
´Ùeùed
 
şass
 
Tr›Node
 
im¶em’ts
 
Com·¿bË
<TrieNode> {

41 
´Ùeùed
 
Tr›Node
[] 
chd»n
;

42 
´Ùeùed
 
LškedLi¡
<
Tr›Node
> 
chd»nLi¡
;

43 
´Ùeùed
 
nodeCh¬
;

44 
´Ùeùed
 
boŞ—n
 
‹rmš®
;

52 
	`Tr›Node
(
nodeCh¬
, 
boŞ—n
 
isT”mš®
) {

53 
this
.
nodeCh¬
=‚odeChar;

54 
this
.
‹rmš®
ğ
isT”mš®
;

55 
this
.
chd»nLi¡
ğ
Ãw
 
LškedLi¡
<
Tr›Node
>();

62 
boŞ—n
 
	`isT”mš®
() {

63  
‹rmš®
;

72 
Tr›Node
 
	`g‘ChdAddIfNÙP»£Á
(
ÃxtCh¬
, 
boŞ—n
 
isT”mš®
) {

73 ià(
chd»nLi¡
 =ğ
nuÎ
) {

74 
chd»nLi¡
ğ
Ãw
 
LškedLi¡
<
Tr›Node
>();

75 
chd»nLi¡
.
	`addAÎ
(
A¼ays
.
	`asLi¡
(
chd»n
));

76 
chd»n
ğ
nuÎ
;

79 ià(
chd»nLi¡
.
	`size
() == 0) {

80 
Tr›Node
 
ÃwNode
ğ
Ãw
 
	`Tr›Node
(
ÃxtCh¬
, 
isT”mš®
);

81 
chd»nLi¡
.
	`add
(
ÃwNode
);

82  
ÃwNode
;

85 
Li¡I‹¿tÜ
<
Tr›Node
> 
™”
ğ
chd»nLi¡
.
	`li¡I‹¿tÜ
();

86 
Tr›Node
 
node
ğ
™”
.
	`Ãxt
();

87  (
node
.
nodeCh¬
 < 
ÃxtCh¬
è&& 
™”
.
	`hasNext
() )

88 
node
ğ
™”
.
	`Ãxt
();

90 ià(
node
.
nodeCh¬
 =ğ
ÃxtCh¬
) {

91 
node
.
‹rmš®
ğnode.‹rmš® | 
isT”mš®
;

92  
node
;

95 ià(
node
.
nodeCh¬
 > 
ÃxtCh¬
)

96 
™”
.
	`´evious
();

98 
Tr›Node
 
ÃwNode
ğ
Ãw
 
	`Tr›Node
(
ÃxtCh¬
, 
isT”mš®
);

99 
™”
.
	`add
(
ÃwNode
);

100  
ÃwNode
;

108 
Tr›Node
 
	`g‘Chd
(
ÃxtCh¬
) {

109 ià(
chd»n
 =ğ
nuÎ
) {

110 
chd»n
ğ
chd»nLi¡
.
	`toA¼ay
(
Ãw
 
Tr›Node
[chd»nLi¡.
	`size
()]);

111 
chd»nLi¡
ğ
nuÎ
;

112 
A¼ays
.
	`sÜt
(
chd»n
);

115 
mš
= 0;

116 
max
ğ
chd»n
.
Ëngth
 - 1;

117 
mid
= 0;

118 
mš
 < 
max
) {

119 
mid
ğ(
mš
 + 
max
) / 2;

120 ià(
chd»n
[
mid
].
nodeCh¬
 =ğ
ÃxtCh¬
)

121  
chd»n
[
mid
];

122 ià(
chd»n
[
mid
].
nodeCh¬
 < 
ÃxtCh¬
)

123 
mš
ğ
mid
 + 1;

125 
max
ğ
mid
 - 1;

128 ià(
mš
 =ğ
max
)

129 ià(
chd»n
[
mš
].
nodeCh¬
 =ğ
ÃxtCh¬
)

130  
chd»n
[
mš
];

132  
nuÎ
;

135 
public
 
	`com·»To
(
Tr›Node
 
Ùh”
) {

136 ià(
this
.
nodeCh¬
 < 
Ùh”
.nodeChar)

138 ià(
this
.
nodeCh¬
 =ğ
Ùh”
.nodeChar)

143 
	}
}

150 
´Ùeùed
 
fš®
 
Tr›Node
 
	$m©chCh¬
(
Tr›Node
 
node
, 
SŒšg
 
s
, 
idx
) {

151  
node
.
	`g‘Chd
(
s
.
	`ch¬At
(
idx
));

152 
	}
}

160 
´Ùeùed
 
fš®
 
	$addP©‹ºFÜw¬d
(
SŒšg
 
s
) {

161 
Tr›Node
 
node
ğ
roÙ
;

162 
¡İ
ğ
s
.
	`Ëngth
() - 1;

163 
i
;

164 ià(
s
.
	`Ëngth
() > 0) {

165 
i
ğ0; i < 
¡İ
; i++)

166 
node
ğnode.
	`g‘ChdAddIfNÙP»£Á
(
s
.
	`ch¬At
(
i
), 
çl£
);

167 
node
ğnode.
	`g‘ChdAddIfNÙP»£Á
(
s
.
	`ch¬At
(
i
), 
Œue
);

169 
	}
}

177 
´Ùeùed
 
fš®
 
	$addP©‹ºBackw¬d
(
SŒšg
 
s
) {

178 
Tr›Node
 
node
ğ
roÙ
;

179 ià(
s
.
	`Ëngth
() > 0) {

180 
i
ğ
s
.
	`Ëngth
()-1; i > 0; i--)

181 
node
ğnode.
	`g‘ChdAddIfNÙP»£Á
(
s
.
	`ch¬At
(
i
), 
çl£
);

182 
node
ğnode.
	`g‘ChdAddIfNÙP»£Á
(
s
.
	`ch¬At
(0), 
Œue
);

184 
	}
}

190 
public
 
ab¡¿ù
 
boŞ—n
 
m©ches
(
SŒšg
 
šput
);

197 
public
 
ab¡¿ù
 
SŒšg
 
shÜ‹¡M©ch
(SŒšg 
šput
);

204 
public
 
ab¡¿ù
 
SŒšg
 
lÚge¡M©ch
(SŒšg 
šput
);

	@com/zhongsou/spider/common/util/URLUtil.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
;

20 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

21 
impÜt
 
	gjava
.
	gÃt
.
	gURL
;

22 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹º
;

24 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
.
	gDomašSuffix
;

25 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
.
	gDomašSuffixes
;

28 
public
 cÏs 
	cURLUt
 {

41 
public
 
URL
 
	$»sŞveURL
(
URL
 
ba£
, 
SŒšg
 
rg‘
)

42 
throws
 
M®fÜmedURLExû±iÚ
 {

43 
rg‘
 =¬g‘.
	`Œim
();

66 ià(
rg‘
.
	`¡¬tsW™h
("?")) {

67  
	`fixPu»Qu”yT¬g‘s
(
ba£
, 
rg‘
);

70  
Ãw
 
	`URL
(
ba£
, 
rg‘
);

74 
URL
 
	$fixPu»Qu”yT¬g‘s
(
URL
 
ba£
, 
SŒšg
 
rg‘
)

75 
throws
 
M®fÜmedURLExû±iÚ
 {

76 ià(!
rg‘
.
	`¡¬tsW™h
("?"))

77  
Ãw
 
	`URL
(
ba£
, 
rg‘
);

79 
SŒšg
 
ba£P©h
 = 
ba£
.
	`g‘P©h
();

80 
SŒšg
 
ba£RightMo¡
 = "";

81 
ba£RightMo¡Idx
 = 
ba£P©h
.
	`Ï¡IndexOf
("/");

82 ià(
ba£RightMo¡Idx
 != -1) {

83 
ba£RightMo¡
 = 
ba£P©h
.
	`sub¡ršg
(
ba£RightMo¡Idx
 + 1);

86 ià(
rg‘
.
	`¡¬tsW™h
("?"))

87 
rg‘
 = 
ba£RightMo¡
 +arget;

89  
Ãw
 
	`URL
(
ba£
, 
rg‘
);

90 
	}
}

112 
´iv©e
 
URL
 
	$fixEmbeddedP¬ams
(
URL
 
ba£
, 
SŒšg
 
rg‘
)

113 
throws
 
M®fÜmedURLExû±iÚ
 {

117 ià(
rg‘
.
	`šdexOf
(';'è>ğ0 || 
ba£
.
	`toSŒšg
().indexOf(';') == -1) {

118  
Ãw
 
	`URL
(
ba£
, 
rg‘
);

122 
SŒšg
 
ba£URL
 = 
ba£
.
	`toSŒšg
();

123 
¡¬tP¬ams
 = 
ba£URL
.
	`šdexOf
(';');

124 
SŒšg
 
·¿ms
 = 
ba£URL
.
	`sub¡ršg
(
¡¬tP¬ams
);

130 
¡¬tQS
 = 
rg‘
.
	`šdexOf
('?');

131 ià(
¡¬tQS
 >= 0) {

132 
rg‘
 =¬g‘.
	`sub¡ršg
(0, 
¡¬tQS
è+ 
·¿ms


133 + 
rg‘
.
	`sub¡ršg
(
¡¬tQS
);

135 
rg‘
 +ğ
·¿ms
;

138  
Ãw
 
	`URL
(
ba£
, 
rg‘
);

139 
	}
}

141 
´iv©e
 
P©‹º
 
	gIP_PATTERN
 = Pattern

142 .
compe
("(\\d{1,3}\\.){3}(\\d{1,3})");

153 
public
 
SŒšg
 
	$g‘DomašName
(
URL
 
u¾
) {

154 
DomašSuffixes
 
ds
 = DomašSuffixes.
	`g‘In¡ªû
();

155 
SŒšg
 
ho¡
 = 
u¾
.
	`g‘Ho¡
();

157 ià(
ho¡
.
	`’dsW™h
("."))

158 
ho¡
 = ho¡.
	`sub¡ršg
(0, ho¡.
	`Ëngth
() - 1);

159 ià(
IP_PATTERN
.
	`m©ch”
(
ho¡
).
	`m©ches
())

160  
ho¡
;

162 
šdex
 = 0;

163 
SŒšg
 
ÿndid©e
 = 
ho¡
;

164 ; 
šdex
 >= 0;) {

165 
šdex
 = 
ÿndid©e
.
	`šdexOf
('.');

166 
SŒšg
 
subCªdid©e
 = 
ÿndid©e
.
	`sub¡ršg
(
šdex
 + 1);

167 ià(
ds
.
	`isDomašSuffix
(
subCªdid©e
)) {

168  
ÿndid©e
;

170 
ÿndid©e
 = 
subCªdid©e
;

172  
ÿndid©e
;

173 
	}
}

175 
public
 
SŒšg
 
	$g‘DomašByHo¡
(
SŒšg
 
ho¡
) {

176 
DomašSuffixes
 
ds
 = DomašSuffixes.
	`g‘In¡ªû
();

177 ià(
ho¡
.
	`’dsW™h
("."))

178 
ho¡
 = ho¡.
	`sub¡ršg
(0, ho¡.
	`Ëngth
() - 1);

179 ià(
IP_PATTERN
.
	`m©ch”
(
ho¡
).
	`m©ches
())

180  
ho¡
;

182 
šdex
 = 0;

183 
SŒšg
 
ÿndid©e
 = 
ho¡
;

184 ; 
šdex
 >= 0;) {

185 
šdex
 = 
ÿndid©e
.
	`šdexOf
('.');

186 
SŒšg
 
subCªdid©e
 = 
ÿndid©e
.
	`sub¡ršg
(
šdex
 + 1);

187 ià(
ds
.
	`isDomašSuffix
(
subCªdid©e
)) {

188  
ÿndid©e
;

190 
ÿndid©e
 = 
subCªdid©e
;

192  
ÿndid©e
;

193 
	}
}

195 
public
 
SŒšg
 
	$ho¡Rev”£
(
SŒšg
 
ho¡
) {

196 
SŒšg
 
t
[] = 
ho¡
.
	`¥l™
("\\.");

197 
SŒšg
 
»v”£Ho¡
 = "";

198 
i
 = 
t
.
Ëngth
 - 1; i > 0; i--) {

199 
»v”£Ho¡
 +ğ
t
[
i
] + ".";

201 
»v”£Ho¡
 +ğ
t
[0];

202  
»v”£Ho¡
;

203 
	}
}

216 
public
 
SŒšg
 
	$g‘DomašName
(
SŒšg
 
u¾
è
throws
 
M®fÜmedURLExû±iÚ
 {

217  
	`g‘DomašName
(
Ãw
 
	`URL
(
u¾
));

218 
	}
}

228 
public
 
boŞ—n
 
	$isSameDomašName
(
URL
 
u¾1
, URL 
u¾2
) {

229  
	`g‘DomašName
(
u¾1
).
	`equ®sIgnÜeCa£
(g‘DomašName(
u¾2
));

230 
	}
}

241 
public
 
boŞ—n
 
	$isSameDomašName
(
SŒšg
 
u¾1
, SŒšg 
u¾2
)

242 
throws
 
M®fÜmedURLExû±iÚ
 {

243  
	`isSameDomašName
(
Ãw
 
	`URL
(
u¾1
),‚ew URL(
u¾2
));

244 
	}
}

250 
public
 
DomašSuffix
 
	$g‘DomašSuffix
(
URL
 
u¾
) {

251 
DomašSuffixes
 
ds
 = DomašSuffixes.
	`g‘In¡ªû
();

252 
SŒšg
 
ho¡
 = 
u¾
.
	`g‘Ho¡
();

253 ià(
IP_PATTERN
.
	`m©ch”
(
ho¡
).
	`m©ches
())

254  
nuÎ
;

256 
šdex
 = 0;

257 
SŒšg
 
ÿndid©e
 = 
ho¡
;

258 ; 
šdex
 >= 0;) {

259 
šdex
 = 
ÿndid©e
.
	`šdexOf
('.');

260 
SŒšg
 
subCªdid©e
 = 
ÿndid©e
.
	`sub¡ršg
(
šdex
 + 1);

261 
DomašSuffix
 
d
 = 
ds
.
	`g‘
(
subCªdid©e
);

262 ià(
d
 !ğ
nuÎ
) {

263  
d
;

265 
ÿndid©e
 = 
subCªdid©e
;

267  
nuÎ
;

268 
	}
}

274 
public
 
DomašSuffix
 
	$g‘DomašSuffix
(
SŒšg
 
u¾
)

275 
throws
 
M®fÜmedURLExû±iÚ
 {

276  
	`g‘DomašSuffix
(
Ãw
 
	`URL
(
u¾
));

277 
	}
}

280 
public
 
	gSŒšg
[] 
	$g‘Ho¡Segm’ts
(
URL
 
u¾
) {

281 
SŒšg
 
ho¡
 = 
u¾
.
	`g‘Ho¡
();

284 ià(
IP_PATTERN
.
	`m©ch”
(
ho¡
).
	`m©ches
())

285  
Ãw
 
SŒšg
[] { 
ho¡
 };

286  
ho¡
.
	`¥l™
("\\.");

287 
	}
}

294 
public
 
	gSŒšg
[] 
	$g‘Ho¡Segm’ts
(
SŒšg
 
u¾
)

295 
throws
 
M®fÜmedURLExû±iÚ
 {

296  
	`g‘Ho¡Segm’ts
(
Ãw
 
	`URL
(
u¾
));

297 
	}
}

375 
public
 
SŒšg
 
	$choo£R•r
(
SŒšg
 
¤c
, SŒšg 
d¡
, 
boŞ—n
 
‹mp
) {

378 
URL
 
¤cU¾
;

379 
URL
 
d¡U¾
;

380 
Œy
 {

381 
¤cU¾
 = 
Ãw
 
	`URL
(
¤c
);

382 
d¡U¾
 = 
Ãw
 
	`URL
(
d¡
);

383 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e
) {

384  
d¡
;

388 
SŒšg
 
¤cDomaš
 = 
URLUt
.
	`g‘DomašName
(
¤cU¾
);

389 
SŒšg
 
d¡Domaš
 = 
URLUt
.
	`g‘DomašName
(
d¡U¾
);

390 
SŒšg
 
¤cHo¡
 = 
¤cU¾
.
	`g‘Ho¡
();

391 
SŒšg
 
d¡Ho¡
 = 
d¡U¾
.
	`g‘Ho¡
();

392 
SŒšg
 
¤cFe
 = 
¤cU¾
.
	`g‘Fe
();

393 
SŒšg
 
d¡Fe
 = 
d¡U¾
.
	`g‘Fe
();

396 
boŞ—n
 
¤cRoÙ
 = (
¤cFe
.
	`equ®s
("/"è|| srcFe.
	`Ëngth
() == 0);

397 
boŞ—n
 
de¡RoÙ
 = (
d¡Fe
.
	`equ®s
("/"è|| d¡Fe.
	`Ëngth
() == 0);

428 ià(!
¤cDomaš
.
	`equ®s
(
d¡Domaš
)) {

429  
d¡
;

433 ià(!
‹mp
) {

436 ià(
¤cRoÙ
) {

437  
¤c
;

439  
d¡
;

444 ià(
¤cRoÙ
 && !
de¡RoÙ
) {

445  
¤c
;

446 } ià(!
¤cRoÙ
 && 
de¡RoÙ
) {

448  
d¡
;

449 } ià(!
¤cRoÙ
 && !
de¡RoÙ
 && (
¤cHo¡
.
	`equ®s
(
d¡Ho¡
))) {

453 
numSrcP©hs
 = 
¤cFe
.
	`¥l™
("/").
Ëngth
;

454 
numD¡P©hs
 = 
d¡Fe
.
	`¥l™
("/").
Ëngth
;

455 ià(
numSrcP©hs
 !ğ
numD¡P©hs
) {

456  (
numD¡P©hs
 < 
numSrcP©hs
 ? 
d¡
 : 
¤c
);

458 
¤cP©hL’gth
 = 
¤cFe
.
	`Ëngth
();

459 
d¡P©hL’gth
 = 
d¡Fe
.
	`Ëngth
();

460  (
d¡P©hL’gth
 < 
¤cP©hL’gth
 ? 
d¡
 : 
¤c
);

465 
numSrcSubs
 = 
¤cHo¡
.
	`¥l™
("\\.").
Ëngth
;

466 
numD¡Subs
 = 
d¡Ho¡
.
	`¥l™
("\\.").
Ëngth
;

467  (
numD¡Subs
 < 
numSrcSubs
 ? 
d¡
 : 
¤c
);

470 
	}
}

480 
public
 
SŒšg
 
	$g‘Ho¡
(
SŒšg
 
u¾
) {

481 
Œy
 {

482  
Ãw
 
	`URL
(
u¾
).
	`g‘Ho¡
().
	`toLow”Ca£
();

483 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e
) {

484  
nuÎ
;

486 
	}
}

497 
public
 
SŒšg
 
	$g‘Page
(
SŒšg
 
u¾
) {

498 
Œy
 {

501 
u¾
 = u¾.
	`toLow”Ca£
();

502 
SŒšg
 
qu”ySŒ
 = 
Ãw
 
	`URL
(
u¾
).
	`g‘Qu”y
();

503  (
qu”ySŒ
 !ğ
nuÎ
è? 
u¾
.
	`»¶aû
("?" + queryStr, "") : url;

504 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e
) {

505  
nuÎ
;

507 
	}
}

512 
public
 
	$maš
(
SŒšg
[] 
¬gs
) {

514 
SŒšg
 
pu¾
 = "http://www.sina.com/dfa/adfa?a=b&amp;c=d";

526 
SŒšg
 
ho¡
 = "adaf.ccdad.da.com.cn";

527 
Sy¡em
.
out
.
	`´šn
("domaš=" + 
URLUt
.
	`g‘DomašByHo¡
(
ho¡
) + "\t"

528 + 
URLUt
.
	`ho¡Rev”£
(
ho¡
));

529 
	}
}

	@com/zhongsou/spider/common/util/domain/DomainSuffix.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
;

37 
public
 cÏs 
	cDomašSuffix
 {

42 
public
 
	eStus
 { 
	mINFRASTRUCTURE
, 
	mSPONSORED
, 
	mUNSPONSORED


43 , 
	mSTARTUP
, 
	mPROPOSED
, 
	mDELETED
, 
	mPSEUDO_DOMAIN
, 
	mDEPRECATED
, 
	mIN_USE
, 
	mNOT_IN_USE
, 
	mREJECTED


46 
´iv©e
 
SŒšg
 
	gdomaš
;

47 
´iv©e
 
Stus
 
	g¡©us
;

48 
´iv©e
 
	gboo¡
;

50 
public
 
fš®
 
	gDEFAULT_BOOST
 = 1.0f;

51 
public
 
fš®
 
Stus
 
	gDEFAULT_STATUS
 = Stus.
IN_USE
;

53 
public
 
	$DomašSuffix
(
SŒšg
 
domaš
, 
Stus
 
¡©us
, 
boo¡
) {

54 
this
.
domaš
 = domain;

55 
this
.
¡©us
 = status;

56 
this
.
boo¡
 = boost;

57 
	}
}

59 
public
 
	$DomašSuffix
(
SŒšg
 
domaš
) {

60 
	`this
(
domaš
, 
DEFAULT_STATUS
, 
DEFAULT_BOOST
);

61 
	}
}

63 
public
 
SŒšg
 
	$g‘Domaš
() {

64  
domaš
;

65 
	}
}

67 
public
 
Stus
 
	$g‘Stus
() {

68  
¡©us
;

69 
	}
}

71 
public
 
	$g‘Boo¡
() {

72  
boo¡
;

73 
	}
}

75 @
Ov”ride


76 
public
 
SŒšg
 
	$toSŒšg
() {

77  
domaš
;

78 
	}
}

	@com/zhongsou/spider/common/util/domain/DomainSuffixes.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
;

20 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—m
;

21 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

24 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

25 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

32 
public
 cÏs 
	cDomašSuffixes
 {

33 
´iv©e
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
DomašSuffixes
.
şass
);

35 
´iv©e
 
	mHashM­
<
	mSŒšg
, 
	mDomašSuffix
> 
	mdomašs
 = 
Ãw
 
HashM­
<
SŒšg
, DomainSuffix>();

37 
´iv©e
 
DomašSuffixes
 
	mš¡ªû
;

40 
´iv©e
 
	$DomašSuffixes
() {

41 
SŒšg
 
fe
 = "domain-suffixes.xml";

42 
IÅutSŒ—m
 
šput
 = 
this
.
	`g‘CÏss
().
	`g‘CÏssLßd”
().
	`g‘ResourûAsSŒ—m
(
fe
);

43 
Œy
 {

44 
Ãw
 
	`DomašSuffixesR—d”
().
	`»ad
(
this
, 
šput
);

46 
	`ÿtch
 (
Exû±iÚ
 
ex
) {

47 
LOG
.
	`w¬n
(
SŒšgUts
.
	`¡ršgifyExû±iÚ
(
ex
));

55 
public
 
DomašSuffixes
 
	$g‘In¡ªû
() {

56 if(
š¡ªû
 =ğ
nuÎ
) {

57 
š¡ªû
 = 
Ãw
 
	`DomašSuffixes
();

59  
š¡ªû
;

60 
	}
}

62 
	$addDomašSuffix
(
DomašSuffix
 
d
) {

63 
domašs
.
	`put
(
d
.
	`g‘Domaš
(),ld);

64 
	}
}

67 
public
 
boŞ—n
 
	$isDomašSuffix
(
SŒšg
 
ex‹nsiÚ
) {

68  
domašs
.
	`cÚšsKey
(
ex‹nsiÚ
);

69 
	}
}

77 
public
 
DomašSuffix
 
	$g‘
(
SŒšg
 
ex‹nsiÚ
) {

78  
domašs
.
	`g‘
(
ex‹nsiÚ
);

79 
	}
}

	@com/zhongsou/spider/common/util/domain/DomainSuffixesReader.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
;

20 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

21 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—m
;

23 
impÜt
 
	gjavax
.
	gxml
.
	g·r£rs
.
	gDocum’tBud”
;

24 
impÜt
 
	gjavax
.
	gxml
.
	g·r£rs
.
	gDocum’tBud”FaùÜy
;

25 
impÜt
 
	gjavax
.
	gxml
.
	g·r£rs
.
	gP¬£rCÚfigu¿tiÚExû±iÚ
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

28 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

29 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

30 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gDocum’t
;

31 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gEËm’t
;

32 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gNodeLi¡
;

33 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gIÅutSourû
;

34 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
.
	gDomašSuffix
.
	gStus
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
.
	gTİLev–Domaš
.
	gTy³
;

45 şas 
	cDomašSuffixesR—d”
 {

47 
´iv©e
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
DomašSuffixesR—d”
.
şass
);

49 
	$»ad
(
DomašSuffixes
 
dEÁr›s
, 
IÅutSŒ—m
 
šput
è
throws
 
IOExû±iÚ
{

50 
Œy
 {

52 
Docum’tBud”FaùÜy
 
çùÜy
 = Docum’tBud”FaùÜy.
	`ÃwIn¡ªû
();

53 
çùÜy
.
	`£tIgnÜšgComm’ts
(
Œue
);

54 
Docum’tBud”
 
bud”
 = 
çùÜy
.
	`ÃwDocum’tBud”
();

55 
Docum’t
 
docum’t
 = 
bud”
.
	`·r£
(
Ãw
 
	`IÅutSourû
(
šput
));

57 
EËm’t
 
roÙ
 = 
docum’t
.
	`g‘Docum’tEËm’t
();

59 if(
roÙ
 !ğ
nuÎ
 &&„oÙ.
	`g‘TagName
().
	`equ®s
("domains")) {

61 
EËm’t
 
ds
 = (EËm’t)
roÙ
.
	`g‘EËm’tsByTagName
("ds").
	`™em
(0);

62 
EËm’t
 
suffixes
 = (EËm’t)
roÙ
.
	`g‘EËm’tsByTagName
("suffixes").
	`™em
(0);

65 
	`»adITLDs
(
dEÁr›s
, (
EËm’t
)
ds
.
	`g‘EËm’tsByTagName
("™lds").
	`™em
(0));

66 
	`»adGTLDs
(
dEÁr›s
, (
EËm’t
)
ds
.
	`g‘EËm’tsByTagName
("gds").
	`™em
(0));

67 
	`»adCCTLDs
(
dEÁr›s
, (
EËm’t
)
ds
.
	`g‘EËm’tsByTagName
("cùlds").
	`™em
(0));

69 
	`»adSuffixes
(
dEÁr›s
, 
suffixes
);

72 
throw
 
Ãw
 
	`IOExû±iÚ
("xml file is‚ot valid");

75 
	`ÿtch
 (
P¬£rCÚfigu¿tiÚExû±iÚ
 
ex
) {

76 
LOG
.
	`w¬n
(
SŒšgUts
.
	`¡ršgifyExû±iÚ
(
ex
));

77 
throw
 
Ãw
 
	`IOExû±iÚ
(
ex
.
	`g‘Mes§ge
());

79 
	`ÿtch
 (
SAXExû±iÚ
 
ex
) {

80 
LOG
.
	`w¬n
(
SŒšgUts
.
	`¡ršgifyExû±iÚ
(
ex
));

81 
throw
 
Ãw
 
	`IOExû±iÚ
(
ex
.
	`g‘Mes§ge
());

85 
	$»adITLDs
(
DomašSuffixes
 
dEÁr›s
, 
EËm’t
 
–
) {

86 
NodeLi¡
 
chd»n
 = 
–
.
	`g‘EËm’tsByTagName
("tld");

87 
i
=0;i<
chd»n
.
	`g‘L’gth
();i++) {

88 
dEÁr›s
.
	`addDomašSuffix
(
	`»adGTLD
((
EËm’t
)
chd»n
.
	`™em
(
i
), 
Ty³
.
INFRASTRUCTURE
));

90 
	}
}

92 
	$»adGTLDs
(
DomašSuffixes
 
dEÁr›s
, 
EËm’t
 
–
) {

93 
NodeLi¡
 
chd»n
 = 
–
.
	`g‘EËm’tsByTagName
("tld");

94 
i
=0;i<
chd»n
.
	`g‘L’gth
();i++) {

95 
dEÁr›s
.
	`addDomašSuffix
(
	`»adGTLD
((
EËm’t
)
chd»n
.
	`™em
(
i
), 
Ty³
.
GENERIC
));

97 
	}
}

99 
	$»adCCTLDs
(
DomašSuffixes
 
dEÁr›s
, 
EËm’t
 
–
è
throws
 
IOExû±iÚ
 {

100 
NodeLi¡
 
chd»n
 = 
–
.
	`g‘EËm’tsByTagName
("tld");

101 
i
=0;i<
chd»n
.
	`g‘L’gth
();i++) {

102 
dEÁr›s
.
	`addDomašSuffix
(
	`»adCCTLD
((
EËm’t
)
chd»n
.
	`™em
(
i
)));

104 
	}
}

106 
TİLev–Domaš
 
	$»adGTLD
(
EËm’t
 
–
, 
Ty³
 
ty³
) {

107 
SŒšg
 
domaš
 = 
–
.
	`g‘A‰ribu‹
("domain");

108 
Stus
 
¡©us
 = 
	`»adStus
(
–
);

109 
boo¡
 = 
	`»adBoo¡
(
–
);

110  
Ãw
 
	`TİLev–Domaš
(
domaš
, 
ty³
, 
¡©us
, 
boo¡
);

111 
	}
}

113 
TİLev–Domaš
 
	$»adCCTLD
(
EËm’t
 
–
è
throws
 
IOExû±iÚ
 {

114 
SŒšg
 
domaš
 = 
–
.
	`g‘A‰ribu‹
("domain");

115 
Stus
 
¡©us
 = 
	`»adStus
(
–
);

116 
boo¡
 = 
	`»adBoo¡
(
–
);

117 
SŒšg
 
couÁryName
 = 
	`»adCouÁryName
(
–
);

118  
Ãw
 
	`TİLev–Domaš
(
domaš
, 
¡©us
, 
boo¡
, 
couÁryName
);

119 
	}
}

122 
Stus
 
	$»adStus
(
EËm’t
 
–
) {

123 
NodeLi¡
 
li¡
 = 
–
.
	`g‘EËm’tsByTagName
("status");

124 if(
li¡
 =ğ
nuÎ
 ||†i¡.
	`g‘L’gth
() == 0)

125  
DomašSuffix
.
DEFAULT_STATUS
;

126  
Stus
.
	`v®ueOf
(
li¡
.
	`™em
(0).
	`g‘Fœ¡Chd
().
	`g‘NodeV®ue
());

127 
	}
}

130 
	$»adBoo¡
(
EËm’t
 
–
) {

131 
NodeLi¡
 
li¡
 = 
–
.
	`g‘EËm’tsByTagName
("boost");

132 if(
li¡
 =ğ
nuÎ
 ||†i¡.
	`g‘L’gth
() == 0)

133  
DomašSuffix
.
DEFAULT_BOOST
;

134  
Flßt
.
	`·r£Flßt
(
li¡
.
	`™em
(0).
	`g‘Fœ¡Chd
().
	`g‘NodeV®ue
());

135 
	}
}

139 
SŒšg
 
	$»adCouÁryName
(
EËm’t
 
–
è
throws
 
IOExû±iÚ
 {

140 
NodeLi¡
 
li¡
 = 
–
.
	`g‘EËm’tsByTagName
("country");

141 if(
li¡
 =ğ
nuÎ
 ||†i¡.
	`g‘L’gth
() == 0)

142 
throw
 
Ãw
 
	`IOExû±iÚ
("Country‚ame should be given");

143  
li¡
.
	`™em
(0).
	`g‘NodeV®ue
();

144 
	}
}

146 
	$»adSuffixes
(
DomašSuffixes
 
dEÁr›s
, 
EËm’t
 
–
) {

147 
NodeLi¡
 
chd»n
 = 
–
.
	`g‘EËm’tsByTagName
("suffix");

148 
i
=0;i<
chd»n
.
	`g‘L’gth
();i++) {

149 
dEÁr›s
.
	`addDomašSuffix
(
	`»adSuffix
((
EËm’t
)
chd»n
.
	`™em
(
i
)));

151 
	}
}

153 
DomašSuffix
 
	$»adSuffix
(
EËm’t
 
–
) {

154 
SŒšg
 
domaš
 = 
–
.
	`g‘A‰ribu‹
("domain");

155 
Stus
 
¡©us
 = 
	`»adStus
(
–
);

156 
boo¡
 = 
	`»adBoo¡
(
–
);

157  
Ãw
 
	`DomašSuffix
(
domaš
, 
¡©us
, 
boo¡
);

158 
	}
}

	@com/zhongsou/spider/common/util/domain/TopLevelDomain.java

18 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gdomaš
;

32 
public
 cÏs 
	cTİLev–Domaš
 
ex‹nds
 
	mDomašSuffix
 {

34 
public
 
	eTy³
 { 
	mINFRASTRUCTURE
, 
	mGENERIC
, 
	mCOUNTRY
 };

36 
´iv©e
 
Ty³
 
	gty³
;

37 
´iv©e
 
SŒšg
 
	gcouÁryName
 = 
nuÎ
;

39 
public
 
	$TİLev–Domaš
(
SŒšg
 
domaš
, 
Ty³
 
ty³
, 
Stus
 
¡©us
, 
boo¡
){

40 
	`su³r
(
domaš
, 
¡©us
, 
boo¡
);

41 
this
.
ty³
 =ype;

42 
	}
}

44 
public
 
	$TİLev–Domaš
(
SŒšg
 
domaš
, 
Stus
 
¡©us
, 
boo¡
, SŒšg 
couÁryName
){

45 
	`su³r
(
domaš
, 
¡©us
, 
boo¡
);

46 
this
.
ty³
 = 
Ty³
.
COUNTRY
;

47 
this
.
couÁryName
 = countryName;

48 
	}
}

50 
public
 
Ty³
 
	$g‘Ty³
() {

51  
ty³
;

52 
	}
}

57 
public
 
SŒšg
 
	$g‘CouÁryName
(){

58  
couÁryName
;

59 
	}
}

	@com/zhongsou/spider/exception/EmptyParamValueException.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gexû±iÚ
;

3 
public
 cÏs 
	cEm±yP¬amV®ueExû±iÚ
 
ex‹nds
 
	mExû±iÚ
 {

5 @
Ov”ride


6 
public
 
SŒšg
 
	$g‘Mes§ge
() {

11 
	}
}

	@com/zhongsou/spider/hadoop/BoilerpipeContentHandler.java

17 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

19 
impÜt
 
	gjava
.
	gio
.
	gWr™”
;

20 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

21 
impÜt
 
	gjava
.
	gut
.
	gB™S‘
;

22 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	gm‘ad©a
.
	gM‘ad©a
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g§x
.
	gWr™eOutCÚ‹ÁHªdËr
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g§x
.
	gXHTMLCÚ‹ÁHªdËr
;

27 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gA‰ribu‹s
;

28 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gCÚ‹ÁHªdËr
;

29 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ
;

30 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gh–³rs
.
	gA‰ribu‹sIm¶
;

32 
impÜt
 
	gde
.
	gl3s
.
	gbo”pe
.
	gBo”peExŒaùÜ
;

33 
impÜt
 
	gde
.
	gl3s
.
	gbo”pe
.
	gBo”peProûssšgExû±iÚ
;

34 
impÜt
 
	gde
.
	gl3s
.
	gbo”pe
.
	gdocum’t
.
	gTextBlock
;

35 
impÜt
 
	gde
.
	gl3s
.
	gbo”pe
.
	gdocum’t
.
	gTextDocum’t
;

36 
impÜt
 
	gde
.
	gl3s
.
	gbo”pe
.
	gexŒaùÜs
.
	gA¹işeExŒaùÜ
;

37 
impÜt
 
	gde
.
	gl3s
.
	gbo”pe
.
	gexŒaùÜs
.
	gDeçuÉExŒaùÜ
;

38 
impÜt
 
	gde
.
	gl3s
.
	gbo”pe
.
	g§x
.
	gBo”peHTMLCÚ‹ÁHªdËr
;

47 
public
 cÏs 
	cBo”peCÚ‹ÁHªdËr
 
ex‹nds
 
	mBo”peHTMLCÚ‹ÁHªdËr
 {

49 
´iv©e
 şas 
	cRecÜdedEËm’t
 {

50 
public
 
	eEËm’tTy³
 {

51 
	mSTART
,

52 
	mEND
,

53 
	mCONTINUE


56 
´iv©e
 
SŒšg
 
	muri
;

57 
´iv©e
 
SŒšg
 
	mloÿlName
;

58 
´iv©e
 
SŒšg
 
	mqName
;

59 
´iv©e
 
A‰ribu‹s
 
	m©Œs
;

60 
´iv©e
 
	mLi¡
<[]> 
	mch¬aù”s
;

61 
´iv©e
 
EËm’tTy³
 
	m–em’tTy³
;

63 
public
 
RecÜdedEËm’t
(
SŒšg
 
uri
, SŒšg 
loÿlName
, SŒšg 
qName
, 
A‰ribu‹s
 
©Œs
) {

64 
this
(
uri
, 
loÿlName
, 
qName
, 
©Œs
, 
EËm’tTy³
.
START
);

67 
public
 
RecÜdedEËm’t
(
SŒšg
 
uri
, SŒšg 
loÿlName
, SŒšg 
qName
) {

68 
this
(
uri
, 
loÿlName
, 
qName
, 
nuÎ
, 
EËm’tTy³
.
END
);

71 
public
 
RecÜdedEËm’t
() {

72 
this
(
nuÎ
,‚uÎ,‚uÎ,‚uÎ, 
EËm’tTy³
.
CONTINUE
);

75 
´Ùeùed
 
RecÜdedEËm’t
(
SŒšg
 
uri
, SŒšg 
loÿlName
, SŒšg 
qName
, 
A‰ribu‹s
 
©Œs
, RecÜdedEËm’t.
EËm’tTy³
 
–em’tTy³
) {

76 
	mthis
.
	muri
 = 
uri
;

77 
	mthis
.
	mloÿlName
 = 
loÿlName
;

78 
	mthis
.
	mqName
 = 
qName
;

79 
	mthis
.
	m©Œs
 = 
©Œs
;

80 
	mthis
.
	m–em’tTy³
 = 
–em’tTy³
;

81 
	mthis
.
	mch¬aù”s
 = 
Ãw
 
A¼ayLi¡
<[]>();

84 @
Ov”ride


85 
public
 
SŒšg
 
toSŒšg
() {

86  
	mSŒšg
.
fÜm©
("<%s> oàty³ %s", 
loÿlName
, 
–em’tTy³
);

89 
public
 
SŒšg
 
g‘Uri
() {

90  
	muri
;

93 
public
 
SŒšg
 
g‘LoÿlName
() {

94  
	mloÿlName
;

97 
public
 
SŒšg
 
g‘QName
() {

98  
	mqName
;

101 
public
 
A‰ribu‹s
 
g‘A‰rs
() {

102  
	m©Œs
;

105 
public
 
	mLi¡
<[]> 
g‘Ch¬aù”s
() {

106  
	mch¬aù”s
;

109 
public
 
	mRecÜdedEËm’t
.
EËm’tTy³
 
g‘EËm’tTy³
() {

110  
	m–em’tTy³
;

117 
´iv©e
 
fš®
 [] 
	gNL
 = 
Ãw
 [] { '\n' };

119 
´iv©e
 
CÚ‹ÁHªdËr
 
	gd–eg©e
;

120 
´iv©e
 
Bo”peExŒaùÜ
 
	gexŒaùÜ
;

122 
´iv©e
 
boŞ—n
 
	gšşudeM¬kup
;

123 
´iv©e
 
boŞ—n
 
	gšH—d”
;

124 
´iv©e
 
boŞ—n
 
	gšFoÙ”
;

125 
´iv©e
 
	gh—d”Ch¬Off£t
;

126 
´iv©e
 
	gLi¡
<
	gRecÜdedEËm’t
> 
	g–em’ts
;

135 
public
 
	$Bo”peCÚ‹ÁHªdËr
(
CÚ‹ÁHªdËr
 
d–eg©e
) {

136 
	`this
(
d–eg©e
, 
DeçuÉExŒaùÜ
.
INSTANCE
);

137 
	}
}

145 
public
 
	$Bo”peCÚ‹ÁHªdËr
(
Wr™”
 
wr™”
) {

146 
	`this
(
Ãw
 
	`Wr™eOutCÚ‹ÁHªdËr
(
wr™”
));

147 
	}
}

159 
public
 
	$Bo”peCÚ‹ÁHªdËr
(
CÚ‹ÁHªdËr
 
d–eg©e
, 
Bo”peExŒaùÜ
 
exŒaùÜ
) {

160 
this
.
d–eg©e
 = delegate;

161 
this
.
exŒaùÜ
 =ƒxtractor;

162 
	}
}

164 
public
 
	$£tInşudeM¬kup
(
boŞ—n
 
šşudeM¬kup
) {

165 
this
.
šşudeM¬kup
 = includeMarkup;

166 
	}
}

168 
public
 
boŞ—n
 
	$isInşudeM¬kup
() {

169  
šşudeM¬kup
;

170 
	}
}

172 @
Ov”ride


173 
public
 
	$¡¬tDocum’t
(è
throws
 
SAXExû±iÚ
 {

174 
su³r
.
	`¡¬tDocum’t
();

176 
d–eg©e
.
	`¡¬tDocum’t
();

178 
šH—d”
 = 
Œue
;

179 
šFoÙ”
 = 
çl£
;

180 
h—d”Ch¬Off£t
 = 0;

182 ià(
šşudeM¬kup
) {

183 
–em’ts
 = 
Ãw
 
A¼ayLi¡
<
RecÜdedEËm’t
>();

185 
	}
};

187 @
Ov”ride


188 
public
 
	$¡¬tP»fixM­pšg
(
SŒšg
 
´efix
, SŒšg 
uri
è
throws
 
SAXExû±iÚ
 {

189 
su³r
.
	`¡¬tP»fixM­pšg
(
´efix
, 
uri
);

190 
d–eg©e
.
	`¡¬tP»fixM­pšg
(
´efix
, 
uri
);

191 
	}
};

193 @
Ov”ride


194 
public
 
	$¡¬tEËm’t
(
SŒšg
 
uri
, SŒšg 
loÿlName
, SŒšg 
qName
, 
A‰ribu‹s
 
©ts
è
throws
 
SAXExû±iÚ
 {

195 
su³r
.
	`¡¬tEËm’t
(
uri
, 
loÿlName
, 
qName
, 
©ts
);

197 ià(
šH—d”
) {

198 
d–eg©e
.
	`¡¬tEËm’t
(
uri
, 
loÿlName
, 
qName
, 
©ts
);

199 } ià(
šFoÙ”
) {

201 } ià(
šşudeM¬kup
) {

202 
–em’ts
.
	`add
(
Ãw
 
	`RecÜdedEËm’t
(
uri
, 
loÿlName
, 
qName
, 
©ts
));

205 
d–eg©e
.
	`¡¬tEËm’t
(
uri
, 
loÿlName
, 
qName
, 
©ts
);

207 
	}
};

209 @
Ov”ride


210 
public
 
	$ch¬aù”s
([] 
ch¬s
, 
off£t
, 
Ëngth
è
throws
 
SAXExû±iÚ
 {

211 
su³r
.
	`ch¬aù”s
(
ch¬s
, 
off£t
, 
Ëngth
);

213 ià(
šH—d”
) {

214 
d–eg©e
.
	`ch¬aù”s
(
ch¬s
, 
off£t
, 
Ëngth
);

215 
h—d”Ch¬Off£t
++;

216 } ià(
šFoÙ”
) {

218 } ià(
šşudeM¬kup
) {

219 
RecÜdedEËm’t
 
–em’t
 = 
–em’ts
.
	`g‘
ÓËm’ts.
	`size
() - 1);

221 [] 
ch¬aù”s
 = 
Ãw
 [
Ëngth
];

222 
Sy¡em
.
	`¬¿ycİy
(
ch¬s
, 
off£t
, 
ch¬aù”s
, 0, 
Ëngth
);

223 
–em’t
.
	`g‘Ch¬aù”s
().
	`add
(
ch¬aù”s
);

225 
	}
};

227 @
Ov”ride


228 
public
 
	$’dEËm’t
(
SŒšg
 
uri
, SŒšg 
loÿlName
, SŒšg 
qName
è
throws
 
SAXExû±iÚ
 {

229 
su³r
.
	`’dEËm’t
(
uri
, 
loÿlName
, 
qName
);

231 ià(
šH—d”
) {

232 
d–eg©e
.
	`’dEËm’t
(
uri
, 
loÿlName
, 
qName
);

233 
šH—d”
 = !
loÿlName
.
	`equ®s
("head");

234 } ià(
šFoÙ”
) {

236 } ià(
loÿlName
.
	`equ®s
("body")) {

237 
šFoÙ”
 = 
Œue
;

238 } ià(
šşudeM¬kup
) {

240 
–em’ts
.
	`add
(
Ãw
 
	`RecÜdedEËm’t
(
uri
, 
loÿlName
, 
qName
));

241 
–em’ts
.
	`add
(
Ãw
 
	`RecÜdedEËm’t
());

243 
	}
};

245 @
Ov”ride


246 
public
 
	$’dDocum’t
(è
throws
 
SAXExû±iÚ
 {

247 
su³r
.
	`’dDocum’t
();

249 
TextDocum’t
 
td
 = 
	`toTextDocum’t
();

250 
Œy
 {

251 
exŒaùÜ
.
	`´oûss
(
td
);

252 } 
	`ÿtch
 (
Bo”peProûssšgExû±iÚ
 
e
) {

253 
throw
 
Ãw
 
	`SAXExû±iÚ
(
e
);

256 
A‰ribu‹s
 
em±yA‰rs
 = 
Ãw
 
	`A‰ribu‹sIm¶
();

261 ià(
šşudeM¬kup
) {

262 
B™S‘
 
v®idCh¬aù”Runs
 = 
Ãw
 
	`B™S‘
();

263 
TextBlock
 
block
 : 
td
.
	`g‘TextBlocks
()) {

264 ià(
block
.
	`isCÚ‹Á
()) {

265 
B™S‘
 
bs
 = 
block
.
	`g‘CÚšedTextEËm’ts
();

266 ià(
bs
 !ğ
nuÎ
) {

267 
v®idCh¬aù”Runs
.
	`Ü
(
bs
);

274 
curCh¬sIndex
 = 
h—d”Ch¬Off£t
;

275 
RecÜdedEËm’t
 
–em’t
 : 
–em’ts
) {

276 
–em’t
.
	`g‘EËm’tTy³
()) {

277 
START
:

278 
d–eg©e
.
	`¡¬tEËm’t
(
–em’t
.
	`g‘Uri
(),ƒËm’t.
	`g‘LoÿlName
(),ƒËm’t.
	`g‘QName
(),ƒËm’t.
	`g‘A‰rs
());

281 
CONTINUE
:

284 [] 
ch¬s
 : 
–em’t
.
	`g‘Ch¬aù”s
()) {

285 
curCh¬sIndex
++;

287 ià(
v®idCh¬aù”Runs
.
	`g‘
(
curCh¬sIndex
)) {

288 
d–eg©e
.
	`ch¬aù”s
(
ch¬s
, 0, ch¬s.
Ëngth
);

293 
END
:

294 
d–eg©e
.
	`’dEËm’t
(
–em’t
.
	`g‘Uri
(),ƒËm’t.
	`g‘LoÿlName
(),ƒËm’t.
	`g‘QName
());

298 
throw
 
Ãw
 
	`RuÁimeExû±iÚ
("UnhªdËdƒËm’ˆty³: " + 
–em’t
.
	`g‘EËm’tTy³
());

304 
TextBlock
 
block
 : 
td
.
	`g‘TextBlocks
()) {

305 ià(
block
.
	`isCÚ‹Á
()) {

306 
d–eg©e
.
	`¡¬tEËm’t
(
XHTMLCÚ‹ÁHªdËr
.
XHTML
, "p", "p", 
em±yA‰rs
);

307 [] 
ch¬s
 = 
block
.
	`g‘Text
().
	`toCh¬A¼ay
();

308 
d–eg©e
.
	`ch¬aù”s
(
ch¬s
, 0, ch¬s.
Ëngth
);

309 
d–eg©e
.
	`’dEËm’t
(
XHTMLCÚ‹ÁHªdËr
.
XHTML
, "p", "p");

310 
d–eg©e
.
	`ignÜabËWh™e¥aû
(
NL
, 0, NL.
Ëngth
);

315 
d–eg©e
.
	`’dEËm’t
(
XHTMLCÚ‹ÁHªdËr
.
XHTML
, "body", "body");

316 
d–eg©e
.
	`’dEËm’t
(
XHTMLCÚ‹ÁHªdËr
.
XHTML
, "html", "html");

320 
d–eg©e
.
	`’dP»fixM­pšg
("");

322 
d–eg©e
.
	`’dDocum’t
();

323 
	}
}

	@com/zhongsou/spider/hadoop/ClawerConvert.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayIÅutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gSŒšgWr™”
;

5 
impÜt
 
	gjava
.
	gio
.
	gWr™”
;

6 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬£t
;

7 
impÜt
 
	gjava
.
	gut
.
	g»gex
.
	gP©‹º
;

9 
impÜt
 
	gjavax
.
	gxml
.
	gŒªsfÜm
.
	gOuutKeys
;

10 
impÜt
 
	gjavax
.
	gxml
.
	gŒªsfÜm
.
	gT¿nsfÜm”CÚfigu¿tiÚExû±iÚ
;

11 
impÜt
 
	gjavax
.
	gxml
.
	gŒªsfÜm
.
	g§x
.
	gSAXT¿nsfÜm”FaùÜy
;

12 
impÜt
 
	gjavax
.
	gxml
.
	gŒªsfÜm
.
	g§x
.
	gT¿nsfÜm”HªdËr
;

13 
impÜt
 
	gjavax
.
	gxml
.
	gŒªsfÜm
.
	g¡»am
.
	gSŒ—mResuÉ
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	gTika
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	gcÚfig
.
	gTikaCÚfig
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	gd‘eù
.
	gD‘eùÜ
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	gexû±iÚ
.
	gTikaExû±iÚ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	gÏnguage
.
	gProfšgHªdËr
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	gm‘ad©a
.
	gM‘ad©a
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	gmime
.
	gMedŸTy³
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g·r£r
.
	gAutoD‘eùP¬£r
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g·r£r
.
	gP¬£CÚ‹xt
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g·r£r
.
	gP¬£r
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g·r£r
.
	gtxt
.
	gCh¬£tD‘eùÜ
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g·r£r
.
	gtxt
.
	gCh¬£tM©ch
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g§x
.
	gBodyCÚ‹ÁHªdËr
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g§x
.
	gCÚ‹ÁHªdËrDecÜ©Ü
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g§x
.
	gT“CÚ‹ÁHªdËr
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	gtika
.
	g§x
.
	gXHTMLCÚ‹ÁHªdËr
;

32 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gA‰ribu‹s
;

33 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gCÚ‹ÁHªdËr
;

34 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ
;

35 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gh–³rs
.
	gA‰ribu‹sIm¶
;

37 
impÜt
 
	gcom
.
	gcybozu
.
	gÏbs
.
	gÏngd‘eù
.
	gD‘eùÜFaùÜy
;

38 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

39 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

41 
public
 cÏs 
	cCÏw”CÚv”t
 {

42 
	mby‹
[] 
	mcÚ‹Á
;

43 
	mcÚ‹ÁS¹
;

44 
	mh—d”S¹
;

45 
	mh—d”L’
;

46 
	mcÚ‹ÁL’
;

48 
Logg”
 
	mlog
 = Logg”.
g‘Logg”
(
CÏw”CÚv”t
.
şass
.
g‘Name
());

49 
Tika
 
	mtika
;

50 
fš®
 
	mMAX_FILE_LENGTH
 = (1 << 24);

51 
TikaCÚfig
 
	mcÚfig
;

52 
AutoD‘eùP¬£r
 
	mautoP¬£r
;

53 
P©‹º
 
	m·‰”n
 = P©‹º.
compe
("([^\r\n]+)");

55 
public
 
	$CÏw”CÚv”t
() {

56 
cÚfig
 = 
TikaCÚfig
.
	`g‘DeçuÉCÚfig
();

57 
tika
 = 
Ãw
 
	`Tika
(
cÚfig
);

58 
autoP¬£r
 = 
Ãw
 
	`AutoD‘eùP¬£r
(
cÚfig
);

61 
public
 
boŞ—n
 
	$»£t
(
by‹
[] 
key
, by‹[] 
ÃwCÚ‹Á
, 
h—d”L’
,

62 
cÚ‹ÁL’
, 
cÚ‹ÁS¹
, 
h—d”S¹
) {

63 ià(
cÚ‹ÁL’
 > 
MAX_FILE_LENGTH
) {

64 
MD5
 
md5
;

65 
Œy
 {

66 
md5
 = 
Ãw
 
	`MD5
(
key
, 
MD5
.
MD5L’
.
eight
, 0);

67 
log
.
	`”rÜ
("cÙ’ˆËngthØlÚg,key=" + 
md5
.
	`g‘HexSŒšg
());

68 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

70 
e
.
	`´štSckT¿û
();

73  
çl£
;

75 
this
.
cÚ‹Á
 = 
ÃwCÚ‹Á
;

76 
this
.
h—d”L’
 = headerLen;

77 
this
.
cÚ‹ÁL’
 = contentLen;

78 
this
.
cÚ‹ÁS¹
 = contentStart;

79 
this
.
h—d”S¹
 = headerStart;

80  
Œue
;

81 
	}
}

83 
public
 
	gby‹
[] 
	$cÚv”t
() {

84 
by‹
[] 
ÃwCÚ‹Á
 = 
nuÎ
;

85 
SŒšg
 
mimeTy³
 = 
nuÎ
;

86 
M‘ad©a
 
m‘ad©a
 = 
Ãw
 
	`M‘ad©a
();

87 ià(
h—d”L’
 > 0) {

88 
SŒšg
 
h—d”
 = 
Ãw
 
	`SŒšg
(
cÚ‹Á
, 
h—d”S¹
, 
h—d”L’
);

89 
SŒšg
[] 
h—d”s
 = 
h—d”
.
	`¥l™
("[\r\n]{1,}");

90 ià(
h—d”s
.
Ëngth
 > 0) {

91 
SŒšg
 
key
, 
v®ue
;

92 
i
;

93 
SŒšg
 
h—d
 : 
h—d”s
) {

94 ià((
i
 = 
h—d
.
	`šdexOf
(":")) != -1) {

95 
key
 = 
h—d
.
	`sub¡ršg
(0, 
i
).
	`Œim
();

96 
v®ue
 = 
h—d
.
	`sub¡ršg
(
i
 + 1).
	`Œim
();

97 
m‘ad©a
.
	`add
(
key
, 
v®ue
);

104 
P¬£r
 
·r£r
 = 
cÚfig
.
	`g‘P¬£r
();

105 
Ch¬£tD‘eùÜ
 
ch¬£tD‘eùÜ
 = 
Ãw
 
	`Ch¬£tD‘eùÜ
();

106 
D‘eùÜ
 
mimeTy³D‘eùÜ
 = 
cÚfig
.
	`g‘D‘eùÜ
();

107 
com
.
cybozu
.
Ïbs
.
Ïngd‘eù
.
D‘eùÜ
 
ÏnguageD‘eùÜ
 = 
nuÎ
;

108 
Œy
 {

109 
ÏnguageD‘eùÜ
 = 
D‘eùÜFaùÜy
.
	`ü—‹
();

110 
¡¬t
 = 
Sy¡em
.
	`cu¼’tTimeMlis
();

111 
MedŸTy³
 
ty³
 = 
mimeTy³D‘eùÜ
.
	`d‘eù
(
Ãw
 
	`By‹A¼ayIÅutSŒ—m
(

112 
cÚ‹Á
, 
this
.
cÚ‹ÁS¹
,his.
cÚ‹ÁL’
), 
m‘ad©a
);

113 
’d
 = 
Sy¡em
.
	`cu¼’tTimeMlis
();

117 ià(
ty³
.
	`g‘Ba£Ty³
().
	`g‘Subty³
().
	`m©ches
("(?i).*html.*|.*rss.*")) {

120 
SŒšg
 
šcomšgCh¬£t
 = 
m‘ad©a


121 .
	`g‘
(
M‘ad©a
.
CONTENT_ENCODING
);

122 
SŒšg
 
šcomšgTy³
 = 
m‘ad©a
.
	`g‘
(
M‘ad©a
.
CONTENT_TYPE
);

123 ià(
šcomšgCh¬£t
 =ğ
nuÎ
 && 
šcomšgTy³
 !=‚ull) {

125 
MedŸTy³
 
mt
 = MedŸTy³.
	`·r£
(
šcomšgTy³
);

126 ià(
mt
 !ğ
nuÎ
) {

127 
šcomšgCh¬£t
 = 
mt
.
	`g‘P¬am‘”s
().
	`g‘
("charset");

131 ià(
šcomšgCh¬£t
 !ğ
nuÎ
) {

132 
Œy
 {

133 
ch¬£tD‘eùÜ
.
	`£tDeş¬edEncodšg
(
šcomšgCh¬£t
);

134 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

139 
’d1
 = 
Sy¡em
.
	`cu¼’tTimeMlis
();

140 
ch¬£tD‘eùÜ
.
	`£tText
(
Ãw
 
	`By‹A¼ayIÅutSŒ—m
(
cÚ‹Á
,

141 
this
.
cÚ‹ÁS¹
,his.
cÚ‹ÁL’
));

142 
Ch¬£tM©ch
 
m©ch2
 : 
ch¬£tD‘eùÜ
.
	`d‘eùAÎ
()) {

143 ià(
Ch¬£t
.
	`isSuµÜ‹d
(
m©ch2
.
	`g‘Name
())) {

144 
m‘ad©a
.
	`£t
(
M‘ad©a
.
CONTENT_ENCODING
,

145 
m©ch2
.
	`g‘Name
());

149 
ch’d
 = 
Sy¡em
.
	`cu¼’tTimeMlis
();

151 
SŒšg
 
’codšg
 = 
m‘ad©a
.
	`g‘
(
M‘ad©a
.
CONTENT_ENCODING
);

152 ià(
’codšg
 =ğ
nuÎ
) {

153 
throw
 
Ãw
 
	`TikaExû±iÚ
(

157 
SŒšg
 
cÚ‹Á_ty³
 = 
ty³
.
	`g‘Ba£Ty³
().
	`toSŒšg
();

159 
SŒšg
 
s
 = 
Ãw
 
	`SŒšg
(
cÚ‹Á
, 
cÚ‹ÁS¹
, 
cÚ‹ÁL’
,

160 
’codšg
);

161 
s
 = s.
	`»¶aûAÎ
("[\r\n]{1,}", "");

162 
s
 = s.
	`»¶aûAÎ
("<script.*?</script>", "");

163 
s
 = s.
	`»¶aûAÎ
("<style.*?</style>", "");

164 
s
 = s.
	`»¶aûAÎ
("<[^<>]*?>", "");

165 
s
 = s.
	`»¶aûAÎ
("\\s{2,}", " ");

166 
ÏnguageD‘eùÜ
.
	`­³nd
(
s
);

167 
SŒšg
 
Ïnguage
 = "en";

168 
Œy
 {

169 
Ïnguage
 = 
ÏnguageD‘eùÜ
.
	`d‘eù
();

170 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

176 ià(
cÚ‹Á_ty³
 =ğ
nuÎ
)

177 
cÚ‹Á_ty³
 = "";

179 
by‹
 
b_cÚ‹Á
[] = 
Ãw
 
	`SŒšg
(
cÚ‹Á
, 
this
.
cÚ‹ÁS¹
,

180 
this
.
cÚ‹ÁL’
, 
’codšg
).
	`g‘By‹s
("utf-8");

181 
by‹
 
b_ty³
[] = 
cÚ‹Á_ty³
.
	`g‘By‹s
();

182 
by‹
 
b_Ïnge
[] = 
Ïnguage
.
	`g‘By‹s
();

183 
by‹
 
b_’codšg
[] = 
’codšg
.
	`g‘By‹s
();

188 
by‹
 
‹mp
[] = 
Ãw
 by‹[4 * 4 + 
b_ty³
.
Ëngth
 + 
b_Ïnge
.length

189 + 
b_’codšg
.
Ëngth
 + 
b_cÚ‹Á
.length];

190 
off£t
 = 0;

191 
by‹
 
num
[] = 
Numb”Ut
.
	`cÚv”tIÁToC
(
b_ty³
.
Ëngth
);

192 
Sy¡em
.
	`¬¿ycİy
(
num
, 0, 
‹mp
, 
off£t
, 4);

193 
off£t
 += 4;

194 
Sy¡em
.
	`¬¿ycİy
(
b_ty³
, 0, 
‹mp
, 
off£t
, b_ty³.
Ëngth
);

195 
off£t
 +ğ
b_ty³
.
Ëngth
;

197 
num
 = 
Numb”Ut
.
	`cÚv”tIÁToC
(
b_Ïnge
.
Ëngth
);

198 
Sy¡em
.
	`¬¿ycİy
(
num
, 0, 
‹mp
, 
off£t
, 4);

199 
off£t
 += 4;

200 
Sy¡em
.
	`¬¿ycİy
(
b_Ïnge
, 0, 
‹mp
, 
off£t
, b_Ïnge.
Ëngth
);

201 
off£t
 +ğ
b_Ïnge
.
Ëngth
;

203 
num
 = 
Numb”Ut
.
	`cÚv”tIÁToC
(
b_’codšg
.
Ëngth
);

204 
Sy¡em
.
	`¬¿ycİy
(
num
, 0, 
‹mp
, 
off£t
, 4);

205 
off£t
 += 4;

206 
Sy¡em
.
	`¬¿ycİy
(
b_’codšg
, 0, 
‹mp
, 
off£t
, b_’codšg.
Ëngth
);

207 
off£t
 +ğ
b_’codšg
.
Ëngth
;

209 
num
 = 
Numb”Ut
.
	`cÚv”tIÁToC
(
b_cÚ‹Á
.
Ëngth
);

210 
Sy¡em
.
	`¬¿ycİy
(
num
, 0, 
‹mp
, 
off£t
, 4);

211 
off£t
 += 4;

212 
Sy¡em
.
	`¬¿ycİy
(
b_cÚ‹Á
, 0, 
‹mp
, 
off£t
, b_cÚ‹Á.
Ëngth
);

213 
off£t
 +ğ
b_cÚ‹Á
.
Ëngth
;

215  
‹mp
;

220 
SŒšgWr™”
 
‹xtBufãr
 = 
Ãw
 
	`SŒšgWr™”
();

221 
ProfšgHªdËr
 
phªdËr
 = 
Ãw
 
	`ProfšgHªdËr
();

222 
s
 = 
Sy¡em
.
	`cu¼’tTimeMlis
();

223 
CÚ‹ÁHªdËr
 
hªdËr
 = 
Ãw
 
	`T“CÚ‹ÁHªdËr
(

224 
	`g‘TextCÚ‹ÁHªdËr
(
‹xtBufãr
), 
phªdËr
);

225 
P¬£CÚ‹xt
 
cÚ‹xt
 = 
Ãw
 
	`P¬£CÚ‹xt
();

226 
autoP¬£r
.
	`·r£
(
Ãw
 
	`By‹A¼ayIÅutSŒ—m
(
cÚ‹Á
,

227 
this
.
cÚ‹ÁS¹
,his.
cÚ‹ÁL’
), 
hªdËr
, 
m‘ad©a
,

228 
cÚ‹xt
);

229 
’d
 = 
Sy¡em
.
	`cu¼’tTimeMlis
();

232 
SŒšg
 
cÚv”tCÚ‹Á
 = 
‹xtBufãr
.
	`toSŒšg
();

233 
cÚv”tCÚ‹Á
 = cÚv”tCÚ‹Á.
	`»¶aûAÎ
("[\r\n]{1,}", "");

234 
cÚv”tCÚ‹Á
 = cÚv”tCÚ‹Á.
	`»¶aûAÎ
(

236 
cÚv”tCÚ‹Á
 = cÚv”tCÚ‹Á.
	`»¶aûAÎ
("<style.*?</style>",

238 
cÚv”tCÚ‹Á
 = cÚv”tCÚ‹Á.
	`»¶aûAÎ
("<[^<>]*?>", "");

239 
cÚv”tCÚ‹Á
 = cÚv”tCÚ‹Á.
	`»¶aûAÎ
("\\s{2,}", " ");

240 
ÏnguageD‘eùÜ
.
	`­³nd
(
cÚv”tCÚ‹Á
);

241 
SŒšg
 
Ïnguage
 = "en";

242 
Œy
 {

243 
Ïnguage
 = 
ÏnguageD‘eùÜ
.
	`d‘eù
();

244 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

247 
SŒšgBufãr
 
bufãr
 = 
Ãw
 
	`SŒšgBufãr
();

248 
SŒšg
[] 
keys
 = 
m‘ad©a
.
	`Çmes
();

249 
SŒšg
 
key
 : 
keys
) {

250 
bufãr
.
	`­³nd
(
key
 + ":" + 
m‘ad©a
.
	`g‘
(key) + "\r\n");

254 
SŒšg
 
cÚ‹Á_ty³
 = 
ty³
.
	`g‘Ba£Ty³
().
	`toSŒšg
();

256 
SŒšg
 
m‘a_šfo
 = 
bufãr
.
	`toSŒšg
();

258 ià(
cÚ‹Á_ty³
 =ğ
nuÎ
)

259 
cÚ‹Á_ty³
 = "";

260 ià(
m‘a_šfo
 =ğ
nuÎ
)

261 
m‘a_šfo
 = "";

264 
by‹
 
b_cÚ‹Á
[] = 
‹xtBufãr
.
	`toSŒšg
().
	`g‘By‹s
("utf-8");

265 
by‹
 
b_ty³
[] = 
cÚ‹Á_ty³
.
	`g‘By‹s
();

266 
by‹
 
b_Ïnge
[] = 
Ïnguage
.
	`g‘By‹s
();

267 
by‹
 
b_m‘a_šfo
[] = 
m‘a_šfo
.
	`g‘By‹s
("utf-8");

269 
by‹
 
‹mp
[] = 
Ãw
 by‹[4 * 4 + 
b_ty³
.
Ëngth
 + 
b_Ïnge
.length

270 + 
b_m‘a_šfo
.
Ëngth
 + 
b_cÚ‹Á
.length];

271 
off£t
 = 0;

272 
by‹
 
num
[] = 
Numb”Ut
.
	`cÚv”tIÁToC
(
b_ty³
.
Ëngth
);

273 
Sy¡em
.
	`¬¿ycİy
(
num
, 0, 
‹mp
, 
off£t
, 4);

274 
off£t
 += 4;

275 
Sy¡em
.
	`¬¿ycİy
(
b_ty³
, 0, 
‹mp
, 
off£t
, b_ty³.
Ëngth
);

276 
off£t
 +ğ
b_ty³
.
Ëngth
;

278 
num
 = 
Numb”Ut
.
	`cÚv”tIÁToC
(
b_Ïnge
.
Ëngth
);

279 
Sy¡em
.
	`¬¿ycİy
(
num
, 0, 
‹mp
, 
off£t
, 4);

280 
off£t
 += 4;

281 
Sy¡em
.
	`¬¿ycİy
(
b_Ïnge
, 0, 
‹mp
, 
off£t
, b_Ïnge.
Ëngth
);

282 
off£t
 +ğ
b_Ïnge
.
Ëngth
;

284 
num
 = 
Numb”Ut
.
	`cÚv”tIÁToC
(
b_m‘a_šfo
.
Ëngth
);

285 
Sy¡em
.
	`¬¿ycİy
(
num
, 0, 
‹mp
, 
off£t
, 4);

286 
off£t
 += 4;

287 
Sy¡em
.
	`¬¿ycİy
(
b_m‘a_šfo
, 0, 
‹mp
, 
off£t
,

288 
b_m‘a_šfo
.
Ëngth
);

289 
off£t
 +ğ
b_m‘a_šfo
.
Ëngth
;

291 
num
 = 
Numb”Ut
.
	`cÚv”tIÁToC
(
b_cÚ‹Á
.
Ëngth
);

292 
Sy¡em
.
	`¬¿ycİy
(
num
, 0, 
‹mp
, 
off£t
, 4);

293 
off£t
 += 4;

294 
Sy¡em
.
	`¬¿ycİy
(
b_cÚ‹Á
, 0, 
‹mp
, 
off£t
, b_cÚ‹Á.
Ëngth
);

295 
off£t
 +ğ
b_cÚ‹Á
.
Ëngth
;

297  
‹mp
;

299 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

301 
e
.
	`´štSckT¿û
();

304  
ÃwCÚ‹Á
;

305 
	}
}

307 
´iv©e
 
CÚ‹ÁHªdËr
 
	$g‘HtmlHªdËr
(
Wr™”
 
wr™”
)

308 
throws
 
T¿nsfÜm”CÚfigu¿tiÚExû±iÚ
 {

309 
SAXT¿nsfÜm”FaùÜy
 
çùÜy
 = (SAXTransformerFactory) SAXTransformerFactory

310 .
	`ÃwIn¡ªû
();

311 
T¿nsfÜm”HªdËr
 
hªdËr
 = 
çùÜy
.
	`ÃwT¿nsfÜm”HªdËr
();

312 
hªdËr
.
	`g‘T¿nsfÜm”
().
	`£tOuutPrİ”ty
(
OuutKeys
.
METHOD
, "html");

313 
hªdËr
.
	`£tResuÉ
(
Ãw
 
	`SŒ—mResuÉ
(
wr™”
));

314  
Ãw
 
	`CÚ‹ÁHªdËrDecÜ©Ü
(
hªdËr
) {

315 @
Ov”ride


316 
public
 
	`¡¬tEËm’t
(
SŒšg
 
uri
, SŒšg 
loÿlName
, SŒšg 
Çme
,

317 
A‰ribu‹s
 
©ts
è
throws
 
SAXExû±iÚ
 {

318 ià(
XHTMLCÚ‹ÁHªdËr
.
XHTML
.
	`equ®s
(
uri
)) {

319 
uri
 = 
nuÎ
;

321 ià(!"h—d".
	`equ®s
(
loÿlName
)) {

322 ià("img".
	`equ®s
(
loÿlName
)) {

323 
A‰ribu‹sIm¶
 
ÃwA‰rs
;

324 ià(
©ts
 
š¡ªûof
 
A‰ribu‹sIm¶
) {

325 
ÃwA‰rs
 = (
A‰ribu‹sIm¶
è
©ts
;

327 
ÃwA‰rs
 = 
Ãw
 
	`A‰ribu‹sIm¶
(
©ts
);

330 
i
 = 0; i < 
ÃwA‰rs
.
	`g‘L’gth
(); i++) {

331 ià("¤c".
	`equ®s
(
ÃwA‰rs
.
	`g‘LoÿlName
(
i
))) {

332 
SŒšg
 
¤c
 = 
ÃwA‰rs
.
	`g‘V®ue
(
i
);

336 
su³r
.
	`¡¬tEËm’t
(
uri
, 
loÿlName
, 
Çme
, 
ÃwA‰rs
);

338 
su³r
.
	`¡¬tEËm’t
(
uri
, 
loÿlName
, 
Çme
, 
©ts
);

343 @
Ov”ride


344 
public
 
	`’dEËm’t
(
SŒšg
 
uri
, SŒšg 
loÿlName
, SŒšg 
Çme
)

345 
throws
 
SAXExû±iÚ
 {

346 ià(
XHTMLCÚ‹ÁHªdËr
.
XHTML
.
	`equ®s
(
uri
)) {

347 
uri
 = 
nuÎ
;

349 ià(!"h—d".
	`equ®s
(
loÿlName
)) {

350 
su³r
.
	`’dEËm’t
(
uri
, 
loÿlName
, 
Çme
);

354 @
Ov”ride


355 
public
 
	`¡¬tP»fixM­pšg
(
SŒšg
 
´efix
, SŒšg 
uri
) {

358 @
Ov”ride


359 
public
 
	`’dP»fixM­pšg
(
SŒšg
 
´efix
) {

362 
	}
}

364 
´iv©e
 
CÚ‹ÁHªdËr
 
	$g‘TextCÚ‹ÁHªdËr
(
Wr™”
 
wr™”
) {

365  
Ãw
 
	`BodyCÚ‹ÁHªdËr
(
wr™”
);

366 
	}
}

368 
´iv©e
 
CÚ‹ÁHªdËr
 
	$g‘TextMašCÚ‹ÁHªdËr
(
Wr™”
 
wr™”
) {

369  
Ãw
 
	`Bo”peCÚ‹ÁHªdËr
(
wr™”
);

370 
	}
}

372 
´iv©e
 
CÚ‹ÁHªdËr
 
	$g‘XmlCÚ‹ÁHªdËr
(
Wr™”
 
wr™”
)

373 
throws
 
T¿nsfÜm”CÚfigu¿tiÚExû±iÚ
 {

374 
SAXT¿nsfÜm”FaùÜy
 
çùÜy
 = (SAXTransformerFactory) SAXTransformerFactory

375 .
	`ÃwIn¡ªû
();

376 
T¿nsfÜm”HªdËr
 
hªdËr
 = 
çùÜy
.
	`ÃwT¿nsfÜm”HªdËr
();

377 
hªdËr
.
	`g‘T¿nsfÜm”
().
	`£tOuutPrİ”ty
(
OuutKeys
.
METHOD
, "xml");

378 
hªdËr
.
	`£tResuÉ
(
Ãw
 
	`SŒ—mResuÉ
(
wr™”
));

379  
hªdËr
;

380 
	}
}

382 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

451 
	}
}

	@com/zhongsou/spider/hadoop/ClawerFileInputFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLog
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLogFaùÜy
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeStus
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeIÅutFÜm©
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeS¶™
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gIÅutS¶™
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚfigu¿bË
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRecÜdR—d”
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gR•Ü‹r
;

20 
public
 
şass
 
CÏw”FeIÅutFÜm©
 
ex‹nds
 
	gFeIÅutFÜm©
<
	gText
, Text> 
im¶em’ts
 
	gJobCÚfigu¿bË
 {

21 
´iv©e
 
fš®
 
Log
 
	gLOG
 = 
LogFaùÜy
.
g‘Log
(
CÏw”FeIÅutFÜm©
.
şass
);

23 
public
 
CÏw”FeIÅutFÜm©
() {

24 
£tMšS¶™Size
(
Sequ’ûFe
.
SYNC_INTERVAL
);

25 
	gLOG
.
šfo
("init clawer input format");

28 @
Ov”ride


29 
´Ùeùed
 
	gFeStus
[] 
li¡Stus
(
JobCÚf
 
job
è
throws
 
	gIOExû±iÚ
 {

30 
	gLOG
.
šfo
("list status");

31 
	gFeStus
[] 
	gfes
 = 
su³r
.
li¡Stus
(
job
);

32 
	gA¼ayLi¡
<
	gFeStus
> 
	gæi¡
 = 
Ãw
 
A¼ayLi¡
<
FeStus
>();

33 
	gi
 = 0; i < 
	gfes
.
	gËngth
; i++) {

34 
FeStus
 
	gfe
 = 
fes
[
i
];

35 ià(
	gfe
.
isDœ
()) {

36 
FeSy¡em
 
	gfs
 = 
fe
.
g‘P©h
().
g‘FeSy¡em
(
job
);

37 
FeStus
 
	gf
[] = 
fs
.
li¡Stus
(
fe
.
g‘P©h
());

38 
FeStus
 
	gf¡©us
 : 
f
) {

39 ià(
f¡©us
.
isDœ
()) {

42 
	gæi¡
.
add
(
f¡©us
);

46 
	gæi¡
.
add
(
fe
);

49  
	gæi¡
.
toA¼ay
(
Ãw
 
FeStus
[0]);

52 @
Ov”ride


53 
public
 
	gRecÜdR—d”
<
	gText
, Text> 
g‘RecÜdR—d”
(
IÅutS¶™
 
¥l™
, 
JobCÚf
 
job
, 
R•Ü‹r
 
»pÜ‹r
è
throws
 
	gIOExû±iÚ
 {

54 
	gLOG
.
šfo
("create‡‚ew„ecord„eader");

56  
Ãw
 
	gCÏw”FeR—d”
<
	gText
, Text>(
	gjob
, (
	gFeS¶™
è(
	g¥l™
));

59 @
Ov”ride


60 
public
 
cÚfigu»
(
JobCÚf
 
job
) {

62 
	gLOG
.
šfo
("start convert clawer file inputformat");

	@com/zhongsou/spider/hadoop/ClawerFileReader.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLog
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLogFaùÜy
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeIÅutFÜm©
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeS¶™
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gSequ’ûFeRecÜdR—d”
;

13 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

15 
public
 
şass
 
	gCÏw”FeR—d”
<
	gK
, 
	gV
> 
ex‹nds
 
	gSequ’ûFeRecÜdR—d”
<K, V> {

16 
´iv©e
 
fš®
 
Log
 
	gLOG
 = 
LogFaùÜy
.
g‘Log
(
FeIÅutFÜm©
.
şass
);

17 
CÏw”CÚv”t
 
	gşaw”CÚv”t
;

18 
´iv©e
 
fš®
 
	gMAX_CONVERT_LOG_TIME
 = 20;

20 
public
 
CÏw”FeR—d”
(
CÚfigu¿tiÚ
 
cÚf
, 
FeS¶™
 
¥l™
è
throws
 
	gIOExû±iÚ
 {

21 
su³r
(
cÚf
, 
¥l™
);

22 
	gLOG
.
”rÜ
("new clawer„ecord„eader");

24 
	gthis
.
	gşaw”CÚv”t
 = 
Ãw
 
CÏw”CÚv”t
();

28 @
Ov”ride


29 
public
 
synchrÚized
 
boŞ—n
 
Ãxt
(
K
 
key
, 
V
 
v®
è
throws
 
	gIOExû±iÚ
 {

31 
boŞ—n
 
	gt
 = 
su³r
.
Ãxt
(
key
, 
v®
);

33 ià(
	gt
 =ğ
çl£
)

34  
t
;

35 
Text
 
	gv
 = (Textè
v®
;

36 
Text
 
	gk
 = (Textè
key
;

37 
	gby‹
[] 
	gb
 = 
v
.
g‘By‹s
();

38 
	gby‹
[] 
	gÃwCÚ‹Á
 = 
nuÎ
;

40 ià(
	gb
[0] == '1') {

41 
·ck‘Num
 = 
Numb”Ut
.
»adIÁ
(
b
, 1);

42 
	g·ck‘L’
 = 0, 
	goff£t
 = 5;

43 
	gh—d”L’
 = 0, 
	gcÚ‹ÁL’
 = 0;

44 
	gu¾L’
 = 0;

45 
	gu¾off£t
 = 0;

46 ià(
	g·ck‘Num
 == 3) {

47 
i
 = 0; 
	gi
 < 2; i++) {

48 ià(
	gi
 == 1) {

49 
u¾L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

50 
	gu¾off£t
 = 
off£t
 + 4;

52 
	g·ck‘L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

53 
	goff£t
 +ğ
·ck‘L’
 + 4;

55 
	gcÚ‹ÁL’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

56 ià(
	gcÚ‹ÁL’
 < 0) {

57 
	gLOG
.
šfo
("error…acket");

58  
	gŒue
;

60 
	gthis
.
	gşaw”CÚv”t
.
»£t
(
k
.
g‘By‹s
(), 
b
, 
h—d”L’
, 
cÚ‹ÁL’
, 
off£t
 + 4, offset + 4);

62 } ià(
	g·ck‘Num
 == 4) {

63 
i
 = 0; 
	gi
 < 2; i++) {

64 ià(
	gi
 == 1) {

65 
u¾L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

66 
	gu¾off£t
 = 
off£t
 + 4;

68 
	g·ck‘L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

69 
	goff£t
 +ğ
·ck‘L’
 + 4;

72 
	gh—d”L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

73 
	gcÚ‹ÁL’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
 + 4 + 
h—d”L’
);

74 
	gthis
.
	gşaw”CÚv”t
.
»£t
(
k
.
g‘By‹s
(), 
b
, 
h—d”L’
, 
cÚ‹ÁL’
, 
off£t
 + 4 + headerLen + 4, offset + 4);

76 
	gLOG
.
”rÜ
("”rÜ…ack‘‚um=" + 
·ck‘Num
);

77  
	gŒue
;

79 
	gt1
 = 
Sy¡em
.
cu¼’tTimeMlis
();

80 
	gÃwCÚ‹Á
 = 
this
.
şaw”CÚv”t
.
cÚv”t
();

81 
	gt2
 = 
Sy¡em
.
cu¼’tTimeMlis
();

82 ià(
	gt2
 - 
	gt1
 > 
	gMAX_CONVERT_LOG_TIME
) {

83 
	gLOG
.
”rÜ
("cÚv”ˆd©¨fÜm©Ø¦ow,u¾=" + 
Ãw
 
SŒšg
(
b
, 
u¾off£t
, 
u¾L’
è+ "ime=" + (
t2
 - 
t1
è+ "\tcÚ‹Á†’gth=" + 
cÚ‹ÁL’
);

85 ià(
	gÃwCÚ‹Á
 !ğ
nuÎ
) {

86 
by‹
 
Ãwby‹
[] = 
Ãw
 by‹[
off£t
 + 
ÃwCÚ‹Á
.
Ëngth
];

87 
	gÃwby‹
[0] = '2';

88 
	g·ck‘Num
 = 6;

89 
by‹
 
	gnumb
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
·ck‘Num
);

90 
	gSy¡em
.
¬¿ycİy
(
numb
, 0, 
Ãwby‹
, 1, 4);

91 
	gSy¡em
.
¬¿ycİy
(
b
, 5, 
Ãwby‹
, 5, 
off£t
 - 5);

92 
	gSy¡em
.
¬¿ycİy
(
ÃwCÚ‹Á
, 0, 
Ãwby‹
, 
off£t
,‚ewCÚ‹Á.
Ëngth
);

93 
	gv
.
£t
(
Ãwby‹
, 0,‚ewby‹.
Ëngth
);

96 
	gLOG
.
”rÜ
("cÚv”ˆd©¨fÜm© faed,u¾=" + 
Ãw
 
SŒšg
(
b
, 
u¾off£t
, 
u¾L’
è+ "\tu¾Ën=" + u¾L’ + "\toff£t=" + u¾off£ˆ+ "\’gth=" + 
v
.
g‘L’gth
());

97 
	gb
[0] = '3';

98 
	gv
.
£t
(
b
, 0, 
v
.
g‘L’gth
());

101  
	gŒue
;

103  
	gŒue
;

	@com/zhongsou/spider/hadoop/DOMBuilder.java

26 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

28 
impÜt
 
	gjava
.
	gut
.
	gSck
;

30 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gComm’t
;

31 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gDocum’t
;

32 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gDocum’tF¿gm’t
;

33 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gEËm’t
;

34 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gNode
;

35 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gText
;

36 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gCDATASeùiÚ
;

38 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gA‰ribu‹s
;

39 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gCÚ‹ÁHªdËr
;

40 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gLoÿtÜ
;

41 
impÜt
 
	gÜg
.
	gxml
.
	g§x
.
	gext
.
	gLexiÿlHªdËr
;

47 
şass
 
DOMBud”


48 
im¶em’ts
 
	gCÚ‹ÁHªdËr
, 
	gLexiÿlHªdËr


52 
public
 
Docum’t
 
	gm_doc
;

55 
´Ùeùed
 
Node
 
	gm_cu¼’tNode
 = 
nuÎ
;

58 
public
 
Docum’tF¿gm’t
 
	gm_docF¿g
 = 
nuÎ
;

61 
´Ùeùed
 
Sck
 
	gm_–emSck
 = 
Ãw
 Stack();

70 
DOMBud”
(
Docum’t
 
doc
, 
Node
 
node
)

72 
	gm_doc
 = 
doc
;

73 
	gm_cu¼’tNode
 = 
node
;

83 
DOMBud”
(
Docum’t
 
doc
, 
Docum’tF¿gm’t
 
docF¿g
)

85 
	gm_doc
 = 
doc
;

86 
	gm_docF¿g
 = 
docF¿g
;

95 
DOMBud”
(
Docum’t
 
doc
)

97 
	gm_doc
 = 
doc
;

106 
Node
 
g‘RoÙNode
()

108  (
	gnuÎ
 !ğ
m_docF¿g
è? (
Node
èm_docF¿g : (Nodeè
m_doc
;

116 
Node
 
g‘Cu¼’tNode
()

118  
	gm_cu¼’tNode
;

126 
	gjava
.
	gio
.
Wr™”
 
g‘Wr™”
()

128  
	gnuÎ
;

136 
´Ùeùed
 
­³nd
(
Node
 
ÃwNode
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


139 
Node
 
	gcu¼’tNode
 = 
m_cu¼’tNode
;

141 ià(
	gnuÎ
 !ğ
cu¼’tNode
)

143 
cu¼’tNode
.
­³ndChd
(
ÃwNode
);

147 ià(
	gnuÎ
 !ğ
m_docF¿g
)

149 
m_docF¿g
.
­³ndChd
(
ÃwNode
);

153 
boŞ—n
 
	gok
 = 
Œue
;

154 
	gty³
 = 
ÃwNode
.
g‘NodeTy³
();

156 ià(
	gty³
 =ğ
Node
.
TEXT_NODE
)

158 
SŒšg
 
d©a
 = 
ÃwNode
.
g‘NodeV®ue
();

160 ià((
	gnuÎ
 !ğ
d©a
è&& (d©a.
Œim
().
Ëngth
() > 0))

162 
throw
 
Ãw
 
Üg
.
xml
.
§x
.
SAXExû±iÚ
("Warning: can't outputext before documentƒlement! Ignoring...");

165 
	gok
 = 
çl£
;

167 ià(
	gty³
 =ğ
Node
.
ELEMENT_NODE
)

169 ià(
m_doc
.
g‘Docum’tEËm’t
(è!ğ
nuÎ
)

171 
throw
 
Ãw
 
Üg
.
xml
.
§x
.
SAXExû±iÚ
("Can't have morehan one„oot on‡ DOM!");

175 ià(
	gok
)

176 
	gm_doc
.
­³ndChd
(
ÃwNode
);

205 
public
 
£tDocum’tLoÿtÜ
(
LoÿtÜ
 
loÿtÜ
)

218 
public
 
¡¬tDocum’t
(è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


233 
public
 
’dDocum’t
(è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


262 
public
 
¡¬tEËm’t
(

263 
SŒšg
 
ns
, SŒšg 
loÿlName
, SŒšg 
Çme
, 
A‰ribu‹s
 
©ts
)

264 
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


267 
EËm’t
 
	g–em
;

271 ià((
	gnuÎ
 =ğ
ns
è|| (ns.
Ëngth
() == 0))

272 
–em
 = 
m_doc
.
ü—‹EËm’tNS
(
nuÎ
,
Çme
);

274 
	g–em
 = 
m_doc
.
ü—‹EËm’tNS
(
ns
, 
Çme
);

276 
­³nd
(
–em
);

278 
	gŒy


280 
	gnA‰s
 = 
©ts
.
g‘L’gth
();

282 ià(0 !ğ
nA‰s
)

284 
i
 = 0; 
	gi
 < 
	gnA‰s
; i++)

289 ià(
	g©ts
.
g‘Ty³
(
i
).
equ®sIgnÜeCa£
("ID"))

290 
£tIDA‰ribu‹
(
©ts
.
g‘V®ue
(
i
), 
–em
);

292 
SŒšg
 
	g©ŒNS
 = 
©ts
.
g‘URI
(
i
);

294 if("".
equ®s
(
©ŒNS
))

295 
	g©ŒNS
 = 
nuÎ
;

300 
SŒšg
 
	g©ŒQName
 = 
©ts
.
g‘QName
(
i
);

303 ià(
	g©ŒQName
.
¡¬tsW™h
("xmlns:"))

304 
	g©ŒNS
 = "http://www.w3.org/2000/xmlns/";

307 
	g–em
.
£tA‰ribu‹NS
(
©ŒNS
,
©ŒQName
, 
©ts
.
g‘V®ue
(
i
));

313 
	gm_–emSck
.
push
(
–em
);

315 
	gm_cu¼’tNode
 = 
–em
;

319 
ÿtch
(
java
.
Ïng
.
Exû±iÚ
 
de
)

322 
throw
 
Ãw
 
	gÜg
.
	gxml
.
	g§x
.
SAXExû±iÚ
(
de
);

346 
public
 
’dEËm’t
(
SŒšg
 
ns
, SŒšg 
loÿlName
, SŒšg 
Çme
)

347 
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


349 
	gm_–emSck
.
pİ
();

350 
	gm_cu¼’tNode
 = 
m_–emSck
.
isEm±y
(è? 
nuÎ
 : (
Node
)m_–emSck.
³ek
();

359 
public
 
£tIDA‰ribu‹
(
SŒšg
 
id
, 
EËm’t
 
–em
)

388 
public
 
ch¬aù”s
(
ch
[], 
¡¬t
, 
Ëngth
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


390 if(
isOutsideDocEËm
()

391 && 
	gXMLCh¬aù”Recogniz”
.
isWh™eS·û
(
ch
, 
¡¬t
, 
Ëngth
))

394 ià(
	gm_šCD©a
)

396 
cd©a
(
ch
, 
¡¬t
, 
Ëngth
);

401 
SŒšg
 
	gs
 = 
Ãw
 SŒšg(
ch
, 
¡¬t
, 
Ëngth
);

402 
Node
 
	gchdNode
;

403 
	gchdNode
 = 
m_cu¼’tNode
 !ğ
nuÎ
 ? m_cu¼’tNode.
g‘La¡Chd
():‚ull;

404 ifĞ
	gchdNode
 !ğ
nuÎ
 && 
chdNode
.
g‘NodeTy³
(è=ğ
Node
.
TEXT_NODE
 ){

405 ((
Text
)
chdNode
).
­³ndD©a
(
s
);

408 
Text
 
	g‹xt
 = 
m_doc
.
ü—‹TextNode
(
s
);

409 
­³nd
(
‹xt
);

423 
public
 
ch¬aù”sRaw
(
ch
[], 
¡¬t
, 
Ëngth
)

424 
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


426 if(
isOutsideDocEËm
()

427 && 
	gXMLCh¬aù”Recogniz”
.
isWh™eS·û
(
ch
, 
¡¬t
, 
Ëngth
))

431 
SŒšg
 
	gs
 = 
Ãw
 SŒšg(
ch
, 
¡¬t
, 
Ëngth
);

433 
­³nd
(
m_doc
.
ü—‹ProûssšgIn¡ruùiÚ
("xslt-next-is-raw",

435 
­³nd
(
m_doc
.
ü—‹TextNode
(
s
));

452 
public
 
¡¬tEÁ™y
(
SŒšg
 
Çme
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


465 
public
 
’dEÁ™y
(
SŒšg
 
Çme
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ
{}

472 
public
 
’t™yReã»nû
(
SŒšg
 
Çme
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


474 
­³nd
(
m_doc
.
ü—‹EÁ™yReã»nû
(
Çme
));

499 
public
 
ignÜabËWh™e¥aû
(
ch
[], 
¡¬t
, 
Ëngth
)

500 
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


502 if(
isOutsideDocEËm
())

505 
SŒšg
 
	gs
 = 
Ãw
 SŒšg(
ch
, 
¡¬t
, 
Ëngth
);

507 
­³nd
(
m_doc
.
ü—‹TextNode
(
s
));

515 
´iv©e
 
boŞ—n
 
isOutsideDocEËm
()

517  (
	gnuÎ
 =ğ
m_docF¿g
è&& 
m_–emSck
.
size
(è=ğ0 && (
nuÎ
 =ğ
m_cu¼’tNode
 || m_cu¼’tNode.
g‘NodeTy³
(è=ğ
Node
.
DOCUMENT_NODE
);

535 
public
 
´oûssšgIn¡ruùiÚ
(
SŒšg
 
rg‘
, SŒšg 
d©a
)

536 
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


538 
­³nd
(
m_doc
.
ü—‹ProûssšgIn¡ruùiÚ
(
rg‘
, 
d©a
));

552 
public
 
comm’t
(
ch
[], 
¡¬t
, 
Ëngth
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


555 ià(
	gch
 =ğ
nuÎ
 || 
¡¬t
 < 0 || 
Ëngth
 >ğ(
ch
.length - start) ||†ength < 0) ;

556 
­³nd
(
m_doc
.
ü—‹Comm’t
(
Ãw
 
SŒšg
(
ch
, 
¡¬t
, 
Ëngth
)));

560 
´Ùeùed
 
boŞ—n
 
	gm_šCD©a
 = 
çl£
;

567 
public
 
¡¬tCDATA
(è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


569 
	gm_šCD©a
 = 
Œue
;

570 
­³nd
(
m_doc
.
ü—‹CDATASeùiÚ
(""));

578 
public
 
’dCDATA
(è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


580 
	gm_šCD©a
 = 
çl£
;

606 
public
 
cd©a
(
ch
[], 
¡¬t
, 
Ëngth
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


608 if(
isOutsideDocEËm
()

609 && 
	gXMLCh¬aù”Recogniz”
.
isWh™eS·û
(
ch
, 
¡¬t
, 
Ëngth
))

612 
SŒšg
 
	gs
 = 
Ãw
 SŒšg(
ch
, 
¡¬t
, 
Ëngth
);

615 
Node
 
	gn
 = 
m_cu¼’tNode
.
g‘La¡Chd
();

616 ià(
n
 
š¡ªûof
 
	gCDATASeùiÚ
)

617 ((
	gCDATASeùiÚ
)
	gn
).
­³ndD©a
(
s
);

618 ià(
n
 
š¡ªûof
 
	gComm’t
)

619 ((
	gComm’t
)
	gn
).
­³ndD©a
(
s
);

636 
public
 
¡¬tDTD
(
SŒšg
 
Çme
, SŒšg 
publicId
, SŒšg 
sy¡emId
)

637 
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


648 
public
 
’dDTD
(è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


682 
public
 
¡¬tP»fixM­pšg
(
SŒšg
 
´efix
, SŒšg 
uri
)

683 
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ


722 
public
 
’dP»fixM­pšg
(
SŒšg
 
´efix
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ
{}

739 
public
 
sk³dEÁ™y
(
SŒšg
 
Çme
è
throws
 
	gÜg
.
	gxml
.
	g§x
.
	gSAXExû±iÚ
{}

	@com/zhongsou/spider/hadoop/DoubleTextComparator.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËUts
;

6 
public
 cÏs 
	cDoubËTextCom·¿tÜ
 
ex‹nds
 
	mWr™abËCom·¿tÜ
 {

7 
public
 
	$DoubËTextCom·¿tÜ
() {

8 
	`su³r
(
PeText
.
şass
, 
Œue
);

12 
public
 
	$com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

13 
n1
 = 
Wr™abËUts
.
	`decodeVIÁSize
(
b1
[
s1
]);

14 
n2
 = 
Wr™abËUts
.
	`decodeVIÁSize
(
b2
[
s2
]);

15 
i
 = 
	`com·»By‹s
(
b1
, 
s1
 + 
n1
, 8, 
b2
, 
s2
 + 
n2
, 8);

16 ià(
i
 != 0)

17  
i
;

19  -
	`com·»By‹s
(
b1
, 
s1
 + 
n1
 + 8, 
l1
 -‚1 - 8, 
b2
, 
s2
 + 
n2
 + 8, 
l2
 -‚2 - 8);

20 
	}
}

	@com/zhongsou/spider/hadoop/DoubleTextGroupComparator.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

6 
public
 cÏs 
	cDoubËTextGroupCom·¿tÜ
 
ex‹nds
 
	mWr™abËCom·¿tÜ
 {

8 
´Ùeùed
 
	$DoubËTextGroupCom·¿tÜ
() {

9 
	`su³r
(
PeText
.
şass
, 
Œue
);

13 @
Ov”ride


14 
public
 
	$com·»
(
Wr™abËCom·¿bË
 
a
, Wr™abËCom·¿bË 
b
) {

16 
PeText
 
c
 = (PeTextè
a
;

17 
PeText
 
d
 = (PeTextè
b
;

18 
by‹
 
e
[] = 
c
.
	`g‘Text
().
	`g‘By‹s
();

19 
by‹
 
f
[] = 
d
.
	`g‘Text
().
	`g‘By‹s
();

21  
	`com·»By‹s
(
e
, 0, 8, 
f
, 0, 8);

22 
	}
}

	@com/zhongsou/spider/hadoop/DoubleTextPartition.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gP¬t™iÚ”
;

8 
public
 
şass
 
DoubËTextP¬t™iÚ
 
im¶em’ts
 
	gP¬t™iÚ”
<
	gPeText
, 
	gText
> {

9 
public
 
g‘P¬t™iÚ
(
PeText
 
key
, 
Text
 
v®ue
, 
numP¬t™iÚs
) {

10 
by‹
 
	gs
[] = 
key
.
g‘Text
().
g‘By‹s
();

11  
	gM©h
.
abs
(
By‹s
.
toSŒšg
(
s
, 0, 8).
hashCode
(è* 127è% 
	gnumP¬t™iÚs
;

14 @
Ov”ride


15 
public
 
cÚfigu»
(
JobCÚf
 
job
) {

	@com/zhongsou/spider/hadoop/FileInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	g‹xt
.
	gSim¶eD©eFÜm©
;

4 
impÜt
 
	gjava
.
	gut
.
	gD©e
;

6 
public
 cÏs 
	cFeInfo
 {

7 
´iv©e
 
SŒšg
 
	m·th
;

8 
boŞ—n
 
	misDœ
;

9 
´iv©e
 
SŒšg
 
	m³rmissiÚ
;

10 
´iv©e
 
	mÏ¡ModifyTime
;

11 
´iv©e
 
	mfeL’
;

12 
Sim¶eD©eFÜm©
 
	mfÜm©
 = 
Ãw
 SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

14 
public
 
SŒšg
 
	$g‘P©h
() {

15  
·th
;

18 
public
 
	$g‘FeL’
() {

19  
feL’
;

20 
	}
}

22 
public
 
	$£tFeL’
(
feL’
) {

23 
this
.
feL’
 = fileLen;

24 
	}
}

26 
public
 
	$£tP©h
(
SŒšg
 
·th
) {

27 
this
.
·th
 =…ath;

28 
	}
}

30 
public
 
boŞ—n
 
	$isDœ
() {

31  
isDœ
;

32 
	}
}

34 
public
 
	$£tDœ
(
boŞ—n
 
isDœ
) {

35 
this
.
isDœ
 = isDir;

36 
	}
}

38 
public
 
SŒšg
 
	$g‘P”missiÚ
() {

39  
³rmissiÚ
;

40 
	}
}

42 
public
 
	$£tP”missiÚ
(
SŒšg
 
³rmissiÚ
) {

43 
this
.
³rmissiÚ
 =…ermission;

44 
	}
}

46 
public
 
	$g‘La¡ModifyTime
() {

47  
Ï¡ModifyTime
;

48 
	}
}

50 
public
 
	$£tLa¡ModifyTime
(
Ï¡ModifyTime
) {

51 
this
.
Ï¡ModifyTime
 =†astModifyTime;

52 
	}
}

54 
public
 
SŒšg
 
	$toSŒšg
() {

55 
SŒšgBufãr
 
bufãr
 = 
Ãw
 
	`SŒšgBufãr
();

56 
bufãr
.
	`­³nd
(
this
.
·th
 + "\t" + 
fÜm©
.
	`fÜm©
(
Ãw
 
	`D©e
Ñhis.
	`g‘La¡ModifyTime
())è+ "\t" +his.
feL’
 + "\t" +his.
isDœ
);

57  
bufãr
.
	`toSŒšg
();

59 
	}
}

	@com/zhongsou/spider/hadoop/HDFSUtil.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

5 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

6 
impÜt
 
	gjava
.
	gut
.
	gM­
.
	gEÁry
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gÏng
.
	gexû±iÚ
.
	gExû±iÚUts
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeStus
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghdfs
.
	gDi¡ribu‹dFeSy¡em
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghdfs
.
	g´ÙocŞ
.
	gD©ªodeInfo
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abË
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

21 
public
 cÏs 
	cHDFSUt
 {

22 
´iv©e
 
Logg”
 
	mlog
 = Logg”.
g‘Logg”
(
HDFSUt
.
şass
);

24 
public
 
synchrÚized
 
FeSy¡em
 
	$g‘FeSy¡em
(
SŒšg
 

, 
pÜt
) {

25 
FeSy¡em
 
fs
 = 
nuÎ
;

26 
SŒšg
 
u¾
 = "hdfs://" + 

 + ":" + SŒšg.
	`v®ueOf
(
pÜt
);

27 
CÚfigu¿tiÚ
 
cÚfig
 = 
Ãw
 
	`CÚfigu¿tiÚ
();

28 
cÚfig
.
	`£t
("fs.deçuÉ.Çme", 
u¾
);

29 
Œy
 {

30 
fs
 = 
FeSy¡em
.
	`g‘
(
cÚfig
);

31 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

32 
log
.
	`”rÜ
("g‘FeSy¡em faed :" + 
Exû±iÚUts
.
	`g‘FuÎSckT¿û
(
e
));

34  
fs
;

37 
public
 
synchrÚized
 
FeSy¡em
 
	$g‘FeSy¡em
() {

38 
FeSy¡em
 
fs
 = 
nuÎ
;

39 
CÚfigu¿tiÚ
 
cÚfig
 = 
Ãw
 
	`CÚfigu¿tiÚ
();

40 
Œy
 {

41 
fs
 = 
FeSy¡em
.
	`g‘
(
cÚfig
);

42 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

43 
log
.
	`”rÜ
("g‘FeSy¡em faed :" + 
Exû±iÚUts
.
	`g‘FuÎSckT¿û
(
e
));

45  
fs
;

46 
	}
}

48 
public
 
synchrÚized
 
	$li¡Node
(
FeSy¡em
 
fs
) {

49 
Di¡ribu‹dFeSy¡em
 
dfs
 = (Di¡ribu‹dFeSy¡emè
fs
;

50 
Œy
 {

51 
D©ªodeInfo
[] 
šfos
 = 
dfs
.
	`g‘D©aNodeSts
();

52 
D©ªodeInfo
 
node
 : 
šfos
) {

53 
Sy¡em
.
out
.
	`´šn
("Ho¡Name: " + 
node
.
	`g‘Ho¡Name
(è+ "/n" +‚ode.
	`g‘D©ªodeR•Üt
());

54 
Sy¡em
.
out
.
	`´šn
("--------------------------------");

56 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

57 
log
.
	`”rÜ
("li¡‚odli¡ faed :" + 
Exû±iÚUts
.
	`g‘FuÎSckT¿û
(
e
));

59 
	}
}

66 
public
 
synchrÚized
 
	$li¡CÚfig
(
FeSy¡em
 
fs
) {

67 
I‹¿tÜ
<
EÁry
<
SŒšg
, SŒšg>> 
’Œys
 = 
fs
.
	`g‘CÚf
().
	`™”©Ü
();

68 
’Œys
.
	`hasNext
()) {

69 
EÁry
<
SŒšg
, SŒšg> 
™em
 = 
’Œys
.
	`Ãxt
();

70 
log
.
	`šfo
(
™em
.
	`g‘Key
(è+ ": " + i‹m.
	`g‘V®ue
());

72 
	}
}

80 
public
 
synchrÚized
 
	$mkdœs
(
FeSy¡em
 
fs
, 
SŒšg
 
dœName
) {

82 
P©h
 
¤c
 = 
Ãw
 
	`P©h
(
dœName
);

84 
boŞ—n
 
succ
;

85 
Œy
 {

86 ià(
fs
.
	`exi¡s
(
¤c
))

88 
succ
 = 
fs
.
	`mkdœs
(
¤c
);

89 ià(
succ
) {

90 
log
.
	`šfo
("ü—‹ dœeùÜy " + 
dœName
 + " successed. ");

92 
log
.
	`šfo
("ü—‹ dœeùÜy " + 
dœName
 + " failed. ");

94 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

95 
log
.
	`”rÜ
("ü—‹ dœeùÜy " + 
dœName
 + " faed :" + 
Exû±iÚUts
.
	`g‘FuÎSckT¿û
(
e
));

97 
	}
}

105 
public
 
synchrÚized
 
	$rmdœs
(
FeSy¡em
 
fs
, 
SŒšg
 
dœName
) {

107 
SŒšg
 
dœ
 = 
dœName
;

108 
P©h
 
¤c
 = 
Ãw
 
	`P©h
(
dœ
);

109 
boŞ—n
 
succ
;

110 
Œy
 {

111 
succ
 = 
fs
.
	`d–‘e
(
¤c
, 
Œue
);

112 ià(
succ
) {

113 
log
.
	`šfo
("»movdœeùÜy " + 
dœ
 + " successed. ");

115 
log
.
	`šfo
("»movdœeùÜy " + 
dœ
 + " failed. ");

117 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

118 
log
.
	`”rÜ
("»movdœeùÜy " + 
dœ
 + " faed :" + 
Exû±iÚUts
.
	`g‘FuÎSckT¿û
(
e
));

120 
	}
}

129 
public
 
synchrÚized
 
boŞ—n
 
	$u¶ßd
(
FeSy¡em
 
fs
, 
SŒšg
 
loÿl
, SŒšg 
»mÙe
) {

131 
P©h
 
d¡
 = 
Ãw
 
	`P©h
(
»mÙe
);

132 
P©h
 
¤c
 = 
Ãw
 
	`P©h
(
loÿl
);

133 
Œy
 {

134 
fs
.
	`cİyFromLoÿlFe
(
çl£
, 
Œue
, 
¤c
, 
d¡
);

135 
log
.
	`šfo
("u¶ßd " + 
loÿl
 + "Ø " + 
»mÙe
 + " successed. ");

136 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

137 
log
.
	`”rÜ
("u¶ßd " + 
loÿl
 + "Ø " + 
»mÙe
 + " faed :" + 
Exû±iÚUts
.
	`g‘FuÎSckT¿û
(
e
));

138  
çl£
;

140  
Œue
;

141 
	}
}

150 
public
 
synchrÚized
 
	$dowÆßd
(
FeSy¡em
 
fs
, 
SŒšg
 
loÿl
, SŒšg 
»mÙe
) {

151 
P©h
 
d¡
 = 
Ãw
 
	`P©h
(
»mÙe
);

152 
P©h
 
¤c
 = 
Ãw
 
	`P©h
(
loÿl
);

153 
Œy
 {

154 
fs
.
	`cİyToLoÿlFe
(
çl£
, 
d¡
, 
¤c
);

155 
log
.
	`šfo
("dowÆßd from " + 
»mÙe
 + "Ø " + 
loÿl
 + " successed. ");

156 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

157 
log
.
	`”rÜ
("dowÆßd from " + 
»mÙe
 + "Ø " + 
loÿl
 + " faed :" + 
Exû±iÚUts
.
	`g‘FuÎSckT¿û
(
e
));

159 
	}
}

167 
public
 
synchrÚized
 
SŒšg
 
	$cÚv”tSize
(
size
) {

168 
SŒšg
 
»suÉ
 = SŒšg.
	`v®ueOf
(
size
);

169 ià(
size
 < 1024 * 1024) {

170 
»suÉ
 = 
SŒšg
.
	`v®ueOf
(
size
 / 1024) + " KB";

171 } ià(
size
 >= 1024 * 1024 && size < 1024 * 1024 * 1024) {

172 
»suÉ
 = 
SŒšg
.
	`v®ueOf
(
size
 / 1024 / 1024) + " MB";

173 } ià(
size
 >= 1024 * 1024 * 1024) {

174 
»suÉ
 = 
SŒšg
.
	`v®ueOf
(
size
 / 1024 / 1024 / 1024) + " GB";

176 
»suÉ
 =„esult + " B";

178  
»suÉ
;

179 
	}
}

181 
public
 
synchrÚized
 
boŞ—n
 
	$»ÇmeFe
(
FeSy¡em
 
fs
, 
SŒšg
 
ŞdP©h
, SŒšg 
ÃwP©h
) {

182 
Œy
 {

183 ià(
ŞdP©h
 =ğ
nuÎ
 || 
ÃwP©h
 =ğnuÎ || oldP©h.
	`equ®s
("") ||‚ewPath.equals(""))

184  
çl£
;

185 
SŒšg
 
fŞd”
 = 
ÃwP©h
;

186 ià(!
ÃwP©h
.
	`’dsW™h
("/")) {

187 
fŞd”
 = 
ÃwP©h
.
	`sub¡ršg
(0,‚ewP©h.
	`Ï¡IndexOf
("/"));

189 
P©h
 
t
 = 
Ãw
 
	`P©h
(
fŞd”
);

190 ià(!
fs
.
	`exi¡s
(
t
)) {

191 
boŞ—n
 
æag
 = 
fs
.
	`mkdœs
(
t
);

192 ià(
æag
 =ğ
çl£
) {

193 
log
.
	`šfo
("ü—‹ d¡ fŞd” faed" + 
t
.
	`toSŒšg
());

194  
çl£
;

198  
fs
.
	`»Çme
(
Ãw
 
	`P©h
(
ŞdP©h
),‚ew P©h(
ÃwP©h
));

199 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

201 
e
.
	`´štSckT¿û
();

203  
çl£
;

204 
	}
}

216 
public
 
synchrÚized
 
boŞ—n
 
	$rmFes
(
FeSy¡em
 
fs
, 
SŒšg
 
¤cP©‹º
) {

217 ià(
¤cP©‹º
 =ğ
nuÎ
 || srcP©‹º.
	`equ®s
(""))

218  
çl£
;

220 
Œy
 {

221 
FeStus
 
fe¡©us
[] = 
fs
.
	`globStus
(
Ãw
 
	`P©h
(
¤cP©‹º
));

222 ià(
fe¡©us
 !ğ
nuÎ
 && fe¡©us.
Ëngth
 > 0) {

224 
FeStus
 
fe
 : 
fe¡©us
) {

225 
fs
.
	`d–‘e
(
fe
.
	`g‘P©h
(), 
çl£
);

229 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

231 
e
.
	`´štSckT¿û
();

232  
çl£
;

234  
Œue
;

235 
	}
}

237 
public
 
synchrÚized
 
boŞ—n
 
	$moveFes
(
FeSy¡em
 
fs
, 
SŒšg
 
¤cP©‹º
, SŒšg 
de¡
) {

238 ià(
¤cP©‹º
 =ğ
nuÎ
 || 
de¡
 =ğnuÎ || srcP©‹º.
	`equ®s
("") || dest.equals(""))

239  
çl£
;

241 
Œy
 {

242 
FeStus
 
fe¡©us
[] = 
fs
.
	`globStus
(
Ãw
 
	`P©h
(
¤cP©‹º
));

243 ià(
fe¡©us
 !ğ
nuÎ
 && fe¡©us.
Ëngth
 > 0) {

244 
P©h
 
de¡P©h
 = 
Ãw
 
	`P©h
(
de¡
);

245 ià(!
fs
.
	`exi¡s
(
de¡P©h
)) {

246 
fs
.
	`mkdœs
(
de¡P©h
);

248 
FeStus
 
fe
 : 
fe¡©us
) {

249 
fs
.
	`»Çme
(
fe
.
	`g‘P©h
(), 
de¡P©h
);

253 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

255 
e
.
	`´štSckT¿û
();

256  
çl£
;

258  
Œue
;

259 
	}
}

267 
public
 
synchrÚized
 
li¡Fe
(
FeSy¡em
 
fs
, 
SŒšg
 
·th
, 
Li¡
<
FeInfo
> 
šfoLi¡
, 
boŞ—n
 
isRecursive
) {

268 
P©h
 
	gwÜkDœ
 = 
fs
.
g‘WÜkšgDœeùÜy
();

269 
P©h
 
	gd¡
;

270 ià(
	gnuÎ
 =ğ
·th
 || "".
equ®s
(path)) {

271 
d¡
 = 
Ãw
 
P©h
(
wÜkDœ
 + "/" + 
·th
);

273 
	gd¡
 = 
Ãw
 
P©h
(
·th
);

275 
	gŒy
 {

276 
SŒšg
 
	g»ÏtiveP©h
 = "";

277 
	gFeStus
[] 
	gfLi¡
 = 
fs
.
li¡Stus
(
d¡
);

278 ià(
	gfLi¡
 !ğ
nuÎ
) {

279 
FeStus
 
f
 : 
fLi¡
) {

280 ià(
nuÎ
 !ğ
f
) {

281 
FeInfo
 
šfo
 = 
Ãw
 FileInfo();

282 ià(
	gf
.
g‘P©h
().
g‘Name
().
¡¬tsW™h
("_"))

284 ià(!
	gf
.
g‘P©h
().
g‘P¬’t
().
g‘Name
().
equ®s
(""))

285 
	g»ÏtiveP©h
 = 
Ãw
 
SŒšgBufãr
().
­³nd
(
f
.
g‘P©h
().
g‘P¬’t
()).­³nd("/").­³nd(f.g‘P©h().
g‘Name
()).
toSŒšg
();

287 
	g»ÏtiveP©h
 = 
Ãw
 
SŒšgBufãr
().
­³nd
(
f
.
g‘P©h
().
g‘P¬’t
()).­³nd(f.g‘P©h().
g‘Name
()).
toSŒšg
();

288 
	gšfo
.
£tDœ
(
f
.
isDœ
());

289 
	gšfo
.
£tP©h
(
»ÏtiveP©h
);

290 
	gšfo
.
£tLa¡ModifyTime
(
f
.
g‘ModifiÿtiÚTime
());

291 
	gšfo
.
£tFeL’
(
f
.
g‘L’
());

292 
	gšfoLi¡
.
add
(
šfo
);

293 ià(
	gf
.
isDœ
(è&& 
	gisRecursive
) {

294 
li¡Fe
(
fs
, 
»ÏtiveP©h
, 
šfoLi¡
, 
isRecursive
);

299 } 
ÿtch
 (
Exû±iÚ
 
e
) {

300 
	glog
.
”rÜ
("li¡ fe oà" + 
·th
 + " faed :" + 
Exû±iÚUts
.
g‘FuÎSckT¿û
(
e
));

301 } 
	gfš®ly
 {

323 
public
 <
A
 
ex‹nds
 
	gWr™abË
, 
B
ƒx‹nd Wr™abË> 
boŞ—n
 
m”geMuÉËSeqFe2OÃ
(
FeSy¡em
 
fs
, 
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
šputP©‹º
, SŒšg 
ouutFe
, 
CÏss
<A> 
Keyşass
, CÏss<B> 
V®ue
) {

324 
boŞ—n
 
	gæag
 = 
çl£
;

325 
	gŒy
 {

326 
P©h
 
	gouut
 = 
Ãw
 P©h(
ouutFe
);

327 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
ouut
, 
Keyşass
, 
V®ue
);

328 
FeStus
 
	g¡©us
[] = 
fs
.
globStus
(
Ãw
 
P©h
(
šputP©‹º
));

329 
A
 
	gk
 = 
Keyşass
.
ÃwIn¡ªû
();

330 
B
 
	gv
 = 
nuÎ
;

331 ià(!
	gV®ue
.
g‘Name
().
equ®s
("NullWritable")) {

332 
	gSy¡em
.
	gout
.
´šn
("null value");

333 
	gv
 = (
B
è
NuÎWr™abË
.
g‘
();

335 
	gv
 = 
V®ue
.
ÃwIn¡ªû
();

338 
FeStus
 
	gs
 : 
¡©us
) {

339 ià(
s
.
g‘P©h
().
equ®s
(
ouut
))

341 
	gSequ’ûFe
.
R—d”
 
	g»ad”
 = 
nuÎ
;

342 
	g»ad”
 = 
Ãw
 
Sequ’ûFe
.
R—d”
(
fs
, 
s
.
g‘P©h
(), 
cÚf
);

343 ià(
	g»ad”
.
g‘KeyCÏssName
().
equ®s
(
Keyşass
.
g‘Name
()è&&„—d”.
g‘V®ueCÏssName
().equ®s(
V®ue
.getName())) {

344 
	g»ad”
.
Ãxt
(
k
, 
v
)) {

345 
	gwr™”
.
­³nd
(
k
, 
v
);

348 
	gSy¡em
.
	gout
.
´šn
(
s
.
g‘P©h
(è+ "\ˆkey cÏs " + 
»ad”
.
g‘KeyCÏssName
(è+ "\ˆv®uşas " +„—d”.
g‘V®ueCÏssName
(è+ " dÛ¢'ˆequ® " + 
Keyşass
.
g‘Name
()

349 + "\ˆv®uşass=" + 
V®ue
.
g‘Name
());

351 
	g»ad”
.
şo£
();

353 
	gwr™”
.
şo£
();

354 
	gæag
 = 
Œue
;

355 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

357 
	ge
.
´štSckT¿û
();

358 } 
ÿtch
 (
In¡ªtŸtiÚExû±iÚ
 
e
) {

360 
	ge
.
´štSckT¿û
();

361 } 
ÿtch
 (
IÎeg®AcûssExû±iÚ
 
e
) {

363 
	ge
.
´štSckT¿û
();

365  
	gæag
;

368 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

369 
FeSy¡em
 
fs
 = 
HDFSUt
.
	`g‘FeSy¡em
();

376 
HDFSUt
.
	`m”geMuÉËSeqFe2OÃ
(
fs
, 
Ãw
 
	`CÚfigu¿tiÚ
(), "/spider_data/clawer_all_docid/newdocid20121123060831*", "/spider_data/clawer_all_docid/newdocid_20121123060831",

377 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

378 
HDFSUt
.
	`rmFes
(
fs
, "/spider_data/clawer_all_docid/newdocid20121123060831*");

379 
	}
}

	@com/zhongsou/spider/hadoop/HadoopFileSystemManager.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

4 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

8 
public
 cÏs 
	cHadoİFeSy¡emMªag”
 {

10 
´iv©e
 
HadoİFeSy¡emMªag”
 
	m_£lf
 = 
nuÎ
;

11 
FeSy¡em
 
	mfs
 = 
nuÎ
;

13 
´iv©e
 
	$HadoİFeSy¡emMªag”
() {

14 
fs
 = 
HDFSUt
.
	`g‘FeSy¡em
();

17 
public
 
FeSy¡em
 
	$g‘FeSy¡em
()

19  
fs
;

20 
	}
}

21 
public
 
synchrÚized
 
HadoİFeSy¡emMªag”
 
	$g‘In¡ªû
() {

22 ià(
_£lf
 =ğ
nuÎ
) {

23 
	`synchrÚized
 (
HadoİFeSy¡emMªag”
.
şass
) {

24 ià(
_£lf
 =ğ
nuÎ
) {

25 
_£lf
 = 
Ãw
 
	`HadoİFeSy¡emMªag”
();

29  
_£lf
;

30 
	}
}

32 
public
 
	gLi¡
<
	gFeInfo
> 
	$li¡Fe
(
SŒšg
 
dœeùÜy
) {

33 ià(
dœeùÜy
 =ğ
nuÎ
 || dœeùÜy.
	`equ®s
(""))

34 
dœeùÜy
 = ".";

35 
LškedLi¡
<
FeInfo
> 
i¡
 = 
Ãw
 LinkedList<FileInfo>();

36 
HDFSUt
.
	`li¡Fe
(
fs
, 
dœeùÜy
, 
i¡
, 
çl£
);

37  
i¡
;

38 
	}
}

40 
public
 
	gLi¡
<
	gFeInfo
> 
	$li¡AÎFes
(
SŒšg
 
dœeùÜy
) {

41 
LškedLi¡
<
FeInfo
> 
i¡
 = 
Ãw
 LinkedList<FileInfo>();

42 
HDFSUt
.
	`li¡Fe
(
fs
, 
dœeùÜy
, 
i¡
, 
Œue
);

43  
i¡
;

44 
	}
}

	@com/zhongsou/spider/hadoop/HostInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËUts
;

11 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

13 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

15 
public
 
şass
 
Ho¡Info
 
im¶em’ts
 
	gWr™abËCom·¿bË
<
	gHo¡Info
>, 
	gClÚ—bË
 {

16 
by‹
 
	gdomaš
[];

17 
by‹
 
	gho¡
[];

19 
public
 
Ho¡Info
() {

20 
	gthis
.
	gdomaš
 = 
Ãw
 
by‹
[8];

24 
public
 
	gby‹
[] 
g‘Domaš
() {

25  
	gdomaš
;

28 
public
 
£tDomaš
(
by‹
[] 
domaš
) {

29 
	gthis
.
	gdomaš
 = 
domaš
;

32 
public
 
	gby‹
[] 
g‘Ho¡
() {

33  
	gho¡
;

36 
public
 
£tHo¡
(
by‹
[] 
ho¡
) {

37 
	gthis
.
	gho¡
 = 
ho¡
;

40 @
Ov”ride


41 
public
 
wr™e
(
D©aOuut
 
out
è
throws
 
	gIOExû±iÚ
 {

43 
	gout
.
wr™e
(
domaš
);

44 ià(
	gho¡
 !ğ
nuÎ
 && 
ho¡
.
Ëngth
 > 0) {

45 
Wr™abËUts
.
wr™eVIÁ
(
out
, 
ho¡
.
Ëngth
);

46 
	gout
.
wr™e
(
ho¡
);

48 
	gWr™abËUts
.
wr™eVIÁ
(
out
, 0);

52 @
Ov”ride


53 
public
 
»adF›lds
(
D©aIÅut
 
š
è
throws
 
	gIOExû±iÚ
 {

55 
	gš
.
»adFuÎy
(
this
.
domaš
);

56 
	gËngth
 = 
Wr™abËUts
.
»adVIÁ
(
š
);

57 
	gthis
.
	gho¡
 = 
Ãw
 
by‹
[
Ëngth
];

58 
	gš
.
»adFuÎy
(
this
.
ho¡
);

61 şas 
	cHo¡InfoCom·¿tÜ
 
ex‹nds
 
	gWr™abËCom·¿tÜ
 {

62 
public
 
Ho¡InfoCom·¿tÜ
() {

63 
su³r
(
Ho¡Info
.
şass
, 
Œue
);

66 
public
 
com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

67 
	gi
 = 
com·»By‹s
(
b1
, 
s1
, 8, 
b2
, 
s2
, 8);

68 ià(
	gi
 != 0)

69  
i
;

71 
	gn3
 = 
Wr™abËUts
.
decodeVIÁSize
(
b1
[
s1
 + 8]);

72 
	gn4
 = 
Wr™abËUts
.
decodeVIÁSize
(
b2
[
s2
 + 8]);

73 
	gi
 = 
com·»By‹s
(
b1
, 
s1
 + 8 + 
n3
, 
l1
 - 8 -‚3, 
b2
, 
s2
 + 8 + 
n4
, 
l2
 - 8 -‚4);

74  
	gi
;

88 @
Ov”ride


89 
public
 
SŒšg
 
	$toSŒšg
() {

91 
SŒšgBufãr
 
bufãr
 = 
Ãw
 
	`SŒšgBufãr
();

92 
bufãr
.
	`­³nd
(
Numb”Ut
.
	`g‘HexSŒšg
(
this
.
domaš
è+ "\t" + 
Ãw
 
	`SŒšg
Ñhis.
ho¡
));

93  
bufãr
.
	`toSŒšg
();

94 
	}
}

97 
	gWr™abËCom·¿tÜ
.
defše
(
Ho¡Info
.
şass
, 
Ãw
 
Ho¡InfoCom·¿tÜ
());

100 @
Ov”ride


101 
public
 
	$com·»To
(
Ho¡Info
 
o
) {

103 
cmp
 = 
Wr™abËCom·¿tÜ
.
	`com·»By‹s
(
domaš
, 0, 8, 
o
.domain, 0, 8);

104 ià(
cmp
 != 0) {

105  
cmp
;

107  
Wr™abËCom·¿tÜ
.
	`com·»By‹s
(
ho¡
, 0, ho¡.
Ëngth
, 
o
.
	`g‘Ho¡
(), 0, o.getHost().length);

108 
	}
}

110 @
Ov”ride


111 
´Ùeùed
 
Objeù
 
	$şÚe
(è
throws
 
ClÚeNÙSuµÜ‹dExû±iÚ
 {

113  
su³r
.
	`şÚe
();

114 
	}
}

	@com/zhongsou/spider/hadoop/HostSequenceFileInputFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

5 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gBlockLoÿtiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeStus
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gIÅutS¶™
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJobCÚ‹xt
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeS¶™
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

15 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

29 
public
 
şass
 
	gHo¡Sequ’ûFeIÅutFÜm©
<
	gK
, 
	gV
> 
ex‹nds
 
	gSequ’ûFeIÅutFÜm©
<K, V> {

31 
´iv©e
 
fš®
 
	gSPLIT_SLOP
 = 1.1;

32 
´iv©e
 
fš®
 
SŒšg
 
	gNUM_INPUT_FILES
 = "mapreduce.input.num.files";

34 @
Ov”ride


35 
public
 
	gLi¡
<
	gIÅutS¶™
> 
g‘S¶™s
(
JobCÚ‹xt
 
job
è
throws
 
	gIOExû±iÚ
 {

38 
boŞ—n
 
	gho¡InFeName
 = 
job
.
g‘CÚfigu¿tiÚ
().
g‘BoŞ—n
("ho¡InFeName", 
çl£
);

39 
	gmšSize
 = 
M©h
.
max
(
g‘FÜm©MšS¶™Size
(), 
g‘MšS¶™Size
(
job
));

40 
	gmaxSize
 = 
g‘MaxS¶™Size
(
job
);

43 
	gLi¡
<
	gIÅutS¶™
> 
	g¥l™s
 = 
Ãw
 
A¼ayLi¡
<
IÅutS¶™
>();

44 
	gLi¡
<
	gFeStus
> 
	gfes
 = 
li¡Stus
(
job
);

45 
FeStus
 
	gfe
 : 
fes
) {

46 
P©h
 
·th
 = 
fe
.
g‘P©h
();

47 
FeSy¡em
 
	gfs
 = 
·th
.
g‘FeSy¡em
(
job
.
g‘CÚfigu¿tiÚ
());

48 
	gËngth
 = 
fe
.
g‘L’
();

49 
	gSŒšg
[] 
	gho¡s
 = 
nuÎ
;

50 ià(
	gho¡InFeName
) {

51 
SŒšg
 
	gÇme
 = 
·th
.
g‘Name
();

53 
	gSŒšg
[] 
	g‹mp
 = 
Çme
.
¥l™
("___");

54 ià(
	g‹mp
.
	gËngth
 > 0) {

55 
	gho¡s
 = 
Ãw
 
SŒšg
[1];

56 
	gho¡s
[0] = 
‹mp
[0];

59 
	gBlockLoÿtiÚ
[] 
	gblkLoÿtiÚs
 = 
fs
.
g‘FeBlockLoÿtiÚs
(
fe
, 0, 
Ëngth
);

61 ià((
	gËngth
 !ğ0è&& 
isS¶™abË
(
job
, 
·th
)) {

62 
	gblockSize
 = 
fe
.
g‘BlockSize
();

63 
	g¥l™Size
 = 
compu‹S¶™Size
(
blockSize
, 
mšSize
, 
maxSize
);

65 
	gby‹sRemaššg
 = 
Ëngth
;

66 ((è
	gby‹sRemaššg
è/ 
	g¥l™Size
 > 
	gSPLIT_SLOP
) {

67 
	gblkIndex
 = 
g‘BlockIndex
(
blkLoÿtiÚs
, 
Ëngth
 - 
by‹sRemaššg
);

68 ià(
	gho¡InFeName
 && 
	gho¡s
 !ğ
nuÎ
 && 
ho¡s
.
Ëngth
 > 0) {

69 
Log
.
šfo
("…¬ˆf" + 
·th
.
toSŒšg
(è+ " cÚš ho¡ " + 
ho¡s
[0]);

70 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 
Ëngth
 - 
by‹sRemaššg
, 
¥l™Size
, 
ho¡s
));

72 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 
Ëngth
 - 
by‹sRemaššg
, 
¥l™Size
, 
blkLoÿtiÚs
[
blkIndex
].
g‘Ho¡s
()));

74 
	gby‹sRemaššg
 -ğ
¥l™Size
;

77 ià(
	gby‹sRemaššg
 != 0) {

78 ià(
ho¡InFeName
 && 
ho¡s
 !ğ
nuÎ
 && ho¡s.
Ëngth
 > 0) {

79 
Log
.
šfo
(" f’d " + 
·th
.
toSŒšg
(è+ " cÚš ho¡ " + 
ho¡s
[0]);

80 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 
Ëngth
 - 
by‹sRemaššg
, by‹sRemaššg, 
ho¡s
));

82 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 
Ëngth
 - 
by‹sRemaššg
, by‹sRemaššg, 
blkLoÿtiÚs
[blkLoÿtiÚs.Ëngth - 1].
g‘Ho¡s
()));

85 } ià(
	gËngth
 != 0) {

87 ià(
ho¡InFeName
 && 
ho¡s
 !ğ
nuÎ
 && ho¡s.
Ëngth
 > 0) {

88 
Log
.
šfo
(" f " + 
·th
.
toSŒšg
(è+ " cÚš ho¡ " + 
ho¡s
[0]);

89 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 0, 
Ëngth
, 
ho¡s
));

91 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 0, 
Ëngth
, 
blkLoÿtiÚs
[0].
g‘Ho¡s
()));

95 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 0, 
Ëngth
,‚ew 
SŒšg
[0]));

100 
	gjob
.
g‘CÚfigu¿tiÚ
().
£tLÚg
(
NUM_INPUT_FILES
, 
fes
.
size
());

102 
	gLog
.
šfo
("Ho¡ Sequ’û FTÙ® # oà¥l™s: " + 
¥l™s
.
size
());

103  
	g¥l™s
;

	@com/zhongsou/spider/hadoop/MyTextOutputFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFSD©aOuutSŒ—m
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gcom´ess
.
	gCom´essiÚCodec
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gcom´ess
.
	gGzCodec
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeOuutFÜm©
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRecÜdWr™”
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gTextOuutFÜm©
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gProg»s§bË
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gReæeùiÚUts
;

20 
public
 
şass
 
	gMyTextOuutFÜm©
<
	gK
, 
	gV
> 
ex‹nds
 
	gTextOuutFÜm©
<K, V> {

21 
şass
 
	gMyLšeRecÜdWr™”
<
	gK
,
	gV
> 
ex‹nds
 
	gLšeRecÜdWr™”
 {

22 
´iv©e
 
fš®
 
SŒšg
 
	gutf8
 = "UTF-8";

24 
public
 
MyLšeRecÜdWr™”
(
D©aOuutSŒ—m
 
out
, 
SŒšg
 
keyV®ueS•¬©Ü
) {

25 
su³r
(
out
, 
keyV®ueS•¬©Ü
);

29 
´iv©e
 
wr™eObjeù
(
Objeù
 
o
è
throws
 
	gIOExû±iÚ
 {

30 ià(
o
 
š¡ªûof
 
	gText
) {

31 
Text
 
	gto
 = (Textè
o
;

32 
	gout
.
wr™e
(
to
.
g‘By‹s
(), 0,o.
g‘L’gth
());

34 
	gout
.
wr™e
(
o
.
toSŒšg
().
g‘By‹s
(
utf8
));

38 @
Ov”ride


39 
public
 
synchrÚized
 
wr™e
(
Objeù
 
key
, Objeù 
v®ue
è
throws
 
	gIOExû±iÚ
 {

41 
boŞ—n
 
	gnuÎKey
 = 
key
 =ğ
nuÎ
 || key 
š¡ªûof
 
NuÎWr™abË
;

42 
boŞ—n
 
	gnuÎV®ue
 = 
v®ue
 =ğ
nuÎ
 || v®u
š¡ªûof
 
NuÎWr™abË
;

43 ià(
	gnuÎKey
 && 
	gnuÎV®ue
) {

46 ià(!
	gnuÎKey
) {

47 
wr™eObjeù
(
key
);

50 ià(!
	gnuÎV®ue
) {

51 
wr™eObjeù
(
v®ue
);

58 @
Ov”ride


59 
public
 
	gRecÜdWr™”
<
	gK
, 
	gV
> 
g‘RecÜdWr™”
(
FeSy¡em
 
ignÜed
, 
JobCÚf
 
job
, 
SŒšg
 
Çme
, 
Prog»s§bË
 
´og»ss
è
throws
 
	gIOExû±iÚ
 {

61 
boŞ—n
 
	gisCom´es£d
 = 
g‘Com´essOuut
(
job
);

62 
SŒšg
 
	gkeyV®ueS•¬©Ü
 = 
job
.
g‘
("mapred.textoutputformat.separator",

64 ià(!
	gisCom´es£d
) {

65 
P©h
 
	gfe
 = 
FeOuutFÜm©
.
g‘TaskOuutP©h
(
job
, 
Çme
);

66 
FeSy¡em
 
	gfs
 = 
fe
.
g‘FeSy¡em
(
job
);

67 
FSD©aOuutSŒ—m
 
	gfeOut
 = 
fs
.
ü—‹
(
fe
, 
´og»ss
);

68  
Ãw
 
	gMyLšeRecÜdWr™”
<
	gK
, 
	gV
>(
	gfeOut
, 
	gkeyV®ueS•¬©Ü
);

70 
	gCÏss
<? 
ex‹nds
 
	gCom´essiÚCodec
> 
	gcodecCÏss
 =

71 
g‘OuutCom´essÜCÏss
(
job
, 
GzCodec
.
şass
);

73 
Com´essiÚCodec
 
	gcodec
 = 
ReæeùiÚUts
.
ÃwIn¡ªû
(
codecCÏss
, 
job
);

75 
P©h
 
	gfe
 =

76 
FeOuutFÜm©
.
g‘TaskOuutP©h
(
job
,

77 
Çme
 + 
codec
.
g‘DeçuÉEx‹nsiÚ
());

78 
FeSy¡em
 
	gfs
 = 
fe
.
g‘FeSy¡em
(
job
);

79 
FSD©aOuutSŒ—m
 
	gfeOut
 = 
fs
.
ü—‹
(
fe
, 
´og»ss
);

80  
Ãw
 
	gMyLšeRecÜdWr™”
<
	gK
, 
	gV
>Òew 
	gD©aOuutSŒ—m


81 (
	gcodec
.
ü—‹OuutSŒ—m
(
feOut
)),

82 
	gkeyV®ueS•¬©Ü
);

	@com/zhongsou/spider/hadoop/PipeScoreKey.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËUts
;

12 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

14 
public
 
şass
 
PeScÜeKey
 
im¶em’ts
 
	gWr™abËCom·¿bË
<
	gPeScÜeKey
>, 
	gClÚ—bË
 {

15 
by‹
 
	gbufãr
[];

17 
public
 
	gby‹
[] 
g‘Bufãr
() {

18  
	gbufãr
;

21 
public
 
£tBufãr
(
by‹
[] 
bufãr
) {

22 
	gthis
.
	gbufãr
 = 
bufãr
;

25 @
Ov”ride


26 
public
 
wr™e
(
D©aOuut
 
out
è
throws
 
	gIOExû±iÚ
 {

28 
	gWr™abËUts
.
wr™eVIÁ
(
out
, 
bufãr
.
Ëngth
);

29 
	gout
.
wr™e
(
bufãr
);

32 @
Ov”ride


33 
public
 
»adF›lds
(
D©aIÅut
 
š
è
throws
 
	gIOExû±iÚ
 {

36 
	gnumBy‹s
 = 
Wr™abËUts
.
»adVIÁ
(
š
);

37 ià(
	gnumBy‹s
 < 0) {

38 
	gSy¡em
.
	gout
.
´šn
("by‹s=" + 
numBy‹s
);

41 
	gthis
.
	gbufãr
 = 
Ãw
 
by‹
[
numBy‹s
];

42 
	gš
.
»adFuÎy
(
bufãr
);

48 
	gWr™abËCom·¿tÜ
.
defše
(
PeScÜeKey
.
şass
, 
Ãw
 
PesScÜeCom·¿tÜ
());

51 
public
 
SŒšg
 
toSŒšg
() {

52  
	gNumb”Ut
.
g‘HexSŒšg
(
this
.
bufãr
);

55 @
Ov”ride


56 
public
 
com·»To
(
PeScÜeKey
 
o
) {

59 
by‹
 
	ga
[] = 
this
.
bufãr
;

60 
by‹
 
	gb
[] = 
o
.
g‘Bufãr
();

62 
	gcmp
 = 
Wr™abËCom·¿tÜ
.
com·»By‹s
(
a
, 0, 8, 
b
, 0, 8);

63 ià(
	gcmp
 != 0) {

64  
cmp
;

67 
	gcmp
 = 
Wr™abËCom·¿tÜ
.
com·»By‹s
(
a
, 8, 1, 
b
, 8, 1);

68 ià(
	gcmp
 != 0)

69  -
cmp
;

72 
	gf1
 = 
M©h
.
abs
(
Numb”Ut
.
»adFlßt
(
a
, 17));

73 
	gf2
 = 
M©h
.
abs
(
Numb”Ut
.
»adFlßt
(
b
, 17));

76  
	gf1
 > 
	gf2
 ? -1 : ((
f1
 < 
f2
) ? 1 : 0);

	@com/zhongsou/spider/hadoop/PipeText.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËUts
;

12 
public
 
şass
 
PeText
 
im¶em’ts
 
	gWr™abËCom·¿bË
<
	gPeText
>, 
	gClÚ—bË
 {

13 
public
 
Text
 
g‘Text
() {

14  
	g‹xt
;

17 
public
 
£tText
(
Text
 
‹xt
) {

18 
	gthis
.
	g‹xt
 = 
‹xt
;

21 
´iv©e
 
Text
 
	g‹xt
;

23 @
Ov”ride


24 
public
 
wr™e
(
D©aOuut
 
out
è
throws
 
	gIOExû±iÚ
 {

26 
	g‹xt
.
wr™e
(
out
);

29 @
Ov”ride


30 
public
 
»adF›lds
(
D©aIÅut
 
š
è
throws
 
	gIOExû±iÚ
 {

32 
	gthis
.
	g‹xt
 = 
Ãw
 
Text
();

33 
	gnumBy‹s
 = 
Wr™abËUts
.
»adVIÁ
(
š
);

34 ià(
	gnumBy‹s
 < 0) {

35 
	gSy¡em
.
	gout
.
´šn
("by‹s=" + 
numBy‹s
);

37 
	gby‹
[] 
	gbufãr
;

38 
	gbufãr
 = 
Ãw
 
by‹
[
numBy‹s
];

39 
	gš
.
»adFuÎy
(
bufãr
);

40 ((
	gText
è
	g‹xt
).
£t
(
bufãr
);

46 
	gWr™abËCom·¿tÜ
.
defše
(
PeText
.
şass
, 
Ãw
 
DoubËTextCom·¿tÜ
());

49 
public
 
SŒšg
 
toSŒšg
() {

50  
	gthis
.
	g‹xt
.
toSŒšg
();

53 @
Ov”ride


54 
public
 
com·»To
(
PeText
 
o
) {

57 
by‹
 
	ga
[] = 
this
.
‹xt
.
g‘By‹s
();

58 
by‹
 
	gb
[] = 
o
.
‹xt
.
g‘By‹s
();

60 
	gcmp
 = 
Wr™abËCom·¿tÜ
.
com·»By‹s
(
a
, 0, 8, 
b
, 0, 8);

61 ià(
	gcmp
 != 0) {

62  
cmp
;

64  
	gWr™abËCom·¿tÜ
.
com·»By‹s
(
a
, 8, 1, 
b
, 8, 1);

	@com/zhongsou/spider/hadoop/PipesScoreComparator.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËUts
;

6 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

8 
public
 cÏs 
	cPesScÜeCom·¿tÜ
 
ex‹nds
 
	mWr™abËCom·¿tÜ
 {

9 
public
 
	$PesScÜeCom·¿tÜ
() {

10 
	`su³r
(
PeScÜeKey
.
şass
, 
Œue
);

13 
public
 
	$com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

17 
n1
 = 
Wr™abËUts
.
	`decodeVIÁSize
(
b1
[
s1
]);

18 
n2
 = 
Wr™abËUts
.
	`decodeVIÁSize
(
b2
[
s2
]);

20 
i
 = 
	`com·»By‹s
(
b1
, 
s1
 + 
n1
, 8, 
b2
, 
s2
 + 
n2
, 8);

21 ià(
i
 != 0)

22  
i
;

25 
i
 = 
	`com·»By‹s
(
b1
, 
s1
 + 
n1
 + 8, 1, 
b2
, 
s2
 + 
n2
 + 8, 1);

26 ià(
i
 != 0)

27  -
i
;

30 
f1
 = 
M©h
.
	`abs
(
Numb”Ut
.
	`»adFlßt
(
b1
, 
s1
 + 
n1
 + 17));

31 
f2
 = 
M©h
.
	`abs
(
Numb”Ut
.
	`»adFlßt
(
b2
, 
s2
 + 
n2
 + 17));

33  
f1
 > 
f2
 ? -1 : ((f1 < f2) ? 1 : 0);

36 
	}
}

	@com/zhongsou/spider/hadoop/PipesScoreKeyGroupComparator.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

6 
public
 cÏs 
	cPesScÜeKeyGroupCom·¿tÜ
 
ex‹nds
 
	mWr™abËCom·¿tÜ
 {

8 
´Ùeùed
 
	$PesScÜeKeyGroupCom·¿tÜ
() {

9 
	`su³r
(
PeScÜeKey
.
şass
, 
Œue
);

13 
public
 
	$com·»
(
Wr™abËCom·¿bË
 
a
, Wr™abËCom·¿bË 
b
) {

15 
PeScÜeKey
 
c
 = (PeScÜeKeyè
a
;

16 
PeScÜeKey
 
d
 = (PeScÜeKeyè
b
;

17 
by‹
 
e
[] = 
c
.
	`g‘Bufãr
();

18 
by‹
 
f
[] = 
d
.
	`g‘Bufãr
();

20  
	`com·»By‹s
(
e
, 0, 8, 
f
, 0, 8);

21 
	}
}

	@com/zhongsou/spider/hadoop/PipesScoreKeyPartition.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gP¬t™iÚ”
;

8 
public
 
şass
 
PesScÜeKeyP¬t™iÚ
 
im¶em’ts
 
	gP¬t™iÚ”
<
	gPeScÜeKey
, 
	gText
> {

10 @
Ov”ride


11 
public
 
cÚfigu»
(
JobCÚf
 
job
) {

16 @
Ov”ride


17 
public
 
g‘P¬t™iÚ
(
PeScÜeKey
 
key
, 
Text
 
v®ue
, 
numP¬t™iÚs
) {

19 
by‹
 
	gs
[] = 
key
.
g‘Bufãr
();

20  
	gM©h
.
abs
(
By‹s
.
toSŒšg
(
s
, 0, 8).
hashCode
(è* 127è% 
	gnumP¬t™iÚs
;

	@com/zhongsou/spider/hadoop/RandomHostSequenceFileInputFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

5 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

6 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gRªdom
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gBlockLoÿtiÚ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeStus
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghdfs
.
	gDi¡ribu‹dFeSy¡em
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghdfs
.
	g´ÙocŞ
.
	gD©ªodeInfo
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeS¶™
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gIÅutS¶™
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gSequ’ûFeIÅutFÜm©
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gÃt
.
	gN‘wÜkTİŞogy
;

20 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

22 
public
 
şass
 
	gRªdomHo¡Sequ’ûFeIÅutFÜm©
<
	gK
, 
	gV
> 
ex‹nds
 
	gSequ’ûFeIÅutFÜm©
<K, V> {

24 
´iv©e
 
fš®
 
SŒšg
 
	gNUM_INPUT_FILES
 = "mapreduce.input.num.files";

25 
´iv©e
 
fš®
 
	gSPLIT_SLOP
 = 1.1;

26 
´iv©e
 
	gmšS¶™Size
 = 1;

28 @
Ov”ride


29 
public
 
	gIÅutS¶™
[] 
g‘S¶™s
(
JobCÚf
 
job
, 
numS¶™s
è
throws
 
	gIOExû±iÚ
 {

32 
	gFeStus
[] 
	gfes
 = 
li¡Stus
(
job
);

33 
FeSy¡em
 
	gdfs
 = FeSy¡em.
g‘
(
job
);

34 
	gLi¡
<
	gSŒšg
> 
	gho¡li¡
 = 
Ãw
 
LškedLi¡
<
SŒšg
>();

35 ià(
dfs
 
š¡ªûof
 
	gDi¡ribu‹dFeSy¡em
) {

36 
Di¡ribu‹dFeSy¡em
 
	gdisfs
 = (Di¡ribu‹dFeSy¡emè
dfs
;

37 
D©ªodeInfo
 
	gšfo
[] = 
disfs
.
g‘D©aNodeSts
();

38 
D©ªodeInfo
 
	gd©ašfo
 : 
šfo
) {

39 
ho¡li¡
.
add
(
d©ašfo
.
g‘Ho¡Name
());

42 
	gLog
.
šfo
("g‘„ªdom ho¡†i¡ size=" + 
ho¡li¡
.
size
());

43 
Rªdom
 
	g¿nd
 = 
Ãw
 Random();

45 
	gjob
.
£tLÚg
(
NUM_INPUT_FILES
, 
fes
.
Ëngth
);

46 
	gtÙ®Size
 = 0;

47 
FeStus
 
	gfe
 : 
fes
) {

48 ià(
fe
.
isDœ
()) {

49 
throw
 
Ãw
 
IOExû±iÚ
("NÙ‡ fe: " + 
fe
.
g‘P©h
());

51 
	gtÙ®Size
 +ğ
fe
.
g‘L’
();

54 
	ggßlSize
 = 
tÙ®Size
 / (
numS¶™s
 == 0 ? 1 :‚umSplits);

55 
	gmšSize
 = 
M©h
.
max
(
job
.
g‘LÚg
("m­»d.mš.¥l™.size", 1), 
mšS¶™Size
);

58 
	gA¼ayLi¡
<
	gFeS¶™
> 
	g¥l™s
 = 
Ãw
 
A¼ayLi¡
<
FeS¶™
>(
numS¶™s
);

59 
N‘wÜkTİŞogy
 
	gşu¡”M­
 = 
Ãw
 NetworkTopology();

60 
FeStus
 
	gfe
 : 
fes
) {

61 
P©h
 
·th
 = 
fe
.
g‘P©h
();

62 
FeSy¡em
 
	gfs
 = 
·th
.
g‘FeSy¡em
(
job
);

63 
	gËngth
 = 
fe
.
g‘L’
();

64 
	gBlockLoÿtiÚ
[] 
	gblkLoÿtiÚs
 = 
fs
.
g‘FeBlockLoÿtiÚs
(
fe
, 0, 
Ëngth
);

65 ià((
	gËngth
 !ğ0è&& 
isS¶™abË
(
fs
, 
·th
)) {

66 
	gblockSize
 = 
fe
.
g‘BlockSize
();

67 
	g¥l™Size
 = 
compu‹S¶™Size
(
gßlSize
, 
mšSize
, 
blockSize
);

69 
	gby‹sRemaššg
 = 
Ëngth
;

70 ((è
	gby‹sRemaššg
è/ 
	g¥l™Size
 > 
	gSPLIT_SLOP
) {

72 ià(
	gho¡li¡
.
size
() > 0) {

73 
SŒšg
 
	g¥l™Ho¡s
[] = 
Ãw
 String[1];

74 
	g¥l™Ho¡s
[0] = 
ho¡li¡
.
g‘
(
¿nd
.
ÃxtIÁ
(ho¡li¡.
size
()));

75 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 
Ëngth
 - 
by‹sRemaššg
, 
¥l™Size
, 
¥l™Ho¡s
));

77 
	gSŒšg
[] 
	g¥l™Ho¡s
 = 
g‘S¶™Ho¡s
(
blkLoÿtiÚs
, 
Ëngth
 - 
by‹sRemaššg
, 
¥l™Size
, 
şu¡”M­
);

78 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 
Ëngth
 - 
by‹sRemaššg
, 
¥l™Size
, 
¥l™Ho¡s
));

81 
	gby‹sRemaššg
 -ğ
¥l™Size
;

84 ià(
	gby‹sRemaššg
 != 0) {

85 ià(
ho¡li¡
.
size
() > 0) {

86 
SŒšg
 
¥l™Ho¡s
[] = 
Ãw
 String[1];

87 
	g¥l™Ho¡s
[0] = 
ho¡li¡
.
g‘
(
¿nd
.
ÃxtIÁ
(ho¡li¡.
size
()));

88 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 
Ëngth
 - 
by‹sRemaššg
, 
¥l™Size
, 
¥l™Ho¡s
));

90 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 
Ëngth
 - 
by‹sRemaššg
, by‹sRemaššg, 
blkLoÿtiÚs
[blkLoÿtiÚs.Ëngth - 1].
g‘Ho¡s
()));

93 } ià(
	gËngth
 != 0) {

94 ià(
ho¡li¡
.
size
() > 0) {

95 
SŒšg
 
¥l™Ho¡s
[] = 
Ãw
 String[1];

96 
	g¥l™Ho¡s
[0] = 
ho¡li¡
.
g‘
(
¿nd
.
ÃxtIÁ
(ho¡li¡.
size
()));

97 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 0, 
Ëngth
, 
¥l™Ho¡s
));

99 
	gSŒšg
[] 
	g¥l™Ho¡s
 = 
g‘S¶™Ho¡s
(
blkLoÿtiÚs
, 0, 
Ëngth
, 
şu¡”M­
);

100 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 0, 
Ëngth
, 
¥l™Ho¡s
));

104 
	g¥l™s
.
add
(
Ãw
 
FeS¶™
(
·th
, 0, 
Ëngth
,‚ew 
SŒšg
[0]));

107 
	gLOG
.
debug
("Rªdom ho¡ TÙ® # oà¥l™s: " + 
¥l™s
.
size
());

108  
	g¥l™s
.
toA¼ay
(
Ãw
 
FeS¶™
[
¥l™s
.
size
()]);

111 @
Ov”ride


112 
´Ùeùed
 
	gSŒšg
[] 
g‘S¶™Ho¡s
(
BlockLoÿtiÚ
[] 
blkLoÿtiÚs
, 
off£t
, 
¥l™Size
, 
N‘wÜkTİŞogy
 
şu¡”M­
è
throws
 
	gIOExû±iÚ
 {

114  
	gsu³r
.
g‘S¶™Ho¡s
(
blkLoÿtiÚs
, 
off£t
, 
¥l™Size
, 
şu¡”M­
);

	@com/zhongsou/spider/hadoop/ScoreURLInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gIÁWr™abË
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

10 
public
 
şass
 
ScÜeURLInfo
 
im¶em’ts
 
	gWr™abËCom·¿bË
<
	gScÜeURLInfo
>,

11 
	gClÚ—bË
 {

13 
´iv©e
 
IÁWr™abË
 
	g®lNum
;

14 
´iv©e
 
IÁWr™abË
 
	gÃwNum
;

16 @
Ov”ride


17 
public
 
»adF›lds
(
D©aIÅut
 
¬g0
è
throws
 
	gIOExû±iÚ
 {

19 
	g®lNum
=
Ãw
 
IÁWr™abË
();

20 
	gÃwNum
=
Ãw
 
IÁWr™abË
();

21 
	g®lNum
.
»adF›lds
(
¬g0
);

22 
	gÃwNum
.
»adF›lds
(
¬g0
);

25 @
Ov”ride


26 
public
 
wr™e
(
D©aOuut
 
¬g0
è
throws
 
	gIOExû±iÚ
 {

28 
	g®lNum
.
wr™e
(
¬g0
);

29 
	gÃwNum
.
wr™e
(
¬g0
);

32 
public
 
IÁWr™abË
 
g‘AÎNum
() {

33  
	g®lNum
;

36 
public
 
£tAÎNum
(
IÁWr™abË
 
®lNum
) {

37 
	gthis
.
	g®lNum
 = 
®lNum
;

40 
public
 
IÁWr™abË
 
g‘NewNum
() {

41  
	gÃwNum
;

44 
public
 
£tNewNum
(
IÁWr™abË
 
ÃwNum
) {

45 
	gthis
.
	gÃwNum
 = 
ÃwNum
;

48 @
Ov”ride


49 
public
 
com·»To
(
ScÜeURLInfo
 
o
) {

51  
	g®lNum
.
com·»To
(
o
.
®lNum
);

	@com/zhongsou/spider/hadoop/TimeMultipleOutoutFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	g‹xt
.
	gSim¶eD©eFÜm©
;

5 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRecÜdWr™”
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gR•Ü‹r
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gSequ’ûFeOuutFÜm©
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	glib
.
	gMuÉËOuutFÜm©
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gProg»s§bË
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

16 
public
 
şass
 
	gTimeMuÉËOutoutFÜm©
<
	gK
, 
	gV
> 
ex‹nds
 
	gMuÉËOuutFÜm©
<K, V> {

17 
Logg”
 
	glogg”
 = Logg”.
g‘Logg”
(
TimeMuÉËOutoutFÜm©
.
şass
);

18 
´iv©e
 
	gSequ’ûFeOuutFÜm©
<
	gK
, 
	gV
> 
	gouut
 = 
nuÎ
;

19 
´iv©e
 
	gÏ¡Time
 = 0;

20 
public
 
	gINTERVAL
 = 1000 * 60 * 15;

21 
´iv©e
 
Sim¶eD©eFÜm©
 
	gfÜm©
;

22 
´iv©e
 
SŒšg
 
	gÏ¡FeName
 = 
nuÎ
;

24 
public
 
TimeMuÉËOutoutFÜm©
() {

25 
su³r
();

26 
	gfÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyyMMddHHmm");

29 
public
 
	gRecÜdWr™”
<
	gK
, 
	gV
> 
g‘RecÜdWr™”
(
FeSy¡em
 
fs
, 
JobCÚf
 
job
, 
SŒšg
 
Çme
, 
Prog»s§bË
 
¬g3
è
throws
 
	gIOExû±iÚ
 {

31 
fš®
 
FeSy¡em
 
	gmyFS
 = 
fs
;

32 
fš®
 
SŒšg
 
	gmyName
 = 
g’”©eL—fFeName
(
Çme
);

33 
fš®
 
JobCÚf
 
	gmyJob
 = 
job
;

34 
fš®
 
Prog»s§bË
 
	gmyProg»s§bË
 = 
¬g3
;

36  
Ãw
 
	gRecÜdWr™”
<
	gK
, 
	gV
>() {

41 
	gHashS‘
<
	gSŒšg
> 
	gwr™”S‘
 = 
Ãw
 
HashS‘
<
SŒšg
>();

42 
	gRecÜdWr™”
<
	gK
, 
	gV
> 
	gcu¼’tWr™”
 = 
nuÎ
;

44 
public
 
wr™e
(
K
 
key
, 
V
 
v®ue
è
throws
 
	gIOExû±iÚ
 {

47 
SŒšg
 
	gkeyBa£dP©h
 = 
g’”©eFeNameFÜKeyV®ue
(
key
, 
v®ue
, 
myName
);

50 
SŒšg
 
	gfš®P©h
 = 
g‘IÅutFeBa£dOuutFeName
(
myJob
, 
keyBa£dP©h
);

53 
K
 
	gaùu®Key
 = 
g’”©eAùu®Key
(
key
, 
v®ue
);

54 
V
 
	gaùu®V®ue
 = 
g’”©eAùu®V®ue
(
key
, 
v®ue
);

56 ià(
	gcu¼’tWr™”
 =ğ
nuÎ
) {

57 
cu¼’tWr™”
 = 
g‘Ba£RecÜdWr™”
(
myFS
, 
myJob
, 
fš®P©h
, 
myProg»s§bË
);

58 
	gthis
.
	gwr™”S‘
.
add
(
fš®P©h
);

63 ià(!
	gthis
.
	gwr™”S‘
.
cÚšs
(
fš®P©h
)) {

64 
	gthis
.
	gcu¼’tWr™”
.
şo£
(
nuÎ
);

65 
	glogg”
.
šfo
("ü—‹‡‚ew f·th =" + 
fš®P©h
);

66 
	gcu¼’tWr™”
 = 
g‘Ba£RecÜdWr™”
(
myFS
, 
myJob
, 
fš®P©h
, 
myProg»s§bË
);

67 
	gthis
.
	gwr™”S‘
.
add
(
fš®P©h
);

70 
	gcu¼’tWr™”
.
wr™e
(
aùu®Key
, 
aùu®V®ue
);

73 
public
 
şo£
(
R•Ü‹r
 
»pÜ‹r
è
throws
 
	gIOExû±iÚ
 {

74 ià(
	gcu¼’tWr™”
 !ğ
nuÎ
) {

75 
this
.
cu¼’tWr™”
.
şo£
(
»pÜ‹r
);

77 
	gthis
.
	gwr™”S‘
.
ş—r
();

82 @
Ov”ride


83 
´Ùeùed
 
	gRecÜdWr™”
<
	gK
, 
	gV
> 
g‘Ba£RecÜdWr™”
(
FeSy¡em
 
fs
, 
JobCÚf
 
job
, 
SŒšg
 
Çme
, 
Prog»s§bË
 
¬g3
è
throws
 
	gIOExû±iÚ
 {

85 ià(
	gouut
 =ğ
nuÎ
) {

86 
ouut
 = 
Ãw
 
Sequ’ûFeOuutFÜm©
<
K
, 
	gV
>();

88 ià(
	gINTERVAL
 == 1000 * 60 * 15) {

89 
INTERVAL
 = 
job
.
g‘IÁ
("multiple.file.name.interval", 1000 * 60 * 15);

91  
	gouut
.
g‘RecÜdWr™”
(
fs
, 
job
, 
Çme
, 
¬g3
);

94 @
Ov”ride


95 
´Ùeùed
 
SŒšg
 
g’”©eFeNameFÜKeyV®ue
(
K
 
key
, 
V
 
v®ue
, SŒšg 
Çme
) {

97 
	gnow
 = 
Sy¡em
.
cu¼’tTimeMlis
();

98 
	gcu¼M
 = 
now
 / 
INTERVAL
;

99 ià(
	gcu¼M
 =ğ
Ï¡Time
 && 
Ï¡FeName
 !ğ
nuÎ
) {

100  
Ï¡FeName
;

102 
	gÏ¡FeName
 = "şaw”_" + 
fÜm©
.fÜm©(
Ãw
 
java
.
ut
.
D©e
(
cu¼M
 * 
INTERVAL
)è+ "/" + 
Çme
;

103 
	gthis
.
	gÏ¡Time
 = 
cu¼M
;

104  
	gÏ¡FeName
;

108 
public
 
maš
(
SŒšg
 
¬gs
[]) {

109 
Sim¶eD©eFÜm©
 
	gfÜm©
 = 
Ãw
 
java
.
‹xt
.SimpleDateFormat("yyyyMMddHHmm");

110 
	gt
 = 
Sy¡em
.
cu¼’tTimeMlis
();

111 
	gt
 = 
t
 / 
INTERVAL
;

112 
	gt
 *ğ
INTERVAL
;

113 
SŒšg
 
	gÏ¡FeName
 = "şaw”_r_" + 
fÜm©
.fÜm©(
Ãw
 
java
.
ut
.
D©e
(
t
));

114 
	gSy¡em
.
	gout
.
´šn
(
Ï¡FeName
);

	@com/zhongsou/spider/hadoop/TimeSequenceFileOutputFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
.
	gCom´essiÚTy³
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gcom´ess
.
	gCom´essiÚCodec
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gcom´ess
.
	gDeçuÉCodec
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gRecÜdWr™”
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gTaskA‰em±CÚ‹xt
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gReæeùiÚUts
;

27 
public
 
şass
 
	gTimeSequ’ûFeOuutFÜm©
<
	gK
, 
	gV
> 
ex‹nds
 
	gSequ’ûFeOuutFÜm©
<K, V> {

28 
D©eFÜm©
 
	gfÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyyMMddHHmm");

30 @
Ov”ride


31 
public
 
	gRecÜdWr™”
<
	gK
, 
	gV
> 
g‘RecÜdWr™”
(
TaskA‰em±CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

33 
CÚfigu¿tiÚ
 
	gcÚf
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
();

35 
Com´essiÚCodec
 
	gcodec
 = 
nuÎ
;

36 
Com´essiÚTy³
 
	gcom´essiÚTy³
 = Com´essiÚTy³.
NONE
;

37 ià(
g‘Com´essOuut
(
cÚ‹xt
)) {

39 
	gcom´essiÚTy³
 = 
g‘OuutCom´essiÚTy³
(
cÚ‹xt
);

42 
	gCÏss
<?> 
	gcodecCÏss
 = 
g‘OuutCom´essÜCÏss
(
cÚ‹xt
, 
DeçuÉCodec
.
şass
);

43 
	gcodec
 = (
Com´essiÚCodec
è
ReæeùiÚUts
.
ÃwIn¡ªû
(
codecCÏss
, 
cÚf
);

46 
P©h
 
	gfe
 = 
g‘DeçuÉWÜkFe
(
cÚ‹xt
, "-"+
fÜm©
.fÜm©(
Ãw
 
java
.
ut
.
D©e
()));

47 
FeSy¡em
 
	gfs
 = 
fe
.
g‘FeSy¡em
(
cÚf
);

48 
fš®
 
	gSequ’ûFe
.
Wr™”
 
	gout
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
fe
, 
cÚ‹xt
.
g‘OuutKeyCÏss
(), cÚ‹xt.
g‘OuutV®ueCÏss
(), 
com´essiÚTy³
, 
codec
, context);

50  
Ãw
 
	gRecÜdWr™”
<
	gK
, 
	gV
>() {

52 
public
 
wr™e
(
K
 
key
, 
V
 
v®ue
è
throws
 
	gIOExû±iÚ
 {

54 
	gout
.
­³nd
(
key
, 
v®ue
);

57 
public
 
şo£
(
TaskA‰em±CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
 {

58 
	gout
.
şo£
();

	@com/zhongsou/spider/hadoop/URLFolderMapReducer.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gPut
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gLÚgWr™abË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

13 
public
 cÏs 
	cURLFŞd”M­Reduûr
 {

14 
şass
 
U¶ßd”


15 
ex‹nds
 
	mM­³r
<
	mLÚgWr™abË
, 
	mText
, 
	mImmubËBy‹sWr™abË
, 
	mPut
> {

16 
Ch¬aù”
 
	mc
;

17 
HashM­
 
	mm­
;

19 
´iv©e
 
	mcheckpošt
 = 100;

20 
´iv©e
 
	mcouÁ
 = 0;

22 @
Ov”ride


23 
public
 
m­
(
LÚgWr™abË
 
key
, 
Text
 
lše
, 
CÚ‹xt
 
cÚ‹xt
)

24 
throws
 
	mIOExû±iÚ
 {

31 
	mSŒšg
 [] 
	mv®ues
 = 
lše
.
toSŒšg
().
¥l™
(",");

32 if(
	mv®ues
.
	mËngth
 != 4) {

37 
	mby‹
 [] 
	mrow
 = 
By‹s
.
toBy‹s
(
v®ues
[0]);

38 
	mby‹
 [] 
	mçmy
 = 
By‹s
.
toBy‹s
(
v®ues
[1]);

39 
	mby‹
 [] 
	mqu®if›r
 = 
By‹s
.
toBy‹s
(
v®ues
[2]);

40 
	mby‹
 [] 
	mv®ue
 = 
By‹s
.
toBy‹s
(
v®ues
[3]);

43 
Put
 
	mput
 = 
Ãw
 Put(
row
);

44 
	mput
.
add
(
çmy
, 
qu®if›r
, 
v®ue
);

50 
	mŒy
 {

51 
	mcÚ‹xt
.
wr™e
(
Ãw
 
ImmubËBy‹sWr™abË
(
row
), 
put
);

52 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

53 
	me
.
´štSckT¿û
();

57 if(++
	mcouÁ
 % 
	mcheckpošt
 == 0) {

58 
cÚ‹xt
.
£tStus
("Em™tšg Puˆ" + 
couÁ
);

	@com/zhongsou/spider/hadoop/XMLCharacterRecognizer.java

26 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
;

32 şas 
	cXMLCh¬aù”Recogniz”


42 
boŞ—n
 
	$isWh™eS·û
(
ch
)

44  (
ch
 == 0x20) || (ch == 0x09) || (ch == 0xD) || (ch == 0xA);

56 
boŞ—n
 
	$isWh™eS·û
(
ch
[], 
¡¬t
, 
Ëngth
)

59 
’d
 = 
¡¬t
 + 
Ëngth
;

61 
s
 = 
¡¬t
; s < 
’d
; s++)

63 ià(!
	`isWh™eS·û
(
ch
[
s
]))

64  
çl£
;

67  
Œue
;

68 
	}
}

76 
boŞ—n
 
	$isWh™eS·û
(
SŒšgBufãr
 
buf
)

79 
n
 = 
buf
.
	`Ëngth
();

81 
i
 = 0; i < 
n
; i++)

83 ià(!
	`isWh™eS·û
(
buf
.
	`ch¬At
(
i
)))

84  
çl£
;

87  
Œue
;

88 
	}
}

96 
boŞ—n
 
	$isWh™eS·û
(
SŒšg
 
s
)

99 if(
nuÎ
 !ğ
s
)

101 
n
 = 
s
.
	`Ëngth
();

103 
i
 = 0; i < 
n
; i++)

105 ià(!
	`isWh™eS·û
(
s
.
	`ch¬At
(
i
)))

106  
çl£
;

110  
Œue
;

111 
	}
}

	@com/zhongsou/spider/hadoop/job/CounterHelper.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjob
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

5 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gCouÁ”s
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gCouÁ”s
.
	gGroup
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRuÂšgJob
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gCouÁ”Group
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

13 
public
 cÏs 
	cCouÁ”H–³r
 {

15 
public
 
g‘CouÁ”V®ue
(
RuÂšgJob
 
job
, 
Enum
<?> 
c
) {

16 
	mŒy
 {

17 
CouÁ”s
 
	ms
 = 
job
.
g‘CouÁ”s
();

18  
	ms
.
g‘CouÁ”
(
c
);

19 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

21 
	me
.
´štSckT¿û
();

26 
public
 
	$g‘CouÁ”V®ue
(
RuÂšgJob
 
job
, 
SŒšg
 
groupName
, SŒšg 
couÁ”Name
) {

27 
Œy
 {

28 
CouÁ”s
 
s
 = 
job
.
	`g‘CouÁ”s
();

29 
Group
 
group
 = 
s
.
	`g‘Group
(
groupName
);

30  
group
.
	`g‘CouÁ”
(
couÁ”Name
);

32 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

34 
e
.
	`´štSckT¿û
();

38 
	}
}

40 
public
 
couÁ”M­
(
Job
 
job
, 
HashM­
<
SŒšg
, SŒšg> 
tm­
) {

41 
	gŒy
 {

42 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
CouÁ”s
 
	gcouÁ”s
 = 
job
.
g‘CouÁ”s
();

43 
	gI‹¿tÜ
<
	gCouÁ”Group
> 
	g™
 = 
couÁ”s
.
™”©Ü
();

44 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

46 
	ge
.
´štSckT¿û
();

	@com/zhongsou/spider/hadoop/job/ParseResultConverterJob.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjob
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

5 
impÜt
 
	gjava
.
	g‹xt
.
	gP¬£Exû±iÚ
;

6 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

7 
impÜt
 
	gjava
.
	gut
.
	gD©e
;

8 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

9 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

10 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gBy‹sWr™abË
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeIÅutFÜm©
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeOuutFÜm©
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCl›Á
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gM­ReduûBa£
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gM­³r
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gOuutCŞËùÜ
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gReduûr
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gR•Ü‹r
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRuÂšgJob
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gSequ’ûFeIÅutFÜm©
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gSequ’ûFeOuutFÜm©
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	glib
.
	gMuÉËOuuts
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞ
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞRuÂ”
;

36 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

38 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gavro
.
	gP¬£rResuÉCÚv”‹r
;

39 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gP¬£rResuÉ
;

40 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gURLInfo
;

41 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

42 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
.
	gMD5L’
;

43 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gHFeOuutFÜm©
;

45 
public
 cÏs 
	cP¬£ResuÉCÚv”‹rJob
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mToŞ
 {

47 
public
 
şass
 
	mReduûCÏss
<
	mK
, 
	mV
> 
im¶em’ts
 
	mReduûr
<
	mBy‹sWr™abË
, BytesWritable, K, V> {

48 
´iv©e
 
MuÉËOuuts
 
	mmos
;

49 
´iv©e
 
OuutCŞËùÜ
 
	mcŞËùÜ
;

50 
´iv©e
 
P¬£rResuÉCÚv”‹r
 
	m·r£CÚv”‹r
;

51 
ImmubËBy‹sWr™abË
 
	mhba£Key
 = 
Ãw
 ImmutableBytesWritable();

52 
	mLškedLi¡
<
	mKeyV®ue
> 
	mkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

53 
	mtime¡amp
;

54 
D©eFÜm©
 
	md©eFÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyyMMddHHmmss");

56 
public
 
cÚfigu»
(
JobCÚf
 
cÚf
) {

57 
	mmos
 = 
Ãw
 
MuÉËOuuts
(
cÚf
);

59 
SŒšg
 
	m£qtime
 = 
cÚf
.
g‘
("seqTimestamp");

61 ià(
	m£qtime
 =ğ
nuÎ
 || 
£qtime
.
equ®s
("")) {

62 
Log
.
šfo
("£qimi nuÎ" + 
£qtime
);

64 
	mŒy
 {

65 
D©e
 
	md
 = 
d©eFÜm©
.
·r£
(
£qtime
);

66 
	mthis
.
	mtime¡amp
 = (è(
d
.
g‘Time
() / 1000);

67 
	m·r£CÚv”‹r
 = 
Ãw
 
P¬£rResuÉCÚv”‹r
(
time¡amp
);

68 } 
ÿtch
 (
P¬£Exû±iÚ
 
e
) {

70 
	me
.
´štSckT¿û
();

74 @
Ov”ride


75 
public
 
»duû
(
By‹sWr™abË
 
key
, 
I‹¿tÜ
<By‹sWr™abË> 
v®ues
, 
OuutCŞËùÜ
<
K
, 
V
> 
ouut
, 
R•Ü‹r
 
»pÜ‹r
è
throws
 
	mIOExû±iÚ
 {

80 
ImmubËBy‹sWr™abË
 
	mk
 = 
Ãw
 ImmutableBytesWritable();

81 
	mk
.
£t
(
key
.
g‘By‹s
());

82 
Text
 
	mk3
 = 
Ãw
 Text();

83 
	mk3
.
£t
(
key
.
g‘By‹s
());

84 
	mv®ues
.
hasNext
()) {

85 
By‹sWr™abË
 
	mv®ue
 = 
v®ues
.
Ãxt
();

86 
	mhba£Key
.
£t
(
key
.
g‘By‹s
());

87 
	mkvLi¡
.
ş—r
();

88 
by‹
 
	mrow
[] = 
Ãw
 by‹[
key
.
g‘L’gth
()];

89 
	mSy¡em
.
¬¿ycİy
(
key
.
g‘By‹s
(), 0, 
row
, 0, key.
g‘L’gth
());

90 
P¬£rResuÉ
 
	m»suÉ
 = 
·r£CÚv”‹r
.
cÚv”‹r
(
row
, 
key
.
g‘L’gth
(), 
v®ue
.
g‘By‹s
(), v®ue.g‘L’gth(), 
kvLi¡
);

91 ià(
	m»suÉ
 !ğ
nuÎ
) {

92 ià(
»suÉ
.
g‘Fšg”
(è!ğ
nuÎ
 &&„esuÉ.g‘Fšg”().
Ëngth
 == 8) {

93 
Text
 
fšg”
 = 
Ãw
 Text();

94 
	mfšg”
.
£t
(
»suÉ
.
g‘Fšg”
());

95 
	mcŞËùÜ
 = 
mos
.
g‘CŞËùÜ
("u¾Andfšg”", 
»pÜ‹r
);

96 
	mcŞËùÜ
.
cŞËù
(
k3
, 
fšg”
);

98 
	mS‘
<
	mURLInfo
> 
	mšfo£t
 = 
»suÉ
.
g‘InfoS‘
();

99 ià(
	mšfo£t
 !ğ
nuÎ
 && 
šfo£t
.
size
() > 0) {

100 
URLInfo
 
šfo
 : 
šfo£t
) {

101 
cŞËùÜ
 = 
mos
.
g‘CŞËùÜ
("u¾šfo", 
»pÜ‹r
);

102 
	mcŞËùÜ
.
cŞËù
(
k3
, 
šfo
);

105 ià(
	mkvLi¡
.
size
() > 0) {

106 
	mŒy
 {

108 
	mCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

109 
KeyV®ue
 
	mkv
 : 
kvLi¡
) {

110 ià(
key
.
g‘L’gth
() == 8) {

111 
cŞËùÜ
 = 
mos
.
g‘CŞËùÜ
("hfed©a", 
»pÜ‹r
);

112 
	mŒy
 {

113 
	mcŞËùÜ
.
cŞËù
(
k
, 
kv
);

114 } 
ÿtch
 (
Exû±iÚ
 
e
) {

115 
	me
.
´štSckT¿û
();

116 
MD5
 
	mmd5
 = 
Ãw
 MD5(
kv
.
g‘Row
(), 
MD5L’
.
eight
, 0);

117 
	mLog
.
šfo
("kv=" + 
md5
.
g‘HexSŒšg
(è+ "\t¤šg bš¬y=" + 
By‹s
.
toSŒšgBš¬y
(
kv
.
g‘Row
()));

120 
	mLog
.
šfo
("”rÜ key†’gth " + 
key
);

123 } 
ÿtch
 (
Exû±iÚ
 
e
) {

124 
	me
.
´štSckT¿û
();

127 
	mSy¡em
.
	mout
.
´šn
("kv†i¡ siz=" + 
kvLi¡
.
size
());

134 
public
 
şo£
(è
throws
 
	mIOExû±iÚ
 {

135 
	mmos
.
şo£
();

139 
public
 
şass
 
M­CÏss
 
ex‹nds
 
M­ReduûBa£
 
im¶em’ts
 
	gM­³r
<
	gText
, Text, 
	gBy‹sWr™abË
, BytesWritable> {

140 
By‹sWr™abË
 
	gk2
 = 
Ãw
 BytesWritable();

141 
By‹sWr™abË
 
	gv2
 = 
Ãw
 BytesWritable();

143 @
Ov”ride


144 
public
 
m­
(
Text
 
key
, Texˆ
v®ue
, 
OuutCŞËùÜ
<
By‹sWr™abË
, By‹sWr™abË> 
ouut
, 
R•Ü‹r
 
»pÜ‹r
è
throws
 
	gIOExû±iÚ
 {

146 
	gk2
.
£t
(
key
.
g‘By‹s
(), 0, key.
g‘L’gth
());

148 
	gv2
.
£t
(
v®ue
.
g‘By‹s
(), 0, v®ue.
g‘L’gth
());

149 
	gouut
.
cŞËù
(
k2
, 
v2
);

154 @
Ov”ride


155 
public
 
	$run
(
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

157 
CÚfigu¿tiÚ
 
cÚf
 = 
	`g‘CÚf
();

158 
JobCÚf
 
job
 = 
Ãw
 
	`JobCÚf
(
cÚf
, 
P¬£ResuÉCÚv”‹rJob
.
şass
);

160 
P©h
 
š
 = 
Ãw
 
	`P©h
(
¬gs
[0]);

161 
P©h
 
out
 = 
Ãw
 
	`P©h
(
¬gs
[1]);

163 
FeIÅutFÜm©
.
	`£tIÅutP©hs
(
job
, 
š
);

164 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
out
);

166 
job
.
	`£tJobName
("ParseResultConverter");

167 
job
.
	`£tM­³rCÏss
(
M­CÏss
.
şass
);

168 
job
.
	`£tReduûrCÏss
(
ReduûCÏss
.
şass
);

170 
job
.
	`£tIÅutFÜm©
(
Sequ’ûFeIÅutFÜm©
.
şass
);

171 
job
.
	`£tM­OuutKeyCÏss
(
By‹sWr™abË
.
şass
);

172 
job
.
	`£tM­OuutV®ueCÏss
(
By‹sWr™abË
.
şass
);

173 
job
.
	`£tOuutKeyCÏss
(
Text
.
şass
);

174 
job
.
	`£tOuutV®ueCÏss
(
Text
.
şass
);

175 
job
.
	`£tNumReduûTasks
(3);

177 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "u¾šfo", 
Sequ’ûFeOuutFÜm©
.
şass
, 
Text
.şass, 
URLInfo
.class);

178 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "u¾Andfšg”", 
Sequ’ûFeOuutFÜm©
.
şass
, 
Text
.class, Text.class);

179 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "hfed©a", 
HFeOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.şass, 
KeyV®ue
.class);

181 
RuÂšgJob
 
rjob
 = 
JobCl›Á
.
	`runJob
(
job
);

184 
	}
}

186 
public
 
	$maš
(
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

187 
»s
 = 
ToŞRuÂ”
.
	`run
(
HBa£CÚfigu¿tiÚ
.
	`ü—‹
(), 
Ãw
 
	`P¬£ResuÉCÚv”‹rJob
(), 
¬gs
);

188 
Sy¡em
.
	`ex™
(
»s
);

189 
	}
}

	@com/zhongsou/spider/hadoop/jobcontrol/JobCreateFactory.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRuÂšgJob
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

7 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gJobInfo
;

8 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gexû±iÚ
.
	gEm±yP¬amV®ueExû±iÚ
;

10 
public
 cÏs 
	cJobC»©eFaùÜy
 {

12 
Logg”
 
	mlog
 = Logg”.
g‘Logg”
(
JobC»©eFaùÜy
.
şass
);

21 
´iv©e
 
Objeù
 
	$ü—‹PesJob
(
JobInfo
 
šfo
) {

23 
PesJobC»©e
 
o
 = 
Ãw
 
	`PesJobC»©e
();

24 
Œy
 {

25 
RuÂšgJob
 
job
 = 
o
.
	`subm™Job
(
šfo
.
	`g’”©eCommªd
().
	`¥l™
(" {1,}"));

27  
job
;

28 } 
	`ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

30 
e
.
	`´štSckT¿û
();

31 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

33 
e
.
	`´štSckT¿û
();

35  
nuÎ
;

47 
´iv©e
 
Objeù
 
	$ü—‹M­»duûV1Job
(
JobInfo
 
šfo
) {

48 
Œy
 {

49 
SŒšg
 
commªd
 = 
šfo
.
	`g’”©eCommªd
();

50 
fœ¡BÏnk
 = 
commªd
.
	`šdexOf
(" ");

51 ià(
fœ¡BÏnk
 == -1)

52  
nuÎ
;

53 
SŒšg
 
şassName
 = 
commªd
.
	`sub¡ršg
(0, 
fœ¡BÏnk
);

54 
SŒšg
 
¬gs
 = 
commªd
.
	`sub¡ršg
(
fœ¡BÏnk
);

55 
CÏss
 
c
 = CÏss.
	`fÜName
(
şassName
.
	`Œim
());

56 
Objeù
 
o
 = 
c
.
	`ÃwIn¡ªû
();

57 ià(
o
 
š¡ªûof
 
M­»duûV1Job
) {

58 
M­»duûV1Job
 
t
 = (M­»duûV1Jobè
o
;

59 
RuÂšgJob
 
job
 = 
t
.
	`ü—‹RuÂabËJob
(
¬gs
.
	`¥l™
(" {1,}"));

60  
job
;

62 
log
.
	`”rÜ
(
şassName
 + " is‚ot‡ valid Mapreduce v1 job");

63  
nuÎ
;

66 } 
	`ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

68 
e
.
	`´štSckT¿û
();

69 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

71 
e
.
	`´štSckT¿û
();

72 } 
	`ÿtch
 (
In¡ªtŸtiÚExû±iÚ
 
e
) {

74 
e
.
	`´štSckT¿û
();

75 } 
	`ÿtch
 (
IÎeg®AcûssExû±iÚ
 
e
) {

77 
e
.
	`´štSckT¿û
();

79  
nuÎ
;

81 
	}
}

83 
´iv©e
 
Objeù
 
	$ü—‹M­»duûV2Job
(
JobInfo
 
šfo
) {

84 
Œy
 {

85 
SŒšg
 
commªd
 = 
šfo
.
	`g’”©eCommªd
().
	`Œim
();

86 
fœ¡BÏnk
 = 
commªd
.
	`šdexOf
(" ");

87 ià(
fœ¡BÏnk
 == -1)

88  
nuÎ
;

89 
SŒšg
 
şassName
 = 
commªd
.
	`sub¡ršg
(0, 
fœ¡BÏnk
);

90 
SŒšg
 
¬gs
 = 
commªd
.
	`sub¡ršg
(
fœ¡BÏnk
).
	`Œim
();

91 
CÏss
 
c
 = CÏss.
	`fÜName
(
şassName
.
	`Œim
());

92 
log
.
	`šfo
("ü—‹ m­»duû v2‡rg " + 
¬gs
);

93 
Objeù
 
o
 = 
c
.
	`ÃwIn¡ªû
();

94 ià(
o
 
š¡ªûof
 
M­»duûV2Job
) {

95 
M­»duûV2Job
 
t
 = (M­»duûV2Jobè
o
;

96 
Job
 
job
 = 
t
.
	`ü—‹RuÂabËJob
(
¬gs
.
	`¥l™
(" {1,}"));

97  
job
;

99 
log
.
	`”rÜ
(
şassName
 + " is‚ot‡ valid Mapreduce v2 job");

100  
nuÎ
;

102 } 
	`ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

104 
e
.
	`´štSckT¿û
();

105 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

107 
e
.
	`´štSckT¿û
();

108 } 
	`ÿtch
 (
In¡ªtŸtiÚExû±iÚ
 
e
) {

110 
e
.
	`´štSckT¿û
();

111 } 
	`ÿtch
 (
IÎeg®AcûssExû±iÚ
 
e
) {

113 
e
.
	`´štSckT¿û
();

115  
nuÎ
;

116 
	}
}

118 
public
 
Objeù
 
	$ü—‹JobObjeù
(
JobInfo
 
jobšfo
) {

119 
Objeù
 
o
 = 
nuÎ
;

120 
jobšfo
.
	`g‘Ty³
()) {

121 
pes
:

122  
	`ü—‹PesJob
(
jobšfo
);

123 
m­»duû_v1
: {

124  
	`ü—‹M­»duûV1Job
(
jobšfo
);

127 
m­»duû_v2
: {

128  
	`ü—‹M­»duûV2Job
(
jobšfo
);

131 
log
.
	`”rÜ
("”rÜ mes§gfÜ job infØ" + 
jobšfo
.
	`toSŒšg
());

134  
o
;

135 
	}
}

	@com/zhongsou/spider/hadoop/jobcontrol/MapreduceV1Job.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRuÂšgJob
;

5 
public
 
š‹rçû
 
	gM­»duûV1Job
 {

7 
public
 
RuÂšgJob
 
ü—‹RuÂabËJob
(
SŒšg
 
¬gs
[]);

	@com/zhongsou/spider/hadoop/jobcontrol/MapreduceV2Job.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

5 
public
 
š‹rçû
 
	gM­»duûV2Job
 {

6 
public
 
Job
 
ü—‹RuÂabËJob
(
SŒšg
 
¬gs
[]);

	@com/zhongsou/spider/hadoop/jobcontrol/ParserJob.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

5 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

6 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

8 
impÜt
 
	gjava
.
	gut
.
	gPrİ”t›s
;

9 
impÜt
 
	gjava
.
	gut
.
	gcÚcu¼’t
.
	gPriÜ™yBlockšgQueue
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gLßdInüem’lHFes
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRuÂšgJob
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gSkBadRecÜds
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gPrİ”tyCÚfigu¿tÜ
;

24 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gJobInfo
;

25 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gP¬£dURLInfo
;

26 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gexû±iÚ
.
	gEm±yP¬amV®ueExû±iÚ
;

27 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gFeInfo
;

28 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gHDFSUt
;

46 
public
 cÏs 
	cP¬£rJob
 
ex‹nds
 
	mSpid”Job
 {

47 
Logg”
 
	mlogg”
 = Logg”.
g‘Logg”
(
P¬£rJob
.
şass
);

48 
	mPriÜ™yBlockšgQueue
<
	mSŒšg
> 
	mfšishedDowÆßdQueue
 =

49 
Ãw
 
PriÜ™yBlockšgQueue
<
SŒšg
>();

50 
	mPriÜ™yBlockšgQueue
<
	mP¬£dURLInfo
> 
	mfšishedP¬£dQueue
 =

51 
Ãw
 
PriÜ™yBlockšgQueue
<
P¬£dURLInfo
>();

52 
boŞ—n
 
	mruÂšg
 = 
Œue
;

53 
P¬£Th»ad
 
	m·r£Th»ad
 = 
Ãw
 ParseThread();

54 
Du¶iÿ‹Th»ad
 
	mdu¶iÿ‹Th»ad
 = 
Ãw
 DuplicateThread();

55 
	mLškedLi¡
<
	mFeInfo
> 
	mi¡
 = 
Ãw
 
LškedLi¡
<
FeInfo
>();

56 
fš®
 
SŒšg
 
	mCLAWER_OUTPUT
 = 
ROOT_DIR
 + "/" + 
CLAWER_OUTPUT_DIR
;

57 
	mHashM­
<
	mSŒšg
, 
	mJobInfo
> 
	mjobInfoM­
;

58 
	msÿnIÁ”v®
;

59 
	m¦“pIÁ”v®
;

60 
	mmaxDocidFeNums
;

61 
HTabË
 
	mwebDBTabË
;

62 
boŞ—n
 
	md–‘eHFe
;

64 
public
 
	$P¬£rJob
(
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

65 
	`su³r
(
cÚf
);

67 
	`sÿnCÏw”FŞd”
();

68 
this
.
jobInfoM­
 = 
jobM­
.
	`g‘
Ñhis.
	`g‘CÏss
().
	`g‘Name
());

69 
this
.
sÿnIÁ”v®
 = 
cÚf
.
	`g‘IÁ
("scan_hbase_interval", 1000 * 10);

70 
this
.
¦“pIÁ”v®
 = 
cÚf
.
	`g‘IÁ
("sleep_interval", 1000 * 10);

71 
this
.
maxDocidFeNums
 = 
cÚf
.
	`g‘IÁ
("max_docid_file_num", 100);

72 
webDBTabË
 = 
Ãw
 
	`HTabË
(
cÚf
, "webDB");

73 
this
.
d–‘eHFe
 = 
cÚf
.
	`g‘BoŞ—n
("d–‘e_hfe", 
Œue
);

77 @
Ov”ride


78 
public
 
	$runJob
() {

79 
Th»ad
 
·r£
 = 
Ãw
 
	`Th»ad
(
this
.
·r£Th»ad
);

80 
Th»ad
 
du¶iÿ‹
 = 
Ãw
 
	`Th»ad
(
this
.
du¶iÿ‹Th»ad
);

82 
·r£
.
	`¡¬t
();

83 
du¶iÿ‹
.
	`¡¬t
();

85 
this
.
ruÂšg
) {

87 
Œy
 {

88 
Th»ad
.
	`¦“p
(1000 * 10);

89 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

90 
e
.
	`´štSckT¿û
();

93 
	}
}

95 
public
 
	$sÿnCÏw”FŞd”
() {

96 
this
.
i¡
.
	`ş—r
();

97 
HDFSUt
.
	`li¡Fe
(
fs
, 
CLAWER_OUTPUT
, 
i¡
, 
çl£
);

98 
FeInfo
 
fešfo
 : 
i¡
) {

99 
SŒšg
 
·th
 = 
fešfo
.
	`g‘P©h
();

100 
SŒšg
 
Çme
 = 
·th
.
	`sub¡ršg
Õ©h.
	`Ï¡IndexOf
("/") + 1);

101 ià(
Çme
.
	`m©ches
("\\d{14}"è&& !
this
.
fšishedDowÆßdQueue
.
	`cÚšs
(
·th
)) {

102 
this
.
fšishedDowÆßdQueue
.
	`add
(
·th
);

103 
logg”
.
	`šfo
("add‡ dowÆßd fšished fŞd”Ø·r£šg queue,·th=" + 
·th
 +

104 "\tqueusize=" + 
this
.
fšishedDowÆßdQueue
.
	`size
());

107  
this
.
fšishedDowÆßdQueue
.
	`size
();

108 
	}
}

110 @
Ov”ride


111 
	$checkFŞd”Exi¡s
() {

113 
HDFSUt
.
	`mkdœs
(
fs
, 
ROOT_DIR
 + "/" + 
CLAWER_DOCID_DIR
);

114 
	}
}

116 şas 
	cP¬£Th»ad
 
im¶em’ts
 
	gRuÂabË
 {

117 @
Ov”ride


118 
public
 
run
() {

120 
	gruÂšg
) {

121 
synchrÚized
 (
this
) {

122 
	gfšishedDowÆßdQueue
.
size
() == 0) {

123 
Œy
 {

124 
sÿnCÏw”FŞd”
();

125 ià(
	gfšishedDowÆßdQueue
.
size
() > 0)

128 
	gthis
.
wa™
(
sÿnIÁ”v®
);

129 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

131 
	ge
.
´štSckT¿û
();

135 
SŒšg
 
	gfŞd”
 = 
fšishedDowÆßdQueue
.
pŞl
();

136 ià(
	gfŞd”
 =ğ
nuÎ
 || 
fŞd”
.
equ®s
("")) {

137 
logg”
.
”rÜ
("retrive‡ wrong…ath from folder");

140 
boŞ—n
 
	gt
 = 
this
.
·r£CÏw”FŞd”
(
fŞd”
);

141 ià(
	gt
) {

142 
	glogg”
.
šfo
("·r£ job " + 
fŞd”
 + " succeed");

144 
	glogg”
.
šfo
("·r£ job " + 
fŞd”
 + " failed");

149 
public
 
boŞ—n
 
·r£CÏw”FŞd”
(
SŒšg
 
fŞd”
) {

150 
boŞ—n
 
	gæag
 = 
çl£
;

151 
JobInfo
 
	g·r£Jobšfo
 = 
jobInfoM­
.
g‘
("parse_url");

152 
SŒšg
 
	gtime
 = 
fŞd”
.
sub¡ršg
(fŞd”.
Ï¡IndexOf
("/") + 1);

153 
SŒšg
 
	gbšdœ
 = 
ROOT_DIR
 + "/" + 
PIPES_BIN_DIR
;

154 
SŒšg
 
	g·r£Ouut
 = 
ROOT_DIR
 + "/" + 
PARSE_OUTPUT_DIR
 + "/" + 
time
;

155 
SŒšg
 
	g·r£_home
 = 
´İ”t›sM­
.
g‘
("$PARSE_HOME");

157 
	gHDFSUt
.
rmdœs
(
fs
, 
bšdœ
 + "/parse_content");

158 
	gHDFSUt
.
u¶ßd
(
fs
, 
·r£_home
 + "/¥id”_c++_commÚ/bš/·r£_cÚ‹Á", 
bšdœ
);

159 
	g·r£Jobšfo
.
g‘P¬amM­
().
put
("$·r£_cÚ‹Á_bš", 
bšdœ
 + "/parse_content");

160 
	g·r£Jobšfo
.
g‘P¬amM­
().
put
("$ouut", 
·r£Ouut
);

161 
	g·r£Jobšfo
.
g‘P¬amM­
().
put
("$job_Çme", "·r£_·ge_" + 
time
);

162 
	g·r£Jobšfo
.
g‘P¬amM­
().
put
("$šput", 
fŞd”
);

164 
	gŒy
 {

165 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
·r£Ouut
))) {

166 
	gHDFSUt
.
rmdœs
(
fs
, 
·r£Ouut
);

168 ià(!
	gfs
.
exi¡s
(
Ãw
 
P©h
(
fŞd”
))) {

169  
	gçl£
;

172 
SŒšg
 
	gcommªd
 = 
·r£Jobšfo
.
g’”©eCommªd
();

173 
	glogg”
.
šfo
("subm™…¬£ job comªd =" + 
commªd
);

174 
RuÂšgJob
 
	gjob
 = (RuÂšgJobè(
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
·r£Jobšfo
));

175 
	gjob
.
wa™FÜCom¶‘iÚ
();

176 
	glogg”
.
šfo
("·r£ jobƒxecu‹ fšished " + 
commªd
 + " " + 
job
.
isSucûssful
());

178 
	gsize
 = 0;

180 ià(!
	gjob
.
isSucûssful
()) {

181 
	gLi¡
<
	gFeInfo
> 
	gi¡
 = 
Ãw
 
LškedLi¡
<
FeInfo
>();

182 
	gHDFSUt
.
li¡Fe
(
fs
, 
·r£Ouut
, 
i¡
, 
çl£
);

183 
	gsize
 = 
i¡
.
size
();

184 
	glogg”
.
w¬n
("·r£ job faed " + 
commªd
 + "\ˆg‘…¬£ sucûed fe =" + 
size
);

187 ià(
	gsize
 > 0 || 
	gjob
.
isSucûssful
()) {

188 
JobInfo
 
	gcÚv”tJob
 = 
jobInfoM­
.
g‘
("parse_convert");

189 
SŒšg
 
	g·r£d_cÚv”t_ouut
 = 
ROOT_DIR
 + "/" + 
PARSE_CONVERT_DIR
 + "/" + 
time
;

190 
	gcÚv”tJob
.
g‘P¬amM­
().
put
("$·r£d_ouut", 
·r£Ouut
);

191 
	gcÚv”tJob
.
g‘P¬amM­
().
put
("$·r£d_cÚv”t_ouut", 
·r£d_cÚv”t_ouut
);

192 
	gcÚv”tJob
.
g‘P¬amM­
().
put
("$job_Çme", "·r£_»suÉ_cÚv”‹r_" + 
time
);

193 
	gcÚv”tJob
.
g‘P¬amM­
().
put
("$£qTime¡amp", 
time
);

195 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
·r£d_cÚv”t_ouut
))) {

196 
	glogg”
.
w¬n
("fŞd” " + 
·r£d_cÚv”t_ouut
 + "‡lreadƒxisted delete");

197 
	gHDFSUt
.
rmdœs
(
fs
, 
·r£d_cÚv”t_ouut
);

200 
SŒšg
 
	gcÚv”tCommªd
 = 
cÚv”tJob
.
g’”©eCommªd
();

201 
	glogg”
.
šfo
("subm™ cÚv”ˆ·r£ job commªd=" + 
cÚv”tCommªd
);

202 
Job
 
	g·r£CÚv”tJob
 = (Jobè(
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
cÚv”tJob
));

203 
	g·r£CÚv”tJob
.
wa™FÜCom¶‘iÚ
(
Œue
);

204 
	glogg”
.
šfo
("cÚv”ˆ·r£ job fšished stus=" + 
·r£CÚv”tJob
.
isCom¶‘e
());

205 ià(
	g·r£CÚv”tJob
.
isSucûssful
()) {

206 
SŒšg
 
	gu¾M‘aFŞd”
 = 
ROOT_DIR
 + "/" + 
PARSED_URL_META_DIR
 + "/" + 
time
;

207 
SŒšg
 
	gu¾AndFšg”
 = 
ROOT_DIR
 + "/" + 
URL_AND_FINGER_DIR
 + "/" + 
time
;

208 
SŒšg
 
	gu¾LškInfo
 = 
ROOT_DIR
 + "/" + 
PARSED_URL_LINK_INFO_DIR
 + "/" + 
time
;

209 
SŒšg
 
	gbak·r£Ouut
 = 
·r£Ouut
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

212 
	glogg”
.
šfo
("movm‘¨f" + 
HDFSUt
.
moveFes
(
fs
, 
·r£d_cÚv”t_ouut
 + "/URLM‘a*", 
u¾M‘aFŞd”
));

213 
	glogg”
.
šfo
("movu¾ infØf" + 
HDFSUt
.
moveFes
(
fs
, 
·r£d_cÚv”t_ouut
 + "/·r£dURL*", 
u¾LškInfo
));

214 
	glogg”
.
šfo
("movÃw u¾ " + 
HDFSUt
.
moveFes
(
fs
, 
·r£d_cÚv”t_ouut
 + "/·¹*", 
u¾AndFšg”
 + "_bak"));

216 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
u¾AndFšg”
 + "_bak", urlAndFinger);

218 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
·r£Ouut
, 
bak·r£Ouut
);

220 
P¬£dURLInfo
 
	gšfo
 = 
Ãw
 ParsedURLInfo();

221 
	gšfo
.
£tM‘aFŞd”
(
u¾M‘aFŞd”
);

222 
	gšfo
.
£tU¾InfoFŞd”
(
u¾LškInfo
);

223 
	gšfo
.
£tSeqTime
(
time
);

224 
	gfšishedP¬£dQueue
.
add
(
šfo
);

225 
	glogg”
.
šfo
("convert job succeed ,add url info " + info + "o duplicate queue");

226 
	gæag
 = 
Œue
;

231 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

233 
	ge
.
´štSckT¿û
();

234 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

236 
	ge
.
´štSckT¿û
();

237 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

239 
	ge
.
´štSckT¿û
();

240 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

242 
	ge
.
´štSckT¿û
();

243 } 
ÿtch
 (
Exû±iÚ
 
e
) {

244 
	ge
.
´štSckT¿û
();

247 
	gfš®ly
 {

248 
SŒšg
 
	gbakCÏw”FŞd”
 = 
fŞd”
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

249 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
fŞd”
, 
bakCÏw”FŞd”
);

252  
	gæag
;

256 şas 
	cDu¶iÿ‹Th»ad
 
im¶em’ts
 
	gRuÂabË
 {

257 
´iv©e
 
	gLi¡
<
	gFeInfo
> 
	gfeLi¡
 = 
Ãw
 
LškedLi¡
<
FeInfo
>();

259 
public
 
Du¶iÿ‹Th»ad
() {

260 
š™Queue
();

269 
public
 
š™Queue
() {

270 
	gi
 = 0;

271 
SŒšg
 
	gm‘a
 = 
ROOT_DIR
 + "/" + 
PARSED_URL_META_DIR
;

272 
SŒšg
 
	gu¾LškInfo
 = 
ROOT_DIR
 + "/" + 
PARSED_URL_LINK_INFO_DIR
;

273 
	gHDFSUt
.
li¡Fe
(
fs
, 
m‘a
, 
feLi¡
, 
çl£
);

275 
FeInfo
 
	gfešfo
 : 
feLi¡
) {

276 
SŒšg
 
·th
 = 
fešfo
.
g‘P©h
();

277 
SŒšg
 
	gtime
 = 
·th
.
sub¡ršg
Õ©h.
Ï¡IndexOf
("/") + 1);

278 ià(
	gtime
.
m©ches
("\\d{14}")) {

279 
	gŒy
 {

280 
SŒšg
 
	gu¾šfo
 = 
u¾LškInfo
 + "/" + 
time
;

281 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
u¾šfo
))) {

282 
P¬£dURLInfo
 
	gšfo
 = 
Ãw
 ParsedURLInfo();

283 
	gšfo
.
£tM‘aFŞd”
(
·th
);

284 
	gšfo
.
£tU¾InfoFŞd”
(
u¾šfo
);

285 
	gšfo
.
£tSeqTime
(
time
);

286 
	glogg”
.
šfo
("load†ast†eft info into finished queue" + info);

287 
	gfšishedP¬£dQueue
.
add
(
šfo
);

288 
	gi
++;

290 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

292 
	ge
.
´štSckT¿û
();

298 
	glogg”
.
šfo
("¡¬ˆlßd†eá…¬£d u¾ infØštØqueue" + 
i
);

299  
	gi
;

303 @
Ov”ride


304 
public
 
run
() {

306 
SŒšg
 
	gdocid_dœ
 = 
ROOT_DIR
 + "/" + 
CLAWER_DOCID_DIR
;

307 
	gruÂšg
) {

308 
synchrÚized
 (
this
) {

309 
	gfšishedP¬£dQueue
.
size
() == 0) {

310 
Œy
 {

311 
this
.
wa™
(
¦“pIÁ”v®
);

312 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

314 
	ge
.
´štSckT¿û
();

318 
	gthis
.
	gfeLi¡
.
ş—r
();

319 
	gŒy
 {

320 
	gHDFSUt
.
li¡Fe
(
fs
, 
docid_dœ
, 
feLi¡
, 
çl£
);

321 ià(
	gthis
.
	gfeLi¡
.
size
(è=ğ0 || 
this
.
feLi¡
.size(è> 
maxDocidFeNums
) {

322 
JobInfo
 
šfo
 = 
jobInfoM­
.
g‘
("export_docid");

323 
as£¹
 (
šfo
 !ğ
nuÎ
);

324 
	gthis
.
expÜtDocidFromHba£
(
šfo
);

327 
P¬£dURLInfo
 
	gšfo
 = 
fšishedP¬£dQueue
.
pŞl
();

328 ià(
	gšfo
 =ğ
nuÎ
) {

329 
logg”
.
”rÜ
("error get‡…arsed url info");

332 
JobInfo
 
	gdu¶iÿ‹Info
 = 
jobInfoM­
.
g‘
("duplicate_url");

333 
as£¹
 (
du¶iÿ‹Info
 !ğ
nuÎ
);

334 
boŞ—n
 
	g»s
 = 
this
.
du¶iÿ‹URL
(
du¶iÿ‹Info
, 
šfo
);

335 ià(
	g»s
) {

336 
JobInfo
 
	g¡©i¡icOldšfo
 = 
jobInfoM­
.
g‘
("statistic_old_url");

337 
boŞ—n
 
	gæag
 = 
this
.
impÜtOldURL
(
¡©i¡icOldšfo
, 
šfo
);

338 
	glogg”
.
šfo
("¡©i¡iøŞd u¾ infØ»suÉ:" + 
æag
);

339 
JobInfo
 
	g¡©i¡icNewInfo
 = 
jobInfoM­
.
g‘
("statistic_new_url");

340 
	gæag
 = 
this
.
impÜtNewURL
(
¡©i¡icNewInfo
, 
šfo
);

341 
	glogg”
.
šfo
("¡©i¡iøÃw u¾ infØ»suÉ:" + 
æag
);

343 
	glogg”
.
šfo
("duplicate url info job failed");

345 } 
ÿtch
 (
Exû±iÚ
 
e
) {

346 
	ge
.
´štSckT¿û
();

347 
	glogg”
.
”rÜ
("get‡ƒxception");

361 
public
 
boŞ—n
 
expÜtDocidFromHba£
(
JobInfo
 
šfo
) {

362 
boŞ—n
 
	gæag
 = 
çl£
;

363 
SŒšg
 
	gexpÜtDocid
 = 
ROOT_DIR
 + "/" + 
CLAWER_DOCID_DIR
 + "_bak";

364 
	gšfo
.
g‘P¬amM­
().
put
("$şaw”_docid_dœ", 
expÜtDocid
);

365 
	gHDFSUt
.
rmdœs
(
fs
, 
expÜtDocid
);

366 
	gŒy
 {

367 
SŒšg
 
	gcommªd
 = 
šfo
.
g’”©eCommªd
();

368 
Job
 
	gjob
 = (Jobè
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
šfo
);

369 
	glogg”
.
šfo
("¡¬ˆexpÜˆdocid job " + 
commªd
);

370 
	gjob
.
wa™FÜCom¶‘iÚ
(
Œue
);

371 
	glogg”
.
šfo
("’dƒxpÜˆdocid job stus=" + 
job
.
isSucûssful
());

372 ià(
	gjob
.
isSucûssful
()) {

373 
	gHDFSUt
.
rmdœs
(
fs
, 
ROOT_DIR
 + "/" + 
CLAWER_DOCID_DIR
);

374 
boŞ—n
 
	gt
 = 
HDFSUt
.
»ÇmeFe
(
fs
, 
expÜtDocid
, 
ROOT_DIR
 + "/" + 
CLAWER_DOCID_DIR
);

375 ià(
	gt
) {

376 
	glogg”
.
šfo
("recreate docid directory succeed!");

377 
	gæag
 = 
Œue
;

382 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

384 
	ge
.
´štSckT¿û
();

385 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

387 
	ge
.
´štSckT¿û
();

388 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

390 
	ge
.
´štSckT¿û
();

391 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

393 
	ge
.
´štSckT¿û
();

394 } 
ÿtch
 (
Exû±iÚ
 
e
) {

395 
	ge
.
´štSckT¿û
();

398  
	gæag
;

409 
public
 
boŞ—n
 
du¶iÿ‹URL
(
JobInfo
 
šfo
, 
P¬£dURLInfo
 
u¾Info
) {

410 
boŞ—n
 
	gæag
 = 
çl£
;

411 
SŒšg
 
	gdu¶iÿ‹_ouut
 = 
ROOT_DIR
 + "/" + 
DUPLICATE_DOCID_DIR
 + "/" + 
u¾Info
.
g‘SeqTime
();

412 
SŒšg
 
	gdocid_dœ
 = 
ROOT_DIR
 + "/" + 
CLAWER_DOCID_DIR
;

413 
SŒšg
 
	gÃw_u¾_¤c_docid_dœ
 = 
ROOT_DIR
 + "/" + 
NEW_URL_SRC_DOCID_DIR
 + "/" + 
u¾Info
.
g‘SeqTime
();

415 
	gšfo
.
g‘P¬amM­
().
put
("$şaw”_docid", 
docid_dœ
);

416 
	gšfo
.
g‘P¬amM­
().
put
("$·r£d_u¾_šfo", 
u¾Info
.
g‘U¾InfoFŞd”
());

417 
	gšfo
.
g‘P¬amM­
().
put
("$job_Çme", "du¶iÿ‹_u¾_" + 
u¾Info
.
g‘SeqTime
());

418 
	gšfo
.
g‘P¬amM­
().
put
("$du¶iÿ‹_u¾_ouut", 
du¶iÿ‹_ouut
);

419 
	gšfo
.
g‘P¬amM­
().
put
("$num_»duû", 
SŒšg
.
v®ueOf
(10));

421 
	gŒy
 {

422 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
du¶iÿ‹_ouut
))) {

423 
	gfs
.
d–‘e
(
Ãw
 
P©h
(
du¶iÿ‹_ouut
), 
Œue
);

425 
SŒšg
 
	gcommªd
 = 
šfo
.
g’”©eCommªd
();

426 
	glogg”
.
šfo
("¡¬ˆdu¶iÿ‹ u¾ commªd " + 
commªd
);

427 
Job
 
	gdu¶iÿ‹Job
 = (Jobè(
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
šfo
));

428 
	gdu¶iÿ‹Job
.
wa™FÜCom¶‘iÚ
(
Œue
);

429 
	glogg”
.
šfo
("’d du¶iÿ‹ u¾ stus=" + 
du¶iÿ‹Job
.
isSucûssful
());

430 ià(
	gdu¶iÿ‹Job
.
isSucûssful
()) {

432 
SŒšg
 
	gouut
 = 
ROOT_DIR
 + "/" + 
DUPLICATE_DOCID_DIR
 + "/" + "Ãw_docid_" + 
u¾Info
.
g‘SeqTime
();

434 
boŞ—n
 
	g»s
 = 
HDFSUt
.
m”geMuÉËSeqFe2OÃ
(
fs
, 
cÚf
, 
du¶iÿ‹_ouut
 + "/Ãwdocid*", 
ouut
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

435 ià(
	g»s
 =ğ
Œue
) {

436 
boŞ—n
 
t1
 = 
HDFSUt
.
»ÇmeFe
(
fs
, 
ouut
, 
docid_dœ
);

437 
boŞ—n
 
	gt2
 = 
HDFSUt
.
rmFes
(
fs
, 
du¶iÿ‹_ouut
 + "/newdocid*");

438 
	glogg”
.
šfo
("m”gÃw docidØÚfe" + 
ouut
 + " sucûed„’am=" + 
t1
 + "\ŒemovŞd‚ew docid fe " + 
t2
);

440 
	glogg”
.
šfo
("m”gÃw docidØÚfe" + 
ouut
 + " failed");

441 
	gHDFSUt
.
moveFes
(
fs
, 
du¶iÿ‹_ouut
 + "/Ãwdocid*", 
docid_dœ
);

443 
	gæag
 = 
Œue
;

444 
	gHDFSUt
.
moveFes
(
fs
, 
du¶iÿ‹_ouut
 + "/¤cu¾docid*", 
Ãw_u¾_¤c_docid_dœ
);

445 
SŒšg
 
	gbakURLInfo
 = 
u¾Info
.
g‘U¾InfoFŞd”
().
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

446 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
u¾Info
.
g‘U¾InfoFŞd”
(), 
bakURLInfo
);

449 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

451 
	ge
.
´štSckT¿û
();

452 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

454 
	ge
.
´štSckT¿û
();

455 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

457 
	ge
.
´štSckT¿û
();

458 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

460 
	ge
.
´štSckT¿û
();

461 } 
ÿtch
 (
Exû±iÚ
 
e
) {

462 
	ge
.
´štSckT¿û
();

465  
	gæag
;

468 
public
 
boŞ—n
 
impÜtOldURL
(
JobInfo
 
šfo
, 
P¬£dURLInfo
 
u¾Info
) {

469 
boŞ—n
 
	gæag
 = 
çl£
;

470 
SŒšg
 
	gu¾M‘aFŞd”
 = 
u¾Info
.
g‘M‘aFŞd”
();

471 
SŒšg
 
	gÃwURLSrcDocidFŞd”
 = 
ROOT_DIR
 + "/" + 
NEW_URL_SRC_DOCID_DIR
 + "/" + 
u¾Info
.
g‘SeqTime
();

472 
SŒšg
 
	g¡©icOldOuut
 = 
ROOT_DIR
 + "/" + 
STATISTIC_OLD_URL_OUTPUT_DIR
 + "/" + 
u¾Info
.
g‘SeqTime
();

473 
	gŒy
 {

474 
boŞ—n
 
	gexi¡
 = 
fs
.
exi¡s
(
Ãw
 
P©h
(
u¾M‘aFŞd”
));

475 
boŞ—n
 
	gexi¡2
 = 
fs
.
exi¡s
(
Ãw
 
P©h
(
ÃwURLSrcDocidFŞd”
));

476 ià(
	gexi¡
 && 
	gexi¡2
) {

477 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
¡©icOldOuut
))) {

478 
	gHDFSUt
.
rmdœs
(
fs
, 
¡©icOldOuut
);

480 
	gšfo
.
g‘P¬amM­
().
put
("$·r£d_u¾m‘a", 
u¾M‘aFŞd”
);

481 
	gšfo
.
g‘P¬amM­
().
put
("$¤cdocid", 
ÃwURLSrcDocidFŞd”
);

482 
	gšfo
.
g‘P¬amM­
().
put
("$job_Çme", "¡©i¡ic_Şd_u¾_" + 
u¾Info
.
g‘SeqTime
());

483 
	gšfo
.
g‘P¬amM­
().
put
("$Şdu¾impÜt_ouut", 
¡©icOldOuut
);

484 
	glogg”
.
šfo
("ü—‹ sti¡iøŞd u¾ job commªd " + info.
g’”©eCommªd
());

485 
Job
 
	g¡©i¡icOldJob
 = (Jobè(
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
šfo
));

486 
	g¡©i¡icOldJob
.
wa™FÜCom¶‘iÚ
(
Œue
);

487 ià(
	g¡©i¡icOldJob
.
isSucûssful
()) {

488 
LßdInüem’lHFes
 
	glßd”
 = 
Ãw
 LßdInüem’lHFes(
cÚf
);

489 
	glogg”
.
šfo
("¡¬ˆlßd hftØwebDbabË…©h=" + 
¡©icOldOuut
);

490 
	glßd”
.
doBulkLßd
(
Ãw
 
P©h
(
¡©icOldOuut
), 
webDBTabË
);

491 
	glogg”
.
šfo
("lßd " + 
¡©icOldOuut
 + "o webDBable succeed!");

492 
	gæag
 = 
Œue
;

494 
	glogg”
.
šfo
("statistic old url job failed");

497 
	glogg”
.
šfo
("fŞd” i missšg " + 
u¾M‘aFŞd”
 + "ƒxi¡ed:" + 
exi¡
 + "\ˆ" + 
ÃwURLSrcDocidFŞd”
 + "ƒxi¡ed:" + 
exi¡2
);

499 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

501 
	ge
.
´štSckT¿û
();

502 
	glogg”
.
”rÜ
("impÜˆŞd u¾ infØ”rÜ " + 
e
.
g‘Mes§ge
());

503 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

505 
	ge
.
´štSckT¿û
();

506 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

508 
	ge
.
´štSckT¿û
();

509 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

511 
	ge
.
´štSckT¿û
();

512 } 
ÿtch
 (
Exû±iÚ
 
e
) {

514 
	ge
.
´štSckT¿û
();

515 
	glogg”
.
”rÜ
("¡©i¡iøŞd u¾ infØjob faed!" + 
e
.
g‘Mes§ge
());

516 } 
	gfš®ly
 {

517 
SŒšg
 
	gm‘aBak
 = 
u¾M‘aFŞd”
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

518 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
u¾M‘aFŞd”
, 
m‘aBak
);

519 
SŒšg
 
	gÃwURLBak
 = 
ÃwURLSrcDocidFŞd”
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

520 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
ÃwURLSrcDocidFŞd”
, 
ÃwURLBak
);

521 ià(
	gd–‘eHFe
) {

522 
	glogg”
.
šfo
("d–‘impÜˆhf" + 
¡©icOldOuut
);

523 
	gHDFSUt
.
rmdœs
(
fs
, 
¡©icOldOuut
);

525 
SŒšg
 
	ghfeBak
 = 
¡©icOldOuut
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

526 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
¡©icOldOuut
, 
hfeBak
);

527 
	glogg”
.
šfo
("»Çmfhäom fŞd” " + 
¡©icOldOuut
 + "Ø" + 
hfeBak
);

531  
	gæag
;

534 
public
 
boŞ—n
 
impÜtNewURL
(
JobInfo
 
šfo
, 
P¬£dURLInfo
 
u¾Info
) {

535 
boŞ—n
 
	gæag
 = 
çl£
;

536 
SŒšg
 
	gdu¶iÿ‹_ouut
 = 
ROOT_DIR
 + "/" + 
DUPLICATE_DOCID_DIR
 + "/" + 
u¾Info
.
g‘SeqTime
();

537 
SŒšg
 
	g¡©icNewOuut
 = 
ROOT_DIR
 + "/" + 
STATISTIC_NEW_URL_OUTPUT_DIR
 + "/" + 
u¾Info
.
g‘SeqTime
();

538 
	gŒy
 {

539 
boŞ—n
 
	gexi¡
 = 
fs
.
exi¡s
(
Ãw
 
P©h
(
du¶iÿ‹_ouut
));

540 ià(
	gexi¡
) {

541 
	gšfo
.
g‘P¬amM­
().
put
("$Ãw_u¾_šfo", 
du¶iÿ‹_ouut
);

542 
	gšfo
.
g‘P¬amM­
().
put
("$job_Çme", "¡©i¡ic_Ãw_u¾_" + 
u¾Info
.
g‘SeqTime
());

543 
	gšfo
.
g‘P¬amM­
().
put
("$Ãwu¾impÜt_ouut", 
¡©icNewOuut
);

544 
	glogg”
.
šfo
("ü—‹ sti¡iøÃw u¾ job commªd " + info.
g’”©eCommªd
());

545 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
¡©icNewOuut
))) {

546 
	gHDFSUt
.
rmdœs
(
fs
, 
¡©icNewOuut
);

548 
Job
 
	g¡©i¡icOldJob
 = (Jobè(
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
šfo
));

549 
	g¡©i¡icOldJob
.
wa™FÜCom¶‘iÚ
(
Œue
);

550 ià(
	g¡©i¡icOldJob
.
isSucûssful
()) {

551 
LßdInüem’lHFes
 
	glßd”
 = 
Ãw
 LßdInüem’lHFes(
cÚf
);

552 
	glogg”
.
šfo
("¡¬ˆlßd hftØwebDbabË…©h=" + 
¡©icNewOuut
);

553 
	glßd”
.
doBulkLßd
(
Ãw
 
P©h
(
¡©icNewOuut
), 
webDBTabË
);

554 
	glogg”
.
šfo
("lßd " + 
¡©icNewOuut
 + "o webDBable succeed!");

555 
	gæag
 = 
Œue
;

557 
	glogg”
.
šfo
("statistic old url job failed");

560 
	glogg”
.
šfo
("fŞd” i missšg " + 
du¶iÿ‹_ouut
 + "ƒxi¡ed:" + 
exi¡
);

563 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

565 
	ge
.
´štSckT¿û
();

566 
	glogg”
.
”rÜ
("impÜˆŞd u¾ infØ”rÜ " + 
e
.
g‘Mes§ge
());

567 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

569 
	ge
.
´štSckT¿û
();

570 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

572 
	ge
.
´štSckT¿û
();

573 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

575 
	ge
.
´štSckT¿û
();

576 } 
ÿtch
 (
Exû±iÚ
 
e
) {

578 
	ge
.
´štSckT¿û
();

579 
	glogg”
.
”rÜ
("¡©i¡iøÃw u¾ infØjob faed!" + 
e
.
g‘Mes§ge
());

580 } 
	gfš®ly
 {

581 
SŒšg
 
	gdu¶iÿ‹Bak
 = 
du¶iÿ‹_ouut
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

582 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
du¶iÿ‹_ouut
, 
du¶iÿ‹Bak
);

583 ià(
	gd–‘eHFe
) {

584 
	gHDFSUt
.
rmdœs
(
fs
, 
¡©icNewOuut
);

585 
	glogg”
.
šfo
("d–‘Ãw u¾ hf" + 
¡©icNewOuut
);

587 
SŒšg
 
	gÃwHfe
 = 
¡©icNewOuut
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

588 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
¡©icNewOuut
, 
ÃwHfe
);

589 
	glogg”
.
šfo
("»ÇmÃw u¾ impÜˆhfäom " + 
¡©icNewOuut
 + "Ø" + 
ÃwHfe
);

593  
	gæag
;

597 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

598 
Œy
 {

599 
Prİ”t›s
 
p
 = 
Ãw
 
	`Prİ”t›s
();

600 
p
.
	`lßd
(
S–eùAndS’dJob
.
şass
.
	`g‘ResourûAsSŒ—m
("/log4j.properties"));

601 
Prİ”tyCÚfigu¿tÜ
.
	`cÚfigu»
(
p
);

602 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e1
) {

604 
e1
.
	`´štSckT¿û
();

605 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

607 
e
.
	`´štSckT¿û
();

609 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

610 
Œy
 {

611 
P¬£rJob
 
·r£Job
 = 
Ãw
 
	`P¬£rJob
(
cÚf
);

612 
·r£Job
.
	`runJob
();

614 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

616 
e
.
	`´štSckT¿û
();

618 
	}
}

	@com/zhongsou/spider/hadoop/jobcontrol/PipesJobCreate.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURL
;

7 
impÜt
 
	gjava
.
	gÃt
.
	gURLCÏssLßd”
;

8 
impÜt
 
	gjava
.
	g£cur™y
.
	gAcûssCÚŒŞËr
;

9 
impÜt
 
	gjava
.
	g£cur™y
.
	gPrivegedAùiÚ
;

10 
impÜt
 
	gjava
.
	gut
.
	gSŒšgTok’iz”
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gşi
.
	gBasicP¬£r
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gşi
.
	gCommªdLše
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gşi
.
	gO±iÚ
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gşi
.
	gO±iÚBud”
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gşi
.
	gO±iÚs
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gşi
.
	gP¬£Exû±iÚ
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gşi
.
	gP¬£r
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLog
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLogFaùÜy
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeIÅutFÜm©
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeOuutFÜm©
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gIÅutFÜm©
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCl›Á
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gM­³r
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gOuutFÜm©
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gP¬t™iÚ”
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gReduûr
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRuÂšgJob
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	glib
.
	gHashP¬t™iÚ”
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	glib
.
	gNuÎOuutFÜm©
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gpes
.
	gSubm™‹r
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞ
;

43 
public
 cÏs 
	cPesJobC»©e
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mToŞ
 {

44 
´Ùeùed
 
fš®
 
Log
 
	mLOG
 = 
LogFaùÜy
.
g‘Log
(
PesJobC»©e
.
şass
);

46 
public
 
	$PesJobC»©e
() {

47 
	`this
(
Ãw
 
	`CÚfigu¿tiÚ
());

50 
public
 
	$PesJobC»©e
(
CÚfigu¿tiÚ
 
cÚf
) {

51 
	`£tCÚf
(
cÚf
);

52 
	}
}

60 
public
 
SŒšg
 
	$g‘ExecubË
(
JobCÚf
 
cÚf
) {

61  
cÚf
.
	`g‘
("hadoop.pipes.executable");

62 
	}
}

72 
public
 
	$£tExecubË
(
JobCÚf
 
cÚf
, 
SŒšg
 
execubË
) {

73 
cÚf
.
	`£t
("hadoİ.pes.execubË", 
execubË
);

74 
	}
}

84 
public
 
	$£tIsJavaRecÜdR—d”
(
JobCÚf
 
cÚf
, 
boŞ—n
 
v®ue
) {

85 
cÚf
.
	`£tBoŞ—n
("hadoİ.pes.java.»cÜd»ad”", 
v®ue
);

86 
	}
}

95 
public
 
boŞ—n
 
	$g‘IsJavaRecÜdR—d”
(
JobCÚf
 
cÚf
) {

96  
cÚf
.
	`g‘BoŞ—n
("hadoİ.pes.java.»cÜd»ad”", 
çl£
);

97 
	}
}

107 
public
 
	$£tIsJavaM­³r
(
JobCÚf
 
cÚf
, 
boŞ—n
 
v®ue
) {

108 
cÚf
.
	`£tBoŞ—n
("hadoİ.pes.java.m­³r", 
v®ue
);

109 
	}
}

118 
public
 
boŞ—n
 
	$g‘IsJavaM­³r
(
JobCÚf
 
cÚf
) {

119  
cÚf
.
	`g‘BoŞ—n
("hadoİ.pes.java.m­³r", 
çl£
);

120 
	}
}

130 
public
 
	$£tIsJavaReduûr
(
JobCÚf
 
cÚf
, 
boŞ—n
 
v®ue
) {

131 
cÚf
.
	`£tBoŞ—n
("hadoİ.pes.java.»duûr", 
v®ue
);

132 
	}
}

141 
public
 
boŞ—n
 
	$g‘IsJavaReduûr
(
JobCÚf
 
cÚf
) {

142  
cÚf
.
	`g‘BoŞ—n
("hadoİ.pes.java.»duûr", 
çl£
);

143 
	}
}

153 
public
 
	$£tIsJavaRecÜdWr™”
(
JobCÚf
 
cÚf
, 
boŞ—n
 
v®ue
) {

154 
cÚf
.
	`£tBoŞ—n
("hadoİ.pes.java.»cÜdwr™”", 
v®ue
);

155 
	}
}

164 
public
 
boŞ—n
 
	$g‘IsJavaRecÜdWr™”
(
JobCÚf
 
cÚf
) {

165  
cÚf
.
	`g‘BoŞ—n
("hadoİ.pes.java.»cÜdwr™”", 
çl£
);

166 
	}
}

179 
´iv©e
 
	$£tIfUn£t
(
JobCÚf
 
cÚf
, 
SŒšg
 
key
, SŒšg 
v®ue
) {

180 ià(
cÚf
.
	`g‘
(
key
è=ğ
nuÎ
) {

181 
cÚf
.
	`£t
(
key
, 
v®ue
);

183 
	}
}

193 
	$£tJavaP¬t™iÚ”
(
JobCÚf
 
cÚf
, 
CÏss
 
şs
) {

194 
cÚf
.
	`£t
("hadoİ.pes.·¹™iÚ”", 
şs
.
	`g‘Name
());

195 
	}
}

204 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘JavaP¬t™iÚ”
(
JobCÚf
 
cÚf
) {

205  
cÚf
.
	`g‘CÏss
("hadoİ.pes.·¹™iÚ”", 
HashP¬t™iÚ”
.
şass
, 
P¬t™iÚ”
.class);

206 
	}
}

221 
public
 
boŞ—n
 
	$g‘K“pCommªdFe
(
JobCÚf
 
cÚf
) {

222  
cÚf
.
	`g‘BoŞ—n
("hadoİ.pes.commªd-fe.k“p", 
çl£
);

223 
	}
}

233 
public
 
	$£tK“pCommªdFe
(
JobCÚf
 
cÚf
, 
boŞ—n
 
k“p
) {

234 
cÚf
.
	`£tBoŞ—n
("hadoİ.pes.commªd-fe.k“p", 
k“p
);

235 
	}
}

247 @
D•»ÿ‹d


248 
public
 
RuÂšgJob
 
	$subm™Job
(
JobCÚf
 
cÚf
è
throws
 
IOExû±iÚ
 {

249  
	`runJob
(
cÚf
);

250 
	}
}

261 
public
 
RuÂšgJob
 
	$runJob
(
JobCÚf
 
cÚf
è
throws
 
IOExû±iÚ
 {

262 
	`£tupPesJob
(
cÚf
);

263  
JobCl›Á
.
	`runJob
(
cÚf
);

264 
	}
}

276 
public
 
RuÂšgJob
 
	$jobSubm™
(
JobCÚf
 
cÚf
è
throws
 
IOExû±iÚ
 {

277 
	`£tupPesJob
(
cÚf
);

278  
Ãw
 
	`JobCl›Á
(
cÚf
).
	`subm™Job
(conf);

279 
	}
}

281 
public
 
RuÂšgJob
 
	$runJob
(
SŒšg
 
¬gs
[]è
throws
 
Exû±iÚ
 {

282 
JobCÚf
 
cÚf
 = 
this
.
	`·r£JobCÚf
(
¬gs
);

283 
	`£tupPesJob
(
cÚf
);

284  
JobCl›Á
.
	`runJob
(
cÚf
);

285 
	}
}

287 
public
 
RuÂšgJob
 
	$subm™Job
(
SŒšg
 
¬gs
[]è
throws
 
Exû±iÚ
 {

288 
JobCÚf
 
cÚf
 = 
this
.
	`·r£JobCÚf
(
¬gs
);

289 
	`£tupPesJob
(
cÚf
);

290 
JobCl›Á
 
jobCl›Á
 = 
Ãw
 
	`JobCl›Á
(
cÚf
);

291  
jobCl›Á
.
	`subm™JobIÁ”Çl
(
cÚf
);

293 
	}
}

295 
´iv©e
 
	$£tupPesJob
(
JobCÚf
 
cÚf
è
throws
 
IOExû±iÚ
 {

297 ià(!
	`g‘IsJavaM­³r
(
cÚf
)) {

298 
cÚf
.
	`£t
("mapred.map.runner.class", "org.apache.hadoop.mapred.pipes.PipesMapRunner");

301 
	`£tJavaP¬t™iÚ”
(
cÚf
, cÚf.
	`g‘P¬t™iÚ”CÏss
());

303 
cÚf
.
	`£t
("mapred.partitioner.class", "org.apache.hadoop.mapred.pipes.PipesPartitioner");

305 ià(!
	`g‘IsJavaReduûr
(
cÚf
)) {

307 
cÚf
.
	`£t
("mapred.reducer.class", "org.apache.hadoop.mapred.pipes.PipesReducer");

308 ià(!
	`g‘IsJavaRecÜdWr™”
(
cÚf
)) {

309 
cÚf
.
	`£tOuutFÜm©
(
NuÎOuutFÜm©
.
şass
);

312 
SŒšg
 
‹xtCÏs¢ame
 = 
Text
.
şass
.
	`g‘Name
();

313 
	`£tIfUn£t
(
cÚf
, "m­»d.m­ouut.key.şass", 
‹xtCÏs¢ame
);

314 
	`£tIfUn£t
(
cÚf
, "m­»d.m­ouut.v®ue.şass", 
‹xtCÏs¢ame
);

315 
	`£tIfUn£t
(
cÚf
, "m­»d.ouut.key.şass", 
‹xtCÏs¢ame
);

316 
	`£tIfUn£t
(
cÚf
, "m­»d.ouut.v®ue.şass", 
‹xtCÏs¢ame
);

320 ià(!
	`g‘IsJavaRecÜdR—d”
(
cÚf
è&& !
	`g‘IsJavaM­³r
(conf)) {

321 
cÚf
.
	`£tCÏss
("m­»d.pes.u£r.šputfÜm©", cÚf.
	`g‘IÅutFÜm©
().
	`g‘CÏss
(), 
IÅutFÜm©
.
şass
);

323 
cÚf
.
	`£t
("mapred.input.format.class", "org.apache.hadoop.mapred.pipes.PipesNonJavaInputFormat");

326 
SŒšg
 
exec
 = 
	`g‘ExecubË
(
cÚf
);

327 ià(
exec
 =ğ
nuÎ
) {

328 
throw
 
Ãw
 
	`IÎeg®Argum’tExû±iÚ
("No‡pplication…rogram defined.");

332 ià(
exec
.
	`cÚšs
("#")) {

333 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

335 
SŒšg
 
defSüt
 = "$HADOOP_HOME/src/c++/pipes/debug/pipes-default-script";

336 
	`£tIfUn£t
(
cÚf
, "m­»d.m­.sk.debug.süt", 
defSüt
);

337 
	`£tIfUn£t
(
cÚf
, "m­»d.»duû.sk.debug.süt", 
defSüt
);

339 
URI
[] 
feCache
 = 
Di¡ribu‹dCache
.
	`g‘CacheFes
(
cÚf
);

340 ià(
feCache
 =ğ
nuÎ
) {

341 
feCache
 = 
Ãw
 
URI
[1];

343 
URI
[] 
tmp
 = 
Ãw
 URI[
feCache
.
Ëngth
 + 1];

344 
Sy¡em
.
	`¬¿ycİy
(
feCache
, 0, 
tmp
, 1, feCache.
Ëngth
);

345 
feCache
 = 
tmp
;

347 
Œy
 {

348 
feCache
[0] = 
Ãw
 
	`URI
(
exec
);

349 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

350 
IOExû±iÚ
 
›
 = 
Ãw
 
	`IOExû±iÚ
("ProbËm…¬sšgƒxeÿbË URI " + 
exec
);

351 
›
.
	`š™Cau£
(
e
);

352 
throw
 
›
;

354 
Di¡ribu‹dCache
.
	`£tCacheFes
(
feCache
, 
cÚf
);

355 
	}
}

360 şas 
	cCommªdLšeP¬£r
 {

361 
´iv©e
 
O±iÚs
 
	gİtiÚs
 = 
Ãw
 Options();

363 
addO±iÚ
(
SŒšg
 
lÚgName
, 
boŞ—n
 
»quœed
, SŒšg 
desütiÚ
, SŒšg 
·¿mName
) {

364 
O±iÚ
 
	gİtiÚ
 = 
O±iÚBud”
.
w™hArgName
(
·¿mName
).
hasArgs
(1).
w™hDesütiÚ
(
desütiÚ
).
isRequœed
(
»quœed
).
ü—‹
(
lÚgName
);

365 
	gİtiÚs
.
addO±iÚ
(
İtiÚ
);

368 
addArgum’t
(
SŒšg
 
Çme
, 
boŞ—n
 
»quœed
, SŒšg 
desütiÚ
) {

369 
O±iÚ
 
	gİtiÚ
 = 
O±iÚBud”
.
w™hArgName
(
Çme
).
hasArgs
(1).
w™hDesütiÚ
(
desütiÚ
).
isRequœed
(
»quœed
).
ü—‹
();

370 
	gİtiÚs
.
addO±iÚ
(
İtiÚ
);

374 
P¬£r
 
ü—‹P¬£r
() {

375 
P¬£r
 
	g»suÉ
 = 
Ãw
 
BasicP¬£r
();

376  
	g»suÉ
;

379 
´štU§ge
() {

382 
	gSy¡em
.
	gout
.
´šn
("bin/hadoop…ipes");

383 
	gSy¡em
.
	gout
.
´šn
(" [-input <path>] // Input directory");

384 
	gSy¡em
.
	gout
.
´šn
(" [-output <path>] // Output directory");

385 
	gSy¡em
.
	gout
.
´šn
(" [-jar <jar file> // jar filename");

386 
	gSy¡em
.
	gout
.
´šn
(" [-inputformat <class>] // InputFormat class");

387 
	gSy¡em
.
	gout
.
´šn
(" [-map <class>] // Java Map class");

388 
	gSy¡em
.
	gout
.
´šn
(" [-partitioner <class>] // Java Partitioner");

389 
	gSy¡em
.
	gout
.
´šn
(" [-reduce <class>] // Java Reduce class");

390 
	gSy¡em
.
	gout
.
´šn
(" [-writer <class>] // Java RecordWriter");

391 
	gSy¡em
.
	gout
.
´šn
(" [-program <executable>] //ƒxecutable URI");

392 
	gSy¡em
.
	gout
.
´šn
(" [-reduces <num>] //‚umber of„educes");

393 
	gSy¡em
.
	gout
.
´šn
();

394 
	gG’”icO±iÚsP¬£r
.
´štG’”icCommªdU§ge
(
Sy¡em
.
out
);

398 
´iv©e
 <
	gIÁ”çûTy³
> 
	gCÏss
<? 
ex‹nds
 IÁ”çûTy³> 
g‘CÏss
(
CommªdLše
 
ş
, 
SŒšg
 
key
, 
JobCÚf
 
cÚf
, 
CÏss
<
IÁ”çûTy³
> 
şs
è
throws
 
	gCÏssNÙFoundExû±iÚ
 {

399  
	gcÚf
.
g‘CÏssByName
((
SŒšg
è
ş
.
g‘O±iÚV®ue
(
key
)).
asSubşass
(
şs
);

402 
public
 
JobCÚf
 
	$·r£JobCÚf
(
SŒšg
 
¬gs
[]è
throws
 
Exû±iÚ
 {

403 
CommªdLšeP¬£r
 
şi
 = 
Ãw
 
	`CommªdLšeP¬£r
();

404 ià(
¬gs
.
Ëngth
 == 0) {

405 
şi
.
	`´štU§ge
();

406  
nuÎ
;

408 
şi
.
	`addO±iÚ
("šput", 
çl£
, "input…athohe maps", "path");

409 
şi
.
	`addO±iÚ
("ouut", 
çl£
, "output…ath fromhe„educes", "path");

411 
şi
.
	`addO±iÚ
("j¬", 
çl£
, "job jar file", "path");

412 
şi
.
	`addO±iÚ
("šputfÜm©", 
çl£
, "java classname of InputFormat", "class");

414 
şi
.
	`addO±iÚ
("m­", 
çl£
, "java classname of Mapper", "class");

415 
şi
.
	`addO±iÚ
("·¹™iÚ”", 
çl£
, "java classname of Partitioner", "class");

416 
şi
.
	`addO±iÚ
("»duû", 
çl£
, "java classname of Reducer", "class");

417 
şi
.
	`addO±iÚ
("wr™”", 
çl£
, "java classname of OutputFormat", "class");

418 
şi
.
	`addO±iÚ
("´og¿m", 
çl£
, "URIo‡pplicationƒxecutable", "class");

419 
şi
.
	`addO±iÚ
("»duûs", 
çl£
, "number of„educes", "num");

420 
şi
.
	`addO±iÚ
("jobcÚf", 
çl£
, "\"n1=v1,n2=v2,..\" (Deprecated) Optional. Add or override‡ JobConf…roperty.", "key=val");

421 
P¬£r
 
·r£r
 = 
şi
.
	`ü—‹P¬£r
();

422 
Œy
 {

424 
G’”icO±iÚsP¬£r
 
g’”icP¬£r
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
	`g‘CÚf
(), 
¬gs
);

425 
CommªdLše
 
»suÉs
 = 
·r£r
.
	`·r£
(
şi
.
İtiÚs
, 
g’”icP¬£r
.
	`g‘RemaššgArgs
());

427 
JobCÚf
 
job
 = 
Ãw
 
	`JobCÚf
(
	`g‘CÚf
());

429 ià(
»suÉs
.
	`hasO±iÚ
("input")) {

430 
FeIÅutFÜm©
.
	`£tIÅutP©hs
(
job
, (
SŒšg
è
»suÉs
.
	`g‘O±iÚV®ue
("input"));

432 ià(
»suÉs
.
	`hasO±iÚ
("output")) {

433 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
((
SŒšg
è
»suÉs
.
	`g‘O±iÚV®ue
("output")));

435 ià(
»suÉs
.
	`hasO±iÚ
("jar")) {

436 
job
.
	`£tJ¬
((
SŒšg
è
»suÉs
.
	`g‘O±iÚV®ue
("jar"));

438 ià(
»suÉs
.
	`hasO±iÚ
("inputformat")) {

439 
	`£tIsJavaRecÜdR—d”
(
job
, 
Œue
);

440 
job
.
	`£tIÅutFÜm©
(
	`g‘CÏss
(
»suÉs
, "šputfÜm©", job, 
IÅutFÜm©
.
şass
));

442 ià(
»suÉs
.
	`hasO±iÚ
("javareader")) {

443 
	`£tIsJavaRecÜdR—d”
(
job
, 
Œue
);

445 ià(
»suÉs
.
	`hasO±iÚ
("map")) {

446 
	`£tIsJavaM­³r
(
job
, 
Œue
);

447 
job
.
	`£tM­³rCÏss
(
	`g‘CÏss
(
»suÉs
, "m­", job, 
M­³r
.
şass
));

449 ià(
»suÉs
.
	`hasO±iÚ
("partitioner")) {

450 
job
.
	`£tP¬t™iÚ”CÏss
(
	`g‘CÏss
(
»suÉs
, "·¹™iÚ”", job, 
P¬t™iÚ”
.
şass
));

452 ià(
»suÉs
.
	`hasO±iÚ
("reduce")) {

453 
	`£tIsJavaReduûr
(
job
, 
Œue
);

454 
job
.
	`£tReduûrCÏss
(
	`g‘CÏss
(
»suÉs
, "»duû", job, 
Reduûr
.
şass
));

456 ià(
»suÉs
.
	`hasO±iÚ
("reduces")) {

457 
job
.
	`£tNumReduûTasks
(
IÁeg”
.
	`·r£IÁ
((
SŒšg
è
»suÉs
.
	`g‘O±iÚV®ue
("reduces")));

459 ià(
»suÉs
.
	`hasO±iÚ
("writer")) {

460 
	`£tIsJavaRecÜdWr™”
(
job
, 
Œue
);

461 
job
.
	`£tOuutFÜm©
(
	`g‘CÏss
(
»suÉs
, "wr™”", job, 
OuutFÜm©
.
şass
));

463 ià(
»suÉs
.
	`hasO±iÚ
("program")) {

464 
	`£tExecubË
(
job
, (
SŒšg
è
»suÉs
.
	`g‘O±iÚV®ue
("program"));

466 ià(
»suÉs
.
	`hasO±iÚ
("jobconf")) {

467 
LOG
.
	`w¬n
("-jobconf option is deprecated,…lease use -D instead.");

468 
SŒšg
 
İtiÚs
 = (SŒšgè
»suÉs
.
	`g‘O±iÚV®ue
("jobconf");

469 
SŒšgTok’iz”
 
tok’iz”
 = 
Ãw
 
	`SŒšgTok’iz”
(
İtiÚs
, ",");

470 
tok’iz”
.
	`hasMÜeTok’s
()) {

471 
SŒšg
 
keyV®
 = 
tok’iz”
.
	`ÃxtTok’
().
	`Œim
();

472 
SŒšg
[] 
keyV®S¶™
 = 
keyV®
.
	`¥l™
("=", 2);

473 
job
.
	`£t
(
keyV®S¶™
[0], keyValSplit[1]);

477 
SŒšg
 
j¬Fe
 = 
job
.
	`g‘J¬
();

478 ià(
j¬Fe
 !ğ
nuÎ
) {

479 
fš®
 
URL
[] 
u¾s
 = 
Ãw
 URL[] { 
FeSy¡em
.
	`g‘Loÿl
(
job
).
	`·thToFe
Òew 
	`P©h
(
j¬Fe
)).
	`toURL
() };

482 
CÏssLßd”
 
lßd”
 = 
AcûssCÚŒŞËr
.
	`doPriveged
(
Ãw
 
PrivegedAùiÚ
<ClassLoader>() {

483 
public
 
CÏssLßd”
 
	`run
() {

484  
Ãw
 
	`URLCÏssLßd”
(
u¾s
);

487 
job
.
	`£tCÏssLßd”
(
lßd”
);

489  
job
;

490 } 
	`ÿtch
 (
P¬£Exû±iÚ
 
³
) {

491 
LOG
.
	`šfo
("E¼Ü : " + 
³
);

492 
şi
.
	`´štU§ge
();

493  
nuÎ
;

495 
	}
}

497 @
Ov”ride


498 
public
 
	$run
(
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

499 
JobCÚf
 
job
 = 
	`·r£JobCÚf
(
¬gs
);

500 
	`runJob
(
job
);

503 
	}
}

510 
public
 
	$maš
(
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

512 
ex™Code
 = 
Ãw
 
	`PesJobC»©e
().
	`run
(
¬gs
);

513 
Sy¡em
.
	`ex™
(
ex™Code
);

514 
	}
}

	@com/zhongsou/spider/hadoop/jobcontrol/ScoreAndClawerJob.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

5 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

6 
impÜt
 
	gjava
.
	gut
.
	gD©e
;

7 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

8 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

9 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

10 
impÜt
 
	gjava
.
	gut
.
	gPrİ”t›s
;

11 
impÜt
 
	gjava
.
	gut
.
	gcÚcu¼’t
.
	gLškedBlockšgQueue
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRuÂšgJob
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gTask
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gPrİ”tyCÚfigu¿tÜ
;

22 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gJobInfo
;

23 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gexû±iÚ
.
	gEm±yP¬amV®ueExû±iÚ
;

24 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gFeInfo
;

25 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gHDFSUt
;

26 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjob
.
	gCouÁ”H–³r
;

42 
public
 cÏs 
	cScÜeAndCÏw”Job
 
ex‹nds
 
	mSpid”Job
 {

44 
Logg”
 
	mlogg”
 = Logg”.
g‘Logg”
(
ScÜeAndCÏw”Job
.
şass
);

45 
´iv©e
 
SŒšg
 
	mSCORE_OUTPUT_TEMP
 = "/user/kaifa/score_output";

47 
public
 
	$ScÜeAndCÏw”Job
(
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

48 
	`su³r
(
cÚf
);

50 
SCORE_OUTPUT_TEMP
 = 
cÚf
.
	`g‘
("score_output_temp", SCORE_OUTPUT_TEMP);

51 
this
.
jobInfoM­
 = 
jobM­
.
	`g‘
Ñhis.
	`g‘CÏss
().
	`g‘Name
());

52 
this
.
scÜeTh»ad
 = 
Ãw
 
	`ScÜeURLTh»ad
(
çl£
);

53 
this
.
dowÆßdTh»ad
 = 
Ãw
 
	`DowÆßdURLTh»ad
(
çl£
);

54 
scÜeNewTh»ad
 = 
Ãw
 
	`ScÜeURLTh»ad
(
Œue
);

55 
dowÆßdNewTh»ad
 = 
Ãw
 
	`DowÆßdURLTh»ad
(
Œue
);

56 
	`sÿnSÜtURLFŞd”
();

57 
Sy¡em
.
out
.
	`´šn
("jobInfØ" + 
jobInfoM­
.
	`size
());

60 
LškedBlockšgQueue
<
SŒšg
> 
ŞdURLS“dQueue
 = 
Ãw
 LinkedBlockingQueue<String>();

61 
LškedBlockšgQueue
<
SŒšg
> 
ÃwURLS“dQueue
 = 
Ãw
 LinkedBlockingQueue<String>();

62 
ScÜeURLTh»ad
 
scÜeTh»ad
;

63 
DowÆßdURLTh»ad
 
dowÆßdTh»ad
;

65 
ScÜeURLTh»ad
 
scÜeNewTh»ad
;

66 
DowÆßdURLTh»ad
 
dowÆßdNewTh»ad
;

68 
ËáURLTh»shŞd
 = 0;

69 
max_scÜe_u¾_»Œy
 = 
cÚf
.
	`g‘IÁ
("max_score_url_retry", 10);

70 
dowÆßd_»Œy_times
 = 
cÚf
.
	`g‘IÁ
("download_retry_times", 3);

72 @
Ov”ride


73 
	$checkFŞd”Exi¡s
() {

75 
HDFSUt
.
	`mkdœs
(
fs
, 
ROOT_DIR
 + "/" + 
SCORE_OUTPUT_DIR
);

76 
HDFSUt
.
	`mkdœs
(
fs
, 
ROOT_DIR
 + "/" + 
SELECT_URL_OUTPUT_DIR
);

77 
HDFSUt
.
	`mkdœs
(
fs
, 
ROOT_DIR
 + "/" + 
SORT_URL_OUTPUT_DIR
);

78 
HDFSUt
.
	`mkdœs
(
fs
, 
ROOT_DIR
 + "/" + 
CLAWER_OUTPUT_DIR
);

79 
HDFSUt
.
	`mkdœs
(
fs
, 
ROOT_DIR
 + "/" + 
PIPES_BIN_DIR
);

80 
	}
}

82 
	gHashM­
<
	gSŒšg
, 
	gJobInfo
> 
	gjobInfoM­
;

84 
public
 
	$sÿnSÜtURLFŞd”
() {

85 
A¼ayLi¡
<
FeInfo
> 
i¡
 = 
Ãw
 ArrayList<FileInfo>();

86 
HDFSUt
.
	`li¡Fe
(
fs
, 
ROOT_DIR
 + "/" + 
SORT_URL_OUTPUT_DIR
, 
i¡
, 
Œue
);

87 
FeInfo
 
fešfo
 : 
i¡
) {

88 
SŒšg
 
·th
 = 
fešfo
.
	`g‘P©h
();

89 
SŒšg
 
Çme
 = 
·th
.
	`sub¡ršg
Õ©h.
	`Ï¡IndexOf
("/") + 1);

90 ià(!
fešfo
.
	`isDœ
(è&& 
·th
.
	`m©ches
(".*Şd_\\d{14}.*")&&
Çme
.matches("\\d{14}")

91 && !
this
.
ŞdURLS“dQueue
.
	`cÚšs
(
·th
)) {

92 
this
.
ŞdURLS“dQueue
.
	`add
(
·th
);

93 
logg”
.
	`šfo
("addƒxisted score urlo old url queue,path="

94 + 
·th
 + "\tqueusize=" + 
this
.
ŞdURLS“dQueue
.
	`size
());

95 } ià(!
fešfo
.
	`isDœ
(è&& 
·th
.
	`m©ches
(".*Ãw_\\d{14}.*")&&
Çme
.matches("\\d{14}")

96 && !
this
.
ÃwURLS“dQueue
.
	`cÚšs
(
·th
)) {

97 
this
.
ÃwURLS“dQueue
.
	`add
(
·th
);

98 
logg”
.
	`šfo
("addƒxisted score urlo‚ew url queue,path="

99 + 
·th
 + "\tqueusize=" + 
this
.
ÃwURLS“dQueue
.
	`size
());

102  
this
.
ŞdURLS“dQueue
.
	`size
(è+his.
ÃwURLS“dQueue
.size();

104 
	}
}

112 
´iv©e
 
synchrÚized
 
	$g‘Cu¼’tTime
() {

113 
t
 = 
Sy¡em
.
	`cu¼’tTimeMlis
();

114 
Œy
 {

115 
Th»ad
.
	`¦“p
(1000 * 2);

116 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

118 
e
.
	`´štSckT¿û
();

120  
t
;

121 
	}
}

123 şas 
	cScÜeURLTh»ad
 
im¶em’ts
 
	gRuÂabË
 {

124 
boŞ—n
 
	gisNew
 = 
çl£
;

125 
JobInfo
 
	gscÜeJob
;

126 
JobInfo
 
	g£ËùURLJob
;

127 
JobInfo
 
	gsÜtURLJobšfo
;

128 
	gLškedBlockšgQueue
<
	gSŒšg
> 
	gu¾S“dQueue
;

130 
public
 
ScÜeURLTh»ad
(
boŞ—n
 
ÃwURL
) {

131 
	gthis
.
	gisNew
 = 
ÃwURL
;

132 ià(!
	gisNew
) {

133 
	gscÜeJob
 = 
jobInfoM­
.
g‘
("score_url");

134 
	g£ËùURLJob
 = 
jobInfoM­
.
g‘
("select_url");

135 
	gthis
.
	gu¾S“dQueue
 = 
ŞdURLS“dQueue
;

136 
	gsÜtURLJobšfo
 = 
jobInfoM­
.
g‘
("sort_url_by_docid");

138 
	gscÜeJob
 = 
jobInfoM­
.
g‘
("score_new_url");

139 
	g£ËùURLJob
 = 
jobInfoM­
.
g‘
("select_new_url");

140 
	gsÜtURLJobšfo
 = 
jobInfoM­
.
g‘
("sort_new_url_by_docid");

141 
	gthis
.
	gu¾S“dQueue
 = 
ÃwURLS“dQueue
;

147 @
Ov”ride


148 
public
 
run
() {

150 
	g”rÜCouÁ
 = 0;

151 
	gruÂšg
) {

152 
synchrÚized
 (
this
) {

153 
	gruÂšg
 && 
	gu¾S“dQueue
.
size
(è> 
	gËáURLTh»shŞd
) {

154 
	gŒy
 {

155 
	gthis
.
wa™
(10 * 1000);

156 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

158 
	ge
.
´štSckT¿û
();

162 ià(!
sumb™ScÜeJob
()) {

163 
	glogg”
.
šfo
("score url job failed");

164 
	gŒy
 {

165 
	gTh»ad
.
¦“p
(1000 * 30);

166 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

168 
	ge
.
´štSckT¿û
();

170 
	g”rÜCouÁ
++;

172 
	g”rÜCouÁ
 = 0;

174 ià(
	g”rÜCouÁ
 > 
	gmax_scÜe_u¾_»Œy
) {

175 
	glogg”
.
”rÜ
("score url failedƒxcced max failedimes"

176 + 
max_scÜe_u¾_»Œy
);

177 
	gSy¡em
.
ex™
(0);

183 
public
 
boŞ—n
 
sumb™ScÜeJob
() {

184 
boŞ—n
 
	gæag
 = 
çl£
;

186 
D©e
 
	gd
 = 
Ãw
 Date();

187 
SŒšg
 
	gtime
 = 
DATE_FORMAT
.
fÜm©
(
d
);

188 
SŒšg
 
	gscÜe_ouut
 = 
ROOT_DIR
 + "/" + 
SCORE_OUTPUT_DIR
;

189 
SŒšg
 
	g£ËùOuut
 = 
ROOT_DIR
 + "/" + 
SELECT_URL_OUTPUT_DIR
 + "/";

191 
SŒšg
 
	gsÜtURLOuut
 = 
ROOT_DIR
 + "/" + 
SORT_URL_OUTPUT_DIR
 + "/";

192 ià(
	gthis
.
	gisNew
) {

193 
	gsÜtURLOuut
 +ğ"Ãw_" + 
time
;

194 
	gscÜe_ouut
 += "_new";

195 
	g£ËùOuut
 +ğ"Ãw_" + 
time
;

197 
	gsÜtURLOuut
 +ğ"Şd_" + 
time
;

198 
	g£ËùOuut
 +ğ"Şd_" + 
time
;

200 
SŒšg
 
	gbšdœ
 = 
ROOT_DIR
 + "/" + 
PIPES_BIN_DIR
;

202 
SŒšg
 
	gpwd_home
 = 
´İ”t›sM­
.
g‘
("$PWD_HOME");

204 
	gHDFSUt
.
rmdœs
(
fs
, 
bšdœ
 + "/score_url");

205 
	gHDFSUt
.
rmdœs
(
fs
, 
scÜe_ouut
);

206 
	gHDFSUt
.
u¶ßd
(
fs
, 
pwd_home
 + "/spider_c++_common/bin/score_url",

207 
bšdœ
);

208 
	gscÜeJob
.
g‘P¬amM­
().
put
("$scÜe_u¾_bš", 
bšdœ
 + "/score_url");

209 
	gscÜeJob
.
g‘P¬amM­
().
put
("$scÜe_ouut", 
scÜe_ouut
);

210 
	gŒy
 {

211 
SŒšg
 
	gcommªd
 = 
scÜeJob
.
g’”©eCommªd
();

212 
	glogg”
.
šfo
("subm™ scÜjob comªd =" + 
commªd
);

213 
RuÂšgJob
 
	gjob
 = (RuÂšgJobè(
JobC»©eFaùÜy


214 .
ü—‹JobObjeù
(
scÜeJob
));

215 
	gjob
.
wa™FÜCom¶‘iÚ
();

216 
	glogg”
.
šfo
("scÜjobƒxecu‹ fšished" + 
commªd
 + " "

217 + 
job
.
isSucûssful
());

218 ià(
	gjob
.
isSucûssful
()) {

219 
	g»duûRecÜds
 = 
CouÁ”H–³r
.
g‘CouÁ”V®ue
(
job
,

220 
Task
.
CouÁ”
.
REDUCE_OUTPUT_RECORDS
);

221 
	glogg”
.
šfo
("socre job succesful„educe„ecords"

222 + 
»duûRecÜds
);

223 ià(
	g»duûRecÜds
 > 0) {

224 
	g£ËùURLJob
.
g‘P¬amM­
().
put
("$reduce_records",

225 
SŒšg
.
v®ueOf
(
»duûRecÜds
));

226 
	g£ËùURLJob
.
g‘P¬amM­
().
put
("$sort_select_output",

227 
£ËùOuut
);

228 
	g£ËùURLJob
.
g‘P¬amM­
().
put
("$score_output",

229 
scÜe_ouut
);

231 
Job
 
	g£Ëùjob
 = (Jobè(
JobC»©eFaùÜy


232 .
ü—‹JobObjeù
(
£ËùURLJob
));

233 
	glogg”
.
šfo
("select url job start"

234 + 
£ËùURLJob
.
g’”©eCommªd
());

235 
	g£Ëùjob
.
wa™FÜCom¶‘iÚ
(
Œue
);

236 
	glogg”
.
šfo
("select url job finished"

237 + 
£ËùURLJob
.
g’”©eCommªd
() + "\t"

238 + 
£Ëùjob
.
isSucûssful
());

239 ià(
	g£Ëùjob
.
isSucûssful
()) {

241 
	gsÜtURLJobšfo
.
g‘P¬amM­
().
put
("$select_output",

242 
£ËùOuut
);

243 
	gsÜtURLJobšfo
.
g‘P¬amM­
().
put
(

244 "$sÜt_u¾_ouut", 
sÜtURLOuut
);

246 
Job
 
	gsÜtURLJob
 = (Jobè(
JobC»©eFaùÜy


247 .
ü—‹JobObjeù
(
sÜtURLJobšfo
));

249 
	glogg”
.
šfo
("sort url job start "

250 + 
sÜtURLJobšfo
.
g’”©eCommªd
());

251 
	gsÜtURLJob
.
wa™FÜCom¶‘iÚ
(
Œue
);

252 
	glogg”
.
šfo
("sort url jobƒnd");

254 ià(
	gsÜtURLJob
.
isSucûssful
()) {

256 
	gLi¡
<
	gFeInfo
> 
	gæi¡
 = 
Ãw
 
LškedLi¡
<
FeInfo
>();

257 
	gHDFSUt
.
li¡Fe
(
fs
, 
sÜtURLOuut
, 
æi¡
,

258 
çl£
);

259 ià(
	gæi¡
.
size
() == 0) {

260 
logg”
.
”rÜ
("score output size="

261 + 
æi¡
.
size
());

263 
	gsucûed
 = 0;

264 
	gi
 = 0; i < 
	gæi¡
.
size
(); i++) {

265 
	gtime¡amp
 = 
g‘Cu¼’tTime
();

266 
D©e
 
	gmtime
 = 
Ãw
 D©e(
time¡amp
);

267 
FeInfo
 
	gfeInfo
 = 
æi¡
.
g‘
(
i
);

268 ià(
	gfeInfo
.
isDœ
()

269 || 
	gfeInfo
.
g‘FeL’
() == 0)

272 
SŒšg
 
	gfeName
 = 
feInfo
.
g‘P©h
();

273 
	gÏ¡Index
 = 
feName


274 .
Ï¡IndexOf
("/");

275 
SŒšg
 
	gfŞd”
 = 
feName
.
sub¡ršg
(0,

276 
Ï¡Index
 + 1);

277 
SŒšg
 
	gÃwName
 = 
fŞd”


278 + 
DATE_FORMAT
.
fÜm©
(
mtime
);

279 ià(!
	gHDFSUt
.
»ÇmeFe
(
fs
, 
feName
,

280 
ÃwName
)) {

281 
	glogg”
.
”rÜ
("rename score file failed "

282 + 
feName


284 + 
ÃwName
);

287 
	gŒy
 {

288 
	gu¾S“dQueue
.
put
(
ÃwName
);

289 
	gsucûed
++;

290 
	glogg”
.
šfo
("add select url fileo queue succeed‚ame="

291 + 
ÃwName
);

292 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

295 
	ge
.
´štSckT¿û
();

300 ià(
	gsucûed
 > 0)

301 
	gæag
 = 
Œue
;

305 
SŒšg
 
	gÃwS–ùOuput
 = 
£ËùOuut


306 .
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

307 ià(!
	gHDFSUt
.
»ÇmeFe
(
fs
, 
£ËùOuut
,

308 
ÃwS–ùOuput
)) {

309 
	glogg”
.
”rÜ
("rename select url outptu failed,src ="

310 + 
£ËùOuut


312 + 
ÃwS–ùOuput
);

318 
	glogg”
.
”rÜ
("£Ëù u¾ faed " + 
commªd
);

321 
	glogg”
.
”rÜ
("score job failed„educe„ecordsƒquals 0 command="

322 + 
commªd
);

326 
	glogg”
.
”rÜ
("scÜjob faed +commªd=" + 
commªd
);

329 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

331 
	ge
.
´štSckT¿û
();

332  
	gçl£
;

333 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

335 
	ge
.
´štSckT¿û
();

336 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

338 
	ge
.
´štSckT¿û
();

339 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

341 
	ge
.
´štSckT¿û
();

342 } 
ÿtch
 (
Exû±iÚ
 
e
) {

343 
	ge
.
´štSckT¿û
();

344 } 
	gfš®ly
 {

349  
	gæag
;

354 şas 
	cDowÆßdURLTh»ad
 
im¶em’ts
 
	gRuÂabË
 {

355 
public
 
boŞ—n
 
	gisNew
;

356 
	gLškedBlockšgQueue
<
	gSŒšg
> 
	gu¾S“dQueue
;

358 
public
 
DowÆßdURLTh»ad
(
boŞ—n
 
isNew
) {

359 
	gthis
.
	gisNew
 = 
isNew
;

360 ià(
	gthis
.
	gisNew
) {

361 
	gthis
.
	gu¾S“dQueue
 = 
ÃwURLS“dQueue
;

363 
	gthis
.
	gu¾S“dQueue
 = 
ŞdURLS“dQueue
;

367 @
Ov”ride


368 
public
 
run
() {

370 
	gruÂšg
) {

371 
synchrÚized
 (
this
) {

372 
	gruÂšg
 && 
	gu¾S“dQueue
.
size
() == 0) {

373 
Œy
 {

374 
this
.
wa™
(10 * 1000);

375 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

377 
	ge
.
´štSckT¿û
();

382 
SŒšg
 
	gfeName
 = 
u¾S“dQueue
.
pŞl
();

383 ià(
	gfeName
 =ğ
nuÎ
) {

384 
logg”
.
”rÜ
("error seed url file‚ame"

385 + 
u¾S“dQueue
.
size
());

388 
	gçed
 = 0;

390 
boŞ—n
 
	gt
 = 
subm™DowÆßdJob
(
feName
);

391 ià(
	gt
)

394 
	gçed
++;

395 } 
	gçed
 < 
	gdowÆßd_»Œy_times
);

396 ià(
	gçed
 =ğ
dowÆßd_»Œy_times
) {

397 
logg”
.
”rÜ
("çed dowÀ" + 
feName


399 
	gSy¡em
.
ex™
(0);

403 
SŒšg
 
	gbakFeName
 = 
feName
.
»¶aûFœ¡
(
ROOT_DIR
,

404 
ROOT_DIR_BAK
);

405 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
feName
, 
bakFeName
);

409 
public
 
boŞ—n
 
subm™DowÆßdJob
(
SŒšg
 
feName
) {

410 
boŞ—n
 
	gæag
 = 
çl£
;

411 
JobInfo
 
	gjobInfo
 = 
jobInfoM­
.
g‘
("claw_url");

412 
SŒšg
 
	glÚgtime
 = 
feName
.
sub¡ršg
(feName.
Ï¡IndexOf
("/") + 1);

414 
SŒšg
 
	gbšdœ
 = 
ROOT_DIR
 + "/" + 
PIPES_BIN_DIR
;

416 
SŒšg
 
	gpwd_home
 = 
´İ”t›sM­
.
g‘
("$PWD_HOME");

418 
	gHDFSUt
.
rmdœs
(
fs
, 
bšdœ
 + "/clawer_url");

419 
	gHDFSUt
.
u¶ßd
(
fs
, 
pwd_home
 + "/spider_c++_common/bin/clawer_url",

420 
bšdœ
);

422 
SŒšg
 
	gouut
 = 
ROOT_DIR
 + "/" + 
CLAWER_OUTPUT_DIR
 + "/" + 
lÚgtime
;

423 
	gjobInfo
.
g‘P¬amM­
().
put
("$ouut_fŞd”", 
ouut
 + "_bak");

424 
	gjobInfo
.
g‘P¬amM­
().
put
("$šputFe", 
feName
);

425 
	gjobInfo
.
g‘P¬amM­
().
put
("$Çme", "şaw”_u¾_" + 
lÚgtime
);

426 
	gjobInfo
.
g‘P¬amM­
()

427 .
put
("$şaw”_u¾_bš", 
bšdœ
 + "/clawer_url");

429 
RuÂšgJob
 
	gjob
 = (RuÂšgJobè
JobC»©eFaùÜy


430 .
ü—‹JobObjeù
(
jobInfo
);

431 
	gŒy
 {

432 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
ouut
 + "_bak"))) {

433 
	gHDFSUt
.
rmdœs
(
fs
, 
ouut
 + "_bak");

435 
	glogg”
.
šfo
("claw job start command="

436 + 
jobInfo
.
g’”©eCommªd
());

437 
	gjob
.
wa™FÜCom¶‘iÚ
();

438 
	glogg”
.
šfo
("şaw job fšished " + 
job
.
isSucûssful
());

439 ià(
	gjob
.
isSucûssful
()) {

440 
	gæag
 = 
Œue
;

442 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
ouut
 + "_bak", output);

445 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

447 
	ge
.
´štSckT¿û
();

448 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

450 
	ge
.
´štSckT¿û
();

451 } 
ÿtch
 (
Exû±iÚ
 
e
) {

452 
	ge
.
´štSckT¿û
();

453 } 
	gfš®ly
 {

457  
	gæag
;

462 @
Ov”ride


463 
public
 
	$runJob
() {

465 
Th»ad
 
scÜe
 = 
Ãw
 
	`Th»ad
(
this
.
scÜeTh»ad
);

466 
Th»ad
 
dowÆßd
 = 
Ãw
 
	`Th»ad
(
this
.
dowÆßdTh»ad
);

467 
Th»ad
 
scÜeNew
 = 
Ãw
 
	`Th»ad
(
this
.
scÜeNewTh»ad
);

468 
Th»ad
 
dowÆßdNew
 = 
Ãw
 
	`Th»ad
(
this
.
dowÆßdNewTh»ad
);

469 
scÜe
.
	`¡¬t
();

470 
dowÆßd
.
	`¡¬t
();

471 
scÜeNew
.
	`¡¬t
();

472 
dowÆßdNew
.
	`¡¬t
();

473 (
this
.
ruÂšg
)) {

474 
Œy
 {

475 
Th»ad
.
	`¦“p
(30 * 1000);

476 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

478 
e
.
	`´štSckT¿û
();

482 
	}
}

484 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

485 
Œy
 {

486 
Prİ”t›s
 
p
 = 
Ãw
 
	`Prİ”t›s
();

487 
p
.
	`lßd
(
S–eùAndS’dJob
.
şass


488 .
	`g‘ResourûAsSŒ—m
("/log4j.properties"));

489 
Prİ”tyCÚfigu¿tÜ
.
	`cÚfigu»
(
p
);

490 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e1
) {

492 
e1
.
	`´štSckT¿û
();

493 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

495 
e
.
	`´štSckT¿û
();

497 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

498 
Œy
 {

499 
ScÜeAndCÏw”Job
 
scÜeJob
 = 
Ãw
 
	`ScÜeAndCÏw”Job
(
cÚf
);

500 
scÜeJob
.
	`runJob
();

502 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

504 
e
.
	`´štSckT¿û
();

506 
	}
}

	@com/zhongsou/spider/hadoop/jobcontrol/SelectAndSendJob.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gM®fÜmedURLExû±iÚ
;

5 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

6 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

7 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

8 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

9 
impÜt
 
	gjava
.
	gut
.
	gM­
;

10 
impÜt
 
	gjava
.
	gut
.
	gPrİ”t›s
;

11 
impÜt
 
	gjava
.
	gut
.
	gT»eM­
;

12 
impÜt
 
	gjava
.
	gut
.
	gcÚcu¼’t
.
	gPriÜ™yBlockšgQueue
;

13 
impÜt
 
	gjava
.
	gut
.
	gcÚcu¼’t
.
	g©omic
.
	gAtomicBoŞ—n
;

14 
impÜt
 
	gjava
.
	gut
.
	gcÚcu¼’t
.
	glocks
.
	gR“Á¿ÁR—dWr™eLock
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFSD©aOuutSŒ—m
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeStus
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gLßdInüem’lHFes
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gPrİ”tyCÚfigu¿tÜ
;

29 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

31 
impÜt
 
	gcom
.
	gzhÚgsou
.
	gšşßd
.
	gS·mPageG’”©e
;

32 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gJobInfo
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gP¬£dFšg”Info
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gexû±iÚ
.
	gEm±yP¬amV®ueExû±iÚ
;

35 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gFeInfo
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gHDFSUt
;

57 
public
 cÏs 
	cS–eùAndS’dJob
 
ex‹nds
 
	mSpid”Job
 {

58 
	mPriÜ™yBlockšgQueue
<
	mP¬£dFšg”Info
> 
	mfšishedP¬£dQueue
 =

59 
Ãw
 
PriÜ™yBlockšgQueue
<
P¬£dFšg”Info
>();

60 
	mPriÜ™yBlockšgQueue
<
	mP¬£dFšg”Info
> 
	mfšishedG’”©eQueue
 =

61 
Ãw
 
PriÜ™yBlockšgQueue
<
P¬£dFšg”Info
>();

62 
public
 
Logg”
 
	mlogg”
 = Logg”.
g‘Logg”
(
S–eùAndS’dJob
.
şass
);

63 
fš®
 
SŒšg
 
	mURL_AND_FINGER_OUTPUT
 = 
ROOT_DIR
 + "/"

64 + 
URL_AND_FINGER_DIR
;

65 
fš®
 
SŒšg
 
	mPARSED_CONVERT_OUTPUT
 = 
ROOT_DIR
 + "/"

66 + 
PARSE_CONVERT_DIR
;

67 
´iv©e
 
	mLi¡
<
	mFeInfo
> 
	mfeLi¡
 = 
Ãw
 
LškedLi¡
<
FeInfo
>();

68 
	msÿnFŞd”IÁ”v®
 = 
cÚf
.
g‘IÁ
("scan_interval", 1000 * 10);

69 
HTabË
 
	mwebDBTabË
;

70 
boŞ—n
 
	md–‘eHFe
;

71 
	mlßdFaedSË•Time
 = 
cÚf
.
g‘IÁ
("loadFailedSleep", 1000 * 60);

72 
	m»ŒyTimes
 = 
cÚf
.
g‘IÁ
("failedRetryTimes", 30);

73 
	mHashM­
<
	mSŒšg
, 
	mJobInfo
> 
	mjobInfoM­
;

74 
G’”©eS’dLi¡
 
	mg’”©eLßdli¡
;

75 
S’dCÚ‹Á
 
	m£ndCÚ‹Á
;

76 
´iv©e
 
R“Á¿ÁR—dWr™eLock
 
	mlock
 = 
Ãw
 ReentrantReadWriteLock();

77 
	mT»eM­
<
	mImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË> 
	mÃwLßdM­


78 ğ
Ãw
 
T»eM­
<
ImmubËBy‹sWr™abË
, 
	mImmubËBy‹sWr™abË
>(

79 
Ãw
 
	mImmubËBy‹sWr™abË
.
Com·¿tÜ
());

81 
AtomicBoŞ—n
 
	mfšishG‘D©aFromHba£
 = 
Ãw
 AtomicBoŞ—n(
Œue
);

83 
public
 
	$S–eùAndS’dJob
(
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

84 
	`su³r
(
cÚf
);

86 
webDBTabË
 = 
Ãw
 
	`HTabË
(
cÚf
, "webDB");

87 
this
.
d–‘eHFe
 = 
cÚf
.
	`g‘BoŞ—n
("d–‘e_hfe", 
çl£
);

88 
this
.
jobInfoM­
 = 
jobM­
.
	`g‘
Ñhis.
	`g‘CÏss
().
	`g‘Name
());

89 
g’”©eLßdli¡
 = 
Ãw
 
	`G’”©eS’dLi¡
();

90 
£ndCÚ‹Á
 = 
Ãw
 
	`S’dCÚ‹Á
();

91 
this
.
ruÂšg
 = 
Œue
;

93 
this
.
	`sÿnU¾AndFšg”FŞd”
();

94 
P¬£dFšg”Info
 
šfo
 : 
this
.
fšishedG’”©eQueue
) {

95 ià(
this
.
fšishedP¬£dQueue
.
	`cÚšs
(
šfo
)) {

96 
this
.
fšishedP¬£dQueue
.
	`»move
(
šfo
);

99 
logg”
.
	`šfo
("initialize finished! sendQueue size "

100 + 
this
.
fšishedG’”©eQueue
.
	`size
() + "\t dup queue "

101 + 
this
.
fšishedP¬£dQueue
.
	`size
());

104 @
Ov”ride


105 
public
 
	$runJob
() {

106 
Th»ad
 
£ËùTh»ad
 = 
Ãw
 
	`Th»ad
(
this
.
g’”©eLßdli¡
);

107 
£ËùTh»ad
.
	`¡¬t
();

108 
Th»ad
 
£ndTh»ad
 = 
Ãw
 
	`Th»ad
(
this
.
£ndCÚ‹Á
);

109 
£ndTh»ad
.
	`¡¬t
();

110 
Œue
) {

111 
Œy
 {

112 
Th»ad
.
	`¦“p
(1000 * 10);

113 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

114 
e
.
	`´štSckT¿û
();

117 
	}
}

119 
public
 
	$sÿnU¾AndFšg”FŞd”
() {

120 
lock
.
	`»adLock
().
	`lock
();

121 
this
.
feLi¡
.
	`ş—r
();

122 
HDFSUt
.
	`li¡Fe
(
fs
, 
URL_AND_FINGER_OUTPUT
, 
feLi¡
, 
çl£
);

123 
FeInfo
 
fešfo
 : 
feLi¡
) {

124 
Œy
 {

125 
SŒšg
 
·th
 = 
fešfo
.
	`g‘P©h
();

126 
SŒšg
 
£qtime
 = 
·th
.
	`sub¡ršg
Õ©h.
	`Ï¡IndexOf
("/") + 1);

127 
SŒšg
 
hfeOuut
 = 
PARSED_CONVERT_OUTPUT
 + "/" + 
£qtime
;

129 
boŞ—n
 
exi¡
 = 
fs
.
	`exi¡s
(
Ãw
 
	`P©h
(
hfeOuut
));

130 ià(!
exi¡
) {

135 
logg”
.
	`w¬n
("u¾‡nd fšg” " + 
·th
 + " seqime "

136 + 
£qtime


138 + 
hfeOuut
);

141 ià(
£qtime
.
	`m©ches
("\\d{14}")) {

142 ià(
·th
.
	`m©ches
("(?i)hdfs://.*")) {

143 
·th
 =…©h.
	`sub¡ršg
Õ©h.
	`šdexOf
("/", 9));

145 ià(
exi¡
) {

146 ià(
hfeOuut
.
	`m©ches
("(?i)hdfs://")) {

147 
hfeOuut
 = hfeOuut.
	`sub¡ršg
(hfileOutput

148 .
	`šdexOf
("/", 9));

151 
hfeOuut
 = 
nuÎ
;

153 
P¬£dFšg”Info
 
šfo
 = 
Ãw
 
	`P¬£dFšg”Info
();

154 
šfo
.
	`£tHfeOuutP©h
(
hfeOuut
);

155 
šfo
.
	`£tSeqTime
(
£qtime
);

156 
šfo
.
	`£tU¾AndFšg”P©h
(
·th
);

157 ià(!
this
.
fšishedG’”©eQueue
.
	`cÚšs
(
šfo
)) {

158 
this
.
fšishedP¬£dQueue
.
	`add
(
šfo
);

159 
logg”
.
	`šfo
("add‡ download finished foldero upload hfile flag queue,path="

160 + 
šfo


162 + 
this
.
fšishedP¬£dQueue
.
	`size
());

166 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

168 
e
.
	`´štSckT¿û
();

171 
lock
.
	`»adLock
().
	`uÆock
();

172  
this
.
fšishedP¬£dQueue
.
	`size
();

173 
	}
}

175 
public
 
	$sÿnLßdFÏgFŞd”
() {

177 
A¼ayLi¡
<
FeInfo
> 
i¡
 = 
Ãw
 ArrayList<FileInfo>();

179 
HDFSUt
.
	`li¡Fe
(
fs
, 
ROOT_DIR
 + "/" + 
LOAD_FLAG_HFILE_OUTPUT_DIR
,

180 
i¡
, 
çl£
);

182 
FeInfo
 
fešfo
 : 
i¡
) {

183 
Œy
 {

184 
SŒšg
 
·th
 = 
fešfo
.
	`g‘P©h
();

185 
SŒšg
 
£qtime
 = 
·th
.
	`sub¡ršg
Õ©h.
	`Ï¡IndexOf
("/") + 1);

186 
SŒšg
 
hfeOuut
 = 
PARSED_CONVERT_OUTPUT
 + "/" + 
£qtime
;

188 
boŞ—n
 
exi¡
 = 
fs
.
	`exi¡s
(
Ãw
 
	`P©h
(
hfeOuut
));

189 ià(!
exi¡
) {

194 
logg”
.
	`w¬n
("u¾‡nd fšg” " + 
·th
 + " seqime "

195 + 
£qtime


197 + 
hfeOuut
);

200 ià(
£qtime
.
	`m©ches
("\\d{14}")) {

201 ià(
·th
.
	`m©ches
("(?i)hdfs://.*")) {

202 
·th
 =…©h.
	`sub¡ršg
Õ©h.
	`šdexOf
("/", 9));

204 ià(
exi¡
) {

205 ià(
hfeOuut
.
	`m©ches
("(?i)hdfs://")) {

206 
hfeOuut
 = hfeOuut.
	`sub¡ršg
(hfileOutput

207 .
	`šdexOf
("/", 9));

210 
hfeOuut
 = 
nuÎ
;

212 
P¬£dFšg”Info
 
šfo
 = 
Ãw
 
	`P¬£dFšg”Info
();

213 
šfo
.
	`£tHfeOuutP©h
(
hfeOuut
);

214 
šfo
.
	`£tSeqTime
(
£qtime
);

215 
šfo
.
	`£tU¾AndFšg”P©h
(
URL_AND_FINGER_OUTPUT
 + "/"

216 + 
£qtime
);

217 
šfo
.
	`£tLßdFeP©h
(
Spid”Job
.
ROOT_DIR
 + "/"

218 + 
LOAD_DOCID_DIR
 + "/" + 
£qtime
);

219 
šfo
.
	`£tNewURLAndFšg”Fe
(
Spid”Job
.
ROOT_DIR
 + "/"

220 + 
NEW_URL_AND_FINGER_DIR
 + "/" + 
£qtime
);

221 
this
.
fšishedG’”©eQueue
.
	`add
(
šfo
);

223 
logg”
.
	`šfo
("add‡ duplicate succeed…atho send queue,path="

224 + 
šfo


226 + 
this
.
fšishedG’”©eQueue
.
	`size
());

229 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

231 
e
.
	`´štSckT¿û
();

235  
this
.
fšishedG’”©eQueue
.
	`size
();

237 
	}
}

239 @
Ov”ride


240 
	$checkFŞd”Exi¡s
() {

243 
	}
}

245 şas 
	cG’”©eS’dLi¡
 
im¶em’ts
 
	gRuÂabË
 {

247 @
Ov”ride


248 
public
 
run
() {

249 
	gruÂšg
) {

251 
	gfšishedP¬£dQueue
.
size
() == 0) {

252 
m
 = 
sÿnU¾AndFšg”FŞd”
();

253 ià(
	gm
 > 0)

256 
	gŒy
 {

257 
	gTh»ad
.
¦“p
(
sÿnFŞd”IÁ”v®
);

258 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

259 
	ge
.
´štSckT¿û
();

264 
P¬£dFšg”Info
 
	gšfo
 = 
fšishedP¬£dQueue
.
pŞl
();

265 ià(
	gšfo
 =ğ
nuÎ
) {

266 
logg”
.
”rÜ
("pop‡ƒmpty url‡nd finger ");

271 
	gfšishG‘D©aFromHba£
.
g‘
(è=ğ
çl£
) {

272 
Œy
 {

273 
Th»ad
.
¦“p
(1000 * 1);

274 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

275 
	ge
.
´štSckT¿û
();

280 
boŞ—n
 
	gu¶ßd
 = 
çl£
;

281 
	gçed
 = 0;

282 ià(
	gšfo
.
g‘HfeOuutP©h
(è!ğ
nuÎ
) {

284 
u¶ßd
 = 
this
.
u¶ßdCÚ‹ÁHfe
(
šfo
);

285 ià(
	gu¶ßd
)

288 
	gçed
++;

289 
	glogg”
.
šfo
("load hfile " + info + "o hbase failed,try‡gain");

290 ià(
	gçed
 =ğ
»ŒyTimes
) {

291 
logg”
.
”rÜ
("wait‡†ongime failed†oad datao hbase,quit");

292 
	gSy¡em
.
ex™
(0);

294 
	gŒy
 {

295 
	gTh»ad
.
¦“p
(
lßdFaedSË•Time
);

296 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

298 
	ge
.
´štSckT¿û
();

301 } !
	gu¶ßd
);

305 
boŞ—n
 
	gg’”©eNewLßd
 = 
çl£
;

306 
	gçed
 = 0;

308 
	gg’”©eNewLßd
 = 
this
.
g’”©eSameFšg”D–‘eLi¡
(
šfo
);

309 ià(
	gg’”©eNewLßd
)

312 
	gçed
++;

313 
	glogg”
.
šfo
("generate‚ew†oad file " + info + " file failed,,try‡gain");

314 ià(
	gçed
 =ğ
»ŒyTimes
) {

315 
logg”
.
”rÜ
("wait‡†ongime failed generate spam…age file,quit");

316 
	gSy¡em
.
ex™
(0);

318 
	gŒy
 {

319 
	gTh»ad
.
¦“p
(
lßdFaedSË•Time
);

320 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

321 
	ge
.
´štSckT¿û
();

325 } !
	gg’”©eNewLßd
);

328 
JobInfo
 
	gg’”©eInfo
 = 
jobInfoM­
.
g‘
("generate_dup_pair");

329 
boŞ—n
 
	gg’”©e_dup_·œ
 = 
çl£
;

330 
	gçed
 = 0;

332 
	gg’”©e_dup_·œ
 = 
this
.
g’”©eS–eùPaœ
(
g’”©eInfo
,

333 
šfo
);

334 ià(
	gg’”©e_dup_·œ
)

337 
	gçed
++;

338 
	glogg”
.
šfo
("generate select…air " + info + " file failed,ry‡gain");

339 ià(
	gçed
 =ğ
»ŒyTimes
) {

340 
logg”
.
”rÜ
("wait‡†ongime failed generate duplicate…air file,quit");

341 
	gSy¡em
.
ex™
(0);

343 
	gŒy
 {

344 
	gTh»ad
.
¦“p
(
lßdFaedSË•Time
);

345 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

347 
	ge
.
´štSckT¿û
();

351 } !
	gg’”©e_dup_·œ
);

353 
JobInfo
 
	g£ËùInfo
 = 
jobInfoM­
.
g‘
("select_dup_pair");

354 
boŞ—n
 
	g£Ëù_·œ
 = 
çl£
;

357 
	gçed
 = 0;

359 
	g£Ëù_·œ
 = 
this
.
£ËùeDocidPaœ
(
£ËùInfo
,

360 
šfo
.
g‘SeqTime
());

361 ià(
	g£Ëù_·œ
)

364 
	gçed
++;

365 
	glogg”
.
šfo
(" select…air " + info + " file failed,ry‡gain");

366 ià(
	gçed
 =ğ
»ŒyTimes
) {

367 
logg”
.
”rÜ
("wait‡†ongime failed for select…air ,quit");

368 
	gSy¡em
.
ex™
(0);

370 
	gŒy
 {

371 
	gTh»ad
.
¦“p
(
lßdFaedSË•Time
);

372 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

374 
	ge
.
´štSckT¿û
();

378 } !
	g£Ëù_·œ
);

381 
boŞ—n
 
	gg’”©eLßd
 = 
g’”©eLßdLi¡Fe
(
šfo
);

382 
	gçed
 = 0;

383 !
	gg’”©eLßd
) {

384 
	glogg”
.
šfo
("generate†oad file failed");

385 
	gg’”©eLßd
 = 
g’”©eLßdLi¡Fe
(
šfo
);

386 
	gçed
++;

387 ià(
	gçed
 =ğ
»ŒyTimes
) {

388 
logg”
.
”rÜ
("wait‡†ongime failed generate‚ew†oad file,quit");

389 
	gSy¡em
.
ex™
(0);

394 
JobInfo
 
	glßdInfo
 = 
jobInfoM­
.
g‘
("generate_load_flag_hfile");

395 
boŞ—n
 
	gg’”©e_lßd_fe
 = 
çl£
;

396 
	gçed
 = 0;

398 
	gg’”©e_lßd_fe
 = 
g’”©eLßdFÏgFe
(
lßdInfo
, 
šfo
.
g‘SeqTime
());

399 ià(
	gg’”©e_lßd_fe
) {

402 
	gçed
++;

403 
	glogg”
.
šfo
("generate†oad hfile " + info + " file failed,,try‡gain");

404 ià(
	gçed
 =ğ
»ŒyTimes
) {

405 
logg”
.
”rÜ
("wait‡†ongime failed generate†oad flag hfile,quit");

406 
	gSy¡em
.
ex™
(0);

408 
	gŒy
 {

409 
	gTh»ad
.
¦“p
(
lßdFaedSË•Time
);

410 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

411 
	ge
.
´štSckT¿û
();

415 } !
	gg’”©e_lßd_fe
);

418 
	gfšishedG’”©eQueue
.
size
() >= 1) {

419 
Œy
 {

420 
Th»ad
.
¦“p
(1000 * 10);

421 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

422 
	ge
.
´štSckT¿û
();

425 
	gfšishedG’”©eQueue
.
add
(
šfo
);

427 
	gfšishG‘D©aFromHba£
.
£t
(
çl£
);

432 
public
 
boŞ—n
 
u¶ßdCÚ‹ÁHfe
(
P¬£dFšg”Info
 
šfo
) {

433 
boŞ—n
 
	gæag
 = 
çl£
;

434 
	gŒy
 {

435 
	glogg”
.
šfo
("start†oad hfileo webDbable…ath=" +

436 
šfo
.
g‘HfeOuutP©h
());

437 
LßdInüem’lHFes
 
	glßd”
 = 
Ãw
 LßdInüem’lHFes(
cÚf
);

438 
	glßd”
.
doBulkLßd
(
Ãw
 
P©h
(
šfo
.
g‘HfeOuutP©h
()), 
webDBTabË
);

439 } 
ÿtch
 (
Exû±iÚ
 
e
) {

440 
	ge
.
´štSckT¿û
();

441 
	glogg”
.
”rÜ
("lßd hftØhba£ faed " + 
šfo
.
g‘HfeOuutP©h
());

442  
	gçl£
;

444 ià(
	gd–‘eHFe
) {

445 
	gHDFSUt
.
rmdœs
(
fs
, 
šfo
.
g‘HfeOuutP©h
());

446 
	glogg”
.
šfo
("lßd sucûd d–‘hfe" + info.
g‘HfeOuutP©h
());

448 
SŒšg
 
	gbak
 = 
šfo
.
g‘HfeOuutP©h
().
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

449 
boŞ—n
 
	g»s
 = 
HDFSUt
.
»ÇmeFe
(
fs
, 
šfo
.
g‘HfeOuutP©h
(), 
bak
);

450 
	glogg”
.
šfo
("load succed„ename hfile " +

451 
šfo
.
g‘HfeOuutP©h
(è+ "\ˆtØ" + 
bak
 + "„es=" + 
»s
);

453 
	gæag
 = 
Œue
;

454  
	gæag
;

457 
public
 
boŞ—n
 
g’”©eSameFšg”D–‘eLi¡
(
P¬£dFšg”Info
 
šfo
) {

458 
boŞ—n
 
	gæag
 = 
çl£
;

459 
S·mPageG’”©e
 
	gp
 = 
Ãw
 SpamPageGenerate(

460 
šfo
.
g‘U¾AndFšg”P©h
(), info.
g‘SeqTime
());

461 
	g»s
 = 
p
.
´oûss
(
cÚf
, 
fs
);

462 ià(
	g»s
 != -1) {

463 
SŒšg
 
ÃwLßdURLAndFšg”Fe
 = 
Spid”Job
.
ROOT_DIR
 + "/"

464 + 
Spid”Job
.
NEW_URL_AND_FINGER_DIR
 + "/"

465 + 
šfo
.
g‘SeqTime
();

466 
	gŒy
 {

467 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
ÃwLßdURLAndFšg”Fe
))) {

468 
	glogg”
.
šfo
("delete spam…age succeed,delete spam"

469 + 
»s
 + "‚ew†oad file "

470 + 
ÃwLßdURLAndFšg”Fe
);

471 
	gšfo
.
£tNewURLAndFšg”Fe
(
ÃwLßdURLAndFšg”Fe
);

472 
	gæag
 = 
Œue
;

474 
	glogg”
.
”rÜ
("Ãw†ßd f" + 
ÃwLßdURLAndFšg”Fe


475 + "„es=" + 
»s
);

477 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

479 
	ge
.
´štSckT¿û
();

482 
	glogg”
.
”rÜ
("delete spam…age failed");

483  
	gçl£
;

485  
	gæag
;

488 
public
 
boŞ—n
 
g’”©eS–eùPaœ
(
JobInfo
 
jobšfo
, 
P¬£dFšg”Info
 
šfo
) {

489 
boŞ—n
 
	gæag
 = 
çl£
;

490 
	gjobšfo
.
g‘P¬amM­
().
put
("$£qTime¡amp", 
šfo
.
g‘SeqTime
());

491 
	gjobšfo
.
g‘P¬amM­
().
put
("$urlid_finger_file",

492 
šfo
.
g‘NewURLAndFšg”Fe
());

493 
	gjobšfo
.
g‘P¬amM­
().
put
("$job_name",

494 "g’”©e_dup_·œ_" + 
šfo
.
g‘SeqTime
());

495 
SŒšg
 
	gouut
 = 
ROOT_DIR
 + "/" + 
GENERATE_DUP_PAIR_DIR
 + "/"

496 + 
šfo
.
g‘SeqTime
();

497 
SŒšg
 
	glßd_fšg”_did_nÙ_chªge
 = 
ROOT_DIR
 + "/"

498 + 
LOAD_DOCD_FINGER_NOT_CHANGE
 + "/" + 
šfo
.
g‘SeqTime
();

499 
	gjobšfo
.
g‘P¬amM­
().
put
("$·œ_ouut", 
ouut
);

500 
	gŒy
 {

501 
boŞ—n
 
	gexi¡
 = 
fs
.
exi¡s
(
Ãw
 
P©h
(
ouut
));

502 ià(
	gexi¡
) {

503 
	gHDFSUt
.
rmdœs
(
fs
, 
ouut
);

505 
SŒšg
 
	gcomªd
 = 
jobšfo
.
g’”©eCommªd
();

506 
	glogg”
.
šfo
("¡¬ˆg’”—‹ du°·œ ,commªd:" + 
comªd
);

507 
Job
 
	gjob
 = (Jobè(
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
jobšfo
));

508 
	gjob
.
wa™FÜCom¶‘iÚ
(
Œue
);

509 ià(
	gjob
.
isSucûssful
()) {

510 
	gæag
 = 
Œue
;

511 ià(
	gHDFSUt
.
m”geMuÉËSeqFe2OÃ
(
fs
, 
cÚf
, 
ouut


512 + "/uÆßdKey*", 
lßd_fšg”_did_nÙ_chªge
,

513 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class)) {

514 
	gHDFSUt
.
rmFes
(
fs
, 
ouut
 + "/unloadKey*");

516 
	glogg”
.
šfo
("merge unload key file failed");

517 
	gHDFSUt
.
rmFes
(
fs
, 
ouut
 + "/unloadKey*");

520 
	glogg”
.
”rÜ
("generate dup‡pir failed");

522 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

523 
	ge
.
´štSckT¿û
();

524 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

525 
	ge
.
´štSckT¿û
();

526 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

527 
	ge
.
´štSckT¿û
();

528 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

529 
	ge
.
´štSckT¿û
();

530 } 
ÿtch
 (
Exû±iÚ
 
e
) {

531 
	ge
.
´štSckT¿û
();

534  
	gæag
;

545 
´iv©e
 
boŞ—n
 
g’”©eLßdLi¡Fe
(
P¬£dFšg”Info
 
pšfo
) {

546 
SŒšg
 
	g£q
 = 
pšfo
.
g‘SeqTime
();

547 
boŞ—n
 
	gæag
 = 
çl£
;

548 
SŒšg
 
	gÃwURLLßdFšg”Fe
 = 
Spid”Job
.
ROOT_DIR
 + "/" +

549 
Spid”Job
.
NEW_URL_AND_FINGER_DIR
 + "/" + 
£q
;

550 
SŒšg
 
	g£ËùD–‘eFe
 = 
Spid”Job
.
ROOT_DIR
 + "/" +

551 
SELECT_DOCID_DELETE_DIR
 + "/" + 
£q
;

552 
SŒšg
 
	glßdFe
 = 
Spid”Job
.
ROOT_DIR
 + "/" + 
LOAD_DOCID_DIR
 + "/" + 
£q
;

553 
SŒšg
 
	guÆßdFe
 = 
ROOT_DIR
 + "/" + 
LOAD_DOCD_FINGER_NOT_CHANGE
 +

554 "/" + 
pšfo
.
g‘SeqTime
();

555 
	gpšfo
.
£tLßdFeP©h
(
lßdFe
);

556 
	gÃwLßdM­
.
ş—r
();

557 
	gSequ’ûFe
.
R—d”
 
	g®lR—d”
 = 
nuÎ
;

558 
	gSequ’ûFe
.
R—d”
 
	gd–‘eR—d”
 = 
nuÎ
;

559 
	gSequ’ûFe
.
R—d”
 
	guÆßdR—d”
 = 
nuÎ
;

560 
	gSequ’ûFe
.
Wr™”
 
	glßdWr™”
 = 
nuÎ
;

562 
	gŒy
 {

563 
P©h
 
	gu¾lßdP©h
 = 
Ãw
 P©h(
ÃwURLLßdFšg”Fe
);

564 
FeStus
 
	g¡©us
 = 
fs
.
g‘FeStus
(
u¾lßdP©h
);

565 ià(
	g¡©us
.
isDœ
()) {

566 
	glogg”
.
”rÜ
("new url‡nd finger†oad file " +

567 
ÃwURLLßdFšg”Fe
 + " should be file");

568  
	gçl£
;

571 
P©h
 
	gd–‘eP©h
 = 
Ãw
 P©h(
£ËùD–‘eFe
);

572 
	g¡©us
 = 
fs
.
g‘FeStus
(
d–‘eP©h
);

573 ià(!
	g¡©us
.
isDœ
()) {

574 
	glogg”
.
”rÜ
("£Ëù d–‘f" + 
£ËùD–‘eFe
 +

576  
	gçl£
;

579 
	g®lNum
 = 0, 
	gfšg”nÙchªge
 = 0, 
	gdu¶iÿ‹D–‘e
=0;

580 
ImmubËBy‹sWr™abË
 
	gkey
 = 
Ãw
 ImmutableBytesWritable();

581 
ImmubËBy‹sWr™abË
 
	gv
 = 
Ãw
 ImmutableBytesWritable();

582 
	g®lR—d”
 = 
Ãw
 
Sequ’ûFe
.
R—d”
(
fs
, 
u¾lßdP©h
, 
cÚf
);

583 
	g®lR—d”
.
Ãxt
(
key
, 
v
)) {

584 ià(!
	gÃwLßdM­
.
cÚšsKey
(
key
)) {

585 
ImmubËBy‹sWr™abË
 
	gşÚe
 = 
Ãw
 ImmutableBytesWritable();

586 
	gşÚe
.
£t
(
key
.
cİyBy‹s
());

587 
ImmubËBy‹sWr™abË
 
	gvşÚe
 = 
Ãw
 ImmutableBytesWritable();

588 
	gvşÚe
.
£t
(
v
.
cİyBy‹s
());

589 
	gÃwLßdM­
.
put
(
şÚe
, 
vşÚe
);

592 
	g®lNum
 = 
ÃwLßdM­
.
size
();

593 
	gLi¡
<
	gFeInfo
> 
	gæi¡
 = 
Ãw
 
LškedLi¡
<
FeInfo
>();

594 
	gHDFSUt
.
li¡Fe
(
fs
, 
£ËùD–‘eFe
, 
æi¡
, 
çl£
);

595 
NuÎWr™abË
 
	gnuÎobj
 = NuÎWr™abË.
g‘
();

596 
FeInfo
 
	gšfo
 : 
æi¡
) {

597 ià(!
šfo
.
isDœ
()) {

598 
Log
.
šfo
("´oûs  fšg” d–‘li¡ f" + info.
toSŒšg
());

599 
	gŒy
 {

600 ià(
	gd–‘eR—d”
 !ğ
nuÎ
)

601 
d–‘eR—d”
.
şo£
();

602 
	gd–‘eR—d”
 = 
Ãw
 
Sequ’ûFe
.
R—d”
(
fs
,‚ew 
P©h
(
šfo
.
g‘P©h
()), 
cÚf
);

603 
	gd–‘eR—d”
.
Ãxt
(
key
, 
v
)) {

604 ià(
	gÃwLßdM­
.
cÚšsKey
(
key
)) {

605 
	gÃwLßdM­
.
»mov•
(
key
);

606 
	gdu¶iÿ‹D–‘e
++;

609 } 
ÿtch
 (
Exû±iÚ
 
e
) {

610 
	ge
.
´štSckT¿û
();

616 
	guÆßdR—d”
 = 
Ãw
 
Sequ’ûFe
.
R—d”
(
fs
,‚ew 
P©h
(
uÆßdFe
), 
cÚf
);

617 
	guÆßdR—d”
.
Ãxt
(
key
, 
nuÎobj
)) {

618 ià(
	gÃwLßdM­
.
cÚšsKey
(
key
)) {

619 
	gÃwLßdM­
.
»move
(
key
);

620 
	gfšg”nÙchªge
++;

624 
	glßdWr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
Ãw
 
P©h
(

625 
lßdFe
), 
ImmubËBy‹sWr™abË
.
şass
,

626 
NuÎWr™abË
.
şass
);

629 
	gM­
.
	gEÁry
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË> 
	g’Œy
 : 
ÃwLßdM­


630 .
’ŒyS‘
()) {

631 
lßdWr™”
.
­³nd
(
’Œy
.
g‘Key
(), 
NuÎWr™abË
.
g‘
());

633 
	gæag
 = 
Œue
;

635 
	glogg”
.
šfo
("g’”©lßd†i¡ f" + 
lßdFe


636 + " sucûed!Ãw†ßd†i¡ size=" + 
ÃwLßdM­
.
size
()

637 + "®Ènum=" + 
®lNum
 + " fšg”‚Ù chªg=" + 
fšg”nÙchªge
+" du¶iÿ‹ docid="+
du¶iÿ‹D–‘e
);

639 } 
ÿtch
 (
Exû±iÚ
 
e
) {

640 
	ge
.
´štSckT¿û
();

641 } 
	gfš®ly
 {

642 ià(
	g®lR—d”
 !ğ
nuÎ
) {

643 
Œy
 {

644 
®lR—d”
.
şo£
();

645 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

647 
	ge
.
´štSckT¿û
();

651 ià(
	gd–‘eR—d”
 !ğ
nuÎ
) {

652 
Œy
 {

653 
d–‘eR—d”
.
şo£
();

654 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

656 
	ge
.
´štSckT¿û
();

660 ià(
	guÆßdR—d”
 !ğ
nuÎ
) {

661 
Œy
 {

662 
uÆßdR—d”
.
şo£
();

663 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

664 
	ge
.
´štSckT¿û
();

668 ià(
	glßdWr™”
 !ğ
nuÎ
) {

669 
Œy
 {

670 
lßdWr™”
.
şo£
();

671 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

672 
	ge
.
´štSckT¿û
();

678  
	gæag
;

681 
public
 
boŞ—n
 
g’”©eLßdFÏgFe
(
JobInfo
 
jobšfo
, 
SŒšg
 
£q
) {

682 
boŞ—n
 
	gæag
 = 
çl£
;

683 
	gjobšfo
.
g‘P¬amM­
().
put
("$£qTime¡amp", 
£q
);

684 
	gjobšfo
.
g‘P¬amM­
().
put
("$job_Çme", "g’”©e_lßd_æag_hfe_" + 
£q
);

685 
SŒšg
 
	gmodifyLi¡
 = 
ROOT_DIR
 + "/" + 
SELECT_DOCID_OUTPUT_DIR
 + "/" + 
£q
;

686 
	gjobšfo
.
g‘P¬amM­
().
put
("$modify_li¡", 
modifyLi¡
);

687 
	g£rŸlNum
 = 
Spid”Job
.
·r£D©eSŒšg
(
£q
);

688 
	gjobšfo
.
g‘P¬amM­
().
put
("$serialNumber",

689 
SŒšg
.
v®ueOf
(
£rŸlNum
));

691 
SŒšg
 
	glßdli¡
 = 
Spid”Job
.
ROOT_DIR
 + "/" + 
LOAD_DOCID_DIR
 + "/"

692 + 
£q
;

693 
	gjobšfo
.
g‘P¬amM­
().
put
("$lßd_li¡", 
lßdli¡
);

695 
SŒšg
 
	gfšg”Fe
 = 
URL_AND_FINGER_OUTPUT
 + "/" + 
£q
;

696 
	gjobšfo
.
g‘P¬amM­
().
put
("$fšg”_li¡", 
fšg”Fe
);

697 
SŒšg
 
	gouut
 = 
ROOT_DIR
 + "/" + 
LOAD_FLAG_HFILE_OUTPUT_DIR
 + "/"

698 + 
£q
 + "_bak";

699 
	gjobšfo
.
g‘P¬amM­
().
put
("$hfe_ouut", 
ouut
);

701 
	gŒy
 {

702 ià(
	gfs
.
exi¡s
(
Ãw
 
P©h
(
ouut
))) {

703 
	gHDFSUt
.
rmdœs
(
fs
, 
ouut
);

705 
SŒšg
 
	gcommªd
 = 
jobšfo
.
g’”©eCommªd
();

706 
	glogg”
.
šfo
("¡¬ˆlßd fÏg hftØhba£ commªd=" + 
commªd
);

708 
Job
 
	gjob
 = (Jobè(
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
jobšfo
));

709 
boŞ—n
 
	g»s
 = 
job
.
wa™FÜCom¶‘iÚ
(
Œue
);

710 ià(!
	g»s
) {

711 
	glogg”
.
”rÜ
("lßd†ßd fÏgØhfçed" + 
commªd
);

712  
	gçl£
;

715 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
ouut
, 
ROOT_DIR
 + "/"

716 + 
LOAD_FLAG_HFILE_OUTPUT_DIR
 + "/" + 
£q
);

717 
	gæag
 = 
Œue
;

719 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

721 
	ge
.
´štSckT¿û
();

722 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

724 
	ge
.
´štSckT¿û
();

725 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

727 
	ge
.
´štSckT¿û
();

728 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

730 
	ge
.
´štSckT¿û
();

731 } 
ÿtch
 (
Exû±iÚ
 
e
) {

733 
	ge
.
´štSckT¿û
();

736  
	gæag
;

739 
public
 
boŞ—n
 
£ËùeDocidPaœ
(
JobInfo
 
jobšfo
, 
SŒšg
 
£q
) {

740 
boŞ—n
 
	gæag
 = 
çl£
;

742 
	gjobšfo
.
g‘P¬amM­
().
put
("$£qTime¡amp", 
£q
);

743 
	gjobšfo
.
g‘P¬amM­
().
put
("$job_Çme", "£Ëù_dup_·œ_" + 
£q
);

744 
SŒšg
 
	gšput
 = 
ROOT_DIR
 + "/" + 
GENERATE_DUP_PAIR_DIR
 + "/" + 
£q
;

745 
	gjobšfo
.
g‘P¬amM­
().
put
("$£Ëù_šput_dœ", 
šput
);

746 
SŒšg
 
	gouut
 = 
ROOT_DIR
 + "/" + 
SELECT_DOCID_OUTPUT_DIR
 + "/" + 
£q
;

747 
	gjobšfo
.
g‘P¬amM­
().
put
("$£Ëù_ouut_dœ", 
ouut
);

748 
SŒšg
 
	gbÏckli¡
 = 
ROOT_DIR
 + "/" + 
SELECT_DOCID_DELETE_DIR
 + "/" + 
£q
;

749 
	gŒy
 {

750 
boŞ—n
 
	gexi¡
 = 
fs
.
exi¡s
(
Ãw
 
P©h
(
ouut
));

751 ià(
	gexi¡
) {

752 
	gHDFSUt
.
rmdœs
(
fs
, 
ouut
);

754 
SŒšg
 
	gcommªd
 = 
jobšfo
.
g’”©eCommªd
();

755 
	glogg”
.
šfo
("£Ëù job s¹ !commªd" + 
commªd
);

756 
Job
 
	gjob
 = (Jobè
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
jobšfo
);

757 
boŞ—n
 
	gt
 = 
job
.
wa™FÜCom¶‘iÚ
(
Œue
);

758 
	glogg”
.
šfo
("£Ëù job fšished!„es=" + 
t
);

759 ià(
	gjob
.
isSucûssful
()) {

760 
	gæag
 = 
Œue
;

761 
boŞ—n
 
	g»s
 = 
HDFSUt
.
moveFes
(
fs
, 
ouut
 + "/part*",

762 
bÏckli¡
);

763 
	glogg”
.
šfo
("mov£Ëù d–‘lßd†i¡Ø" + 
bÏckli¡


764 + "„es=" + 
»s
);

766 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

767 
	ge
.
´štSckT¿û
();

768 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

769 
	ge
.
´štSckT¿û
();

770 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

771 
	ge
.
´štSckT¿û
();

772 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

773 
	ge
.
´štSckT¿û
();

774 } 
ÿtch
 (
Exû±iÚ
 
e
) {

775 
	ge
.
´štSckT¿û
();

778  
	gæag
;

783 şas 
	cS’dCÚ‹Á
 
im¶em’ts
 
	gRuÂabË
 {

785 
public
 
S’dCÚ‹Á
() {

789 @
Ov”ride


790 
public
 
run
() {

791 
	gruÂšg
) {

792 
	gfšishedG’”©eQueue
.
size
() == 0) {

793 
Œy
 {

794 
Th»ad
.
¦“p
(
sÿnFŞd”IÁ”v®
);

795 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

796 
	ge
.
´štSckT¿û
();

800 
P¬£dFšg”Info
 
	gšfo
 = 
fšishedG’”©eQueue
.
³ek
();

801 ià(
	gšfo
 =ğ
nuÎ
) {

802 
logg”
.
”rÜ
("get‡‚ull seq from finishedGenerateQueue");

805 
	gçed
 = 0;

809 
SŒšg
 
	gouut
 = 
ROOT_DIR
 + "/" + 
LOAD_FLAG_HFILE_OUTPUT_DIR


810 + "/" + 
šfo
.
g‘SeqTime
();

811 
LßdInüem’lHFes
 
	glßd”
;

812 
	gŒy
 {

813 
	glßd”
 = 
Ãw
 
LßdInüem’lHFes
(
cÚf
);

814 
	glßd”
.
doBulkLßd
(
Ãw
 
P©h
(
ouut
), 
webDBTabË
);

816 } 
ÿtch
 (
Exû±iÚ
 
e1
) {

817 
	ge1
.
´štSckT¿û
();

818 
	glogg”
.
šfo
("load hfileo hbase failed");

819 
	gçed
++;

821 ià(
	gçed
 =ğ
»ŒyTimes
) {

822 
logg”
.
”rÜ
("load upload flag fileo hbae„each max„etryimes ,abort;info="

823 + 
šfo
);

825 } 
	gçed
 < 
	g»ŒyTimes
);

828 
JobInfo
 
	g£ndJobInfo
 = 
jobInfoM­
.
g‘
("generate_send_file");

829 
boŞ—n
 
	gg’”©e_£nd_cÚ‹Á
 = 
çl£
;

830 
	gçed
 = 0;

832 
	gg’”©e_£nd_cÚ‹Á
 = 
g’”©eS’dDocCÚ‹Á
(
£ndJobInfo
,

833 
šfo
.
g‘SeqTime
());

834 ià(
	gg’”©e_£nd_cÚ‹Á
)

837 
	gçed
++;

838 
	glogg”
.
šfo
("generate send content" + info

840 ià(
	gçed
 =ğ
»ŒyTimes
) {

841 
logg”
.
”rÜ
("wait‡†ongime failed generate send file,quit");

842 
	gSy¡em
.
ex™
(0);

844 
	gŒy
 {

845 
	gTh»ad
.
¦“p
(
lßdFaedSË•Time
);

846 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

848 
	ge
.
´štSckT¿û
();

852 } !
	gg’”©e_£nd_cÚ‹Á
);

864 
	glogg”
.
šfo
("one„ound select‡nd generate content file succeed,seq="

865 + 
šfo
.
g‘SeqTime
());

867 
	glock
.
wr™eLock
().
lock
();

870 
SŒšg
 
	gu¾ªdfšg”
 = 
šfo
.
g‘U¾AndFšg”P©h
();

871 
SŒšg
 
	gbaku¾ªdfš”
 = 
u¾ªdfšg”
.
»¶aûFœ¡
(
ROOT_DIR
,

872 
ROOT_DIR_BAK
);

873 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
u¾ªdfšg”
, 
baku¾ªdfš”
);

875 
SŒšg
 
	gÃwu¾Andfšg”
 = 
šfo
.
g‘NewURLAndFšg”Fe
();

876 
SŒšg
 
	gbakÃw
 = 
Ãwu¾Andfšg”
.
»¶aûFœ¡
(
ROOT_DIR
,

877 
ROOT_DIR_BAK
);

878 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
Ãwu¾Andfšg”
, 
bakÃw
);

880 
SŒšg
 
	g§meD–‘e
 = 
Spid”Job
.
ROOT_DIR
 + "/"

881 + 
Spid”Job
.
SAME_FINGER_DOCID_DELETE_DIR
 + "/"

882 + 
šfo
.
g‘SeqTime
();

883 
SŒšg
 
	gbak
 = 
§meD–‘e
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

884 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
§meD–‘e
, 
bak
);

887 
SŒšg
 
	g£ËùD–‘e
 = 
ROOT_DIR
 + "/" + 
SELECT_DOCID_DELETE_DIR


888 + "/" + 
šfo
.
g‘SeqTime
();

889 
SŒšg
 
	gbakd–‘e
 = 
£ËùD–‘e
.
»¶aûFœ¡
(
ROOT_DIR
,

890 
ROOT_DIR_BAK
);

891 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
£ËùD–‘e
, 
bakd–‘e
);

894 
SŒšg
 
	gmodifyD–‘e
 = 
ROOT_DIR
 + "/" + 
SELECT_DOCID_OUTPUT_DIR


895 + "/" + 
šfo
.
g‘SeqTime
();

896 
SŒšg
 
	gbakModify
 = 
modifyD–‘e
.
»¶aûFœ¡
(
ROOT_DIR
,

897 
ROOT_DIR_BAK
);

898 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
modifyD–‘e
, 
bakModify
);

901 
SŒšg
 
	ghba£Lßddocid
 = 
Spid”Job
.
ROOT_DIR
 + "/"

902 + 
Spid”Job
.
SELECT_LOAD_DOCID_DIR
 + "/"

903 + 
šfo
.
g‘SeqTime
();

904 
SŒšg
 
	gbakLßddocid
 = 
hba£Lßddocid
.
»¶aûFœ¡
(
ROOT_DIR
,

905 
ROOT_DIR_BAK
);

906 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
hba£Lßddocid
, 
bakLßddocid
);

909 
SŒšg
 
	glßdFe
 = 
Spid”Job
.
ROOT_DIR
 + "/" + 
LOAD_DOCID_DIR


910 + "/" + 
šfo
.
g‘SeqTime
();

911 
SŒšg
 
	gbakLßd
 = 
lßdFe
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

912 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
lßdFe
, 
bakLßd
);

915 
SŒšg
 
	ghfeOuut
 = 
ROOT_DIR
 + "/"

916 + 
LOAD_FLAG_HFILE_OUTPUT_DIR
 + "/" + 
šfo
.
g‘SeqTime
();

917 
SŒšg
 
	gbakhfe
 = 
hfeOuut
.
»¶aûFœ¡
(
ROOT_DIR
,

918 
ROOT_DIR_BAK
);

919 ià(
	gd–‘eHFe
) {

920 
	gHDFSUt
.
rmdœs
(
fs
, 
hfeOuut
);

922 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
hfeOuut
, 
bakhfe
);

927 
SŒšg
 
	gdupPaœ
 = 
ROOT_DIR
 + "/"

928 + 
Spid”Job
.
GENERATE_DUP_PAIR_DIR
 + "/"

929 + 
šfo
.
g‘SeqTime
();

930 
SŒšg
 
	gbakPaœ
 = 
dupPaœ
.
»¶aûFœ¡
(
ROOT_DIR
, 
ROOT_DIR_BAK
);

931 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
dupPaœ
, 
bakPaœ
);

934 
SŒšg
 
	gfšg”NÙChªge
 = 
ROOT_DIR
 + "/"

935 + 
Spid”Job
.
LOAD_DOCD_FINGER_NOT_CHANGE
 + "/"

936 + 
šfo
.
g‘SeqTime
();

937 
SŒšg
 
	gbakFe
 = 
fšg”NÙChªge
.
»¶aûFœ¡
(
ROOT_DIR
,

938 
ROOT_DIR_BAK
);

939 
	gHDFSUt
.
»ÇmeFe
(
fs
, 
fšg”NÙChªge
, 
bakFe
);

943 
	gfšishedG’”©eQueue
.
»move
(
šfo
);

944 
	glogg”
.
šfo
("remove " + info + " from send queue "

945 + 
fšishedG’”©eQueue
.
cÚšs
(
šfo
));

946 
	glock
.
wr™eLock
().
uÆock
();

951 
public
 
boŞ—n
 
g’”©eS’dDocCÚ‹Á
(
JobInfo
 
jobšfo
, 
SŒšg
 
£q
) {

952 
boŞ—n
 
	gæag
 = 
çl£
;

954 
	g£rŸlNum
 = 
·r£D©eSŒšg
(
£q
);

955 
	gjobšfo
.
g‘P¬amM­
().
put
("$£qTime¡amp", 
£q
);

956 
	gjobšfo
.
g‘P¬amM­
().
put
("$serialNumber",

957 
SŒšg
.
v®ueOf
(
£rŸlNum
));

959 
	gjobšfo
.
g‘P¬amM­
().
put
("$job_Çme", "g’”©e_£nd_fe_" + 
£q
);

960 
SŒšg
 
	gšput
 = 
Spid”Job
.
ROOT_DIR
 + "/" + 
LOAD_DOCID_DIR
 + "/"

961 + 
£q
;

962 
	gjobšfo
.
g‘P¬amM­
().
put
("$lßd_fe", 
šput
);

963 
SŒšg
 
	gd–‘–i¡
 = 
ROOT_DIR
 + "/" + 
SELECT_DOCID_OUTPUT_DIR
 + "/"

964 + 
£q
;

965 
	gjobšfo
.
g‘P¬amM­
().
put
("$d–‘e_fe", 
d–‘–i¡
);

966 
SŒšg
 
	gouut
 = 
ROOT_DIR
 + "/" + 
SEND_CONTENT_DIR
 + "/" + 
£q


968 
	gjobšfo
.
g‘P¬amM­
().
put
("$£nd_ouut", 
ouut
);

969 
	gŒy
 {

970 
boŞ—n
 
	gexi¡
 = 
fs
.
exi¡s
(
Ãw
 
P©h
(
ouut
));

971 ià(
	gexi¡
) {

972 
	gHDFSUt
.
rmdœs
(
fs
, 
ouut
);

974 
SŒšg
 
	gcommªd
 = 
jobšfo
.
g’”©eCommªd
();

975 
	glogg”
.
šfo
("generate send content job start !command"

976 + 
commªd
);

977 
Job
 
	gjob
 = (Jobè
JobC»©eFaùÜy
.
ü—‹JobObjeù
(
jobšfo
);

978 
	gjob
.
subm™
();

979 !
	gjob
.
isCom¶‘e
()) {

980 
	gt
 = 
job
.
m­Prog»ss
();

981 ià(
	gt
 =ğ1.0 && 
fšishG‘D©aFromHba£
.
g‘
(è=ğ
çl£
) {

982 
fšishG‘D©aFromHba£
.
£t
(
Œue
);

984 
	gTh»ad
.
¦“p
(1000);

986 
boŞ—n
 
	gt
 = 
job
.
isSucûssful
();

987 
	glogg”
.
šfo
("g’”©£nd cÚ‹Á job fšished!„es=" + 
t
);

988 ià(
	gjob
.
isSucûssful
()) {

989 
	gæag
 = 
Œue
;

990 
boŞ—n
 
	g»s
 = 
HDFSUt
.
»ÇmeFe
(
fs
, 
ouut
, 
ROOT_DIR


991 + "/" + 
SEND_CONTENT_DIR
 + "/" + 
£q
);

992 
	glogg”
.
šfo
("»Çmäom " + 
ouut
 + " content outputo"

993 + 
ROOT_DIR
 + "/" + 
SEND_CONTENT_DIR
 + "/" + 
£q


994 + 
»s
);

996 } 
ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

998 
	ge
.
´štSckT¿û
();

999 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

1001 
	ge
.
´štSckT¿û
();

1002 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

1004 
	ge
.
´štSckT¿û
();

1005 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

1007 
	ge
.
´štSckT¿û
();

1008 } 
ÿtch
 (
Exû±iÚ
 
e
) {

1009 
	ge
.
´štSckT¿û
();

1012  
	gæag
;

1018 
´iv©e
 
	$g‘DocidMod
(
ImmubËBy‹sWr™abË
 
k
) {

1020 
by‹
 
ac
[] = 
k
.
	`g‘
();

1021 
by‹
 
a
 = 
ac
[
k
.
	`g‘Off£t
(è+ k.
	`g‘L’gth
() - 1];

1022 
by‹
 
b
 = 
ac
[
k
.
	`g‘Off£t
(è+ k.
	`g‘L’gth
() - 2];

1023 
t
 = 
a
 & 0x000000ff;

1024 
t2
 = 
b
 & 0x00000003;

1025 
·¹
 = 
t2
 * 256 + 
t
;

1026 ià(
·¹
 < 0 ||…art > 1024) {

1027 
Log
.
	`šfo
("t2 =" + 
t2
 + "=" + 
t
 + "…¬t=" + 
·¹
);

1029  
·¹
;

1030 
	}
}

1032 
public
 
boŞ—n
 
	$¥l™S’dCÚ‹Á
(
SŒšg
 
d©aDœ
) {

1033 
boŞ—n
 
æag
 = 
çl£
;

1035 
Sequ’ûFe
.
R—d”
 
»ad”
 = 
nuÎ
;

1036 
Ï¡Mod
 = -1;

1037 
sumS’d
 = 0;

1038 
sumD–‘e
 = 0;

1039 
cÚ‹ÁfeC»©e
 = 0;

1040 
d–‘eFeC»©e
 = 0;

1041 
Œy
 {

1042 
FeStus
 
¡
[] = 
fs
.
	`globStus
(
Ãw
 
	`P©h
(
d©aDœ
 + "/part*"));

1043 
FSD©aOuutSŒ—m
 
feOut
 = 
nuÎ
;

1044 
ImmubËBy‹sWr™abË
 
k
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
();

1045 
ImmubËBy‹sWr™abË
 
v
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
();

1046 
FeStus
 
s
 : 
¡
) {

1047 ià(
»ad”
 !ğ
nuÎ
) {

1048 
»ad”
.
	`şo£
();

1050 
»ad”
 = 
Ãw
 
Sequ’ûFe
.
	`R—d”
(
fs
, 
s
.
	`g‘P©h
(), 
cÚf
);

1051 
»ad”
.
	`Ãxt
(
k
, 
v
)) {

1052 
sumS’d
++;

1053 
mod
 = 
this
.
	`g‘DocidMod
(
k
);

1054 ià(
mod
 !ğ
Ï¡Mod
) {

1055 
P©h
 
fe
 = 
Ãw
 
	`P©h
(
d©aDœ
 + "/load-"

1056 + 
SŒšg
.
	`v®ueOf
(
mod
));

1057 
logg”
.
	`debug
("ü—‹‚ew s’d f" + 
fe
);

1058 ià(
feOut
 !ğ
nuÎ
) {

1059 
feOut
.
	`şo£
();

1061 
cÚ‹ÁfeC»©e
++;

1062 
feOut
 = 
fs
.
	`ü—‹
(
fe
, 
çl£
);

1063 
Ï¡Mod
 = 
mod
;

1065 
feOut
.
	`wr™e
(
v
.
	`g‘
());

1068 ià(
»ad”
 !ğ
nuÎ
)

1069 
»ad”
.
	`şo£
();

1070 ià(
feOut
 !ğ
nuÎ
) {

1071 
feOut
.
	`şo£
();

1074 
¡
 = 
fs
.
	`globStus
(
Ãw
 
	`P©h
(
d©aDœ
 + "/deletelist*"));

1075 
FeStus
 
s
 : 
¡
) {

1076 ià(
»ad”
 !ğ
nuÎ
) {

1077 
»ad”
.
	`şo£
();

1079 
»ad”
 = 
Ãw
 
Sequ’ûFe
.
	`R—d”
(
fs
, 
s
.
	`g‘P©h
(), 
cÚf
);

1080 
»ad”
.
	`Ãxt
(
k
, 
v
)) {

1081 
sumD–‘e
++;

1082 
mod
 = 
this
.
	`g‘DocidMod
(
k
);

1083 ià(
mod
 !ğ
Ï¡Mod
) {

1084 
P©h
 
fe
 = 
Ãw
 
	`P©h
(
d©aDœ
 + "/delete-"

1085 + 
SŒšg
.
	`v®ueOf
(
mod
));

1086 
logg”
.
	`debug
("ü—‹‚ew d–‘f" + 
fe
);

1087 ià(
feOut
 !ğ
nuÎ
) {

1088 
feOut
.
	`şo£
();

1090 
d–‘eFeC»©e
++;

1091 
feOut
 = 
fs
.
	`ü—‹
(
fe
, 
çl£
);

1092 
Ï¡Mod
 = 
mod
;

1094 
feOut
.
	`wr™e
(
k
.
	`g‘
());

1097 ià(
»ad”
 !ğ
nuÎ
)

1098 
»ad”
.
	`şo£
();

1100 ià(
feOut
 !ğ
nuÎ
) {

1101 
feOut
.
	`şo£
();

1103 
logg”
.
	`šfo
("sum s’d =" + 
sumS’d
 + "\t fileCreate ="

1104 + 
cÚ‹ÁfeC»©e
 + "\ˆsum d–‘=" + 
sumD–‘e


1105 + "\ˆfd–‘e=" + 
d–‘eFeC»©e
);

1106 ià(
cÚ‹ÁfeC»©e
 <ğ1024 && 
d–‘eFeC»©e
 <= 102)

1107 
æag
 = 
Œue
;

1109 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

1111 
e
.
	`´štSckT¿û
();

1114  
æag
;

1116 
	}
}

1118 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

1119 
Œy
 {

1120 
Prİ”t›s
 
p
 = 
Ãw
 
	`Prİ”t›s
();

1121 
p
.
	`lßd
(
S–eùAndS’dJob
.
şass


1122 .
	`g‘ResourûAsSŒ—m
("/log4j.properties"));

1123 
Prİ”tyCÚfigu¿tÜ
.
	`cÚfigu»
(
p
);

1124 } 
	`ÿtch
 (
M®fÜmedURLExû±iÚ
 
e1
) {

1126 
e1
.
	`´štSckT¿û
();

1127 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

1129 
e
.
	`´štSckT¿û
();

1131 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

1132 
Œy
 {

1133 
S–eùAndS’dJob
 
£ËùAndS’dJob
 = 
Ãw
 
	`S–eùAndS’dJob
(
cÚf
);

1134 
£ËùAndS’dJob
.
	`runJob
();

1137 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

1139 
e
.
	`´štSckT¿û
();

1141 
	}
}

	@com/zhongsou/spider/hadoop/jobcontrol/SpiderJob.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
;

3 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

4 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

5 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—m
;

6 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—mR—d”
;

7 
impÜt
 
	gjava
.
	gio
.
	gOuutSŒ—mWr™”
;

8 
impÜt
 
	gjava
.
	gio
.
	gPrštWr™”
;

9 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

10 
impÜt
 
	gjava
.
	g‹xt
.
	gP¬£Exû±iÚ
;

11 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

12 
impÜt
 
	gjava
.
	gut
.
	gCom·¿tÜ
;

13 
impÜt
 
	gjava
.
	gut
.
	gD©e
;

14 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

15 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

16 
impÜt
 
	gjava
.
	gut
.
	gcÚcu¼’t
.
	glocks
.
	gR“Á¿ÁR—dWr™eLock
;

18 
impÜt
 
	gjavax
.
	gxml
.
	g·r£rs
.
	gDocum’tBud”
;

19 
impÜt
 
	gjavax
.
	gxml
.
	g·r£rs
.
	gDocum’tBud”FaùÜy
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	g»giÚ£rv”
.
	gm‘rics
.
	gSchemaM‘rics
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

25 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gDocum’t
;

26 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gEËm’t
;

27 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gNode
;

28 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gNodeLi¡
;

30 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gJobInfo
;

31 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gJobty³
;

32 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gexû±iÚ
.
	gEm±yP¬amV®ueExû±iÚ
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gFeInfo
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gHDFSUt
;

43 
ab¡¿ù
 
public
 cÏs 
	cSpid”Job
 {

44 
Logg”
 
	mLOG
 = Logg”.
g‘Logg”
(
Spid”Job
.
şass
);

46 
public
 
fš®
 
SŒšg
 
	mROOT_DIR_BAK
 = "/spider_data_old";

48 
public
 
fš®
 
SŒšg
 
	mROOT_DIR
 = "/spider_data";

54 
public
 
fš®
 
SŒšg
 
	mPIPES_BIN_DIR
 = "pipes_bin";

60 
public
 
fš®
 
SŒšg
 
	mSCORE_OUTPUT_DIR
 = "score_output";

66 
public
 
fš®
 
SŒšg
 
	mSELECT_URL_OUTPUT_DIR
 = "select_url_output";

74 
public
 
fš®
 
SŒšg
 
	mSORT_URL_OUTPUT_DIR
="sort_url_output";

80 
public
 
fš®
 
SŒšg
 
	mCLAWER_OUTPUT_DIR
 = "clawer_output";

86 
public
 
fš®
 
SŒšg
 
	mPARSE_OUTPUT_DIR
 = "parse_output";

93 
public
 
fš®
 
SŒšg
 
	mPARSE_CONVERT_DIR
 = "parse_convert_output";

97 
public
 
fš®
 
SŒšg
 
	mURL_AND_FINGER_DIR
 = "url_and_finger_output";

102 
public
 
fš®
 
SŒšg
 
	mPARSED_URL_META_DIR
 = "parsed_url_meta";

109 
public
 
fš®
 
SŒšg
 
	mPARSED_URL_LINK_INFO_DIR
 = "parsed_url_info";

115 
public
 
fš®
 
SŒšg
 
	mCLAWER_DOCID_DIR
 = "clawer_all_docid";

121 
public
 
fš®
 
SŒšg
 
	mNEW_URL_SRC_DOCID_DIR
 = "new_url_src_docid";

127 
public
 
fš®
 
SŒšg
 
	mDUPLICATE_DOCID_DIR
 = "clawer_duplicte_docid";

135 
public
 
fš®
 
SŒšg
 
	mSTATISTIC_OLD_URL_OUTPUT_DIR
 = "statistic_old_output";

142 
public
 
fš®
 
SŒšg
 
	mSTATISTIC_NEW_URL_OUTPUT_DIR
 = "statistic_new_newoutput";

147 
public
 
fš®
 
SŒšg
 
	mOLD_URL_HFILE_UPDATE_DIR
 = "old_url_update_output";

153 
public
 
fš®
 
SŒšg
 
	mGENERATE_DUP_PAIR_DIR
 = "generate_dup_pair_output";

160 
public
 
fš®
 
SŒšg
 
	mLOAD_DOCD_FINGER_NOT_CHANGE
="load_docid_finger_not_change_output";

164 
public
 
fš®
 
SŒšg
 
	mNEW_URL_HFILE_INSERT_DIR
 = "new_url_insert_output";

169 
public
 
fš®
 
SŒšg
 
	mSELECT_DOCID_OUTPUT_DIR
 = "select_docid_output";

174 
public
 
fš®
 
SŒšg
 
	mNEW_URL_AND_FINGER_DIR
 = "new_url_and_finger";

179 
public
 
fš®
 
SŒšg
 
	mSAME_FINGER_DOCID_DELETE_DIR
 = "same_finger_docid_delete_output";

185 
public
 
fš®
 
SŒšg
 
	mLOAD_DOCID_DIR
 = "load_docid_output";

191 
public
 
fš®
 
SŒšg
 
	mLOAD_FLAG_HFILE_OUTPUT_DIR
 = "load_flag_hfile_output";

198 
public
 
fš®
 
SŒšg
 
	mSELECT_LOAD_DOCID_DIR
 = "select_load_docid_hbase_keys";

204 
public
 
fš®
 
SŒšg
 
	mSELECT_DOCID_DELETE_DIR
 = "select_docid_delete_output";

208 
public
 
SŒšg
 
	mSEND_CONTENT_DIR
 = "send_content_output";

210 
public
 
D©eFÜm©
 
	mDATE_FORMAT
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyyMMddHHmmss");

211 
CÚfigu¿tiÚ
 
	mcÚf
;

212 
´Ùeùed
 
FeSy¡em
 
	mfs
;

213 
´iv©e
 
Com·¿tÜ
 
	m·thCom·¿tÜ
 = 
Ãw
 
P©hCom·¿tÜ
();

214 
´Ùeùed
 
SŒšg
 
	mLOCAL_PWD_HOME
;

215 
´Ùeùed
 
boŞ—n
 
	mruÂšg
 = 
Œue
;

217 
public
 
fš®
 
SŒšg
 
	mJOB_INFO
 = "/jobinfo.xml";

218 
public
 
fš®
 
	mHashM­
<
	mSŒšg
, HashM­<SŒšg, 
	mJobInfo
>> 
	mjobM­
 = 
Ãw
 
HashM­
<
SŒšg
, HashMap<String, JobInfo>>();

219 
public
 
fš®
 
	mHashM­
<
	mSŒšg
, SŒšg> 
	m´İ”t›sM­
 = 
Ãw
 
HashM­
<
SŒšg
, String>();

221 
lßdJobInfo
();

224 
ab¡¿ù
 
checkFŞd”Exi¡s
();

226 
şass
 
P©hCom·¿tÜ
 
im¶em’ts
 
	gCom·¿tÜ
<
	gFeInfo
> {

227 @
Ov”ride


228 
public
 
com·»
(
FeInfo
 
o1
, FeInfØ
o2
) {

230  
	go1
.
g‘P©h
().
com·»To
(
o2
.getPath());

234 
´Ùeùed
 
g‘FeLi¡
(
SŒšg
 
·th
, 
Li¡
<
FeInfo
> 
li¡
) {

235 
	gHDFSUt
.
li¡Fe
(
fs
, 
·th
, 
li¡
, 
çl£
);

236 
	gCŞËùiÚs
.
sÜt
(
li¡
, 
·thCom·¿tÜ
);

237  
	gli¡
.
size
();

240 
´Ùeùed
 
boŞ—n
 
	$u¶ßdFes
(
SŒšg
 
loÿlP©h
, SŒšg 
»mÙeP©h
) {

241  
HDFSUt
.
	`u¶ßd
(
fs
, 
loÿlP©h
, 
»mÙeP©h
);

242 
	}
}

244 
public
 
	$š™
() {

245 
this
.
	`checkFŞd”Exi¡s
();

246 
	}
}

248 
public
 
	$·r£D©eSŒšg
(
SŒšg
 
¡r
) {

249 
D©e
 
a
;

250 
Œy
 {

251 
a
 = 
DATE_FORMAT
.
	`·r£
(
¡r
);

252 
m
 = 
a
.
	`g‘Time
();

253 
£cÚd
 = (è(
m
 / 1000);

254  
£cÚd
;

255 } 
	`ÿtch
 (
P¬£Exû±iÚ
 
e
) {

257 
e
.
	`´štSckT¿û
();

260 
	}
}

262 
public
 
SŒšg
 
	$execJ¬Job
(
JobInfo
 
šfo
) {

263 
SŒšg
 
»tuºSŒšg
 = "";

264 
Proûss
 
´o
 = 
nuÎ
;

265 
RuÁime
 
runTime
 = RuÁime.
	`g‘RuÁime
();

266 ià(
runTime
 =ğ
nuÎ
) {

267 
Sy¡em
.
”r
.
	`´šn
("Create„untime false!");

269 
SŒšg
 
commªd
 = 
nuÎ
;

270 
Œy
 {

271 
commªd
 = 
šfo
.
	`g’”©eCommªd
();

272 
´o
 = 
runTime
.
	`exec
(
commªd
);

273 
Bufã»dR—d”
 
šput
 = 
Ãw
 
	`Bufã»dR—d”
Òew 
	`IÅutSŒ—mR—d”
(
´o
.
	`g‘IÅutSŒ—m
()));

274 
PrštWr™”
 
ouut
 = 
Ãw
 
	`PrštWr™”
Òew 
	`OuutSŒ—mWr™”
(
´o
.
	`g‘OuutSŒ—m
()));

275 
SŒšg
 
lše
;

276 (
lše
 = 
šput
.
	`»adLše
()è!ğ
nuÎ
) {

278 
»tuºSŒšg
 =„‘uºSŒšg + 
lše
 + "\n";

280 
šput
.
	`şo£
();

281 
ouut
.
	`şo£
();

282 
´o
.
	`de¡roy
();

283 } 
	`ÿtch
 (
IOExû±iÚ
 
ex
) {

284 
LOG
.
	`”rÜ
(
commªd
 + "\t" + 
ex
.
	`g‘Mes§ge
());

285 } 
	`ÿtch
 (
Em±yP¬amV®ueExû±iÚ
 
e
) {

287 
e
.
	`´štSckT¿û
();

288 
LOG
.
	`”rÜ
("em±y commªd mes§g" + 
commªd
);

289 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

290 
e
.
	`´štSckT¿û
();

291 
LOG
.
	`”rÜ
(
commªd
 + "\n" + 
e
.
	`g‘Mes§ge
());

293  
»tuºSŒšg
;

295 
	}
}

297 
public
 
	$Spid”Job
(
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

298 
this
.
cÚf
 = conf;

299 
fs
 = 
FeSy¡em
.
	`g‘
(
cÚf
);

300 
SchemaM‘rics
.
	`cÚfigu»Glob®ly
(
cÚf
);

301 
this
.
LOCAL_PWD_HOME
 = 
cÚf
.
	`g‘
("PWD_HOME", "/home/kaifa/xiqi");

302 
	`š™
();

303 
	}
}

305 
ab¡¿ù
 
public
 
runJob
();

307 
public
 
	$ş—nup
() {

309 
	}
}

311 
´iv©e
 
	$lßdJobInfo
() {

312 
Œy
 {

313 
IÅutSŒ—m
 
šput
 = 
Spid”Job
.
şass
.
	`g‘ResourûAsSŒ—m
(
JOB_INFO
);

314 
Docum’tBud”FaùÜy
 
dbf
 = Docum’tBud”FaùÜy.
	`ÃwIn¡ªû
();

315 
Docum’tBud”
 
db
 = 
dbf
.
	`ÃwDocum’tBud”
();

316 
Docum’t
 
doc
 = 
db
.
	`·r£
(
šput
);

317 
doc
.
	`g‘Docum’tEËm’t
().
	`nÜm®ize
();

319 
NodeLi¡
 
´İ”tyL¡
 = 
doc
.
	`g‘EËm’tsByTagName
("properties");

320 
SŒšg
 
Çme
, 
v®ue
;

322 
Node
 
²ode
 = 
´İ”tyL¡
.
	`™em
(0);

324 
NodeLi¡
 
´İ”ty
 = ((
EËm’t
è
²ode
).
	`g‘EËm’tsByTagName
("property");

326 
i
 = 0; i < 
´İ”ty
.
	`g‘L’gth
(); i++) {

327 
Node
 
fNode
 = 
´İ”ty
.
	`™em
(
i
);

328 ià(
fNode
.
	`g‘NodeTy³
(è=ğ
Node
.
ELEMENT_NODE
) {

329 
Œy
 {

330 
EËm’t
 
f¡ElmÁ
 = (EËm’tè
fNode
;

332 
NodeLi¡
 
nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("name");

333 
EËm’t
 
–e
 = (EËm’tè
nodeLi¡
.
	`™em
(0);

334 
Çme
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

335 
nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("value");

336 
–e
 = (
EËm’t
è
nodeLi¡
.
	`™em
(0);

337 
v®ue
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

338 
´İ”t›sM­
.
	`put
(
Çme
, 
v®ue
);

339 
Sy¡em
.
out
.
	`´šn
("Çme=" + 
Çme
 + "\tv®ue=" + 
v®ue
);

340 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

341 
e
.
	`´štSckT¿û
();

347 
NodeLi¡
 
nod–i¡
 = 
doc
.
	`g‘EËm’tsByTagName
("Jobinfo");

349 
Node
 
jobšfo
 = 
nod–i¡
.
	`™em
(0);

350 
NodeLi¡
 
¶i¡
 = ((
EËm’t
è
jobšfo
).
	`g‘EËm’tsByTagName
("Jobs");

352 
SŒšg
 
id
, 
ty³
, 
sh–l
;

353 
i
 = 0; i < 
¶i¡
.
	`g‘L’gth
(); i++) {

354 
Node
 
jobnode
 = 
¶i¡
.
	`™em
(
i
);

355 
Node
 
idNode
 = 
jobnode
.
	`g‘A‰ribu‹s
().
	`g‘NamedI‹m
("id");

356 
id
 = 
idNode
.
	`g‘NodeV®ue
();

357 ià(
jobnode
.
	`g‘NodeTy³
(è=ğ
Node
.
ELEMENT_NODE
) {

358 
HashM­
<
SŒšg
, 
JobInfo
> 
jobšfoM­
 = 
Ãw
 HashMap<String, JobInfo>();

359 
jobM­
.
	`put
(
id
, 
jobšfoM­
);

360 
Œy
 {

361 
NodeLi¡
 
jobnod–i¡
 = ((
EËm’t
è
jobnode
).
	`g‘EËm’tsByTagName
("job");

362 
k
 = 0; k < 
jobnod–i¡
.
	`g‘L’gth
(); k++) {

363 
Node
 
jobšfoNode
 = 
jobnod–i¡
.
	`™em
(
k
);

364 
JobInfo
 
jobInfo
 = 
Ãw
 
	`JobInfo
();

365 
EËm’t
 
f¡ElmÁ
 = (EËm’tè
jobšfoNode
;

366 
NodeLi¡
 
nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("name");

367 
EËm’t
 
–e
 = (EËm’tè
nodeLi¡
.
	`™em
(0);

368 
Çme
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

369 
nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("type");

370 
–e
 = (
EËm’t
è
nodeLi¡
.
	`™em
(0);

371 
ty³
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

373 
nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("shell");

374 
–e
 = (
EËm’t
è
nodeLi¡
.
	`™em
(0);

375 
sh–l
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

377 
jobInfo
.
	`£tName
(
Çme
);

378 
jobInfo
.
	`£tCommªd
(
sh–l
);

379 
jobInfo
.
	`£tTy³
(
Jobty³
.
	`v®ueOf
(
ty³
));

381 
´İ”tyL¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("params");

382 
SŒšg
 
·¿mName
, 
·¿mV®ue
;

384 
²ode
 = 
´İ”tyL¡
.
	`™em
(0);

386 
NodeLi¡
 
·¿m
 = ((
EËm’t
è
²ode
).
	`g‘EËm’tsByTagName
("param");

387 ià(
·¿m
.
	`g‘L’gth
() > 0) {

388 
HashM­
<
SŒšg
, SŒšg> 
·¿mm­
 = 
Ãw
 HashMap<String, String>();

389 
j
 = 0; j < 
·¿m
.
	`g‘L’gth
(); j++) {

390 
Node
 
fNode
 = 
·¿m
.
	`™em
(
j
);

391 ià(
fNode
.
	`g‘NodeTy³
(è=ğ
Node
.
ELEMENT_NODE
) {

392 
Œy
 {

393 
EËm’t
 
–em’t
 = (EËm’tè
fNode
;

395 
NodeLi¡
 
ÇmeLi¡
 = 
–em’t
.
	`g‘EËm’tsByTagName
("name");

396 
EËm’t
 
ÇmeEË
 = (EËm’tè
ÇmeLi¡
.
	`™em
(0);

397 
·¿mName
 = ((
Node
è
ÇmeEË
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

398 
nodeLi¡
 = 
–em’t
.
	`g‘EËm’tsByTagName
("value");

399 
–e
 = (
EËm’t
è
nodeLi¡
.
	`™em
(0);

400 ià(
–e
.
	`g‘ChdNodes
().
	`g‘L’gth
() > 0) {

401 
·¿mV®ue
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

402 
·¿mm­
.
	`put
(
·¿mName
, 
·¿mV®ue
);

404 
·¿mm­
.
	`put
(
·¿mName
, "");

409 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

410 
e
.
	`´štSckT¿û
();

415 
jobInfo
.
	`£tP¬amM­
(
·¿mm­
);

419 
jobšfoM­
.
	`put
(
jobInfo
.
	`g‘Name
(), jobInfo);

421 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

422 
e
.
	`´štSckT¿û
();

427 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

428 
e
.
	`´štSckT¿û
();

431 
	}
}

	@com/zhongsou/spider/hbase/Bulkload.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gLßdInüem’lHFes
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	g»giÚ£rv”
.
	gm‘rics
.
	gSchemaM‘rics
;

8 
public
 cÏs 
	cBulklßd
 {

11 
public
 
	$maš
(
SŒšg
 
¬gs
[])

13 
CÚfigu¿tiÚ
 
cÚf
=
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

14 
Œy
 {

15 
SchemaM‘rics
.
	`cÚfigu»Glob®ly
(
cÚf
);

16 
LßdInüem’lHFes
 
lßd
=
Ãw
 
	`LßdInüem’lHFes
(
cÚf
);

17 
Sy¡em
.
out
.
	`´šn
("Ëngth="+
¬gs
.
Ëngth
);

18 
lßd
.
	`run
(
¬gs
);

19 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

21 
e
.
	`´štSckT¿û
();

26 
	}
}

	@com/zhongsou/spider/hbase/DataParser.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

3 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

4 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

5 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

6 
impÜt
 
	gjava
.
	gut
.
	gM­
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

10 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

12 
public
 cÏs 
	cD©aP¬£r
 {

13 
´iv©e
 
fš®
 
	mby‹
[][] 
	mçm›s
;

14 
´iv©e
 
fš®
 
	mby‹
[][] 
	mqu®if›rs
;

15 
	mM­
<
	mSŒšg
, 
	mIÁeg”
> 
	mcŞumnM­
;

16 
´iv©e
 
boŞ—n
 
	misM­ReduûOuut
 = 
Œue
;

18 
public
 
	$D©aP¬£r
(
SŒšg
 
cŞumn
, SŒšg 
£·¿tÜ
) {

19 
cŞumnM­
 = 
Ãw
 
HashM­
<
SŒšg
, 
IÁeg”
>();

20 
SŒšg
 
t
[] = 
cŞumn
.
	`¥l™
(
£·¿tÜ
);

21 ià(
t
 !ğ
nuÎ
 &&.
Ëngth
 > 0) {

22 
i
 = 0;

23 
çm›s
 = 
Ãw
 
by‹
[
t
.
Ëngth
][];

24 
qu®if›rs
 = 
Ãw
 
by‹
[
t
.
Ëngth
][];

25 
SŒšg
 
m
 : 
t
) {

26 
cŞumnM­
.
	`put
(
m
, 
i
);

27 
SŒšg
[] 
·¹s
 = 
m
.
	`¥l™
(":", 2);

28 ià(
·¹s
.
Ëngth
 == 1) {

29 
çm›s
[
i
] = 
m
.
	`g‘By‹s
();

30 
qu®if›rs
[
i
] = 
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
;

32 
çm›s
[
i
] = 
·¹s
[0].
	`g‘By‹s
();

33 
qu®if›rs
[
i
] = 
·¹s
[1].
	`g‘By‹s
();

35 
i
++;

38 
çm›s
 = 
Ãw
 
by‹
[0][];

39 
qu®if›rs
 = 
Ãw
 
by‹
[0][];

43 
public
 
	$D©aP¬£r
(
SŒšg
 
cŞumn
, SŒšg 
£·¿tÜ
, 
boŞ—n
 
isM­ReduûOuut
) {

44 
	`this
(
cŞumn
, 
£·¿tÜ
);

45 
this
.
isM­ReduûOuut
 = isMapReduceOutput;

46 
	}
}

48 
public
 
	gby‹
[] 
	$g‘Famy
(
idx
) {

49  
çm›s
[
idx
];

50 
	}
}

52 
public
 
	gby‹
[] 
	$g‘Qu®if›r
(
idx
) {

53  
qu®if›rs
[
idx
];

54 
	}
}

56 
public
 şas 
	cPosAndOff£t
 {

57 
	g¡¬t
;

58 
	gËn
;

60 
public
 
PosAndOff£t
(
¡¬t
, 
Ën
) {

61 
	gthis
.
	g¡¬t
 = 
¡¬t
;

62 
	gthis
.
	gËn
 = 
Ën
;

65 
public
 
g‘S¹
() {

66  
	g¡¬t
;

69 
public
 
£tS¹
(
¡¬t
) {

70 
	gthis
.
	g¡¬t
 = 
¡¬t
;

73 
public
 
g‘L’
() {

74  
	gËn
;

77 
public
 
£tL’
(
Ën
) {

78 
	gthis
.
	gËn
 = 
Ën
;

83 
public
 
	gLi¡
<
	gPosAndOff£t
> 
	$·r£
(
by‹
[] 
lšeBy‹s
, 
Ëngth
) {

85 
Li¡
<
PosAndOff£t
> 
i¡
 = 
Ãw
 
LškedLi¡
<PosAndOffset>();

86 
Ën
;

87 
šdex
 = 0;

88 
·ck‘s
=
Numb”Ut
.
	`»adIÁ
(
lšeBy‹s
, 0);

89 
off£t
 = 4; off£ˆ+ 4 < 
Ëngth
&&
šdex
<
·ck‘s
;) {

90 
Ën
 = 
Numb”Ut
.
	`»adIÁ
(
lšeBy‹s
, 
off£t
);

91 
off£t
 += 4;

92 
i¡
.
	`add
(
Ãw
 
	`PosAndOff£t
(
off£t
, 
Ën
));

93 
off£t
 +ğ
Ën
;

94 
šdex
++;

96  
i¡
;

97 
	}
}

	@com/zhongsou/spider/hbase/GenerateHost.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

3 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

4 
impÜt
 
	gjava
.
	gio
.
	gBufã»dWr™”
;

5 
impÜt
 
	gjava
.
	gio
.
	gFe
;

6 
impÜt
 
	gjava
.
	gio
.
	gFeIÅutSŒ—m
;

7 
impÜt
 
	gjava
.
	gio
.
	gFeNÙFoundExû±iÚ
;

8 
impÜt
 
	gjava
.
	gio
.
	gFeOuutSŒ—m
;

9 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

10 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—mR—d”
;

11 
impÜt
 
	gjava
.
	gio
.
	gOuutSŒ—mWr™”
;

12 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

13 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

14 
impÜt
 
	gjava
.
	gut
.
	gRªdom
;

16 
public
 cÏs 
	cG’”©eHo¡
 {

17 
SŒšg
 
	mdomašSuffix
[] = { "", "", "edu", "org", "com", "com.cn", "cn", "net", "edu.cn", "", "" };

18 
	gch
[] = "abcdefghijklmnİqr¡uvwxyz1234560789".
toCh¬A¼ay
();

19 
´iv©e
 
	gdomašNum
 = 0;

20 
´iv©e
 
	gho¡Max
 = 0;

21 
Rªdom
 
	g¿nd
 = 
Ãw
 Random();

22 
	gdomašMšL‘‹r
 = 3;

23 
	gdomašMaxL‘‹r
 = 8;

24 
	gho¡MaxLev–
 = 5;

25 
	gho¡MšL‘‹r
 = 1;

26 
	gho¡MaxL‘‹r
 = 9;

27 
	gbasicURLNUM
 = 500;

28 
	gho¡CouÁ
;

29 
	gdomašBufãr
[] = 
Ãw
 [8];

30 
	gchSize
 = 
ch
.
Ëngth
;

31 
	gdomašHo¡Max
;

33 
public
 
	$G’”©eHo¡
(
domašNum
, 
domašHo¡Max
, 
ho¡Num
) {

34 
this
.
domašNum
 = domainNum;

35 
this
.
ho¡Max
 = 
ho¡Num
;

36 
this
.
domašHo¡Max
 = domainHostMax;

37 
	}
}

39 
	$g‘AGaussŸnNum
(
mš
, 
max
, 
mid
) {

40 
d–ay
;

42 
v®
 = 
¿nd
.
	`ÃxtGaussŸn
(è+ 
mid
;

43 
d–ay
 = (è
M©h
.
	`round
(
v®
);

44 } 
d–ay
 < 
mš
 || d–ay > 
max
);

45  
d–ay
;

46 
	}
}

48 
	$g‘BasicGussŸnNum
(
mš
, 
max
) {

49 
d–ay
;

51 
v®
 = 
¿nd
.
	`ÃxtGaussŸn
() * 10000;

52 
d–ay
 = (è
M©h
.
	`round
(
v®
);

53 } 
d–ay
 < 
mš
 || d–ay > 
max
);

54  
d–ay
;

55 
	}
}

57 
public
 
	$G’”©eDomaš
() {

58 
domašcouÁ
 = 0;

59 
Œy
 {

60 
Bufã»dWr™”
 
wr™”
 = 
Ãw
 
	`Bufã»dWr™”
Òew 
	`OuutSŒ—mWr™”
Òew 
	`FeOuutSŒ—m
Òew 
	`Fe
("/tmp/host.txt"))));

61 
šdex
, 
domašho¡
;

63 
out
: ; 
domašcouÁ
 < 
this
.
domašNum
; domaincount++) {

64 
šdex
 = 
this
.
	`g‘AGaussŸnNum
(2, 10, 5);

65 
dL‘‹rNum
 = 
¿nd
.
	`ÃxtIÁ
(
domašMaxL‘‹r
 - 
domašMšL‘‹r
) + domainMinLetter;

66 
i
 = 0; i < 
dL‘‹rNum
; i++) {

67 
domašBufãr
[
i
] = 
ch
[
¿nd
.
	`ÃxtIÁ
(
chSize
)];

69 
SŒšg
 
domaš
 = 
Ãw
 
	`SŒšg
(
domašBufãr
, 0, 
dL‘‹rNum
è+ "." + 
domašSuffix
[
šdex
];

71 
domašho¡
 = 
this
.
	`g‘AGaussŸnNum
(1,his.
domašHo¡Max
, 5);

72 
i
 = 0; i < 
domašho¡
; i++) {

73 
dho¡Num
 = 
¿nd
.
	`ÃxtIÁ
(
ho¡MaxLev–
 - 
ho¡MšL‘‹r
) + hostMinLetter;

74 
k
 = 0; k < 
dho¡Num
; k++) {

75 
domašBufãr
[
k
] = 
ch
[
¿nd
.
	`ÃxtIÁ
(
chSize
)];

77 
SŒšg
 
ho¡
 = 
Ãw
 
	`SŒšg
(
domašBufãr
, 0, 
dho¡Num
è+ "." + 
domaš
;

79 
wr™”
.
	`wr™e
(
ho¡
 + "\n");

80 
this
.
ho¡CouÁ
++;

81 ià(
this
.
ho¡CouÁ
 >ğthis.
ho¡Max
)

82  
out
;

83 ià(
ho¡CouÁ
 % 1000 == 0) {

84 
Sy¡em
.
out
.
	`´šn
("ho¡ couÁ=" + 
ho¡CouÁ
);

88 
wr™”
.
	`şo£
();

89 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

91 
e
.
	`´štSckT¿û
();

92 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

94 
e
.
	`´štSckT¿û
();

97 
Sy¡em
.
out
.
	`´šn
("fš® ho¡ couÁ=" + 
this
.
ho¡CouÁ
 + " domaš couÁ=" + 
domašcouÁ
);

98 
	}
}

100 
public
 
ü©eOÃFe
(
Li¡
<
SŒšg
> 
ho¡Li¡
, 
feNum
, 
u¾SumNum
) {

101 
	gSy¡em
.
	gout
.
´šn
("ho¡ size=" + 
ho¡Li¡
.
size
());

102 
	gŒy
 {

103 
Bufã»dWr™”
 
	gwr™”
 = 
Ãw
 Bufã»dWr™”Òew 
OuutSŒ—mWr™”
Òew 
FeOuutSŒ—m
Òew 
Fe
("/tmp/·¹-" + 
feNum
 + ".txt"))));

104 
	gËáURL
 = 
u¾SumNum
 - 
ho¡Li¡
.
size
(è* 
basicURLNUM
;

106 ià(
	gËáURL
 < 0) {

107 
	gËáURL
 = 0;

109 
	gho¡URLNum
 = 0;

110 
SŒšg
 
	gho¡
 : 
ho¡Li¡
) {

111 
ho¡URLNum
 = 
basicURLNUM
;

112 
	gÙh”P¬t
 = 
this
.
g‘BasicGussŸnNum
(0, 1000000);

113 ià(
	gËáURL
 > 0) {

114 
	gËáURL
 -ğ
Ùh”P¬t
;

115 
	gho¡URLNum
 +ğ
Ùh”P¬t
;

117 
	gwr™”
.
wr™e
(
ho¡
 + "\t" + 
ho¡URLNum
 + "\n");

119 
	gwr™”
.
şo£
();

120 ià(
	gËáURL
 > 0) {

121 
	gSy¡em
.
	gout
.
´šn
("Ëá u¾=" + 
ËáURL
);

124 } 
ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

126 
	ge
.
´štSckT¿û
();

127 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

129 
	ge
.
´štSckT¿û
();

134 
public
 
	$¥l™Fe
(
SŒšg
 
šputFe
, 
ÚeFeHo¡Num
, 
ÚeHo¡URLSum
) {

135 
Œy
 {

136 
Bufã»dR—d”
 
»ad”
 = 
Ãw
 
	`Bufã»dR—d”
Òew 
	`IÅutSŒ—mR—d”
Òew 
	`FeIÅutSŒ—m
Òew 
	`Fe
(
šputFe
))));

137 
i
 = 0;

138 
SŒšg
 
lše
 = 
nuÎ
;

139 
feNum
 = 0;

140 
Li¡
<
SŒšg
> 
ho¡Li¡
 = 
Ãw
 
LškedLi¡
<String>();

141 (
lše
 = 
»ad”
.
	`»adLše
()è!ğ
nuÎ
) {

142 ià(
i
 < 
ÚeFeHo¡Num
) {

143 
ho¡Li¡
.
	`add
(
lše
);

144 
i
++;

147 
this
.
	`ü©eOÃFe
(
ho¡Li¡
, 
feNum
++, 
ÚeHo¡URLSum
);

148 
i
 = 0;

149 
ho¡Li¡
.
	`ş—r
();

150 
Sy¡em
.
out
.
	`´šn
("fnum=" + 
feNum
);

152 
this
.
	`ü©eOÃFe
(
ho¡Li¡
, 
feNum
++, 
ÚeHo¡URLSum
);

155 } 
	`ÿtch
 (
FeNÙFoundExû±iÚ
 
e
) {

157 
e
.
	`´štSckT¿û
();

158 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

160 
e
.
	`´štSckT¿û
();

163 
	}
}

165 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

166 
G’”©eHo¡
 
p
 = 
Ãw
 
	`G’”©eHo¡
(650000, 1000, 3000000);

167 
p
.
	`G’”©eDomaš
();

168 
p
.
	`¥l™Fe
("/tmp/host.txt", 100000, 166666666);

170 
	}
}

	@com/zhongsou/spider/hbase/HFileOutputFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gio
.
	gUnsuµÜ‹dEncodšgExû±iÚ
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURLDecod”
;

6 
impÜt
 
	gjava
.
	gut
.
	gM­
;

7 
impÜt
 
	gjava
.
	gut
.
	gT»eM­
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLog
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLogFaùÜy
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	g’codšg
.
	gD©aBlockEncodšg
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	ghfe
.
	gCom´essiÚ
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	ghfe
.
	gHFe
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	ghfe
.
	gHFeD©aBlockEncod”
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	ghfe
.
	gHFeD©aBlockEncod”Im¶
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	ghfe
.
	gNoOpD©aBlockEncod”
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	g»giÚ£rv”
.
	gStÜe
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	g»giÚ£rv”
.
	gStÜeFe
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	g»giÚ£rv”
.
	gTimeRªgeT¿ck”
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËUts
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gFeOuutFÜm©
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRecÜdWr™”
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gR•Ü‹r
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gProg»s§bË
;

33 
public
 
şass
 
HFeOuutFÜm©
 
ex‹nds
 
	gFeOuutFÜm©
<
	gImmubËBy‹sWr™abË
, 
	gKeyV®ue
> {

34 
fš®
 
SŒšg
 
	gCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

35 
Log
 
	gLOG
 = 
LogFaùÜy
.
g‘Log
(
HFeOuutFÜm©
.
şass
);

36 
TimeRªgeT¿ck”
 
	gŒt
 = 
Ãw
 TimeRangeTracker();

37 
´iv©e
 
fš®
 
SŒšg
 
	gDATABLOCK_ENCODING_CONF_KEY
 =

39 @
Ov”ride


40 
public
 
	gRecÜdWr™”
<
	gImmubËBy‹sWr™abË
, 
	gKeyV®ue
> 
g‘RecÜdWr™”
(
FeSy¡em
 
ignÜed
, 
fš®
 
JobCÚf
 
cÚf
, 
SŒšg
 
Çme
, 
Prog»s§bË
 
´og»ss
è
throws
 
	gIOExû±iÚ
 {

43 
fš®
 
P©h
 
	gouutP©h
 = 
FeOuutFÜm©
.
g‘OuutP©h
(
cÚf
);

44 
fš®
 
P©h
 
	gouutdœ
 = 
ouutP©h
.
g‘P¬’t
();

46 
fš®
 
FeSy¡em
 
	gfs
 = 
ouutdœ
.
g‘FeSy¡em
(
cÚf
);

48 
fš®
 
	gmaxsize
 = 
cÚf
.
g‘LÚg
("hba£.h»giÚ.max.fesize", 
HCÚ¡ªts
.
DEFAULT_MAX_FILE_SIZE
);

49 
fš®
 
	gblocksize
 = 
cÚf
.
g‘IÁ
("hba£.m­»duû.hfeouutfÜm©.blocksize", 
HFe
.
DEFAULT_BLOCKSIZE
);

52 
fš®
 
SŒšg
 
	gdeçuÉCom´essiÚ
 = 
cÚf
.
g‘
("hfe.com´essiÚ", 
Com´essiÚ
.
AlgÜ™hm
.
NONE
.
g‘Name
());

55 
fš®
 
	gM­
<
	gby‹
[], 
	gSŒšg
> 
	gcom´essiÚM­
 = 
ü—‹FamyCom´essiÚM­
(
cÚf
);

56 
SŒšg
 
	gd©aBlockEncodšgSŒ
 = 
cÚf
.
g‘
(
DATABLOCK_ENCODING_CONF_KEY
);

57 
fš®
 
HFeD©aBlockEncod”
 
	g’cod”
;

58 ià(
	gd©aBlockEncodšgSŒ
 =ğ
nuÎ
) {

59 
’cod”
 = 
NoOpD©aBlockEncod”
.
INSTANCE
;

61 
	gŒy
 {

62 
	g’cod”
 = 
Ãw
 
HFeD©aBlockEncod”Im¶
(
D©aBlockEncodšg


63 .
v®ueOf
(
d©aBlockEncodšgSŒ
));

64 } 
ÿtch
 (
IÎeg®Argum’tExû±iÚ
 
ex
) {

65 
throw
 
Ãw
 
RuÁimeExû±iÚ
(

67 + 
DATABLOCK_ENCODING_CONF_KEY
 + " : "

68 + 
d©aBlockEncodšgSŒ
);

71  
Ãw
 
	gRecÜdWr™”
<
	gImmubËBy‹sWr™abË
, 
	gKeyV®ue
>() {

74 
´iv©e
 
fš®
 
	gM­
<
	gby‹
[], 
	gWr™”L’gth
> 
	gwr™”s
 = 
Ãw
 
T»eM­
<
by‹
[], Wr™”L’gth>(
	gBy‹s
.
	gBYTES_COMPARATOR
);

75 
´iv©e
 
	gby‹
[] 
	g´eviousRow
 = 
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
;

76 
´iv©e
 
fš®
 
	gby‹
[] 
	gnow
 = 
By‹s
.
toBy‹s
(
Sy¡em
.
cu¼’tTimeMlis
());

77 
´iv©e
 
boŞ—n
 
	grŞlReque¡ed
 = 
çl£
;

79 
public
 
wr™e
(
ImmubËBy‹sWr™abË
 
row
, 
KeyV®ue
 
kv
è
throws
 
	gIOExû±iÚ
 {

81 ià(
	grow
 =ğ
nuÎ
 && 
kv
 ==‚ull) {

82 
rŞlWr™”s
();

86 
	gby‹
[] 
	growKey
 = 
kv
.
g‘Row
();

87 
	gËngth
 = 
kv
.
g‘L’gth
();

88 
	gby‹
[] 
	gçmy
 = 
kv
.
g‘Famy
();

89 
Wr™”L’gth
 
	gwl
 = 
this
.
wr™”s
.
g‘
(
çmy
);

93 ià(
	gwl
 =ğ
nuÎ
) {

94 
fs
.
mkdœs
(
Ãw
 
P©h
(
ouutdœ
, 
By‹s
.
toSŒšg
(
çmy
)));

99 ià(
	gwl
 !ğ
nuÎ
 && 
wl
.
wr™‹n
 + 
Ëngth
 >ğ
maxsize
) {

100 
this
.
rŞlReque¡ed
 = 
Œue
;

104 ià(
	grŞlReque¡ed
 && 
	gBy‹s
.
com·»To
(
this
.
´eviousRow
, 
rowKey
) != 0) {

105 
rŞlWr™”s
();

109 ià(
	gwl
 =ğ
nuÎ
 || 
wl
.
wr™”
 ==‚ull) {

110 
wl
 = 
g‘NewWr™”
(
çmy
, 
cÚf
);

114 
	gkv
.
upd©eL©e¡Smp
(
this
.
now
);

115 
	gŒt
.
šşudeTime¡amp
(
kv
);

116 
	gwl
.
	gwr™”
.
­³nd
(
kv
);

117 
	gwl
.
	gwr™‹n
 +ğ
Ëngth
;

120 
	gthis
.
	g´eviousRow
 = 
rowKey
;

123 
´iv©e
 
rŞlWr™”s
(è
throws
 
	gIOExû±iÚ
 {

124 
Wr™”L’gth
 
	gwl
 : 
this
.
wr™”s
.
v®ues
()) {

125 ià(
wl
.
wr™”
 !ğ
nuÎ
) {

126 
LOG
.
šfo
("Wr™”=" + 
wl
.
wr™”
.
g‘P©h
(è+ ((wl.
wr™‹n
 == 0) ? "" : ", wrote=" + wl.written));

127 
şo£
(
wl
.
wr™”
);

129 
	gwl
.
	gwr™”
 = 
nuÎ
;

130 
	gwl
.
	gwr™‹n
 = 0;

132 
	gthis
.
	grŞlReque¡ed
 = 
çl£
;

144 
´iv©e
 
Wr™”L’gth
 
g‘NewWr™”
(
by‹
[] 
çmy
, 
fš®
 
JobCÚf
 
cÚf
è
throws
 
	gIOExû±iÚ
 {

145 
Wr™”L’gth
 
	gwl
 = 
Ãw
 WriterLength();

146 
P©h
 
	gçmydœ
 = 
Ãw
 P©h(
ouutdœ
, 
By‹s
.
toSŒšg
(
çmy
));

147 
SŒšg
 
	gcom´essiÚ
 = 
com´essiÚM­
.
g‘
(
çmy
);

148 
	gcom´essiÚ
 = 
com´essiÚ
 =ğ
nuÎ
 ? 
deçuÉCom´essiÚ
 : compression;

149 
	gwl
.
	gwr™”
 = 
HFe
.
g‘Wr™”FaùÜyNoCache
(
cÚf
)

150 .
w™hP©h
(
fs
, 
StÜeFe
.
g‘UniqueFe
(fs, 
çmydœ
))

151 .
w™hBlockSize
(
blocksize
)

152 .
w™hCom´essiÚ
(
com´essiÚ
)

153 .
w™hCom·¿tÜ
(
KeyV®ue
.
KEY_COMPARATOR
)

154 .
w™hD©aBlockEncod”
(
’cod”
)

155 .
w™hChecksumTy³
(
StÜe
.
g‘ChecksumTy³
(
cÚf
))

156 .
w™hBy‹sP”Checksum
(
StÜe
.
g‘By‹sP”Checksum
(
cÚf
))

157 .
ü—‹
();

158 
	gthis
.
	gwr™”s
.
put
(
çmy
, 
wl
);

159  
	gwl
;

162 
´iv©e
 
şo£
(
fš®
 
HFe
.
Wr™”
 
w
è
throws
 
	gIOExû±iÚ
 {

163 ià(
	gw
 !ğ
nuÎ
) {

164 
w
.
­³ndFeInfo
(
StÜeFe
.
BULKLOAD_TIME_KEY
, 
By‹s
.
toBy‹s
(
Sy¡em
.
cu¼’tTimeMlis
()));

165 
SŒšg
 
	gskId
 = 
cÚf
.
g‘
("mapred.task.id");

168 
	gLOG
.
šfo
("sk id " + 
skId
);

169 
	gw
.
­³ndFeInfo
(
StÜeFe
.
BULKLOAD_TASK_KEY
, 
By‹s
.
toBy‹s
(
skId
));

170 
	gw
.
­³ndFeInfo
(
StÜeFe
.
MAJOR_COMPACTION_KEY
, 
By‹s
.
toBy‹s
(
Œue
));

171 
	gw
.
­³ndFeInfo
(
StÜeFe
.
TIMERANGE_KEY
, 
Wr™abËUts
.
toBy‹A¼ay
(
Œt
));

172 
	gw
.
şo£
();

176 @
Ov”ride


177 
public
 
şo£
(
R•Ü‹r
 
»pÜ‹r
è
throws
 
	gIOExû±iÚ
 {

179 
Wr™”L’gth
 
	gwl
 : 
this
.
wr™”s
.
v®ues
()) {

180 
şo£
(
wl
.
wr™”
);

190 şas 
	cWr™”L’gth
 {

191 
	gwr™‹n
 = 0;

192 
	gHFe
.
Wr™”
 
	gwr™”
 = 
nuÎ
;

204 
	gM­
<
	gby‹
[], 
	gSŒšg
> 
	$ü—‹FamyCom´essiÚM­
(
JobCÚf
 
cÚf
) {

205 
M­
<
by‹
[], 
SŒšg
> 
com´essiÚM­
 = 
Ãw
 
T»eM­
<by‹[], SŒšg>(
By‹s
.
BYTES_COMPARATOR
);

206 
SŒšg
 
com´essiÚCÚf
 = 
cÚf
.
	`g‘
(
COMPRESSION_CONF_KEY
, "");

207 
SŒšg
 
çmyCÚf
 : 
com´essiÚCÚf
.
	`¥l™
("&")) {

208 
SŒšg
[] 
çmyS¶™
 = 
çmyCÚf
.
	`¥l™
("=");

209 ià(
çmyS¶™
.
Ëngth
 != 2) {

213 
Œy
 {

214 
com´essiÚM­
.
	`put
(
URLDecod”
.
	`decode
(
çmyS¶™
[0], "UTF-8").
	`g‘By‹s
(), URLDecoder.decode(familySplit[1], "UTF-8"));

215 } 
	`ÿtch
 (
UnsuµÜ‹dEncodšgExû±iÚ
 
e
) {

217 
throw
 
Ãw
 
	`As£¹iÚE¼Ü
(
e
);

220  
com´essiÚM­
;

221 
	}
}

	@com/zhongsou/spider/hbase/MultiTableInputFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

5 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

6 
impÜt
 
	gjava
.
	gut
.
	gD©e
;

7 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

8 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

9 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLog
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLogFaùÜy
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gCom·»F‹r
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹rLi¡
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gSšgËCŞumnV®ueF‹r
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»d
.
	gTabËIÅutFÜm©
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»d
.
	gTabËS¶™
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gPaœ
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gIÅutFÜm©
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gIÅutS¶™
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚfigu¿bË
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRecÜdR—d”
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gR•Ü‹r
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

35 
public
 
şass
 
MuÉiTabËIÅutFÜm©
 
im¶em’ts


36 
	gIÅutFÜm©
<
	gImmubËBy‹sWr™abË
, 
	gResuÉ
>, 
	gJobCÚfigu¿bË
 {

37 
´iv©e
 
fš®
 
Log
 
	gLOG
 = 
LogFaùÜy
.
g‘Log
(
TabËIÅutFÜm©
.
şass
);

40 
public
 
fš®
 
SŒšg
 
	gINPUT_TABLE
 = "hbase.mapreduce.inputtables";

46 
public
 
fš®
 
SŒšg
 
	gSCAN
 = "hbase.mapreduce.scan";

48 
public
 
fš®
 
SŒšg
 
	gSCAN_COLUMN_FAMILY
 = "hbase.mapreduce.scan.column.family";

50 
public
 
fš®
 
SŒšg
 
	gSCAN_COLUMNS
 = "hbase.mapreduce.scan.columns";

52 
public
 
fš®
 
SŒšg
 
	gSCAN_TIMESTAMP
 = "hbase.mapreduce.scan.timestamp";

57 
public
 
fš®
 
SŒšg
 
	gSCAN_TIMERANGE_START
 = "hbase.mapreduce.scan.timerange.start";

62 
public
 
fš®
 
SŒšg
 
	gSCAN_TIMERANGE_END
 = "hbase.mapreduce.scan.timerange.end";

64 
public
 
fš®
 
SŒšg
 
	gSCAN_MAXVERSIONS
 = "hbase.mapreduce.scan.maxversions";

66 
public
 
fš®
 
SŒšg
 
	gSCAN_CACHEBLOCKS
 = "hbase.mapreduce.scan.cacheblocks";

68 
public
 
fš®
 
SŒšg
 
	gSCAN_CACHEDROWS
 = "hbase.mapreduce.scan.cachedrows";

70 
public
 
fš®
 
SŒšg
 
	gSCAN_FILTER_STRING
 = "hbase.mapreduce.scan.filterstring";

72 
public
 
fš®
 
SŒšg
 
	gCOLUMN_LIST
 = "hbase.mapred.tablecolumns";

74 
MuÉiTabËRecÜdR—d”
 
	gbËRecÜdR—d”
;

76 
´iv©e
 
	gHashM­
<
	gSŒšg
, 
	gHTabË
> 
	gbËM­
;

77 
´iv©e
 
	gHashM­
<
	gSŒšg
, 
	gF‹r
> 
	gf‹rM­
;

78 
	gHashM­
<
	gSŒšg
, SŒšg[]> 
	gšputCŞumnM­
;

79 
´iv©e
 
	gHashM­
<
	gSŒšg
, []> 
	gtimeRªgeM­
;

80 
	gÿchedRows
;

81 
	gby‹
[] 
	g¡¬tRow
 = 
Ãw
 
by‹
[0];

82 
	gby‹
[] 
	g¡İRow
 = 
Ãw
 
by‹
[0];

86 
public
 
cÚfigu»
(
JobCÚf
 
job
) {

88 
	gbËM­
 = 
Ãw
 
HashM­
<
SŒšg
, 
	gHTabË
>();

89 
SŒšg
 
	gbËNames
 = 
job
.
g‘
(
INPUT_TABLE
);

90 
	gf‹rM­
 = 
Ãw
 
HashM­
<
SŒšg
, 
	gF‹r
>();

91 
	gšputCŞumnM­
 = 
Ãw
 
HashM­
<
SŒšg
, 
	gSŒšg
[]>();

92 
	gthis
.
	gtimeRªgeM­
 = 
Ãw
 
HashM­
<
SŒšg
, []>();

93 
SŒšg
 
	gbË
[] = 
bËNames
.
¥l™
(",");

94 
	gthis
.
	gÿchedRows
 = 
job
.
g‘IÁ
(
SCAN_CACHEDROWS
, 100);

95 
P¬£F‹r
 
	g·r£F‹r
 = 
Ãw
 ParseFilter();

96 
D©eFÜm©
 
	gfÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
(

98 
SŒšg
 
	gt
 : 
bË
) {

99 
t
 =.
Œim
();

100 ià(
	gt
 !ğ"" && 
t
.
Ëngth
() == 0)

102 
	gŒy
 {

103 
	gbËM­
.
put
(
t
, 
Ãw
 
HTabË
(
HBa£CÚfigu¿tiÚ
.
ü—‹
(
job
),));

104 
SŒšg
 
	gcŞArg
 = 
job
.
g‘
(
t
 + "." + 
COLUMN_LIST
);

106 
	gSŒšg
[] 
	gcŞNames
 = 
cŞArg
.
¥l™
(" ");

107 ià(
	gcŞNames
 !ğ
nuÎ
 && 
cŞNames
.
Ëngth
 > 0) {

108 
this
.
šputCŞumnM­
.
put
(
t
, 
cŞNames
);

109 
	gLOG
.
šfo
("bË " + 
t
 + "‡dd cŞumÀ" + 
cŞArg
);

111 
SŒšg
 
	gtimeSmpS¹
 = 
job
.
g‘
(
t
 + "." + 
SCAN_TIMERANGE_START
);

112 
SŒšg
 
	gtimeSmpEnd
 = 
job
.
g‘
(
t
 + "." + 
SCAN_TIMERANGE_END
);

113 
	gŒy
 {

114 
D©e
 
	g¡¬t
 = 
nuÎ
, 
	g’d
 =‚ull;

115 
	ga
[] = 
Ãw
 [2];

116 ià(
	gtimeSmpS¹
 !ğ
nuÎ


117 && 
timeSmpS¹


118 .
m©ches
("\\d{4}-\\d{1,2}-\\d{1,2} \\d{1,2}:\\d{1,2}:\\d{1,2}")) {

119 
¡¬t
 = 
fÜm©
.
·r£
(
timeSmpS¹
);

120 
	ga
[0] = 
¡¬t
.
g‘Time
();

122 
	ga
[0] = 
LÚg
.
MIN_VALUE
;

124 ià(
	gtimeSmpEnd
 !ğ
nuÎ


125 && 
timeSmpEnd


126 .
m©ches
("\\d{4}-\\d{1,2}-\\d{1,2} \\d{1,2}:\\d{1,2}:\\d{1,2}")) {

127 
’d
 = 
fÜm©
.
·r£
(
timeSmpEnd
);

128 
	ga
[1] = 
’d
.
g‘Time
();

130 
	ga
[1] = 
LÚg
.
MAX_VALUE
;

132 ià(
	g¡¬t
 !ğ
nuÎ
 && 
’d
 !=‚ull)

133 
LOG
.
šfo
("bË " + 
t
 + "+time„ange,start:"

134 + 
¡¬t
.
toLoÿËSŒšg
() + "ƒnd:"

135 + 
’d
.
toLoÿËSŒšg
());

136 
	gthis
.
	gtimeRªgeM­
.
put
(
t
, 
a
);

137 } 
ÿtch
 (
Exû±iÚ
 
e
) {

138 
	ge
.
´štSckT¿û
();

141 
	gLOG
.
šfo
("tim¿ngšfo,¡¬t=" + 
timeSmpS¹
 + "ƒnd:"

142 + 
timeSmpEnd
);

144 
SŒšg
 
	growF‹rSŒ
 = 
job
.
g‘
(
t
 + "." + 
SCAN_FILTER_STRING
);

145 ià(
	growF‹rSŒ
 !ğ
nuÎ
 && !
rowF‹rSŒ
.
equ®s
("")) {

146 
Œy
 {

147 
F‹r
 
f‹r
 = 
·r£F‹r


148 .
·r£F‹rSŒšg
(
rowF‹rSŒ
.
Œim
());

149 
	gf‹rM­
.
put
(
t
, 
f‹r
);

150 
	gLOG
.
šfo
("bË " + 
t


152 + 
rowF‹rSŒ
);

153 } 
ÿtch
 (
Ch¬aù”CodšgExû±iÚ
 
e
) {

155 
	ge
.
´štSckT¿û
();

156 
	gLOG
.
”rÜ
("bË " + 
t
 + "…arse file string failed="

157 + 
rowF‹rSŒ
);

161 
SŒšg
 
	gf‹rTime
 = 
job
.
g‘
(
t
 + ".hbase.filter.bytime");

162 
SŒšg
 
	gf‹rCŞumn
 = 
job
.
g‘
(
t
 + ".hbase.filter.column");

163 ià(
	gf‹rTime
 !ğ
nuÎ
 && !
f‹rTime
.
equ®s
("")

164 && 
f‹rCŞumn
 !ğ
nuÎ
 && !f‹rCŞumn.
equ®s
("")

165 && 
f‹rCŞumn
.
cÚšs
(":")) {

166 
time
 = 0;

167 ià(
	gf‹rTime
.
equ®s
("now")) {

168 
	gtime
 = (è(
Sy¡em
.
cu¼’tTimeMlis
() / 1000);

169 } ià(
	gf‹rTime


170 .
m©ches
("\\d{4}-\\d{1,2}-\\d{1,2} \\d{1,2}:\\d{1,2}:\\d{1,2}")) {

171 
D©e
 
	gáime
 = 
fÜm©
.
·r£
(
f‹rTime
);

172 
	gtime
 = (è(
áime
.
g‘Time
() / 1000);

175 ià(
	gtime
 != 0) {

176 
SŒšg
 
cŞumAndF
[] = 
f‹rCŞumn
.
¥l™
(":");

177 
SšgËCŞumnV®ueF‹r
 
	glff
 = 
Ãw
 SingleColumnValueFilter(

178 
By‹s
.
toBy‹s
(
cŞumAndF
[0]),

179 
By‹s
.
toBy‹s
(
cŞumAndF
[1]),

180 
Com·»F‹r
.
Com·»Op
.
LESS_OR_EQUAL
,

181 
By‹s
.
toBy‹s
(
time
));

182 
	glff
.
£tF‹rIfMissšg
(
çl£
);

183 
	glff
.
£tL©e¡V”siÚOÆy
(
Œue
);

184 
F‹r
 
	gf
=
f‹rM­
.
g‘
(
t
);

185 
F‹rLi¡
 
	gli¡
=
Ãw
 FilterList();

186 if(
	gf
!=
nuÎ
)

188 
li¡
.
addF‹r
(
f
);

190 
	gli¡
.
addF‹r
(
lff
);

191 
	gf‹rM­
.
put
(
t
, 
li¡
);

192 
D©e
 
	gd
 = 
Ãw
 D©e(1È* 
time
 * 1000);

193 
	gLOG
.
šfo
("bË " + 
t
 + "‡dd oneime filterime="

194 + 
fÜm©
.fÜm©(
d
));

200 } 
ÿtch
 (
Exû±iÚ
 
e
) {

201 
	gLOG
.
”rÜ
(
SŒšgUts
.
¡ršgifyExû±iÚ
(
e
));

234 
´Ùeùed
 
boŞ—n
 
šşudeRegiÚInS¶™
(
fš®
 
by‹
[] 
¡¬tKey
,

235 
fš®
 
by‹
[] 
’dKey
) {

236  
	gŒue
;

239 
public
 
	gIÅutS¶™
[] 
g‘S¶™s
(
JobCÚf
 
job
, 
numS¶™s
)

240 
throws
 
	gIOExû±iÚ
 {

241 ià(
	gbËM­
.
size
() == 0) {

242 
throw
 
Ãw
 
IOExû±iÚ
("Noable was…rovided");

244 
	g®lTabËL’
 = 0;

245 
	gLi¡
<
	gIÅutS¶™
> 
	gi¡
 = 
Ãw
 
LškedLi¡
<
IÅutS¶™
>();

246 
HTabË
 
	gbË
 : 
this
.
bËM­
.
v®ues
()) {

248 
Paœ
<
by‹
[][], 
	gby‹
[][]> 
	gkeys
 = 
bË
.
g‘S¹EndKeys
();

249 ià(
	gkeys
 =ğ
nuÎ
 || 
keys
.
g‘Fœ¡
() ==‚ull

250 || 
keys
.
g‘Fœ¡
().
Ëngth
 == 0) {

251 
throw
 
Ãw
 
IOExû±iÚ
("Expecting‡t†east one„egion.");

253 
	gcouÁ
 = 0;

254 
	gi
 = 0; i < 
	gkeys
.
g‘Fœ¡
().
	gËngth
; i++) {

255 ià(!
šşudeRegiÚInS¶™
(
keys
.
g‘Fœ¡
()[
i
],

256 
keys
.
g‘SecÚd
()[
i
])) {

259 
SŒšg
 
	g»giÚLoÿtiÚ
 = 
bË
.
g‘RegiÚLoÿtiÚ
(

260 
keys
.
g‘Fœ¡
()[
i
]).
g‘Ho¡Çme
();

263 ià((
	g¡¬tRow
.
	gËngth
 =ğ0 || 
keys
.
g‘SecÚd
()[
i
].
Ëngth
 =ğ0 || 
By‹s


264 .
com·»To
(
¡¬tRow
, 
keys
.
g‘SecÚd
()[
i
]) < 0)

265 && (
	g¡İRow
.
	gËngth
 =ğ0 || 
By‹s
.
com·»To
(
¡İRow
,

266 
keys
.
g‘Fœ¡
()[
i
]) > 0)) {

267 
	gby‹
[] 
	g¥l™S¹
 = 
¡¬tRow
.
Ëngth
 == 0

268 || 
By‹s
.
com·»To
(
keys
.
g‘Fœ¡
()[
i
], 
¡¬tRow
) >= 0 ? keys

269 .
g‘Fœ¡
()[
i
] : 
¡¬tRow
;

270 
	gby‹
[] 
	g¥l™Stİ
 = (
¡İRow
.
Ëngth
 =ğ0 || 
By‹s
.
com·»To
(

271 
keys
.
g‘SecÚd
()[
i
], 
¡İRow
) <= 0)

272 && 
keys
.
g‘SecÚd
()[
i
].
Ëngth
 > 0 ? keys

273 .
g‘SecÚd
()[
i
] : 
¡İRow
;

274 
IÅutS¶™
 
	g¥l™
 = 
Ãw
 
TabËS¶™
(
bË
.
g‘TabËName
(),

275 
¥l™S¹
, 
¥l™Stİ
, 
»giÚLoÿtiÚ
);

276 
	gi¡
.
add
(
¥l™
);

277 ià(
	gLOG
.
isInfoEÇbËd
())

278 
	gLOG
.
šfo
("g‘S¶™s: s¶™ -> " + (
couÁ
++) + " -> "

279 + 
¥l™
 + "able‚ame"

280 + 
Ãw
 
SŒšg
(
bË
.
g‘TabËName
()));

285  
	gi¡
.
toA¼ay
(
Ãw
 
IÅutS¶™
[0]);

288 
public
 
	gRecÜdR—d”
<
	gImmubËBy‹sWr™abË
, 
	gResuÉ
> 
g‘RecÜdR—d”
(

289 
IÅutS¶™
 
¥l™
, 
JobCÚf
 
job
, 
R•Ü‹r
 
»pÜ‹r
)

290 
throws
 
	gIOExû±iÚ
 {

291 
TabËS¶™
 
	gtS¶™
 = (TabËS¶™è
¥l™
;

292 
MuÉiTabËRecÜdR—d”
 
	gŒr
 = 
this
.
bËRecÜdR—d”
;

294 ià(
	gŒr
 =ğ
nuÎ
) {

295 
Œr
 = 
Ãw
 
MuÉiTabËRecÜdR—d”
();

297 
Sÿn
 
	gsc
 = 
Ãw
 Scan();

298 
	gsc
.
£tS¹Row
(
tS¶™
.
g‘S¹Row
());

299 
	gsc
.
£tStİRow
(
tS¶™
.
g‘EndRow
());

300 
	gsc
.
£tMaxV”siÚs
(1);

301 
SŒšg
 
	gbË
 = 
By‹s
.
toSŒšg
(
tS¶™
.
g‘TabËName
());

302 
SŒšg
 
	gšputCŞumns
[] = 
this
.
šputCŞumnM­
.
g‘
(
bË
);

303 ià(
	gšputCŞumns
 =ğ
nuÎ
 || 
šputCŞumns
.
Ëngth
 == 0) {

304 
LOG
.
šfo
("ÿÀnÙ fšd‡ny iÅuˆcŞumn fÜabË " + 
bË
);

306 
SŒšg
 
	gcŞs
 : 
šputCŞumns
) {

307 ià(
cŞs
.
equ®s
(""))

309 ià(
	gcŞs
.
cÚšs
(":")) {

310 
SŒšg
 
	gf
 = 
cŞs
.
sub¡ršg
(0, cŞs.
šdexOf
(":"));

311 
SŒšg
 
	gcŞ
 = 
cŞs
.
sub¡ršg
(cŞs.
šdexOf
(":") + 1);

312 ià(
	gf
.
Ëngth
(è> 0 && 
	gcŞ
.length() > 0) {

313 
	gsc
.
addCŞumn
(
By‹s
.
toBy‹s
(
f
), By‹s.toBy‹s(
cŞ
));

314 
	gLOG
.
šfo
("TabË " + 
bË
 + "‡dd cŞumn çmy: " + 
f


315 + " cŞumn:" + 
cŞ
);

317 
	gLOG
.
”rÜ
("TabË " + 
bË
 + " bad fÜm©" + 
cŞs
);

320 
	gsc
.
addFamy
(
By‹s
.
toBy‹s
(
cŞs
));

321 
	gLOG
.
šfo
("TabË " + 
bË
 + "‡dd cŞumn çmy: " + 
cŞs
);

325 
	gtim”ªge
[] = 
this
.
timeRªgeM­
.
g‘
(
bË
);

326 ià(
	gtim”ªge
 !ğ
nuÎ
 && 
tim”ªge
.
Ëngth
 == 2) {

327 
sc
.
£tTimeRªge
(
tim”ªge
[0],imerange[1]);

329 
	gsc
.
£tF‹r
(
this
.
f‹rM­
.
g‘
(
bË
));

330 
	gsc
.
£tCachšg
(
ÿchedRows
);

331 
	gŒr
.
£tSÿn
(
sc
);

332 
	gŒr
.
£tHTabË
(
this
.
bËM­
.
g‘
(
bË
));

333 
	gŒy
 {

334 
	gŒr
.
š™
(
nuÎ
);

335 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

337 
	ge
.
´štSckT¿û
();

340  
	gŒr
;

343 
public
 
	gHashM­
<
	gSŒšg
, 
	gHTabË
> 
g‘TabËM­
() {

344  
	gbËM­
;

347 
public
 
£tTabËM­
(
HashM­
<
SŒšg
, 
HTabË
> 
bËM­
) {

348 
	gthis
.
	gbËM­
 = 
bËM­
;

351 
public
 
	gHashM­
<
	gSŒšg
, 
	gF‹r
> 
g‘F‹rM­
() {

352  
	gf‹rM­
;

355 
public
 
£tF‹rM­
(
HashM­
<
SŒšg
, 
F‹r
> 
f‹rM­
) {

356 
	gthis
.
	gf‹rM­
 = 
f‹rM­
;

359 
public
 
v®id©eIÅut
(
JobCÚf
 
job
è
throws
 
	gIOExû±iÚ
 {

361 
SŒšg
 
	gbËNames
 = 
job
.
g‘
(
INPUT_TABLE
);

363 ià(
	gbËNames
 =ğ
nuÎ
 || 
bËNames
 =ğ"" || 
this
.
bËM­
.
size
() == 0) {

364 
throw
 
Ãw
 
IOExû±iÚ
("could‚Ù cÚÃùØbË '" + 
bËNames


368 
SŒšg
 
	gbËs
[] = 
bËNames
.
¥l™
(",");

369 
SŒšg
 
	gt
 : 
bËs
) {

370 
t
 =.
Œim
();

371 
SŒšg
 
	gcŞArg
 = 
job
.
g‘
(
t
 + "." + 
COLUMN_LIST
);

372 ià(
	gcŞArg
 =ğ
nuÎ
 || 
cŞArg
.
Ëngth
() == 0) {

373 
throw
 
Ãw
 
IOExû±iÚ
("expecting‡t†east one column");

	@com/zhongsou/spider/hbase/MultiTableRecordReader.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËRecÜdR—d”Im¶
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gWr™abËs
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gRecÜdR—d”
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gIÅutS¶™
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gTaskA‰em±CÚ‹xt
;

15 
public
 
şass
 
MuÉiTabËRecÜdR—d”
 
im¶em’ts
 
	gRecÜdR—d”
<
	gImmubËBy‹sWr™abË
, 
	gResuÉ
> {

16 
by‹
 
	gÏ¡Sucûssful
[] = 
nuÎ
;

17 
´iv©e
 
TabËRecÜdR—d”Im¶
 
	g»cÜdR—d”Im¶
 = 
Ãw
 TableRecordReaderImpl();

19 @
Ov”ride


20 
public
 
boŞ—n
 
Ãxt
(
ImmubËBy‹sWr™abË
 
key
, 
ResuÉ
 
v®ue
è
throws
 
	gIOExû±iÚ
 {

22 
boŞ—n
 
	gt
;

23 
	gŒy
 {

24 
	gt
 = 
»cÜdR—d”Im¶
.
ÃxtKeyV®ue
();

25 ià(
	gt
) {

26 
ImmubËBy‹sWr™abË
 
	gk
 = 
»cÜdR—d”Im¶
.
g‘Cu¼’tKey
();

27 
ResuÉ
 
	gv
 = 
»cÜdR—d”Im¶
.
g‘Cu¼’tV®ue
();

28 
	gkey
.
£t
(
k
.
g‘
());

29 
	gÏ¡Sucûssful
 = 
k
.
g‘
();

30 
	gWr™abËs
.
cİyWr™abË
(
v
, 
v®ue
);

32  
	gt
;

33 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

35 
	ge
.
´štSckT¿û
();

36 } 
ÿtch
 (
Exû±iÚ
 
e
) {

37 
	gSy¡em
.
	gout
.
´šn
("hbase‚ext keyhrows‡ƒxcepitonƒ„etry");

38 
	ge
.
´štSckT¿û
();

39 
	g»cÜdR—d”Im¶
.
»¡¬t
(
Ï¡Sucûssful
);

40 
	gŒy
 {

41 
	gt
 = 
»cÜdR—d”Im¶
.
ÃxtKeyV®ue
();

42 ià(
	gt
) {

43 
ImmubËBy‹sWr™abË
 
	gk
 = 
»cÜdR—d”Im¶
.
g‘Cu¼’tKey
();

44 
ResuÉ
 
	gv
 = 
»cÜdR—d”Im¶
.
g‘Cu¼’tV®ue
();

45 
	gkey
.
£t
(
k
.
g‘
());

46 
	gÏ¡Sucûssful
 = 
k
.
g‘
();

47 
	gWr™abËs
.
cİyWr™abË
(
v
, 
v®ue
);

49 
	gSy¡em
.
	gout
.
´šn
("»Œy " + 
t
);

50  
	gt
;

51 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e1
) {

53 
	ge1
.
´štSckT¿û
();

54 } 
ÿtch
 (
Exû±iÚ
 
e1
) {

55  
	gçl£
;

57 
	gSy¡em
.
	gout
.
´šn
("retry failed");

58  
	gçl£
;

61  
	gçl£
;

64 
public
 
£tHTabË
(
HTabË
 
hbË
) {

65 
	g»cÜdR—d”Im¶
.
£tHTabË
(
hbË
);

68 
public
 
£tSÿn
(
Sÿn
 
sÿn
) {

69 
	gthis
.
	g»cÜdR—d”Im¶
.
£tSÿn
(
sÿn
);

72 
public
 
š™
(
IÅutS¶™
 
šput¥l™
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

73 
	gthis
.
	g»cÜdR—d”Im¶
.
š™Ÿlize
(
šput¥l™
,
nuÎ
);

76 @
Ov”ride


77 
public
 
ImmubËBy‹sWr™abË
 
ü—‹Key
() {

79  
Ãw
 
ImmubËBy‹sWr™abË
();

82 @
Ov”ride


83 
public
 
ResuÉ
 
ü—‹V®ue
() {

85  
Ãw
 
ResuÉ
();

88 @
Ov”ride


89 
public
 
g‘Pos
(è
throws
 
	gIOExû±iÚ
 {

94 @
Ov”ride


95 
public
 
şo£
(è
throws
 
	gIOExû±iÚ
 {

97 
	gthis
.
	g»cÜdR—d”Im¶
.
şo£
();

100 @
Ov”ride


101 
public
 
g‘Prog»ss
(è
throws
 
	gIOExû±iÚ
 {

	@com/zhongsou/spider/hbase/Snippet.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

3 
public
 cÏs 
	cSn³t
 {

4 
public
 
	$maš
(
SŒšg
[] 
¬gs
) {

7 
	}
}

	@com/zhongsou/spider/hbase/TableMapReduceUtil.java

20 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

22 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayIÅutSŒ—m
;

23 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

24 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅutSŒ—m
;

25 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

26 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

27 
impÜt
 
	gjava
.
	gÏng
.
	g»æeù
.
	gInvoÿtiÚT¬g‘Exû±iÚ
;

28 
impÜt
 
	gjava
.
	gÏng
.
	g»æeù
.
	gM‘hod
;

29 
impÜt
 
	gjava
.
	gÃt
.
	gURL
;

30 
impÜt
 
	gjava
.
	gÃt
.
	gURLDecod”
;

31 
impÜt
 
	gjava
.
	gut
.
	gEnum”©iÚ
;

32 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

33 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLog
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	gcommÚs
.
	gloggšg
.
	gLogFaùÜy
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

42 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

43 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

44 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHRegiÚP¬t™iÚ”
;

45 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËIÅutFÜm©
;

46 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

47 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËOuutFÜm©
;

48 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËReduûr
;

49 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	g£cur™y
.
	gU£r
;

50 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

51 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

52 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gzook“³r
.
	gZKUt
;

53 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abË
;

54 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

55 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gIÅutFÜm©
;

56 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

57 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

62 @
Suµ»ssW¬nšgs
("unchecked")

63 
public
 cÏs 
	cTabËM­ReduûUt
 {

64 
Log
 
	mLOG
 = 
LogFaùÜy
.
g‘Log
(
TabËM­ReduûUt
.
şass
);

86 
public
 
š™TabËM­³rJob
(
SŒšg
 
bË
, 
Sÿn
 
sÿn
, 
CÏss
<? 
ex‹nds
 
TabËM­³r
> 
m­³r
, CÏss<?ƒx‹nd 
Wr™abËCom·¿bË
> 
ouutKeyCÏss
, CÏss<?ƒx‹nd 
Wr™abË
> 
ouutV®ueCÏss
,

87 
Job
 
job
è
throws
 
	mIOExû±iÚ
 {

88 
š™TabËM­³rJob
(
bË
, 
sÿn
, 
m­³r
, 
ouutKeyCÏss
, 
ouutV®ueCÏss
, 
job
, 
Œue
);

111 
public
 
š™TabËM­³rJob
(
by‹
[] 
bË
, 
Sÿn
 
sÿn
, 
CÏss
<? 
ex‹nds
 
TabËM­³r
> 
m­³r
, CÏss<?ƒx‹nd 
Wr™abËCom·¿bË
> 
ouutKeyCÏss
, CÏss<?ƒx‹nd 
Wr™abË
> 
ouutV®ueCÏss
,

112 
Job
 
job
è
throws
 
	gIOExû±iÚ
 {

113 
š™TabËM­³rJob
(
By‹s
.
toSŒšg
(
bË
), 
sÿn
, 
m­³r
, 
ouutKeyCÏss
, 
ouutV®ueCÏss
, 
job
, 
Œue
);

139 
public
 
š™TabËM­³rJob
(
SŒšg
 
bË
, 
Sÿn
 
sÿn
, 
CÏss
<? 
ex‹nds
 
TabËM­³r
> 
m­³r
, CÏss<?ƒx‹nd 
Wr™abËCom·¿bË
> 
ouutKeyCÏss
, CÏss<?ƒx‹nd 
Wr™abË
> 
ouutV®ueCÏss
,

140 
Job
 
job
, 
boŞ—n
 
addD•’d’cyJ¬s
, 
CÏss
<? 
ex‹nds
 
IÅutFÜm©
> 
šputFÜm©CÏss
è
throws
 
	gIOExû±iÚ
 {

141 
	gjob
.
£tIÅutFÜm©CÏss
(
šputFÜm©CÏss
);

142 ià(
	gouutV®ueCÏss
 !ğ
nuÎ
)

143 
job
.
£tM­OuutV®ueCÏss
(
ouutV®ueCÏss
);

144 ià(
	gouutKeyCÏss
 !ğ
nuÎ
)

145 
job
.
£tM­OuutKeyCÏss
(
ouutKeyCÏss
);

146 
	gjob
.
£tM­³rCÏss
(
m­³r
);

147 
CÚfigu¿tiÚ
 
	gcÚf
 = 
job
.
g‘CÚfigu¿tiÚ
();

148 
	gHBa£CÚfigu¿tiÚ
.
m”ge
(
cÚf
, 
HBa£CÚfigu¿tiÚ
.
ü—‹
(conf));

149 
	gcÚf
.
£t
(
TabËIÅutFÜm©
.
INPUT_TABLE
, 
bË
);

150 
	gcÚf
.
£t
(
TabËIÅutFÜm©
.
SCAN
, 
cÚv”tSÿnToSŒšg
(
sÿn
));

151 ià(
	gaddD•’d’cyJ¬s
) {

152 
addD•’d’cyJ¬s
(
job
);

154 
š™C»d’tŸls
(
job
);

182 
public
 
š™TabËM­³rJob
(
by‹
[] 
bË
, 
Sÿn
 
sÿn
, 
CÏss
<? 
ex‹nds
 
TabËM­³r
> 
m­³r
, CÏss<?ƒx‹nd 
Wr™abËCom·¿bË
> 
ouutKeyCÏss
, CÏss<?ƒx‹nd 
Wr™abË
> 
ouutV®ueCÏss
,

183 
Job
 
job
, 
boŞ—n
 
addD•’d’cyJ¬s
, 
CÏss
<? 
ex‹nds
 
IÅutFÜm©
> 
šputFÜm©CÏss
è
throws
 
	gIOExû±iÚ
 {

184 
š™TabËM­³rJob
(
By‹s
.
toSŒšg
(
bË
), 
sÿn
, 
m­³r
, 
ouutKeyCÏss
, 
ouutV®ueCÏss
, 
job
, 
addD•’d’cyJ¬s
, 
šputFÜm©CÏss
);

210 
public
 
š™TabËM­³rJob
(
by‹
[] 
bË
, 
Sÿn
 
sÿn
, 
CÏss
<? 
ex‹nds
 
TabËM­³r
> 
m­³r
, CÏss<?ƒx‹nd 
Wr™abËCom·¿bË
> 
ouutKeyCÏss
, CÏss<?ƒx‹nd 
Wr™abË
> 
ouutV®ueCÏss
,

211 
Job
 
job
, 
boŞ—n
 
addD•’d’cyJ¬s
è
throws
 
	gIOExû±iÚ
 {

212 
š™TabËM­³rJob
(
By‹s
.
toSŒšg
(
bË
), 
sÿn
, 
m­³r
, 
ouutKeyCÏss
, 
ouutV®ueCÏss
, 
job
, 
addD•’d’cyJ¬s
, 
TabËIÅutFÜm©
.
şass
);

238 
public
 
š™TabËM­³rJob
(
SŒšg
 
bË
, 
Sÿn
 
sÿn
, 
CÏss
<? 
ex‹nds
 
TabËM­³r
> 
m­³r
, CÏss<?ƒx‹nd 
Wr™abËCom·¿bË
> 
ouutKeyCÏss
, CÏss<?ƒx‹nd 
Wr™abË
> 
ouutV®ueCÏss
,

239 
Job
 
job
, 
boŞ—n
 
addD•’d’cyJ¬s
è
throws
 
	gIOExû±iÚ
 {

240 
š™TabËM­³rJob
(
bË
, 
sÿn
, 
m­³r
, 
ouutKeyCÏss
, 
ouutV®ueCÏss
, 
job
, 
addD•’d’cyJ¬s
, 
TabËIÅutFÜm©
.
şass
);

243 
public
 
	$š™C»d’tŸls
(
Job
 
job
è
throws
 
IOExû±iÚ
 {

244 ià(
U£r
.
	`isHBa£Secur™yEÇbËd
(
job
.
	`g‘CÚfigu¿tiÚ
())) {

245 
Œy
 {

246 
U£r
.
	`g‘Cu¼’t
().
	`obšAuthTok’FÜJob
(
job
.
	`g‘CÚfigu¿tiÚ
(), job);

247 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
›
) {

248 
LOG
.
	`šfo
("Interrupted obtaining user‡uthenticationoken");

249 
Th»ad
.
	`š‹¼u±ed
();

252 
	}
}

263 
public
 
SŒšg
 
	$cÚv”tSÿnToSŒšg
(
Sÿn
 
sÿn
è
throws
 
IOExû±iÚ
 {

264 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

265 
D©aOuutSŒ—m
 
dos
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

266 
sÿn
.
	`wr™e
(
dos
);

267  
Ba£64
.
	`’codeBy‹s
(
out
.
	`toBy‹A¼ay
());

268 
	}
}

279 
public
 
Sÿn
 
	$cÚv”tSŒšgToSÿn
(
SŒšg
 
ba£64
è
throws
 
IOExû±iÚ
 {

280 
By‹A¼ayIÅutSŒ—m
 
bis
 = 
Ãw
 
	`By‹A¼ayIÅutSŒ—m
(
Ba£64
.
	`decode
(
ba£64
));

281 
D©aIÅutSŒ—m
 
dis
 = 
Ãw
 
	`D©aIÅutSŒ—m
(
bis
);

282 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

283 
sÿn
.
	`»adF›lds
(
dis
);

284  
sÿn
;

285 
	}
}

300 
public
 
š™TabËReduûrJob
(
SŒšg
 
bË
, 
CÏss
<? 
ex‹nds
 
TabËReduûr
> 
»duûr
, 
Job
 
job
è
throws
 
	gIOExû±iÚ
 {

301 
š™TabËReduûrJob
(
bË
, 
»duûr
, 
job
, 
nuÎ
);

320 
public
 
š™TabËReduûrJob
(
SŒšg
 
bË
, 
CÏss
<? 
ex‹nds
 
TabËReduûr
> 
»duûr
, 
Job
 
job
, CÏs 
·¹™iÚ”
è
throws
 
	gIOExû±iÚ
 {

321 
š™TabËReduûrJob
(
bË
, 
»duûr
, 
job
, 
·¹™iÚ”
, 
nuÎ
,‚ull,‚ull);

356 
public
 
š™TabËReduûrJob
(
SŒšg
 
bË
, 
CÏss
<? 
ex‹nds
 
TabËReduûr
> 
»duûr
, 
Job
 
job
, CÏs 
·¹™iÚ”
, SŒšg 
quÜumAdd»ss
, SŒšg 
£rv”CÏss
, SŒšg 
£rv”Im¶
)

357 
throws
 
	gIOExû±iÚ
 {

358 
š™TabËReduûrJob
(
bË
, 
»duûr
, 
job
, 
·¹™iÚ”
, 
quÜumAdd»ss
, 
£rv”CÏss
, 
£rv”Im¶
, 
Œue
);

396 
public
 
š™TabËReduûrJob
(
SŒšg
 
bË
, 
CÏss
<? 
ex‹nds
 
TabËReduûr
> 
»duûr
, 
Job
 
job
, CÏs 
·¹™iÚ”
, SŒšg 
quÜumAdd»ss
, SŒšg 
£rv”CÏss
, SŒšg 
£rv”Im¶
,

397 
boŞ—n
 
addD•’d’cyJ¬s
è
throws
 
	gIOExû±iÚ
 {

399 
CÚfigu¿tiÚ
 
	gcÚf
 = 
job
.
g‘CÚfigu¿tiÚ
();

400 
	gHBa£CÚfigu¿tiÚ
.
m”ge
(
cÚf
, 
HBa£CÚfigu¿tiÚ
.
ü—‹
(conf));

401 
	gjob
.
£tOuutFÜm©CÏss
(
TabËOuutFÜm©
.
şass
);

402 ià(
	g»duûr
 !ğ
nuÎ
)

403 
job
.
£tReduûrCÏss
(
»duûr
);

404 
	gcÚf
.
£t
(
TabËOuutFÜm©
.
OUTPUT_TABLE
, 
bË
);

406 ià(
	gquÜumAdd»ss
 !ğ
nuÎ
) {

408 
ZKUt
.
ŒªsfÜmClu¡”Key
(
quÜumAdd»ss
);

409 
	gcÚf
.
£t
(
TabËOuutFÜm©
.
QUORUM_ADDRESS
, 
quÜumAdd»ss
);

411 ià(
	g£rv”CÏss
 !ğ
nuÎ
 && 
£rv”Im¶
 !=‚ull) {

412 
cÚf
.
£t
(
TabËOuutFÜm©
.
REGION_SERVER_CLASS
, 
£rv”CÏss
);

413 
	gcÚf
.
£t
(
TabËOuutFÜm©
.
REGION_SERVER_IMPL
, 
£rv”Im¶
);

415 
	gjob
.
£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

416 
	gjob
.
£tOuutV®ueCÏss
(
Wr™abË
.
şass
);

417 ià(
	g·¹™iÚ”
 =ğ
HRegiÚP¬t™iÚ”
.
şass
) {

418 
job
.
£tP¬t™iÚ”CÏss
(
HRegiÚP¬t™iÚ”
.
şass
);

419 
HTabË
 
	gouutTabË
 = 
Ãw
 HTabË(
cÚf
, 
bË
);

420 
	g»giÚs
 = 
ouutTabË
.
g‘RegiÚsInfo
().
size
();

421 ià(
	gjob
.
g‘NumReduûTasks
(è> 
	g»giÚs
) {

422 
	gjob
.
£tNumReduûTasks
(
ouutTabË
.
g‘RegiÚsInfo
().
size
());

424 } ià(
	g·¹™iÚ”
 !ğ
nuÎ
) {

425 
job
.
£tP¬t™iÚ”CÏss
(
·¹™iÚ”
);

428 ià(
	gaddD•’d’cyJ¬s
) {

429 
addD•’d’cyJ¬s
(
job
);

432 
š™C»d’tŸls
(
job
);

446 
public
 
	$lim™NumReduûTasks
(
SŒšg
 
bË
, 
Job
 
job
è
throws
 
IOExû±iÚ
 {

447 
HTabË
 
ouutTabË
 = 
Ãw
 
	`HTabË
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
bË
);

448 
»giÚs
 = 
ouutTabË
.
	`g‘RegiÚsInfo
().
	`size
();

449 ià(
job
.
	`g‘NumReduûTasks
(è> 
»giÚs
)

450 
job
.
	`£tNumReduûTasks
(
»giÚs
);

451 
	}
}

464 
public
 
	$£tNumReduûTasks
(
SŒšg
 
bË
, 
Job
 
job
è
throws
 
IOExû±iÚ
 {

465 
HTabË
 
ouutTabË
 = 
Ãw
 
	`HTabË
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
bË
);

466 
»giÚs
 = 
ouutTabË
.
	`g‘RegiÚsInfo
().
	`size
();

467 
job
.
	`£tNumReduûTasks
(
»giÚs
);

468 
	}
}

481 
public
 
	$£tSÿÂ”Cachšg
(
Job
 
job
, 
b©chSize
) {

482 
job
.
	`g‘CÚfigu¿tiÚ
().
	`£tIÁ
("hba£.ş›Á.sÿÂ”.ÿchšg", 
b©chSize
);

483 
	}
}

490 
public
 
	$addD•’d’cyJ¬s
(
Job
 
job
è
throws
 
IOExû±iÚ
 {

491 
Œy
 {

492 
	`addD•’d’cyJ¬s
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
Üg
.
­ache
.
zook“³r
.
ZooK“³r
.
şass
, job.
	`g‘M­OuutKeyCÏss
(), job.
	`g‘M­OuutV®ueCÏss
(), job.
	`g‘IÅutFÜm©CÏss
(),

493 
job
.
	`g‘OuutKeyCÏss
(), job.
	`g‘OuutV®ueCÏss
(), job.
	`g‘OuutFÜm©CÏss
(), job.
	`g‘P¬t™iÚ”CÏss
(), job.
	`g‘Combš”CÏss
());

494 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

495 
throw
 
Ãw
 
	`IOExû±iÚ
(
e
);

497 
	}
}

504 
public
 
	$addD•’d’cyJ¬s
(
CÚfigu¿tiÚ
 
cÚf
, 
CÏss
... 
şas£s
è
throws
 
IOExû±iÚ
 {

506 
FeSy¡em
 
loÿlFs
 = FeSy¡em.
	`g‘Loÿl
(
cÚf
);

508 
S‘
<
SŒšg
> 
j¬s
 = 
Ãw
 
HashS‘
<String>();

511 
j¬s
.
	`addAÎ
(
cÚf
.
	`g‘SŒšgCŞËùiÚ
("tmpjars"));

514 
CÏss
 
şazz
 : 
şas£s
) {

515 ià(
şazz
 =ğ
nuÎ
)

518 
SŒšg
 
·thSŒ
 = 
	`fšdOrC»©eJ¬
(
şazz
);

519 ià(
·thSŒ
 =ğ
nuÎ
) {

520 
LOG
.
	`w¬n
("Could‚Ù fšd j¬ fÜ cÏs " + 
şazz
 + " in ordero ship itohe cluster.");

523 
P©h
 
·th
 = 
Ãw
 
	`P©h
(
·thSŒ
);

524 ià(!
loÿlFs
.
	`exi¡s
(
·th
)) {

525 
LOG
.
	`w¬n
("Could‚Ù v®id©j¬ f" + 
·th
 + " fÜ cÏs " + 
şazz
);

528 
j¬s
.
	`add
(
·th
.
	`makeQu®if›d
(
loÿlFs
).
	`toSŒšg
());

530 ià(
j¬s
.
	`isEm±y
())

533 
cÚf
.
	`£t
("tmpj¬s", 
SŒšgUts
.
	`¬¿yToSŒšg
(
j¬s
.
	`toA¼ay
(
Ãw
 
SŒšg
[0])));

534 
	}
}

551 
´iv©e
 
SŒšg
 
	$fšdOrC»©eJ¬
(
CÏss
 
my_şass
è
throws
 
IOExû±iÚ
 {

552 
Œy
 {

553 
CÏss
<?> 
j¬Fšd”
 = CÏss.
	`fÜName
("org.apache.hadoop.util.JarFinder");

565 
M‘hod
 
m
 = 
j¬Fšd”
.
	`g‘M‘hod
("g‘J¬", 
CÏss
.
şass
);

566  (
SŒšg
è
m
.
	`švoke
(
nuÎ
, 
my_şass
);

567 } 
	`ÿtch
 (
InvoÿtiÚT¬g‘Exû±iÚ
 
™e
) {

569 
throw
 
Ãw
 
	`IOExû±iÚ
(
™e
.
	`g‘Cau£
());

570 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

574 
LOG
.
	`debug
("New JarFinder: org.apache.hadoop.util.JarFinder.getJar " + "not‡vailable. Using old findContainingJar");

575  
	`fšdCÚššgJ¬
(
my_şass
);

576 
	}
}

590 
´iv©e
 
SŒšg
 
	$fšdCÚššgJ¬
(
CÏss
 
my_şass
) {

591 
CÏssLßd”
 
lßd”
 = 
my_şass
.
	`g‘CÏssLßd”
();

592 
SŒšg
 
şass_fe
 = 
my_şass
.
	`g‘Name
().
	`»¶aûAÎ
("\\.", "/") + ".class";

593 
Œy
 {

594 
Enum”©iÚ
 
™r
 = 
lßd”
.
	`g‘Resourûs
(
şass_fe
); iŒ.
	`hasMÜeEËm’ts
();) {

595 
URL
 
u¾
 = (URLè
™r
.
	`ÃxtEËm’t
();

596 ià("j¬".
	`equ®s
(
u¾
.
	`g‘PrÙocŞ
())) {

597 
SŒšg
 
toR‘uº
 = 
u¾
.
	`g‘P©h
();

598 ià(
toR‘uº
.
	`¡¬tsW™h
("file:")) {

599 
toR‘uº
 =oR‘uº.
	`sub¡ršg
("fe:".
	`Ëngth
());

609 
toR‘uº
 =oR‘uº.
	`»¶aûAÎ
("\\+", "%2B");

610 
toR‘uº
 = 
URLDecod”
.
	`decode
(toReturn, "UTF-8");

611  
toR‘uº
.
	`»¶aûAÎ
("!.*$", "");

614 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

615 
throw
 
Ãw
 
	`RuÁimeExû±iÚ
(
e
);

617  
nuÎ
;

618 
	}
}

	@com/zhongsou/spider/hbase/TimeRangeFilter.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aIÅut
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuut
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹rBa£
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

13 
impÜt
 
	gcom
.
	ggoogË
.
	gcommÚ
.
	gba£
.
	gP»cÚd™iÚs
;

15 
public
 cÏs 
	cTimeRªgeF‹r
 
ex‹nds
 
	mF‹rBa£
 {

17 
´iv©e
 
	mmšTimeSmp
 = 
LÚg
.
MIN_VALUE
;

18 
´iv©e
 
	mmaxTimeSmp
 = 
LÚg
.
MAX_VALUE
;

20 
public
 
	$TimeRªgeF‹r
(
mšTimeSmp
, 
maxTimeSmp
) {

21 
P»cÚd™iÚs
.
	`checkArgum’t
(
maxTimeSmp
 >ğ
mšTimeSmp
, "maximestamp %s must be bighan minimestamp %s", maxTimeStamp, minTimeStamp);

22 
this
.
maxTimeSmp
 = maxTimeStamp;

23 
this
.
mšTimeSmp
 = minTimeStamp;

26 @
Ov”ride


27 
public
 
R‘uºCode
 
	$f‹rKeyV®ue
(
KeyV®ue
 
v
) {

28 ià(
v
.
	`g‘Time¡amp
(è>ğ
mšTimeSmp
 && v.g‘Time¡amp(è<ğ
maxTimeSmp
) {

29  
R‘uºCode
.
INCLUDE
;

30 } ià(
v
.
	`g‘Time¡amp
(è< 
mšTimeSmp
) {

33  
R‘uºCode
.
NEXT_COL
;

35  
R‘uºCode
.
SKIP
;

36 
	}
}

38 
public
 
F‹r
 
ü—‹F‹rFromArgum’ts
(
A¼ayLi¡
<
by‹
[]> 
f‹rArgum’ts
) {

39 
	gmšTime
, 
	gmaxTime
;

40 ià(
	gf‹rArgum’ts
.
size
() < 2)

41  
	gnuÎ
;

42 
	gmšTime
 = 
P¬£F‹r
.
cÚv”tBy‹A¼ayToLÚg
(
f‹rArgum’ts
.
g‘
(0));

43 
	gmaxTime
 = 
P¬£F‹r
.
cÚv”tBy‹A¼ayToLÚg
(
f‹rArgum’ts
.
g‘
(1));

44  
Ãw
 
TimeRªgeF‹r
(
mšTime
, 
maxTime
);

47 @
Ov”ride


48 
public
 
	$wr™e
(
D©aOuut
 
out
è
throws
 
IOExû±iÚ
 {

50 
out
.
	`wr™eLÚg
(
mšTimeSmp
);

51 
out
.
	`wr™eLÚg
(
maxTimeSmp
);

52 
	}
}

54 @
Ov”ride


55 
public
 
	$»adF›lds
(
D©aIÅut
 
š
è
throws
 
IOExû±iÚ
 {

57 
this
.
mšTimeSmp
 = 
š
.
	`»adLÚg
();

58 
this
.
maxTimeSmp
 = 
š
.
	`»adLÚg
();

59 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/BinaryOutputFormat.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFSD©aOuutSŒ—m
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gcom´ess
.
	gCom´essiÚCodec
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gcom´ess
.
	gGzCodec
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gRecÜdWr™”
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gTaskA‰em±CÚ‹xt
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gTextOuutFÜm©
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gReæeùiÚUts
;

20 
public
 
şass
 
	gBš¬yOuutFÜm©
<
	gK
, 
	gV
> 
ex‹nds
 
	gTextOuutFÜm©
<K, V> {

22 
şass
 
	gMyLšeRecÜdWr™”
<
	gK
, 
	gV
> 
ex‹nds
 
	gLšeRecÜdWr™”
 {

23 
´iv©e
 
fš®
 
SŒšg
 
	gutf8
 = "UTF-8";

25 
public
 
MyLšeRecÜdWr™”
(
D©aOuutSŒ—m
 
out
, 
SŒšg
 
keyV®ueS•¬©Ü
) {

26 
su³r
(
out
, 
keyV®ueS•¬©Ü
);

30 
´iv©e
 
wr™eObjeù
(
Objeù
 
o
è
throws
 
	gIOExû±iÚ
 {

31 ià(
o
 
š¡ªûof
 
	gText
) {

32 
Text
 
	gto
 = (Textè
o
;

33 
	gout
.
wr™e
(
to
.
g‘By‹s
(), 0,o.
g‘L’gth
());

34 } ià(
o
 
š¡ªûof
 
	gImmubËBy‹sWr™abË
) {

35 
ImmubËBy‹sWr™abË
 
	gv
 = (ImmubËBy‹sWr™abËè
o
;

36 
	gout
.
wr™e
(
v
.
g‘
(), v.
g‘Off£t
(), v.
g‘L’gth
());

38 
	gout
.
wr™e
(
o
.
toSŒšg
().
g‘By‹s
());

42 @
Ov”ride


43 
public
 
synchrÚized
 
wr™e
(
Objeù
 
key
, Objeù 
v®ue
è
throws
 
	gIOExû±iÚ
 {

45 
boŞ—n
 
	gnuÎKey
 = 
key
 =ğ
nuÎ
 || key 
š¡ªûof
 
NuÎWr™abË
;

46 
boŞ—n
 
	gnuÎV®ue
 = 
v®ue
 =ğ
nuÎ
 || v®u
š¡ªûof
 
NuÎWr™abË
;

47 ià(
	gnuÎKey
 && 
	gnuÎV®ue
) {

50 ià(!
	gnuÎKey
) {

51 
wr™eObjeù
(
key
);

54 ià(!
	gnuÎV®ue
) {

55 
wr™eObjeù
(
v®ue
);

61 @
Ov”ride


62 
public
 
	gRecÜdWr™”
<
	gK
, 
	gV
> 
g‘RecÜdWr™”
(
TaskA‰em±CÚ‹xt
 
job
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

64 
CÚfigu¿tiÚ
 
	gcÚf
 = 
job
.
g‘CÚfigu¿tiÚ
();

65 
boŞ—n
 
	gisCom´es£d
 = 
g‘Com´essOuut
(
job
);

66 
SŒšg
 
	gkeyV®ueS•¬©Ü
 = 
cÚf
.
g‘
("mapred.textoutputformat.separator", "\t");

67 
Com´essiÚCodec
 
	gcodec
 = 
nuÎ
;

68 
SŒšg
 
	gex‹nsiÚ
 = "";

69 ià(
	gisCom´es£d
) {

70 
	gCÏss
<? 
ex‹nds
 
	gCom´essiÚCodec
> 
	gcodecCÏss
 = 
g‘OuutCom´essÜCÏss
(
job
, 
GzCodec
.
şass
);

71 
	gcodec
 = (
Com´essiÚCodec
è
ReæeùiÚUts
.
ÃwIn¡ªû
(
codecCÏss
, 
cÚf
);

72 
	gex‹nsiÚ
 = 
codec
.
g‘DeçuÉEx‹nsiÚ
();

74 
P©h
 
	gfe
 = 
g‘DeçuÉWÜkFe
(
job
, 
ex‹nsiÚ
);

75 
FeSy¡em
 
	gfs
 = 
fe
.
g‘FeSy¡em
(
cÚf
);

76 ià(!
	gisCom´es£d
) {

77 
FSD©aOuutSŒ—m
 
	gfeOut
 = 
fs
.
ü—‹
(
fe
, 
çl£
);

78  
Ãw
 
	gMyLšeRecÜdWr™”
<
	gK
, 
	gV
>(
	gfeOut
, 
	gkeyV®ueS•¬©Ü
);

80 
FSD©aOuutSŒ—m
 
	gfeOut
 = 
fs
.
ü—‹
(
fe
, 
çl£
);

81  
Ãw
 
	gMyLšeRecÜdWr™”
<
	gK
, 
	gV
>Òew 
D©aOuutSŒ—m
(
codec
.
ü—‹OuutSŒ—m
(
feOut
)), 
	gkeyV®ueS•¬©Ü
);

	@com/zhongsou/spider/hbase/mapreduce/DataImporterMapper.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gPut
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gPutSÜtReduûr
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gCouÁ”
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

26 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gD©aP¬£r
;

27 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gD©aP¬£r
.
	gPosAndOff£t
;

29 
public
 
şass
 
D©aImpÜ‹rM­³r
 
ex‹nds
 
	gM­³r
<
	gText
, Text, 
	gImmubËBy‹sWr™abË
, 
	gPut
> {

30 
´iv©e
 
	gts
;

33 
´iv©e
 
SŒšg
 
	g£·¿tÜ
;

34 
fš®
 
SŒšg
 
	gNAME
 = "import_data";

35 
fš®
 
CÏss
 
	gDEFAULT_MAPPER
 = 
D©aImpÜ‹rM­³r
.
şass
;

36 
fš®
 
SŒšg
 
	gMAPPER_CONF_KEY
 = "import_data.mapper.class";

37 
fš®
 
SŒšg
 
	gCOLUMNS_CONF_KEY
 = "import_data.columns";

38 
fš®
 
SŒšg
 
	gSKIP_LINES_CONF_KEY
 = "import_data.skip.bad.lines";

39 
fš®
 
SŒšg
 
	gBULK_OUTPUT_CONF_KEY
 = "import_data.bulk.output";

40 
fš®
 
SŒšg
 
	gSEPARATOR_CONF_KEY
 = "import_data.separator";

41 
fš®
 
SŒšg
 
	gTIMESTAMP_CONF_KEY
 = "import_data.timestamp";

42 
fš®
 
SŒšg
 
	gDEFAULT_SEPARATOR
 = ",";

44 
´iv©e
 
boŞ—n
 
	gskBadLšes
;

45 
´iv©e
 
CouÁ”
 
	gbadLšeCouÁ
;

47 
´iv©e
 
D©aP¬£r
 
	g·r£r
;

49 
public
 
g‘Ts
() {

50  
	gts
;

53 
public
 
boŞ—n
 
g‘SkBadLšes
() {

54  
	gskBadLšes
;

57 
public
 
CouÁ”
 
g‘BadLšeCouÁ
() {

58  
	gbadLšeCouÁ
;

61 
public
 
šüem’tBadLšeCouÁ
(
couÁ
) {

62 
	gthis
.
	gbadLšeCouÁ
.
šüem’t
(
couÁ
);

65 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
) {

66 
doS‘up
(
cÚ‹xt
);

68 
CÚfigu¿tiÚ
 
	gcÚf
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
();

70 
	g·r£r
 = 
Ãw
 
D©aP¬£r
(
cÚf
.
g‘
(
COLUMNS_CONF_KEY
), 
£·¿tÜ
);

79 
´Ùeùed
 
doS‘up
(
CÚ‹xt
 
cÚ‹xt
) {

80 
CÚfigu¿tiÚ
 
	gcÚf
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
();

84 
	g£·¿tÜ
 = 
cÚf
.
g‘
(
SEPARATOR_CONF_KEY
);

85 ià(
	g£·¿tÜ
 =ğ
nuÎ
) {

86 
£·¿tÜ
 = 
DEFAULT_SEPARATOR
;

88 
	g£·¿tÜ
 = 
Ãw
 
SŒšg
(
Ba£64
.
decode
(
£·¿tÜ
));

91 
	gts
 = 
cÚf
.
g‘LÚg
(
TIMESTAMP_CONF_KEY
, 
Sy¡em
.
cu¼’tTimeMlis
());

93 
	gskBadLšes
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘BoŞ—n
(
SKIP_LINES_CONF_KEY
, 
Œue
);

94 
	gbadLšeCouÁ
 = 
cÚ‹xt
.
g‘CouÁ”
("ImportTsv", "Bad Lines");

97 
public
 
m­
(
Text
 
key
, Texˆ
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
 {

98 
	gby‹
[] 
	glšeBy‹s
 = 
v®ue
.
g‘By‹s
();

100 
	gŒy
 {

101 
	gLi¡
<
	gPosAndOff£t
> 
	g·r£dLi¡
 = 
·r£r
.
·r£
(
lšeBy‹s
, 
v®ue
.
g‘L’gth
());

102 
	gSy¡em
.
	gout
.
´šn
("lšeBy‹ Ëngth="+
lšeBy‹s
.
Ëngth
+"†i¡ size="+
·r£dLi¡
.
size
());

103 ià(
	g·r£dLi¡
.
size
() <= 1)

106 
ImmubËBy‹sWr™abË
 
	growKey
 = 
Ãw
 ImmubËBy‹sWr™abË(
key
.
g‘By‹s
(),0, key.
g‘L’gth
());

107 
Put
 
	gput
 = 
Ãw
 Put(
rowKey
.
cİyBy‹s
());

108 
	gi
 = 0; i < 
	g·r£dLi¡
.
size
(); i++) {

109 
PosAndOff£t
 
	gq
 = 
·r£dLi¡
.
g‘
(
i
);

110 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
.
g‘By‹s
(),0, key.
g‘L’gth
(), 
·r£r
.
g‘Famy
(
i
), 0,…¬£r.g‘Famy(i).
Ëngth
,…¬£r.
g‘Qu®if›r
(i), 0,…¬£r.g‘Qu®if›r(i).Ëngth, 
ts
,

111 
KeyV®ue
.
Ty³
.
Put
, 
lšeBy‹s
, 
q
.
g‘S¹
(), q.
g‘L’
());

112 
	gput
.
add
(
kv
);

114 
	gcÚ‹xt
.
wr™e
(
rowKey
, 
put
);

115 } 
ÿtch
 (
IÎeg®Argum’tExû±iÚ
 
e
) {

116 ià(
	gskBadLšes
) {

117 
	gSy¡em
.
	g”r
.
´šn
("Bad†š© off£t: "+ 
e
.
g‘Mes§ge
());

118 
šüem’tBadLšeCouÁ
(1);

121 
throw
 
Ãw
 
IOExû±iÚ
(
e
);

123 } 
ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

124 
	ge
.
´štSckT¿û
();

128 
public
 
Job
 
ü—‹Subm™bËJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
[] 
¬gs
è
throws
 
	gIOExû±iÚ
, 
	gCÏssNÙFoundExû±iÚ
 {

132 
SŒšg
 
	gaùu®S•¬©Ü
 = 
cÚf
.
g‘
(
SEPARATOR_CONF_KEY
);

133 ià(
	gaùu®S•¬©Ü
 !ğ
nuÎ
) {

134 
cÚf
.
£t
(
SEPARATOR_CONF_KEY
, 
Ãw
 
SŒšg
(
Ba£64
.
’codeBy‹s
(
aùu®S•¬©Ü
.
g‘By‹s
())));

138 
SŒšg
 
	gm­³rCÏssName
 = 
cÚf
.
g‘
(
MAPPER_CONF_KEY
);

139 
CÏss
 
	gm­³rCÏss
 = 
m­³rCÏssName
 !ğ
nuÎ
 ? CÏss.
fÜName
(m­³rCÏssNameè: 
DEFAULT_MAPPER
;

141 
SŒšg
 
	gbËName
 = 
¬gs
[0];

142 
P©h
 
	gšputDœ
 = 
Ãw
 P©h(
¬gs
[1]);

143 
Job
 
	gjob
 = 
Ãw
 Job(
cÚf
, 
NAME
 + "_" + 
bËName
);

144 
	gjob
.
£tJ¬ByCÏss
(
m­³rCÏss
);

145 
	gFeIÅutFÜm©
.
£tIÅutP©hs
(
job
, 
šputDœ
);

146 
	gjob
.
£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

147 
	gjob
.
£tM­³rCÏss
(
m­³rCÏss
);

149 
SŒšg
 
	ghfeOutP©h
 = 
cÚf
.
g‘
(
BULK_OUTPUT_CONF_KEY
);

150 ià(
	ghfeOutP©h
 !ğ
nuÎ
) {

151 
HTabË
 
bË
 = 
Ãw
 HTabË(
cÚf
, 
bËName
);

152 
	gjob
.
£tReduûrCÏss
(
PutSÜtReduûr
.
şass
);

153 
P©h
 
	gouutDœ
 = 
Ãw
 P©h(
hfeOutP©h
);

154 
	gFeOuutFÜm©
.
£tOuutP©h
(
job
, 
ouutDœ
);

155 
	gjob
.
£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

156 
	gjob
.
£tM­OuutV®ueCÏss
(
Put
.
şass
);

157 
	gHFeOuutFÜm©
.
cÚfigu»Inüem’lLßd
(
job
, 
bË
);

162 
	gTabËM­ReduûUt
.
š™TabËReduûrJob
(
bËName
, 
nuÎ
, 
job
);

163 
	gjob
.
£tNumReduûTasks
(0);

166 
	gTabËM­ReduûUt
.
addD•’d’cyJ¬s
(
job
);

167 
	gTabËM­ReduûUt
.
addD•’d’cyJ¬s
(
job
.
g‘CÚfigu¿tiÚ
(), 
com
.
googË
.
commÚ
.
ba£
.
FunùiÚ
.
şass


169  
	gjob
;

175 
´iv©e
 
u§ge
(
fš®
 
SŒšg
 
”rÜMsg
) {

176 ià(
	g”rÜMsg
 !ğ
nuÎ
 && 
”rÜMsg
.
Ëngth
() > 0) {

177 
Sy¡em
.
”r
.
´šn
("ERROR: " + 
”rÜMsg
);

179 
SŒšg
 
	gu§ge
 = "U§ge: " + 
NAME
 + " -Dimport_data.columns=a,b,c <tablename> <inputdir>\n" + "\n" + "Importshe given input directory of TSV data intohe specifiedable.\n" + "\n"

184 + " -D" + 
BULK_OUTPUT_CONF_KEY
 + "=/path/for/output\n" + " Note: if you do‚ot usehis option,henheargetable must‡lreadyƒxist in HBase\n" + "\n"

185 + "Oth” o±iÚ th© may b¥ecif›d w™h -D inşude:\n" + " -D" + 
SKIP_LINES_CONF_KEY
 + "=çl£ - fa ià’couÁ”šg‡Àšv®id†še\n" + " '-D" + 
SEPARATOR_CONF_KEY


186 + "=|' -ƒg s•¬©Ú…e š¡—d oàbs\n" + " -D" + 
TIMESTAMP_CONF_KEY
 + "=cu¼’tTimeAsLÚg - u£h¥ecif›dime¡am°fÜhimpÜt\n" + " -D" + 
MAPPER_CONF_KEY


187 + "=my.M­³¸- A u£r-defšed M­³¸tØu£ in¡—d oà" + 
DEFAULT_MAPPER
.
g‘Name
() + "\n";

189 
	gSy¡em
.
	g”r
.
´šn
(
u§ge
);

200 
public
 
maš
(
SŒšg
[] 
¬gs
è
throws
 
	gExû±iÚ
 {

201 
CÚfigu¿tiÚ
 
	gcÚf
 = 
HBa£CÚfigu¿tiÚ
.
ü—‹
();

202 
	gSŒšg
[] 
	gÙh”Args
 = 
Ãw
 
G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
g‘RemaššgArgs
();

203 ià(
	gÙh”Args
.
	gËngth
 < 2) {

204 
u§ge
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
);

205 
	gSy¡em
.
ex™
(-1);

209 
SŒšg
 
	gcŞumns
[] = 
cÚf
.
g‘SŒšgs
(
COLUMNS_CONF_KEY
);

210 ià(
	gcŞumns
 =ğ
nuÎ
) {

211 
u§ge
("NØcŞumn ¥ecif›d. PËa£ s³cify w™h -D" + 
COLUMNS_CONF_KEY
 + "=...");

212 
	gSy¡em
.
ex™
(-1);

217 ià(
	gcŞumns
.
	gËngth
 < 2) {

218 
u§ge
("One or more columns in‡dditionohe„ow key‡re„equired");

219 
	gSy¡em
.
ex™
(-1);

222 
Job
 
	gjob
 = 
ü—‹Subm™bËJob
(
cÚf
, 
Ùh”Args
);

223 
	gSy¡em
.
ex™
(
job
.
wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1);

	@com/zhongsou/spider/hbase/mapreduce/DuplicateURL.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

5 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gHash
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gBy‹sWr™abË
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gRawCom·¿tÜ
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

28 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gURLInfo
;

29 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

46 
public
 cÏs 
	cDu¶iÿ‹URL
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

56 
şass
 
URLDocidM­³r
 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, 
	mNuÎWr™abË
, ImmubËBy‹sWr™abË, 
	mURLInfo
> {

57 
ImmubËBy‹sWr™abË
 
	mk2
 = 
Ãw
 ImmutableBytesWritable();

58 
by‹
 
	mb
[] = 
Ãw
 byte[9];

59 
URLInfo
 
	mnuÎšfo
 = 
Ãw
 URLInfo();

61 
	mnuÎšfo
.
£tSrcURLmd5
(
nuÎ
);

62 
	mnuÎšfo
.
£tU¾
(
nuÎ
);

63 
	mnuÎšfo
.
£tU¾md5
(
nuÎ
);

66 @
Ov”ride


67 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

72 @
Ov”ride


73 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
NuÎWr™abË
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

75 
	mSy¡em
.
¬¿ycİy
(
key
.
g‘
(), 0, 
b
, 0, 8);

76 
	mb
[8] = '0';

77 
	mk2
.
£t
(
b
);

78 
	mcÚ‹xt
.
wr™e
(
k2
, 
nuÎšfo
);

90 
şass
 
NewURLInfoM­³r
 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, 
	gURLInfo
, ImmutableBytesWritable, URLInfo> {

91 
ImmubËBy‹sWr™abË
 
	gk2
 = 
Ãw
 ImmutableBytesWritable();

92 
by‹
 
	gb
[] = 
Ãw
 byte[9];

94 @
Ov”ride


95 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

100 @
Ov”ride


101 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
URLInfo
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

103 
	gSy¡em
.
¬¿ycİy
(
v®ue
.
g‘U¾md5
(), 0, 
b
, 0, 8);

104 
	gb
[8] = '1';

105 
	gk2
.
£t
(
b
);

106 
	gcÚ‹xt
.
wr™e
(
k2
, 
v®ue
);

107 
	gcÚ‹xt
.
g‘CouÁ”
("Ãwu¾", "šput_u¾").
šüem’t
(1);

121 
şass
 
NewURLInfoReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gURLInfo
, ImmutableBytesWritable, ImmutableBytesWritable> {

122 
´iv©e
 
MuÉËOuuts
 
	gmos
;

123 
´iv©e
 
SŒšg
 
	gba£Name
;

125 @
Ov”ride


126 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

128 
	gsu³r
.
£tup
(
cÚ‹xt
);

129 
	gmos
 = 
Ãw
 
MuÉËOuuts
(
cÚ‹xt
);

130 
	gk3
 = 
Ãw
 
ImmubËBy‹sWr™abË
();

131 
	gba£Name
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘
("new_docid_prefix");

132 
	gSy¡em
.
	gout
.
´šn
("ba£Name=" + 
ba£Name
);

135 @
Ov”ride


136 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

138 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

139 
	gmos
.
şo£
();

142 
ImmubËBy‹sWr™abË
 
	gk
 = 
Ãw
 ImmutableBytesWritable();

143 
ImmubËBy‹sWr™abË
 
	gk3
;

145 @
Ov”ride


146 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<
URLInfo
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

148 
	gI‹¿tÜ
<
	gURLInfo
> 
	ge
 = 
v®ues
.
™”©Ü
();

149 
boŞ—n
 
	gæag
 = 
Œue
;

151 
by‹
 
	ga
[] = 
Ãw
 byte[8];

152 
	gSy¡em
.
¬¿ycİy
(
key
.
g‘
(), 0, 
a
, 0, 8);

153 
	gk
.
£t
(
a
);

154 
	ge
.
hasNext
()) {

155 
URLInfo
 
	go
 = 
e
.
Ãxt
();

157 ià(
	gæag
 =ğ
Œue
) {

158 ià(
o
.
g‘U¾
(è=ğ
nuÎ
) {

161 
	gæag
 = 
çl£
;

163 
	gcÚ‹xt
.
wr™e
(
k
, 
Ãw
 
ImmubËBy‹sWr™abË
(
o
.
g‘U¾
()));

165 
	gcÚ‹xt
.
g‘CouÁ”
("Ãwu¾", "u¾").
šüem’t
(1);

167 
	gmos
.
wr™e
(
ba£Name
, 
k
, 
NuÎWr™abË
.
g‘
());

170 
	gcÚ‹xt
.
g‘CouÁ”
("Ãwu¾", "¤cu¾").
šüem’t
(1);

171 
	gk3
.
£t
(
o
.
g‘SrcURLmd5
(), 0, 8);

173 
	gmos
.
wr™e
("¤cu¾docid", 
k3
, 
NuÎWr™abË
.
g‘
());

181 
şass
 
URLInfoGroupCom·¿tÜ
 
im¶em’ts
 
	gRawCom·¿tÜ
<
	gImmubËBy‹sWr™abË
> {

183 @
Ov”ride


184 
public
 
com·»
(
ImmubËBy‹sWr™abË
 
o1
, ImmubËBy‹sWr™abË 
o2
) {

185  
	gBy‹s
.
com·»To
(
o1
.
g‘
(), 0, 8, 
o2
.get(), 0, 8);

188 @
Ov”ride


189 
public
 
com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

191  
	gBy‹s
.
com·»To
(
b1
, 
s1
 + 4, 8, 
b2
, 
s2
 + 4, 8);

196 
şass
 
P¬t™iÚURL
 
ex‹nds
 
	gP¬t™iÚ”
<
	gImmubËBy‹sWr™abË
, 
	gURLInfo
> {

197 
Hash
 
	ghash
 = Hash.
g‘In¡ªû
(Hash.
JENKINS_HASH
);

199 @
Ov”ride


200 
public
 
g‘P¬t™iÚ
(
ImmubËBy‹sWr™abË
 
key
, 
URLInfo
 
v®ue
, 
numP¬t™iÚs
) {

202 
	gt
 = 
M©h
.
abs
(
hash
.hash(
key
.
g‘
(), 0, 8, 0));

203  
	gt
 % 
	gnumP¬t™iÚs
;

208 
Job
 
	$ü—‹Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
[] 
¬gs
) {

209 
Job
 
job
;

210 
Œy
 {

211 
job
 = 
Ãw
 
	`Job
(
cÚf
);

213 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
URLDocidM­³r
.class);

214 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
NewURLInfoM­³r
.class);

215 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[2]));

216 
jobnum
 = 
IÁeg”
.
	`·r£IÁ
(
¬gs
[3]);

217 
job
.
	`£tNumReduûTasks
(
jobnum
);

218 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

219 
job
.
	`£tM­OuutV®ueCÏss
(
URLInfo
.
şass
);

220 
job
.
	`£tGroupšgCom·¿tÜCÏss
(
URLInfoGroupCom·¿tÜ
.
şass
);

221 
job
.
	`£tReduûrCÏss
(
NewURLInfoReduûr
.
şass
);

222 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

223 
job
.
	`£tP¬t™iÚ”CÏss
(
P¬t™iÚURL
.
şass
);

224 
job
.
	`£tOuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

225 
job
.
	`£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

226 
D©eFÜm©
 
fÜm©
 = 
Ãw
 
java
.
‹xt
.
	`Sim¶eD©eFÜm©
("yyyyMMddHHmmss");

227 
SŒšg
 
ba£Name
 = "Ãwdocid" + 
fÜm©
.
	`fÜm©
(
Ãw
 
java
.
ut
.
	`D©e
());

228 
job
.
	`g‘CÚfigu¿tiÚ
().
	`£t
("Ãw_docid_´efix", 
ba£Name
);

229 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "¤cu¾docid", 
Sequ’ûFeOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.şass, 
NuÎWr™abË
.class);

230 
MuÉËOuuts
.
	`addNamedOuut
(
job
, 
ba£Name
, 
Sequ’ûFeOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.şass, 
NuÎWr™abË
.class);

231  
job
;

232 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

234 
e
.
	`´štSckT¿û
();

237  
nuÎ
;

238 
	}
}

240 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

241 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

242 
SŒšg
[] 
Ùh”Args
;

243 
Œy
 {

244 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

245 ià(
Ùh”Args
.
Ëngth
 < 4) {

246 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + "‡rgs: urldocid‚ewurlinfo outputpath‚umber_of_reduce");

247 
Sy¡em
.
	`ex™
(-1);

249 
Job
 
job
 = 
	`ü—‹Job
(
cÚf
, 
Ùh”Args
);

250 
Sy¡em
.
	`ex™
(
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1);

251 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

253 
e
.
	`´štSckT¿û
();

254 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

256 
e
.
	`´štSckT¿û
();

258 
	}
}

260 @
Ov”ride


261 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

263 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

264 
this
.
	`£tCÚf
(
cÚf
);

265 
SŒšg
[] 
Ùh”Args
;

266 
Œy
 {

267 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

268 ià(
Ùh”Args
.
Ëngth
 < 4) {

269 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + "‡rgs: urldocid‚ewurlinfo outputpath‚umber_of_reduce");

270 
Sy¡em
.
	`ex™
(-1);

272 
Job
 
job
 = 
	`ü—‹Job
(
cÚf
, 
Ùh”Args
);

273  
job
;

274 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

276 
e
.
	`´štSckT¿û
();

277 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

279 
e
.
	`´štSckT¿û
();

281  
nuÎ
;

283 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/ExportDocid.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËIÅutFÜm©
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

30 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

32 
public
 cÏs 
	cExpÜtDocid
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

34 
public
 
	$ExpÜtDocid
() {

35 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

36 
this
.
	`£tCÚf
(
cÚf
);

39 
public
 
şass
 
ExpÜtDocidM­³r
 
ex‹nds
 
TabËM­³r
<
ImmubËBy‹sWr™abË
, 
NuÎWr™abË
> {

40 
by‹
[] 
f
 = 
By‹s
.
	`toBy‹s
("F");

41 
by‹
[] 
u
 = 
By‹s
.
	`toBy‹s
("u");

42 
by‹
[] 
h
 = 
By‹s
.
	`toBy‹s
("H");

43 
by‹
[] 
s
 = 
By‹s
.
	`toBy‹s
("s");

44 
by‹
[] 
p
 = 
By‹s
.
	`toBy‹s
("P");

45 
by‹
[] 
fšg”
 = 
By‹s
.
	`toBy‹s
("f");

47 @
Ov”ride


48 
´Ùeùed
 
	`m­
(
ImmubËBy‹sWr™abË
 
key
, 
ResuÉ
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
IOExû±iÚ
, 
IÁ”ru±edExû±iÚ
 {

50 
cÚ‹xt
.
	`wr™e
(
key
, 
NuÎWr™abË
.
	`g‘
());

51 
cÚ‹xt
.
	`g‘CouÁ”
("sÿnhba£", "u¾_couÁ").
	`šüem’t
(1);

54 
	}
}

56 
public
 
şass
 
ExpÜtDocidReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gNuÎWr™abË
, ImmutableBytesWritable, NullWritable> {

58 @
Ov”ride


59 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<
NuÎWr™abË
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

61 
	gcÚ‹xt
.
wr™e
(
key
, 
NuÎWr™abË
.
g‘
());

66 
SŒšg
 
	$cÚv”tSÿnToSŒšg
(
Sÿn
 
sÿn
è
throws
 
IOExû±iÚ
 {

67 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

68 
D©aOuutSŒ—m
 
dos
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

69 
sÿn
.
	`wr™e
(
dos
);

70  
Ba£64
.
	`’codeBy‹s
(
out
.
	`toBy‹A¼ay
());

71 
	}
}

86 
´iv©e
 
	$addCŞumn
(
Sÿn
 
sÿn
, 
by‹
[] 
çmyAndQu®if›r
) {

87 
by‹
[][] 
fq
 = 
KeyV®ue
.
	`·r£CŞumn
(
çmyAndQu®if›r
);

88 ià(
fq
.
Ëngth
 > 1 && fq[1] !ğ
nuÎ
 && fq[1].length > 0) {

89 
sÿn
.
	`addCŞumn
(
fq
[0], fq[1]);

91 
sÿn
.
	`addFamy
(
fq
[0]);

93 
	}
}

107 
public
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
by‹
[][] 
cŞumns
) {

108 
by‹
[] 
cŞumn
 : 
cŞumns
) {

109 
	`addCŞumn
(
sÿn
, 
cŞumn
);

111 
	}
}

123 
´iv©e
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
SŒšg
 
cŞumns
) {

124 
SŒšg
[] 
cŞs
 = 
cŞumns
.
	`¥l™
(" ");

125 
SŒšg
 
cŞ
 : 
cŞs
) {

126 
	`addCŞumn
(
sÿn
, 
By‹s
.
	`toBy‹s
(
cŞ
));

128 
	}
}

130 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

131 
Œy
 {

132 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

133 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "webDB");

134 
sÿn
.
	`£tCachšg
(500);

135 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("F"), Bytes.toBytes("s"));

137 ià(
cÚf
.
	`g‘
("sÿn_f‹r"è!ğ
nuÎ
) {

138 
F‹r
 
f‹r
;

139 
Œy
 {

140 
P¬£F‹r
 
·r£
 = 
Ãw
 
	`P¬£F‹r
();

141 
f‹r
 = 
·r£
.
	`·r£F‹rSŒšg
(
cÚf
.
	`g‘
("scan_filter"));

142 
Sy¡em
.
out
.
	`´šn
("£ˆf‹¸" + 
cÚf
.
	`g‘
("scan_filter"));

143 
sÿn
.
	`£tF‹r
(
f‹r
);

144 } 
	`ÿtch
 (
Ch¬aù”CodšgExû±iÚ
 
e1
) {

146 
e1
.
	`´štSckT¿û
();

149 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
è!ğ
nuÎ
) {

150 
	`addCŞumns
(
sÿn
, 
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
));

153 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
è!ğ
nuÎ
) {

154 
sÿn
.
	`addFamy
(
By‹s
.
	`toBy‹s
(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
)));

156 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
è!ğ
nuÎ
) {

157 
sÿn
.
	`£tMaxV”siÚs
(
IÁeg”
.
	`·r£IÁ
(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
)));

161 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

162 
cÚf
.
	`£t
("mapred.map.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

163 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
Œue
);

164 
cÚf
.
	`£t
("mapred.output.compression.type", "BLOCK");

165 
cÚf
.
	`£t
("mapred.output.compression", "org.apache.hadoop.io.compress.SnappyCodec");

167 
cÚf
.
	`£t
(
TabËIÅutFÜm©
.
SCAN
, 
	`cÚv”tSÿnToSŒšg
(
sÿn
));

168 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

170 
TabËM­ReduûUt
.
	`š™TabËM­³rJob
(
bËName
, 
sÿn
, 
ExpÜtDocidM­³r
.
şass
, 
ImmubËBy‹sWr™abË
.şass, 
NuÎWr™abË
.şass, 
job
);

172 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

173 
job
.
	`£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

174 
job
.
	`£tM­S³cuÏtiveExecutiÚ
(
çl£
);

175 
job
.
	`£tReduûS³cuÏtiveExecutiÚ
(
Œue
);

176 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

177 
job
.
	`£tM­OuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

178 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

179 
job
.
	`£tOuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

180 
job
.
	`£tReduûrCÏss
(
ExpÜtDocidReduûr
.
şass
);

181 
num»duû
 = 
cÚf
.
	`g‘IÁ
("mapred.reduce.tasks", 0);

182 
job
.
	`£tNumReduûTasks
(
num»duû
);

183  
job
;

184 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

186 
e
.
	`´štSckT¿û
();

188  
nuÎ
;

189 
	}
}

191 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

192 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

193 
Œy
 {

194 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

195 
Job
 
job
 = 
ExpÜtDocid
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

196 ià(
Ùh”Args
.
Ëngth
 < 1) {

197 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage: outputpath SingleColumnValueFilter('F','s',=,'binary:5',true,true)");

198 
Sy¡em
.
	`ex™
(-1);

200 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

201 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

203 
e
.
	`´štSckT¿û
();

204 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

206 
e
.
	`´štSckT¿û
();

207 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

209 
e
.
	`´štSckT¿û
();

211 
	}
}

213 @
Ov”ride


214 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

216 
SŒšg
[] 
Ùh”Args
;

217 
Œy
 {

218 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
this
.
	`g‘CÚf
(), 
¬gs
).
	`g‘RemaššgArgs
();

219 
Job
 
job
 = 
ExpÜtDocid
.
	`ü—‹Subm™Job
(
this
.
	`g‘CÚf
(), 
Ùh”Args
);

220  
job
;

221 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

223 
e
.
	`´štSckT¿û
();

225  
nuÎ
;

226 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/ExportLinkInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gnio
.
	gBy‹Bufãr
;

5 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

6 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gSchema
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gSchema
.
	gF›ld
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gg’”ic
.
	gG’”icA¼ay
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gg’”ic
.
	gG’”icD©umR—d”
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gg’”ic
.
	gG’”icRecÜd
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gio
.
	gBš¬yDecod”
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gio
.
	gD©umR—d”
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	gavro
.
	gio
.
	gDecod”FaùÜy
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
.
	gCom´essiÚTy³
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

35 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gavro
.
	gP¬£rResuÉCÚv”‹r
;

38 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

39 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
.
	gMD5L’
;

40 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

41 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gURLUt
;

43 
public
 cÏs 
	cExpÜtLškInfo
 {

44 
public
 
şass
 
SÿnM­³r
 
ex‹nds
 
	mTabËM­³r
<
	mText
, 
	mNuÎWr™abË
> {

45 
	mby‹
[] 
	mf
 = 
By‹s
.
toBy‹s
("F");

46 
	mby‹
[] 
	mu
 = 
By‹s
.
toBy‹s
("u");

47 
	mby‹
[] 
	mh
 = 
By‹s
.
toBy‹s
("h");

48 
	mby‹
[] 
	mp
 = 
By‹s
.
toBy‹s
("P");

49 
	mby‹
[] 
	ml
 = 
By‹s
.
toBy‹s
("l");

50 
Schema
 
	m»cÜdSchema
;

51 
Schema
 
	m¬¿ySchema
;

52 
	mD©umR—d”
<
	mG’”icA¼ay
> 
	m¬¿yR—d”
;

53 
	mby‹
[] 
	mEMPTY_DOCID
 = 
Ãw
 
by‹
[] { 0, 0, 0, 0, 0, 0, 0, 0 };

54 
	mHashS‘
<
	mText
> 
	mdoicText
 = 
Ãw
 
HashS‘
<
Text
>();

56 
	mSchema
.
P¬£r
 
	m·r£r
 = 
Ãw
 
Schema
.Parser();

57 
	mŒy
 {

58 
	m»cÜdSchema
 = 
·r£r
.
·r£
(
P¬£rResuÉCÚv”‹r
.
şass
.
g‘ResourûAsSŒ—m
("resource/parser_data.avro"));

59 
F›ld
 
	md
 = 
»cÜdSchema
.
g‘F›ld
("parser_link");

60 
	mSy¡em
.
	mout
.
´šn
(
d
.
schema
());

61 
	m¬¿ySchema
 = 
d
.
schema
();

62 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

64 
	me
.
´štSckT¿û
();

68 @
Ov”ride


69 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

71 
	m¬¿yR—d”
 = 
Ãw
 
G’”icD©umR—d”
<
G’”icA¼ay
>(
¬¿ySchema
);

74 @
Ov”ride


75 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
ResuÉ
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

77 
by‹
 
	mrow
[] = 
key
.
g‘
();

78 
as£¹
 (
row
.
Ëngth
 == 8);

79 
by‹
 
	mho¡
[] = 
nuÎ
;

81 
by‹
 
	mu¾
[] = 
v®ue
.
g‘V®ue
(
f
, 
u
);

82 ià(
	mu¾
 =ğ
nuÎ
) {

83 
MD5
 
md5
 = 
nuÎ
;

84 
	mŒy
 {

85 
	mmd5
 = 
Ãw
 
MD5
(
row
, 
MD5L’
.
eight
, 0);

86 } 
ÿtch
 (
Exû±iÚ
 
e1
) {

88 
	me1
.
´štSckT¿û
();

90 
	mcÚ‹xt
.
g‘CouÁ”
("·r£_lšk", "em±y_u¾").
šüem’t
(1);

91 
	mLog
.
šfo
("row key=" + 
md5
.
g‘HexSŒšg
(
Œue
) + " url is‚ull");

94 
SŒšg
 
	msu¾
 = 
Ãw
 SŒšg(
u¾
);

95 
	mŒy
 {

96 
	mho¡
 = 
URLUt
.
g‘DomašName
(
su¾
).
g‘By‹s
();

97 } 
ÿtch
 (
Exû±iÚ
 
e
) {

98 
	me
.
´štSckT¿û
();

99 
MD5
 
	mmd5
 = 
nuÎ
;

100 
	mŒy
 {

101 
	mmd5
 = 
Ãw
 
MD5
(
row
, 
MD5L’
.
eight
, 0);

102 } 
ÿtch
 (
Exû±iÚ
 
e1
) {

104 
	me1
.
´štSckT¿û
();

106 
	mcÚ‹xt
.
g‘CouÁ”
("·r£_lšk", "”rÜ_u¾").
šüem’t
(1);

107 
	mLog
.
šfo
("row key=" + 
md5
.
g‘HexSŒšg
(è+ "\tu¾=" + 
su¾
 + "ƒnd");

111 ià(
	mho¡
 =ğ
nuÎ
) {

112 
cÚ‹xt
.
g‘CouÁ”
("·r£_lšk", "”rÜ_ho¡").
šüem’t
(1);

115 
by‹
 
	mlšk
[] = 
v®ue
.
g‘V®ue
(
p
, 
l
);

116 
by‹
 
	m¤cS™eId
[] = 
MD5
.
dige¡8
(
ho¡
).
g‘Dige¡
();

117 ià(
	mlšk
 !ğ
nuÎ
) {

118 
cÚ‹xt
.
g‘CouÁ”
("·r£_lšk", "have_lšk").
šüem’t
(1);

119 
	mthis
.
	mdoicText
.
ş—r
();

120 
Bš¬yDecod”
 
	mdecod”
 = 
Decod”FaùÜy
.
g‘
().
bš¬yDecod”
(
lšk
, 
nuÎ
);

121 
G’”icA¼ay
 
	m¬¿y
 = 
nuÎ
;

122 
	mŒy
 {

123 
	m¬¿y
 = 
¬¿yR—d”
.
»ad
(
¬¿y
, 
decod”
);

124 
	msize
 = 
¬¿y
.
size
();

128 
	mi
 = 0; i < 
	msize
; i++) {

129 
	mcÚ‹xt
.
g‘CouÁ”
("·r£_lšk", "ªchÜ_num").
šüem’t
(1);

130 
Objeù
 
	mo
 = 
¬¿y
.
g‘
(
i
);

131 ià(
o
 
š¡ªûof
 
	mG’”icRecÜd
) {

132 
By‹Bufãr
 
	mbufãr
 = (By‹Bufãrè(((
G’”icRecÜd
è
o
).
g‘
("url"));

133 
	mby‹
[] 
	mde¡u¾
 = 
bufãr
.
¬¿y
();

135 
by‹
 
	mde¡URLDocid
[] = 
MD5
.
dige¡8
(
de¡u¾
).
g‘Dige¡
();

136 
	mbufãr
 = (
By‹Bufãr
è(((
G’”icRecÜd
è
o
).
g‘
("host"));

138 
	mby‹
[] 
	mde¡ho¡
 = 
bufãr
.
¬¿y
();

139 
	mby‹
[] 
	mde¡Ho¡Id
 = 
MD5
.
dige¡8
(
de¡ho¡
).
g‘Dige¡
();

141 
	mbufãr
 = (
By‹Bufãr
è(((
G’”icRecÜd
è
o
).
g‘
("text"));

142 
	mby‹
[] 
	m¬chÜText
 = 
bufãr
.
¬¿y
();

148 
	mbufãr
 = (
By‹Bufãr
è(((
G’”icRecÜd
è
o
).
g‘
("source"));

149 
	mby‹
[] 
	msourû
 = 
bufãr
.
¬¿y
();

151 ià(
	msourû
 =ğ
nuÎ
 || 
sourû
.
Ëngth
 > 1 || source[0] > 9 || source[0] < 0)

154 
	msumL’
 = 2 + 
¬chÜText
.
Ëngth
 + 1 + 8 * 4;

155 ià(
	m¬chÜText
.
	mËngth
 > 32768) {

156 
	mLog
.
šfo
("”rÜ‡rchÜ†’" + 
¬chÜText
.
Ëngth
);

157 
	mLog
.
šfo
("¬chÜ " + 
Numb”Ut
.
g‘HexSŒšg
(
row
è+ "\toff£t=" + 
bufãr
.
¬¿yOff£t
(è+ "\Œemaš=" + bufãr.
»maššg
(è+ "\’=" + bufãr.
ÿ·c™y
() + "\tarch="

158 + 
Ãw
 
SŒšg
(
¬chÜText
, "gbk"));

159 
	mcÚ‹xt
.
g‘CouÁ”
("¥id”", "”rÜ_¬chÜ").
šüem’t
(1);

162 
by‹
 
	m»s
[] = 
Ãw
 by‹[
sumL’
];

163 
	moff£t
 = 0;

164 
by‹
 
	m¬chL’
[] = 
Numb”Ut
.
cÚv”tIÁToShÜtC
(
¬chÜText
.
Ëngth
);

165 
	mSy¡em
.
¬¿ycİy
(
¬chL’
, 0, 
»s
, 0, 2);

166 
	moff£t
 += 2;

167 
	mSy¡em
.
¬¿ycİy
(
¬chÜText
, 0, 
»s
, 2,‡rchÜText.
Ëngth
);

168 
	moff£t
 +ğ
¬chÜText
.
Ëngth
;

169 
	m»s
[
off£t
] = (
by‹
è((by‹è127 - (by‹è(
sourû
[0]));

170 
	moff£t
 += 1;

171 
	mSy¡em
.
¬¿ycİy
(
row
, 0, 
»s
, 
off£t
, 8);

172 
	moff£t
 += 8;

173 
	mSy¡em
.
¬¿ycİy
(
¤cS™eId
, 0, 
»s
, 
off£t
, 8);

174 
	moff£t
 += 8;

175 
	mSy¡em
.
¬¿ycİy
(
de¡URLDocid
, 0, 
»s
, 
off£t
, 8);

176 
	moff£t
 += 8;

177 
	mSy¡em
.
¬¿ycİy
(
de¡Ho¡Id
, 0, 
»s
, 
off£t
, 8);

178 
Text
 
	mk2
 = 
Ãw
 Text(
»s
);

179 ià(!
	mthis
.
	mdoicText
.
cÚšs
(
k2
)) {

180 
	mcÚ‹xt
.
wr™e
(
k2
, 
NuÎWr™abË
.
g‘
());

181 
	mcÚ‹xt
.
g‘CouÁ”
("·r£_lšk", "lšk").
šüem’t
(1);

182 
	mthis
.
	mdoicText
.
add
(
k2
);

186 } 
ÿtch
 (
Exû±iÚ
 
e
) {

187 
	me
.
´štSckT¿û
();

191 
	msumL’
 = 2 + 1 + 8 * 4;

192 
by‹
 
	m»s
[] = 
Ãw
 by‹[
sumL’
];

193 
	moff£t
 = 0;

194 
by‹
 
	m¬chL’
[] = 
Numb”Ut
.
cÚv”tIÁToShÜtC
(0);

195 
	mSy¡em
.
¬¿ycİy
(
¬chL’
, 0, 
»s
, 0, 2);

196 
	moff£t
 += 2;

197 
	m»s
[
off£t
] = 0;

198 
	moff£t
 += 1;

199 
	mSy¡em
.
¬¿ycİy
(
row
, 0, 
»s
, 
off£t
, 8);

200 
	moff£t
 += 8;

201 
	mSy¡em
.
¬¿ycİy
(
¤cS™eId
, 0, 
»s
, 
off£t
, 8);

202 
	moff£t
 += 8;

203 
	mSy¡em
.
¬¿ycİy
(
EMPTY_DOCID
, 0, 
»s
, 
off£t
, 8);

204 
	moff£t
 += 8;

205 
	mSy¡em
.
¬¿ycİy
(
EMPTY_DOCID
, 0, 
»s
, 
off£t
, 8);

206 
Text
 
	mk2
 = 
Ãw
 Text(
»s
);

207 
	mcÚ‹xt
.
wr™e
(
k2
, 
NuÎWr™abË
.
g‘
());

209 
	mcÚ‹xt
.
g‘CouÁ”
("·r£_lšk", "em±y_lšk").
šüem’t
(1);

215 
public
 
şass
 
SÿnReduûr
 
ex‹nds
 
	gReduûr
<
	gText
, 
	gNuÎWr™abË
, Text, NullWritable> {

217 @
Ov”ride


218 
´Ùeùed
 
»duû
(
Text
 
key
, 
I‹¿bË
<
NuÎWr™abË
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

220 
	gcÚ‹xt
.
wr™e
(
key
, 
NuÎWr™abË
.
g‘
());

225 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

226 
Œy
 {

227 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

228 
cÚf
.
	`£t
("mapred.map.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

229 
cÚf
.
	`£t
("m­»d.ouut.com´essiÚ.ty³", 
Com´essiÚTy³
.
BLOCK
.
	`toSŒšg
());

230 
cÚf
.
	`£t
("mapred.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

231 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

232 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

233 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "webDB");

234 
sÿn
.
	`£tCachšg
(500);

235 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("P"), Bytes.toBytes("h"));

236 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("P"), Bytes.toBytes("l"));

237 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("F"), Bytes.toBytes("u"));

238 ià(
cÚf
.
	`g‘
("sÿn_f‹r"è!ğ
nuÎ
) {

239 
F‹r
 
f‹r
;

240 
Œy
 {

241 
P¬£F‹r
 
·r£
 = 
Ãw
 
	`P¬£F‹r
();

242 
f‹r
 = 
·r£
.
	`·r£F‹rSŒšg
(
cÚf
.
	`g‘
("scan_filter"));

243 
Sy¡em
.
out
.
	`´šn
("£ˆf‹¸" + 
cÚf
.
	`g‘
("scan_filter"));

244 
sÿn
.
	`£tF‹r
(
f‹r
);

245 } 
	`ÿtch
 (
Ch¬aù”CodšgExû±iÚ
 
e1
) {

247 
e1
.
	`´štSckT¿û
();

250 
sÿn
.
	`£tMaxV”siÚs
(1);

251 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

252 
TabËM­ReduûUt
.
	`š™TabËM­³rJob
(
bËName
, 
sÿn
, 
SÿnM­³r
.
şass
, 
ImmubËBy‹sWr™abË
.şass, 
NuÎWr™abË
.şass, 
job
);

253 
job
.
	`£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

254 
job
.
	`£tM­OuutKeyCÏss
(
Text
.
şass
);

255 
job
.
	`£tM­OuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

256 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
Œue
);

257 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

258 
job
.
	`£tOuutKeyCÏss
(
Text
.
şass
);

259 
job
.
	`£tOuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

261 
job
.
	`£tNumReduûTasks
(0);

262  
job
;

263 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

265 
e
.
	`´štSckT¿û
();

267  
nuÎ
;

268 
	}
}

270 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

272 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

273 
Œy
 {

274 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

275 
Job
 
job
 = 
ExpÜtLškInfo
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

276 ià(
Ùh”Args
.
Ëngth
 < 1) {

277 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage: outputpath SingleColumnValueFilter('F','s',=,'binary:5',true,true)");

278 
Sy¡em
.
	`ex™
(-1);

280 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

281 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

283 
e
.
	`´štSckT¿û
();

284 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

286 
e
.
	`´štSckT¿û
();

287 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

289 
e
.
	`´štSckT¿û
();

291 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/FloatReverseComparator.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gFlßtWr™abË
;

4 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

6 
public
 cÏs 
	cFlßtRev”£Com·¿tÜ
 
ex‹nds
 
	mWr™abËCom·¿tÜ
 {

7 
public
 
	$FlßtRev”£Com·¿tÜ
() {

8 
	`su³r
(
FlßtWr™abË
.
şass
);

11 
public
 
	$com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

12 
thisV®ue
 = 
	`»adFlßt
(
b1
, 
s1
);

13 
th©V®ue
 = 
	`»adFlßt
(
b2
, 
s2
);

14  (
thisV®ue
 < 
th©V®ue
 ? 1 : (thisValue ==hatValue ? 0 : -1));

15 
	}
}

17 @
Ov”ride


18 
public
 
	$com·»
(
Objeù
 
a
, Objeù 
b
) {

20  -1 * 
su³r
.
	`com·»
(
a
, 
b
);

21 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/GenerateHFile.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

8 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

9 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

10 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

11 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

38 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

40 
public
 cÏs 
	cG’”©eHFe
 {

41 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

43 
public
 
şass
 
FeM­³r
 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	mKeyV®ue
> {

45 
by‹
 
	mP
[] = 
By‹s
.
toBy‹s
("P");

46 
by‹
 
	mÏ
[] = 
By‹s
.
toBy‹s
("la");

47 
by‹
 
	mF
[] = 
By‹s
.
toBy‹s
("F");

48 
by‹
 
	ma
[] = 
By‹s
.
toBy‹s
("a");

49 
by‹
 
	md
[] = 
By‹s
.
toBy‹s
("d");

50 
by‹
 
	mi
[] = 
By‹s
.
toBy‹s
("i");

51 
	mby‹
[] 
	mm
 = 
By‹s
.
toBy‹s
("m");

52 
	mby‹
 []
	me
=
By‹s
.
toBy‹s
("e");

53 
by‹
 
	mv
[];

55 @
Ov”ride


56 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

59 
	m£rŸl
 = 
IÁeg”
.
·r£IÁ
(
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘
("serialNum", "0000"));

60 
	mLog
.
šfo
("lßd s—rŸÈnum=" + 
£rŸl
);

61 
	mv
 = 
By‹s
.
toBy‹s
(
£rŸl
);

65 @
Ov”ride


66 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

68 
KeyV®ue
 
	mkv1
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
P
, 
Ï
, 
v
);

69 
	mcÚ‹xt
.
wr™e
(
key
, 
kv1
);

73 
şass
 
ImpÜtReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gKeyV®ue
, ImmutableBytesWritable, KeyValue> {

74 
	gLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

76 @
Ov”ride


77 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<
KeyV®ue
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

79 
	gkvLi¡
.
ş—r
();

80 
	gI‹¿tÜ
<
	gKeyV®ue
> 
	ge
 = 
v®ues
.
™”©Ü
();

81 
	gi
 = 0;

82 
	ge
.
hasNext
()) {

84 
	gcÚ‹xt
.
wr™e
(
key
, 
e
.
Ãxt
());

85 
	gi
++;

92 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
(è
throws
 
CÏssNÙFoundExû±iÚ
 {

93 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

94 
Œy
 {

95 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

96 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

97 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

99  
şazz
;

100 
	}
}

102 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
è
throws
 
IOExû±iÚ
 {

103 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

104 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 A¼ayLi¡<ImmubËBy‹sWr™abË>(
by‹Keys
.
Ëngth
);

105 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

106 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

108  
»t
;

109 
	}
}

111 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
è
throws
 
	gIOExû±iÚ
 {

112 ià(
	g¡¬tKeys
.
isEm±y
()) {

113 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

120 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(
¡¬tKeys
);

122 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

123 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

124 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("Fœ¡„egiÚ oàbË should havem±y s¹ key. In¡—d has: " + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

126 
	gsÜ‹d
.
»move
(
fœ¡
);

129 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

130 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

132 
	gŒy
 {

133 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

134 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

136 } 
	gfš®ly
 {

137 
	gwr™”
.
şo£
();

141 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

142 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

143 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

144 ià(
bËDesütÜ
 =ğ
nuÎ
) {

148 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

149 
i
 = 0;

150 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

151 ià(
i
++ > 0) {

152 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

154 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

155 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

156 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

159 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

160 
	}
}

162 
public
 
Job
 
	$run
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

167 
now
 = (è(
Sy¡em
.
	`cu¼’tTimeMlis
() / 1000);

169 
cÚf
.
	`£t
("£rŸlNum", 
SŒšg
.
	`v®ueOf
(
now
));

171 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
, "generate_import");

172 
P©h
 
š
 = 
Ãw
 
	`P©h
(
¬gs
[0]);

173 
P©h
 
out
 = 
Ãw
 
	`P©h
(
¬gs
[1]);

174 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
š
);

176 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
out
);

178 
job
.
	`£tM­³rCÏss
(
FeM­³r
.
şass
);

179 
job
.
	`£tReduûrCÏss
(
ImpÜtReduûr
.
şass
);

181 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

182 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

183 
job
.
	`£tM­OuutV®ueCÏss
(
KeyV®ue
.
şass
);

184 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

185 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

186 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

188 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

189 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

190 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

191 
Œy
 {

192 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

193 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

194 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

196 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

198 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

199 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

200 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

201 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

203 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

204 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

205 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

206 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

207 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

209 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

210 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

211 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

212 
Log
.
	`šfo
("Incrementalable output configured.");

213 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

214 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

216  
job
;

217 
	}
}

219 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

220 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

221 
SŒšg
[] 
Ùh”Args
;

222 
Œy
 {

223 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

224 ià(
Ùh”Args
.
Ëngth
 < 2) {

225 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
);

226 
Sy¡em
.
	`ex™
(-1);

228 
Job
 
job
 = 
	`run
(
cÚf
, 
Ùh”Args
);

229 
Sy¡em
.
	`ex™
(
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1);

230 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

232 
e
.
	`´štSckT¿û
();

233 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

235 
e
.
	`´štSckT¿û
();

238 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/GenerateImportFile.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

8 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

9 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

10 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

11 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

12 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
.
	gTy³
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

42 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

44 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

45 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
.
	gMD5L’
;

46 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gURLUt
;

47 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gP¬£ResuÉImpÜ‹r
.
	gP¬£ResuÉM­³r
;

48 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gP¬£ResuÉImpÜ‹r
.
	gP¬£ResuÉReduûr
;

50 
public
 cÏs 
	cG’”©eImpÜtFe
 {

51 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

53 
public
 
şass
 
FeM­³r
 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	mKeyV®ue
> {

54 
boŞ—n
 
	mkeyW™hFŞd”
 = 
çl£
;

55 
by‹
 
	m»s
[];

56 
by‹
 
	mh
[] = 
By‹s
.
toBy‹s
("H");

57 
by‹
 
	ms
[] = 
By‹s
.
toBy‹s
("s");

58 
by‹
 
	mu
[] = 
By‹s
.
toBy‹s
("u");

59 
by‹
 
	mf
[] = 
By‹s
.
toBy‹s
("F");

60 
boŞ—n
 
	mputSrc
 = 
çl£
;

62 @
Ov”ride


63 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

65 
CÚfigu¿tiÚ
 
	mcÚf
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
();

66 ià(
	mcÚf
.
g‘BoŞ—n
("u¾_ªd_ho¡", 
çl£
)) {

67 
	mthis
.
	mkeyW™hFŞd”
 = 
Œue
;

68 
	m»s
 = 
Ãw
 
by‹
[16];

70 
	m»s
 = 
Ãw
 
by‹
[8];

72 ià(
	mcÚf
.
g‘BoŞ—n
("put_html", 
çl£
)) {

73 
	mthis
.
	mputSrc
 = 
Œue
;

75 
	mthis
.
	mputSrc
 = 
çl£
;

79 @
Ov”ride


80 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

82 
SŒšg
 
	mu¾
 = 
Ãw
 SŒšg(
key
.
g‘
(), key.
g‘Off£t
(), key.
g‘L’gth
());

83 ià(!
	mu¾
.
m©ches
("http://.*sina.com.cn.*"))

85 ià(
	mthis
.
	mkeyW™hFŞd”
) {

86 
SŒšg
 
	mfŞd”
 = "";

87 ià(
	mu¾
.
Ï¡IndexOf
("/") != -1) {

88 
fŞd”
 = 
u¾
.
sub¡ršg
(0, u¾.
Ï¡IndexOf
("/"));

90 
	mfŞd”
 = 
u¾
;

93 
by‹
 
	ma
[] = 
MD5
.
dige¡8
(
fŞd”
.
g‘By‹s
()).
g‘Dige¡
();

94 
	mSy¡em
.
¬¿ycİy
(
a
, 0, 
»s
, 0, 8);

95 
by‹
 
	mdocid
[] = 
MD5
.
dige¡8
(
key
.
g‘
(), key.
g‘Off£t
(), key.
g‘L’gth
()).
g‘Dige¡
();

96 
	mSy¡em
.
¬¿ycİy
(
docid
, 0, 
»s
, 8, 8);

97 
ImmubËBy‹sWr™abË
 
	mk
 = 
Ãw
 ImmutableBytesWritable();

98 
	mk
.
£t
(
»s
, 0,„es.
Ëngth
);

99 
KeyV®ue
 
	mkv1
 = 
Ãw
 KeyV®ue(
»s
, 
f
, 
u
, 0, u.
Ëngth
, 
Sy¡em
.
cu¼’tTimeMlis
(), 
Ty³
.
Put
, 
key
.
g‘
(), key.
g‘Off£t
(), key.
g‘L’gth
());

100 
	mcÚ‹xt
.
wr™e
(
k
, 
kv1
);

101 
	mŒy
 {

102 
MD5
 
	mmd5
 = 
Ãw
 MD5(
»s
, 
MD5L’
.
six‹n
, 0);

103 
	mLog
.
šfo
("key u¾=" + 
md5
.
g‘HexSŒšg
(
Œue
));

104 } 
ÿtch
 (
Exû±iÚ
 
e
) {

106 
	me
.
´štSckT¿û
();

108 ià(
	mthis
.
	mputSrc
) {

109 
	mŒy
 {

110 
MD5
 
	mmd5
 = 
Ãw
 MD5(
»s
, 
MD5L’
.
six‹n
, 0);

111 
	mLog
.
šfo
("cÚ u¾=" + 
md5
.
g‘HexSŒšg
(
Œue
));

112 } 
ÿtch
 (
Exû±iÚ
 
e
) {

114 
	me
.
´štSckT¿û
();

116 
KeyV®ue
 
	mkv2
 = 
Ãw
 KeyV®ue(
»s
, 
h
, 
s
, 0, s.
Ëngth
, 
Sy¡em
.
cu¼’tTimeMlis
(), 
Ty³
.
Put
, 
v®ue
.
g‘
(), v®ue.
g‘Off£t
(), v®ue.
g‘L’gth
());

117 
	mcÚ‹xt
.
wr™e
(
k
, 
kv2
);

121 
by‹
 
	mdocid
[] = 
MD5
.
dige¡8
(
key
.
g‘
(), key.
g‘Off£t
(), key.
g‘L’gth
()).
g‘Dige¡
();

122 
	mSy¡em
.
¬¿ycİy
(
docid
, 0, 
»s
, 0, 8);

123 
ImmubËBy‹sWr™abË
 
	mk
 = 
Ãw
 ImmutableBytesWritable();

124 
	mk
.
£t
(
»s
);

125 
KeyV®ue
 
	mkv1
 = 
Ãw
 KeyV®ue(
»s
, 
f
, 
u
, 0, u.
Ëngth
, 
Sy¡em
.
cu¼’tTimeMlis
(), 
Ty³
.
Put
, 
key
.
g‘
(), key.
g‘Off£t
(), key.
g‘L’gth
());

126 
	mcÚ‹xt
.
wr™e
(
k
, 
kv1
);

127 ià(
	mthis
.
	mputSrc
) {

128 
KeyV®ue
 
	mkv2
 = 
Ãw
 KeyV®ue(
»s
, 
h
, 
s
, 0, s.
Ëngth
, 
Sy¡em
.
cu¼’tTimeMlis
(), 
Ty³
.
Put
, 
v®ue
.
g‘
(), v®ue.
g‘Off£t
(), v®ue.
g‘L’gth
());

129 
	mcÚ‹xt
.
wr™e
(
k
, 
kv2
);

136 
şass
 
ImpÜtHtmlReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gKeyV®ue
, ImmutableBytesWritable, KeyValue> {

137 
	gLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

139 @
Ov”ride


140 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<
KeyV®ue
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

142 
	gkvLi¡
.
ş—r
();

143 
	gI‹¿tÜ
<
	gKeyV®ue
> 
	ge
 = 
v®ues
.
™”©Ü
();

144 
	gi
 = 0;

145 
	ge
.
hasNext
()) {

147 
	gcÚ‹xt
.
wr™e
(
key
, 
e
.
Ãxt
());

148 
	gi
++;

150 
as£¹
 (
kvLi¡
.
size
() == 2);

156 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
(è
throws
 
CÏssNÙFoundExû±iÚ
 {

157 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

158 
Œy
 {

159 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

160 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

161 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

163  
şazz
;

164 
	}
}

166 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
è
throws
 
IOExû±iÚ
 {

167 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

168 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 A¼ayLi¡<ImmubËBy‹sWr™abË>(
by‹Keys
.
Ëngth
);

169 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

170 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

172  
»t
;

173 
	}
}

175 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
è
throws
 
	gIOExû±iÚ
 {

176 ià(
	g¡¬tKeys
.
isEm±y
()) {

177 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

184 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(
¡¬tKeys
);

186 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

187 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

188 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("Fœ¡„egiÚ oàbË should havem±y s¹ key. In¡—d has: " + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

190 
	gsÜ‹d
.
»move
(
fœ¡
);

193 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

194 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

196 
	gŒy
 {

197 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

198 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

200 } 
	gfš®ly
 {

201 
	gwr™”
.
şo£
();

205 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

206 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

207 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

208 ià(
bËDesütÜ
 =ğ
nuÎ
) {

212 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

213 
i
 = 0;

214 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

215 ià(
i
++ > 0) {

216 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

218 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

219 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

220 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

223 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

224 
	}
}

226 
public
 
Job
 
	$run
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

231 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
, "import_html");

232 
P©h
 
š
 = 
Ãw
 
	`P©h
(
¬gs
[0]);

233 
P©h
 
out
 = 
Ãw
 
	`P©h
(
¬gs
[1]);

234 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
š
);

236 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
out
);

238 
job
.
	`£tJobName
("import_html_job");

239 
job
.
	`£tM­³rCÏss
(
FeM­³r
.
şass
);

240 
job
.
	`£tReduûrCÏss
(
ImpÜtHtmlReduûr
.
şass
);

242 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

243 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

244 
job
.
	`£tM­OuutV®ueCÏss
(
KeyV®ue
.
şass
);

245 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

246 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

247 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

249 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webpage_1");

250 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

251 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

252 
Œy
 {

253 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

254 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

255 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

257 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

259 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

260 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

261 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

262 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

264 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

265 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

266 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

267 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

268 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

270 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

271 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

272 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

273 
Log
.
	`šfo
("Incrementalable output configured.");

274 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

275 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

277  
job
;

278 
	}
}

280 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

281 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

282 
SŒšg
[] 
Ùh”Args
;

283 
Œy
 {

284 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

285 ià(
Ùh”Args
.
Ëngth
 < 2) {

286 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
);

287 
Sy¡em
.
	`ex™
(-1);

289 
Job
 
job
 = 
	`run
(
cÚf
, 
Ùh”Args
);

290 
Sy¡em
.
	`ex™
(
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1);

291 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

293 
e
.
	`´štSckT¿û
();

294 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

296 
e
.
	`´štSckT¿û
();

299 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/GenerateURLData.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

7 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

8 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

9 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

10 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

11 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

12 
impÜt
 
	gjava
.
	gut
.
	gRªdom
;

13 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
.
	gCÚ‹xt
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

41 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

43 
public
 cÏs 
	cG’”©eURLD©a
 {

44 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

46 
public
 
şass
 
P¬£M­³r
 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, 
	mNuÎWr™abË
, ImmutableBytesWritable, NullWritable> {

48 @
Ov”ride


49 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

51 
	msu³r
.
£tup
(
cÚ‹xt
);

55 @
Ov”ride


56 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
NuÎWr™abË
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

58 
	mcÚ‹xt
.
wr™e
(
key
, 
NuÎWr™abË
.
g‘
());

63 
public
 
şass
 
P¬£Reduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gNuÎWr™abË
, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

64 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

65 
ImmubËBy‹sWr™abË
 
	gk2
 = 
Ãw
 ImmutableBytesWritable();

66 
Rªdom
 
	g¿nd
 = 
Ãw
 Random();

67 
by‹
 
	gnum
[] = "abcdefghijklmnİqr¡uvwxyz0123456789".
g‘By‹s
();

68 
SŒšgBufãr
 
	gbufãr
 = 
Ãw
 StringBuffer();

69 
´iv©e
 
	gby‹
[] 
	gf
 = 
By‹s
.
toBy‹s
("F");

70 
´iv©e
 
	gby‹
[] 
	gp
 = 
By‹s
.
toBy‹s
("P");

71 
´iv©e
 
	gby‹
[] 
	gh
 = 
By‹s
.
toBy‹s
("H");

72 
´iv©e
 
	gby‹
[] 
	gu
 = 
By‹s
.
toBy‹s
("u");

73 
´iv©e
 
	gby‹
[] 
	gl
 = 
By‹s
.
toBy‹s
("l");

74 
´iv©e
 
	gby‹
[] 
	gn
 = 
By‹s
.
toBy‹s
("n");

75 
´iv©e
 
	gby‹
[] 
	gs
 = 
By‹s
.
toBy‹s
("s");

76 
´iv©e
 
	gby‹
[] 
	gc
 = 
By‹s
.
toBy‹s
("c");

78 
´iv©e
 
	gby‹
[] 
	gyes
 = 
By‹s
.
toBy‹s
("1");

79 
´iv©e
 
	gby‹
[] 
	gno
 = 
By‹s
.
toBy‹s
("0");

81 
	gby‹
[] 
	ghtmlby‹s
 = 
Ãw
 
by‹
[1024 * 20];

82 
	gby‹
[] 
	g·r£dby‹s
 = 
Ãw
 
by‹
[1024];

84 
´iv©e
 
shufæe
() {

85 
	ghtmÎ’gth
 = 
htmlby‹s
.
Ëngth
;

87 
	gtimes
 = 
¿nd
.
ÃxtIÁ
(1000) + 1000;

88 
	ga
, 
	gb
;

89 
	gi
 = 0; i < 
	gtimes
; i++) {

90 
	ga
 = 
¿nd
.
ÃxtIÁ
(
htmÎ’gth
) % htmllength;

91 
	gb
 = 
¿nd
.
ÃxtIÁ
(
htmÎ’gth
) % htmllength;

92 ià(
	ga
 !ğ
b
) {

93 
by‹
 
c
 = 
htmlby‹s
[
a
];

94 
	ghtmlby‹s
[
a
] = 
htmlby‹s
[
b
];

95 
	ghtmlby‹s
[
b
] = 
c
;

98 
	g·r£dL’gth
 = 
·r£dby‹s
.
Ëngth
;

99 
	gtimes
 = 
¿nd
.
ÃxtIÁ
(100) + 100;

100 
	gi
 = 0; i < 
	g·r£dL’gth
; i++) {

101 
	ga
 = 
¿nd
.
ÃxtIÁ
(
·r£dL’gth
) %…arsedLength;

102 
	gb
 = 
¿nd
.
ÃxtIÁ
(
·r£dL’gth
) %…arsedLength;

103 ià(
	ga
 !ğ
b
) {

104 
by‹
 
c
 = 
·r£dby‹s
[
a
];

105 
	g·r£dby‹s
[
a
] = 
·r£dby‹s
[
b
];

106 
	g·r£dby‹s
[
b
] = 
c
;

112 @
Ov”ride


113 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

115 
	gsu³r
.
£tup
(
cÚ‹xt
);

117 
	ghtmÎ’gth
 = 
htmlby‹s
.
Ëngth
;

118 
	gi
 = 0; i < 
	ghtmÎ’gth
; i++) {

119 
	ghtmlby‹s
[
i
] = 
num
[
¿nd
.
ÃxtIÁ
Òum.
Ëngth
)];

121 
	g·r£dL’gth
 = 
·r£dby‹s
.
Ëngth
;

122 
	gi
 = 0; i < 
	g·r£dL’gth
; i++) {

123 
	g·r£dby‹s
[
i
] = 
num
[
¿nd
.
ÃxtIÁ
Òum.
Ëngth
)];

128 @
Ov”ride


129 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<
NuÎWr™abË
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

132 
	gthis
.
shufæe
();

133 
KeyV®ue
 
	gv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
p
, 
c
, 
this
.
·r£dby‹s
);

134 
	gkvLi¡
.
add
(
v
);

135 
	gi
 = 0;

137 
	gfšg”
 = 
¿nd
.
ÃxtLÚg
();

139 
	gv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
p
, 
f
, 
By‹s
.
toBy‹s
(
fšg”
));

140 
	gkvLi¡
.
add
(
v
);

141 ià(
	g¿nd
.
ÃxtIÁ
(4) == 0) {

142 
v
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
p
, 
l
, 
this
.
yes
);

143 
	gkvLi¡
.
add
(
v
);

145 
	gv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
p
, 
l
, 
this
.
no
);

146 
	gkvLi¡
.
add
(
v
);

148 ià(
	g¿nd
.
ÃxtIÁ
(3750) == 0) {

149 
v
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
p
, 
n
, 
this
.
yes
);

150 
	gkvLi¡
.
add
(
v
);

154 
	gv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
h
, 
s
, 
this
.
htmlby‹s
);

155 
	gkvLi¡
.
add
(
v
);

157 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

159 
KeyV®ue
 
	gv2
 : 
this
.
kvLi¡
) {

160 
cÚ‹xt
.
wr™e
(
key
, 
v2
);

162 
	gkvLi¡
.
ş—r
();

166 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
è
throws
 
IOExû±iÚ
 {

167 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

168 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 A¼ayLi¡<ImmubËBy‹sWr™abË>(
by‹Keys
.
Ëngth
);

169 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

170 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

172  
»t
;

173 
	}
}

175 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
è
throws
 
	gIOExû±iÚ
 {

176 ià(
	g¡¬tKeys
.
isEm±y
()) {

177 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

184 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(
¡¬tKeys
);

186 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

187 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

188 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("Fœ¡„egiÚ oàbË should havem±y s¹ key. In¡—d has: " + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

190 
	gsÜ‹d
.
»move
(
fœ¡
);

193 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

194 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

196 
	gŒy
 {

197 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

198 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

200 } 
	gfš®ly
 {

201 
	gwr™”
.
şo£
();

205 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

206 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

207 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

208 ià(
bËDesütÜ
 =ğ
nuÎ
) {

212 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

213 
i
 = 0;

214 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

215 ià(
i
++ > 0) {

216 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

218 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

219 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

220 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

223 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

224 
	}
}

226 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
(è
throws
 
CÏssNÙFoundExû±iÚ
 {

227 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

228 
Œy
 {

229 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

230 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

231 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

233  
şazz
;

234 
	}
}

236 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

237 
Œy
 {

238 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

239 
cÚf
.
	`£t
("mapred.map.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

240 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
Œue
);

241 
cÚf
.
	`£t
("mapred.output.compression.type", "BLOCK");

242 
cÚf
.
	`£t
("mapred.output.compression", "org.apache.hadoop.io.compress.SnappyCodec");

243 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

244 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

245 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

246 
job
.
	`£tM­³rCÏss
(
P¬£M­³r
.
şass
);

247 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

248 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

249 
job
.
	`£tM­OuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

252 
job
.
	`£tReduûrCÏss
(
P¬£Reduûr
.
şass
);

254 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

255 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

256 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

258 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webpage_2");

259 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

260 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

261 
Œy
 {

262 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

263 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

264 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

266 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

268 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

269 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

270 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

271 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

273 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

274 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

275 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

276 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

277 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

279 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

280 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

281 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

282 
Log
.
	`šfo
("Incrementalable output configured.");

283 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

284 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

285 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
com
.
googË
.
commÚ
.
ba£
.
P»cÚd™iÚs
.
şass
);

287  
job
;

288 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

290 
e
.
	`´štSckT¿û
();

291 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

293 
e
.
	`´štSckT¿û
();

295  
nuÎ
;

296 
	}
}

298 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

299 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

300 
Œy
 {

301 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

302 ià(
Ùh”Args
.
Ëngth
 < 2) {

303 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage:inputpath outputpath");

304 
Sy¡em
.
	`ex™
(-1);

306 
Job
 
job
 = 
G’”©eURLD©a
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

307 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

308 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

310 
e
.
	`´štSckT¿û
();

311 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

313 
e
.
	`´štSckT¿û
();

314 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

316 
e
.
	`´štSckT¿û
();

318 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/GenerateURLInfo.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

7 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

8 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

9 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

10 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

11 
impÜt
 
	gjava
.
	gut
.
	gRªdom
;

12 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gIÁWr™abË
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gLÚgWr™abË
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gTextIÅutFÜm©
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

42 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

44 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

46 
public
 cÏs 
	cG’”©eURLInfo
 {

47 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

49 
public
 
şass
 
P¬£M­³r
 
ex‹nds
 
	mM­³r
<
	mLÚgWr™abË
, 
	mText
, 
	mImmubËBy‹sWr™abË
, Text> {

50 
ImmubËBy‹sWr™abË
 
	mk2
 = 
Ãw
 ImmutableBytesWritable();

51 
Rªdom
 
	m¿nd
 = 
Ãw
 Random();

52 
Text
 
	mv2
 = 
Ãw
 Text();

53 
	mfŞd”R©iÚ
 = 0.2f;

54 
	mLi¡
<
	mSŒšg
> 
	mfŞd”Li¡
 = 
Ãw
 
LškedLi¡
<
SŒšg
>();

55 
	mnum
[] = "abcdefghijklmnİqr¡uvwxyz0123456789".
toCh¬A¼ay
();

56 
SŒšgBufãr
 
	mbufãr
 = 
Ãw
 StringBuffer();

58 @
Ov”ride


59 
´Ùeùed
 
m­
(
LÚgWr™abË
 
key
, 
Text
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

61 
SŒšg
 
	mu¾Info
 = 
v®ue
.
toSŒšg
();

62 
SŒšg
 
	ma
[] = 
u¾Info
.
¥l™
("\t");

63 
SŒšg
 
	mho¡
 = "h‰p://" + 
a
[0];

64 
	mu¾Num
 = 
IÁeg”
.
·r£IÁ
(
a
[1]);

65 
	mfŞd”Num
 = (è(
u¾Num
 * 
this
.
fŞd”R©iÚ
);

66 
	mfŞd”Li¡
.
ş—r
();

67 
	mj
 = 0; j < 
	mfŞd”Num
; j++) {

68 
	m¦ashNum
 = 
¿nd
.
ÃxtIÁ
(10);

69 
	mbufãr
.
£tL’gth
(0);

70 
	mbufãr
.
­³nd
(
ho¡
);

71 
	mbufãr
.
­³nd
("/");

72 
	mfŞd”Li¡
.
add
(
bufãr
.
toSŒšg
());

73 ià(
	m¦ashNum
 == 0)

75 
	mk
 = 0; k < 
	m¦ashNum
; k++) {

76 
	múum
 = 
¿nd
.
ÃxtIÁ
(6) + 1;

77 
	mm
 = 0; m < 
	múum
; m++) {

78 
	mbufãr
.
­³nd
(
num
[
¿nd
.
ÃxtIÁ
Òum.
Ëngth
)]);

80 
	mbufãr
.
­³nd
("/");

82 
	mfŞd”Li¡
.
add
(
bufãr
.
toSŒšg
());

85 
	mi
 = 0; i < 
	mu¾Num
; i++) {

86 
	mŠum
 = 
¿nd
.
ÃxtIÁ
(20) + 3;

87 
	mbufãr
.
£tL’gth
(0);

88 
	mbufãr
.
­³nd
(
fŞd”Li¡
.
g‘
(
¿nd
.
ÃxtIÁ
(fŞd”Li¡.
size
())));

89 
	mk
 = 0; k < 
	mŠum
; k++) {

90 
	mbufãr
.
­³nd
(
num
[
¿nd
.
ÃxtIÁ
Òum.
Ëngth
)]);

92 
MD5
 
	mmd5
 = MD5.
dige¡8
(
bufãr
.
toSŒšg
().
g‘By‹s
());

93 
	mk2
.
£t
(
md5
.
g‘Dige¡
());

94 
	mv2
.
£t
(
bufãr
.
toSŒšg
());

96 
	mcÚ‹xt
.
wr™e
(
k2
, 
v2
);

103 
public
 
şass
 
P¬£Reduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gText
, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

104 
´iv©e
 
	gby‹
[] 
	gf
 = 
By‹s
.
toBy‹s
("F");

105 
´iv©e
 
	gby‹
[] 
	gp
 = 
By‹s
.
toBy‹s
("P");

106 
´iv©e
 
	gby‹
[] 
	gh
 = 
By‹s
.
toBy‹s
("H");

107 
´iv©e
 
	gby‹
[] 
	gu
 = 
By‹s
.
toBy‹s
("u");

109 @
Ov”ride


110 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<
Text
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

112 
Text
 
	gv
 : 
v®ues
) {

113 
KeyV®ue
 
kv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
f
, 
u
, 
v
.
g‘By‹s
());

114 
	gcÚ‹xt
.
wr™e
(
key
, 
kv
);

119 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
è
throws
 
IOExû±iÚ
 {

120 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

121 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 A¼ayLi¡<ImmubËBy‹sWr™abË>(
by‹Keys
.
Ëngth
);

122 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

123 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

125  
»t
;

126 
	}
}

128 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
è
throws
 
	gIOExû±iÚ
 {

129 ià(
	g¡¬tKeys
.
isEm±y
()) {

130 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

137 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(
¡¬tKeys
);

139 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

140 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

141 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("Fœ¡„egiÚ oàbË should havem±y s¹ key. In¡—d has: " + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

143 
	gsÜ‹d
.
»move
(
fœ¡
);

146 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

147 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

149 
	gŒy
 {

150 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

151 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

153 } 
	gfš®ly
 {

154 
	gwr™”
.
şo£
();

158 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

159 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

160 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

161 ià(
bËDesütÜ
 =ğ
nuÎ
) {

165 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

166 
i
 = 0;

167 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

168 ià(
i
++ > 0) {

169 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

171 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

172 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

173 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

176 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

177 
	}
}

180 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
(è
throws
 
CÏssNÙFoundExû±iÚ
 {

181 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

182 
Œy
 {

183 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

184 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

185 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

187  
şazz
;

188 
	}
}

191 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

192 
Œy
 {

193 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

194 
cÚf
.
	`£t
("mapred.map.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

195 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
Œue
);

196 
cÚf
.
	`£t
("mapred.output.compression.type", "BLOCK");

197 
cÚf
.
	`£t
("mapred.output.compression", "org.apache.hadoop.io.compress.SnappyCodec");

198 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

199 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

200 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

201 
job
.
	`£tM­³rCÏss
(
P¬£M­³r
.
şass
);

202 
job
.
	`£tIÅutFÜm©CÏss
(
TextIÅutFÜm©
.
şass
);

203 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

204 
job
.
	`£tM­OuutV®ueCÏss
(
Text
.
şass
);

207 
job
.
	`£tReduûrCÏss
(
P¬£Reduûr
.
şass
);

209 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

210 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

211 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

213 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webpage");

214 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

215 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

216 
Œy
 {

217 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

218 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

219 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

221 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

223 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

224 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

225 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

226 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

228 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

229 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

230 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

231 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

232 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

234 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

235 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

236 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

237 
Log
.
	`šfo
("Incrementalable output configured.");

238 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

239 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

240 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
.
	`g‘CÚfigu¿tiÚ
(),
com
.
googË
.
commÚ
.
ba£
.
P»cÚd™iÚs
.
şass
);

242  
job
;

243 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

245 
e
.
	`´štSckT¿û
();

246 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

248 
e
.
	`´štSckT¿û
();

250  
nuÎ
;

251 
	}
}

253 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

254 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

255 
Œy
 {

256 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

257 ià(
Ùh”Args
.
Ëngth
 < 2) {

258 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage:inputpath outputpath");

259 
Sy¡em
.
	`ex™
(-1);

261 
Job
 
job
 = 
G’”©eURLInfo
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

262 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

263 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

265 
e
.
	`´štSckT¿û
();

266 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

268 
e
.
	`´štSckT¿û
();

269 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

271 
e
.
	`´štSckT¿û
();

273 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/HBLoadFlagUpdater.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

6 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

7 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

8 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

9 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

33 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

35 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

43 
public
 cÏs 
	cHBLßdFÏgUpd©”
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

49 
şass
 
ModifyLi¡M­³r


50 
ex‹nds


51 
	mM­³r
<
	mImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	mKeyV®ue
> {

52 
´iv©e
 
	mby‹
[] 
	mts
;

53 
´iv©e
 
	mby‹
[] 
	mP
 = 
By‹s
.
toBy‹s
("P");

54 
´iv©e
 
	mby‹
[] 
	mÏ
 = 
By‹s
.
toBy‹s
("la");

55 
´iv©e
 
	mby‹
[] 
	mz”o
 = 
By‹s
.
toBy‹s
("0");

57 @
Ov”ride


58 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
,

59 
	mIÁ”ru±edExû±iÚ
 {

61 
	mtime¡amp
 = 
IÁeg”
.
·r£IÁ
(
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘
(

63 
	mts
 = 
By‹s
.
toBy‹s
(
time¡amp
);

66 @
Ov”ride


67 
public
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

68 
ImmubËBy‹sWr™abË
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

69 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

70 
KeyV®ue
 
	mkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
P
, 
Ï
, 
z”o
);

71 
	mcÚ‹xt
.
wr™e
(
key
, 
kv
);

72 
	mcÚ‹xt
.
g‘CouÁ”
("hfe_lßd", "modify").
šüem’t
(1);

80 
şass
 
LßdLi¡M­³r


81 
ex‹nds


82 
	gM­³r
<
	gImmubËBy‹sWr™abË
, 
	gNuÎWr™abË
, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

84 
´iv©e
 
	gby‹
[] 
	gts
;

85 
´iv©e
 
	gby‹
[] 
	gP
 = 
By‹s
.
toBy‹s
("P");

86 
´iv©e
 
	gby‹
[] 
	gÏ
 = 
By‹s
.
toBy‹s
("la");

88 @
Ov”ride


89 
public
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

90 
	gIÁ”ru±edExû±iÚ
 {

91 
	gtime¡amp
 = 
IÁeg”
.
·r£IÁ
(
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘
(

93 
	gts
 = 
By‹s
.
toBy‹s
(
time¡amp
);

96 @
Ov”ride


97 
public
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
NuÎWr™abË
 
v®ue
,

98 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

99 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
P
, 
Ï
, 
ts
);

100 
	gcÚ‹xt
.
wr™e
(
key
, 
kv
);

101 
	gcÚ‹xt
.
g‘CouÁ”
("hfe_lßd", "lßd").
šüem’t
(1);

113 
şass
 
LßdFšg”M­³r


114 
ex‹nds


115 
	gM­³r
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

117 
´iv©e
 
	gby‹
[] 
	gP
 = 
By‹s
.
toBy‹s
("P");

118 
´iv©e
 
	gby‹
[] 
	gf
 = 
By‹s
.
toBy‹s
("f");

120 @
Ov”ride


121 
public
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

122 
	gIÁ”ru±edExû±iÚ
 {

126 @
Ov”ride


127 
public
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

128 
ImmubËBy‹sWr™abË
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

129 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

130 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
P
, 
f
, 
v®ue
.get());

131 
	gcÚ‹xt
.
wr™e
(
key
, 
kv
);

132 
	gcÚ‹xt
.
g‘CouÁ”
("hfe_lßd", "fšg”").
šüem’t
(1);

136 
şass
 
HFeG’”©eReduûr


137 
ex‹nds


138 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gKeyV®ue
, ImmutableBytesWritable, KeyValue> {

139 
	gLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

141 @
Ov”ride


142 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
,

143 
I‹¿bË
<
KeyV®ue
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

144 
	gIÁ”ru±edExû±iÚ
 {

145 
	gkvLi¡
.
ş—r
();

146 
KeyV®ue
 
	gv®ue
 : 
v®ues
) {

148 
kvLi¡
.
add
(
v®ue
.
şÚe
());

150 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

151 
KeyV®ue
 
	gkv
 : 
kvLi¡
) {

152 
cÚ‹xt
.
wr™e
(
key
, 
kv
);

158 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
()

159 
throws
 
CÏssNÙFoundExû±iÚ
 {

160 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

161 
Œy
 {

162 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

163 .
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

164 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

165 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

166 .
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

168  
şazz
;

169 
	}
}

175 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
)

176 
throws
 
IOExû±iÚ
 {

177 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

178 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 ArrayList<ImmutableBytesWritable>(

179 
by‹Keys
.
Ëngth
);

180 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

181 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

183  
»t
;

184 
	}
}

195 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
,

196 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
)

197 
throws
 
	gIOExû±iÚ
 {

198 ià(
	g¡¬tKeys
.
isEm±y
()) {

199 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

206 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(

207 
¡¬tKeys
);

209 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

210 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

211 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
(

213 + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

215 
	gsÜ‹d
.
»move
(
fœ¡
);

218 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

219 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
,

220 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
,

221 
NuÎWr™abË
.
şass
);

223 
	gŒy
 {

224 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

225 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

227 } 
	gfš®ly
 {

228 
	gwr™”
.
şo£
();

232 
public
 
Job
 
	$ü—‹Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[])

233 
throws
 
Exû±iÚ
 {

234 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

235 
job
.
	`£tJ¬ByCÏss
(
HBLßdFÏgUpd©”
.
şass
);

236 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]),

237 
Sequ’ûFeIÅutFÜm©
.
şass
, 
ModifyLi¡M­³r
.class);

238 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]),

239 
Sequ’ûFeIÅutFÜm©
.
şass
, 
LßdLi¡M­³r
.class);

240 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[2]),

241 
Sequ’ûFeIÅutFÜm©
.
şass
, 
LßdFšg”M­³r
.class);

242 
job
.
	`£tReduûrCÏss
(
HFeG’”©eReduûr
.
şass
);

243 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

244 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

245 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

246 
HFeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[3]));

248 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "webDB");

249 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

251 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

252 
Œy
 {

253 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

254 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

255 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

257 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

259 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

260 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

261 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions "

263 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

265 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "partitions_"

266 + 
Sy¡em
.
	`cu¼’tTimeMlis
());

267 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

269 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

271 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

272 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(),

273 
·¹™iÚsP©h
);

275 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

276 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

277 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

278 
Log
.
	`šfo
("Incrementalable output configured.");

280 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

286  
job
;

287 
	}
}

289 @
Ov”ride


290 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

292 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

293 
SŒšg
[] 
Ùh”Args
;

294 
Œy
 {

295 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

296 ià(
Ùh”Args
.
Ëngth
 < 3) {

297 
Sy¡em
.
out
.
	`´šn
("Wrong‚umber of‡rguments: "

298 + 
Ùh”Args
.
Ëngth
 + " modifylist†oadlist output");

299 
Sy¡em
.
	`ex™
(-1);

301 
Job
 
job
 = 
	`ü—‹Job
(
cÚf
, 
Ùh”Args
);

302  
job
;

303 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

305 
e
.
	`´štSckT¿û
();

306 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

308 
e
.
	`´štSckT¿û
();

310  
nuÎ
;

311 
	}
}

313 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

315 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/HostStatistic.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

7 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

8 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËIÅutFÜm©
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿tÜ
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËUts
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gTextOuutFÜm©
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

35 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

38 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

39 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gURLUt
;

40 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gHo¡Info
;

42 şas 
	cHo¡InfoGroupCom·¿tÜ
 
ex‹nds
 
	mWr™abËCom·¿tÜ
 {

44 
´Ùeùed
 
	$Ho¡InfoGroupCom·¿tÜ
() {

45 
	`su³r
(
Ho¡Info
.
şass
, 
Œue
);

48 @
Ov”ride


49 
public
 
	$com·»
(
by‹
[] 
b1
, 
s1
, 
l1
, by‹[] 
b2
, 
s2
, 
l2
) {

50 
i
 = 
	`com·»By‹s
(
b1
, 
s1
, 8, 
b2
, 
s2
, 8);

51  
i
;

52 
	}
}

56 
şass
 
Ho¡InfoP¬t™iÚ
 
ex‹nds
 
	gP¬t™iÚ”
<
	gHo¡Info
, 
	gText
> {

58 @
Ov”ride


59 
public
 
g‘P¬t™iÚ
(
Ho¡Info
 
key
, 
Text
 
v®ue
, 
numP¬t™iÚs
) {

60  
	gM©h
.
abs
(
By‹s
.
toSŒšg
(
key
.
g‘Domaš
()).
hashCode
(è* 127è% 
	gnumP¬t™iÚs
;

65 
public
 cÏs 
	cHo¡Sti¡ic
 {

66 
public
 
şass
 
SÿnHo¡M­³r
 
ex‹nds
 
	mTabËM­³r
<
	mHo¡Info
, 
	mText
> {

67 
	mby‹
[] 
	mH
 = 
By‹s
.
toBy‹s
("H");

68 
	mby‹
[] 
	mh
 = 
By‹s
.
toBy‹s
("h");

70 
Ho¡Info
 
	mšfo
 = 
Ãw
 HostInfo();

72 @
Ov”ride


73 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
ResuÉ
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

75 
by‹
 
	mho¡by‹s
[] = 
v®ue
.
g‘V®ue
(
H
, 
h
);

76 
SŒšg
 
	mho¡
 = 
Ãw
 SŒšg(
ho¡by‹s
);

77 ià(
	mho¡
.
Ëngth
(è=ğ0 || 
ho¡
.
g‘By‹s
().Ëngth !ğ
ho¡by‹s
.length) {

78 
Log
.
šfo
("”rÜ ho¡" + 
ho¡
 + "\ˆ¤øby‹s=" + 
Numb”Ut
.
g‘HexSŒšg
(
ho¡by‹s
));

79 
	mcÚ‹xt
.
g‘CouÁ”
("ho¡DB", "”rÜHo¡").
šüem’t
(1);

82 
SŒšg
 
	mdomaš
 = 
URLUt
.
g‘DomašByHo¡
(
ho¡
);

83 ià(
	mdomaš
 =ğ
nuÎ
) {

84 
Log
.
šfo
("domaš i nuÎ" + 
ho¡
);

87 
by‹
 
	mdige¡
[] = 
MD5
.
dige¡8
(
domaš
.
g‘By‹s
()).
g‘Dige¡
();

88 
	mšfo
.
£tDomaš
(
dige¡
);

89 
SŒšg
 
	m»v”£Ho¡
 = 
URLUt
.
ho¡Rev”£
(
ho¡
);

90 
	mšfo
.
£tHo¡
(
»v”£Ho¡
.
g‘By‹s
());

91 
	mcÚ‹xt
.
wr™e
(
šfo
, 
Ãw
 
Text
(šfo.
g‘Ho¡
()));

96 
public
 
şass
 
SÿnHo¡Reduûr
 
ex‹nds
 
	gReduûr
<
	gHo¡Info
, 
	gText
, Text, 
	gNuÎWr™abË
> {

98 
´iv©e
 
MuÉËOuuts
 
	gmos
;

100 
	gmaxLev–OÃHo¡
 = 1000;

101 
	gmaxLev–TwoHo¡
 = 100;

103 
	gHashS‘
<
	gSŒšg
> 
	gblÿkHo¡
 = 
Ãw
 
HashS‘
<
SŒšg
>();

105 @
Ov”ride


106 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

108 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

109 
	gmos
.
şo£
();

112 @
Ov”ride


113 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

115 
	gsu³r
.
£tup
(
cÚ‹xt
);

116 
	gmos
 = 
Ãw
 
MuÉËOuuts
(
cÚ‹xt
);

117 
	gthis
.
	gmaxLev–OÃHo¡
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘IÁ
("max_level_one_host", 2500);

118 
	gthis
.
	gmaxLev–TwoHo¡
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘IÁ
("max_level_two_host", 500);

122 @
Ov”ride


123 
´Ùeùed
 
»duû
(
Ho¡Info
 
key
, 
I‹¿bË
<
Text
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

125 
	gthis
.
	gblÿkHo¡
.
ş—r
();

126 
	gI‹¿tÜ
<
	gText
> 
	g™
 = 
v®ues
.
™”©Ü
();

127 
SŒšg
 
	gdomaš
 = "";

128 
SŒšg
 
	g»v”£Domaš
 = "";

129 
SŒšg
 
	gho¡
 = "";

130 
boŞ—n
 
	gfœ¡
 = 
Œue
;

131 
SŒšg
 
	gÏ¡Lev–OÃHo¡
 = "";

132 
SŒšg
 
	gÏ¡Lev–TwoHo¡
 = "";

133 
	gËv–OÃHo¡Num
 = 0;

134 
	gËv–TwoHo¡Num
 = 0;

136 
	g™
.
hasNext
()) {

137 
Text
 
	go
 = 
™
.
Ãxt
();

138 
	gho¡
 = 
o
.
toSŒšg
();

139 ià(
	gfœ¡
) {

140 
	gdomaš
 = 
URLUt
.
g‘DomašByHo¡
(URLUt.
ho¡Rev”£
(
o
.
toSŒšg
()));

141 
	g»v”£Domaš
 = 
URLUt
.
ho¡Rev”£
(
domaš
);

142 
	gfœ¡
 = 
çl£
;

145 ià(
	gho¡
.
Ëngth
(è=ğ
»v”£Domaš
.Ëngth(è&& 
ho¡
.
equ®s
(reverseDomain)) {

146 ià(!
Ï¡Lev–OÃHo¡
.
equ®s
(
ho¡
)) {

147 
Ï¡Lev–OÃHo¡
 = 
ho¡
;

148 
	gËv–OÃHo¡Num
++;

149 
	gËv–TwoHo¡Num
 = 0;

150 
	gLog
.
šfo
("fšd†ev– oÃ ho¡ " + 
ho¡
 + "\t" + 
Ëv–OÃHo¡Num
 + "\t" + 
domaš
);

151 ià(
	gËv–OÃHo¡Num
 > 
	gthis
.
	gmaxLev–OÃHo¡
) {

152 
	gLog
.
šfo
("exûed max‚um oàËv– oÃ ho¡" + 
domaš
 + "\t" + 
this
.
maxLev–OÃHo¡
 + "\t" + 
Ëv–OÃHo¡Num
);

153 
	gmos
.
wr™e
("bÏckdomaš", 
Ãw
 
Text
(
domaš
), 
NuÎWr™abË
.
g‘
());

161 
	gt
 = 
ho¡
.
šdexOf
(
»v”£Domaš
);

162 ià(
	gt
 == -1) {

163 
Log
.
šfo
("”rÜ ho¡ " + 
ho¡
 + "\t" + 
»v”£Domaš
);

164 
	gcÚ‹xt
.
g‘CouÁ”
("ho¡¡©", "”rÜ_ho¡").
šüem’t
(1);

168 ià(
	gho¡
.
Ëngth
(è<ğ
»v”£Domaš
.length() + 1) {

172 
	gËv–OÃDÙ
 = 
ho¡
.
šdexOf
(".", 
»v”£Domaš
.
Ëngth
() + 1);

175 ià(
	gËv–OÃDÙ
 == -1) {

177 ià(
this
.
blÿkHo¡
.
cÚšs
(
ho¡
))

179 ià(!
	gÏ¡Lev–OÃHo¡
.
equ®s
(
ho¡
)) {

180 
	gÏ¡Lev–OÃHo¡
 = 
ho¡
;

181 
	gËv–OÃHo¡Num
++;

182 
	gLog
.
šfo
("fšd†ev– oÃ ho¡ " + 
Ï¡Lev–OÃHo¡
 + "\ev– oÃ‚um=" + 
Ëv–OÃHo¡Num
 + "\tdomaš=" + 
domaš
 + "\a¡Lev–twoNum" + 
Ëv–TwoHo¡Num
);

183 
	gËv–TwoHo¡Num
 = 0;

184 ià(
	gËv–OÃHo¡Num
 > 
	gthis
.
	gmaxLev–OÃHo¡
) {

185 
	gLog
.
šfo
("exûed max‚um oàËv– oÃ ho¡" + 
domaš
 + "\t" + 
this
.
maxLev–OÃHo¡
 + "\t" + 
Ëv–OÃHo¡Num
);

186 
	gmos
.
wr™e
("bÏckdomaš", 
Ãw
 
Text
(
domaš
), 
NuÎWr™abË
.
g‘
());

192 
SŒšg
 
	gËv–OÃHo¡
 = 
ho¡
.
sub¡ršg
(0, 
Ëv–OÃDÙ
);

194 ià(
	gthis
.
	gblÿkHo¡
.
cÚšs
(
Ëv–OÃHo¡
))

196 ià(!
	gËv–OÃHo¡
.
equ®s
(
Ï¡Lev–OÃHo¡
)) {

197 
	gÏ¡Lev–OÃHo¡
 = 
Ëv–OÃHo¡
;

198 
	gËv–OÃHo¡Num
++;

199 
	gLog
.
šfo
("fšd†ev– oÃ ho¡ " + 
Ï¡Lev–OÃHo¡
 + "ho¡=" + 
ho¡
 + "\ev– oÃ‚um=" + 
Ëv–OÃHo¡Num
 + "\tdomaš=" + 
domaš
 + "\a¡Lev–twoNum" + 
Ëv–TwoHo¡Num
);

200 
	gËv–TwoHo¡Num
 = 0;

201 ià(
	gËv–OÃHo¡Num
 > 
	gthis
.
	gmaxLev–OÃHo¡
) {

202 
	gLog
.
šfo
("exûed max‚um oàËv– oÃ ho¡" + 
domaš
 + "\t" + 
this
.
maxLev–OÃHo¡
 + "\t" + 
Ëv–OÃHo¡Num
);

203 
	gmos
.
wr™e
("bÏckdomaš", 
Ãw
 
Text
(
domaš
), 
NuÎWr™abË
.
g‘
());

208 ià(
	gho¡
.
Ëngth
(è> 
	gËv–OÃHo¡
.length() + 1) {

209 
	gËv–TwoDÙ
 = 
ho¡
.
šdexOf
(".", 
Ëv–OÃHo¡
.
Ëngth
() + 1);

210 
SŒšg
 
	gËv–TwoHo¡
 = "";

211 ià(
	gËv–TwoDÙ
 == -1) {

212 
Ëv–TwoHo¡
 = 
ho¡
;

214 
	gËv–TwoHo¡
 = 
ho¡
.
sub¡ršg
(0, 
Ëv–TwoDÙ
);

217 
	gËv–TwoHo¡Num
++;

218 
	gLog
.
šfo
("fšd†ev–wØho¡ " + 
Ëv–TwoHo¡
 + " ho¡ " + 
ho¡
 + "\ˆËv– oÃ ho¡=" + 
Ëv–OÃHo¡
 + "†ev– oÃ‚um=" + 
Ëv–OÃHo¡Num
 + "\tlevelwo‚um="

219 + 
Ëv–TwoHo¡Num
 + "\tdomaš=" + 
domaš
);

220 ià(
	gËv–TwoHo¡Num
 > 
	gthis
.
	gmaxLev–TwoHo¡
) {

221 
	gblÿkHo¡
.
add
(
Ëv–OÃHo¡
);

222 
	gLog
.
šfo
("exûed max‚um oàËv–wØho¡ " + 
Ëv–OÃHo¡
 + "\ev– oÃ‚um=" + 
Ëv–OÃHo¡Num
 + "\ev–wØnum=" + 
Ëv–TwoHo¡Num
);

223 
	gcÚ‹xt
.
wr™e
(
Ãw
 
Text
(
URLUt
.
ho¡Rev”£
(
Ï¡Lev–OÃHo¡
)), 
NuÎWr™abË
.
g‘
());

231 ià(
	gËv–OÃHo¡Num
 > 
	gthis
.
	gmaxLev–OÃHo¡
) {

232 
	gLog
.
šfo
("exûed max‚um oàËv– oÃ ho¡" + 
domaš
 + "\t" + 
this
.
maxLev–OÃHo¡
 + "\t" + 
Ëv–OÃHo¡Num
);

233 
	gmos
.
wr™e
("bÏckdomaš", 
Ãw
 
Text
(
domaš
), 
NuÎWr™abË
.
g‘
());

240 
SŒšg
 
	$cÚv”tSÿnToSŒšg
(
Sÿn
 
sÿn
è
throws
 
IOExû±iÚ
 {

241 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

242 
D©aOuutSŒ—m
 
dos
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

243 
sÿn
.
	`wr™e
(
dos
);

244  
Ba£64
.
	`’codeBy‹s
(
out
.
	`toBy‹A¼ay
());

245 
	}
}

260 
´iv©e
 
	$addCŞumn
(
Sÿn
 
sÿn
, 
by‹
[] 
çmyAndQu®if›r
) {

261 
by‹
[][] 
fq
 = 
KeyV®ue
.
	`·r£CŞumn
(
çmyAndQu®if›r
);

262 ià(
fq
.
Ëngth
 > 1 && fq[1] !ğ
nuÎ
 && fq[1].length > 0) {

263 
sÿn
.
	`addCŞumn
(
fq
[0], fq[1]);

265 
sÿn
.
	`addFamy
(
fq
[0]);

267 
	}
}

281 
public
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
by‹
[][] 
cŞumns
) {

282 
by‹
[] 
cŞumn
 : 
cŞumns
) {

283 
	`addCŞumn
(
sÿn
, 
cŞumn
);

285 
	}
}

297 
´iv©e
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
SŒšg
 
cŞumns
) {

298 
SŒšg
[] 
cŞs
 = 
cŞumns
.
	`¥l™
(" ");

299 
SŒšg
 
cŞ
 : 
cŞs
) {

300 
	`addCŞumn
(
sÿn
, 
By‹s
.
	`toBy‹s
(
cŞ
));

302 
	}
}

304 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

305 
Œy
 {

307 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

308 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "hostDB");

309 
sÿn
.
	`£tCachšg
(500);

315 ià(
cÚf
.
	`g‘
("sÿn_f‹r"è!ğ
nuÎ
) {

316 
F‹r
 
f‹r
;

317 
Œy
 {

318 
P¬£F‹r
 
·r£
 = 
Ãw
 
	`P¬£F‹r
();

319 
f‹r
 = 
·r£
.
	`·r£F‹rSŒšg
(
cÚf
.
	`g‘
("scan_filter"));

320 
Sy¡em
.
out
.
	`´šn
("£ˆf‹¸" + 
cÚf
.
	`g‘
("scan_filter"));

321 
sÿn
.
	`£tF‹r
(
f‹r
);

322 } 
	`ÿtch
 (
Ch¬aù”CodšgExû±iÚ
 
e1
) {

323 
e1
.
	`´štSckT¿û
();

326 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
è!ğ
nuÎ
) {

327 
	`addCŞumns
(
sÿn
, 
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
));

329 
	`addCŞumns
(
sÿn
, "H:h");

332 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
è!ğ
nuÎ
) {

333 
sÿn
.
	`addFamy
(
By‹s
.
	`toBy‹s
(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
)));

335 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
è!ğ
nuÎ
) {

336 
sÿn
.
	`£tMaxV”siÚs
(
IÁeg”
.
	`·r£IÁ
(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
)));

340 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

341 
cÚf
.
	`£t
("mapred.map.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

342 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
çl£
);

343 
cÚf
.
	`£t
("mapred.output.compression.type", "BLOCK");

344 
cÚf
.
	`£t
("mapred.output.compression", "org.apache.hadoop.io.compress.SnappyCodec");

346 
cÚf
.
	`£t
(
TabËIÅutFÜm©
.
SCAN
, 
	`cÚv”tSÿnToSŒšg
(
sÿn
));

347 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

349 
TabËM­ReduûUt
.
	`š™TabËM­³rJob
(
bËName
, 
sÿn
, 
SÿnHo¡M­³r
.
şass
, 
Ho¡Info
.şass, 
Text
.şass, 
job
);

351 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

352 
job
.
	`£tOuutFÜm©CÏss
(
TextOuutFÜm©
.
şass
);

353 
job
.
	`£tM­OuutKeyCÏss
(
Ho¡Info
.
şass
);

354 
job
.
	`£tM­OuutV®ueCÏss
(
Text
.
şass
);

356 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "bÏckdomaš", 
TextOuutFÜm©
.
şass
, 
Text
.şass, 
NuÎWr™abË
.class);

357 
job
.
	`£tGroupšgCom·¿tÜCÏss
(
Ho¡InfoGroupCom·¿tÜ
.
şass
);

358 
job
.
	`£tP¬t™iÚ”CÏss
(
Ho¡InfoP¬t™iÚ
.
şass
);

360 
job
.
	`£tOuutKeyCÏss
(
Text
.
şass
);

361 
job
.
	`£tOuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

363 
job
.
	`£tReduûrCÏss
(
SÿnHo¡Reduûr
.
şass
);

364 
num»duû
 = 
cÚf
.
	`g‘IÁ
("mapred.reduce.tasks", 0);

365 
job
.
	`£tNumReduûTasks
(
num»duû
);

366  
job
;

367 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

368 
e
.
	`´štSckT¿û
();

370  
nuÎ
;

371 
	}
}

373 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

376 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

377 
Œy
 {

378 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

379 
Job
 
job
 = 
Ho¡Sti¡ic
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

380 ià(
Ùh”Args
.
Ëngth
 < 1) {

381 
Sy¡em
.
out
.
	`´šn
("Wrong‚umber of‡rguments: " +

382 
Ùh”Args
.
Ëngth
 +

384 
Sy¡em
.
	`ex™
(-1);

386 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

387 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

388 
e
.
	`´štSckT¿û
();

389 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

390 
e
.
	`´štSckT¿û
();

391 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

392 
e
.
	`´štSckT¿û
();

394 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/ImportURL.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

7 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

8 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

9 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

10 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

11 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

12 
impÜt
 
	gjava
.
	gut
.
	gRªdom
;

13 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

40 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

42 
public
 cÏs 
	cImpÜtURL
 {

43 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

45 
public
 
şass
 
ImpÜtURLM­³r
 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

47 @
Ov”ride


48 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

50 
	mcÚ‹xt
.
wr™e
(
key
, 
v®ue
);

55 
public
 
şass
 
ImpÜtURLReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

56 
´iv©e
 
	gby‹
[] 
	gf
 = 
By‹s
.
toBy‹s
("F");

57 
´iv©e
 
	gby‹
[] 
	gp
 = 
By‹s
.
toBy‹s
("P");

58 
´iv©e
 
	gby‹
[] 
	gh
 = 
By‹s
.
toBy‹s
("H");

59 
´iv©e
 
	gby‹
[] 
	gu
 = 
By‹s
.
toBy‹s
("u");

60 
´iv©e
 
	gby‹
[] 
	gs
 = 
By‹s
.
toBy‹s
("s");

61 
´iv©e
 
	gby‹
[] 
	gi
 = 
By‹s
.
toBy‹s
("i");

62 
´iv©e
 
	gby‹
[] 
	gd
 = 
By‹s
.
toBy‹s
("d");

63 
	gby‹
[] 
	gÃwStus
 = 
By‹s
.
toBy‹s
("0");

64 
	gLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

65 
Rªdom
 
	g¿nd
 = 
Ãw
 Random();

67 @
Ov”ride


68 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<ImmubËBy‹sWr™abË> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

70 
	gkvLi¡
.
ş—r
();

71 
ImmubËBy‹sWr™abË
 
	gv
 : 
v®ues
) {

72 
KeyV®ue
 
kv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
f
, 
u
, 
v
.get());

73 
	gkvLi¡
.
add
(
kv
);

74 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
f
, 
s
, 
ÃwStus
);

75 
	gkvLi¡
.
add
(
kv
);

76 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
f
, 
d
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
Sy¡em
.
cu¼’tTimeMlis
(è/ 1000 - 
¿nd
.
ÃxtIÁ
(80000))));

77 
	gkvLi¡
.
add
(
kv
);

78 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
f
, 
i
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
Sy¡em
.
cu¼’tTimeMlis
() / 1000)));

79 
	gkvLi¡
.
add
(
kv
);

82 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

83 
KeyV®ue
 
	gkv
:
kvLi¡
)

85 
cÚ‹xt
.
wr™e
(
key
, 
kv
);

90 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
è
throws
 
IOExû±iÚ
 {

91 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

92 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 A¼ayLi¡<ImmubËBy‹sWr™abË>(
by‹Keys
.
Ëngth
);

93 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

94 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

96  
»t
;

97 
	}
}

99 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
è
throws
 
	gIOExû±iÚ
 {

100 ià(
	g¡¬tKeys
.
isEm±y
()) {

101 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

108 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(
¡¬tKeys
);

110 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

111 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

112 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("Fœ¡„egiÚ oàbË should havem±y s¹ key. In¡—d has: " + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

114 
	gsÜ‹d
.
»move
(
fœ¡
);

117 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

118 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

120 
	gŒy
 {

121 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

122 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

124 } 
	gfš®ly
 {

125 
	gwr™”
.
şo£
();

129 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

130 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

131 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

132 ià(
bËDesütÜ
 =ğ
nuÎ
) {

136 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

137 
i
 = 0;

138 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

139 ià(
i
++ > 0) {

140 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

142 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

143 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

144 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

147 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

148 
	}
}

150 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
(è
throws
 
CÏssNÙFoundExû±iÚ
 {

151 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

152 
Œy
 {

153 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

154 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

155 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

157  
şazz
;

158 
	}
}

160 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

161 
Œy
 {

162 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

163 
cÚf
.
	`£t
("mapred.map.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

164 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
Œue
);

165 
cÚf
.
	`£t
("mapred.output.compression.type", "BLOCK");

166 
cÚf
.
	`£t
("mapred.output.compression", "org.apache.hadoop.io.compress.SnappyCodec");

167 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

168 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

169 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

170 
job
.
	`£tM­³rCÏss
(
ImpÜtURLM­³r
.
şass
);

171 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

172 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

173 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

176 
job
.
	`£tReduûrCÏss
(
ImpÜtURLReduûr
.
şass
);

178 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

179 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

180 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

182 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

183 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

184 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

185 
Œy
 {

186 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

187 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

188 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

190 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

192 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

193 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

194 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

195 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

197 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

198 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

199 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

200 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

201 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

203 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

204 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

205 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

206 
Log
.
	`šfo
("Incrementalable output configured.");

207 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

208 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

209 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
com
.
googË
.
commÚ
.
ba£
.
P»cÚd™iÚs
.
şass
);

211  
job
;

212 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

214 
e
.
	`´štSckT¿û
();

215 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

217 
e
.
	`´štSckT¿û
();

219  
nuÎ
;

220 
	}
}

222 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

223 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

224 
Œy
 {

225 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

226 ià(
Ùh”Args
.
Ëngth
 < 2) {

227 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage:inputpath outputpath");

228 
Sy¡em
.
	`ex™
(-1);

230 
Job
 
job
 = 
ImpÜtURL
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

231 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

232 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

234 
e
.
	`´štSckT¿û
();

235 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

237 
e
.
	`´štSckT¿û
();

238 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

240 
e
.
	`´štSckT¿û
();

242 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/MergeNewURLDocid.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

18 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gTimeSequ’ûFeOuutFÜm©
;

20 
public
 cÏs 
	cM”geNewURLDocid
 {

22 
public
 
şass
 
M”geDocidM­
 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, 
	mNuÎWr™abË
, ImmutableBytesWritable, NullWritable> {

24 @
Ov”ride


25 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
NuÎWr™abË
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

27 
	mcÚ‹xt
.
wr™e
(
key
, 
v®ue
);

32 
public
 
şass
 
M”geDocidReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gNuÎWr™abË
, ImmutableBytesWritable, NullWritable> {

34 @
Ov”ride


35 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<
NuÎWr™abË
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

37 
	gcÚ‹xt
.
wr™e
(
key
, 
NuÎWr™abË
.
g‘
());

42 
Job
 
	$ü—‹M”geJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

43 
Job
 
job
 = 
nuÎ
;

44 
Œy
 {

45 
job
 = 
Ãw
 
	`Job
(
cÚf
);

46 
FeIÅutFÜm©
.
	`£tIÅutP©hs
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

47 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

48 
job
.
	`£tJobName
("MergeDocidJob");

49 
job
.
	`£tM­³rCÏss
(
M”geDocidM­
.
şass
);

50 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

51 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

52 
job
.
	`£tM­OuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

53 
job
.
	`£tReduûrCÏss
(
M”geDocidReduûr
.
şass
);

54 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

55 
job
.
	`£tOuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

56 
job
.
	`£tOuutFÜm©CÏss
(
TimeSequ’ûFeOuutFÜm©
.
şass
);

57 
job
.
	`£tNumReduûTasks
(
IÁeg”
.
	`·r£IÁ
(
¬gs
[2]));

58 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

59 
e
.
	`´štSckT¿û
();

61  
job
;

62 
	}
}

64 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

65 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

66 
SŒšg
[] 
Ùh”Args
;

67 
Œy
 {

68 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

69 ià(
Ùh”Args
.
Ëngth
 < 3) {

70 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage: input outpu‚umofreducer");

71 
Sy¡em
.
	`ex™
(-1);

73 
Job
 
job
 = 
	`ü—‹M”geJob
(
cÚf
, 
Ùh”Args
);

74 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

76 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

77 
e
.
	`´štSckT¿û
();

78 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

79 
e
.
	`´štSckT¿û
();

81 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/ParseHost.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gIÁWr™abË
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

23 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gURLUt
;

25 
public
 cÏs 
	cP¬£Ho¡
 {

26 
public
 
şass
 
P¬£M­³r
 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	mIÁWr™abË
> {

27 
	mby‹
[] 
	mf
 = 
By‹s
.
toBy‹s
("F");

28 
	mby‹
[] 
	mu
 = 
By‹s
.
toBy‹s
("u");

29 
	mby‹
[] 
	mh
 = 
By‹s
.
toBy‹s
("H");

30 
	mby‹
[] 
	ms
 = 
By‹s
.
toBy‹s
("s");

31 
	mby‹
[] 
	mp
 = 
By‹s
.
toBy‹s
("P");

32 
	mby‹
[] 
	mfšg”
 = 
By‹s
.
toBy‹s
("f");

33 
ImmubËBy‹sWr™abË
 
	mk2
 = 
Ãw
 ImmutableBytesWritable();

34 
	mHashS‘
<
	mSŒšg
> 
	mho¡S‘
 = 
Ãw
 
HashS‘
<
SŒšg
>();

36 @
Ov”ride


37 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

39 
SŒšg
 
	mu¾
 = 
Ãw
 SŒšg(
key
.
g‘
());

40 
SŒšg
 
	mdomaš
 = 
URLUt
.
g‘DomašName
(
u¾
);

41 ià(!
	mho¡S‘
.
cÚšs
(
domaš
)) {

42 
	mk2
.
£t
(
domaš
.
g‘By‹s
());

43 
	mcÚ‹xt
.
wr™e
(
k2
, 
Ãw
 
IÁWr™abË
(1));

44 
	mho¡S‘
.
add
(
domaš
);

50 
public
 
şass
 
P¬£Reduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gIÁWr™abË
, 
	gText
, 
	gNuÎWr™abË
> {

52 @
Ov”ride


53 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<
IÁWr™abË
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

55 
	gcÚ‹xt
.
wr™e
(
Ãw
 
Text
(
key
.
g‘
()), 
NuÎWr™abË
.get());

60 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

61 
Œy
 {

67 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

68 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

69 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

70 
job
.
	`£tM­³rCÏss
(
P¬£M­³r
.
şass
);

71 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

72 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

73 
job
.
	`£tM­OuutV®ueCÏss
(
IÁWr™abË
.
şass
);

74 
job
.
	`£tOuutKeyCÏss
(
Text
.
şass
);

75 
job
.
	`£tOuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

78 
job
.
	`£tReduûrCÏss
(
P¬£Reduûr
.
şass
);

79 
job
.
	`£tNumReduûTasks
(1);

80  
job
;

81 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

83 
e
.
	`´štSckT¿û
();

85  
nuÎ
;

86 
	}
}

88 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

89 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

90 
Œy
 {

91 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

92 ià(
Ùh”Args
.
Ëngth
 < 2) {

93 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage:inputpath outputpath");

94 
Sy¡em
.
	`ex™
(-1);

96 
Job
 
job
 = 
P¬£Ho¡
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

98 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

99 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

101 
e
.
	`´štSckT¿û
();

102 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

104 
e
.
	`´štSckT¿û
();

105 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

107 
e
.
	`´štSckT¿û
();

109 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/ParseResultImporter.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

6 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

7 
impÜt
 
	gjava
.
	g‹xt
.
	gP¬£Exû±iÚ
;

8 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

9 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

10 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

11 
impÜt
 
	gjava
.
	gut
.
	gD©e
;

12 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

13 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

14 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

15 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

16 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

42 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

43 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

44 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

45 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

46 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

47 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

48 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

50 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gavro
.
	gP¬£rResuÉCÚv”‹r
;

51 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gP¬£rResuÉ
;

52 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gb—n
.
	gURLInfo
;

53 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

54 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
.
	gMD5L’
;

55 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

74 
public
 cÏs 
	cP¬£ResuÉImpÜ‹r
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

75 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

77 
şass
 
P¬£ResuÉM­³r
 
ex‹nds


78 
	mM­³r
<
	mText
, Text, 
	mImmubËBy‹sWr™abË
, Text> {

79 
ImmubËBy‹sWr™abË
 
	mk2
 = 
Ãw
 ImmutableBytesWritable();

81 @
Ov”ride


82 
´Ùeùed
 
m­
(
Text
 
key
, Texˆ
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

83 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

85 
	mk2
.
£t
(
key
.
g‘By‹s
());

86 
	mcÚ‹xt
.
wr™e
(
k2
, 
v®ue
);

89 @
Ov”ride


90 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
,

91 
	mIÁ”ru±edExû±iÚ
 {

93 
	msu³r
.
£tup
(
cÚ‹xt
);

94 
CÚfigu¿tiÚ
 
	mcÚf
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
();

95 
	mLog
.
šfo
("cÚf=" + 
TÙ®Ord”P¬t™iÚ”
.
g‘P¬t™iÚFe
(
cÚf
));

99 
şass
 
P¬£ResuÉReduûr


100 
ex‹nds


101 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gText
, ImmutableBytesWritable, ImmutableBytesWritable> {

102 
´iv©e
 
MuÉËOuuts
 
	gmos
;

103 
´iv©e
 
P¬£rResuÉCÚv”‹r
 
	g·r£CÚv”‹r
;

104 
ImmubËBy‹sWr™abË
 
	ghba£Key
 = 
Ãw
 ImmutableBytesWritable();

105 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

106 
by‹
 
	gP
[] = 
By‹s
.
toBy‹s
("P");

107 
by‹
 
	gn
[] = 
By‹s
.
toBy‹s
("n");

108 
by‹
 
	gŞd
[] = 
By‹s
.
toBy‹s
("0");

110 
D©eFÜm©
 
	gfÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyyMMddHHmmss");

112 @
Ov”ride


113 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

114 
	gIÁ”ru±edExû±iÚ
 {

116 
	gmos
 = 
Ãw
 
MuÉËOuuts
(
cÚ‹xt
);

118 
CÚfigu¿tiÚ
 
	gcÚf
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
();

119 
SŒšg
 
	gtime¡amp
 = 
cÚf
.
g‘
("seqTimestamp");

120 ià(
	gtime¡amp
 !ğ
nuÎ
) {

121 
Œy
 {

122 
D©e
 
d
 = 
fÜm©
.
·r£
(
time¡amp
);

123 ià(
	gd
 !ğ
nuÎ
) {

124 
m
 = (è(
d
.
g‘Time
() / 1000);

125 
	g·r£CÚv”‹r
 = 
Ãw
 
P¬£rResuÉCÚv”‹r
(
m
,

126 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
());

128 } 
ÿtch
 (
P¬£Exû±iÚ
 
e
) {

130 
	ge
.
´štSckT¿û
();

134 ià(
	g·r£CÚv”‹r
 =ğ
nuÎ
) {

135 
·r£CÚv”‹r
 = 
Ãw
 
P¬£rResuÉCÚv”‹r
(

136 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
());

137 
	gLog
.
šfo
("error could‚ot find seqtimestamp");

140 
	gLog
.
šfo
("cÚf=" + 
TÙ®Ord”P¬t™iÚ”
.
g‘P¬t™iÚFe
(
cÚf
));

143 @
Ov”ride


144 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
,

145 
I‹¿bË
<
Text
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

146 
	gIÁ”ru±edExû±iÚ
 {

149 
	gI‹¿tÜ
<
	gText
> 
	g™
 = 
v®ues
.
™”©Ü
();

150 
ImmubËBy‹sWr™abË
 
	gk3
 = 
Ãw
 ImmutableBytesWritable();

151 
	gk3
.
£t
(
key
.
g‘
());

152 
	g™
.
hasNext
()) {

153 
Text
 
	gv®ue
 = 
™
.
Ãxt
();

154 
	gkvLi¡
.
ş—r
();

155 
P¬£rResuÉ
 
	g»suÉ
 = 
·r£CÚv”‹r
.
cÚv”‹r
(
key
.
g‘
(),

156 
key
.
g‘L’gth
(), 
v®ue
.
g‘By‹s
(), value.getLength(),

157 
kvLi¡
);

158 ià(
	g»suÉ
 !ğ
nuÎ
) {

159 ià(
»suÉ
.
g‘Fšg”
(è!ğ
nuÎ


160 && 
»suÉ
.
g‘Fšg”
().
Ëngth
 == 8) {

161 
ImmubËBy‹sWr™abË
 
fšg”
 = 
Ãw
 ImmutableBytesWritable();

162 
	gfšg”
.
£t
(
»suÉ
.
g‘Fšg”
(), 0, 8);

163 
	gcÚ‹xt
.
wr™e
(
k3
, 
fšg”
);

164 
ImmubËBy‹sWr™abË
 
	gm‘a
 = 
Ãw
 ImmutableBytesWritable();

165 
by‹
 
	g»s
[] = 
Ãw
 by‹[
»suÉ
.
g‘M‘a
().
Ëngth
 + 8];

170 
	gSy¡em
.
¬¿ycİy
(
fšg”
.
g‘
(), 0, 
»s
, 0, 8);

171 
	gSy¡em
.
¬¿ycİy
(
»suÉ
.
g‘M‘a
(), 0, 
»s
, 8,

172 
»suÉ
.
g‘M‘a
().
Ëngth
);

173 
	gm‘a
.
£t
(
»s
);

174 
	gLog
.
šfo
("new url meta "

175 + 
SŒšgUts
.
by‹ToHexSŒšg
(
»suÉ


176 .
g‘U¾Md5
())

178 + 
SŒšgUts
.
by‹ToHexSŒšg
(
»s
, 0,

179 
m‘a
.
g‘L’gth
()));

180 
	gmos
.
wr™e
("URLM‘a", 
k3
, 
m‘a
);

182 
	gS‘
<
	gURLInfo
> 
	gšfo£t
 = 
»suÉ
.
g‘InfoS‘
();

183 ià(
	gšfo£t
 !ğ
nuÎ
 && 
šfo£t
.
size
() > 0) {

184 
URLInfo
 
šfo
 : 
šfo£t
) {

185 
mos
.
wr™e
("·r£dURL", 
k3
, 
šfo
);

188 ià(
	gkvLi¡
.
size
() > 0) {

189 
	gŒy
 {

191 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

192 
KeyV®ue
 
	gkv
 : 
kvLi¡
) {

193 ià(
key
.
g‘L’gth
() == 8) {

194 
Œy
 {

195 
mos
.
wr™e
("hfeD©a", 
key
, 
kv
);

196 } 
ÿtch
 (
Exû±iÚ
 
e
) {

197 
	ge
.
´štSckT¿û
();

198 
MD5
 
	gmd5
 = 
Ãw
 MD5(
kv
.
g‘Row
(),

199 
MD5L’
.
eight
, 0);

200 
	gLog
.
šfo
("kv="

201 + 
md5
.
g‘HexSŒšg
()

203 + 
By‹s
.
toSŒšgBš¬y
(
kv


204 .
g‘Row
()));

207 
	gLog
.
šfo
("”rÜ key†’gth " + 
key
);

210 } 
ÿtch
 (
Exû±iÚ
 
e
) {

211 
	ge
.
´štSckT¿û
();

214 
	gSy¡em
.
	gout
.
´šn
("kv†i¡ siz=" + 
kvLi¡
.
size
());

221 @
Ov”ride


222 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

223 
	gIÁ”ru±edExû±iÚ
 {

225 
	gmos
.
şo£
();

226 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

231 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
()

232 
throws
 
CÏssNÙFoundExû±iÚ
 {

233 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

234 
Œy
 {

235 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

236 .
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

237 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

238 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

239 .
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

241  
şazz
;

242 
	}
}

244 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
)

245 
throws
 
IOExû±iÚ
 {

246 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

247 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 ArrayList<ImmutableBytesWritable>(

248 
by‹Keys
.
Ëngth
);

249 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

250 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

252  
»t
;

253 
	}
}

255 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
,

256 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
)

257 
throws
 
	gIOExû±iÚ
 {

258 ià(
	g¡¬tKeys
.
isEm±y
()) {

259 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

266 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(

267 
¡¬tKeys
);

269 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

270 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

271 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
(

273 + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

275 
	gsÜ‹d
.
»move
(
fœ¡
);

278 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

279 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
,

280 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
,

281 
NuÎWr™abË
.
şass
);

283 
	gŒy
 {

284 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

285 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

287 } 
	gfš®ly
 {

288 
	gwr™”
.
şo£
();

292 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
)

293 
throws
 
IOExû±iÚ
 {

294 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

295 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

296 ià(
bËDesütÜ
 =ğ
nuÎ
) {

300 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

301 
i
 = 0;

302 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

303 ià(
i
++ > 0) {

304 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

306 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(

307 
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

308 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

309 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ


310 .
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

313 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

314 
	}
}

316 
public
 
Job
 
	$run
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

321 
URI
 
ho¡u¾
 = 
Ãw
 
	`URI
(

324 
URI
 
domašu¾
 = 
Ãw
 
	`URI
(

327 
Di¡ribu‹dCache
.
	`addCacheFe
(
ho¡u¾
, 
cÚf
);

328 
Di¡ribu‹dCache
.
	`addCacheFe
(
domašu¾
, 
cÚf
);

329 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

330 
cÚf
.
	`£t
("robot_idx_name", "robotidx-r-00000");

331 
cÚf
.
	`£t
("robot_file_name", "part-r-00000");

332 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

333 
P©h
 
š
 = 
Ãw
 
	`P©h
(
¬gs
[0]);

334 
P©h
 
out
 = 
Ãw
 
	`P©h
(
¬gs
[1]);

335 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
š
);

336 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
out
);

337 
job
.
	`£tM­³rCÏss
(
P¬£ResuÉM­³r
.
şass
);

338 
job
.
	`£tReduûrCÏss
(
P¬£ResuÉReduûr
.
şass
);

341 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

342 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

343 
job
.
	`£tM­OuutV®ueCÏss
(
Text
.
şass
);

344 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

345 
job
.
	`£tOuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

346 
job
.
	`£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

348 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "URLMeta",

349 
Sequ’ûFeOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.class,

350 
ImmubËBy‹sWr™abË
.
şass
);

351 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "parsedURL",

352 
Sequ’ûFeOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.class,

353 
URLInfo
.
şass
);

354 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "hfileData",

355 
HFeOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.class,

356 
KeyV®ue
.
şass
);

357 
MuÉËOuuts
.
	`£tCouÁ”sEÇbËd
(
job
, 
Œue
);

358 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

359 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

361 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

362 
Œy
 {

363 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

364 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

365 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

367 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

369 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

370 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

371 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions "

373 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

375 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "partitions_"

376 + 
Sy¡em
.
	`cu¼’tTimeMlis
());

377 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

378 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

379 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

380 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(),

381 
·¹™iÚsP©h
);

383 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

384 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

385 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

386 
Log
.
	`šfo
("Incrementalable output configured.");

387 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

388 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

390  
job
;

391 
	}
}

393 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

394 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

395 
SŒšg
[] 
Ùh”Args
;

396 
Œy
 {

397 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

398 ià(
Ùh”Args
.
Ëngth
 < 2) {

399 
Sy¡em
.
out
.
	`´šn
("Wrong‚umber of‡rguments: "

400 + 
Ùh”Args
.
Ëngth
);

401 
Sy¡em
.
	`ex™
(-1);

403 
Job
 
job
 = 
	`run
(
cÚf
, 
Ùh”Args
);

404 
Sy¡em
.
	`ex™
(
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1);

405 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

407 
e
.
	`´štSckT¿û
();

408 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

410 
e
.
	`´štSckT¿û
();

413 
	}
}

415 @
Ov”ride


416 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

418 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

419 
SŒšg
[] 
Ùh”Args
;

420 
Œy
 {

421 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

422 ià(
Ùh”Args
.
Ëngth
 < 2) {

423 
Sy¡em
.
out
.
	`´šn
("Wrong‚umber of‡rguments: "

424 + 
Ùh”Args
.
Ëngth
);

425 
Sy¡em
.
	`ex™
(-1);

427 
Job
 
job
 = 
	`run
(
cÚf
, 
Ùh”Args
);

428  
job
;

429 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

431 
e
.
	`´štSckT¿û
();

432 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

434 
e
.
	`´štSckT¿û
();

436  
nuÎ
;

437 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/RobotFileGenerate.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gCom·»F‹r
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gSšgËCŞumnV®ueF‹r
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËIÅutFÜm©
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

36 
public
 cÏs 
	cRobÙFeG’”©e
 {

38 
public
 
şass
 
Ho¡M­³r


39 
ex‹nds
 
	mTabËM­³r
<
	mText
, Text> {

40 
	mby‹
[] 
	mH
 = 
By‹s
.
toBy‹s
("H");

41 
	mby‹
[] 
	mh
 = 
By‹s
.
toBy‹s
("h");

42 
	mby‹
[] 
	mR
 = 
By‹s
.
toBy‹s
("R");

43 
	mby‹
[] 
	mr
 = 
By‹s
.
toBy‹s
("r");

45 @
Ov”ride


46 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

47 
ResuÉ
 
v®ue
,

48 
CÚ‹xt
 
cÚ‹xt
)

49 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

50 
by‹
 
	mbho¡
[] = 
v®ue
.
g‘V®ue
(
H
, 
h
);

51 
by‹
 
	mrobÙs
[] = 
v®ue
.
g‘V®ue
(
R
, 
r
);

52 ià(
	mbho¡
 !ğ
nuÎ
 && 
robÙs
 !ğnuÎ &&„obÙs.
Ëngth
 > 0) {

53 
cÚ‹xt
.
wr™e
(
Ãw
 
Text
(
bho¡
),‚ew Text(
robÙs
));

58 
public
 
şass
 
Ho¡Reduûr


59 
ex‹nds
 
	gReduûr
<
	gText
, Text, 
	gImmubËBy‹sWr™abË
, 
	gNuÎWr™abË
> {

60 
	gby‹
[] 
	gbufãr
 = 
Ãw
 
by‹
[2048];

61 
ImmubËBy‹sWr™abË
 
	go
 = 
Ãw
 ImmutableBytesWritable();

62 
	gby‹
[] 
	g¡¬t
 = "########".
g‘By‹s
();

63 
	gby‹
[] 
	g’d
 = "@@@@@@@@".
g‘By‹s
();

64 
´iv©e
 
MuÉËOuuts
 
	gmos
;

65 
	goff£t
 = 0;

66 
	gËn
 = 0;

67 
	gcu¼Off£t
 = 0;

68 
	gby‹
[] 
	gidxbufãr
 = 
Ãw
 
by‹
[20];

69 
	gby‹
[] 
	grobÙsbufãr
 = 
Ãw
 
by‹
[1024 * 1024 * 2];

70 
ImmubËBy‹sWr™abË
 
	gkidx
 = 
Ãw
 ImmutableBytesWritable();

71 
ImmubËBy‹sWr™abË
 
	gkcÚ‹Á
 = 
Ãw
 ImmutableBytesWritable();

73 @
Ov”ride


74 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
)

75 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

76 
	gsu³r
.
£tup
(
cÚ‹xt
);

77 
	gmos
 = 
Ãw
 
MuÉËOuuts
(
cÚ‹xt
);

78 
	gSy¡em
.
¬¿ycİy
(
¡¬t
, 0, 
robÙsbufãr
, 0, 8);

81 @
Ov”ride


82 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

83 
	gIÁ”ru±edExû±iÚ
 {

84 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

85 
	gmos
.
şo£
();

95 @
Ov”ride


96 
´Ùeùed
 
»duû
(
Text
 
key
,

97 
I‹¿bË
<
Text
> 
v®ues
,

98 
CÚ‹xt
 
cÚ‹xt
)

99 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

100 
	gËn
 = 8;

101 
SŒšg
 
	gho¡
 = 
key
.
toSŒšg
();

102 
SŒšg
 
	grobÙs
 = 
v®ues
.
™”©Ü
().
Ãxt
().
toSŒšg
();

103 
by‹
 
	gdige¡
[] = 
MD5
.
dige¡8
(
ho¡
.
g‘By‹s
()).
g‘Dige¡
();

104 ià(
	grobÙs
.
g‘By‹s
().
	gËngth
 > 
	grobÙsbufãr
.length) {

105 
	gcÚ‹xt
.
g‘CouÁ”
("robÙs", "”rÜ_»cÜd").
šüem’t
(1);

109 
	gby‹
[] 
	gho¡by‹
 = 
ho¡
.
g‘By‹s
();

110 
	gby‹
[] 
	grobÙsby‹
 = 
robÙs
.
g‘By‹s
();

112 
by‹
 
	gho¡Ën
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
ho¡by‹
.
Ëngth
);

113 
	gSy¡em
.
¬¿ycİy
(
dige¡
, 0, 
robÙsbufãr
, 
Ën
, 8);

114 
	gËn
 += 8;

115 
	gSy¡em
.
¬¿ycİy
(
ho¡Ën
, 0, 
robÙsbufãr
, 
Ën
, 4);

116 
	gËn
 += 4;

117 
	gSy¡em
.
¬¿ycİy
(
ho¡by‹
, 0, 
robÙsbufãr
, 
Ën
, ho¡by‹.
Ëngth
);

118 
	gËn
 +ğ
ho¡by‹
.
Ëngth
;

119 
by‹
 
	grobÙ¦’
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
robÙsby‹
.
Ëngth
);

120 
	gSy¡em
.
¬¿ycİy
(
robÙ¦’
, 0, 
robÙsbufãr
, 
Ën
, 4);

121 
	gËn
 += 4;

122 
	gSy¡em
.
¬¿ycİy
(
robÙsby‹
, 0, 
robÙsbufãr
, 
Ën
,„obÙsby‹.
Ëngth
);

123 
	gËn
 +ğ
robÙsby‹
.
Ëngth
;

124 
	gSy¡em
.
¬¿ycİy
(
’d
, 0, 
robÙsbufãr
, 
Ën
, 8);

125 
	gËn
 += 8;

127 
	gSy¡em
.
¬¿ycİy
(
dige¡
, 0, 
idxbufãr
, 0, 8);

128 
by‹
 
	goff
[] = 
Numb”Ut
.
cÚv”tLÚgToC
(
off£t
);

129 
	gSy¡em
.
¬¿ycİy
(
off
, 0, 
idxbufãr
, 8, 8);

130 
by‹
 
	gËnby‹
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
Ën
);

131 
	gSy¡em
.
¬¿ycİy
(
Ënby‹
, 0, 
idxbufãr
, 16, 4);

133 
	goff£t
 +ğ
Ën
;

134 
	gkcÚ‹Á
.
£t
(
robÙsbufãr
, 0, 
Ën
);

135 
	gcÚ‹xt
.
wr™e
(
kcÚ‹Á
, 
NuÎWr™abË
.
g‘
());

136 
	gkidx
.
£t
(
idxbufãr
);

137 
	gmos
.
wr™e
("robÙidx", 
kidx
, 
NuÎWr™abË
.
g‘
());

141 
SŒšg
 
	$cÚv”tSÿnToSŒšg
(
Sÿn
 
sÿn
è
throws
 
IOExû±iÚ
 {

142 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

143 
D©aOuutSŒ—m
 
dos
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

144 
sÿn
.
	`wr™e
(
dos
);

145  
Ba£64
.
	`’codeBy‹s
(
out
.
	`toBy‹A¼ay
());

146 
	}
}

161 
´iv©e
 
	$addCŞumn
(
Sÿn
 
sÿn
, 
by‹
[] 
çmyAndQu®if›r
) {

162 
by‹
[][] 
fq
 = 
KeyV®ue
.
	`·r£CŞumn
(
çmyAndQu®if›r
);

163 ià(
fq
.
Ëngth
 > 1 && fq[1] !ğ
nuÎ
 && fq[1].length > 0) {

164 
sÿn
.
	`addCŞumn
(
fq
[0], fq[1]);

166 
sÿn
.
	`addFamy
(
fq
[0]);

168 
	}
}

182 
public
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
by‹
[][] 
cŞumns
) {

183 
by‹
[] 
cŞumn
 : 
cŞumns
) {

184 
	`addCŞumn
(
sÿn
, 
cŞumn
);

186 
	}
}

198 
´iv©e
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
SŒšg
 
cŞumns
) {

199 
SŒšg
[] 
cŞs
 = 
cŞumns
.
	`¥l™
(" ");

200 
SŒšg
 
cŞ
 : 
cŞs
) {

201 
	`addCŞumn
(
sÿn
, 
By‹s
.
	`toBy‹s
(
cŞ
));

203 
	}
}

205 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

206 
Œy
 {

208 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

209 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "hostDB");

210 
sÿn
.
	`£tCachšg
(500);

212 ià(
cÚf
.
	`g‘
("sÿn_f‹r"è!ğ
nuÎ
) {

213 
F‹r
 
f‹r
;

214 
Œy
 {

215 
P¬£F‹r
 
·r£
 = 
Ãw
 
	`P¬£F‹r
();

216 
f‹r
 = 
·r£
.
	`·r£F‹rSŒšg
(
cÚf
.
	`g‘
("scan_filter"));

217 
Sy¡em
.
out
.
	`´šn
("£ˆf‹¸" + 
cÚf
.
	`g‘
("scan_filter"));

218 
sÿn
.
	`£tF‹r
(
f‹r
);

219 } 
	`ÿtch
 (
Ch¬aù”CodšgExû±iÚ
 
e1
) {

220 
e1
.
	`´štSckT¿û
();

223 
SšgËCŞumnV®ueF‹r
 
lff
 = 
Ãw
 
	`SšgËCŞumnV®ueF‹r
(

224 
By‹s
.
	`toBy‹s
("R"), Bytes.toBytes("r"),

225 
Com·»F‹r
.
Com·»Op
.
NOT_EQUAL
, "0".
	`g‘By‹s
());

226 
lff
.
	`£tF‹rIfMissšg
(
Œue
);

227 
lff
.
	`£tL©e¡V”siÚOÆy
(
Œue
);

228 
sÿn
.
	`£tF‹r
(
lff
);

231 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
è!ğ
nuÎ
) {

232 
	`addCŞumns
(
sÿn
, 
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
));

234 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("H"), Bytes.toBytes("h"));

235 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("R"), Bytes.toBytes("r"));

238 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
è!ğ
nuÎ
) {

239 
sÿn
.
	`addFamy
(
By‹s
.
	`toBy‹s
(
cÚf


240 .
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
)));

242 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
è!ğ
nuÎ
) {

243 
sÿn
.
	`£tMaxV”siÚs
(
IÁeg”
.
	`·r£IÁ
(
cÚf


244 .
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
)));

246 
sÿn
.
	`£tMaxV”siÚs
(1);

258 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

259 
cÚf
.
	`£t
("mapred.map.output.compression.codec",

261 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
çl£
);

263 
cÚf
.
	`£t
(
TabËIÅutFÜm©
.
SCAN
, 
	`cÚv”tSÿnToSŒšg
(
sÿn
));

264 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

266 
TabËM­ReduûUt
.
	`š™TabËM­³rJob
(
bËName
, 
sÿn
,

267 
Ho¡M­³r
.
şass
, 
Text
.şass, 
NuÎWr™abË
.şass, 
job
);

269 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

270 
job
.
	`£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

271 
job
.
	`£tOuutFÜm©CÏss
(
Bš¬yOuutFÜm©
.
şass
);

272 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "robotidx",

273 
Bš¬yOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.class,

274 
NuÎWr™abË
.
şass
);

275 
job
.
	`£tM­OuutKeyCÏss
(
Text
.
şass
);

276 
job
.
	`£tM­OuutV®ueCÏss
(
Text
.
şass
);

277 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

278 
job
.
	`£tOuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

279 
job
.
	`£tReduûrCÏss
(
Ho¡Reduûr
.
şass
);

281  
job
;

282 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

284 
e
.
	`´štSckT¿û
();

286  
nuÎ
;

287 
	}
}

289 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

290 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

291 
Œy
 {

292 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
)

293 .
	`g‘RemaššgArgs
();

294 
Job
 
job
 = 
RobÙFeG’”©e
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

295 ià(
Ùh”Args
.
Ëngth
 < 1) {

296 
Sy¡em
.
out
.
	`´šn
("Wrong‚umber of‡rguments: " +

297 
Ùh”Args
.
Ëngth
 +

299 
Sy¡em
.
	`ex™
(-1);

301 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

302 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

303 
e
.
	`´štSckT¿û
();

304 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

305 
e
.
	`´štSckT¿û
();

306 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

307 
e
.
	`´štSckT¿û
();

309 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/RobotsHostGenerate.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËIÅutFÜm©
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

30 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

31 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

33 
public
 cÏs 
	cRobÙsHo¡G’”©e
 {

34 
public
 
şass
 
Ho¡M­³r


35 
ex‹nds
 
	mTabËM­³r
<
	mText
, 
	mNuÎWr™abË
> {

36 
	mby‹
 [] 
	mH
 = 
By‹s
.
toBy‹s
("H");

37 
	mby‹
 [] 
	mh
 = 
By‹s
.
toBy‹s
("h");

38 
	mby‹
 [] 
	mo
 = 
By‹s
.
toBy‹s
("o");

41 
	mrobÙsTheŞd
;

43 @
Ov”ride


44 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
,

45 
	mIÁ”ru±edExû±iÚ
 {

46 
	msu³r
.
£tup
(
cÚ‹xt
);

73 
	mrobÙsTheŞd
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘IÁ
("robotsTheold", 10);

76 @
Ov”ride


77 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

78 
ResuÉ
 
v®ue
,

79 
CÚ‹xt
 
cÚ‹xt
)

80 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

81 
by‹
 
	mbho¡
[] = 
v®ue
.
g‘V®ue
(
H
, 
h
);

83 
by‹
 
	mu¾num
[]=
v®ue
.
g‘V®ue
(
H
, 
o
);

85 
	mm
=
Numb”Ut
.
»adIÁ
(
u¾num
,0);

86 if(
	mm
<
	mrobÙsTheŞd
)

88 
SŒšg
 
	mho¡
 = 
Ãw
 SŒšg(
bho¡
);

89 
	mcÚ‹xt
.
wr™e
(
Ãw
 
Text
(
ho¡
), 
NuÎWr™abË
.
g‘
());

121 
public
 
şass
 
Ho¡Reduûr


122 
ex‹nds
 
	gReduûr
<
	gText
, 
	gNuÎWr™abË
, 
	gImmubËBy‹sWr™abË
, Text> {

123 
	gby‹
 [] 
	gbufãr
 = 
Ãw
 
by‹
[2048];

124 
ImmubËBy‹sWr™abË
 
	go
 = 
Ãw
 ImmutableBytesWritable();

126 @
Ov”ride


127 
´Ùeùed
 
»duû
(
Text
 
key
,

128 
I‹¿bË
<
NuÎWr™abË
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
)

129 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

130 
SŒšg
 
	gho¡
=
key
.
toSŒšg
();

135 
SŒšg
 
	gu¾
="h‰p://"+
ho¡
+"/robots.txt";

136 
	gby‹
 [] 
	gu¾by‹s
 = 
u¾
.
g‘By‹s
();

137 
	gby‹
 [] 
	gmd5
 = 
MD5
.
dige¡8
(
u¾by‹s
, 0, u¾by‹s.
Ëngth
).
g‘Dige¡
();

138 
	go
.
£t
(
md5
);

139 
by‹
 
	gËnby‹s
[]=
Numb”Ut
.
cÚv”tIÁToC
(
u¾by‹s
.
Ëngth
);

140 
	gSy¡em
.
¬¿ycİy
(
Ënby‹s
, 0, 
bufãr
, 44, 4);

141 
	gSy¡em
.
¬¿ycİy
(
u¾by‹s
, 0, 
bufãr
, 48, u¾by‹s.
Ëngth
);

142 
	gcÚ‹xt
.
wr™e
(
o
, 
Ãw
 
Text
Òew 
SŒšg
(
bufãr
, 0, 48 + 
u¾by‹s
.
Ëngth
)));

147 
SŒšg
 
	$cÚv”tSÿnToSŒšg
(
Sÿn
 
sÿn
è
throws
 
IOExû±iÚ
 {

148 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

149 
D©aOuutSŒ—m
 
dos
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

150 
sÿn
.
	`wr™e
(
dos
);

151  
Ba£64
.
	`’codeBy‹s
(
out
.
	`toBy‹A¼ay
());

152 
	}
}

167 
´iv©e
 
	$addCŞumn
(
Sÿn
 
sÿn
, 
by‹
[] 
çmyAndQu®if›r
) {

168 
by‹
[][] 
fq
 = 
KeyV®ue
.
	`·r£CŞumn
(
çmyAndQu®if›r
);

169 ià(
fq
.
Ëngth
 > 1 && fq[1] !ğ
nuÎ
 && fq[1].length > 0) {

170 
sÿn
.
	`addCŞumn
(
fq
[0], fq[1]);

172 
sÿn
.
	`addFamy
(
fq
[0]);

174 
	}
}

188 
public
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
by‹
[][] 
cŞumns
) {

189 
by‹
[] 
cŞumn
 : 
cŞumns
) {

190 
	`addCŞumn
(
sÿn
, 
cŞumn
);

192 
	}
}

204 
´iv©e
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
SŒšg
 
cŞumns
) {

205 
SŒšg
[] 
cŞs
 = 
cŞumns
.
	`¥l™
(" ");

206 
SŒšg
 
cŞ
 : 
cŞs
) {

207 
	`addCŞumn
(
sÿn
, 
By‹s
.
	`toBy‹s
(
cŞ
));

209 
	}
}

211 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

212 
Œy
 {

214 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

215 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "hostDB");

216 
sÿn
.
	`£tCachšg
(500);

222 ià(
cÚf
.
	`g‘
("sÿn_f‹r"è!ğ
nuÎ
) {

223 
F‹r
 
f‹r
;

224 
Œy
 {

225 
P¬£F‹r
 
·r£
 = 
Ãw
 
	`P¬£F‹r
();

226 
f‹r
 = 
·r£
.
	`·r£F‹rSŒšg
(
cÚf
.
	`g‘
("scan_filter"));

227 
Sy¡em
.
out
.
	`´šn
("£ˆf‹¸" + 
cÚf
.
	`g‘
("scan_filter"));

228 
sÿn
.
	`£tF‹r
(
f‹r
);

229 } 
	`ÿtch
 (
Ch¬aù”CodšgExû±iÚ
 
e1
) {

230 
e1
.
	`´štSckT¿û
();

233 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
è!ğ
nuÎ
) {

234 
	`addCŞumns
(
sÿn
, 
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
));

236 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("H"), Bytes.toBytes("h"));

237 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("H"), Bytes.toBytes("o"));

240 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
è!ğ
nuÎ
) {

241 
sÿn
.
	`addFamy
(
By‹s
.
	`toBy‹s
(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
)));

243 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
è!ğ
nuÎ
) {

244 
sÿn
.
	`£tMaxV”siÚs
(
IÁeg”
.
	`·r£IÁ
(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
)));

246 
sÿn
.
	`£tMaxV”siÚs
(1);

258 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

259 
cÚf
.
	`£t
("mapred.map.output.compression.codec",

261 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
çl£
);

264 
cÚf
.
	`£t
(
TabËIÅutFÜm©
.
SCAN
, 
	`cÚv”tSÿnToSŒšg
(
sÿn
));

265 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

267 
TabËM­ReduûUt
.
	`š™TabËM­³rJob
(
bËName
, 
sÿn
,

268 
Ho¡M­³r
.
şass
,

269 
Text
.
şass
,

270 
NuÎWr™abË
.
şass
, 
job
);

272 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

273 
job
.
	`£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

275 
job
.
	`£tM­OuutKeyCÏss
(
Text
.
şass
);

276 
job
.
	`£tM­OuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

277 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

278 
job
.
	`£tOuutV®ueCÏss
(
Text
.
şass
);

279 
job
.
	`£tReduûrCÏss
(
Ho¡Reduûr
.
şass
);

281  
job
;

282 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

283 
e
.
	`´štSckT¿û
();

285  
nuÎ
;

286 
	}
}

288 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

289 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

290 
Œy
 {

291 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
)

292 .
	`g‘RemaššgArgs
();

293 
Job
 
job
 = 
RobÙsHo¡G’”©e
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

294 ià(
Ùh”Args
.
Ëngth
 < 1) {

295 
Sy¡em
.
out


296 .
	`´šn
("Wrong‚umber of‡rguments: "

297 + 
Ùh”Args
.
Ëngth


299 
Sy¡em
.
	`ex™
(-1);

301 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

302 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

303 
e
.
	`´štSckT¿û
();

304 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

305 
e
.
	`´štSckT¿û
();

306 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

307 
e
.
	`´štSckT¿û
();

309 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/RobotsProtocolProcess.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

8 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

9 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

10 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

11 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

12 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

40 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

42 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
.
	gRobÙsPrÙocŞP¬£r
;

43 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

44 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

45 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gURLUt
;

47 
public
 cÏs 
	cRobÙsPrÙocŞProûss
 {

48 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

50 
public
 
şass
 
RobÙsPrÙocŞM­³r
 
ex‹nds


51 
	mM­³r
<
	mText
, Text, 
	mImmubËBy‹sWr™abË
, 
	mKeyV®ue
> {

52 
RobÙsPrÙocŞP¬£r
 
	mrobÙsTxtP¬£r
 = 
Ãw
 RobotsProtocolParser();

53 
by‹
 
	mR
[] = 
By‹s
.
toBy‹s
("R");

54 
by‹
 
	ms
[] = 
By‹s
.
toBy‹s
("s");

55 
by‹
 
	mr
[] = 
By‹s
.
toBy‹s
("r");

56 
by‹
 
	mv
[];

58 
ImmubËBy‹sWr™abË
 
	mk
 = 
Ãw
 ImmutableBytesWritable();

60 @
Ov”ride


61 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
,

62 
	mIÁ”ru±edExû±iÚ
 {

66 @
Ov”ride


67 
´Ùeùed
 
m­
(
Text
 
key
, Texˆ
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

68 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

69 
Text
 
	mv
 = 
v®ue
;

70 
	mby‹
[] 
	mb
 = 
v
.
g‘By‹s
();

72 ià(
	mb
[0] == '1') {

73 
·ck‘Num
 = 
Numb”Ut
.
»adIÁ
(
b
, 1);

74 
	m·ck‘L’
 = 0, 
	moff£t
 = 5;

75 
	mh—d”L’
 = 0, 
	mcÚ‹ÁL’
 = 0;

76 
	mu¾L’
 = 0;

77 
	mu¾off£t
 = 0;

78 
SŒšg
 
	mcÚ‹Á
 = 
nuÎ
;

79 
SŒšg
 
	mu¾
 = 
nuÎ
;

80 ià(
	m·ck‘Num
 == 3) {

81 
i
 = 0; 
	mi
 < 2; i++) {

82 ià(
	mi
 == 1) {

83 
u¾L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

84 
	mu¾
 = 
Ãw
 
SŒšg
(
b
, 
off£t
 + 4, 
u¾L’
);

85 
	mu¾off£t
 = 
off£t
 + 4;

87 
	m·ck‘L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

88 
	moff£t
 +ğ
·ck‘L’
 + 4;

90 
	mcÚ‹ÁL’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

91 ià(
	mcÚ‹ÁL’
 < 0) {

92 
	mLog
.
šfo
("error…acket");

95 
	mcÚ‹Á
 = 
Ãw
 
SŒšg
(
b
, 
off£t
 + 4, 
cÚ‹ÁL’
);

99 } ià(
	m·ck‘Num
 == 4) {

100 
i
 = 0; 
	mi
 < 2; i++) {

101 ià(
	mi
 == 1) {

102 
u¾L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

103 
	mu¾off£t
 = 
off£t
 + 4;

104 
	mu¾
 = 
Ãw
 
SŒšg
(
b
, 
off£t
 + 4, 
u¾L’
);

106 
	m·ck‘L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

107 
	moff£t
 +ğ
·ck‘L’
 + 4;

110 
	mh—d”L’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
);

111 
	mcÚ‹ÁL’
 = 
Numb”Ut
.
»adIÁ
(
b
, 
off£t
 + 4 + 
h—d”L’
);

112 
	mcÚ‹Á
 = 
Ãw
 
SŒšg
(
b
, 
off£t
 + 4 + 
h—d”L’
 + 4,

113 
cÚ‹ÁL’
);

118 ià(
	mu¾
 !ğ
nuÎ
 && 
cÚ‹Á
 !=‚ull

119 && 
cÚ‹Á
.
šdexOf
("User-agent") != -1) {

120 
t1
 = 
Sy¡em
.
cu¼’tTimeMlis
();

121 
SŒšg
 
	mrobÙs
 = 
robÙsTxtP¬£r
.
·r£rRobÙsText
(
cÚ‹Á
);

122 
SŒšg
 
	mho¡
 = 
URLUt
.
g‘Ho¡
(
u¾
);

123 
by‹
 
	mh
[] = 
MD5
.
dige¡8
(
ho¡
.
g‘By‹s
()).
g‘Dige¡
();

124 
	mk
.
£t
(
h
);

126 ià(
	mrobÙs
 !ğ
nuÎ
 && !
robÙs
.
equ®s
("")) {

127 
KeyV®ue
 
rkv
 = 
Ãw
 KeyV®ue(
h
, 
R
, 
r
,

128 
robÙs
.
g‘By‹s
());

129 
	mcÚ‹xt
.
wr™e
(
k
, 
rkv
);

130 
	mcÚ‹xt
.
g‘CouÁ”
("spider", "parse_succeed")

131 .
šüem’t
(1);

133 
	mLog
.
šfo
("ho¡ " + 
ho¡
 + "ƒm±y„obÙs" + 
cÚ‹Á
);

135 
KeyV®ue
 
	mkv
 = 
Ãw
 KeyV®ue(
h
, 
R
, 
s
,

136 
cÚ‹Á
.
g‘By‹s
());

137 
	mcÚ‹xt
.
g‘CouÁ”
("¥id”", "robÙs").
šüem’t
(1);

138 
	mcÚ‹xt
.
wr™e
(
k
, 
kv
);

139 
	mt2
 = 
Sy¡em
.
cu¼’tTimeMlis
();

140 ià(
	mt2
 - 
	mt1
 > 1000) {

141 
	mSy¡em
.
	mout
.
´šn
("timcÚsumtoØlÚg ho¡=" + 
ho¡


142 + "ime=" + (
t2
 - 
t1
));

157 
şass
 
RobÙsPrÙocŞReduûr


158 
ex‹nds


159 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gKeyV®ue
, ImmutableBytesWritable, KeyValue> {

160 
	gLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

162 @
Ov”ride


163 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
,

164 
I‹¿bË
<
KeyV®ue
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

165 
	gIÁ”ru±edExû±iÚ
 {

167 
	gkvLi¡
.
ş—r
();

168 
	gI‹¿tÜ
<
	gKeyV®ue
> 
	ge
 = 
v®ues
.
™”©Ü
();

169 
	gi
 = 0;

170 
	ge
.
hasNext
()) {

171 
	gkvLi¡
.
add
(
e
.
Ãxt
().
şÚe
());

173 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

174 
KeyV®ue
 
	gkv
 : 
kvLi¡
) {

175 
cÚ‹xt
.
wr™e
(
key
, 
kv
);

182 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
()

183 
throws
 
CÏssNÙFoundExû±iÚ
 {

184 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

185 
Œy
 {

186 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

187 .
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

188 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

189 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

190 .
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

192  
şazz
;

193 
	}
}

195 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
)

196 
throws
 
IOExû±iÚ
 {

197 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

198 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 ArrayList<ImmutableBytesWritable>(

199 
by‹Keys
.
Ëngth
);

200 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

201 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

203  
»t
;

204 
	}
}

206 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
,

207 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
)

208 
throws
 
	gIOExû±iÚ
 {

209 ià(
	g¡¬tKeys
.
isEm±y
()) {

210 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

217 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(

218 
¡¬tKeys
);

220 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

221 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

222 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
(

224 + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

226 
	gsÜ‹d
.
»move
(
fœ¡
);

229 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

230 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
,

231 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
,

232 
NuÎWr™abË
.
şass
);

234 
	gŒy
 {

235 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

236 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

238 } 
	gfš®ly
 {

239 
	gwr™”
.
şo£
();

243 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
)

244 
throws
 
IOExû±iÚ
 {

245 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

246 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

247 ià(
bËDesütÜ
 =ğ
nuÎ
) {

251 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

252 
i
 = 0;

253 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

254 ià(
i
++ > 0) {

255 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

257 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(

258 
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

259 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

260 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ


261 .
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

264 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

265 
	}
}

267 
public
 
Job
 
	$run
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
[] 
¬gs
è
throws
 
Exû±iÚ
 {

270 
now
 = (è(
Sy¡em
.
	`cu¼’tTimeMlis
() / 1000);

272 
cÚf
.
	`£t
("£rŸlNum", 
SŒšg
.
	`v®ueOf
(
now
));

274 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
, "robots_protocol_import");

275 
P©h
 
š
 = 
Ãw
 
	`P©h
(
¬gs
[0]);

276 
P©h
 
out
 = 
Ãw
 
	`P©h
(
¬gs
[1]);

277 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
š
);

279 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
out
);

281 
job
.
	`£tM­³rCÏss
(
RobÙsPrÙocŞM­³r
.
şass
);

282 
job
.
	`£tReduûrCÏss
(
RobÙsPrÙocŞReduûr
.
şass
);

284 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

285 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

286 
job
.
	`£tM­OuutV®ueCÏss
(
KeyV®ue
.
şass
);

287 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

288 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

289 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

291 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "hostDB");

292 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

293 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

294 
Œy
 {

295 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

296 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

297 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

299 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

301 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

302 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

303 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions "

305 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

307 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "partitions_"

308 + 
Sy¡em
.
	`cu¼’tTimeMlis
());

309 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

310 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

311 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

312 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(),

313 
·¹™iÚsP©h
);

315 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

316 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

317 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

318 
Log
.
	`šfo
("Incrementalable output configured.");

319 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

320 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

322  
job
;

323 
	}
}

325 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

326 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

327 
SŒšg
[] 
Ùh”Args
;

328 
Œy
 {

329 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

330 ià(
Ùh”Args
.
Ëngth
 < 2) {

331 
Sy¡em
.
out
.
	`´šn
("Wrong‚umber of‡rguments: "

332 + 
Ùh”Args
.
Ëngth
);

333 
Sy¡em
.
	`ex™
(-1);

335 
Job
 
job
 = 
	`run
(
cÚf
, 
Ùh”Args
);

336 
Sy¡em
.
	`ex™
(
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1);

337 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

338 
e
.
	`´štSckT¿û
();

339 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

340 
e
.
	`´štSckT¿û
();

343 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/ScanAndGenerateHfile.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

7 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

8 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

9 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

10 
impÜt
 
	gjava
.
	g‹xt
.
	gP¬£Exû±iÚ
;

11 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

12 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

13 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

14 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

15 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

16 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

17 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËIÅutFÜm©
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

42 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

43 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

44 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

45 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

46 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

47 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

48 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

50 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

52 
public
 cÏs 
	cSÿnAndG’”©eHfe
 {

53 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

55 
public
 
şass
 
SÿnM­³r
 
ex‹nds


56 
	mTabËM­³r
<
	mImmubËBy‹sWr™abË
, 
	mKeyV®ue
> {

57 
	mby‹
[] 
	mf
 = 
By‹s
.
toBy‹s
("F");

58 
	mby‹
[] 
	mu
 = 
By‹s
.
toBy‹s
("u");

59 
	mby‹
[] 
	ms
 = 
By‹s
.
toBy‹s
("s");

60 
	mby‹
[] 
	mP
 = 
By‹s
.
toBy‹s
("P");

61 
	mby‹
[] 
	mfšg”
 = 
By‹s
.
toBy‹s
("f");

62 
by‹
 
	mÏ
[] = 
By‹s
.
toBy‹s
("la");

63 
by‹
 
	mh
[] = 
By‹s
.
toBy‹s
("h");

64 
by‹
 
	muÆßd
[] = 
By‹s
.
toBy‹s
("0");

66 
by‹
 
	ma
[] = 
By‹s
.
toBy‹s
("a");

67 
by‹
 
	md
[] = 
By‹s
.
toBy‹s
("d");

68 
by‹
 
	mi
[] = 
By‹s
.
toBy‹s
("i");

69 
by‹
 
	mm
[] = 
By‹s
.
toBy‹s
("m");

70 
by‹
 
	mt
[] = 
Ãw
 byte[12];

72 
by‹
 
	me
[] = 
By‹s
.
toBy‹s
("e");

73 
by‹
 
	mz”o
[] = 
By‹s
.
toBy‹s
("0");

75 @
Ov”ride


76 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
ResuÉ
 
v®ue
,

77 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

81 
	m©ime
 = 0, 
	mmtime
 = 0, 
	m™ime
 = 0, 
	mdtime
 = 0;

82 
by‹
 
	macûss_time
[] = 
nuÎ
, 
	mš£¹_time
[] =‚uÎ, 
	mdowÆßd_time
[] =‚uÎ, 
	mmodify_time
[] =‚ull;

84 
	mš£¹_time
 = 
v®ue
.
g‘V®ue
(
f
, 
i
);

85 
	mdowÆßd_time
 = 
v®ue
.
g‘V®ue
(
f
, 
d
);

107 ià(
	mdowÆßd_time
 !ğ
nuÎ
) {

115 
dtime
=
Numb”Ut
.
»adIÁ
(
dowÆßd_time
, 0);

130 
	mdowÆßd_time
 =
By‹s
.
toBy‹s
(
dtime
);

146 ià(
	mdtime
 != 0) {

147 
KeyV®ue
 
kv4
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
f
, 
d
, 
dowÆßd_time
);

148 
	mcÚ‹xt
.
wr™e
(
key
, 
kv4
);

173 
public
 
şass
 
SÿnReduûr


174 
ex‹nds


175 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gKeyV®ue
, ImmutableBytesWritable, KeyValue> {

176 
	gLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

178 @
Ov”ride


179 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
,

180 
I‹¿bË
<
KeyV®ue
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

181 
	gIÁ”ru±edExû±iÚ
 {

183 
	gkvLi¡
.
ş—r
();

184 
	gI‹¿tÜ
<
	gKeyV®ue
> 
	ge
 = 
v®ues
.
™”©Ü
();

185 
	gi
 = 0;

186 
	ge
.
hasNext
()) {

187 
	gkvLi¡
.
add
(
e
.
Ãxt
().
şÚe
());

191 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

192 
KeyV®ue
 
	gkv
 : 
kvLi¡
) {

193 
cÚ‹xt
.
wr™e
(
key
, 
kv
);

200 
SŒšg
 
	$cÚv”tSÿnToSŒšg
(
Sÿn
 
sÿn
è
throws
 
IOExû±iÚ
 {

201 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

202 
D©aOuutSŒ—m
 
dos
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

203 
sÿn
.
	`wr™e
(
dos
);

204  
Ba£64
.
	`’codeBy‹s
(
out
.
	`toBy‹A¼ay
());

205 
	}
}

220 
´iv©e
 
	$addCŞumn
(
Sÿn
 
sÿn
, 
by‹
[] 
çmyAndQu®if›r
) {

221 
by‹
[][] 
fq
 = 
KeyV®ue
.
	`·r£CŞumn
(
çmyAndQu®if›r
);

222 ià(
fq
.
Ëngth
 > 1 && fq[1] !ğ
nuÎ
 && fq[1].length > 0) {

223 
sÿn
.
	`addCŞumn
(
fq
[0], fq[1]);

225 
sÿn
.
	`addFamy
(
fq
[0]);

227 
	}
}

241 
public
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
by‹
[][] 
cŞumns
) {

242 
by‹
[] 
cŞumn
 : 
cŞumns
) {

243 
	`addCŞumn
(
sÿn
, 
cŞumn
);

245 
	}
}

257 
´iv©e
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
SŒšg
 
cŞumns
) {

258 
SŒšg
[] 
cŞs
 = 
cŞumns
.
	`¥l™
(" ");

259 
SŒšg
 
cŞ
 : 
cŞs
) {

260 
	`addCŞumn
(
sÿn
, 
By‹s
.
	`toBy‹s
(
cŞ
));

262 
	}
}

264 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
()

265 
throws
 
CÏssNÙFoundExû±iÚ
 {

266 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

267 
Œy
 {

268 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

269 .
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

270 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

271 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

272 .
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

274  
şazz
;

275 
	}
}

277 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
)

278 
throws
 
IOExû±iÚ
 {

279 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

280 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 ArrayList<ImmutableBytesWritable>(

281 
by‹Keys
.
Ëngth
);

282 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

283 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

285  
»t
;

286 
	}
}

288 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
,

289 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
)

290 
throws
 
	gIOExû±iÚ
 {

291 ià(
	g¡¬tKeys
.
isEm±y
()) {

292 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

299 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(

300 
¡¬tKeys
);

302 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

303 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

304 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
(

306 + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

308 
	gsÜ‹d
.
»move
(
fœ¡
);

311 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

312 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
,

313 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
,

314 
NuÎWr™abË
.
şass
);

316 
	gŒy
 {

317 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

318 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

320 } 
	gfš®ly
 {

321 
	gwr™”
.
şo£
();

325 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
)

326 
throws
 
IOExû±iÚ
 {

327 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

328 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

329 ià(
bËDesütÜ
 =ğ
nuÎ
) {

333 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

334 
i
 = 0;

335 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

336 ià(
i
++ > 0) {

337 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

339 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(

340 
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

341 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

342 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ


343 .
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

346 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

347 
	}
}

349 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

350 
Œy
 {

352 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

353 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "webDB");

354 
sÿn
.
	`£tCachšg
(500);

357 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("F"), Bytes.toBytes("d"));

365 ià(
cÚf
.
	`g‘
("sÿn_f‹r"è!ğ
nuÎ
) {

366 
F‹r
 
f‹r
;

367 
Œy
 {

368 
P¬£F‹r
 
·r£
 = 
Ãw
 
	`P¬£F‹r
();

369 
f‹r
 = 
·r£
.
	`·r£F‹rSŒšg
(
cÚf
.
	`g‘
("scan_filter"));

370 
Sy¡em
.
out
.
	`´šn
("£ˆf‹¸" + 
cÚf
.
	`g‘
("scan_filter"));

371 
sÿn
.
	`£tF‹r
(
f‹r
);

372 } 
	`ÿtch
 (
Ch¬aù”CodšgExû±iÚ
 
e1
) {

374 
e1
.
	`´štSckT¿û
();

385 
P¬£F‹r
 
·r£
 = 
Ãw
 
	`P¬£F‹r
();

386 
F‹r
 
f‹r
 = 
·r£


387 .
	`·r£F‹rSŒšg
("SingleColumnValueFilter('F','d',!=,'binary:0',true,true)");

388 
sÿn
.
	`£tF‹r
(
f‹r
);

391 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
è!ğ
nuÎ
) {

392 
	`addCŞumns
(
sÿn
, 
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
));

395 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
è!ğ
nuÎ
) {

396 
sÿn
.
	`addFamy
(
By‹s
.
	`toBy‹s
(
cÚf


397 .
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
)));

399 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
è!ğ
nuÎ
) {

400 
sÿn
.
	`£tMaxV”siÚs
(
IÁeg”
.
	`·r£IÁ
(
cÚf


401 .
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
)));

406 
cÚf
.
	`£t
(
TabËIÅutFÜm©
.
SCAN
, 
	`cÚv”tSÿnToSŒšg
(
sÿn
));

408 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

409 
job
.
	`£tM­OuutV®ueCÏss
(
KeyV®ue
.
şass
);

410 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

411 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

412 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

413 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

414 
TabËM­ReduûUt
.
	`š™TabËM­³rJob
(
bËName
, 
sÿn
,

415 
SÿnM­³r
.
şass
, 
ImmubËBy‹sWr™abË
.class,

416 
KeyV®ue
.
şass
, 
job
);

418 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

419 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

420 
Œy
 {

421 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

422 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

423 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

425 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

426 
job
.
	`£tReduûrCÏss
(
SÿnReduûr
.
şass
);

428 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

429 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

430 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions "

432 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

434 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(),

435 "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

436 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

437 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

438 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

439 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(),

440 
·¹™iÚsP©h
);

442 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
()

444 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

445 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

446 
Log
.
	`šfo
("Incrementalable output configured.");

447 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

448 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

450  
job
;

451 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

453 
e
.
	`´štSckT¿û
();

454 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

456 
e
.
	`´štSckT¿û
();

458  
nuÎ
;

459 
	}
}

461 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

462 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

463 
Œy
 {

464 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
)

465 .
	`g‘RemaššgArgs
();

466 
Job
 
job
 = 
SÿnAndG’”©eHfe
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

467 ià(
Ùh”Args
.
Ëngth
 < 1) {

468 
Sy¡em
.
out


469 .
	`´šn
("Wrong‚umber of‡rguments: "

470 + 
Ùh”Args
.
Ëngth


472 
Sy¡em
.
	`ex™
(-1);

474 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

475 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

477 
e
.
	`´štSckT¿û
();

478 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

480 
e
.
	`´štSckT¿û
();

481 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

483 
e
.
	`´štSckT¿û
();

485 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/ScanHbase.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

7 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

8 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËIÅutFÜm©
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gTextOuutFÜm©
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

33 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
.
	gRobÙsF‹r
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gu¾
.
	gURLF‹r
;

35 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

37 
	eDu¶id©e
 {

38 
	mu¾
;

41 
public
 cÏs 
	cSÿnHba£
 {

42 
public
 
şass
 
SÿnM­³r
 
ex‹nds
 
	mTabËM­³r
<
	mText
, Text> {

43 
	mby‹
[] 
	mf
 = 
By‹s
.
toBy‹s
("F");

44 
	mby‹
[] 
	mu
 = 
By‹s
.
toBy‹s
("u");

45 
	mby‹
[] 
	mh
 = 
By‹s
.
toBy‹s
("H");

46 
	mby‹
[] 
	ms
 = 
By‹s
.
toBy‹s
("s");

47 
	mby‹
[] 
	mp
 = 
By‹s
.
toBy‹s
("P");

48 
	mby‹
[] 
	mfšg”
 = 
By‹s
.
toBy‹s
("f");

50 
URLF‹r
 
	mf‹r
 = 
nuÎ
;

52 @
Ov”ride


53 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
)

54 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

55 
	msu³r
.
£tup
(
cÚ‹xt
);

57 
	mf‹r
 = 
Ãw
 
RobÙsF‹r
();

58 
	mf‹r
.
£tCÚf
(
cÚ‹xt
.
g‘CÚfigu¿tiÚ
());

61 @
Ov”ride


62 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
ResuÉ
 
v®ue
,

63 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

96 
	mcÚ‹xt
.
g‘CouÁ”
("sÿnhba£", "u¾_couÁ").
šüem’t
(1);

98 
by‹
 
	ma
[] = 
v®ue
.
g‘V®ue
(
f
, 
u
);

99 
	mŒy
 {

100 ià(
	ma
 =ğ
nuÎ
) {

101 
cÚ‹xt
.
g‘CouÁ”
("sÿn_hba£", "em±y_u¾").
šüem’t
(1);

104 
SŒšg
 
	mu¾
 = 
Ãw
 SŒšg(
a
);

105 
	mŒy
 {

106 
SŒšg
 
	mm
 = 
f‹r
.f‹r(
u¾
);

107 ià(
	mm
 =ğ
nuÎ
) {

108 
cÚ‹xt
.
wr™e
(

109 
Ãw
 
Text
(
Numb”Ut
.
g‘HexSŒšg
(
key
.
g‘
())),

110 
Ãw
 
Text
(
u¾
));

112 } 
ÿtch
 (
Exû±iÚ
 
e
) {

114 
	mcÚ‹xt
.
g‘CouÁ”
("sÿn_hba£", "”rÜ_u¾").
šüem’t
(1);

116 } 
ÿtch
 (
Exû±iÚ
 
e
) {

118 
	me
.
´štSckT¿û
();

133 
public
 
şass
 
SÿnReduûr
 
ex‹nds
 
	gReduûr
<
	gText
, Text, Text, Text> {

135 @
Ov”ride


136 
´Ùeùed
 
»duû
(
Text
 
key
, 
I‹¿bË
<Text> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
)

137 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

138 
Text
 
	gv
 : 
v®ues
) {

139 
cÚ‹xt
.
wr™e
(
key
, 
v
);

144 
SŒšg
 
	$cÚv”tSÿnToSŒšg
(
Sÿn
 
sÿn
è
throws
 
IOExû±iÚ
 {

145 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

146 
D©aOuutSŒ—m
 
dos
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

147 
sÿn
.
	`wr™e
(
dos
);

148  
Ba£64
.
	`’codeBy‹s
(
out
.
	`toBy‹A¼ay
());

149 
	}
}

164 
´iv©e
 
	$addCŞumn
(
Sÿn
 
sÿn
, 
by‹
[] 
çmyAndQu®if›r
) {

165 
by‹
[][] 
fq
 = 
KeyV®ue
.
	`·r£CŞumn
(
çmyAndQu®if›r
);

166 ià(
fq
.
Ëngth
 > 1 && fq[1] !ğ
nuÎ
 && fq[1].length > 0) {

167 
sÿn
.
	`addCŞumn
(
fq
[0], fq[1]);

169 
sÿn
.
	`addFamy
(
fq
[0]);

171 
	}
}

185 
public
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
by‹
[][] 
cŞumns
) {

186 
by‹
[] 
cŞumn
 : 
cŞumns
) {

187 
	`addCŞumn
(
sÿn
, 
cŞumn
);

189 
	}
}

201 
´iv©e
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
SŒšg
 
cŞumns
) {

202 
SŒšg
[] 
cŞs
 = 
cŞumns
.
	`¥l™
(" ");

203 
SŒšg
 
cŞ
 : 
cŞs
) {

204 
	`addCŞumn
(
sÿn
, 
By‹s
.
	`toBy‹s
(
cŞ
));

206 
	}
}

208 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

209 
Œy
 {

211 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

212 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "webDB");

213 
sÿn
.
	`£tCachšg
(500);

214 
sÿn
.
	`addCŞumn
(
By‹s
.
	`toBy‹s
("F"), Bytes.toBytes("u"));

219 ià(
cÚf
.
	`g‘
("sÿn_f‹r"è!ğ
nuÎ
) {

220 
F‹r
 
f‹r
;

221 
Œy
 {

222 
P¬£F‹r
 
·r£
 = 
Ãw
 
	`P¬£F‹r
();

223 
f‹r
 = 
·r£
.
	`·r£F‹rSŒšg
(
cÚf
.
	`g‘
("scan_filter"));

224 
Sy¡em
.
out
.
	`´šn
("£ˆf‹¸" + 
cÚf
.
	`g‘
("scan_filter"));

225 
sÿn
.
	`£tF‹r
(
f‹r
);

226 } 
	`ÿtch
 (
Ch¬aù”CodšgExû±iÚ
 
e1
) {

228 
e1
.
	`´štSckT¿û
();

231 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
è!ğ
nuÎ
) {

232 
	`addCŞumns
(
sÿn
, 
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
));

235 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
è!ğ
nuÎ
) {

236 
sÿn
.
	`addFamy
(
By‹s
.
	`toBy‹s
(
cÚf


237 .
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
)));

239 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
è!ğ
nuÎ
) {

240 
sÿn
.
	`£tMaxV”siÚs
(
IÁeg”
.
	`·r£IÁ
(
cÚf


241 .
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
)));

245 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

246 
cÚf
.
	`£t
("mapred.map.output.compression.codec",

252 
URI
 
ho¡u¾
 = 
Ãw
 
	`URI
(

255 
URI
 
domašu¾
 = 
Ãw
 
	`URI
(

258 
Di¡ribu‹dCache
.
	`addCacheFe
(
ho¡u¾
, 
cÚf
);

259 
Di¡ribu‹dCache
.
	`addCacheFe
(
domašu¾
, 
cÚf
);

260 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

261 
cÚf
.
	`£tBoŞ—n
("u£Di¡ribu‹Cache", 
Œue
);

262 
cÚf
.
	`£t
("robot_idx_name", "robotidx-r-00000");

263 
cÚf
.
	`£t
("robot_file_name", "part-r-00000");

264 
cÚf
.
	`£t
(
TabËIÅutFÜm©
.
SCAN
, 
	`cÚv”tSÿnToSŒšg
(
sÿn
));

265 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

267 
TabËM­ReduûUt
.
	`š™TabËM­³rJob
(
bËName
, 
sÿn
,

268 
SÿnM­³r
.
şass
, 
Text
.şass, 
NuÎWr™abË
.şass, 
job
);

270 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

271 
job
.
	`£tOuutFÜm©CÏss
(
TextOuutFÜm©
.
şass
);

272 
job
.
	`£tM­OuutKeyCÏss
(
Text
.
şass
);

273 
job
.
	`£tM­OuutV®ueCÏss
(
Text
.
şass
);

275 
job
.
	`£tOuutKeyCÏss
(
Text
.
şass
);

276 
job
.
	`£tOuutV®ueCÏss
(
Text
.
şass
);

277 
job
.
	`£tM­S³cuÏtiveExecutiÚ
(
çl£
);

278 
job
.
	`£tReduûrCÏss
(
SÿnReduûr
.
şass
);

282  
job
;

283 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

284 
e
.
	`´štSckT¿û
();

285 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

286 
e
.
	`´štSckT¿û
();

288  
nuÎ
;

289 
	}
}

291 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

292 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

293 
Œy
 {

294 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
)

295 .
	`g‘RemaššgArgs
();

296 
Job
 
job
 = 
SÿnHba£
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

297 ià(
Ùh”Args
.
Ëngth
 < 1) {

298 
Sy¡em
.
out
.
	`´šn
("Wrong‚umber of‡rguments: " +

299 
Ùh”Args
.
Ëngth
 +

301 
Sy¡em
.
	`ex™
(-1);

303 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

304 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

305 
e
.
	`´štSckT¿û
();

306 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

307 
e
.
	`´štSckT¿û
();

308 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

309 
e
.
	`´štSckT¿û
();

311 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/ScoreURLStatistic.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gBufã»dR—d”
;

4 
impÜt
 
	gjava
.
	gio
.
	gFe
;

5 
impÜt
 
	gjava
.
	gio
.
	gFeIÅutSŒ—m
;

6 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

7 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—mR—d”
;

8 
impÜt
 
	gjava
.
	gÃt
.
	gURL
;

9 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

10 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

11 
impÜt
 
	gjava
.
	gut
.
	gCom·¿tÜ
;

12 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

13 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gPaœ
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gFlßtWr™abË
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gIÁWr™abË
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gTextOuutFÜm©
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

32 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

34 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

35 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gURLUt
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gScÜeURLInfo
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

39 
public
 cÏs 
	cScÜeURLSti¡ic
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

41 
şass
 
ScÜeURLM­³r
 
ex‹nds


42 
	mM­³r
<
	mFlßtWr™abË
, 
	mText
, Text, 
	mScÜeURLInfo
> {

43 
	mHashS‘
<
	mSŒšg
> 
	mbÏckDomaš
=
Ãw
 
HashS‘
<
SŒšg
>();

44 
	mHashS‘
<
	mSŒšg
> 
	mbÏckHo¡
=
Ãw
 
HashS‘
<
SŒšg
>();

46 @
Ov”ride


47 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
,

48 
	mIÁ”ru±edExû±iÚ
 {

50 
P©h
 
	mÿchesFes
[] = 
Di¡ribu‹dCache
.
g‘LoÿlCacheFes
(
cÚ‹xt


51 .
g‘CÚfigu¿tiÚ
());

52 
P©h
 
	m·th
 : 
ÿchesFes
) {

53 
Log
.
šfo
("g‘‡†oÿÈÿche f·th" + 
·th
.
toSŒšg
());

54 
SŒšg
 
	mt
 = 
·th
.
toSŒšg
();

55 ià(
	mt
.
cÚšs
("blackdomain.txt")) {

56 
Bufã»dR—d”
 
	m»ad”
 = 
Ãw
 BufferedReader(

57 
Ãw
 
IÅutSŒ—mR—d”
Òew 
FeIÅutSŒ—m
Òew 
Fe
(

58 
t
))));

59 
SŒšg
 
	mlše
 = 
nuÎ
;

60 (
	mlše
 = 
»ad”
.
»adLše
()è!ğ
nuÎ
) {

61 
SŒšg
 
»Ho¡
 = 
URLUt
.
ho¡Rev”£
(
lše
.
Œim
());

62 
	mthis
.
	mbÏckDomaš
.
add
(
»Ho¡
);

64 
	m»ad”
.
şo£
();

65 } ià(
	mt
.
cÚšs
("blackhost.txt")) {

66 
Bufã»dR—d”
 
	m»ad”
 = 
Ãw
 BufferedReader(

67 
Ãw
 
IÅutSŒ—mR—d”
Òew 
FeIÅutSŒ—m
Òew 
Fe
(

68 
t
))));

69 
SŒšg
 
	mlše
 = 
nuÎ
;

70 (
	mlše
 = 
»ad”
.
»adLše
()è!ğ
nuÎ
) {

71 
SŒšg
 
»Ho¡
 = 
URLUt
.
ho¡Rev”£
(
lše
.
Œim
());

72 
	mthis
.
	mbÏckHo¡
.
add
(
»Ho¡
);

74 
	m»ad”
.
şo£
();

78 
	mLog
.
šfo
("lßd bÏck dßmš size="+
this
.
bÏckDomaš
.
size
()+"\tbÏck ho¡ size="+this.
bÏckHo¡
.size());

82 @
Ov”ride


83 
´Ùeùed
 
m­
(
FlßtWr™abË
 
key
, 
Text
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

84 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

86 
by‹
 
	mby‹s
[] = 
v®ue
.
g‘By‹s
();

87 
	mu¾L’
 = 
Numb”Ut
.
»adIÁ
(
by‹s
, 44);

88 
SŒšg
 
	mu¾SŒ
 = 
Ãw
 SŒšg(
by‹s
, 48, 
u¾L’
);

89 
	mŒy
 {

90 
URL
 
	mu¾
 = 
Ãw
 URL(
u¾SŒ
);

91 
SŒšg
 
	mho¡
 = 
u¾
.
g‘Ho¡
();

92 
SŒšg
 
	m»Ho¡
 = 
URLUt
.
ho¡Rev”£
(
ho¡
);

94 
SŒšg
 
	mdomaš
 = 
URLUt
.
g‘DomašByHo¡
(
ho¡
);

95 
SŒšg
 
	m»domaš
 = 
URLUt
.
ho¡Rev”£
(
domaš
);

96 ià(
	mthis
.
	mbÏckDomaš
.
cÚšs
(
»domaš
)) {

97 
ScÜeURLInfo
 
	mšfo
 = 
Ãw
 ScoreURLInfo();

98 
	mšfo
.
£tAÎNum
(
Ãw
 
IÁWr™abË
(1));

99 ià(
	mkey
.
g‘
() < 0) {

100 
	mšfo
.
£tNewNum
(
Ãw
 
IÁWr™abË
(1));

102 
	mšfo
.
£tNewNum
(
Ãw
 
IÁWr™abË
(0));

104 
	mcÚ‹xt
.
wr™e
(
Ãw
 
Text
(
domaš
), 
šfo
);

105 
	mcÚ‹xt
.
g‘CouÁ”
("u¾CouÁ”", "bÏckDomaš").
šüem’t
(1);

107 
SŒšg
 
	m»Lev–OÃHo¡
 = 
»Ho¡
;

108 ià(
	m»Ho¡
.
Ëngth
(è> 
	m»domaš
.length()) {

109 
	mdÙ
 = 
»Ho¡
.
šdexOf
(".", 
»domaš
.
Ëngth
()+2);

110 ià(
	mdÙ
 != -1) {

111 
»Lev–OÃHo¡
 = 
»Ho¡
.
sub¡ršg
(0, 
dÙ
);

116 ià(
	mthis
.
	mbÏckHo¡
.
cÚšs
(
»Lev–OÃHo¡
)) {

117 
SŒšg
 
	mËv–OÃHo¡
 = 
URLUt


118 .
ho¡Rev”£
(
»Lev–OÃHo¡
);

119 
ScÜeURLInfo
 
	mšfo
 = 
Ãw
 ScoreURLInfo();

120 
	mšfo
.
£tAÎNum
(
Ãw
 
IÁWr™abË
(1));

121 ià(
	mkey
.
g‘
() < 0) {

122 
	mšfo
.
£tNewNum
(
Ãw
 
IÁWr™abË
(1));

124 
	mšfo
.
£tNewNum
(
Ãw
 
IÁWr™abË
(0));

126 
	mcÚ‹xt
.
g‘CouÁ”
("u¾CouÁ”", "bÏckHo¡").
šüem’t
(1);

127 
	mcÚ‹xt
.
wr™e
(
Ãw
 
Text
(
Ëv–OÃHo¡
), 
šfo
);

129 
ScÜeURLInfo
 
	mšfo
 = 
Ãw
 ScoreURLInfo();

130 
	mšfo
.
£tAÎNum
(
Ãw
 
IÁWr™abË
(1));

131 ià(
	mkey
.
g‘
() < 0) {

132 
	mšfo
.
£tNewNum
(
Ãw
 
IÁWr™abË
(1));

134 
	mšfo
.
£tNewNum
(
Ãw
 
IÁWr™abË
(0));

136 
	mcÚ‹xt
.
wr™e
(
Ãw
 
Text
(
ho¡
), 
šfo
);

137 
	mcÚ‹xt
.
g‘CouÁ”
("u¾CouÁ”", "nÜm®URL").
šüem’t
(1);

144 } 
ÿtch
 (
Exû±iÚ
 
e
) {

145 
	me
.
´štSckT¿û
();

152 
şass
 
ScÜeURLReduûr
 
ex‹nds


153 
	gReduûr
<
	gText
, 
	gScÜeURLInfo
, Text, Text> {

154 
´iv©e
 
	gLi¡
<
	gPaœ
<
	gSŒšg
, 
	gScÜeURLInfo
>> 
	gi¡
 = 
Ãw
 
A¼ayLi¡
<
Paœ
<
SŒšg
, ScoreURLInfo>>(1000000);

156 @
Ov”ride


157 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

158 
	gIÁ”ru±edExû±iÚ
 {

160 
	gsu³r
.
£tup
(
cÚ‹xt
);

163 @
Ov”ride


164 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

165 
	gIÁ”ru±edExû±iÚ
 {

167 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

169 
	gCŞËùiÚs
.
sÜt
(
i¡
,

170 
Ãw
 
Com·¿tÜ
<
Paœ
<
SŒšg
, 
ScÜeURLInfo
>>() {

172 @
Ov”ride


173 
public
 
com·»
(
Paœ
<
SŒšg
, 
ScÜeURLInfo
> 
¬g0
,

174 
Paœ
<
SŒšg
, 
ScÜeURLInfo
> 
¬g1
) {

176  
¬g0
.
g‘SecÚd
().
g‘AÎNum
()

177 .
com·»To
(
¬g1
.
g‘SecÚd
().
g‘AÎNum
());

181 
	gPaœ
<
	gSŒšg
, 
	gScÜeURLInfo
> 
	gp
 : 
i¡
) {

182 
ScÜeURLInfo
 
šfo
 = 
p
.
g‘SecÚd
();

183 
SŒšg
 
	gt
 = 
šfo
.
g‘AÎNum
().
g‘
() + "\t"

184 + 
šfo
.
g‘NewNum
().
g‘
() + "\t"

185 + (
šfo
.
g‘AÎNum
().
g‘
(è- info.
g‘NewNum
().get());

186 
	gcÚ‹xt
.
wr™e
(
Ãw
 
Text
(
p
.
g‘Fœ¡
()),‚ew Text(
t
));

191 @
Ov”ride


192 
´Ùeùed
 
»duû
(
Text
 
key
, 
I‹¿bË
<
ScÜeURLInfo
> 
v®ues
,

193 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

194 
	g®lNum
 = 0, 
	gŞdNum
 = 0, 
	gÃwNum
 = 0;

195 
ScÜeURLInfo
 
	gšfo
 : 
v®ues
) {

196 
®lNum
 +ğ
šfo
.
g‘AÎNum
().
g‘
();

197 
	gÃwNum
 +ğ
šfo
.
g‘NewNum
().
g‘
();

199 
	gŞdNum
 = 
®lNum
 - 
ÃwNum
;

201 
ScÜeURLInfo
 
	gšfo
 = 
Ãw
 ScoreURLInfo();

202 
	gšfo
.
£tAÎNum
(
Ãw
 
IÁWr™abË
(
®lNum
));

203 
	gšfo
.
£tNewNum
(
Ãw
 
IÁWr™abË
(
ÃwNum
));

204 
	gthis
.
	gi¡


205 .
add
(
Ãw
 
Paœ
<
SŒšg
, 
ScÜeURLInfo
>(
key
.
toSŒšg
(), 
šfo
));

210 
Job
 
	$ü—‹Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
[] 
¬gs
) {

211 
Job
 
job
;

212 
Œy
 {

213 
job
 = 
Ãw
 
	`Job
(
cÚf
);

215 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]),

216 
Sequ’ûFeIÅutFÜm©
.
şass
, 
ScÜeURLM­³r
.class);

217 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

218 
job
.
	`£tM­OuutKeyCÏss
(
Text
.
şass
);

219 
job
.
	`£tM­OuutV®ueCÏss
(
ScÜeURLInfo
.
şass
);

220 
job
.
	`£tReduûrCÏss
(
ScÜeURLReduûr
.
şass
);

221 
job
.
	`£tOuutKeyCÏss
(
Text
.
şass
);

222 
job
.
	`£tOuutV®ueCÏss
(
Text
.
şass
);

223 
job
.
	`£tOuutFÜm©CÏss
(
TextOuutFÜm©
.
şass
);

224  
job
;

225 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

227 
e
.
	`´štSckT¿û
();

230  
nuÎ
;

231 
	}
}

233 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

234 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

235 
SŒšg
[] 
Ùh”Args
;

236 
Œy
 {

237 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

238 ià(
Ùh”Args
.
Ëngth
 < 2) {

239 
Sy¡em
.
out


240 .
	`´šn
("Wrong‚umber of‡rguments: "

241 + 
Ùh”Args
.
Ëngth


243 
Sy¡em
.
	`ex™
(-1);

245 
Job
 
job
 = 
	`ü—‹Job
(
cÚf
, 
Ùh”Args
);

246 
Sy¡em
.
	`ex™
(
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1);

247 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

249 
e
.
	`´štSckT¿û
();

250 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

252 
e
.
	`´štSckT¿û
();

254 
	}
}

256 @
Ov”ride


257 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

259 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

260 
this
.
	`£tCÚf
(
cÚf
);

261 
SŒšg
[] 
Ùh”Args
;

262 
Œy
 {

263 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

264 ià(
Ùh”Args
.
Ëngth
 < 2) {

265 
Sy¡em
.
out


266 .
	`´šn
("Wrong‚umber of‡rguments: "

267 + 
Ùh”Args
.
Ëngth


269 
Sy¡em
.
	`ex™
(-1);

271 
Job
 
job
 = 
	`ü—‹Job
(
cÚf
, 
Ùh”Args
);

272  
job
;

273 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

275 
e
.
	`´štSckT¿û
();

276 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

278 
e
.
	`´štSckT¿û
();

280  
nuÎ
;

282 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/SendWebPage.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gIÃtAdd»ss
;

5 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

8 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

9 
impÜt
 
	gjava
.
	gut
.
	gHashS‘
;

10 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

11 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

12 
impÜt
 
	gjava
.
	gut
.
	gM­
;

13 
impÜt
 
	gjava
.
	gut
.
	gNavigabËM­
;

14 
impÜt
 
	gjava
.
	gut
.
	gS‘
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿bË
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHRegiÚInfo
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHRegiÚLoÿtiÚ
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gS”v”Name
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉSÿÂ”
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gRow
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gCom·»F‹r
.
	gCom·»Op
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gSšgËCŞumnV®ueF‹r
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

42 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

43 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

44 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

45 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

46 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

47 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

48 
impÜt
 
	gÜg
.
	g­ache
.
	glog4j
.
	gLogg”
;

49 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

51 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

52 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gHo¡Sequ’ûFeIÅutFÜm©
;

53 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

54 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gS–eùAndS’dJob
;

55 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gSpid”Job
;

64 
public
 cÏs 
	cS’dWebPage
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

65 
Logg”
 
	mlogg”
 = 
S–eùAndS’dJob
.
logg”
;

66 
D©eFÜm©
 
	mfÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyyMMddHHmmss");

67 
HTabË
 
	mbË
;

68 
	mHashM­
<
	mSŒšg
, 
	mSequ’ûFe
.
	mWr™”
> 
	mwr™”M­
;

69 
	mNavigabËM­
<
	mHRegiÚInfo
, 
	mS”v”Name
> 
	m»giÚM­
;

71 
	mby‹
[] 
	mÏ¡S¹Key
;

72 
	mby‹
[] 
	mÏ¡EndKey
;

73 
	mSequ’ûFe
.
Wr™”
 
	mÏ¡Wr™”
;

75 
public
 
	$S’dWebPage
() {

76 
Œy
 {

77 ià(
this
.
	`g‘CÚf
(è=ğ
nuÎ
) {

78 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

79 
this
.
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, "webDB");

81 
this
.
bË
 = 
Ãw
 
	`HTabË
Ñhis.
	`g‘CÚf
(), "webDB");

83 
»giÚM­
 = 
bË
.
	`g‘RegiÚLoÿtiÚs
();

84 
wr™”M­
 = 
Ãw
 
HashM­
<
SŒšg
, 
Sequ’ûFe
.
Wr™”
>();

85 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

87 
e
.
	`´štSckT¿û
();

97 
´iv©e
 
boŞ—n
 
	$ü—‹Wr™”
() {

98 
Œy
 {

99 
FeSy¡em
 
fs
;

100 
fs
 = 
FeSy¡em
.
	`g‘
(
this
.
	`g‘CÚf
());

101 
NavigabËM­
<
HRegiÚInfo
, 
S”v”Name
> 
»giÚM­
 = 
bË
.
	`g‘RegiÚLoÿtiÚs
();

102 
i
 = 0;

103 
SŒšg
 
¡
 = 
this
.
	`g‘CÚf
().
	`g‘
("seqTimestamp");

104 ià(
¡
 =ğ
nuÎ
 || st.
	`equ®s
(""))

105  
çl£
;

106 
SŒšg
 
lßdli¡Dœ
 = 
Spid”Job
.
ROOT_DIR
 + "/" + Spid”Job.
SELECT_LOAD_DOCID_DIR
 + "/" + 
¡
;

107 
S”v”Name
 
£rv”Name
 : 
»giÚM­
.
	`v®ues
()) {

108 ià(!
this
.
wr™”M­
.
	`cÚšsKey
(
£rv”Name
.
	`g‘Ho¡Çme
())) {

109 
SŒšg
 
feName
 = 
lßdli¡Dœ
 + "/" + SŒšg.
	`v®ueOf
(
£rv”Name
.
	`g‘Ho¡Çme
()è+ "___" + (
i
++);

110 
P©h
 
Í©h
 = 
Ãw
 
	`P©h
(
feName
);

111 
logg”
.
	`šfo
("wr™”…©h " + 
feName
);

112 
Sequ’ûFe
.
Wr™”
 
lßdWr™”
 = Sequ’ûFe.
	`ü—‹Wr™”
(
fs
, 
this
.
	`g‘CÚf
(), 
Í©h
, 
ImmubËBy‹sWr™abË
.
şass
, ImmutableBytesWritable.class);

113 
this
.
wr™”M­
.
	`put
(
£rv”Name
.
	`g‘Ho¡Çme
(), 
lßdWr™”
);

116 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

117 
e
.
	`´štSckT¿û
();

118  
çl£
;

120  
Œue
;

121 
	}
}

123 @
Ov”ride


124 
public
 
	$£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

126 
su³r
.
	`£tCÚf
(
cÚf
);

128 
	}
}

130 
´iv©e
 
HRegiÚInfo
 
	$g‘DocidRegiÚ
(
by‹
[] 
docid
) {

131 
M­
.
EÁry
<
HRegiÚInfo
, 
S”v”Name
> 
’Œy
 : 
this
.
»giÚM­
.
	`’ŒyS‘
()) {

132 
HRegiÚInfo
 
»giÚ
 = 
’Œy
.
	`g‘Key
();

133 
by‹
[] 
¡¬t
 = 
»giÚ
.
	`g‘S¹Key
();

134 
by‹
[] 
’d
 = 
»giÚ
.
	`g‘EndKey
();

136 ià((
¡¬t
.
Ëngth
 =ğ0 || 
By‹s
.
	`com·»To
(
docid
, s¹è>ğ0è&& (
’d
.length == 0 || Bytes.compareTo(docid,ƒnd) < 0)) {

137  
»giÚ
;

141 
logg”
.
	`šfo
("”rÜ cª‚Ù fšd‡µrİrŸ‹„egiÚ fÜ docid " + 
Numb”Ut
.
	`g‘HexSŒšg
(
docid
));

142  
nuÎ
;

143 
	}
}

145 
´iv©e
 
	$şo£Wr™”
() {

147 
M­
.
EÁry
<
SŒšg
, 
Sequ’ûFe
.
Wr™”
> 
’Œy
 : 
this
.
wr™”M­
.
	`’ŒyS‘
()) {

148 
Œy
 {

149 
’Œy
.
	`g‘V®ue
().
	`şo£
();

150 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

151 
e
.
	`´štSckT¿û
();

154 
	}
}

156 
´iv©e
 
	gSequ’ûFe
.
Wr™”
 
	$g‘Wr™”
(
by‹
[] 
docid
) {

157 ià(
this
.
Ï¡EndKey
 !ğ
nuÎ
 &&his.
Ï¡S¹Key
 !=‚ull) {

158 ià((
this
.
Ï¡S¹Key
.
Ëngth
 =ğ0 || 
By‹s
.
	`com·»To
(
docid
,his.Ï¡S¹Keyè>ğ0è&& (this.
Ï¡EndKey
.length == 0 || Bytes.compareTo(docid,his.lastEndKey) < 0)) {

159  
this
.
Ï¡Wr™”
;

162 
HRegiÚInfo
 
šfo
;

163 
šfo
 = 
this
.
	`g‘DocidRegiÚ
(
docid
);

164 ià(
šfo
 !ğ
nuÎ
) {

165 
this
.
Ï¡EndKey
 = 
šfo
.
	`g‘EndKey
();

166 
this
.
Ï¡S¹Key
 = 
šfo
.
	`g‘S¹Key
();

167 
S”v”Name
 
Çme
 = 
this
.
»giÚM­
.
	`g‘
(
šfo
);

168 
this
.
Ï¡Wr™”
 =his.
wr™”M­
.
	`g‘
(
Çme
.
	`g‘Ho¡Çme
());

169  
this
.
Ï¡Wr™”
;

171  
nuÎ
;

172 
	}
}

174 
public
 
boŞ—n
 
	$isInRegiÚ
(
HRegiÚInfo
 
»giÚ
, 
by‹
[] 
docid
) {

175 
by‹
[] 
¡¬t
 = 
»giÚ
.
	`g‘S¹Key
();

176 
by‹
[] 
’d
 = 
»giÚ
.
	`g‘EndKey
();

178 ià((
¡¬t
.
Ëngth
 =ğ0 && 
docid
.Ëngth =ğ0è|| (
’d
.length == 0 && docid.length == 0))

179  
Œue
;

180 ià((
¡¬t
.
Ëngth
 =ğ0 || 
By‹s
.
	`com·»To
(
docid
, s¹è>ğ0è&& (
’d
.length == 0 || Bytes.compareTo(docid,ƒnd) < 0)) {

181  
Œue
;

183  
çl£
;

184 
	}
}

186 
´iv©e
 
	gby‹
[] 
	$fšdNextDocid
(
by‹
[] 
docid
, 
HRegiÚInfo
 
»giÚ
) {

187 
by‹
[] 
ÃxtDocid
 = 
A¼ays
.
	`cİyOf
(
docid
, docid.
Ëngth
);

188 
i
 = 7; i >= 0; i--) {

189 ià(
ÃxtDocid
[
i
] =ğ(
by‹
) 0xff)

191 
ÃxtDocid
[
i
] = (
by‹
) 0xff;

192 ià(
»giÚ
.
	`g‘EndKey
().
Ëngth
 !ğ0 && 
By‹s
.
	`com·»To
(
ÃxtDocid
,„egion.getEndKey()) >= 0) {

193 
logg”
.
	`šfo
("docid " + 
Numb”Ut
.
	`g‘HexSŒšg
(
docid
è+ " fšd„egiÚƒnd docid " + Numb”Ut.g‘HexSŒšg(
»giÚ
.
	`g‘EndKey
()));

194  
»giÚ
.
	`g‘EndKey
();

196 
logg”
.
	`šfo
("docid " + 
Numb”Ut
.
	`g‘HexSŒšg
(
docid
è+ " fšd‡‚exˆ’d docid " + Numb”Ut.g‘HexSŒšg(
ÃxtDocid
) + "„egionƒnd docid "

197 + 
Numb”Ut
.
	`g‘HexSŒšg
(
»giÚ
.
	`g‘EndKey
()));

198  
ÃxtDocid
;

201  
»giÚ
.
	`g‘EndKey
();

202 
	}
}

204 
şass
 
S’dPageD©aM­³r
 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

206 
´iv©e
 
	gÿchšg
 = 500;

207 
	gLi¡
<
	gRow
> 
	growli¡
 = 
Ãw
 
A¼ayLi¡
<
Row
>(100);

208 
Objeù
 
	g»suÉ
[] = 
nuÎ
;

209 
HTabË
 
	gwebDbTabË
;

210 
by‹
 
	gF
[] = 
By‹s
.
toBy‹s
("F");

211 
by‹
 
	gP
[] = 
By‹s
.
toBy‹s
("P");

212 
	gby‹
[] 
	gu
 = 
By‹s
.
toBy‹s
("u");

213 
	gby‹
[] 
	gfšg”
 = 
By‹s
.
toBy‹s
("f");

214 
	gby‹
[] 
	gsc
 = 
By‹s
.
toBy‹s
("sc");

215 
	gby‹
[] 
	g¤t
 = 
By‹s
.
toBy‹s
("srt");

216 
	gby‹
[] 
	gs¡
 = 
By‹s
.
toBy‹s
("sst");

217 
	gby‹
[] 
	gt
 = 
By‹s
.
toBy‹s
("t");

218 
	gby‹
[] 
	gac
 = 
By‹s
.
toBy‹s
("ac");

219 
	gby‹
[] 
	gş
 = 
By‹s
.
toBy‹s
("cl");

220 
	gby‹
[] 
	gsu
 = 
By‹s
.
toBy‹s
("su");

221 
	gby‹
[] 
	gÏ
 = 
By‹s
.
toBy‹s
("la");

222 
	gby‹
[] 
	gbufãr
 = 
Ãw
 
by‹
[1024 * 1024 * 2];

224 
ImmubËBy‹sWr™abË
 
	gv
 = 
Ãw
 ImmutableBytesWritable();

225 
	gS‘
<
	gHRegiÚInfo
> 
	g»giÚS‘
 = 
Ãw
 
HashS‘
<
HRegiÚInfo
>();

227 
	gby‹
[] 
	gÇmebufãr
 = 
Ãw
 
by‹
[8];

228 
	goff£t
 = 12;

229 
	g´oûss
 = 0;

231 
SŒšg
 
	gho¡Name
;

233 @
Ov”ride


234 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

237 
´iv©e
 
wr™eD©a
(
by‹
[] 
key
, 
ResuÉ
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

238 
	gA¼ays
.
fl
(
bufãr
, (
by‹
) '0');

239 
	gKeyV®ue
[] 
	gkvs
 = 
v®ue
.
¿w
();

241 
	g´oûss
 = 0;

243 
	gSy¡em
.
¬¿ycİy
(
key
, 0, 
bufãr
, 4, 8);

244 
	goff£t
 = 16;

245 
KeyV®ue
 
	gkv
 : 
kvs
) {

247 ià(
By‹s
.
com·»To
(
kv
.
g‘Bufãr
(), kv.
g‘FamyOff£t
(), kv.
g‘FamyL’gth
(), 
F
, 0, 1) == 0) {

249 ià(
kv
.
g‘Qu®if›rL’gth
(è=ğ1 && 
By‹s
.
com·»To
(kv.
g‘Bufãr
(), kv.
g‘Qu®if›rOff£t
(), kv.g‘Qu®if›rL’gth(), 
u
, 0, 1) == 0) {

250 ià(
off£t
 + 
kv
.
g‘V®ueL’gth
(è+ 12 > 
bufãr
.
Ëngth
) {

251 
Log
.
šfo
("bufã¸tØlÚg docid=" + 
SŒšgUts
.
by‹ToHexSŒšg
(
kv
.
g‘Key
()è+ "\’gth=" + (
off£t
 + kv.
g‘V®ueL’gth
()));

254 
	gSy¡em
.
¬¿ycİy
(
kv
.
g‘Bufãr
(), kv.
g‘Qu®if›rOff£t
(), 
bufãr
, 
off£t
, kv.
g‘Qu®if›rL’gth
());

255 
	goff£t
 += 8;

256 
	gËngth
 = 
kv
.
g‘V®ueL’gth
();

257 
by‹
 
	gv®ueL’
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
Ëngth
);

258 
	gSy¡em
.
¬¿ycİy
(
v®ueL’
, 0, 
bufãr
, 
off£t
, v®ueL’.
Ëngth
);

259 
	goff£t
 +ğ
v®ueL’
.
Ëngth
;

260 
	gSy¡em
.
¬¿ycİy
(
kv
.
g‘Bufãr
(), kv.
g‘V®ueOff£t
(), 
bufãr
, 
off£t
, kv.
g‘V®ueL’gth
());

261 
	goff£t
 +ğ
kv
.
g‘V®ueL’gth
();

262 
	g´oûss
++;

267 ià(
	gBy‹s
.
com·»To
(
kv
.
g‘Bufãr
(), kv.
g‘FamyOff£t
(), kv.
g‘FamyL’gth
(), 
P
, 0, 1) == 0) {

268 ià(
off£t
 + 
kv
.
g‘V®ueL’gth
(è+ 12 > 
bufãr
.
Ëngth
) {

269 
Log
.
šfo
("bufã¸tØlÚg docid=" + 
SŒšgUts
.
by‹ToHexSŒšg
(
kv
.
g‘Key
()è+ "\’gth=" + (
off£t
 + kv.
g‘V®ueL’gth
()));

272 ià(
	gBy‹s
.
com·»To
(
kv
.
g‘Bufãr
(), kv.
g‘Qu®if›rOff£t
(), kv.
g‘Qu®if›rL’gth
(), 
Ï
, 0,†a.
Ëngth
) == 0) {

275 
	gSy¡em
.
¬¿ycİy
(
kv
.
g‘Bufãr
(), kv.
g‘Qu®if›rOff£t
(), 
bufãr
, 
off£t
, kv.
g‘Qu®if›rL’gth
());

276 
	goff£t
 += 8;

277 
	gËngth
 = 
kv
.
g‘V®ueL’gth
();

278 
by‹
 
	gv®ueL’
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
Ëngth
);

279 
	gSy¡em
.
¬¿ycİy
(
v®ueL’
, 0, 
bufãr
, 
off£t
, v®ueL’.
Ëngth
);

280 
	goff£t
 +ğ
v®ueL’
.
Ëngth
;

282 
	gSy¡em
.
¬¿ycİy
(
kv
.
g‘Bufãr
(), kv.
g‘V®ueOff£t
(), 
bufãr
, 
off£t
, kv.
g‘V®ueL’gth
());

283 
	goff£t
 +ğ
kv
.
g‘V®ueL’gth
();

284 
	g´oûss
++;

287 
by‹
 
	gËn
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
´oûss
);

288 
	gSy¡em
.
¬¿ycİy
(
Ën
, 0, 
bufãr
, 12, 4);

290 
by‹
 
	gsumËn
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
off£t
 - 4);

291 
	gSy¡em
.
¬¿ycİy
(
sumËn
, 0, 
bufãr
, 0, 4);

292 
	gv
.
£t
(
bufãr
, 0, 
off£t
);

293 
	gcÚ‹xt
.
wr™e
(
Ãw
 
ImmubËBy‹sWr™abË
(
key
), 
v
);

294 
	gcÚ‹xt
.
g‘CouÁ”
("£ndd©a", "lßd").
šüem’t
(1);

297 @
Ov”ride


298 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

299 
boŞ—n
 
	gfšd
 = 
çl£
;

300 
HRegiÚInfo
 
	gšfo
 : 
this
.
»giÚS‘
) {

301 ià(
S’dWebPage
.
isInRegiÚ
(
šfo
, 
key
.
g‘
()è&& 
	gS’dWebPage
.isInRegiÚ(šfo, 
v®ue
.get())) {

302 
	gLog
.
šfo
("g‘‡„egiÚ" + 
this
.
ho¡Name
 + "\ŒegiÚ s¹" + 
Numb”Ut
.
g‘HexSŒšg
(šfo.
g‘S¹Key
()è+ "\ŒegiÚƒnd=" + Numb”Ut.g‘HexSŒšg(šfo.
g‘EndKey
())

303 + "\ˆ¡¬t=" + 
Numb”Ut
.
g‘HexSŒšg
(
key
.
g‘
()è+ "\ˆ’d=" + Numb”Ut.g‘HexSŒšg(
v®ue
.get()));

304 
	gcÚ‹xt
.
g‘CouÁ”
("hba£_»giÚ", 
this
.
ho¡Name
 + "_m©ch").
šüem’t
(1);

305 
	gfšd
 = 
Œue
;

310 ià(!
	gfšd
) {

311 
HRegiÚLoÿtiÚ
 
	gloÿtiÚ
 = 
this
.
webDbTabË
.
g‘RegiÚLoÿtiÚ
(
key
.
g‘
(), 
çl£
);

312 
	gLog
.
šfo
("did‚Ù fšd„egiÚ" + "\t¡¬t=" + 
Numb”Ut
.
g‘HexSŒšg
(
key
.
g‘
()è+ "\ˆ’d=" + Numb”Ut.g‘HexSŒšg(
v®ue
.g‘()è+ "\ˆ»giÚ†oÿtiÚ " + 
loÿtiÚ
.
g‘Ho¡Çme
());

313 
	gcÚ‹xt
.
g‘CouÁ”
("hba£_»giÚ", 
this
.
ho¡Name
 + "nÙ_m©ch").
šüem’t
(1);

314 
	gNavigabËM­
<
	gHRegiÚInfo
, 
	gS”v”Name
> 
	gtm­
 = 
this
.
webDbTabË
.
g‘RegiÚLoÿtiÚs
();

317 
	gcÚ‹xt
.
g‘CouÁ”
("hba£_»giÚ", 
this
.
ho¡Name
).
šüem’t
(1);

318 
	gcÚ‹xt
.
g‘CouÁ”
("hba£_»giÚ", "»giÚ").
šüem’t
(1);

319 
	gsÿn
.
£tS¹Row
(
key
.
g‘
());

320 
	gsÿn
.
£tStİRow
(
v®ue
.
g‘
());

321 
ResuÉSÿÂ”
 
	gsÿÂ”
 = 
this
.
webDbTabË
.
g‘SÿÂ”
(
sÿn
);

322 
	gsÿn
.
£tCachšg
(
this
.
ÿchšg
);

323 
	gcÚ‹xt
.
g‘CouÁ”
("sÿnCouÁ”", "sÿnTime").
šüem’t
(1);

324 
	gŒy
 {

325 
	gou‹r
: 
ResuÉ
 
»suÉ
 : 
sÿÂ”
) {

326 
this
.
wr™eD©a
(
»suÉ
.
g‘Row
(),„esuÉ, 
cÚ‹xt
);

329 } 
	gfš®ly
 {

330 
	gsÿÂ”
.
şo£
();

335 
´iv©e
 
Sÿn
 
	gsÿn
 = 
Ãw
 Scan();

336 
SšgËCŞumnV®ueF‹r
 
	gf‹r
;

338 @
Ov”ride


339 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

341 
	gsu³r
.
£tup
(
cÚ‹xt
);

342 
CÚfigu¿tiÚ
 
	gcÚf
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
();

343 
	gthis
.
	gÿchšg
 = 
cÚf
.
g‘IÁ
("get_data_caching", 500);

344 
	gthis
.
	g»suÉ
 = 
Ãw
 
Objeù
[
this
.
ÿchšg
];

345 
SŒšg
 
	gbËName
 = 
cÚf
.
g‘
("LoadTableName", "webDB");

346 
	gthis
.
	gwebDbTabË
 = 
Ãw
 
HTabË
(
cÚf
, 
bËName
);

347 
	g£rŸlNum
 = 
IÁeg”
.
·r£IÁ
(
cÚf
.
g‘
("serialNumber"));

348 
	gf‹r
 = 
Ãw
 
SšgËCŞumnV®ueF‹r
(
By‹s
.
toBy‹s
("P"), By‹s.toBy‹s("Ï"), 
Com·»Op
.
EQUAL
, By‹s.toBy‹s(
£rŸlNum
));

349 
	gf‹r
.
£tF‹rIfMissšg
(
Œue
);

350 
	gf‹r
.
£tL©e¡V”siÚOÆy
(
Œue
);

351 
	gsÿn
.
addCŞumn
(
P
, 
fšg”
);

352 
	gsÿn
.
addCŞumn
(
P
, 
sc
);

353 
	gsÿn
.
addCŞumn
(
P
, 
¤t
);

354 
	gsÿn
.
addCŞumn
(
P
, 
s¡
);

355 
	gsÿn
.
addCŞumn
(
P
, 
t
);

356 
	gsÿn
.
addCŞumn
(
P
, 
ac
);

357 
	gsÿn
.
addCŞumn
(
P
, 
su
);

358 
	gsÿn
.
addCŞumn
(
P
, 
Ï
);

359 
	gsÿn
.
addCŞumn
(
P
, 
ş
);

360 
	gsÿn
.
addCŞumn
(
F
, 
u
);

361 
	gsÿn
.
£tF‹r
(
f‹r
);

363 
	gNavigabËM­
<
	gHRegiÚInfo
, 
	gS”v”Name
> 
	gtm­
 = 
this
.
webDbTabË
.
g‘RegiÚLoÿtiÚs
();

365 
IÃtAdd»ss
 
	gadd»ss
 = IÃtAdd»ss.
g‘LoÿlHo¡
();

366 
	gho¡Name
 = 
add»ss
.
g‘Ho¡Name
();

367 
	gLog
.
šfo
("m­ s¹ ,ho¡‚am" + 
ho¡Name
);

368 
	gM­
.
	gEÁry
<
	gHRegiÚInfo
, 
	gS”v”Name
> 
	g’Œy
 : 
tm­
.
’ŒyS‘
()) {

369 ià(
’Œy
.
g‘V®ue
().
g‘Ho¡Çme
().
equ®s
(
ho¡Name
)) {

370 
this
.
»giÚS‘
.
add
(
’Œy
.
g‘Key
());

373 
	gLog
.
šfo
("ho¡ " + 
ho¡Name
 + "\ˆg‘„egiÚ " + 
this
.
»giÚS‘
.
size
());

378 
public
 
şass
 
	gDocidP¬tiÚ”
<
	gK
, 
	gV
> 
ex‹nds
 
	gP¬t™iÚ”
<K, V> 
im¶em’ts
 
	gCÚfigu¿bË
 {

379 
CÚfigu¿tiÚ
 
	gcÚf
;

380 
	gnumOäeduû
;

382 @
Ov”ride


383 
public
 
CÚfigu¿tiÚ
 
g‘CÚf
() {

385  
	gthis
.
	gcÚf
;

388 @
Ov”ride


389 
public
 
£tCÚf
(
CÚfigu¿tiÚ
 
¬g0
) {

391 
	gthis
.
	gcÚf
 = 
¬g0
;

392 
	gthis
.
	gnumOäeduû
 = 
cÚf
.
g‘IÁ
("mapred.reduce.tasks", 1024);

396 @
Ov”ride


397 
public
 
g‘P¬t™iÚ
(
K
 
¬g0
, 
V
 
¬g1
, 
¬g2
) {

398 
ImmubËBy‹sWr™abË
 
	gk
 = (ImmubËBy‹sWr™abËè
¬g0
;

400 
by‹
 
	gac
[] = 
k
.
g‘
();

401 
by‹
 
	ga
 = 
ac
[
k
.
g‘Off£t
(è+ k.
g‘L’gth
() - 1];

402 
by‹
 
	gb
 = 
ac
[
k
.
g‘Off£t
(è+ k.
g‘L’gth
() - 2];

403 
	gt
 = 
a
 & 0x000000ff;

404 
	gt2
 = 
b
 & 0x00000003;

405 
	g·¹
 = 
t2
 * 256 + 
t
;

406 ià(
	g·¹
 < 0 ||…art > 1024) {

407 
	gLog
.
šfo
("t2 =" + 
t2
 + "=" + 
t
 + "…¬t=" + 
·¹
);

409  
	g·¹
;

414 
public
 
şass
 
S’dPageD–‘eM­³r
 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

416 
by‹
 
	gÚe
[] = 
Ãw
 byte[1];

417 
ImmubËBy‹sWr™abË
 
	gv
 = 
Ãw
 ImmutableBytesWritable();

419 @
Ov”ride


420 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

422 
	gsu³r
.
£tup
(
cÚ‹xt
);

423 
	gv
.
£t
(
Úe
, 0, 1);

426 @
Ov”ride


427 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

428 
	gcÚ‹xt
.
wr™e
(
key
, 
v
);

429 
	gcÚ‹xt
.
g‘CouÁ”
("£ndd©a", "d–‘e").
šüem’t
(1);

433 
public
 
şass
 
S’dPageD©aS’dReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gNuÎWr™abË
> {

434 
´iv©e
 
MuÉËOuuts
 
	gmos
;

436 @
Ov”ride


437 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

439 
	gsu³r
.
£tup
(
cÚ‹xt
);

440 
	gmos
 = 
Ãw
 
MuÉËOuuts
(
cÚ‹xt
);

443 @
Ov”ride


444 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

446 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

447 
	gmos
.
şo£
();

450 @
Ov”ride


451 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<ImmubËBy‹sWr™abË> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

453 
ImmubËBy‹sWr™abË
 
	gv
 = 
nuÎ
;

454 
	gI‹¿tÜ
<
	gImmubËBy‹sWr™abË
> 
	g™
 = 
v®ues
.
™”©Ü
();

455 
	g™
.
hasNext
()) {

456 
	gv
 = 
™
.
Ãxt
();

457 ià(
	gv
.
g‘L’gth
() == 1) {

458 
mos
.
wr™e
("d–‘–i¡", 
key
, 
NuÎWr™abË
.
g‘
());

460 
	gcÚ‹xt
.
wr™e
(
v
, 
NuÎWr™abË
.
g‘
());

466 
Job
 
	$ü—‹S’dPageJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

467 
Job
 
job
 = 
nuÎ
;

468 
Œy
 {

469 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

470 
cÚf
.
	`£t
("mapred.map.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

471 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
çl£
);

472 
job
 = 
Ãw
 
	`Job
(
cÚf
);

473 
SŒšg
 
¡
 = 
cÚf
.
	`g‘
("seqTimestamp");

474 ià(
¡
 =ğ
nuÎ
 || st.
	`equ®s
(""))

475  
nuÎ
;

476 
SŒšg
 
lßdli¡Dœ
 = 
Spid”Job
.
ROOT_DIR
 + "/" + Spid”Job.
SELECT_LOAD_DOCID_DIR
 + "/" + 
¡
;

480 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
lßdli¡Dœ
), 
Ho¡Sequ’ûFeIÅutFÜm©
.
şass
, 
S’dPageD©aM­³r
.class);

481 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
S’dPageD–‘eM­³r
.class);

482 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[2]));

483 
job
.
	`£tOuutFÜm©CÏss
(
Bš¬yOuutFÜm©
.
şass
);

484 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

485 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

486 
job
.
	`£tM­S³cuÏtiveExecutiÚ
(
çl£
);

487 
job
.
	`£tP¬t™iÚ”CÏss
(
DocidP¬tiÚ”
.
şass
);

488 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

489 
job
.
	`£tOuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

490 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "d–‘–i¡", 
Bš¬yOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.şass, 
NuÎWr™abË
.class);

491 
job
.
	`£tReduûrCÏss
(
S’dPageD©aS’dReduûr
.
şass
);

492 
job
.
	`£tNumReduûTasks
(1024);

493  
job
;

494 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

496 
e
.
	`´štSckT¿û
();

498  
nuÎ
;

499 
	}
}

509 
boŞ—n
 
	$g’”©eLßdLi¡Fe
(
SŒšg
 
lßdFe
) {

510 
boŞ—n
 
æag
 = 
çl£
;

511 
Sequ’ûFe
.
R—d”
 
®lR—d”
 = 
nuÎ
;

513 
Œy
 {

514 
FeSy¡em
 
fs
;

515 
fs
 = 
FeSy¡em
.
	`g‘
(
this
.
	`g‘CÚf
());

516 
ImmubËBy‹sWr™abË
 
key
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
();

517 
NuÎWr™abË
 
v
 = NuÎWr™abË.
	`g‘
();

518 
®lR—d”
 = 
Ãw
 
Sequ’ûFe
.
	`R—d”
(
fs
,‚ew 
	`P©h
(
lßdFe
), 
this
.
	`g‘CÚf
());

521 
numM­
 = 
this
.
	`g‘CÚf
().
	`g‘IÁ
("mapred.map.tasks", 1);

522 
Log
.
	`šfo
("‚um oàm­ask " + 
numM­
);

523 
by‹
[] 
Ï¡Docid
 = 
nuÎ
;

524 
HRegiÚInfo
 
Ï¡RegiÚ
 = 
nuÎ
;

525 
by‹
[] 
Ï¡S¹Key
 = 
nuÎ
;

526 
Sequ’ûFe
.
Wr™”
 
wr™”
 = 
nuÎ
;

527 
ImmubËBy‹sWr™abË
 
¡¬t
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
();

528 
ImmubËBy‹sWr™abË
 
’d
 = 
Ãw
 
	`ImmubËBy‹sWr™abË
();

529 
sum
 = 0;

530 
£·¿‹SameRegiÚCouÁ
 = 
this
.
	`g‘CÚf
().
	`g‘IÁ
("sameRegionMax", 0);

531 
Œy
 {

532 
®lR—d”
.
	`Ãxt
(
key
, 
v
)) {

533 
sum
++;

534 ià(
Ï¡Docid
 =ğ
nuÎ
) {

535 
Ï¡Docid
 = 
key
.
	`cİyBy‹s
();

536 
Ï¡S¹Key
 = 
Ï¡Docid
;

537 
Ï¡RegiÚ
 = 
this
.
	`g‘DocidRegiÚ
(
Ï¡Docid
);

541 
by‹
[] 
docid
 = 
key
.
	`g‘
();

542 ià(
	`isInRegiÚ
(
Ï¡RegiÚ
, 
docid
)) {

543 
Ï¡Docid
 = 
key
.
	`cİyBy‹s
();

544 ià(
£·¿‹SameRegiÚCouÁ
 > 0 && 
sum
 > separateSameRegionCount) {

545 
wr™”
 = 
this
.
	`g‘Wr™”
(
Ï¡S¹Key
);

546 
¡¬t
.
	`£t
(
Ï¡S¹Key
);

547 
’d
.
	`£t
(
Ï¡Docid
);

548 
wr™”
.
	`­³nd
(
¡¬t
, 
’d
);

549 
Ï¡S¹Key
 = 
Ï¡Docid
;

550 
Ï¡RegiÚ
 = 
this
.
	`g‘DocidRegiÚ
(
docid
);

551 
sum
 = 0;

555 
by‹
 
»giÚStİDocid
[] = 
this
.
	`fšdNextDocid
(
Ï¡Docid
, 
Ï¡RegiÚ
);

556 
logg”
.
	`šfo
("docid g‘‡‚ew wr™” " + 
Numb”Ut
.
	`g‘HexSŒšg
(
docid
è+ "†a¡„egiÚ s¹=" + Numb”Ut.g‘HexSŒšg(
Ï¡RegiÚ
.
	`g‘S¹Key
()) + "\tlast„egionƒnd="

557 + 
Numb”Ut
.
	`g‘HexSŒšg
(
Ï¡RegiÚ
.
	`g‘EndKey
()è+ "\ˆ·¹ s¹ key=" + Numb”Ut.g‘HexSŒšg(
Ï¡S¹Key
) + "\tend key="

558 + 
Numb”Ut
.
	`g‘HexSŒšg
(
»giÚStİDocid
è+ "\tsum=" + 
sum
);

559 
wr™”
 = 
this
.
	`g‘Wr™”
(
Ï¡S¹Key
);

560 
¡¬t
.
	`£t
(
Ï¡S¹Key
);

561 
’d
.
	`£t
(
»giÚStİDocid
);

562 
wr™”
.
	`­³nd
(
¡¬t
, 
’d
);

563 
Ï¡S¹Key
 = 
key
.
	`cİyBy‹s
();

564 
Ï¡Docid
 = 
Ï¡S¹Key
;

565 
Ï¡RegiÚ
 = 
this
.
	`g‘DocidRegiÚ
(
docid
);

566 
sum
 = 0;

569 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

570 
e
.
	`´štSckT¿û
();

573 ià(
sum
 > 0) {

575 
by‹
 
»giÚStİDocid
[] = 
this
.
	`fšdNextDocid
(
Ï¡Docid
, 
Ï¡RegiÚ
);

577 
logg”
.
	`šfo
("docid g‘‡‚ew wr™” " + 
Numb”Ut
.
	`g‘HexSŒšg
(
Ï¡Docid
è+ "†a¡„egiÚ s¹=" + Numb”Ut.g‘HexSŒšg(
Ï¡RegiÚ
.
	`g‘S¹Key
()) + "\tlast„egionƒnd="

578 + 
Numb”Ut
.
	`g‘HexSŒšg
(
Ï¡RegiÚ
.
	`g‘EndKey
()è+ "\ˆ·¹ s¹ key=" + Numb”Ut.g‘HexSŒšg(
Ï¡S¹Key
è+ "\‹nd key=" + Numb”Ut.g‘HexSŒšg(
»giÚStİDocid
));

580 
wr™”
 = 
this
.
	`g‘Wr™”
(
Ï¡S¹Key
);

581 
¡¬t
.
	`£t
(
Ï¡S¹Key
);

582 
’d
.
	`£t
(
»giÚStİDocid
);

583 
wr™”
.
	`­³nd
(
¡¬t
, 
’d
);

586 
this
.
	`şo£Wr™”
();

587 
æag
 = 
Œue
;

589 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

591 
e
.
	`´štSckT¿û
();

594  
æag
;

595 
	}
}

597 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

598 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

599 
SŒšg
[] 
Ùh”Args
;

600 
Œy
 {

601 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

602 ià(
Ùh”Args
.
Ëngth
 < 3) {

603 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " modifylist†oadlist output");

604 
Sy¡em
.
	`ex™
(-1);

606 
S’dWebPage
 
·
 = 
Ãw
 
	`S’dWebPage
();

607 
·
.
	`£tCÚf
(
cÚf
);

608 
·
.
	`ü—‹Wr™”
();

609 
boŞ—n
 
»s
 = 
·
.
	`g’”©eLßdLi¡Fe
(
Ùh”Args
[0]);

610 ià(!
»s
)

612 
Job
 
job
 = 
	`ü—‹S’dPageJob
(
cÚf
, 
Ùh”Args
);

613 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

614 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

615 
e
.
	`´štSckT¿û
();

617 
	}
}

619 @
Ov”ride


620 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

622 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

623 
SŒšg
[] 
Ùh”Args
;

624 
Œy
 {

625 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

626 ià(
Ùh”Args
.
Ëngth
 < 3) {

627 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " modifylist†oadlist output");

628 
Sy¡em
.
	`ex™
(-1);

630 
this
.
	`£tCÚf
(
cÚf
);

631 
this
.
	`ü—‹Wr™”
();

632 
boŞ—n
 
»s
 = 
this
.
	`g’”©eLßdLi¡Fe
(
Ùh”Args
[0]);

633 ià(!
»s
)

634  
nuÎ
;

636 
Job
 
job
 = 
	`ü—‹S’dPageJob
(
cÚf
, 
Ùh”Args
);

637  
job
;

638 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

640 
e
.
	`´štSckT¿û
();

641 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

643 
e
.
	`´štSckT¿û
();

645  
nuÎ
;

646 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/SortSeedURL.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	ghadoİbackpÜt
.
	gIÅutSam¶”
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	ghadoİbackpÜt
.
	gTÙ®Ord”P¬t™iÚ”
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

27 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

28 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gScÜeURLSti¡ic
.
	gScÜeURLM­³r
;

30 
public
 cÏs 
	cSÜtS“dURL
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

32 
şass
 
SÜtS“dURLM­³r
 
ex‹nds


33 
	mM­³r
<
	mImmubËBy‹sWr™abË
, 
	mText
, ImmutableBytesWritable, Text> {

35 @
Ov”ride


36 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
,

37 
	mIÁ”ru±edExû±iÚ
 {

42 
ImmubËBy‹sWr™abË
 
	mdocid
 = 
Ãw
 ImmutableBytesWritable();

43 
by‹
 
	ma
[] = 
Ãw
 byte[8];

45 @
Ov”ride


46 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
Text
 
v®ue
,

47 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

49 
	mSy¡em
.
¬¿ycİy
(
key
.
g‘
(), 0, 
a
, 0, 8);

50 
	mdocid
.
£t
(
a
);

51 
	mcÚ‹xt
.
wr™e
(
docid
, 
v®ue
);

55 
şass
 
SÜtS“dURLReduûr
 
ex‹nds


56 
	gReduûr
<
	gImmubËBy‹sWr™abË
, 
	gText
, ImmutableBytesWritable, Text> {

58 @
Ov”ride


59 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

60 
	gIÁ”ru±edExû±iÚ
 {

62 
	gsu³r
.
£tup
(
cÚ‹xt
);

65 @
Ov”ride


66 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
,

67 
I‹¿bË
<
Text
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

68 
	gIÁ”ru±edExû±iÚ
 {

69 
Text
 
	go
 : 
v®ues
) {

70 
cÚ‹xt
.
wr™e
(
key
, 
o
);

75 
Job
 
	$ü—‹Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
[] 
¬gs
) {

76 
Job
 
job
;

77 
Œy
 {

78 
job
 = 
Ãw
 
	`Job
(
cÚf
);

81 
FeIÅutFÜm©
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

82 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

83 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

84 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

85 
job
.
	`£tM­OuutV®ueCÏss
(
Text
.
şass
);

86 
job
.
	`£tM­³rCÏss
(
SÜtS“dURLM­³r
.
şass
);

87 
job
.
	`£tReduûrCÏss
(
SÜtS“dURLReduûr
.
şass
);

88 
job
.
	`£tP¬t™iÚ”CÏss
(
TÙ®Ord”P¬t™iÚ”
.
şass
);

89 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

90 
job
.
	`£tOuutV®ueCÏss
(
Text
.
şass
);

91 
job
.
	`£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

93 
IÅutSam¶”
.
Sam¶”
<
ImmubËBy‹sWr™abË
, 
Text
> 
§m¶”
 = 
Ãw
 IÅutSam¶”.
RªdomSam¶”
<ImmutableBytesWritable, Text>(

95 
P©h
 
šput
 = 
Ãw
 
	`P©h
(
¬gs
[0]);

96 
šput
 = iÅut.
	`makeQu®if›d
(šput.
	`g‘FeSy¡em
(
cÚf
));

97 
P©h
 
·¹™iÚFe
 = 
Ãw
 
	`P©h
(
šput
, "_partitions");

98 
FeSy¡em
 
fs
 = 
·¹™iÚFe
.
	`g‘FeSy¡em
(
job
.
	`g‘CÚfigu¿tiÚ
());

99 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(),

100 
·¹™iÚFe
);

101 
IÅutSam¶”
.
	`wr™eP¬t™iÚFe
(
job
, 
§m¶”
);

102 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚFe
.
	`toSŒšg
()

104 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

105 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

106 
fs
.
	`d–‘eOnEx™
(
·¹™iÚFe
);

108  
job
;

109 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

111 
e
.
	`´štSckT¿û
();

112 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

114 
e
.
	`´štSckT¿û
();

115 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

117 
e
.
	`´štSckT¿û
();

118 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

120 
e
.
	`´štSckT¿û
();

123  
nuÎ
;

124 
	}
}

126 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

127 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

128 
SŒšg
[] 
Ùh”Args
;

129 
Œy
 {

130 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

131 ià(
Ùh”Args
.
Ëngth
 < 2) {

132 
Sy¡em
.
out


133 .
	`´šn
("Wrong‚umber of‡rguments: "

134 + 
Ùh”Args
.
Ëngth


136 
Sy¡em
.
	`ex™
(-1);

138 
Job
 
job
 = 
	`ü—‹Job
(
cÚf
, 
Ùh”Args
);

139 
Sy¡em
.
	`ex™
(
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1);

140 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

142 
e
.
	`´štSckT¿û
();

143 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

145 
e
.
	`´štSckT¿û
();

147 
	}
}

149 @
Ov”ride


150 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

152 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

153 
this
.
	`£tCÚf
(
cÚf
);

154 
SŒšg
[] 
Ùh”Args
;

155 
Œy
 {

156 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

157 ià(
Ùh”Args
.
Ëngth
 < 2) {

158 
Sy¡em
.
out


159 .
	`´šn
("Wrong‚umber of‡rguments: "

160 + 
Ùh”Args
.
Ëngth


162 
Sy¡em
.
	`ex™
(-1);

164 
Job
 
job
 = 
	`ü—‹Job
(
cÚf
, 
Ùh”Args
);

165  
job
;

166 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

168 
e
.
	`´štSckT¿û
();

169 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

171 
e
.
	`´štSckT¿û
();

173  
nuÎ
;

175 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/StatisticNewURL.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

7 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

8 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

9 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

10 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

11 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

12 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

13 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
.
	gCÚ‹xt
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

42 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

44 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

45 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

46 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gSti¡iÿlURL
.
	gNewURLInfoM­³r
;

47 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gSti¡iÿlURL
.
	gNewURLReduûr
;

49 
public
 cÏs 
	cSti¡icNewURL
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

50 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

52 
´iv©e
 
	mCÏss
<? 
ex‹nds
 
	mP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
(è
throws
 
CÏssNÙFoundExû±iÚ
 {

53 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

54 
Œy
 {

55 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

56 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

57 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

59  
şazz
;

62 
´iv©e
 
Li¡
<
ImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
è
throws
 
IOExû±iÚ
 {

63 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

64 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 A¼ayLi¡<ImmubËBy‹sWr™abË>(
by‹Keys
.
Ëngth
);

65 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

66 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

68  
»t
;

69 
	}
}

71 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
è
throws
 
	gIOExû±iÚ
 {

72 ià(
	g¡¬tKeys
.
isEm±y
()) {

73 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

80 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(
¡¬tKeys
);

82 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

83 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

84 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("Fœ¡„egiÚ oàbË should havem±y s¹ key. In¡—d has: " + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

86 
	gsÜ‹d
.
»move
(
fœ¡
);

89 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

90 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

92 
	gŒy
 {

93 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

94 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

96 } 
	gfš®ly
 {

97 
	gwr™”
.
şo£
();

101 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

102 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

103 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

104 ià(
bËDesütÜ
 =ğ
nuÎ
) {

108 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

109 
i
 = 0;

110 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

111 ià(
i
++ > 0) {

112 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

114 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

115 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

116 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

119 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

120 
	}
}

122 
şass
 
NewURLInfoM­³r
 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

124 @
Ov”ride


125 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

128 
	gcÚ‹xt
.
wr™e
(
key
, 
v®ue
);

129 ià(
	gkey
.
g‘
().
	gËngth
 > 8) {

130 
	gcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "Ãwu¾m­_wrÚgkey").
šüem’t
(1);

133 
	gcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "Ãwu¾m­").
šüem’t
(1);

138 
şass
 
NewURLReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

140 
by‹
 
	gF
[] = 
By‹s
.
toBy‹s
("F");

141 
by‹
 
	gs
[] = 
By‹s
.
toBy‹s
("s");

142 
by‹
 
	gi
[] = 
By‹s
.
toBy‹s
("i");

143 
by‹
 
	gu
[] = 
By‹s
.
toBy‹s
("u");

144 
by‹
 
	gÃwu¾s
[] = 
By‹s
.
toBy‹s
("0");

145 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

147 @
Ov”ride


148 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<ImmubËBy‹sWr™abË> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

149 
	gI‹¿tÜ
<
	gImmubËBy‹sWr™abË
> 
	ge
 = 
v®ues
.
™”©Ü
();

150 
ImmubËBy‹sWr™abË
 
	gu¾
 = 
e
.
Ãxt
();

151 
	gkvLi¡
.
ş—r
();

153 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
s
, 
Ãwu¾s
);

154 
	gkvLi¡
.
add
(
kv
);

156 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
u
, 
u¾
.get());

157 
	gkvLi¡
.
add
(
kv
);

159 
	gš£¹Time
=()(
Sy¡em
.
cu¼’tTimeMlis
() / 1000);

160 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
i
, 
Numb”Ut
.
cÚv”tIÁToC
(()(
š£¹Time
)));

161 
	gkvLi¡
.
add
(
kv
);

162 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

163 
KeyV®ue
 
	gkeyv®ue
 : 
kvLi¡
) {

164 
cÚ‹xt
.
wr™e
(
key
, 
keyv®ue
);

166 
	gcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "Ãwu¾»duû").
šüem’t
(1);

174 
Job
 
	$ü—‹NewURLJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

175 
Job
 
job
 = 
nuÎ
;

176 
Œy
 {

177 
job
 = 
Ãw
 
	`Job
(
cÚf
);

178 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
NewURLInfoM­³r
.class);

179 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

180 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

181 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

182 
job
.
	`£tReduûrCÏss
(
NewURLReduûr
.
şass
);

183 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

184 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

185 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

186 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

187 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

189 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

190 
Œy
 {

191 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

192 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

193 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

195 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

197 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

198 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

199 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

200 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

202 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

203 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

204 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

205 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

206 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

208 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

209 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

210 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

211 
Log
.
	`šfo
("Incrementalable output configured.");

212 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

213 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

214 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

216 
e
.
	`´štSckT¿û
();

218 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

220 
e
.
	`´štSckT¿û
();

222  
job
;

223 
	}
}

225 @
Ov”ride


226 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

228 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

229 
SŒšg
[] 
Ùh”Args
;

230 
Œy
 {

231 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

232 ià(
Ùh”Args
.
Ëngth
 < 2) {

233 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage:");

234 
Sy¡em
.
	`ex™
(-1);

236 
Job
 
job
 = 
	`ü—‹NewURLJob
(
cÚf
, 
Ùh”Args
);

237  
job
;

238 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

239 
e
.
	`´štSckT¿û
();

240 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

241 
e
.
	`´štSckT¿û
();

243  
nuÎ
;

244 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/StatisticOldURL.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

7 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

8 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

9 
impÜt
 
	gjava
.
	gut
.
	gC®’d¬
;

10 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

11 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

12 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

13 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

14 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

15 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
.
	gCÚ‹xt
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

42 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

43 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

44 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

45 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

47 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

48 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

49 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gSti¡iÿlURL
.
	gOldURLReduûr
;

50 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gSti¡iÿlURL
.
	gSrcURLDocidM­³r
;

51 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
.
	gSti¡iÿlURL
.
	gSrcURLM‘aM­³r
;

53 
public
 cÏs 
	cSti¡icOldURL
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	mM­»duûV2Job
 {

54 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

56 
şass
 
SrcURLM‘aM­³r


57 
ex‹nds


58 
	mM­³r
<
	mImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

59 
ImmubËBy‹sWr™abË
 
	mk2
 = 
Ãw
 ImmutableBytesWritable();

61 @
Ov”ride


62 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

63 
ImmubËBy‹sWr™abË
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

64 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

66 
	mcÚ‹xt
.
wr™e
(
key
, 
v®ue
);

67 
	mcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "u¾m‘a").
šüem’t
(1);

68 
	mLog
.
šfo
("u¾ m‘¨Ëngth=" + 
v®ue
.
g‘L’gth
() + "\t"

69 + 
SŒšgUts
.
by‹ToHexSŒšg
(
v®ue
.
g‘
()) + "\tsize="

70 + 
v®ue
.
g‘Size
());

75 
şass
 
SrcURLDocidM­³r


76 
ex‹nds


77 
	gM­³r
<
	gImmubËBy‹sWr™abË
, 
	gNuÎWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable> {

78 
ImmubËBy‹sWr™abË
 
	gv2
 = 
Ãw
 ImmubËBy‹sWr™abËÒew 
by‹
[0]);

80 @
Ov”ride


81 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
NuÎWr™abË
 
v®ue
,

82 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

84 
	gcÚ‹xt
.
wr™e
(
key
, 
v2
);

85 
	gcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "¤cu¾").
šüem’t
(1);

90 
şass
 
OldURLReduûr


91 
ex‹nds


92 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

93 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

95 
	gby‹
[] 
	gF
 = 
By‹s
.
toBy‹s
("F");

96 
	gby‹
[] 
	ga
 = 
By‹s
.
toBy‹s
("a");

97 
	gby‹
[] 
	gm
 = 
By‹s
.
toBy‹s
("m");

98 
	gby‹
[] 
	gf
 = 
By‹s
.
toBy‹s
("f");

99 
	gby‹
[] 
	ge
 = 
By‹s
.
toBy‹s
("e");

100 
	gby‹
[] 
	gc
 = 
By‹s
.
toBy‹s
("c");

101 
	gby‹
[] 
	gb
 = 
By‹s
.
toBy‹s
("b");

102 
	gby‹
[] 
	gg
 = 
By‹s
.
toBy‹s
("g");

103 
	gby‹
[] 
	gn
 = 
By‹s
.
toBy‹s
("n");

104 
	gby‹
[] 
	gd
 = 
By‹s
.
toBy‹s
("d");

105 
	gby‹
[] 
	gs
 = 
By‹s
.
toBy‹s
("s");

106 
	gby‹
[] 
	gl
 = 
By‹s
.
toBy‹s
("l");

107 
by‹
 
	gfšg”
[] = 
Ãw
 byte[8];

108 
C®’d¬
 
	gÏ¡C®
 = 
Ãw
 
java
.
ut
.
G»gÜŸnC®’d¬
();

109 
C®’d¬
 
	gnow
 = 
Ãw
 
java
.
ut
.
G»gÜŸnC®’d¬
();

110 
	gONE_DAY_SECONDS
 = 24 * 60 * 60;

111 
D©eFÜm©
 
	gd©eFÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
(

113 
	gmodifyR©iÚ
;

114 
	gÃwu¾R©iÚ
;

115 
	gÚeMÚthModifyR©iÚ
;

116 
	gÚeMÚthNewURLR©iÚ
;

117 
	g·geRªkR©iÚ
;

118 
	gno_lšk_max_couÁs
 = 4;

119 
	gno_lšk_max_time
 = 1L * 60 * 60 * 24 * 30;

121 @
Ov”ride


122 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

123 
	gIÁ”ru±edExû±iÚ
 {

125 
	gmodifyR©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
("modify_ration",

127 
	gÃwu¾R©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
("newurl_ration",

129 
	gÚeMÚthModifyR©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
(

131 
	gÚeMÚthNewURLR©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
(

133 
	g·geRªkR©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
(

135 
	gno_lšk_max_couÁs
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘IÁ
(

137 
	gno_lšk_max_time
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘LÚg
(

141 @
Ov”ride


142 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
,

143 
I‹¿bË
<
ImmubËBy‹sWr™abË
> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
)

144 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

147 
ImmubËBy‹sWr™abË
 
	gm‘a
 = 
nuÎ
;

148 
	gI‹¿tÜ
<
	gImmubËBy‹sWr™abË
> 
	ge
 = 
v®ues
.
™”©Ü
();

149 
	gsum
 = 0;

150 
	ge
.
hasNext
()) {

152 
ImmubËBy‹sWr™abË
 
	gtmp
 = 
e
.
Ãxt
();

153 ià(
	gtmp
.
g‘L’gth
() == 0) {

154 
sum
++;

156 
	gm‘a
 = 
Ãw
 
ImmubËBy‹sWr™abË
();

157 
	gby‹
[] 
	gb
 = 
Ãw
 
by‹
[
tmp
.
g‘L’gth
()];

158 
	gSy¡em
.
¬¿ycİy
(
tmp
.
g‘
(), 0, 
b
, 0,mp.
g‘L’gth
());

159 
	gm‘a
.
£t
(
b
);

163 ià(
	gm‘a
 =ğ
nuÎ
) {

164 
Log
.
šfo
("error key ,did‚ot find corresponding key"

165 + 
SŒšgUts
.
by‹ToHexSŒšg
(
key
.
g‘
()));

168 
	gLog
.
šfo
("find„educe key="

169 + 
SŒšgUts
.
by‹ToHexSŒšg
(
key
.
g‘
()) + "\tsum="

170 + 
sum
 + " meta="

171 + 
SŒšgUts
.
by‹ToHexSŒšg
(
m‘a
.
g‘
())

172 + "\tm‘¨Ëngth=" + 
m‘a
.
g‘L’gth
());

180 
boŞ—n
 
	gisChªged
 = 
çl£
;

182 
	gÃwURLToday
 = 0, 
	gmodifyCouÁ
 = 0, 
	g”rÜCouÁ
 = 0, 
	gÃwURLB™m­
 = 0, 
	gmodifyB™m­
 = 0, 
	gno_chªge_couÁ
 = 0, 
	gty³
 = 0;

183 
	gÏ¡ModifyTime
 = 0;

184 
	gÃxtDowÆßdTime
 = 0;

185 
	g·geRªk
 = 0;

187 
by‹
 
	gm‘aBy‹s
[] = 
m‘a
.
g‘
();

188 
	gisChªged
 = 
By‹s
.
com·»To
(
m‘aBy‹s
, 0, 8, m‘aBy‹s, 8, 8è=ğ0 ? 
çl£


189 : 
Œue
;

190 
	gÏ¡ModifyTime
 = 
Numb”Ut
.
»adLÚg
(
m‘aBy‹s
, 36);

191 
	gno_chªge_couÁ
 = 
Numb”Ut
.
»adIÁ
(
m‘aBy‹s
, 44);

192 
	gty³
 = 
Numb”Ut
.
»adIÁ
(
m‘aBy‹s
, 48);

194 
	gÃwURLToday
 = 
Numb”Ut
.
»adIÁ
(
m‘aBy‹s
, 16);

195 
	gmodifyCouÁ
 = 
Numb”Ut
.
»adIÁ
(
m‘aBy‹s
, 20);

196 
	g”rÜCouÁ
 = 
Numb”Ut
.
»adIÁ
(
m‘aBy‹s
, 24);

197 
	gÃwURLB™m­
 = 
By‹s
.
toIÁ
(
m‘aBy‹s
, 28);

198 
	gmodifyB™m­
 = 
By‹s
.
toIÁ
(
m‘aBy‹s
, 32);

200 
	gtoday
 = 
now
.
g‘
(
C®’d¬
.
DAY_OF_MONTH
);

201 
boŞ—n
 
	gisNewURL
 = 
çl£
;

202 ià(
	gÏ¡ModifyTime
 != 0) {

204 
Ï¡C®
.
£tTimeInMlis
(
Ï¡ModifyTime
 * 1000);

206 ià(
	gÏ¡C®
.
g‘
(
C®’d¬
.
DAY_OF_MONTH
è=ğ
now


207 .
g‘
(
C®’d¬
.
DAY_OF_MONTH
)

208 && 
Ï¡C®
.
g‘
(
C®’d¬
.
MONTH
è=ğ
now


209 .
g‘
(
C®’d¬
.
MONTH
)) {

210 ià(
sum
 > 0) {

211 
ÃwURLToday
 +ğ
sum
;

212 
	gÃwURLB™m­
 = 
ÃwURLB™m­
 | (1 << (32 - 
today
));

214 ià(
	gisChªged
) {

215 
	gmodifyCouÁ
++;

216 
	gmodifyB™m­
 = 
modifyB™m­
 | (1 << (32 - 
today
));

219 
	gÏ¡C®
.
add
(
C®’d¬
.
DAY_OF_MONTH
, 1);

220 
	gÏ¡C®
.
befÜe
(
now
)) {

221 
	gday
 = 
Ï¡C®
.
g‘
(
C®’d¬
.
DAY_OF_MONTH
);

222 
	gÃwURLB™m­
 = 
ÃwURLB™m­
 & ~(1 << (32 - 
day
));

223 
	gmodifyB™m­
 = 
modifyB™m­
 & ~(1 << (32 - 
day
));

224 
	gÏ¡C®
.
add
(
C®’d¬
.
DAY_OF_MONTH
, 1);

227 ià(
	gsum
 > 0) {

228 
	gÃwURLToday
 = 
sum
;

229 
	gÃwURLB™m­
 = 
ÃwURLB™m­
 | (1 << (32 - 
today
));

231 
	gÃwURLToday
 = 0;

233 ià(
	gisChªged
) {

234 
	gmodifyCouÁ
 = 1;

235 
	gmodifyB™m­
 = 
modifyB™m­
 | (1 << (32 - 
today
));

237 
	gmodifyCouÁ
 = 0;

245 
	gisNewURL
 = 
Œue
;

246 ià(
	gsum
 > 0) {

247 
	gÃwURLToday
 = 
sum
;

248 
	gÃwURLB™m­
 = 
ÃwURLB™m­
 | (1 << (32 - 
today
));

250 
	gÃwURLToday
 = 0;

251 
	gÃwURLB™m­
 = 0;

253 ià(
	gisChªged
) {

254 
	gmodifyCouÁ
 = 1;

255 
	gmodifyB™m­
 = 
modifyB™m­
 | (1 << (32 - 
today
));

257 
	gmodifyCouÁ
 = 0;

258 
	gmodifyB™m­
 = 0;

263 ià(
	gisChªged
) {

264 
	gÏ¡ModifyTime
 = 
Sy¡em
.
cu¼’tTimeMlis
() / 1000;

267 
	gkvLi¡
.
ş—r
();

269 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyValue(

270 
key
.
g‘
(),

271 
F
,

272 
a
,

273 
Numb”Ut
.
cÚv”tIÁToC
((è(
Sy¡em
.
cu¼’tTimeMlis
() / 1000)));

274 
	gkvLi¡
.
add
(
kv
);

275 ià(
	gisChªged
) {

277 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
m
,

278 
Numb”Ut
.
cÚv”tIÁToC
((è(
Ï¡ModifyTime
)));

279 
	gkvLi¡
.
add
(
kv
);

281 
	gSy¡em
.
¬¿ycİy
(
m‘aBy‹s
, 0, 
fšg”
, 0, 8);

282 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
f
, 
fšg”
);

283 
	gkvLi¡
.
add
(
kv
);

288 ià(
	g”rÜCouÁ
 > 0) {

289 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
this
.
e
, 
By‹s
.
toBy‹s
(
SŒšg


290 .
v®ueOf
(0)));

291 
	gkvLi¡
.
add
(
kv
);

294 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
c
, 
By‹s
.
toBy‹s
(
SŒšg


295 .
v®ueOf
(
modifyCouÁ
)));

296 
	gkvLi¡
.
add
(
kv
);

298 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
b
, 
By‹s
.
toBy‹s
(
modifyB™m­
));

299 
	gkvLi¡
.
add
(
kv
);

301 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
g
, 
By‹s
.
toBy‹s
(
ÃwURLB™m­
));

302 
	gkvLi¡
.
add
(
kv
);

304 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
n
, 
By‹s
.
toBy‹s
(
SŒšg


305 .
v®ueOf
(
ÃwURLToday
)));

306 
	gkvLi¡
.
add
(
kv
);

310 ià(
	gty³
 == 0) {

311 
KeyV®ue
 
skv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
s
,

312 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
("2")));

313 
	gkvLi¡
.
add
(
skv
);

316 ià(
	gty³
 == 2) {

317 
boŞ—n
 
hasChªge
 = 
çl£
;

318 ià(
	gÃwURLToday
 == 0) {

319 
no_chªge_couÁ
++;

320 
	ghasChªge
 = 
Œue
;

323 ià(
	gno_chªge_couÁ
 > 0 && 
	gÃwURLToday
 > 0) {

324 
	gno_chªge_couÁ
 = 0;

325 
	ghasChªge
 = 
Œue
;

329 ià(
	gno_chªge_couÁ
 > 
	gthis
.
	gno_lšk_max_couÁs


330 || (
	gSy¡em
.
cu¼’tTimeMlis
(è/ 1000 - 
	gÏ¡ModifyTime
è> 
	gthis
.
	gno_lšk_max_time
) {

331 
KeyV®ue
 
	gskv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
s
,

332 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
("1")));

333 
	gkvLi¡
.
add
(
skv
);

334 
KeyV®ue
 
	glkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
l
,

335 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
("0")));

336 
	gkvLi¡
.
add
(
lkv
);

337 
	gLog
.
šfo
("url„ow key "

338 + 
Numb”Ut
.
g‘HexSŒšg
(
key
.
g‘
())

340 + 
no_chªge_couÁ


342 + 
d©eFÜm©
.
fÜm©
(
Ãw
 
java
.
ut
.
D©e
(

343 
Ï¡ModifyTime
 * 1000)));

344 } ià(
	gÃwURLToday
 > 0 && 
	gno_chªge_couÁ
 > 0) {

345 
KeyV®ue
 
	glkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
l
,

346 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
("0")));

347 
	gkvLi¡
.
add
(
lkv
);

349 
	gLog
.
šfo
("url„ow key "

350 + 
Numb”Ut
.
g‘HexSŒšg
(
key
.
g‘
())

352 + 
ÃwURLToday
);

354 ià(
	ghasChªge
) {

355 
KeyV®ue
 
	glkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
l
,

356 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
no_chªge_couÁ
)));

357 
	gkvLi¡
.
add
(
lkv
);

362 ià(
	gty³
 == 1) {

364 ià(
ÃwURLToday
 > 0) {

365 
KeyV®ue
 
skv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
s
,

366 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
("2")));

367 
	gkvLi¡
.
add
(
skv
);

368 
KeyV®ue
 
	glkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
l
,

369 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
("0")));

370 
	gkvLi¡
.
add
(
lkv
);

372 ià(!
	gisChªged
) {

373 
	gno_chªge_couÁ
++;

375 
	gno_chªge_couÁ
 = 0;

377 
KeyV®ue
 
	glkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
l
,

378 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
no_chªge_couÁ
)));

379 
	gkvLi¡
.
add
(
lkv
);

384 
	gLog
.
šfo
("”rÜy³ " + 
ty³
 + " for key="

385 + 
Numb”Ut
.
g‘HexSŒšg
(
key
.
g‘
()));

388 ià(
	gisChªged
) {

389 
	gsumR©e
 = 0;

390 ià(
	gmodifyCouÁ
 > 0) {

391 
	gsumR©e
 +ğ
this
.
modifyR©iÚ
 * 
M©h
.
log
(
modifyCouÁ
 + 1);

393 
	gÚeMÚthModifyCouÁ
 = 
Numb”Ut


394 .
b™_couÁ_¥¬£
(
modifyB™m­
);

395 ià(
	gÚeMÚthModifyCouÁ
 > 0) {

396 
	gsumR©e
 +ğ
this
.
ÚeMÚthModifyR©iÚ


397 * (
ÚeMÚthModifyCouÁ
 / 30);

400 
	gÚeMÚthNewURLCouÁ
 = 
Numb”Ut


401 .
b™_couÁ_¥¬£
(
ÃwURLB™m­
);

402 ià(
	gÚeMÚthNewURLCouÁ
 > 0) {

403 
	gsumR©e
 +ğ
this
.
ÚeMÚthNewURLR©iÚ


404 * (
ÚeMÚthNewURLCouÁ
 / 30);

407 ià(
	gÃwURLToday
 > 0) {

408 
	gsumR©e
 +ğ
this
.
Ãwu¾R©iÚ
 * (
M©h
.
log
(
ÃwURLToday
 + 1));

411 ià(
	g·geRªk
 > 0) {

412 
	gsumR©e
 +ğ
this
.
·geRªkR©iÚ
 * 
·geRªk
;

415 
	gÃxtDowÆßdTime
 = 
Sy¡em
.
cu¼’tTimeMlis
() / 1000

416 + (è((
ONE_DAY_SECONDS
 / 
sumR©e
));

420 
	gš‹rv®
 = (
Sy¡em
.
cu¼’tTimeMlis
(è/ 1000 - 
Ï¡ModifyTime
)

421 / 
ONE_DAY_SECONDS
;

422 
	gÃxtDowÆßdTime
 = 
Sy¡em
.
cu¼’tTimeMlis
()

424 + (è((
ONE_DAY_SECONDS
è* (1 + 
M©h


425 .
log
(1 + 
š‹rv®
)));

430 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
d
,

431 
By‹s
.
toBy‹s
((è
ÃxtDowÆßdTime
));

432 
	gkvLi¡
.
add
(
kv
);

434 
	gLog
.
šfo
("final„esult:isChanged:="

435 + 
isChªged


437 + 
d©eFÜm©
.
fÜm©
(
Ãw
 
java
.
ut
.
D©e
(

438 
Ï¡ModifyTime
 * 1000))

440 + 
SŒšg
.
v®ueOf
(
modifyCouÁ
)

442 + 
Numb”Ut
.
g‘HexSŒšg
(
By‹s
.
toBy‹s
(
modifyB™m­
))

444 + 
Numb”Ut
.
g‘HexSŒšg
(
By‹s
.
toBy‹s
(
ÃwURLB™m­
))

446 + 
SŒšg
.
v®ueOf
(
ÃwURLToday
)

448 + 
d©eFÜm©
.
fÜm©
(
Ãw
 
java
.
ut
.
D©e
(

449 
ÃxtDowÆßdTime
 * 1000)));

450 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

451 
KeyV®ue
 
	gkeyv®ue
 : 
kvLi¡
) {

452 
cÚ‹xt
.
wr™e
(
key
, 
keyv®ue
);

459 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
()

460 
throws
 
CÏssNÙFoundExû±iÚ
 {

461 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

462 
Œy
 {

463 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

464 .
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

465 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

466 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>) Class

467 .
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

469  
şazz
;

470 
	}
}

472 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
)

473 
throws
 
IOExû±iÚ
 {

474 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

475 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 ArrayList<ImmutableBytesWritable>(

476 
by‹Keys
.
Ëngth
);

477 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

478 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

480  
»t
;

481 
	}
}

483 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
,

484 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
)

485 
throws
 
	gIOExû±iÚ
 {

486 ià(
	g¡¬tKeys
.
isEm±y
()) {

487 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

494 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(

495 
¡¬tKeys
);

497 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

498 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

499 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
(

501 + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

503 
	gsÜ‹d
.
»move
(
fœ¡
);

506 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

507 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
,

508 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
,

509 
NuÎWr™abË
.
şass
);

511 
	gŒy
 {

512 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

513 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

515 } 
	gfš®ly
 {

516 
	gwr™”
.
şo£
();

520 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
)

521 
throws
 
IOExû±iÚ
 {

522 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

523 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

524 ià(
bËDesütÜ
 =ğ
nuÎ
) {

528 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

529 
i
 = 0;

530 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

531 ià(
i
++ > 0) {

532 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

534 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(

535 
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

536 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

537 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ


538 .
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

541 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

542 
	}
}

544 @
Ov”ride


545 
public
 
Job
 
	$ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

547 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

548 
SŒšg
[] 
Ùh”Args
;

549 
Œy
 {

550 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

551 ià(
Ùh”Args
.
Ëngth
 < 3) {

552 
Sy¡em
.
out
.
	`´šn
("Wrong‚umber of‡rguments: "

553 + 
Ùh”Args
.
Ëngth
 + " usage:");

554 
Sy¡em
.
	`ex™
(-1);

556 
Job
 
job
 = 
	`ü—‹OldURLJob
(
cÚf
, 
Ùh”Args
);

557  
job
;

558 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

559 
e
.
	`´štSckT¿û
();

560 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

561 
e
.
	`´štSckT¿û
();

563  
nuÎ
;

564 
	}
}

566 
Job
 
	$ü—‹OldURLJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

567 
Job
 
job
 = 
nuÎ
;

568 
Œy
 {

569 
job
 = 
Ãw
 
	`Job
(
cÚf
);

570 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]),

571 
Sequ’ûFeIÅutFÜm©
.
şass
, 
SrcURLM‘aM­³r
.class);

572 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]),

573 
Sequ’ûFeIÅutFÜm©
.
şass
, 
SrcURLDocidM­³r
.class);

574 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[2]));

576 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

577 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

578 
job
.
	`£tReduûrCÏss
(
OldURLReduûr
.
şass
);

579 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

580 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

581 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

582 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

583 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

585 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

586 
Œy
 {

587 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

588 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

589 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

591 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

593 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

594 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

595 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions "

597 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

599 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(),

600 "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

601 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

603 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

605 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

606 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(),

607 
·¹™iÚsP©h
);

609 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
()

611 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

612 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

613 
Log
.
	`šfo
("Incrementalable output configured.");

614 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

615 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

617 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

619 
e
.
	`´štSckT¿û
();

621 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

623 
e
.
	`´štSckT¿û
();

625  
job
;

626 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/StatisticalURL.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

7 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

8 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

9 
impÜt
 
	gjava
.
	gut
.
	gC®’d¬
;

10 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

11 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

12 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

13 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

14 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

15 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gPaœ
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

42 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

43 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

44 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

46 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

65 
public
 cÏs 
	cSti¡iÿlURL
 {

66 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

68 
şass
 
SrcURLM‘aM­³r


69 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, ImmutableBytesWritable,

70 
	mImmubËBy‹sWr™abË
,

71 
	mImmubËBy‹sWr™abË
> {

72 
ImmubËBy‹sWr™abË
 
	mk2
 = 
Ãw
 ImmutableBytesWritable();

74 @
Ov”ride


75 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

77 
	mcÚ‹xt
.
wr™e
(
key
, 
v®ue
);

78 
	mcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "u¾m‘a").
šüem’t
(1);

79 
	mLog
.
šfo
("u¾ m‘¨Ëngth=" + 
v®ue
.
g‘L’gth
(è+ "\t" + 
Numb”Ut
.
g‘HexSŒšg
(v®ue.
g‘
()è+ "\tsize=" + v®ue.
g‘Size
());

90 
şass
 
NewURLInfoM­³r


91 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

93 @
Ov”ride


94 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

95 
ImmubËBy‹sWr™abË
 
v®ue
,

96 
CÚ‹xt
 
cÚ‹xt
)

97 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

100 
	gcÚ‹xt
.
wr™e
(
key
, 
v®ue
);

101 ià(
	gkey
.
g‘
().
	gËngth
 > 8) {

102 
	gcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "Ãwu¾m­_wrÚgkey").
šüem’t
(1);

105 
	gcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "Ãwu¾m­").
šüem’t
(1);

110 
şass
 
SrcURLDocidM­³r


111 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, 
	gNuÎWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable> {

112 
ImmubËBy‹sWr™abË
 
	gv2
 = 
Ãw
 ImmubËBy‹sWr™abËÒew 
by‹
[0]);

114 @
Ov”ride


115 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
,

116 
NuÎWr™abË
 
v®ue
,

117 
CÚ‹xt
 
cÚ‹xt
)

118 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

120 
	gcÚ‹xt
.
wr™e
(
key
, 
v2
);

121 
	gcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "¤cu¾").
šüem’t
(1);

126 
şass
 
OldURLReduûr


127 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

128 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

130 
	gby‹
[] 
	gF
 = 
By‹s
.
toBy‹s
("F");

131 
	gby‹
[] 
	ga
 = 
By‹s
.
toBy‹s
("a");

132 
	gby‹
[] 
	gm
 = 
By‹s
.
toBy‹s
("m");

133 
	gby‹
[] 
	gf
 = 
By‹s
.
toBy‹s
("f");

134 
	gby‹
[] 
	ge
 = 
By‹s
.
toBy‹s
("e");

135 
	gby‹
[] 
	gc
 = 
By‹s
.
toBy‹s
("c");

136 
	gby‹
[] 
	gb
 = 
By‹s
.
toBy‹s
("b");

137 
	gby‹
[] 
	gg
 = 
By‹s
.
toBy‹s
("g");

138 
	gby‹
[] 
	gn
 = 
By‹s
.
toBy‹s
("n");

139 
	gby‹
[] 
	gd
 = 
By‹s
.
toBy‹s
("d");

140 
	gby‹
[] 
	gs
 = 
By‹s
.
toBy‹s
("s");

141 
by‹
 
	gfšg”
[] = 
Ãw
 byte[8];

142 
C®’d¬
 
	gÏ¡C®
 = 
Ãw
 
java
.
ut
.
G»gÜŸnC®’d¬
();

143 
C®’d¬
 
	gnow
 = 
Ãw
 
java
.
ut
.
G»gÜŸnC®’d¬
();

144 
	gONE_DAY_SECONDS
 = 24 * 60 * 60;

145 
D©eFÜm©
 
	gd©eFÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyy-MM-dd HH:mm:ss");

146 
	gmodifyR©iÚ
;

147 
	gÃwu¾R©iÚ
;

148 
	gÚeMÚthModifyR©iÚ
;

149 
	gÚeMÚthNewURLR©iÚ
;

150 
	g·geRªkR©iÚ
;

152 @
Ov”ride


153 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

155 
	gmodifyR©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
("modify_ration", 0.25f);

156 
	gÃwu¾R©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
("newurl_ration", 0.25f);

157 
	gÚeMÚthModifyR©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
("one_month_modify_ration", 0.25f);

158 
	gÚeMÚthNewURLR©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
("one_month_newURL_ration", 0.25f);

159 
	g·geRªkR©iÚ
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
("page_rank_ration", 0.5f);

162 @
Ov”ride


163 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<ImmubËBy‹sWr™abË> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
)

164 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

167 
ImmubËBy‹sWr™abË
 
	gm‘a
 = 
nuÎ
;

168 
	gI‹¿tÜ
<
	gImmubËBy‹sWr™abË
> 
	ge
 = 
v®ues
.
™”©Ü
();

169 
	gsum
 = 0;

170 
	ge
.
hasNext
()) {

171 
ImmubËBy‹sWr™abË
 
	gtmp
 = 
e
.
Ãxt
();

172 ià(
	gtmp
.
g‘L’gth
() == 0) {

173 
sum
++;

175 
	gm‘a
 = 
Ãw
 
ImmubËBy‹sWr™abË
();

176 
	gby‹
[] 
	gb
 = 
Ãw
 
by‹
[
tmp
.
g‘L’gth
()];

177 
	gSy¡em
.
¬¿ycİy
(
tmp
.
g‘
(), 0, 
b
, 0,mp.
g‘L’gth
());

178 
	gm‘a
.
£t
(
b
);

182 ià(
	gm‘a
 =ğ
nuÎ
) {

183 
Log
.
šfo
("”rÜ key ,did‚Ù fšd cÜ»¥Údšg key" + 
SŒšgUts
.
by‹ToHexSŒšg
(
key
.
g‘
()));

186 
	gLog
.
šfo
("fšd„eduû key=" + 
Numb”Ut
.
g‘HexSŒšg
(
key
.
g‘
()è+ "\tsum=" + 
sum
 + " m‘a=" + Numb”Ut.g‘HexSŒšg(
m‘a
.g‘()è+ "\tm‘¨Ëngth=" + m‘a.
g‘L’gth
());

194 
boŞ—n
 
	gisChªged
 = 
çl£
;

196 
	gÃwURLToday
 = 0, 
	gmodifyCouÁ
 = 0, 
	g”rÜCouÁ
 = 0, 
	gÃwURLB™m­
 = 0, 
	gmodifyB™m­
 = 0;

197 
	gÏ¡ModifyTime
 = 0;

198 
	gÃxtDowÆßdTime
 = 0;

199 
	g·geRªk
 = 0;

201 
by‹
 
	gm‘aBy‹s
[] = 
m‘a
.
g‘
();

202 
	gisChªged
 = 
By‹s
.
com·»To
(
m‘aBy‹s
, 0, 8, m‘aBy‹s, 8, 8è=ğ0 ? 
çl£
 : 
Œue
;

203 
	gÏ¡ModifyTime
 = 
Numb”Ut
.
»adLÚg
(
m‘aBy‹s
, 36);

205 
	gÃwURLToday
 = 
Numb”Ut
.
»adIÁ
(
m‘aBy‹s
, 16);

206 
	gmodifyCouÁ
 = 
Numb”Ut
.
»adIÁ
(
m‘aBy‹s
, 20);

207 
	g”rÜCouÁ
 = 
Numb”Ut
.
»adIÁ
(
m‘aBy‹s
, 24);

208 
	gÃwURLB™m­
 = 
By‹s
.
toIÁ
(
m‘aBy‹s
, 28);

209 
	gmodifyB™m­
 = 
By‹s
.
toIÁ
(
m‘aBy‹s
, 32);

211 
	gtoday
 = 
now
.
g‘
(
C®’d¬
.
DAY_OF_MONTH
);

212 
boŞ—n
 
	gisNewURL
 = 
çl£
;

213 ià(
	gÏ¡ModifyTime
 != 0) {

215 
Ï¡C®
.
£tTimeInMlis
(
Ï¡ModifyTime
 * 1000);

217 ià(
	gÏ¡C®
.
g‘
(
C®’d¬
.
DAY_OF_MONTH
è=ğ
now
.get(Calendar.DAY_OF_MONTH) &&

218 
Ï¡C®
.
g‘
(
C®’d¬
.
MONTH
è=ğ
now
.get(Calendar.MONTH)) {

219 ià(
sum
 > 0) {

220 
ÃwURLToday
 +ğ
sum
;

221 
	gÃwURLB™m­
 = 
ÃwURLB™m­
 | (1 << (32 - 
today
));

223 ià(
	gisChªged
) {

224 
	gmodifyCouÁ
++;

225 
	gmodifyB™m­
 = 
modifyB™m­
 | (1 << (32 - 
today
));

228 
	gÏ¡C®
.
add
(
C®’d¬
.
DAY_OF_MONTH
, 1);

229 
	gÏ¡C®
.
befÜe
(
now
)) {

230 
	gday
 = 
Ï¡C®
.
g‘
(
C®’d¬
.
DAY_OF_MONTH
);

231 
	gÃwURLB™m­
 = 
ÃwURLB™m­
 & ~(1 << (32 - 
day
));

232 
	gmodifyB™m­
 = 
modifyB™m­
 & ~(1 << (32 - 
day
));

233 
	gÏ¡C®
.
add
(
C®’d¬
.
DAY_OF_MONTH
, 1);

236 ià(
	gsum
 > 0) {

237 
	gÃwURLToday
 = 
sum
;

238 
	gÃwURLB™m­
 = 
ÃwURLB™m­
 | (1 << (32 - 
today
));

240 
	gÃwURLToday
 = 0;

242 ià(
	gisChªged
) {

243 
	gmodifyCouÁ
 = 1;

244 
	gmodifyB™m­
 = 
modifyB™m­
 | (1 << (32 - 
today
));

246 
	gmodifyCouÁ
 = 0;

254 
	gisNewURL
 = 
Œue
;

255 ià(
	gsum
 > 0) {

256 
	gÃwURLToday
 = 
sum
;

257 
	gÃwURLB™m­
 = 
ÃwURLB™m­
 | (1 << (32 - 
today
));

259 
	gÃwURLToday
 = 0;

260 
	gÃwURLB™m­
 = 0;

262 ià(
	gisChªged
) {

263 
	gmodifyCouÁ
 = 1;

264 
	gmodifyB™m­
 = 
modifyB™m­
 | (1 << (32 - 
today
));

266 
	gmodifyCouÁ
 = 0;

267 
	gmodifyB™m­
 = 0;

272 ià(
	gisChªged
) {

273 
	gÏ¡ModifyTime
 = 
Sy¡em
.
cu¼’tTimeMlis
() / 1000;

276 
	gkvLi¡
.
ş—r
();

278 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
a
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
Sy¡em
.
cu¼’tTimeMlis
() / 1000)));

279 
	gkvLi¡
.
add
(
kv
);

280 ià(
	gisChªged
) {

282 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
m
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
Ï¡ModifyTime
)));

283 
	gkvLi¡
.
add
(
kv
);

285 
	gSy¡em
.
¬¿ycİy
(
m‘aBy‹s
, 0, 
fšg”
, 0, 8);

286 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
f
, 
fšg”
);

287 
	gkvLi¡
.
add
(
kv
);

292 ià(
	g”rÜCouÁ
 > 0) {

293 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
this
.
e
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(0)));

294 
	gkvLi¡
.
add
(
kv
);

297 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
c
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
modifyCouÁ
)));

298 
	gkvLi¡
.
add
(
kv
);

300 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
b
, 
By‹s
.
toBy‹s
(
modifyB™m­
));

301 
	gkvLi¡
.
add
(
kv
);

303 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
g
, 
By‹s
.
toBy‹s
(
ÃwURLB™m­
));

304 
	gkvLi¡
.
add
(
kv
);

306 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
n
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
ÃwURLToday
)));

307 
	gkvLi¡
.
add
(
kv
);

311 ià(
	gisNewURL
) {

312 
KeyV®ue
 
	gskv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
s
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
("2")));

313 
	gkvLi¡
.
add
(
skv
);

315 ià(
	gisChªged
) {

316 
	gsumR©e
 = 0;

317 ià(
	gmodifyCouÁ
 > 0) {

318 
	gsumR©e
 +ğ
this
.
modifyR©iÚ
 * 
M©h
.
log
(
modifyCouÁ
 + 1);

320 
	gÚeMÚthModifyCouÁ
 = 
Numb”Ut
.
b™_couÁ_¥¬£
(
modifyB™m­
);

321 ià(
	gÚeMÚthModifyCouÁ
 > 0) {

322 
	gsumR©e
 +ğ
this
.
ÚeMÚthModifyR©iÚ
 * (
ÚeMÚthModifyCouÁ
 / 30);

325 
	gÚeMÚthNewURLCouÁ
 = 
Numb”Ut
.
b™_couÁ_¥¬£
(
ÃwURLB™m­
);

326 ià(
	gÚeMÚthNewURLCouÁ
 > 0) {

327 
	gsumR©e
 +ğ
this
.
ÚeMÚthNewURLR©iÚ
 * (
ÚeMÚthNewURLCouÁ
 / 30);

330 ià(
	gÃwURLToday
 > 0) {

331 
	gsumR©e
 +ğ
this
.
Ãwu¾R©iÚ
 * (
M©h
.
log
(
ÃwURLToday
 + 1));

334 ià(
	g·geRªk
 > 0) {

335 
	gsumR©e
 +ğ
this
.
·geRªkR©iÚ
 * 
·geRªk
;

338 
	gÃxtDowÆßdTime
 = 
Sy¡em
.
cu¼’tTimeMlis
(è/ 1000 + (è((
ONE_DAY_SECONDS
 / 
sumR©e
));

342 
	gš‹rv®
 = (
Sy¡em
.
cu¼’tTimeMlis
(è/ 1000 - 
Ï¡ModifyTime
è/ 
ONE_DAY_SECONDS
;

343 
	gÃxtDowÆßdTime
 = 
Sy¡em
.
cu¼’tTimeMlis
(è/ 1000 + (è((
ONE_DAY_SECONDS
è* (1 + 
M©h
.
log
(1 + 
š‹rv®
)));

347 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
d
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
ÃxtDowÆßdTime
)));

348 
	gkvLi¡
.
add
(
kv
);

350 
	gLog
.
šfo
("fš®„esuÉ:isChªged:=" + 
isChªged
 + "\a¡ModifyTime:=" + 
d©eFÜm©
.
fÜm©
(
Ãw
 
java
.
ut
.
D©e
(
Ï¡ModifyTime
)) + "\tmodifyCount="

351 + 
SŒšgUts
.
by‹ToHexSŒšg
(
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
modifyCouÁ
))è+ "\tmodifyb™m­=" + SŒšgUts.by‹ToHexSŒšg(By‹s.toBy‹s(
modifyB™m­
)) + "\tnewurlbitmap="

352 + 
SŒšgUts
.
by‹ToHexSŒšg
(
By‹s
.
toBy‹s
(
ÃwURLB™m­
)è+ "\Šewu¾today=" + SŒšgUts.by‹ToHexSŒšg(By‹s.toBy‹s(
SŒšg
.
v®ueOf
(
ÃwURLToday
))) + "\t‚extdownloadtime="

353 + 
d©eFÜm©
.
fÜm©
(
Ãw
 
java
.
ut
.
D©e
(
ÃxtDowÆßdTime
 * 1000)));

354 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

355 
KeyV®ue
 
	gkeyv®ue
 : 
kvLi¡
) {

356 
cÚ‹xt
.
wr™e
(
key
, 
keyv®ue
);

363 
şass
 
NewURLReduûr


364 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

366 
by‹
 
	gF
[] = 
By‹s
.
toBy‹s
("F");

367 
by‹
 
	gs
[] = 
By‹s
.
toBy‹s
("s");

368 
by‹
 
	gi
[] = 
By‹s
.
toBy‹s
("i");

369 
by‹
 
	gu
[] = 
By‹s
.
toBy‹s
("u");

370 
by‹
 
	gÃwu¾s
[] = 
By‹s
.
toBy‹s
("0");

371 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

373 @
Ov”ride


374 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<ImmubËBy‹sWr™abË> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
)

375 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

376 
	gI‹¿tÜ
<
	gImmubËBy‹sWr™abË
> 
	ge
 = 
v®ues
.
™”©Ü
();

377 
ImmubËBy‹sWr™abË
 
	gu¾
 = 
e
.
Ãxt
();

378 
	gkvLi¡
.
ş—r
();

380 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
F
, 
s
, 
Ãwu¾s
);

381 
	gkvLi¡
.
add
(
kv
);

383 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
u
, 
u¾
.get());

384 
	gkvLi¡
.
add
(
kv
);

386 
	gkv
 = 
Ãw
 
KeyV®ue
(
key
.
g‘
(), 
F
, 
i
, 
By‹s
.
toBy‹s
(
SŒšg
.
v®ueOf
(
Sy¡em
.
cu¼’tTimeMlis
() / 1000)));

387 
	gkvLi¡
.
add
(
kv
);

388 
	gCŞËùiÚs
.
sÜt
(
kvLi¡
, 
KeyV®ue
.
COMPARATOR
);

389 
KeyV®ue
 
	gkeyv®ue
 : 
kvLi¡
) {

390 
cÚ‹xt
.
wr™e
(
key
, 
keyv®ue
);

392 
	gcÚ‹xt
.
g‘CouÁ”
("¡©i¡icu¾", "Ãwu¾»duû").
šüem’t
(1);

400 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
(è
throws
 
CÏssNÙFoundExû±iÚ
 {

401 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

402 
Œy
 {

403 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

404 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

405 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>èCÏss.
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

407  
şazz
;

408 
	}
}

410 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
è
throws
 
IOExû±iÚ
 {

411 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

412 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 A¼ayLi¡<ImmubËBy‹sWr™abË>(
by‹Keys
.
Ëngth
);

413 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

414 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

416  
»t
;

417 
	}
}

419 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
è
throws
 
	gIOExû±iÚ
 {

420 ià(
	g¡¬tKeys
.
isEm±y
()) {

421 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

428 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(
¡¬tKeys
);

430 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

431 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

432 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("Fœ¡„egiÚ oàbË should havem±y s¹ key. In¡—d has: " + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

434 
	gsÜ‹d
.
»move
(
fœ¡
);

437 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

438 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

440 
	gŒy
 {

441 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

442 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

444 } 
	gfš®ly
 {

445 
	gwr™”
.
şo£
();

449 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

450 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

451 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

452 ià(
bËDesütÜ
 =ğ
nuÎ
) {

456 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

457 
i
 = 0;

458 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

459 ià(
i
++ > 0) {

460 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

462 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

463 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

464 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

467 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

468 
	}
}

470 
Job
 
	$ü—‹NewURLJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

471 
Job
 
job
 = 
nuÎ
;

472 
Œy
 {

473 
job
 = 
Ãw
 
	`Job
(
cÚf
);

474 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
NewURLInfoM­³r
.class);

475 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[4]));

476 
job
.
	`£tJobName
("StatisticNewURLInfo");

477 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

478 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

479 
job
.
	`£tReduûrCÏss
(
NewURLReduûr
.
şass
);

480 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

481 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

482 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

483 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

484 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

486 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

487 
Œy
 {

488 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

489 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

490 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

492 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

494 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

495 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

496 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

497 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

499 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

500 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

502 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

504 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

505 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

507 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

508 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

509 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

510 
Log
.
	`šfo
("Incrementalable output configured.");

511 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

512 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

513 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

515 
e
.
	`´štSckT¿û
();

517 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

519 
e
.
	`´štSckT¿û
();

521  
job
;

522 
	}
}

524 
Job
 
	$ü—‹OldURLJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

525 
Job
 
job
 = 
nuÎ
;

526 
Œy
 {

527 
job
 = 
Ãw
 
	`Job
(
cÚf
);

528 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
SrcURLM‘aM­³r
.class);

529 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[2]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
SrcURLDocidM­³r
.class);

530 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[3]));

531 
job
.
	`£tJobName
("StatisticOldURLInfo");

532 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

533 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

534 
job
.
	`£tReduûrCÏss
(
OldURLReduûr
.
şass
);

535 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

536 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

537 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

538 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

539 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

541 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

542 
Œy
 {

543 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

544 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

545 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

547 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

549 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

550 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

551 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

552 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

554 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

555 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

557 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

559 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

560 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

562 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

563 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

564 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

565 
Log
.
	`šfo
("Incrementalable output configured.");

566 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

567 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

569 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

571 
e
.
	`´štSckT¿û
();

573 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

575 
e
.
	`´štSckT¿û
();

577  
job
;

578 
	}
}

580 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

581 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

582 
SŒšg
[] 
Ùh”Args
;

583 
Œy
 {

584 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

585 ià(
Ùh”Args
.
Ëngth
 < 4) {

586 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage:");

587 
Sy¡em
.
	`ex™
(-1);

589 
Job
 
job
 = 
	`ü—‹OldURLJob
(
cÚf
, 
Ùh”Args
);

590 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

591 
Job
 
job2
 = 
	`ü—‹NewURLJob
(
cÚf
, 
Ùh”Args
);

592 
job2
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

593 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

594 
e
.
	`´štSckT¿û
();

595 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

596 
e
.
	`´štSckT¿û
();

599 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/TopKOrderPartition.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÏng
.
	g»æeù
.
	gA¼ay
;

5 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿bË
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gBš¬yCom·¿bË
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gRawCom·¿tÜ
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gWr™abËCom·¿bË
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gReæeùiÚUts
;

21 
public
 
şass
 
	gTİKOrd”P¬t™iÚ
<
K
 
ex‹nds
 
	gWr™abËCom·¿bË
<?>, 
	gV
>ƒxtends

22 
	gP¬t™iÚ”
<
	gK
, 
	gV
> 
im¶em’ts
 
	gCÚfigu¿bË
 {

24 
´iv©e
 
Node
 
	g·¹™iÚs
;

25 
public
 
fš®
 
SŒšg
 
	gDEFAULT_PATH
 = "_partition.lst";

26 
public
 
fš®
 
SŒšg
 
	gPARTITIONER_PATH
 = "mapreduce.totalorderpartitioner.path";

27 
public
 
fš®
 
SŒšg
 
	gMAX_TRIE_DEPTH
 = "mapreduce.totalorderpartitioner.trie.maxdepth";

28 
public
 
fš®
 
SŒšg
 
	gNATURAL_ORDER
 = "mapreduce.totalorderpartitioner.naturalorder";

29 
CÚfigu¿tiÚ
 
	gcÚf
;

32 
	gŞdRecÜdIndex
;

33 
	gÃwRecÜdIndex
;

35 @
Ov”ride


36 
public
 
£tCÚf
(
CÚfigu¿tiÚ
 
cÚf
) {

38 
	gK
[] 
	g¥l™Pošts
 = 
nuÎ
;

39 
	gŒy
 {

40 
	gthis
.
	gcÚf
 = 
cÚf
;

41 
SŒšg
 
	g·¹s
 = 
g‘P¬t™iÚFe
(
cÚf
);

42 
fš®
 
P©h
 
	g·¹Fe
 = 
Ãw
 P©h(
·¹s
);

43 
fš®
 
FeSy¡em
 
	gfs
 = (
DEFAULT_PATH
.
equ®s
(
·¹s
)) ? FileSystem

44 .
g‘Loÿl
(
cÚf
)

47 : 
·¹Fe
.
g‘FeSy¡em
(
cÚf
);

49 
Job
 
	gjob
 = 
Ãw
 Job(
cÚf
);

50 
	gCÏss
<
	gK
> 
	gkeyCÏss
 = (
CÏss
<
K
>è
job
.
g‘M­OuutKeyCÏss
();

51 
	gthis
.
	gŞdRecÜdIndex
 = 
cÚf
.
g‘IÁ
("old.record.index",-1);

52 
	gthis
.
	gÃwRecÜdIndex
 = 
cÚf
.
g‘IÁ
("Ãw.»cÜd.šdex", 
job
.
g‘NumReduûTasks
());

53 
	g¥l™Pošts
 = 
»adP¬t™iÚs
(
fs
, 
·¹Fe
, 
keyCÏss
, 
cÚf
);

61 ià(
	g¥l™Pošts
.
	gËngth
 !ğ
job
.
g‘NumReduûTasks
() - 1) {

62 
throw
 
Ãw
 
IOExû±iÚ
("Wrong‚umber of…artitions in keyset:"

63 + 
¥l™Pošts
.
Ëngth
 + "„educe‚um "

64 + 
job
.
g‘NumReduûTasks
());

66 
	gRawCom·¿tÜ
<
	gK
> 
	gcom·¿tÜ
 = (
RawCom·¿tÜ
<
K
>è
job


67 .
g‘SÜtCom·¿tÜ
();

68 
	gi
 = 0; i < 
	g¥l™Pošts
.
	gËngth
 - 1; ++i) {

69 
	gSy¡em
.
	gout
.
´šn
("v=" + 
¥l™Pošts
[
i
] + " "

70 + 
¥l™Pošts
[
i
 + 1]);

71 ià(
	gcom·¿tÜ
.
com·»
(
¥l™Pošts
[
i
], splitPoints[i + 1]) > 0) {

72 
throw
 
Ãw
 
IOExû±iÚ
("Split…oints‡re out of order");

75 
boŞ—n
 
	gÇtOrd”
 = 
cÚf
.
g‘BoŞ—n
(
NATURAL_ORDER
, 
Œue
);

76 ià(
	gÇtOrd”
 && 
	gBš¬yCom·¿bË
.
	gşass
.
isAssigÇbËFrom
(
keyCÏss
)) {

77 
	g·¹™iÚs
 = 
budTr›
((
Bš¬yCom·¿bË
[]è
¥l™Pošts
, 0,

78 
¥l™Pošts
.
Ëngth
, 
Ãw
 
by‹
[0],

92 
cÚf
.
g‘IÁ
(
MAX_TRIE_DEPTH
, 200));

94 
	g·¹™iÚs
 = 
Ãw
 
Bš¬yS—rchNode
(
¥l™Pošts
, 
com·¿tÜ
);

96 } 
ÿtch
 (
IOExû±iÚ
 
e
) {

97 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
(

99 + 
¥l™Pošts
.
Ëngth
, 
e
);

103 @
Ov”ride


104 
public
 
CÚfigu¿tiÚ
 
g‘CÚf
() {

105  
	gcÚf
;

108 @
Ov”ride


109 
public
 
g‘P¬t™iÚ
(
K
 
key
, 
V
 
v®ue
, 
numP¬t™iÚs
) {

110  
	g·¹™iÚs
.
fšdP¬t™iÚ
(
key
);

113 
public
 
£tP¬t™iÚFe
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
p
) {

114 
	gcÚf
.
£t
(
PARTITIONER_PATH
, 
p
.
toSŒšg
());

122 
public
 
SŒšg
 
g‘P¬t™iÚFe
(
CÚfigu¿tiÚ
 
cÚf
) {

123  
	gcÚf
.
g‘
(
PARTITIONER_PATH
, 
DEFAULT_PATH
);

129 
š‹rçû
 
	gNode
<
	gT
> {

134 
fšdP¬t™iÚ
(
T
 
key
);

141 
ab¡¿ù
 
şass
 
Tr›Node
 
im¶em’ts
 
	gNode
<
	gBš¬yCom·¿bË
> {

142 
´iv©e
 
fš®
 
	gËv–
;

144 
Tr›Node
(
Ëv–
) {

145 
	gthis
.
	gËv–
 = 
Ëv–
;

148 
g‘Lev–
() {

149  
	gËv–
;

158 
şass
 
Bš¬yS—rchNode
 
im¶em’ts
 
	gNode
<
	gK
> {

159 
´iv©e
 
fš®
 
	gK
[] 
	g¥l™Pošts
;

160 
´iv©e
 
fš®
 
	gRawCom·¿tÜ
<
	gK
> 
	gcom·¿tÜ
;

162 
Bš¬yS—rchNode
(
K
[] 
¥l™Pošts
, 
RawCom·¿tÜ
<K> 
com·¿tÜ
) {

163 
	gthis
.
	g¥l™Pošts
 = 
¥l™Pošts
;

164 
	gthis
.
	gcom·¿tÜ
 = 
com·¿tÜ
;

167 
public
 
fšdP¬t™iÚ
(
K
 
key
) {

168 
fš®
 
	gpos
 = 
A¼ays
.
bš¬yS—rch
(
¥l™Pošts
, 
key
, 
com·¿tÜ
) + 1;

169  (
	gpos
 < 0è? -po : 
pos
;

177 şas 
	cIÂ”Tr›Node
 
ex‹nds
 
	gTr›Node
 {

178 
´iv©e
 
	gTr›Node
[] 
	gchd
 = 
Ãw
 
Tr›Node
[256];

180 
IÂ”Tr›Node
(
Ëv–
) {

181 
su³r
(
Ëv–
);

184 
public
 
fšdP¬t™iÚ
(
Bš¬yCom·¿bË
 
key
) {

185 
	gËv–
 = 
g‘Lev–
();

186 ià(
	gkey
.
g‘L’gth
(è<ğ
Ëv–
) {

187  
chd
[0].
fšdP¬t™iÚ
(
key
);

189  
	gchd
[0xFF & 
key
.
g‘By‹s
()[
Ëv–
]].
fšdP¬t™iÚ
(key);

208 
´iv©e
 
Tr›Node
 
	$L—fTr›NodeFaùÜy
(
Ëv–
,

209 
Bš¬yCom·¿bË
[] 
¥l™Pošts
, 
low”
, 
uµ”
) {

210 
uµ”
 - 
low”
) {

212  
Ãw
 
	`Un¥l™Tr›Node
(
Ëv–
, 
low”
);

215  
Ãw
 
	`SšglyS¶™Tr›Node
(
Ëv–
, 
¥l™Pošts
, 
low”
);

218  
Ãw
 
	`L—fTr›Node
(
Ëv–
, 
¥l™Pošts
, 
low”
, 
uµ”
);

220 
	}
}

229 
´iv©e
 cÏs 
	cL—fTr›Node
 
ex‹nds
 
	gTr›Node
 {

230 
fš®
 
	glow”
;

231 
fš®
 
	guµ”
;

232 
fš®
 
	gBš¬yCom·¿bË
[] 
	g¥l™Pošts
;

234 
L—fTr›Node
(
Ëv–
, 
Bš¬yCom·¿bË
[] 
¥l™Pošts
, 
low”
,

235 
uµ”
) {

236 
su³r
(
Ëv–
);

237 
	gthis
.
	glow”
 = 
low”
;

238 
	gthis
.
	guµ”
 = 
uµ”
;

239 
	gthis
.
	g¥l™Pošts
 = 
¥l™Pošts
;

242 
public
 
fšdP¬t™iÚ
(
Bš¬yCom·¿bË
 
key
) {

243 
fš®
 
	gpos
 = 
A¼ays
.
bš¬yS—rch
(
¥l™Pošts
, 
low”
, 
uµ”
, 
key
) + 1;

244  (
	gpos
 < 0è? -po : 
pos
;

248 
´iv©e
 cÏs 
	cUn¥l™Tr›Node
 
ex‹nds
 
	gTr›Node
 {

249 
fš®
 
	g»suÉ
;

251 
Un¥l™Tr›Node
(
Ëv–
, 
v®ue
) {

252 
su³r
(
Ëv–
);

253 
	gthis
.
	g»suÉ
 = 
v®ue
;

256 
public
 
fšdP¬t™iÚ
(
Bš¬yCom·¿bË
 
key
) {

257  
	g»suÉ
;

261 
´iv©e
 cÏs 
	cSšglyS¶™Tr›Node
 
ex‹nds
 
	gTr›Node
 {

262 
fš®
 
	glow”
;

263 
fš®
 
Bš¬yCom·¿bË
 
	gmyS¶™Pošt
;

265 
SšglyS¶™Tr›Node
(
Ëv–
, 
Bš¬yCom·¿bË
[] 
¥l™Pošts
, 
low”
) {

266 
su³r
(
Ëv–
);

267 
	gthis
.
	glow”
 = 
low”
;

268 
	gthis
.
	gmyS¶™Pošt
 = 
¥l™Pošts
[
low”
];

271 
public
 
fšdP¬t™iÚ
(
Bš¬yCom·¿bË
 
key
) {

272  
	glow”
 + (
	gkey
.
com·»To
(
myS¶™Pošt
) < 0 ? 0 : 1);

290 @
Suµ»ssW¬nšgs
("unchecked")

292 
´iv©e
 
	gK
[] 
»adP¬t™iÚs
(
FeSy¡em
 
fs
, 
P©h
 
p
, 
CÏss
<
K
> 
keyCÏss
,

293 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
	gIOExû±iÚ
 {

294 
	gSequ’ûFe
.
R—d”
 
	g»ad”
 = 
Ãw
 
Sequ’ûFe
.R—d”(
fs
, 
p
, 
cÚf
);

295 
	gA¼ayLi¡
<
	gK
> 
	g·¹s
 = 
Ãw
 
A¼ayLi¡
<
K
>();

296 
K
 
	gkey
 = 
ReæeùiÚUts
.
ÃwIn¡ªû
(
keyCÏss
, 
cÚf
);

297 
NuÎWr™abË
 
	gv®ue
 = NuÎWr™abË.
g‘
();

298 
	gk
 = 1;

299 
	g»ad”
.
Ãxt
(
key
, 
v®ue
)) {

300 ià(
	gthis
.
	gŞdRecÜdIndex
 !ğ-1 || 
this
.
ÃwRecÜdIndex
 != -1) {

301 ià(
k
 <=
this
.
ŞdRecÜdIndex
 || k >his.
ÃwRecÜdIndex
) {

302 
·¹s
.
add
(
key
);

305 
	g·¹s
.
add
(
key
);

307 
	gk
++;

308 
	gkey
 = 
ReæeùiÚUts
.
ÃwIn¡ªû
(
keyCÏss
, 
cÚf
);

310 
	g»ad”
.
şo£
();

311  
	g·¹s
.
toA¼ay
((
K
[]è
A¼ay
.
ÃwIn¡ªû
(
keyCÏss
, 
·¹s
.
size
()));

322 
´iv©e
 cÏs 
	cC¬r›dTr›NodeRef
 {

323 
Tr›Node
 
	gcÚ‹Á
;

325 
C¬r›dTr›NodeRef
() {

326 
	gcÚ‹Á
 = 
nuÎ
;

346 
´iv©e
 
Tr›Node
 
	$budTr›
(
Bš¬yCom·¿bË
[] 
¥l™s
, 
low”
, 
uµ”
,

347 
by‹
[] 
´efix
, 
maxD•th
) {

348  
	`budTr›Rec
(
¥l™s
, 
low”
, 
uµ”
, 
´efix
, 
maxD•th
,

349 
Ãw
 
	`C¬r›dTr›NodeRef
());

350 
	}
}

372 
´iv©e
 
Tr›Node
 
	$budTr›Rec
(
Bš¬yCom·¿bË
[] 
¥l™s
, 
low”
,

373 
uµ”
, 
by‹
[] 
´efix
, 
maxD•th
, 
C¬r›dTr›NodeRef
 
»f
) {

374 
fš®
 
d•th
 = 
´efix
.
Ëngth
;

377 ià(
d•th
 >ğ
maxD•th
 || 
low”
 >ğ
uµ”
 - 1) {

380 ià(
low”
 =ğ
uµ”
 && 
»f
.
cÚ‹Á
 !ğ
nuÎ
) {

381  
»f
.
cÚ‹Á
;

383 
Tr›Node
 
»suÉ
 = 
	`L—fTr›NodeFaùÜy
(
d•th
, 
¥l™s
, 
low”
, 
uµ”
);

384 
»f
.
cÚ‹Á
 = 
low”
 =ğ
uµ”
 ? 
»suÉ
 : 
nuÎ
;

385  
»suÉ
;

387 
IÂ”Tr›Node
 
»suÉ
 = 
Ãw
 
	`IÂ”Tr›Node
(
d•th
);

388 
by‹
[] 
ŒŸl
 = 
A¼ays
.
	`cİyOf
(
´efix
,…»fix.
Ëngth
 + 1);

390 
cu¼’tBound
 = 
low”
;

391 
ch
 = 0; ch < 0xFF; ++ch) {

392 
ŒŸl
[
d•th
] = (
by‹
è(
ch
 + 1);

393 
low”
 = 
cu¼’tBound
;

394 
cu¼’tBound
 < 
uµ”
) {

395 ià(
¥l™s
[
cu¼’tBound
].
	`com·»To
(
ŒŸl
, 0,rŸl.
Ëngth
) >= 0) {

398 
cu¼’tBound
 += 1;

400 
ŒŸl
[
d•th
] = (
by‹
è
ch
;

401 
»suÉ
.
chd
[0xFF & 
ch
] = 
	`budTr›Rec
(
¥l™s
, 
low”
, 
cu¼’tBound
,

402 
ŒŸl
, 
maxD•th
, 
»f
);

405 
ŒŸl
[
d•th
] = (
by‹
) 0xFF;

406 
»suÉ
.
chd
[0xFF] = 
	`budTr›Rec
(
¥l™s
, 
low”
, 
cu¼’tBound
, 
ŒŸl
,

407 
maxD•th
, 
»f
);

409  
»suÉ
;

410 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/TotalValueSort.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÏng
.
	g»æeù
.
	gA¼ay
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

6 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

7 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	ghadoİbackpÜt
.
	gIÅutSam¶”
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	ghadoİbackpÜt
.
	gIÅutSam¶”
.
	gSam¶”
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	ghadoİbackpÜt
.
	gTÙ®Ord”P¬t™iÚ”
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gFlßtWr™abË
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gRawCom·¿tÜ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gIÅutFÜm©
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gReæeùiÚUts
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞ
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gToŞRuÂ”
;

36 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gMD5
;

37 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

38 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghadoİ
.
	gjobcÚŒŞ
.
	gM­»duûV2Job
;

40 
public
 
şass
 
TÙ®V®ueSÜt
 
ex‹nds
 
CÚfigu»d
 
im¶em’ts
 
	gToŞ
, 
	gM­»duûV2Job
 {

42 
public
 
TÙ®V®ueSÜt
() {

43 
this
(
Ãw
 
CÚfigu¿tiÚ
());

46 
public
 
TÙ®V®ueSÜt
(
CÚfigu¿tiÚ
 
cÚf
) {

47 
	gthis
.
£tCÚf
(
cÚf
);

50 
şass
 
TÙ®V®ueM­³r
 
ex‹nds


51 
	gM­³r
<
	gFlßtWr™abË
, 
	gText
, FloatWritable, Text> {

52 
CÚfigu¿tiÚ
 
	gcÚf
;

53 
public
 
fš®
 
SŒšg
 
	gDEFAULT_PATH
 = "_partition.lst";

54 
public
 
fš®
 
SŒšg
 
	gPARTITIONER_PATH
 = "mapreduce.totalorderpartitioner.path";

55 
	gRawCom·¿tÜ
<
	gFlßtWr™abË
> 
	gcom·¿tÜ
;

56 
	gFlßtWr™abË
[] 
	g¥l™Pošts
;

58 
	gŞdRecÜdIndex
;

59 
	gÃwRecÜdIndex
;

60 
	g·¹™iÚs
;

62 @
Ov”ride


63 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

64 
	gIÁ”ru±edExû±iÚ
 {

66 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

69 @
Ov”ride


70 
´Ùeùed
 
m­
(
FlßtWr™abË
 
key
, 
Text
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

71 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

74 
	gpos
 = 
A¼ays
.
bš¬yS—rch
(
¥l™Pošts
, 
key
, 
com·¿tÜ
) + 1;

75 
	gpos
 = 
pos
 < 0 ? -pos :…os;

77 ià(
	gpos
 <ğ
this
.
ŞdRecÜdIndex
 || 
pos
 >ğthis.
ÃwRecÜdIndex
) {

78 
u¾L’
 = 
Numb”Ut
.
»adIÁ
(
v®ue
.
g‘By‹s
(), 44);

79 
SŒšg
 
	gu¾
 = 
Ãw
 SŒšg(
v®ue
.
g‘By‹s
(), 48, 
u¾L’
);

80 
	gSy¡em
.
	gout
.
´šn
("pos=" + 
pos
 + " u¾=" + 
u¾
 + " score="

81 + 
key
);

82 
	gcÚ‹xt
.
wr™e
(
key
, 
v®ue
);

88 @
Ov”ride


89 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
,

90 
	gIÁ”ru±edExû±iÚ
 {

92 
	gsu³r
.
£tup
(
cÚ‹xt
);

93 
	gthis
.
	gcÚf
 = 
cÚ‹xt
.
g‘CÚfigu¿tiÚ
();

94 
SŒšg
 
	g·¹s
 = 
cÚf
.
g‘
(
PARTITIONER_PATH
, 
DEFAULT_PATH
);

95 
fš®
 
P©h
 
	g·¹Fe
 = 
Ãw
 P©h(
·¹s
);

96 
fš®
 
FeSy¡em
 
	gfs
 = (
DEFAULT_PATH
.
equ®s
(
·¹s
)) ? FileSystem

97 .
g‘Loÿl
(
cÚf
)

100 : 
·¹Fe
.
g‘FeSy¡em
(
cÚf
);

102 
Job
 
	gjob
 = 
Ãw
 Job(
cÚf
);

103 
	gthis
.
	g·¹™iÚs
 = 
cÚf
.
g‘IÁ
("total.sort.pre.partition",

104 
job
.
g‘NumReduûTasks
());

105 
	gthis
.
	gŞdRecÜdIndex
 = 
cÚf
.
g‘IÁ
("old.record.index",

106 
job
.
g‘NumReduûTasks
() - 1);

107 
	gthis
.
	gÃwRecÜdIndex
 = 
cÚf
.
g‘IÁ
("new.record.index",

108 
this
.
·¹™iÚs
);

109 
	g¥l™Pošts
 = 
»adP¬t™iÚs
(
fs
, 
·¹Fe
, 
FlßtWr™abË
.
şass
,

110 
cÚf
);

111 
	gSy¡em
.
	gout
.
´šn
("¥l™Pošts.Ëngth" + 
¥l™Pošts
.
Ëngth


112 + " old.»cÜd.šdex=" + 
ŞdRecÜdIndex


113 + "Ãw.»cÜd.šdex" + 
ÃwRecÜdIndex
 + "reduce="

114 + 
job
.
g‘NumReduûTasks
());

117 
	gSy¡em
.
	gout
.
´šn
("¥l™…ošt Ëngth=" + 
¥l™Pošts
.
Ëngth
);

118 
	gcom·¿tÜ
 = (
RawCom·¿tÜ
<
FlßtWr™abË
>è
job
.
g‘SÜtCom·¿tÜ
();

119 
	gi
 = 0; i < 
	g¥l™Pošts
.
	gËngth
 - 1 && i < 
	gthis
.
	g·¹™iÚs
; ++i) {

120 ià(
	gcom·¿tÜ
.
com·»
(
¥l™Pošts
[
i
], splitPoints[i + 1]) > 0) {

121 
throw
 
Ãw
 
IOExû±iÚ
("Split…oints‡re out of order");

127 
´iv©e
 
	gFlßtWr™abË
[] 
»adP¬t™iÚs
(
FeSy¡em
 
fs
, 
P©h
 
p
,

128 
CÏss
 
keyCÏss
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
	gIOExû±iÚ
 {

129 
	gSequ’ûFe
.
R—d”
 
	g»ad”
 = 
Ãw
 
Sequ’ûFe
.R—d”(
fs
, 
p
, 
cÚf
);

130 
	gA¼ayLi¡
<
	gFlßtWr™abË
> 
	g·¹s
 = 
Ãw
 
A¼ayLi¡
<
FlßtWr™abË
>();

131 
FlßtWr™abË
 
	gkey
 = (FlßtWr™abËè
ReæeùiÚUts
.
ÃwIn¡ªû
(

132 
keyCÏss
, 
cÚf
);

133 
NuÎWr™abË
 
	gv®ue
 = NuÎWr™abË.
g‘
();

134 
	g»ad”
.
Ãxt
(
key
, 
v®ue
)) {

135 
	g·¹s
.
add
(
key
);

136 
	gkey
 = (
FlßtWr™abË
è
ReæeùiÚUts
.
ÃwIn¡ªû
(
keyCÏss
,

137 
cÚf
);

139 
	g»ad”
.
şo£
();

140  
	g·¹s
.
toA¼ay
((
FlßtWr™abË
[]è
A¼ay
.
ÃwIn¡ªû
(
keyCÏss
,

141 
·¹s
.
size
()));

146 
şass
 
TÙ®V®ueReduûr
 
ex‹nds


147 
	gReduûr
<
	gFlßtWr™abË
, 
	gText
, 
	gImmubËBy‹sWr™abË
, Text> {

149 
by‹
 
	ga
[] = 
Ãw
 byte[12];

150 
ImmubËBy‹sWr™abË
 
	gk3
 = 
Ãw
 ImmutableBytesWritable();

152 @
Ov”ride


153 
´Ùeùed
 
»duû
(
FlßtWr™abË
 
key
, 
I‹¿bË
<
Text
> 
v®ues
,

154 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

155 
by‹
 
	gscÜe
[] = 
By‹s
.
toBy‹s
(
key
.
g‘
());

156 
	gu¾L’
 = 0;

157 
	gSy¡em
.
¬¿ycİy
(
scÜe
, 0, 
a
, 8, 4);

158 
Text
 
	go
 : 
v®ues
) {

159 
by‹
 
by‹s
[] = 
o
.
g‘By‹s
();

160 
	gu¾L’
 = 
Numb”Ut
.
»adIÁ
(
by‹s
, 44);

161 
by‹
 
	gdocid
[] = 
MD5
.
dige¡8
(
by‹s
, 48, 
u¾L’
).
g‘Dige¡
();

162 
	gSy¡em
.
¬¿ycİy
(
docid
, 0, 
a
, 0, 8);

163 
	gk3
.
£t
(
a
);

164 
	gcÚ‹xt
.
wr™e
(
k3
, 
o
);

169 @
Ov”ride


170 
public
 
run
(
SŒšg
[] 
¬gs
è
throws
 
	gExû±iÚ
 {

176 
Job
 
	gjob
 = 
this
.
ü—‹RuÂabËJob
(
¬gs
);

177 ià(
	gjob
 !ğ
nuÎ
) {

178  
job
.
wa™FÜCom¶‘iÚ
(
Œue
) ? 0 : 1;

183 
public
 <
	gK
, 
	gV
> 
boŞ—n
 
wr™eP¬t™iÚFe
(
Job
 
job
,

184 
Sam¶”
<
K
, 
V
> 
§m¶”
è
throws
 
	gIOExû±iÚ
, 
	gCÏssNÙFoundExû±iÚ
,

185 
	gIÁ”ru±edExû±iÚ
 {

186 
CÚfigu¿tiÚ
 
	gcÚf
 = 
job
.
g‘CÚfigu¿tiÚ
();

187 
fš®
 
IÅutFÜm©
 
	gšf
 = 
ReæeùiÚUts
.
ÃwIn¡ªû
(

188 
job
.
g‘IÅutFÜm©CÏss
(), 
cÚf
);

189 
	gnumP¬t™iÚs
 = 
job
.
g‘CÚfigu¿tiÚ
().
g‘IÁ
(

190 "tÙ®.sÜt.´e.·¹™iÚ", 
job
.
g‘NumReduûTasks
());

191 
	gK
[] 
	g§m¶es
 = 
§m¶”
.
g‘Sam¶e
(
šf
, 
job
);

192 
	gSy¡em
.
	gout
.
´šn
("·¹™iÚ Ëngth=" + 
numP¬t™iÚs


193 + " sam¶e Ëngth =" + 
§m¶es
.
Ëngth
);

194 
	gRawCom·¿tÜ
<
	gK
> 
	gcom·¿tÜ
 = (
RawCom·¿tÜ
<
K
>è
job


195 .
g‘SÜtCom·¿tÜ
();

196 
	gA¼ays
.
sÜt
(
§m¶es
, 
com·¿tÜ
);

201 
P©h
 
	gd¡
 = 
Ãw
 P©h(
TÙ®Ord”P¬t™iÚ”
.
g‘P¬t™iÚFe
(
cÚf
));

202 
FeSy¡em
 
	gfs
 = 
d¡
.
g‘FeSy¡em
(
cÚf
);

203 ià(
	gfs
.
exi¡s
(
d¡
)) {

204 
	gfs
.
d–‘e
(
d¡
, 
çl£
);

206 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
d¡
,

207 
job
.
g‘M­OuutKeyCÏss
(), 
NuÎWr™abË
.
şass
);

208 
NuÎWr™abË
 
	gnuÎV®ue
 = NuÎWr™abË.
g‘
();

209 
	g¡•Size
 = 
§m¶es
.
Ëngth
 / (è
numP¬t™iÚs
;

210 
	gÏ¡
 = -1;

211 
	gi
 = 1;

212 
	gm
 = 0;

213 ; 
	gi
 < 
	gnumP¬t™iÚs
; ++i) {

214 
	gk
 = 
M©h
.
round
(
¡•Size
 * 
i
);

215 
	gÏ¡
 >ğ
k


216 && 
com·¿tÜ
.
com·»
(
§m¶es
[
Ï¡
], sam¶es[
k
]) == 0) {

217 ++
k
;

219 ià(
	gk
 < 
	g§m¶es
.
	gËngth
) {

220 
	gm
++;

221 
	gwr™”
.
­³nd
(
§m¶es
[
k
], 
nuÎV®ue
);

222 
	gÏ¡
 = 
k
;

224 
	gSy¡em
.
	gout
.
´šn
("sample failed");

228 
	gwr™”
.
şo£
();

229 
	gSy¡em
.
	gout
.
´šn
("wr™§m¶fšished,m=" + 
m
 + "\ti=" + 
i


230 + "‚um…¬t™iÚs=" + 
numP¬t™iÚs
);

231 ià(
	gm
 =ğ
numP¬t™iÚs
 - 1) {

232  
Œue
;

234  
	gçl£
;

238 @
Suµ»ssW¬nšgs
("unchecked")

239 
public
 
maš
(
SŒšg
 
¬gs
[]è
throws
 
	gExû±iÚ
 {

240 
	gex™Code
 = 
ToŞRuÂ”
.
run
(
Ãw
 
TÙ®V®ueSÜt
(), 
¬gs
);

241 
	gSy¡em
.
ex™
(
ex™Code
);

251 @
Ov”ride


252 
public
 
Job
 
ü—‹RuÂabËJob
(
SŒšg
[] 
¬gs
) {

254 
	gŒy
 {

255 
	gSŒšg
[] 
	gÙh”Args
 = 
Ãw
 
G’”icO±iÚsP¬£r
(
g‘CÚf
(), 
¬gs
)

256 .
g‘RemaššgArgs
();

257 ià(
	gÙh”Args
.
	gËngth
 < 4) {

258 
	gSy¡em
.
	gout
.
´šn
("Wrong‚umber of‡rguments: "

259 + 
Ùh”Args
.
Ëngth
 + " input ");

260 
	gSy¡em
.
ex™
(-1);

266 
	gSy¡em
.
	gout
.
´šn
("ü—‹„uÂšg job‡rg Ëngth=" + 
Ùh”Args
);

268 
Job
 
	gjob
 = 
Ãw
 Job(
g‘CÚf
());

269 
	gsumRecÜd
 = 0, 
	gãtchRecÜd
 = 0;

270 
	gŞdURLR©iÚ
 = 0.5f;

271 ià(
	gÙh”Args
.
	gËngth
 >= 3) {

272 
sumRecÜd
 = 
IÁeg”
.
·r£IÁ
(
Ùh”Args
[2]);

275 ià(
	gÙh”Args
.
	gËngth
 >= 4) {

276 
ãtchRecÜd
 = 
IÁeg”
.
·r£IÁ
(
Ùh”Args
[3]);

278 
	gŞdURLR©iÚ
 = 
job
.
g‘CÚfigu¿tiÚ
().
g‘Flßt
("oldNewRatio", 0.0f);

279 
	g·¹™iÚs
 = 0, 
	gŞdRecÜdIndex
 = 
job
.
g‘NumReduûTasks
(è- 1, 
	gÃwRecÜdIndex
 = -1;

280 ià(
	gsumRecÜd
 =ğ0 || 
ãtchRecÜd
 == 0) {

281 
·¹™iÚs
 = 
job
.
g‘NumReduûTasks
();

283 ià(
	gãtchRecÜd
 > 
	gsumRecÜd
) {

284 
	g·¹™iÚs
 = 
job
.
g‘NumReduûTasks
();

285 
	gŞdRecÜdIndex
 = 
job
.
g‘NumReduûTasks
() - 1;

287 
	gt
 = 
job
.
g‘NumReduûTasks
();

288 
	gŞdP¬t
 = (è(
t
 * 
ŞdURLR©iÚ
);

289 
	gÃwP¬t
 = 
t
 - 
ŞdP¬t
;

291 
	g·¹
 = 
ãtchRecÜd
 / 
t
;

292 
	g®lP¬t
 = 
sumRecÜd
 / 
·¹
;

293 ià(
	gsumRecÜd
 % 
	g·¹
 > (part / 2)) {

294 
	g®lP¬t
++;

296 
	g·¹™iÚs
 = 
®lP¬t
;

297 ià(
	gŞdP¬t
 != 0) {

298 
ŞdRecÜdIndex
 = 
ŞdP¬t
 - 1;

300 
	gŞdRecÜdIndex
 = -1;

302 ià(
	gÃwP¬t
 != 0) {

303 
ÃwRecÜdIndex
 = 
®lP¬t
 - 
ÃwP¬t
;

305 
	gÃwRecÜdIndex
 = 
®lP¬t
+1 ;

310 
	g§m¶eL’
 = 
sumRecÜd
 / 100;

311 ià(
	g§m¶eL’
 < 10000 && 
	gsumRecÜd
 / 2 > 10000) {

312 
	g§m¶eL’
 = 10000;

314 ià(
	g§m¶eL’
 > 100000) {

315 
	g§m¶eL’
 = 50000;

317 
	gSy¡em
.
	gout
.
´šn
("tÙ®.sÜt.´e.·¹™iÚ=" + 
·¹™iÚs


318 + "\tŞd.»cÜd.šdex=" + 
ŞdRecÜdIndex


319 + "\Šew.»cÜd.šdex=" + 
ÃwRecÜdIndex
);

323 
	gjob
.
g‘CÚfigu¿tiÚ
().
£tIÁ
("Şd.»cÜd.šdex", 
ŞdRecÜdIndex
);

324 
	gjob
.
g‘CÚfigu¿tiÚ
().
£tIÁ
("Ãw.»cÜd.šdex", 
ÃwRecÜdIndex
);

325 
	gjob
.
g‘CÚfigu¿tiÚ
().
£tIÁ
("total.sort.pre.partition",

326 
·¹™iÚs
);

330 
	gFeIÅutFÜm©
.
£tIÅutP©hs
(
job
, 
Ãw
 
P©h
(
Ùh”Args
[0]));

333 
	gFeOuutFÜm©
.
£tOuutP©h
(
job
, 
Ãw
 
P©h
(
Ùh”Args
[1]));

334 
	gjob
.
£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

335 
	gjob
.
£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

336 
	gjob
.
£tM­OuutKeyCÏss
(
FlßtWr™abË
.
şass
);

337 
	gjob
.
£tM­OuutV®ueCÏss
(
Text
.
şass
);

338 
	gjob
.
£tOuutV®ueCÏss
(
Text
.
şass
);

340 
	gjob
.
£tM­³rCÏss
(
TÙ®V®ueM­³r
.
şass
);

341 
	gjob
.
£tP¬t™iÚ”CÏss
(
TİKOrd”P¬t™iÚ
.
şass
);

342 
	gjob
.
£tSÜtCom·¿tÜCÏss
(
FlßtRev”£Com·¿tÜ
.
şass
);

348 
	gjob
.
£tReduûrCÏss
(
TÙ®V®ueReduûr
.
şass
);

349 
	gIÅutSam¶”
.
	gSam¶”
<
	gFlßtWr™abË
, 
	gText
> 
	g§m¶”
 = 
Ãw
 
IÅutSam¶”
.
RªdomSam¶”
<
FlßtWr™abË
, Text>(

350 0.1, 
	g§m¶eL’
, 10);

351 
P©h
 
	gšput
 = 
FeIÅutFÜm©
.
g‘IÅutP©hs
(
job
)[0];

352 
	gšput
 = 
šput
.
makeQu®if›d
(šput.
g‘FeSy¡em
(
g‘CÚf
()));

353 
P©h
 
	g·¹™iÚFe
 = 
Ãw
 P©h(
šput
, "_partitions");

354 
FeSy¡em
 
	gfs
 = 
·¹™iÚFe
.
g‘FeSy¡em
(
job
.
g‘CÚfigu¿tiÚ
());

355 
	gTİKOrd”P¬t™iÚ
.
£tP¬t™iÚFe
(
job
.
g‘CÚfigu¿tiÚ
(),

356 
·¹™iÚFe
);

357 
	gt
 = 0;

359 
boŞ—n
 
	gm
 = 
wr™eP¬t™iÚFe
(
job
, 
§m¶”
);

360 ià(
	gm
)

363 
	gt
++;

364 
	gSy¡em
.
	gout
.
´šn
("g’”©·¹™iÚ fçed!" + 
t


367 } 
	gt
 < 10);

368 ià(
	gt
 == 10) {

369 
Sy¡em
.
out
.
´šn
("generate…artition file failed!");

370 
	gSy¡em
.
ex™
(0);

372 
URI
 
	g·¹™iÚUri
 = 
Ãw
 URI(
·¹™iÚFe
.
toSŒšg
()

374 
	gDi¡ribu‹dCache
.
addCacheFe
(
·¹™iÚUri
, 
g‘CÚf
());

375 
	gDi¡ribu‹dCache
.
ü—‹Symlšk
(
g‘CÚf
());

376 
	gfs
.
d–‘eOnEx™
(
·¹™iÚFe
);

377  
	gjob
;

378 } 
ÿtch
 (
Exû±iÚ
 
e
) {

379 
	ge
.
´štSckT¿û
();

381  
	gnuÎ
;

	@com/zhongsou/spider/hbase/mapreduce/UpdateHbaseStatus.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

4 
impÜt
 
	gjava
.
	gÃt
.
	gURI
;

5 
impÜt
 
	gjava
.
	gÃt
.
	gURISyÁaxExû±iÚ
;

6 
impÜt
 
	gjava
.
	gÃt
.
	gURLEncod”
;

7 
impÜt
 
	gjava
.
	g‹xt
.
	gD©eFÜm©
;

8 
impÜt
 
	gjava
.
	gut
.
	gA¼ayLi¡
;

9 
impÜt
 
	gjava
.
	gut
.
	gC®’d¬
;

10 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚ
;

11 
impÜt
 
	gjava
.
	gut
.
	gCŞËùiÚs
;

12 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

13 
impÜt
 
	gjava
.
	gut
.
	gLškedLi¡
;

14 
impÜt
 
	gjava
.
	gut
.
	gLi¡
;

15 
impÜt
 
	gjava
.
	gut
.
	gT»eS‘
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfeÿche
.
	gDi¡ribu‹dCache
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gFeSy¡em
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCŞumnDesütÜ
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHCÚ¡ªts
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHTabËDesütÜ
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
.
	gTy³
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gHTabË
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gHFeOuutFÜm©
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gSequ’ûFe
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

39 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

40 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

41 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

42 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	g·¹™iÚ
.
	gTÙ®Ord”P¬t™iÚ”
;

43 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

44 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

69 
public
 cÏs 
	cUpd©eHba£Stus
 {

70 
fš®
 
SŒšg
 
	mCOMPRESSION_CONF_KEY
 = "hbase.hfileoutputformat.families.compression";

72 
şass
 
NewDocidM­³r
 
ex‹nds
 
	mM­³r
<
	mImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

73 
ImmubËBy‹sWr™abË
 
	mv
 = 
Ãw
 ImmutableBytesWritable();

75 @
Ov”ride


76 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

78 
	msu³r
.
£tup
(
cÚ‹xt
);

79 
by‹
 
	ma
[] = 
Ãw
 byte[1];

80 
	ma
[0] = '1';

81 
	mv
.
£t
(
a
);

84 @
Ov”ride


85 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

87 
	mcÚ‹xt
.
wr™e
(
key
, 
v
);

88 
	mcÚ‹xt
.
g‘CouÁ”
("upd©ehba£¡©us", "Ãwdocid").
šüem’t
(1);

94 
şass
 
D–‘eLßdM­³r
 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

95 
ImmubËBy‹sWr™abË
 
	gv
 = 
Ãw
 ImmutableBytesWritable();

97 @
Ov”ride


98 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

100 
	gsu³r
.
£tup
(
cÚ‹xt
);

101 
by‹
 
	ga
[] = 
Ãw
 byte[1];

102 
	ga
[0] = '2';

103 
	gv
.
£t
(
a
);

106 @
Ov”ride


107 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, ImmubËBy‹sWr™abË 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

109 
	gcÚ‹xt
.
wr™e
(
key
, 
v
);

110 
	gcÚ‹xt
.
g‘CouÁ”
("upd©ehba£¡©us", "d–‘eLßd").
šüem’t
(1);

114 
şass
 
LßdFÏgM­³r
 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, 
	gNuÎWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable> {

115 
ImmubËBy‹sWr™abË
 
	gv
 = 
Ãw
 ImmutableBytesWritable();

117 @
Ov”ride


118 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

120 
	gsu³r
.
£tup
(
cÚ‹xt
);

121 
by‹
 
	ga
[] = 
Ãw
 byte[1];

122 
	ga
[0] = '3';

123 
	gv
.
£t
(
a
);

127 @
Ov”ride


128 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
NuÎWr™abË
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

130 
	gcÚ‹xt
.
wr™e
(
key
, 
v
);

131 
	gcÚ‹xt
.
g‘CouÁ”
("upd©ehba£¡©us", "lßdFÏg").
šüem’t
(1);

136 
şass
 
DocidReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

137 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

139 
	gby‹
[] 
	gP
 = 
By‹s
.
toBy‹s
("P");

140 
	gby‹
[] 
	gF
 = 
By‹s
.
toBy‹s
("F");

141 
	gby‹
[] 
	gn
 = 
By‹s
.
toBy‹s
("n");

142 
	gby‹
[] 
	gÏ
 = 
By‹s
.
toBy‹s
("la");

143 
	gby‹
[] 
	g´–ßd
 = 
By‹s
.
toBy‹s
("2");

144 
	gby‹
[] 
	glßd
 = 
By‹s
.
toBy‹s
("1");

145 
	gby‹
[] 
	gnÚew
 = 
By‹s
.
toBy‹s
("0");

147 
by‹
 
	gfšg”
[] = 
Ãw
 byte[8];

148 
C®’d¬
 
	gÏ¡C®
 = 
Ãw
 
java
.
ut
.
G»gÜŸnC®’d¬
();

149 
C®’d¬
 
	gnow
 = 
Ãw
 
java
.
ut
.
G»gÜŸnC®’d¬
();

150 
	gONE_DAY_SECONDS
 = 24 * 60 * 60;

151 
D©eFÜm©
 
	gd©eFÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyy-MM-dd HH:mm:ss");

153 @
Ov”ride


154 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

159 @
Ov”ride


160 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

162 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

166 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvli¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

168 @
Ov”ride


169 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<ImmubËBy‹sWr™abË> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

172 
ImmubËBy‹sWr™abË
 
	gv
 = 
nuÎ
;

173 
	gI‹¿tÜ
<
	gImmubËBy‹sWr™abË
> 
	g™
 = 
v®ues
.
™”©Ü
();

174 
	gkvli¡
.
ş—r
();

175 
	g™
.
hasNext
()) {

176 
	gv
 = 
™
.
Ãxt
();

178 ià(
	gv
.
g‘
()[
v
.
g‘Off£t
()] == '1') {

179 
KeyV®ue
 
kv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
P
, 
n
, 
Sy¡em
.
cu¼’tTimeMlis
(), 
Ty³
.
Put
, 
nÚew
);

180 
	gkvli¡
.
add
(
kv
);

183 ià(
	gv
.
g‘
()[
v
.
g‘Off£t
()] == '2') {

184 
KeyV®ue
 
kv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
P
, 
Ï
, 
Sy¡em
.
cu¼’tTimeMlis
(), 
Ty³
.
Put
, 
nÚew
);

185 
	gkvli¡
.
add
(
kv
);

188 ià(
	gv
.
g‘
()[
v
.
g‘Off£t
()] == '3') {

189 
KeyV®ue
 
kv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
P
, 
Ï
, 
Sy¡em
.
cu¼’tTimeMlis
(), 
Ty³
.
Put
, 
´–ßd
);

190 
	gkvli¡
.
add
(
kv
);

196 
	gCŞËùiÚs
.
sÜt
(
kvli¡
, 
KeyV®ue
.
COMPARATOR
);

197 
KeyV®ue
 
	gkv
 : 
kvli¡
) {

198 
cÚ‹xt
.
wr™e
(
key
, 
kv
);

203 
şass
 
NewLßdReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gKeyV®ue
> {

204 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvLi¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

206 
	gby‹
[] 
	gP
 = 
By‹s
.
toBy‹s
("P");

207 
	gby‹
[] 
	gF
 = 
By‹s
.
toBy‹s
("F");

208 
	gby‹
[] 
	gn
 = 
By‹s
.
toBy‹s
("n");

209 
	gby‹
[] 
	gÏ
 = 
By‹s
.
toBy‹s
("la");

210 
	gby‹
[] 
	g´–ßd
 = 
By‹s
.
toBy‹s
("2");

211 
	gby‹
[] 
	glßd
 = 
By‹s
.
toBy‹s
("1");

213 
by‹
 
	gfšg”
[] = 
Ãw
 byte[8];

214 
C®’d¬
 
	gÏ¡C®
 = 
Ãw
 
java
.
ut
.
G»gÜŸnC®’d¬
();

215 
C®’d¬
 
	gnow
 = 
Ãw
 
java
.
ut
.
G»gÜŸnC®’d¬
();

216 
	gONE_DAY_SECONDS
 = 24 * 60 * 60;

217 
D©eFÜm©
 
	gd©eFÜm©
 = 
Ãw
 
java
.
‹xt
.
Sim¶eD©eFÜm©
("yyyy-MM-dd HH:mm:ss");

219 @
Ov”ride


220 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

225 @
Ov”ride


226 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

231 
	gLškedLi¡
<
	gKeyV®ue
> 
	gkvli¡
 = 
Ãw
 
LškedLi¡
<
KeyV®ue
>();

233 @
Ov”ride


234 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<ImmubËBy‹sWr™abË> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

237 
ImmubËBy‹sWr™abË
 
	gv
 = 
nuÎ
;

238 
	gI‹¿tÜ
<
	gImmubËBy‹sWr™abË
> 
	g™
 = 
v®ues
.
™”©Ü
();

239 
	gkvli¡
.
ş—r
();

240 
	g™
.
hasNext
()) {

241 
	gv
 = 
™
.
Ãxt
();

242 
KeyV®ue
 
	gkv
 = 
Ãw
 KeyV®ue(
key
.
g‘
(), 
P
, 
Ï
, 
Sy¡em
.
cu¼’tTimeMlis
(), 
Ty³
.
Put
, 
lßd
);

243 
	gcÚ‹xt
.
wr™e
(
key
, 
kv
);

248 
´iv©e
 
	gCÏss
<? 
ex‹nds
 
	gP¬t™iÚ”
> 
	$g‘TÙ®Ord”P¬t™iÚ”CÏss
(è
throws
 
CÏssNÙFoundExû±iÚ
 {

249 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
şazz
 = 
nuÎ
;

250 
Œy
 {

251 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>)

252 
CÏss
.
	`fÜName
("org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner");

253 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

254 
şazz
 = (
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
>)

255 
CÏss
.
	`fÜName
("org.apache.hadoop.hbase.mapreduce.hadoopbackport.TotalOrderPartitioner");

257  
şazz
;

258 
	}
}

260 
´iv©e
 
	gLi¡
<
	gImmubËBy‹sWr™abË
> 
	$g‘RegiÚS¹Keys
(
HTabË
 
bË
è
throws
 
IOExû±iÚ
 {

261 
by‹
[][] 
by‹Keys
 = 
bË
.
	`g‘S¹Keys
();

262 
A¼ayLi¡
<
ImmubËBy‹sWr™abË
> 
»t
 = 
Ãw
 A¼ayLi¡<ImmubËBy‹sWr™abË>(
by‹Keys
.
Ëngth
);

263 
by‹
[] 
by‹Key
 : 
by‹Keys
) {

264 
»t
.
	`add
(
Ãw
 
	`ImmubËBy‹sWr™abË
(
by‹Key
));

266  
»t
;

267 
	}
}

269 
´iv©e
 
wr™eP¬t™iÚs
(
CÚfigu¿tiÚ
 
cÚf
, 
P©h
 
·¹™iÚsP©h
, 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
è
throws
 
	gIOExû±iÚ
 {

270 ià(
	g¡¬tKeys
.
isEm±y
()) {

271 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("No„egions…assed");

278 
	gT»eS‘
<
	gImmubËBy‹sWr™abË
> 
	gsÜ‹d
 = 
Ãw
 
T»eS‘
<
ImmubËBy‹sWr™abË
>(
¡¬tKeys
);

280 
ImmubËBy‹sWr™abË
 
	gfœ¡
 = 
sÜ‹d
.
fœ¡
();

281 ià(!
	gfœ¡
.
equ®s
(
HCÚ¡ªts
.
EMPTY_BYTE_ARRAY
)) {

282 
throw
 
Ãw
 
IÎeg®Argum’tExû±iÚ
("Fœ¡„egiÚ oàbË should havem±y s¹ key. In¡—d has: " + 
By‹s
.
toSŒšgBš¬y
(
fœ¡
.
g‘
()));

284 
	gsÜ‹d
.
»move
(
fœ¡
);

287 
FeSy¡em
 
	gfs
 = 
·¹™iÚsP©h
.
g‘FeSy¡em
(
cÚf
);

288 
	gSequ’ûFe
.
Wr™”
 
	gwr™”
 = 
Sequ’ûFe
.
ü—‹Wr™”
(
fs
, 
cÚf
, 
·¹™iÚsP©h
, 
ImmubËBy‹sWr™abË
.
şass
, 
NuÎWr™abË
.class);

290 
	gŒy
 {

291 
ImmubËBy‹sWr™abË
 
	g¡¬tKey
 : 
sÜ‹d
) {

292 
wr™”
.
­³nd
(
¡¬tKey
, 
NuÎWr™abË
.
g‘
());

294 } 
	gfš®ly
 {

295 
	gwr™”
.
şo£
();

299 
	$cÚfigu»Com´essiÚ
(
HTabË
 
bË
, 
CÚfigu¿tiÚ
 
cÚf
è
throws
 
IOExû±iÚ
 {

300 
SŒšgBud”
 
com´essiÚCÚfigV®ue
 = 
Ãw
 
	`SŒšgBud”
();

301 
HTabËDesütÜ
 
bËDesütÜ
 = 
bË
.
	`g‘TabËDesütÜ
();

302 ià(
bËDesütÜ
 =ğ
nuÎ
) {

306 
CŞËùiÚ
<
HCŞumnDesütÜ
> 
çm›s
 = 
bËDesütÜ
.
	`g‘Fam›s
();

307 
i
 = 0;

308 
HCŞumnDesütÜ
 
çmyDesütÜ
 : 
çm›s
) {

309 ià(
i
++ > 0) {

310 
com´essiÚCÚfigV®ue
.
	`­³nd
('&');

312 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘NameAsSŒšg
(), "UTF-8"));

313 
com´essiÚCÚfigV®ue
.
	`­³nd
('=');

314 
com´essiÚCÚfigV®ue
.
	`­³nd
(
URLEncod”
.
	`’code
(
çmyDesütÜ
.
	`g‘Com´essiÚ
().
	`g‘Name
(), "UTF-8"));

317 
cÚf
.
	`£t
(
COMPRESSION_CONF_KEY
, 
com´essiÚCÚfigV®ue
.
	`toSŒšg
());

318 
	}
}

320 
Job
 
	$ü—‹OldURLJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

321 
Job
 
job
 = 
nuÎ
;

322 
Œy
 {

323 
job
 = 
Ãw
 
	`Job
(
cÚf
);

324 ià(
¬gs
.
Ëngth
 > 4)

325 
Log
.
	`šfo
("Ãwdoicd…©h=" + 
¬gs
[2] + "\tdeleteload…ath=" +‡rgs[4] + "\tloadflag" +‡rgs[3]);

327 
Log
.
	`šfo
("Ãwdoicd…©h=" + 
¬gs
[2] + "\tloadflag" +‡rgs[3]);

328 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[2]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
NewDocidM­³r
.class);

329 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[3]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
LßdFÏgM­³r
.class);

330 ià(
¬gs
.
Ëngth
 > 4)

331 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[4]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
D–‘eLßdM­³r
.class);

333 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

334 
job
.
	`£tJobName
("UpdateHbaseStatus");

335 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

336 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

337 
job
.
	`£tReduûrCÏss
(
DocidReduûr
.
şass
);

338 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

339 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

340 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

341 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

342 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

344 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

345 
Œy
 {

346 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

347 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

348 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

350 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

352 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

353 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

354 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

355 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

357 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

358 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

360 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

362 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

363 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

365 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

366 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

367 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

368 
Log
.
	`šfo
("Incrementalable output configured.");

369 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

370 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

372 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

374 
e
.
	`´štSckT¿û
();

376 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

378 
e
.
	`´štSckT¿û
();

380  
job
;

381 
	}
}

383 
Job
 
	$ü—‹NewURLLßdJob
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

384 
Job
 
job
 = 
nuÎ
;

385 
Œy
 {

386 
job
 = 
Ãw
 
	`Job
(
cÚf
);

387 ià(
¬gs
.
Ëngth
 > 4)

388 
Log
.
	`šfo
("Ãwdoicd…©h=" + 
¬gs
[2] + "\tdeleteload…ath=" +‡rgs[4] + "\tloadflag" +‡rgs[3]);

390 
Log
.
	`šfo
("Ãwdoicd…©h=" + 
¬gs
[2] + "\tloadflag" +‡rgs[3]);

391 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[3]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
LßdFÏgM­³r
.class);

393 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

394 
job
.
	`£tJobName
("UpdateHbaseStatus");

395 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

396 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

397 
job
.
	`£tReduûrCÏss
(
NewLßdReduûr
.
şass
);

398 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

399 
job
.
	`£tOuutV®ueCÏss
(
KeyV®ue
.
şass
);

400 
job
.
	`£tOuutFÜm©CÏss
(
HFeOuutFÜm©
.
şass
);

401 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("importTable", "webDB");

402 
HTabË
 
bË
 = 
Ãw
 
	`HTabË
(
cÚf
, 
bËName
);

404 
CÏss
<? 
ex‹nds
 
P¬t™iÚ”
> 
tİCÏss
;

405 
Œy
 {

406 
tİCÏss
 = 
	`g‘TÙ®Ord”P¬t™iÚ”CÏss
();

407 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

408 
throw
 
Ãw
 
	`IOExû±iÚ
("Faed g‘tšg TÙ®Ord”P¬t™iÚ”", 
e
);

410 
job
.
	`£tP¬t™iÚ”CÏss
(
tİCÏss
);

412 
Log
.
	`šfo
("Lookšg u°cu¼’ˆ»giÚ fÜabË " + 
bË
);

413 
Li¡
<
ImmubËBy‹sWr™abË
> 
¡¬tKeys
 = 
	`g‘RegiÚS¹Keys
(
bË
);

414 
Log
.
	`šfo
("CÚfiguršg " + 
¡¬tKeys
.
	`size
() + "„educe…artitions " + "to match current„egion count");

415 
job
.
	`£tNumReduûTasks
(
¡¬tKeys
.
	`size
());

417 
P©h
 
·¹™iÚsP©h
 = 
Ãw
 
	`P©h
(
job
.
	`g‘WÜkšgDœeùÜy
(), "·¹™iÚs_" + 
Sy¡em
.
	`cu¼’tTimeMlis
());

418 
Log
.
	`šfo
("Wr™šg…¬t™iÚ infÜm©iÚØ" + 
·¹™iÚsP©h
);

420 
FeSy¡em
 
fs
 = 
·¹™iÚsP©h
.
	`g‘FeSy¡em
(
cÚf
);

422 
	`wr™eP¬t™iÚs
(
cÚf
, 
·¹™iÚsP©h
, 
¡¬tKeys
);

423 
TÙ®Ord”P¬t™iÚ”
.
	`£tP¬t™iÚFe
(
job
.
	`g‘CÚfigu¿tiÚ
(), 
·¹™iÚsP©h
);

425 
URI
 
·¹™iÚUri
 = 
Ãw
 
	`URI
(
·¹™iÚsP©h
.
	`toSŒšg
() + "#_partitions");

426 
Di¡ribu‹dCache
.
	`addCacheFe
(
·¹™iÚUri
, 
cÚf
);

427 
Di¡ribu‹dCache
.
	`ü—‹Symlšk
(
cÚf
);

428 
Log
.
	`šfo
("Incrementalable output configured.");

429 
TabËM­ReduûUt
.
	`addD•’d’cyJ¬s
(
job
);

430 
fs
.
	`d–‘eOnEx™
(
·¹™iÚsP©h
);

432 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

434 
e
.
	`´štSckT¿û
();

436 } 
	`ÿtch
 (
URISyÁaxExû±iÚ
 
e
) {

438 
e
.
	`´štSckT¿û
();

440  
job
;

441 
	}
}

443 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

445 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

446 
SŒšg
[] 
Ùh”Args
;

447 
Œy
 {

448 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

449 ià(
Ùh”Args
.
Ëngth
 < 4) {

450 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage:parsed_url_finger deletelist†oadlist");

451 
Sy¡em
.
	`ex™
(-1);

453 
Job
 
job
 = 
	`ü—‹OldURLJob
(
cÚf
, 
Ùh”Args
);

454 ià(
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
)) {

455 
Job
 
lßdJob
 = 
	`ü—‹NewURLLßdJob
(
cÚf
, 
Ùh”Args
);

456 
lßdJob
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

459 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

460 
e
.
	`´štSckT¿û
();

461 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

462 
e
.
	`´štSckT¿û
();

465 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/WebPageDataSend.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gBy‹A¼ayOuutSŒ—m
;

4 
impÜt
 
	gjava
.
	gio
.
	gD©aOuutSŒ—m
;

5 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

6 
impÜt
 
	gjava
.
	gnio
.
	gch¬£t
.
	gCh¬aù”CodšgExû±iÚ
;

7 
impÜt
 
	gjava
.
	gut
.
	gA¼ays
;

8 
impÜt
 
	gjava
.
	gut
.
	gI‹¿tÜ
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿bË
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gKeyV®ue
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gResuÉ
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gş›Á
.
	gSÿn
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gF‹r
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gP¬£F‹r
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gSšgËCŞumnV®ueF‹r
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gf‹r
.
	gCom·»F‹r
.
	gCom·»Op
;

21 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gio
.
	gImmubËBy‹sWr™abË
;

22 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËIÅutFÜm©
;

23 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­ReduûUt
;

24 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gm­»duû
.
	gTabËM­³r
;

25 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBa£64
;

26 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gut
.
	gBy‹s
;

27 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gNuÎWr™abË
;

28 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»d
.
	gJobCÚf
;

29 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

30 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

31 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gP¬t™iÚ”
;

32 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

33 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gMuÉËIÅuts
;

34 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

35 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

36 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gMuÉËOuuts
;

37 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

38 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gSŒšgUts
;

39 
impÜt
 
	gÜg
.
	gmÜtbay
.
	glog
.
	gLog
;

41 
impÜt
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	gcommÚ
.
	gut
.
	gNumb”Ut
;

56 
public
 cÏs 
	cWebPageD©aS’d
 {

66 
public
 
şass
 
WebPageD©aS’dM­³r
 
ex‹nds
 
	mTabËM­³r
<
	mImmubËBy‹sWr™abË
, ImmutableBytesWritable> {

67 
	mby‹
[] 
	mf
 = 
By‹s
.
toBy‹s
("F");

68 
	mby‹
[] 
	mu
 = 
By‹s
.
toBy‹s
("u");

69 
	mby‹
[] 
	mp
 = 
By‹s
.
toBy‹s
("P");

70 
	mby‹
[] 
	mfšg”
 = 
By‹s
.
toBy‹s
("f");

71 
	mby‹
[] 
	msc
 = 
By‹s
.
toBy‹s
("sc");

72 
	mby‹
[] 
	m¤t
 = 
By‹s
.
toBy‹s
("srt");

73 
	mby‹
[] 
	ms¡
 = 
By‹s
.
toBy‹s
("sst");

74 
	mby‹
[] 
	mt
 = 
By‹s
.
toBy‹s
("t");

75 
	mby‹
[] 
	mac
 = 
By‹s
.
toBy‹s
("ac");

76 
	mby‹
[] 
	mş
 = 
By‹s
.
toBy‹s
("cl");

77 
	mby‹
[] 
	msu
 = 
By‹s
.
toBy‹s
("su");

78 
	mby‹
[] 
	mÏ
 = 
By‹s
.
toBy‹s
("la");

79 
	mby‹
[] 
	mÚe
 = 
Numb”Ut
.
cÚv”tIÁToC
(3);

80 
	mby‹
[] 
	mtwo
 = 
Numb”Ut
.
cÚv”tIÁToC
(4);

81 
	mby‹
[] 
	mth»e
 = 
Numb”Ut
.
cÚv”tIÁToC
(5);

83 
	mby‹
[] 
	mbufãr
 = 
Ãw
 
by‹
[1024 * 1024 * 2];

85 
ImmubËBy‹sWr™abË
 
	mv
 = 
Ãw
 ImmutableBytesWritable();

87 
	mby‹
[] 
	mÇmebufãr
 = 
Ãw
 
by‹
[8];

88 
	moff£t
 = 12;

89 
	m´oûss
 = 0;

91 @
Ov”ride


92 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
ResuÉ
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

94 
	mA¼ays
.
fl
(
bufãr
, (
by‹
) '0');

95 
	mKeyV®ue
[] 
	mkvs
 = 
v®ue
.
¿w
();

97 
	m´oûss
 = 0;

99 
	mSy¡em
.
¬¿ycİy
(
key
.
g‘
(), 0, 
bufãr
, 4, 8);

100 
	moff£t
 = 16;

101 
KeyV®ue
 
	mkv
 : 
kvs
) {

103 ià(
By‹s
.
com·»To
(
kv
.
g‘Bufãr
(), kv.
g‘FamyOff£t
(), kv.
g‘FamyL’gth
(), 
f
, 0, 1) == 0) {

105 ià(
kv
.
g‘Qu®if›rL’gth
(è=ğ1 && 
By‹s
.
com·»To
(kv.
g‘Bufãr
(), kv.
g‘Qu®if›rOff£t
(), kv.g‘Qu®if›rL’gth(), 
u
, 0, 1) == 0) {

106 ià(
off£t
 + 
kv
.
g‘V®ueL’gth
(è+ 12 > 
bufãr
.
Ëngth
) {

107 
Log
.
šfo
("bufã¸tØlÚg docid=" + 
SŒšgUts
.
by‹ToHexSŒšg
(
kv
.
g‘Key
()è+ "\’gth=" + (
off£t
 + kv.
g‘V®ueL’gth
()));

110 
	mSy¡em
.
¬¿ycİy
(
kv
.
g‘Bufãr
(), kv.
g‘Qu®if›rOff£t
(), 
bufãr
, 
off£t
, kv.
g‘Qu®if›rL’gth
());

111 
	moff£t
 += 8;

112 
	mËngth
 = 
kv
.
g‘V®ueL’gth
();

113 
by‹
 
	mv®ueL’
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
Ëngth
);

114 
	mSy¡em
.
¬¿ycİy
(
v®ueL’
, 0, 
bufãr
, 
off£t
, v®ueL’.
Ëngth
);

115 
	moff£t
 +ğ
v®ueL’
.
Ëngth
;

116 
	mSy¡em
.
¬¿ycİy
(
kv
.
g‘Bufãr
(), kv.
g‘V®ueOff£t
(), 
bufãr
, 
off£t
, kv.
g‘V®ueL’gth
());

117 
	moff£t
 +ğ
kv
.
g‘V®ueL’gth
();

118 
	m´oûss
++;

123 ià(
	mBy‹s
.
com·»To
(
kv
.
g‘Bufãr
(), kv.
g‘FamyOff£t
(), kv.
g‘FamyL’gth
(), 
p
, 0, 1) == 0) {

124 ià(
off£t
 + 
kv
.
g‘V®ueL’gth
(è+ 12 > 
bufãr
.
Ëngth
) {

125 
Log
.
šfo
("bufã¸tØlÚg docid=" + 
SŒšgUts
.
by‹ToHexSŒšg
(
kv
.
g‘Key
()è+ "\’gth=" + (
off£t
 + kv.
g‘V®ueL’gth
()));

128 ià(
	mBy‹s
.
com·»To
(
kv
.
g‘Bufãr
(), kv.
g‘Qu®if›rOff£t
(), kv.
g‘Qu®if›rL’gth
(), 
Ï
, 0,†a.
Ëngth
) == 0) {

131 
	mSy¡em
.
¬¿ycİy
(
kv
.
g‘Bufãr
(), kv.
g‘Qu®if›rOff£t
(), 
bufãr
, 
off£t
, kv.
g‘Qu®if›rL’gth
());

132 
	moff£t
 += 8;

133 
	mËngth
 = 
kv
.
g‘V®ueL’gth
();

134 
by‹
 
	mv®ueL’
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
Ëngth
);

135 
	mSy¡em
.
¬¿ycİy
(
v®ueL’
, 0, 
bufãr
, 
off£t
, v®ueL’.
Ëngth
);

136 
	moff£t
 +ğ
v®ueL’
.
Ëngth
;

138 
	mSy¡em
.
¬¿ycİy
(
kv
.
g‘Bufãr
(), kv.
g‘V®ueOff£t
(), 
bufãr
, 
off£t
, kv.
g‘V®ueL’gth
());

139 
	moff£t
 +ğ
kv
.
g‘V®ueL’gth
();

140 
	m´oûss
++;

143 
by‹
 
	mËn
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
´oûss
);

144 
	mSy¡em
.
¬¿ycİy
(
Ën
, 0, 
bufãr
, 12, 4);

146 
by‹
 
	msumËn
[] = 
Numb”Ut
.
cÚv”tIÁToC
(
off£t
 - 4);

147 
	mSy¡em
.
¬¿ycİy
(
sumËn
, 0, 
bufãr
, 0, 4);

148 
	mv
.
£t
(
bufãr
, 0, 
off£t
);

149 
	mcÚ‹xt
.
wr™e
(
key
, 
v
);

160 
public
 
şass
 
WebPageD–‘eM­³r
 
ex‹nds
 
	gM­³r
<
	gImmubËBy‹sWr™abË
, ImmutableBytesWritable, ImmutableBytesWritable, ImmutableBytesWritable> {

162 
by‹
 
	gÚe
[] = 
Ãw
 byte[1];

163 
ImmubËBy‹sWr™abË
 
	gv
 = 
Ãw
 ImmutableBytesWritable();

165 @
Ov”ride


166 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

168 
	gsu³r
.
£tup
(
cÚ‹xt
);

169 
	gv
.
£t
(
Úe
, 0, 1);

172 
´Ùeùed
 
m­
(
ImmubËBy‹sWr™abË
 
key
, 
NuÎWr™abË
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

174 
	gcÚ‹xt
.
wr™e
(
key
, 
v
);

178 
public
 
şass
 
	gDocidP¬tiÚ”
<
	gK
, 
	gV
> 
ex‹nds
 
	gP¬t™iÚ”
<K, V> 
im¶em’ts
 
	gCÚfigu¿bË
 {

179 
CÚfigu¿tiÚ
 
	gcÚf
;

180 
	gnumOäeduû
;

182 @
Ov”ride


183 
public
 
CÚfigu¿tiÚ
 
g‘CÚf
() {

185  
	gthis
.
	gcÚf
;

188 @
Ov”ride


189 
public
 
£tCÚf
(
CÚfigu¿tiÚ
 
¬g0
) {

191 
	gthis
.
	gcÚf
 = 
¬g0
;

192 
	gthis
.
	gnumOäeduû
 = 
cÚf
.
g‘IÁ
("mapred.reduce.tasks", 1024);

196 @
Ov”ride


197 
public
 
g‘P¬t™iÚ
(
K
 
¬g0
, 
V
 
¬g1
, 
¬g2
) {

198 
ImmubËBy‹sWr™abË
 
	gk
 = (ImmubËBy‹sWr™abËè
¬g0
;

200 
by‹
 
	gac
[] = 
k
.
g‘
();

201 
by‹
 
	ga
 = 
ac
[
k
.
g‘Off£t
(è+ k.
g‘L’gth
() - 1];

202 
by‹
 
	gb
 = 
ac
[
k
.
g‘Off£t
(è+ k.
g‘L’gth
() - 2];

203 
	gt
 = 
a
 & 0x000000ff;

204 
	gt2
 = 
b
 & 0x00000003;

205 
	g·¹
 = 
t2
 * 256 + 
t
;

206 ià(
	g·¹
 < 0 ||…art >= 1024) {

207 
Log
.
šfo
("”rÜ " + 
t
 + "2=" + 
t2
 + "\t" + 
·¹
);

209  
	g·¹
;

214 
public
 
şass
 
WebPageD©aS’dReduûr
 
ex‹nds
 
	gReduûr
<
	gImmubËBy‹sWr™abË
, ImmubËBy‹sWr™abË, ImmubËBy‹sWr™abË, 
	gNuÎWr™abË
> {

215 
´iv©e
 
MuÉËOuuts
 
	gmos
;

217 @
Ov”ride


218 
´Ùeùed
 
£tup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

220 
	gsu³r
.
£tup
(
cÚ‹xt
);

221 
	gmos
 = 
Ãw
 
MuÉËOuuts
(
cÚ‹xt
);

224 @
Ov”ride


225 
´Ùeùed
 
ş—nup
(
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

227 
	gsu³r
.
ş—nup
(
cÚ‹xt
);

228 
	gmos
.
şo£
();

231 @
Ov”ride


232 
´Ùeùed
 
»duû
(
ImmubËBy‹sWr™abË
 
key
, 
I‹¿bË
<ImmubËBy‹sWr™abË> 
v®ues
, 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

235 
ImmubËBy‹sWr™abË
 
	gv
 = 
nuÎ
;

236 
	gI‹¿tÜ
<
	gImmubËBy‹sWr™abË
> 
	g™
 = 
v®ues
.
™”©Ü
();

237 
	g™
.
hasNext
()) {

238 
	gv
 = 
™
.
Ãxt
();

239 ià(
	gv
.
g‘L’gth
() == 1) {

240 
mos
.
wr™e
("d–‘–i¡", 
key
, 
NuÎWr™abË
.
g‘
());

242 
	gcÚ‹xt
.
wr™e
(
v
, 
NuÎWr™abË
.
g‘
());

249 
SŒšg
 
	$cÚv”tSÿnToSŒšg
(
Sÿn
 
sÿn
è
throws
 
IOExû±iÚ
 {

250 
By‹A¼ayOuutSŒ—m
 
out
 = 
Ãw
 
	`By‹A¼ayOuutSŒ—m
();

251 
D©aOuutSŒ—m
 
dos
 = 
Ãw
 
	`D©aOuutSŒ—m
(
out
);

252 
sÿn
.
	`wr™e
(
dos
);

253  
Ba£64
.
	`’codeBy‹s
(
out
.
	`toBy‹A¼ay
());

254 
	}
}

269 
´iv©e
 
	$addCŞumn
(
Sÿn
 
sÿn
, 
by‹
[] 
çmyAndQu®if›r
) {

270 
by‹
[][] 
fq
 = 
KeyV®ue
.
	`·r£CŞumn
(
çmyAndQu®if›r
);

271 ià(
fq
.
Ëngth
 > 1 && fq[1] !ğ
nuÎ
 && fq[1].length > 0) {

272 
sÿn
.
	`addCŞumn
(
fq
[0], fq[1]);

274 
sÿn
.
	`addFamy
(
fq
[0]);

276 
	}
}

290 
public
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
by‹
[][] 
cŞumns
) {

291 
by‹
[] 
cŞumn
 : 
cŞumns
) {

292 
	`addCŞumn
(
sÿn
, 
cŞumn
);

294 
	}
}

306 
´iv©e
 
	$addCŞumns
(
Sÿn
 
sÿn
, 
SŒšg
 
cŞumns
) {

307 
SŒšg
[] 
cŞs
 = 
cŞumns
.
	`¥l™
(" ");

308 
SŒšg
 
cŞ
 : 
cŞs
) {

309 
	`addCŞumn
(
sÿn
, 
By‹s
.
	`toBy‹s
(
cŞ
));

311 
	}
}

313 
Job
 
	$ü—‹Subm™Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

314 
Œy
 {

316 
Sÿn
 
sÿn
 = 
Ãw
 
	`Sÿn
();

317 
SŒšg
 
bËName
 = 
cÚf
.
	`g‘
("tableName", "webDB");

318 
sÿn
.
	`£tCachšg
(500);

320 ià(
cÚf
.
	`g‘
("£rŸlNum"è!ğ
nuÎ
) {

321 
£rŸlNum
 = 
IÁeg”
.
	`·r£IÁ
(
cÚf
.
	`g‘
("serialNum"));

322 
SšgËCŞumnV®ueF‹r
 
f‹r
 = 
Ãw
 
	`SšgËCŞumnV®ueF‹r
(
By‹s
.
	`toBy‹s
("P"), By‹s.toBy‹s("Ï"), 
Com·»Op
.
EQUAL
, By‹s.toBy‹s(
£rŸlNum
));

323 
f‹r
.
	`£tF‹rIfMissšg
(
Œue
);

324 
f‹r
.
	`£tL©e¡V”siÚOÆy
(
Œue
);

325 
sÿn
.
	`£tF‹r
(
f‹r
);

327 
Sy¡em
.
out
.
	`´šn
("must give serialNum ");

328  
nuÎ
;

330 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
è!ğ
nuÎ
) {

331 
	`addCŞumns
(
sÿn
, 
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMNS
));

333 
	`addCŞumns
(
sÿn
, "F:u P:su P:sc P:sst P:f P:t P:srt P:ac P:cl P:la");

336 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
è!ğ
nuÎ
) {

337 
sÿn
.
	`addFamy
(
By‹s
.
	`toBy‹s
(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_COLUMN_FAMILY
)));

339 ià(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
è!ğ
nuÎ
) {

340 
sÿn
.
	`£tMaxV”siÚs
(
IÁeg”
.
	`·r£IÁ
(
cÚf
.
	`g‘
(
TabËIÅutFÜm©
.
SCAN_MAXVERSIONS
)));

344 
cÚf
.
	`£tBoŞ—n
("m­»d.com´ess.m­.ouut", 
Œue
);

345 
cÚf
.
	`£t
("mapred.map.output.compression.codec", "org.apache.hadoop.io.compress.SnappyCodec");

346 
cÚf
.
	`£tBoŞ—n
("m­»d.ouut.com´ess", 
çl£
);

348 
cÚf
.
	`£t
(
TabËIÅutFÜm©
.
SCAN
, 
	`cÚv”tSÿnToSŒšg
(
sÿn
));

349 
sÿn
.
	`£tCacheBlocks
(
çl£
);

351 
Job
 
job
 = 
Ãw
 
	`Job
(
cÚf
);

353 
job
.
	`£tJobName
("exportLoadPageDataFromHbase");

355 ià(
¬gs
.
Ëngth
 > 1) {

356 
Ën
 = 
¬gs
.
Ëngth
;

357 
i
 = 1; i < 
Ën
; i++) {

358 
MuÉËIÅuts
.
	`addIÅutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[
i
]), 
Sequ’ûFeIÅutFÜm©
.
şass
, 
WebPageD–‘eM­³r
.class);

362 
TabËM­ReduûUt
.
	`š™TabËM­³rJob
(
bËName
, 
sÿn
, 
WebPageD©aS’dM­³r
.
şass
, 
ImmubËBy‹sWr™abË
.şass, ImmubËBy‹sWr™abË.şass, 
job
);

363 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

364 
job
.
	`£tOuutFÜm©CÏss
(
Bš¬yOuutFÜm©
.
şass
);

365 
job
.
	`£tM­OuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

366 
job
.
	`£tM­OuutV®ueCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

367 
job
.
	`£tP¬t™iÚ”CÏss
(
DocidP¬tiÚ”
.
şass
);

368 
job
.
	`£tOuutKeyCÏss
(
ImmubËBy‹sWr™abË
.
şass
);

369 
job
.
	`£tOuutV®ueCÏss
(
NuÎWr™abË
.
şass
);

370 
MuÉËOuuts
.
	`addNamedOuut
(
job
, "d–‘–i¡", 
Bš¬yOuutFÜm©
.
şass
, 
ImmubËBy‹sWr™abË
.şass, 
NuÎWr™abË
.class);

371 
job
.
	`£tReduûrCÏss
(
WebPageD©aS’dReduûr
.
şass
);

372 
job
.
	`£tNumReduûTasks
(1024);

373  
job
;

374 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

376 
e
.
	`´štSckT¿û
();

378  
nuÎ
;

379 
	}
}

381 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

382 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

383 
Œy
 {

384 
SŒšg
[] 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

385 
Job
 
job
 = 
WebPageD©aS’d
.
	`ü—‹Subm™Job
(
cÚf
, 
Ùh”Args
);

386 ià(
Ùh”Args
.
Ëngth
 < 1) {

387 
Sy¡em
.
out
.
	`´šn
("WrÚg‚umb” oà¬gum’ts: " + 
Ùh”Args
.
Ëngth
 + " usage: outputpath ");

388 
Sy¡em
.
	`ex™
(-1);

390 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

392 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

394 
e
.
	`´štSckT¿û
();

395 } 
	`ÿtch
 (
IÁ”ru±edExû±iÚ
 
e
) {

397 
e
.
	`´štSckT¿û
();

398 } 
	`ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

400 
e
.
	`´štSckT¿û
();

402 
	}
}

	@com/zhongsou/spider/hbase/mapreduce/WordCount.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	ghba£
.
	gm­»duû
;

3 
impÜt
 
	gjava
.
	gio
.
	gIOExû±iÚ
;

5 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gfs
.
	gP©h
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	ghba£
.
	gHBa£CÚfigu¿tiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gIÁWr™abË
;

9 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gLÚgWr™abË
;

10 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gio
.
	gText
;

11 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gJob
;

12 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gM­³r
;

13 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	gReduûr
;

14 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gFeIÅutFÜm©
;

15 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gSequ’ûFeIÅutFÜm©
;

16 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gšput
.
	gTextIÅutFÜm©
;

17 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gFeOuutFÜm©
;

18 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gSequ’ûFeOuutFÜm©
;

19 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gm­»duû
.
	glib
.
	gouut
.
	gTextOuutFÜm©
;

20 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gut
.
	gG’”icO±iÚsP¬£r
;

22 
public
 cÏs 
	cWÜdCouÁ
 {

24 
public
 
şass
 
WÜdCouÁM­
 
ex‹nds


25 
	mM­³r
<
	mText
, Text, Text, 
	mIÁWr™abË
> {

26 
IÁWr™abË
 
	mÚe
 = 
Ãw
 IntWritable(1);

28 @
Ov”ride


29 
´Ùeùed
 
m­
(
Text
 
key
, Texˆ
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

30 
throws
 
	mIOExû±iÚ
, 
	mIÁ”ru±edExû±iÚ
 {

33 
SŒšg
 
	m¬gs
[] = 
v®ue
.
toSŒšg
().
¥l™
("[\\s\t\r\n]{1,}");

34 ià(
	m¬gs
 !ğ
nuÎ
) {

35 
SŒšg
 
s
 : 
¬gs
) {

36 
cÚ‹xt
.
wr™e
(
Ãw
 
Text
(
s
), 
Úe
);

44 
public
 
şass
 
WÜdCouÁTextM­
 
ex‹nds


45 
	gM­³r
<
	gLÚgWr™abË
, 
	gText
, Text, 
	gIÁWr™abË
> {

46 
IÁWr™abË
 
	gÚe
 = 
Ãw
 IntWritable(1);

48 @
Ov”ride


49 
´Ùeùed
 
m­
(
LÚgWr™abË
 
key
, 
Text
 
v®ue
, 
CÚ‹xt
 
cÚ‹xt
)

50 
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

53 
SŒšg
 
	g¬gs
[] = 
v®ue
.
toSŒšg
().
¥l™
("[\\s\t\r\n]{1,}");

54 ià(
	g¬gs
 !ğ
nuÎ
) {

55 
SŒšg
 
s
 : 
¬gs
) {

56 
cÚ‹xt
.
wr™e
(
Ãw
 
Text
(
s
), 
Úe
);

64 
public
 
şass
 
WÜdCouÁReduûr
 
ex‹nds


65 
	gReduûr
<
	gText
, 
	gIÁWr™abË
, Text, IntWritable> {

67 @
Ov”ride


68 
´Ùeùed
 
»duû
(
Text
 
key
, 
I‹¿bË
<
IÁWr™abË
> 
v®ues
,

69 
CÚ‹xt
 
cÚ‹xt
è
throws
 
	gIOExû±iÚ
, 
	gIÁ”ru±edExû±iÚ
 {

70 
	ga
 = 0;

71 
IÁWr™abË
 
	gt
 : 
v®ues
) {

72 
a
 +ğ
t
.
g‘
();

74 
	gcÚ‹xt
.
wr™e
(
key
, 
Ãw
 
IÁWr™abË
(
a
));

80 
Job
 
	$ü—‹Job
(
CÚfigu¿tiÚ
 
cÚf
, 
SŒšg
 
¬gs
[]) {

81 
Job
 
job
 = 
nuÎ
;

82 
Œy
 {

83 
job
 = 
Ãw
 
	`Job
(
cÚf
);

84 
FeIÅutFÜm©
.
	`£tIÅutP©hs
(
job
, 
Ãw
 
	`P©h
(
¬gs
[0]));

85 
FeOuutFÜm©
.
	`£tOuutP©h
(
job
, 
Ãw
 
	`P©h
(
¬gs
[1]));

86 
job
.
	`£tJobName
("WordCountJob");

88 
SŒšg
 
šputFÜm©
 = 
cÚf
.
	`g‘
("input_format");

89 ià(
šputFÜm©
 =ğ
nuÎ
 || iÅutFÜm©.
	`equ®s
("")) {

90 
job
.
	`£tIÅutFÜm©CÏss
(
TextIÅutFÜm©
.
şass
);

91 
job
.
	`£tM­³rCÏss
(
WÜdCouÁTextM­
.
şass
);

93 
job
.
	`£tIÅutFÜm©CÏss
(
Sequ’ûFeIÅutFÜm©
.
şass
);

94 
job
.
	`£tM­³rCÏss
(
WÜdCouÁM­
.
şass
);

96 
job
.
	`£tM­OuutKeyCÏss
(
Text
.
şass
);

97 
job
.
	`£tM­OuutV®ueCÏss
(
IÁWr™abË
.
şass
);

98 
job
.
	`£tReduûrCÏss
(
WÜdCouÁReduûr
.
şass
);

99 
job
.
	`£tOuutKeyCÏss
(
Text
.
şass
);

100 
job
.
	`£tOuutV®ueCÏss
(
IÁWr™abË
.
şass
);

101 
SŒšg
 
ouutFÜm©
=
cÚf
.
	`g‘
("output_format");

102 if(
ouutFÜm©
==
nuÎ
||ouutFÜm©.
	`equ®s
(""))

104 
job
.
	`£tOuutFÜm©CÏss
(
TextOuutFÜm©
.
şass
);

108 
job
.
	`£tOuutFÜm©CÏss
(
Sequ’ûFeOuutFÜm©
.
şass
);

110 
job
.
	`£tNumReduûTasks
(
IÁeg”
.
	`·r£IÁ
(
¬gs
[2]));

111 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

112 
e
.
	`´štSckT¿û
();

114  
job
;

115 
	}
}

117 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

118 
CÚfigu¿tiÚ
 
cÚf
 = 
HBa£CÚfigu¿tiÚ
.
	`ü—‹
();

119 
SŒšg
[] 
Ùh”Args
;

120 
Œy
 {

121 
Ùh”Args
 = 
Ãw
 
	`G’”icO±iÚsP¬£r
(
cÚf
, 
¬gs
).
	`g‘RemaššgArgs
();

122 ià(
Ùh”Args
.
Ëngth
 < 3) {

123 
Sy¡em
.
out


124 .
	`´šn
("Wrong‚umber of‡rguments: "

125 + 
Ùh”Args
.
Ëngth


127 
Sy¡em
.
	`ex™
(-1);

129 
Job
 
job
 = 
	`ü—‹Job
(
cÚf
, 
Ùh”Args
);

130 
job
.
	`wa™FÜCom¶‘iÚ
(
Œue
);

132 } 
	`ÿtch
 (
IOExû±iÚ
 
e
) {

133 
e
.
	`´štSckT¿û
();

134 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

135 
e
.
	`´štSckT¿û
();

137 
	}
}

	@com/zhongsou/spider/plugin/Plugin.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
;

3 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

4 
impÜt
 
	gjava
.
	gut
.
	gT»eM­
;

6 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿bË
;

7 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu¿tiÚ
;

8 
impÜt
 
	gÜg
.
	g­ache
.
	ghadoİ
.
	gcÚf
.
	gCÚfigu»d
;

10 
public
 cÏs 
	cPlugš
 {

11 
´iv©e
 
SŒšg
 
	mşassName
;

12 
´iv©e
 
	mT»eM­
<
	mIÁeg”
, 
	mPlugšIm¶em’tiÚ
> 
	mtm­
 = 
Ãw
 
T»eM­
<
IÁeg”
, PluginImplementation>();

14 
public
 
SŒšg
 
	$g‘CÏssName
() {

15  
şassName
;

18 
public
 
	$£tCÏssName
(
SŒšg
 
şassName
) {

19 
this
.
şassName
 = className;

20 
	}
}

22 
public
 
	gT»eM­
<
	gIÁeg”
, 
	gPlugšIm¶em’tiÚ
> 
	$g‘Im¶em’tiÚm­
() {

24  
tm­
;

25 
	}
}

27 
public
 şas 
	cPlugšIm¶em’tiÚ
 {

28 
SŒšg
 
	gşassName
;

29 
	gÜd”
;

30 
boŞ—n
 
	g’abËd
;

31 
	gHashM­
<
	gSŒšg
, SŒšg> 
	g©Œibu‹s
;

33 
public
 
SŒšg
 
g‘CÏssName
() {

34  
	gşassName
;

37 
public
 
£tCÏssName
(
SŒšg
 
şassName
) {

38 
	gthis
.
	gşassName
 = 
şassName
;

41 
public
 
g‘Ord”
() {

42  
	gÜd”
;

45 
public
 
£tOrd”
(
Üd”
) {

46 
	gthis
.
	gÜd”
 = 
Üd”
;

49 
public
 
boŞ—n
 
isEÇbËd
() {

50  
	g’abËd
;

53 
public
 
£tEÇbËd
(
boŞ—n
 
’abËd
) {

54 
	gthis
.
	g’abËd
 = 
’abËd
;

57 
public
 
put
(
SŒšg
 
key
, SŒšg 
v®ue
) {

58 ià(
	gthis
.
	g©Œibu‹s
 =ğ
nuÎ
) {

59 
this
.
©Œibu‹s
 = 
Ãw
 
HashM­
<
SŒšg
, 
	gSŒšg
>();

62 
	gthis
.
	g©Œibu‹s
.
put
(
key
, 
v®ue
);

65 
public
 
SŒšg
 
g‘A‰ribu‹
(SŒšg 
key
) {

66 ià(
	gthis
.
	g©Œibu‹s
 =ğ
nuÎ
 || !
this
.
©Œibu‹s
.
cÚšsKey
(
key
)) {

67  
nuÎ
;

69  
	gthis
.
	g©Œibu‹s
.
g‘
(
key
);

73 
public
 
SŒšg
 
toSŒšg
() {

74 
SŒšgBufãr
 
	gbufãr
 = 
Ãw
 StringBuffer();

75 
	gbufãr
.
­³nd
("şassName=" + 
şassName
 + "\tÜd”" + 
Üd”
 + "\‹ÇbË=" + 
’abËd
);

76  
	gbufãr
.
toSŒšg
();

79 
public
 
Objeù
 
ÃwIn¡ªû
(
CÚfigu¿tiÚ
 
cÚf
) {

80 
	gŒy
 {

81 
Objeù
 
	gt
 = 
CÏss
.
fÜName
(
this
.
şassName
).
ÃwIn¡ªû
();

82 ià(
	gCÚfigu»d
.
	gşass
.
isAssigÇbËFrom
(
t
.
g‘CÏss
())) {

83 ((
	gCÚfigu»d
è
	gt
).
£tCÚf
(
cÚf
);

84 } ià(
	gCÚfigu¿bË
.
	gşass
.
isAssigÇbËFrom
(
t
.
g‘CÏss
())) {

85 ((
	gCÚfigu¿bË
è
	gt
).
£tCÚf
(
cÚf
);

87  
	gt
;

88 } 
ÿtch
 (
In¡ªtŸtiÚExû±iÚ
 
e
) {

89 
	ge
.
´štSckT¿û
();

90 } 
ÿtch
 (
IÎeg®AcûssExû±iÚ
 
e
) {

91 
	ge
.
´štSckT¿û
();

92 } 
ÿtch
 (
CÏssNÙFoundExû±iÚ
 
e
) {

93 
	ge
.
´štSckT¿û
();

95  
	gnuÎ
;

	@com/zhongsou/spider/plugin/PluginParser.java

1 
·ckage
 
	gcom
.
	gzhÚgsou
.
	g¥id”
.
	g¶ugš
;

3 
impÜt
 
	gjava
.
	gio
.
	gIÅutSŒ—m
;

4 
impÜt
 
	gjava
.
	gut
.
	gHashM­
;

5 
impÜt
 
	gjava
.
	gut
.
	gM­
;

7 
impÜt
 
	gjavax
.
	gxml
.
	g·r£rs
.
	gDocum’tBud”
;

8 
impÜt
 
	gjavax
.
	gxml
.
	g·r£rs
.
	gDocum’tBud”FaùÜy
;

10 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”
;

11 
impÜt
 
	gÜg
.
	g¦f4j
.
	gLogg”FaùÜy
;

12 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gDocum’t
;

13 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gEËm’t
;

14 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gNode
;

15 
impÜt
 
	gÜg
.
	gw3c
.
	gdom
.
	gNodeLi¡
;

17 
public
 cÏs 
	cPlugšP¬£r
 {

18 
SŒšg
 
	mcÚfigName
;

19 
PlugšP¬£r
 
	m_š¡ªû
 = 
nuÎ
;

20 
	mM­
<
	mSŒšg
, 
	mPlugš
> 
	m¶ugšM­
 = 
Ãw
 
HashM­
<
SŒšg
, Plugin>();

21 
public
 
fš®
 
Logg”
 
	mLOG
 = 
Logg”FaùÜy
.
g‘Logg”
(
PlugšP¬£r
.
şass
);

23 
´iv©e
 
	$PlugšP¬£r
() {

24 
this
.
cÚfigName
 = "/plugin-config.xml";

25 
this
.
	`·r£CÚfigFe
();

28 
	$·r£CÚfigFe
() {

29 
Œy
 {

31 
IÅutSŒ—m
 
šput
 = 
PlugšP¬£r
.
şass
.
	`g‘ResourûAsSŒ—m
(
this
.
cÚfigName
);

32 
Docum’tBud”FaùÜy
 
dbf
 = Docum’tBud”FaùÜy.
	`ÃwIn¡ªû
();

33 
Docum’tBud”
 
db
 = 
dbf
.
	`ÃwDocum’tBud”
();

34 
Docum’t
 
doc
 = 
db
.
	`·r£
(
šput
);

35 
doc
.
	`g‘Docum’tEËm’t
().
	`nÜm®ize
();

36 
NodeLi¡
 
nodeL¡
 = 
doc
.
	`g‘EËm’tsByTagName
("plugin");

37 
SŒšg
 
şassName
, 
Üd”
, 
’abË
;

38 
i
 = 0; i < 
nodeL¡
.
	`g‘L’gth
(); i++) {

39 
Node
 
¶ugšNode
 = 
nodeL¡
.
	`™em
(
i
);

40 
Node
 
idNode
 = 
¶ugšNode
.
	`g‘A‰ribu‹s
().
	`g‘NamedI‹m
("id");

41 ià(
idNode
 =ğ
nuÎ
)

44 
SŒšg
 
id
 = 
idNode
.
	`g‘NodeV®ue
();

45 
Plugš
 
c
 = 
Ãw
 
	`Plugš
();

46 
c
.
	`£tCÏssName
(
id
);

47 
NodeLi¡
 
úodeL¡
 = ((
EËm’t
è
¶ugšNode
).
	`g‘EËm’tsByTagName
("implementation");

48 
s
 = 0; s < 
úodeL¡
.
	`g‘L’gth
(); s++) {

49 
Node
 
f¡Node
 = 
úodeL¡
.
	`™em
(
s
);

51 ià(
f¡Node
.
	`g‘NodeTy³
(è=ğ
Node
.
ELEMENT_NODE
) {

52 
Œy
 {

53 
EËm’t
 
f¡ElmÁ
 = (EËm’tè
f¡Node
;

55 
NodeLi¡
 
nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("class");

56 
EËm’t
 
–e
 = (EËm’tè
nodeLi¡
.
	`™em
(0);

57 
şassName
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

58 
nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("order");

59 
–e
 = (
EËm’t
è
nodeLi¡
.
	`™em
(0);

60 
Üd”
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

61 
nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("enable");

62 
–e
 = (
EËm’t
è
nodeLi¡
.
	`™em
(0);

63 
’abË
 = ((
Node
è
–e
.
	`g‘ChdNodes
().
	`™em
(0)).
	`g‘NodeV®ue
();

65 
Plugš
.
PlugšIm¶em’tiÚ
 
t
 = 
Ãw
 Plugš.
	`PlugšIm¶em’tiÚ
();

66 
t
.
	`£tCÏssName
(
şassName
);

67 
t
.
	`£tEÇbËd
(
BoŞ—n
.
	`·r£BoŞ—n
(
’abË
));

68 
t
.
	`£tOrd”
(
IÁeg”
.
	`·r£IÁ
(
Üd”
));

69 ià(
CÏss
.
	`fÜName
(
id
).
	`isAssigÇbËFrom
(CÏss.fÜName(
şassName
)è&& 
BoŞ—n
.
	`·r£BoŞ—n
(
’abË
)) {

70 
c
.
	`g‘Im¶em’tiÚm­
().
	`put
(
IÁeg”
.
	`·r£IÁ
(
Üd”
), 
t
);

72 
LOG
.
	`šfo
("im¶em’©iÚ " + 
t
 + " ingnored");

74 
NodeLi¡
 
·¿nodeLi¡
 = 
f¡ElmÁ
.
	`g‘EËm’tsByTagName
("parameter");

75 
j
 = 0; j < 
·¿nodeLi¡
.
	`g‘L’gth
(); j++) {

76 
Node
 
·¿Node
 = 
·¿nodeLi¡
.
	`™em
(
j
);

77 
Node
 
ÇmeNode
 = 
·¿Node
.
	`g‘A‰ribu‹s
().
	`g‘NamedI‹m
("name");

78 
Node
 
v®ueNode
 = 
·¿Node
.
	`g‘A‰ribu‹s
().
	`g‘NamedI‹m
("value");

79 ià(
ÇmeNode
 !ğ
nuÎ
 && 
v®ueNode
 !=‚ull) {

80 
t
.
	`put
(
ÇmeNode
.
	`g‘NodeV®ue
(), 
v®ueNode
.getNodeValue());

81 
Sy¡em
.
out
.
	`´šn
(
ÇmeNode
.
	`g‘NodeV®ue
()+"\t"+
v®ueNode
.getNodeValue());

85 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

86 
e
.
	`´štSckT¿û
();

93 ià(
c
.
	`g‘Im¶em’tiÚm­
().
	`size
() > 0) {

94 
LOG
.
	`šfo
("şas " + 
c
.
	`g‘CÏssName
(è+ "†ßd " + c.
	`g‘Im¶em’tiÚm­
().
	`size
() + " implmentations");

95 
this
.
¶ugšM­
.
	`put
(
c
.
	`g‘CÏssName
(), c);

98 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

99 
e
.
	`´štSckT¿û
();

102 
	}
}

104 
public
 
PlugšP¬£r
 
	$g‘In¡ªû
() {

105 ià(
_š¡ªû
 =ğ
nuÎ
) {

106 
	`synchrÚized
 (
PlugšP¬£r
.
şass
) {

107 ià(
_š¡ªû
 =ğ
nuÎ
) {

108 
_š¡ªû
 = 
Ãw
 
	`PlugšP¬£r
();

112  
_š¡ªû
;

114 
	}
}

116 
public
 
Plugš
 
	$g‘Plugš
(
SŒšg
 
¶ugšName
) {

117 ià(
this
.
¶ugšM­
.
	`cÚšsKey
(
¶ugšName
))

118  
this
.
¶ugšM­
.
	`g‘
(
¶ugšName
);

120  
nuÎ
;

121 
	}
}

123 
public
 
	$maš
(
SŒšg
 
¬gs
[]) {

124 
PlugšP¬£r
 
·r£r
 = PlugšP¬£r.
	`g‘In¡ªû
();

126 
	}
}

	@
1
.
1
/usr/include
152
7675
com/cybozu/labs/langdetect/Command.java
com/cybozu/labs/langdetect/Detector.java
com/cybozu/labs/langdetect/DetectorFactory.java
com/cybozu/labs/langdetect/GenProfile.java
com/cybozu/labs/langdetect/LangDetectException.java
com/cybozu/labs/langdetect/Language.java
com/cybozu/labs/langdetect/util/LangProfile.java
com/cybozu/labs/langdetect/util/Messages.java
com/cybozu/labs/langdetect/util/NGram.java
com/cybozu/labs/langdetect/util/TagExtractor.java
com/zhongsou/BMTrieNode.java
com/zhongsou/incload/DeDup.java
com/zhongsou/incload/DeDupMapper.java
com/zhongsou/incload/DeDupReducer.java
com/zhongsou/incload/Driver.java
com/zhongsou/incload/DupPair.java
com/zhongsou/incload/HFileCreatorMapper.java
com/zhongsou/incload/KeyValuePair.java
com/zhongsou/incload/MemTable.java
com/zhongsou/incload/PageNode.java
com/zhongsou/incload/SelectLogic.java
com/zhongsou/incload/SelectLogicMapper.java
com/zhongsou/incload/SelectLogicReducer.java
com/zhongsou/incload/SizeCal.java
com/zhongsou/incload/SpamPageGenerate.java
com/zhongsou/incload/Triple.java
com/zhongsou/robots/BMTrie.java
com/zhongsou/robots/BMTrieNode.java
com/zhongsou/spider/avro/ParserResultConverter.java
com/zhongsou/spider/bean/JobInfo.java
com/zhongsou/spider/bean/Jobtype.java
com/zhongsou/spider/bean/ParsedFingerInfo.java
com/zhongsou/spider/bean/ParsedURLInfo.java
com/zhongsou/spider/bean/ParserResult.java
com/zhongsou/spider/bean/URLInfo.java
com/zhongsou/spider/common/fileutil/GenerateImportHFile.java
com/zhongsou/spider/common/url/AutomatonURLFilter.java
com/zhongsou/spider/common/url/BMTrieRobots.java
com/zhongsou/spider/common/url/BasicURLNormalizer.java
com/zhongsou/spider/common/url/DomainBlacklistURLFilter.java
com/zhongsou/spider/common/url/DomainURLFilter.java
com/zhongsou/spider/common/url/PassURLNormalizer.java
com/zhongsou/spider/common/url/PrefixRobotsProtocol.java
com/zhongsou/spider/common/url/PrefixURLFilter.java
com/zhongsou/spider/common/url/RegexRule.java
com/zhongsou/spider/common/url/RegexURLFilter.java
com/zhongsou/spider/common/url/RegexURLFilterBase.java
com/zhongsou/spider/common/url/RegexURLNormalizer.java
com/zhongsou/spider/common/url/RobotsFilter.java
com/zhongsou/spider/common/url/RobotsProtocol.java
com/zhongsou/spider/common/url/RobotsProtocolParser.java
com/zhongsou/spider/common/url/SuffixURLFilter.java
com/zhongsou/spider/common/url/TrieRobotsProtocol.java
com/zhongsou/spider/common/url/URLFilter.java
com/zhongsou/spider/common/url/URLFilterException.java
com/zhongsou/spider/common/url/URLFilters.java
com/zhongsou/spider/common/url/URLNormalizer.java
com/zhongsou/spider/common/url/URLNormalizers.java
com/zhongsou/spider/common/url/UrlValidator.java
com/zhongsou/spider/common/util/BitsUtil.java
com/zhongsou/spider/common/util/MD5.java
com/zhongsou/spider/common/util/NetwokUtil.java
com/zhongsou/spider/common/util/NumberUtil.java
com/zhongsou/spider/common/util/ObjectCache.java
com/zhongsou/spider/common/util/PrefixStringMatcher.java
com/zhongsou/spider/common/util/SpiderConfiguration.java
com/zhongsou/spider/common/util/SuffixStringMatcher.java
com/zhongsou/spider/common/util/TrieStringMatcher.java
com/zhongsou/spider/common/util/URLUtil.java
com/zhongsou/spider/common/util/domain/DomainSuffix.java
com/zhongsou/spider/common/util/domain/DomainSuffixes.java
com/zhongsou/spider/common/util/domain/DomainSuffixesReader.java
com/zhongsou/spider/common/util/domain/TopLevelDomain.java
com/zhongsou/spider/exception/EmptyParamValueException.java
com/zhongsou/spider/hadoop/BoilerpipeContentHandler.java
com/zhongsou/spider/hadoop/ClawerConvert.java
com/zhongsou/spider/hadoop/ClawerFileInputFormat.java
com/zhongsou/spider/hadoop/ClawerFileReader.java
com/zhongsou/spider/hadoop/DOMBuilder.java
com/zhongsou/spider/hadoop/DoubleTextComparator.java
com/zhongsou/spider/hadoop/DoubleTextGroupComparator.java
com/zhongsou/spider/hadoop/DoubleTextPartition.java
com/zhongsou/spider/hadoop/FileInfo.java
com/zhongsou/spider/hadoop/HDFSUtil.java
com/zhongsou/spider/hadoop/HadoopFileSystemManager.java
com/zhongsou/spider/hadoop/HostInfo.java
com/zhongsou/spider/hadoop/HostSequenceFileInputFormat.java
com/zhongsou/spider/hadoop/MyTextOutputFormat.java
com/zhongsou/spider/hadoop/PipeScoreKey.java
com/zhongsou/spider/hadoop/PipeText.java
com/zhongsou/spider/hadoop/PipesScoreComparator.java
com/zhongsou/spider/hadoop/PipesScoreKeyGroupComparator.java
com/zhongsou/spider/hadoop/PipesScoreKeyPartition.java
com/zhongsou/spider/hadoop/RandomHostSequenceFileInputFormat.java
com/zhongsou/spider/hadoop/ScoreURLInfo.java
com/zhongsou/spider/hadoop/TimeMultipleOutoutFormat.java
com/zhongsou/spider/hadoop/TimeSequenceFileOutputFormat.java
com/zhongsou/spider/hadoop/URLFolderMapReducer.java
com/zhongsou/spider/hadoop/XMLCharacterRecognizer.java
com/zhongsou/spider/hadoop/job/CounterHelper.java
com/zhongsou/spider/hadoop/job/ParseResultConverterJob.java
com/zhongsou/spider/hadoop/jobcontrol/JobCreateFactory.java
com/zhongsou/spider/hadoop/jobcontrol/MapreduceV1Job.java
com/zhongsou/spider/hadoop/jobcontrol/MapreduceV2Job.java
com/zhongsou/spider/hadoop/jobcontrol/ParserJob.java
com/zhongsou/spider/hadoop/jobcontrol/PipesJobCreate.java
com/zhongsou/spider/hadoop/jobcontrol/ScoreAndClawerJob.java
com/zhongsou/spider/hadoop/jobcontrol/SelectAndSendJob.java
com/zhongsou/spider/hadoop/jobcontrol/SpiderJob.java
com/zhongsou/spider/hbase/Bulkload.java
com/zhongsou/spider/hbase/DataParser.java
com/zhongsou/spider/hbase/GenerateHost.java
com/zhongsou/spider/hbase/HFileOutputFormat.java
com/zhongsou/spider/hbase/MultiTableInputFormat.java
com/zhongsou/spider/hbase/MultiTableRecordReader.java
com/zhongsou/spider/hbase/Snippet.java
com/zhongsou/spider/hbase/TableMapReduceUtil.java
com/zhongsou/spider/hbase/TimeRangeFilter.java
com/zhongsou/spider/hbase/mapreduce/BinaryOutputFormat.java
com/zhongsou/spider/hbase/mapreduce/DataImporterMapper.java
com/zhongsou/spider/hbase/mapreduce/DuplicateURL.java
com/zhongsou/spider/hbase/mapreduce/ExportDocid.java
com/zhongsou/spider/hbase/mapreduce/ExportLinkInfo.java
com/zhongsou/spider/hbase/mapreduce/FloatReverseComparator.java
com/zhongsou/spider/hbase/mapreduce/GenerateHFile.java
com/zhongsou/spider/hbase/mapreduce/GenerateImportFile.java
com/zhongsou/spider/hbase/mapreduce/GenerateURLData.java
com/zhongsou/spider/hbase/mapreduce/GenerateURLInfo.java
com/zhongsou/spider/hbase/mapreduce/HBLoadFlagUpdater.java
com/zhongsou/spider/hbase/mapreduce/HostStatistic.java
com/zhongsou/spider/hbase/mapreduce/ImportURL.java
com/zhongsou/spider/hbase/mapreduce/MergeNewURLDocid.java
com/zhongsou/spider/hbase/mapreduce/ParseHost.java
com/zhongsou/spider/hbase/mapreduce/ParseResultImporter.java
com/zhongsou/spider/hbase/mapreduce/RobotFileGenerate.java
com/zhongsou/spider/hbase/mapreduce/RobotsHostGenerate.java
com/zhongsou/spider/hbase/mapreduce/RobotsProtocolProcess.java
com/zhongsou/spider/hbase/mapreduce/ScanAndGenerateHfile.java
com/zhongsou/spider/hbase/mapreduce/ScanHbase.java
com/zhongsou/spider/hbase/mapreduce/ScoreURLStatistic.java
com/zhongsou/spider/hbase/mapreduce/SendWebPage.java
com/zhongsou/spider/hbase/mapreduce/SortSeedURL.java
com/zhongsou/spider/hbase/mapreduce/StatisticNewURL.java
com/zhongsou/spider/hbase/mapreduce/StatisticOldURL.java
com/zhongsou/spider/hbase/mapreduce/StatisticalURL.java
com/zhongsou/spider/hbase/mapreduce/TopKOrderPartition.java
com/zhongsou/spider/hbase/mapreduce/TotalValueSort.java
com/zhongsou/spider/hbase/mapreduce/UpdateHbaseStatus.java
com/zhongsou/spider/hbase/mapreduce/WebPageDataSend.java
com/zhongsou/spider/hbase/mapreduce/WordCount.java
com/zhongsou/spider/plugin/Plugin.java
com/zhongsou/spider/plugin/PluginParser.java
